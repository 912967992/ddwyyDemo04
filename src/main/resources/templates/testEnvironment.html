<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据接收状态</title>
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/testEnvironment.css">

    <script>
        async function fetchData() {
            try {
                const response = await fetch('/passback/getAllReceivedData');
                const data = await response.json();

                let tableBody = document.getElementById("dataBody");
                tableBody.innerHTML = "";

                console.log(data);

                data.forEach(item => {
                    let scheduleText = "";
                    let isCancel = "";
                    switch (item.schedule) {
                        case "15":
                            scheduleText = "待排期";
                            break;
                        case "16":
                            scheduleText = "已排期待测试";
                            break;
                        case "0":
                            scheduleText = "测试中";
                            break;
                        case "1":
                            scheduleText = "待DQE和研发审核";
                            break;
                        case "2":
                            scheduleText = "审核完成";
                            break;
                        default:
                            scheduleText = item.schedule || "";
                    }
                    switch (item.isCancel) {
                        case 0:
                            isCancel = "";
                            break;
                        case 1:
                            isCancel = "已作废";
                            break;
                        default:
                            isCancel = item.isCancel || "";
                    }

                    let row = `<tr>
                <td>${item.id || ''}</td>
                <td>${item.sample_id || ''}</td>
                <td>${item.sample_category || ''}</td>
                <td>${item.sample_model || ''}</td>
                <td>${item.materialCode || ''}</td>
                <td>${item.sample_frequency || ''}</td>
                <td>${item.sample_name || ''}</td>
                <td>${item.version || ''}</td>
                <td>${item.priority || ''}</td>
                <td>${item.sample_leader || ''}</td>
                <td>${item.supplier || ''}</td>
                <td>${item.testProjectCategory || ''}</td>
                <td>${item.testProjects || ''}</td>
                <td>${scheduleText}</td>  <!-- 这里替换为转换后的文本 -->
                <td>${item.create_time || ''}</td>
                <td>${item.actual_start_time || ''}</td>
                <td>${item.actual_finish_time || ''}</td>
                <td>${isCancel}</td>
                <td>${item.cancel_reason || ''}</td>
                <td>${item.cancel_by || ''}</td>
                <td>${item.cancel_code || ''}</td>
                <td>${item.cancel_date || ''}</td>
            </tr>`;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('获取数据失败:', error);
            }
        }


        window.onload = fetchData;

        // 刷新页面函数
        function refreshPage() {
            location.reload(); // 重新加载页面
        }


        // 发送测试数据到 /passback/receiveData
        // async function sendTestData() {
        //     try {
        //         // 生成一个5位随机数（字符串）
        //         const randomSampleId = Math.floor(10000 + Math.random() * 90000).toString();
        //
        //
        //
        //         const response = await fetch('/passback/receiveData', {
        //             method: 'POST',
        //             headers: {
        //                 'Content-Type': 'application/json'
        //             },
        //             body: JSON.stringify({
        //                 sample_id: randomSampleId ,
        //                 sample_category:  "测试类别",
        //                 sample_model:  "型号A",
        //                 materialCode: "M001",
        //                 sample_frequency:  "1",
        //                 sample_name:  "测试样品",
        //                 version: "1.0",
        //                 priority: "高",
        //                 sample_leader:  "张三",
        //                 supplier: "供应商A",
        //                 testProjectCategory: "试验项目A",
        //                 testProjects: JSON.stringify(["子项目A","子项目B"]), // 先转换成字符串
        //                 schedule: "0",
        //                 isUsed: 0
        //             })
        //         });
        //
        //         const data = await response.json();
        //         console.log('Response:', data);
        //         alert('接口接收成功，状态码: ' + data.status + ' 信息: ' + data.message);
        //         refreshPage();
        //     } catch (error) {
        //         console.error('发送请求失败:', error);
        //         alert('请求发送失败');
        //     }
        // }

        async function sendTestData() {
            try {
                const payload = Array.from({ length: 5 }, (_, i) => {
                    const timestamp = Date.now() + i;
                    return {
                        sample_id: "ET" + timestamp, // ❌ 第5条故意设置 undefined
                        sample_category: "2025031900" + (i + 1),
                        sample_model: "LP15" + i,
                        sample_coding: null,
                        sample_name: "测试样品" + i,
                        version: "1",
                        priority: "加急",
                        // sample_leader: i === 4 ? undefined : "测试人" + i, // ❌ 第5条故意设置 undefined
                        sample_leader:  "测试人" + i, // ❌ 第5条故意设置 undefined
                        supplier: "测试供应商" + i,
                        schedule: "待测试",
                        materialItems: [
                            {
                                STTestCode: "ST" + timestamp,
                                materialCode: "50" + (728 + i),
                                sample_frequency: 2
                            }
                        ],
                        electricalTestItems: [
                            {
                                ETTestCode: "ET" + timestamp,
                                testProjectCategory: "分类" + i,
                                testProjects: "项目" + i
                            }
                        ]
                    };
                });

                const response = await fetch('/passback/receiveData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    // ❌ HTTP 状态码不是 200，例如 500
                    throw new Error(data.message || '服务器返回错误');
                }

                // ✅ 接口返回成功
                alert('✅ 接口接收成功\n状态码: ' + data.status + '\n信息: ' + data.message);
                refreshPage(); // 可选：刷新页面

            } catch (error) {
                console.error('发送请求失败:', error);
                alert('❌ 请求发送失败\n原因: ' + error.message);
            }
        }




        // 打开模态框
        function openModal() {
            document.getElementById("cancelModal").style.display = "block";
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById("cancelModal").style.display = "none";
        }

        // 提交作废请求
        function submitCancel() {
            const sampleId = document.getElementById("sampleId").value.trim();
            const cancelReason = document.getElementById("cancelReason").value.trim();
            const cancelBy = document.getElementById("cancelBy").value.trim();
            const cancelCode = document.getElementById("cancelCode").value.trim();
            const cancelDate = new Date().toISOString().replace("T", " ").substring(0, 19); // 获取当前时间

            // 输入校验
            if (!sampleId || !cancelReason || !cancelBy || !cancelCode) {
                alert("请填写所有字段");
                return;
            }

            const requestData = {
                sample_id: sampleId,
                cancel_reason: cancelReason,
                cancel_by: cancelBy,
                cancel_code: cancelCode,
                cancel_date: cancelDate
            };

            // 发送POST请求
            fetch("/passback/cancelData", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                    closeModal();
                })
                .catch(error => {
                    alert("请求失败：" + error);
                });
        }



        // 打开测试模态框
        function openTestModal() {
            document.getElementById("testModal").style.display = "block";
        }

        // 关闭测试模态框
        function closeTestModal() {
            document.getElementById("testModal").style.display = "none";
            document.getElementById("testFinishModal").style.display = "none";
            document.getElementById("testProcessModal").style.display = "none";
        }

        // 提交测试编号
        function submitTest() {
            const testNumber = document.getElementById("testNumber").value.trim();
            const actual_time = new Date().toISOString().replace("T", " ").substring(0, 19); // 获取当前时间

            if (!testNumber) {
                alert("请输入测试编号");
                return;
            }

            const requestData = {
                test_number: testNumber,
                actual_time: actual_time
            };

            // 发送POST请求
            fetch("/passback/StartTestElectricalTest", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    alert("测试已开始，状态码: " + data.status + " 信息: " + data.message);
                    closeTestModal();
                })
                .catch(error => {
                    alert("请求失败: " + error);
                });
        }



        function finishTestModal() {
            document.getElementById("testFinishModal").style.display = "block";
        }


        // 提交测试编号
        function submitFinishTest() {
            const testFinishNumber = document.getElementById("testFinishNumber").value.trim();

            if (!testFinishNumber) {
                alert("请输入测试编号");
                return;
            }

            const requestData = {
                test_number: testFinishNumber,
                actual_work_time: "8"
            };

            // 发送POST请求
            fetch("/passback/FinishTestElectricalTest", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    alert("测试已结束，状态码: " + data.status + " 信息: " + data.message);
                    closeTestModal();
                })
                .catch(error => {
                    alert("请求失败: " + error);
                });
        }


        function processTestModal() {
            document.getElementById("testProcessModal").style.display = "block";
        }


        // 提交测试编号
        function submitProcessTest() {
            const testProcessNumber = document.getElementById("testProcessNumber").value.trim();

            if (!testProcessNumber) {
                alert("请输入测试编号");
                return;
            }

            const requestData = {
                test_number: testProcessNumber,
                sampleRecognizeResult: "签样"
            };

            // 发送POST请求
            fetch("/passback/ProcessTestElectricalTest", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    alert("报告审核按钮成功，状态码: " + data.status + " 信息: " + data.message);
                    closeTestModal();
                })
                .catch(error => {
                    alert("请求失败: " + error);
                });
        }
    </script>
</head>
<body>
<!-- 刷新按钮 -->
<button class="fixed-button" onclick="refreshPage()">刷新页面</button>

<!-- 测试数据发送按钮 -->
<button class="fixed-button" onclick="sendTestData()">发送测试数据</button>

<button class="fixed-button" onclick="openModal()">作废数据按钮</button>

<!-- "开始测试" 按钮 -->
<button class="fixed-button" onclick="openTestModal()">开始测试按钮</button>

<button class="fixed-button" onclick="finishTestModal()">结束时间按钮</button>

<button class="fixed-button" onclick="processTestModal()">报告审核按钮</button>


<!-- 测试编号测试开始模态框 -->
<div id="testModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeTestModal()">&times;</span>
        <h3>填写测试编号</h3>
        <label>测试编号：</label>
        <input type="text" id="testNumber" class="input-field" placeholder="请输入测试编号">
        <button class="submit-btn" onclick="submitTest()">确定</button>
    </div>
</div>

<!-- 测试编号结束测试模态框 -->
<div id="testFinishModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeTestModal()">&times;</span>
        <h3>填写测试编号</h3>
        <label>测试编号：</label>
        <input type="text" id="testFinishNumber" class="input-field" placeholder="请输入测试编号">
        <button class="submit-btn" onclick="submitFinishTest()">确定</button>
    </div>
</div>

<!-- 报告审核按钮模态框 -->
<div id="testProcessModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeTestModal()">&times;</span>
        <h3>填写测试编号</h3>
        <label>测试编号：</label>
        <input type="text" id="testProcessNumber" class="input-field" placeholder="请输入测试编号">
        <button class="submit-btn" onclick="submitProcessTest()">确定</button>
    </div>
</div>



<!-- 内容区域 -->
<div class="content">
    <h2>接收的数据</h2>
    <table border="1">
        <thead>
        <tr>
            <th>序号</th>
            <th>电气编号</th>
            <th>产品类别</th>
            <th>大编码</th>
            <th>物料编码</th>
            <th>送样次数</th>
            <th>产品名称</th>
            <th>版本号</th>
            <th>优先级</th>
            <th>项目负责人</th>
            <th>供应商</th>
            <th>试验项目类别</th>
            <th>测试子项目</th>
            <th>当前进度</th>
            <th>创建时间</th>
            <th>实际开始时间</th>
            <th>实际结束时间</th>
            <th>是否作废</th>
            <th>作废原因</th>
            <th>作废人</th>
            <th>作废工号</th>
            <th>作废时间</th>
        </tr>
        </thead>
        <tbody id="dataBody"></tbody>
    </table>
</div>

<!-- 模态框 -->
<div id="cancelModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>填写作废信息</h3>
        <label>样品ID：</label>
        <input type="text" id="sampleId" class="input-field" placeholder="请输入样品ID">
        <label>作废原因：</label>
        <input type="text" id="cancelReason" class="input-field" placeholder="请输入作废原因">
        <label>作废人：</label>
        <input type="text" id="cancelBy" class="input-field" placeholder="请输入作废人">
        <label>作废人工号：</label>
        <input type="text" id="cancelCode" class="input-field" placeholder="请输入作废人工号">
        <button class="submit-btn" onclick="submitCancel()">提交</button>
    </div>
</div>


</body>
</html>
