<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问题点库管理</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/problemLibraryManageStyle.css">
    <!-- 引入jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 引入钉钉JSAPI -->
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>
    <!-- 引入问题类别配置 -->
    <script src="/js/problemCategories.js"></script>

    <!-- 自定义提示框样式 -->
    <style>
        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .custom-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-content {
            display: flex;
            align-items: center;
            padding: 16px;
            position: relative;
        }

        .toast-icon {
            color: #28a745;
            font-size: 20px;
            margin-right: 12px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            color: #999;
            font-size: 12px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .toast-close:hover {
            background-color: #f5f5f5;
            color: #666;
        }

        .custom-toast.success .toast-icon {
            color: #28a745;
        }

        .custom-toast.error .toast-icon {
            color: #dc3545;
        }

        .custom-toast.warning .toast-icon {
            color: #ffc107;
        }

        .custom-toast.info .toast-icon {
            color: #17a2b8;
        }

        /* 问题图片容器样式 */
        .problem-image-container {
            max-width: 100%;
            margin-top: 8px;
        }

        .problem-image-container img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 5px 0;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .problem-image-container img:hover {
            transform: scale(1.02);
        }

        .problem-image-container .no-image {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
            border: 1px dashed #ddd;
            border-radius: 4px;
        }

        .problem-image-container .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .problem-image-container .image-item {
            position: relative;
            display: inline-block;
        }

        .problem-image-container .image-item img {
            display: block;
            margin: 0;
        }

        /* 图片编辑容器样式 */
        .image-edit-container {
            width: 100%;
        }

        .image-edit-container textarea {
            width: 100%;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        .image-preview {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-height: 60px;
        }

        .image-preview .preview-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .image-preview .preview-item {
            position: relative;
            display: inline-block;
        }

        .image-preview .preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .image-preview .preview-item .remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .image-preview .preview-item:hover .remove-btn {
            display: block;
        }

        .image-edit-tips {
            margin-top: 5px;
            color: #666;
        }

        .image-edit-tips small {
            font-size: 11px;
        }

        /* 收藏夹模态框样式修复 */
        .cart-items-container {
            margin-top: 20px;
        }

        .cart-items-container .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .cart-items-container .data-table th,
        .cart-items-container .data-table td {
            padding: 12px 8px;
            text-align: left;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
        }

        .cart-items-container .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        .cart-items-container .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .cart-items-container .data-table tbody tr:hover td {
            background-color: #f5f5f5;
            color: #333;
        }

        .cart-items-container .filter-desc {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333 !important;
        }

        /* 问题类别输入组样式 */
        .category-input-group {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .category-select, .category-input {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .category-select:focus, .category-input:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .toggle-input-btn {
            margin-left: 8px;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-input-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .toggle-input-btn.active {
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
        }

        .category-input {
            display: none;
        }

        .category-input.show {
            display: block;
        }

        .category-select.hide {
            display: none;
        }

        /* 输入框与建议框容器 */
        .input-with-suggestions {
            position: relative;
            flex: 1;
        }

        /* 建议下拉框样式 */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .suggestions-dropdown.show {
            display: block;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.15s ease-in-out;
            font-size: 14px;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item.highlighted {
            background-color: #007bff;
            color: #fff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item .suggestion-text {
            display: block;
        }

        .suggestion-item .suggestion-hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        .suggestion-item.highlighted .suggestion-hint {
            color: #e3f2fd;
        }

        /* 合并数据展示区域样式 */
        .merged-data-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .merged-data-section h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .merged-stats {
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .merged-stats span {
            color: #495057;
            font-size: 14px;
        }

        .merged-stats strong {
            color: #007bff;
            font-weight: bold;
        }

        .merged-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .merged-table-container .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .merged-table-container .data-table th,
        .merged-table-container .data-table td {
            padding: 8px 6px;
            text-align: left;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            font-size: 12px;
        }

        .merged-table-container .data-table th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .merged-table-container .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .merged-table-container .data-table tbody tr:hover td {
            background-color: #f5f5f5;
            color: #333;
        }

        .merged-table-container .problem-desc {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333 !important;
        }

        /* 头部操作按钮样式 */
        .header-action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-action-buttons .btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* 搜索和重置按钮样式 */
        .search-reset-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .search-reset-buttons .btn {
            padding: 10px 20px;
        }

        /* 收藏夹控制按钮样式 */
        .cart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .cart-controls .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* 收藏夹详情模态框样式 */
        .cart-detail-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .cart-detail-info .detail-row {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .cart-detail-info .detail-row:last-child {
            margin-bottom: 0;
        }

        .cart-detail-info label {
            font-weight: bold;
            color: #495057;
            min-width: 100px;
            margin-right: 10px;
        }

        .cart-detail-info .detail-value {
            color: #333;
            flex: 1;
            word-break: break-all;
        }

        .cart-detail-table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .cart-detail-table-container .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .cart-detail-table-container .data-table th,
        .cart-detail-table-container .data-table td {
            padding: 8px 6px;
            text-align: left;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            font-size: 12px;
        }

        .cart-detail-table-container .data-table th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cart-detail-table-container .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .cart-detail-table-container .data-table tbody tr:hover td {
            background-color: #f5f5f5;
            color: #333;
        }

        .cart-detail-table-container .problem-desc {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333 !important;
        }
    </style>
</head>
<body>
    <!-- 页面头部 -->
    <div class="header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-database"></i>
                问题点库管理
            </h1>
            <div class="user-info">
                <span id="currentUser"></span>
                <span id="currentRole"></span>
                <span id="cacheStatus" class="cache-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
            </div>
            
            <!-- 操作按钮组 -->
            <div class="header-action-buttons">
                <button id="addToCartBtn" class="btn btn-warning">
                    <i class="fas fa-shopping-cart"></i> 加入收藏夹
                </button>
                <button id="exportBtn" class="btn btn-success">
                    <i class="fas fa-download"></i> 导出筛选结果
                </button>
                <button id="showCartBtn" class="btn btn-info">
                    <i class="fas fa-list"></i> 查看收藏夹 (<span id="cartCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- 筛选和操作区域 -->
    <div class="filter-section">
        <div class="filter-container">
            <!-- 筛选器主容器（平行布局） -->
            <div class="filters-main-container">
                <!-- 基础筛选器（左侧） -->
                <div class="basic-filters-container">
                    <div class="filter-row">
                <div class="filter-group">
                    <label>完整编码:</label>
                    <select id="fullModelFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>样品阶段:</label>
                    <select id="sampleStageFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>版本:</label>
                    <select id="versionFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>大类:</label>
                    <select id="bigSpeciesFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>小类:</label>
                    <select id="smallSpeciesFilter">
                        <option value="">全部</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>缺陷等级:</label>
                    <select id="defectLevelFilter">
                        <option value="">全部</option>
                        <option value="S">S</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="待确定">待确定</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>当前状态:</label>
                    <select id="currentStatusFilter" data-compatible="true">
                        <option value="">全部</option>
                        <option value="Open">Open</option>
                        <option value="Closed" data-compatible-values="close,closed,Close,CLOSED">Closed</option>
                        <option value="Follow up" data-compatible-values="follow up,followup,Follow up,FOLLOW UP">Follow up</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>测试人员:</label>
                    <select id="testerFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>责任部门:</label>
                    <select id="responsibleDepartmentFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>测试平台:</label>
                    <select id="testPlatformFilter">
                        <option value="">全部</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>提交时间:</label>
                    <input type="date" id="startDateFilter">
                    <span>至</span>
                    <input type="date" id="endDateFilter">
                </div>
                <div class="filter-group">
                    <label>DQE负责人:</label>
                    <select id="dqeFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>问题描述:</label>
                    <input type="text" id="problemFilter" placeholder="输入问题关键词">
                </div>
                <div class="filter-group">
                    <label>显示设备:</label>
                    <select id="testDeviceFilter">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>其他设备:</label>
                    <input type="text" id="otherDeviceFilter" placeholder="输入其他设备">
                </div>
            </div>


            <!-- 搜索和重置按钮 -->
            <div class="search-reset-buttons">
                <button id="searchBtn" class="btn btn-primary">
                    <i class="fas fa-search"></i> 搜索
                </button>
                <button id="resetBtn" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> 重置
                </button>
                <button id="refreshAllOptionsBtn" class="btn btn-info">
                    <i class="fas fa-sync-alt"></i> 刷新选项
                </button>
            </div>
                </div>

                <!-- 问题类别筛选器（右侧） -->
                <div class="problem-category-filter-container">
                    <div class="filter-group problem-category-group">
                        <label>问题类别:</label>
                        <div class="filter-input-group">
                            <div class="three-level-selects-vertical">
                                <!-- 一级问题类别 -->
                                <div class="category-input-group">
                                    <select id="problemCategoryLevel1Filter" class="category-select">
                                        <option value="">全部</option>
                                    </select>
                                    <div class="input-with-suggestions">
                                        <input type="text" id="problemCategoryLevel1Input" class="category-input" placeholder="手动输入一级类别" style="display: none;">
                                        <div id="problemCategoryLevel1Suggestions" class="suggestions-dropdown" style="display: none;"></div>
                                    </div>
                                    <button type="button" class="toggle-input-btn" data-target="problemCategoryLevel1Input" title="切换手动输入">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <!-- 二级问题类别 -->
                                <div class="category-input-group">
                                    <select id="problemCategoryLevel2Filter" class="category-select">
                                        <option value="">全部</option>
                                    </select>
                                    <div class="input-with-suggestions">
                                        <input type="text" id="problemCategoryLevel2Input" class="category-input" placeholder="手动输入二级类别" style="display: none;">
                                        <div id="problemCategoryLevel2Suggestions" class="suggestions-dropdown" style="display: none;"></div>
                                    </div>
                                    <button type="button" class="toggle-input-btn" data-target="problemCategoryLevel2Input" title="切换手动输入">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <!-- 三级问题类别 -->
                                <div class="category-input-group">
                                    <select id="problemCategoryLevel3Filter" class="category-select">
                                        <option value="">全部</option>
                                    </select>
                                    <div class="input-with-suggestions">
                                        <input type="text" id="problemCategoryLevel3Input" class="category-input" placeholder="手动输入三级类别" style="display: none;">
                                        <div id="problemCategoryLevel3Suggestions" class="suggestions-dropdown" style="display: none;"></div>
                                    </div>
                                    <button type="button" class="toggle-input-btn" data-target="problemCategoryLevel3Input" title="切换手动输入">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据统计区域 -->
    <div class="stats-section">
        <div class="stats-container">

            <div class="stat-item clickable-stat" onclick="filterByStatus('Open')">
                <span class="stat-label">Open:</span>
                <span class="stat-value" id="openCount">0</span>
            </div>
            <div class="stat-item clickable-stat" onclick="filterByStatus('Closed')">
                <span class="stat-label">Closed:</span>
                <span class="stat-value" id="closedCount">0</span>
            </div>
            <div class="stat-item clickable-stat" onclick="filterByStatus('Follow up')">
                <span class="stat-label">Follow up:</span>
                <span class="stat-value" id="followupCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">筛选结果:</span>
                <span class="stat-value" id="filteredCount">0</span>
            </div>
        </div>
    </div>

    <!-- 数据表格区域 -->
    <div class="table-section">
        <div class="table-container">
            <table id="problemTable" class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>完整编码</th>
                        <th>大类</th>
                        <th>小类</th>
                        <th>样品阶段</th>
                        <th>版本</th>
                        <th>测试平台</th>
                        <th>显示设备</th>
                        <th>其他设备</th>
                        <th>问题描述</th>
                        <th>问题类别</th>
                        <th>缺陷等级</th>
                        <th>当前状态</th>
                        <th>测试人员</th>
                        <th>DQE责任人</th>
                        <th>责任部门</th>
                        <th>DQE确认回复</th>
                        <th>研发确认回复</th>
                        <th>提交时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="problemTableBody">
                    <!-- 数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>

        <!-- 分页控件 -->
        <div class="pagination-container">
            <div class="pagination-info">
                <span>显示第 <span id="startRecord">1</span> - <span id="endRecord">10</span> 条，共 <span id="totalRecords">0</span> 条记录</span>
                <div class="page-size-selector">
                    <label>每页显示:</label>
                    <select id="pageSizeSelect">
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>条</span>
                </div>
            </div>
            <div class="pagination-controls">
                <button id="firstPageBtn" class="btn btn-sm" title="首页">首页</button>
                <button id="prevPageBtn" class="btn btn-sm">上一页</button>
                <div class="page-numbers" id="pageNumbers">
                    <!-- 页码按钮将通过JavaScript动态生成 -->
                </div>
                <button id="nextPageBtn" class="btn btn-sm">下一页</button>
                <button id="lastPageBtn" class="btn btn-sm" title="末页">末页</button>
                <div class="page-jump">
                    <span>跳转到</span>
                    <input type="number" id="pageJumpInput" min="1" style="width: 60px; margin: 0 5px;">
                    <span>页</span>
                    <button id="pageJumpBtn" class="btn btn-sm">跳转</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 问题点详情模态框 -->
    <div id="problemDetailModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>问题点详情</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProblemId" value="">
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>基本信息</h3>
                        <div class="detail-row">
                            <label>样品ID:</label>
                            <span id="detailSampleId" class="detail-value"></span>
                        </div>
                        <div class="detail-row">
                            <label>完整编码:</label>
                            <span id="detailFullModel" class="detail-value"></span>
                            <input type="text" id="editDetailFullModel" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>大类:</label>
                            <span id="detailBigSpecies" class="detail-value"></span>
                            <input type="text" id="editDetailBigSpecies" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>小类:</label>
                            <span id="detailSmallSpecies" class="detail-value"></span>
                            <input type="text" id="editDetailSmallSpecies" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>样品阶段:</label>
                            <span id="detailSampleStage" class="detail-value"></span>
                            <input type="text" id="editDetailSampleStage" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>版本:</label>
                            <span id="detailVersion" class="detail-value"></span>
                            <input type="text" id="editDetailVersion" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>芯片方案:</label>
                            <span id="detailChipSolution" class="detail-value"></span>
                            <input type="text" id="editDetailChipSolution" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>测试平台:</label>
                            <span id="detailTestPlatform" class="detail-value"></span>
                            <input type="text" id="editDetailTestPlatform" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>显示设备:</label>
                            <span id="detailTestDevice" class="detail-value"></span>
                            <input type="text" id="editDetailTestDevice" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>其他设备:</label>
                            <span id="detailOtherDevice" class="detail-value"></span>
                            <input type="text" id="editDetailOtherDevice" class="detail-input" style="display: none;">
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>问题信息</h3>
                        <div class="detail-row">
                            <label>问题描述:</label>
                            <div id="detailProblem" class="detail-value"></div>
                            <textarea id="editDetailProblem" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>问题图片:</label>
                            <div id="detailProblemImage" class="detail-value problem-image-container"></div>
                        </div>
                        <div class="detail-row">
                            <label>问题类别:</label>
                            <span id="detailProblemCategory" class="detail-value"></span>
                            <select id="editDetailProblemCategory" class="detail-input" style="display: none;">
                                <option value="">请选择问题类别</option>
                                <optgroup label="视频组">
                                    <option value="视频播放问题">视频播放问题</option>
                                    <option value="视频录制问题">视频录制问题</option>
                                    <option value="视频编码问题">视频编码问题</option>
                                    <option value="视频解码问题">视频解码问题</option>
                                    <option value="视频传输问题">视频传输问题</option>
                                    <option value="视频显示问题">视频显示问题</option>
                                    <option value="视频格式问题">视频格式问题</option>
                                    <option value="视频画质问题">视频画质问题</option>
                                    <option value="视频同步问题">视频同步问题</option>
                                    <option value="视频卡顿问题">视频卡顿问题</option>
                                </optgroup>
                                <optgroup label="蓝牙组">
                                    <option value="蓝牙连接问题">蓝牙连接问题</option>
                                    <option value="蓝牙配对问题">蓝牙配对问题</option>
                                    <option value="蓝牙传输问题">蓝牙传输问题</option>
                                    <option value="蓝牙音频问题">蓝牙音频问题</option>
                                    <option value="蓝牙信号问题">蓝牙信号问题</option>
                                    <option value="蓝牙兼容性问题">蓝牙兼容性问题</option>
                                    <option value="蓝牙功耗问题">蓝牙功耗问题</option>
                                    <option value="蓝牙协议问题">蓝牙协议问题</option>
                                    <option value="蓝牙设备识别问题">蓝牙设备识别问题</option>
                                    <option value="蓝牙断连问题">蓝牙断连问题</option>
                                </optgroup>
                                <optgroup label="硬件组">
                                    <option value="硬件设计问题">硬件设计问题</option>
                                    <option value="生产问题">生产问题</option>
                                    <option value="器件问题">器件问题</option>
                                    <option value="配件问题">配件问题</option>
                                    <option value="外观问题">外观问题</option>
                                    <option value="PCBA问题">PCBA问题</option>
                                    <option value="电路问题">电路问题</option>
                                    <option value="接口问题">接口问题</option>
                                    <option value="散热问题">散热问题</option>
                                    <option value="机械结构问题">机械结构问题</option>
                                </optgroup>
                                <optgroup label="软件组">
                                    <option value="软件问题">软件问题</option>
                                    <option value="系统问题">系统问题</option>
                                    <option value="驱动问题">驱动问题</option>
                                    <option value="固件问题">固件问题</option>
                                    <option value="应用问题">应用问题</option>
                                    <option value="界面问题">界面问题</option>
                                    <option value="性能问题">性能问题</option>
                                    <option value="兼容性问题">兼容性问题</option>
                                    <option value="稳定性问题">稳定性问题</option>
                                    <option value="功能缺失问题">功能缺失问题</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>缺陷等级:</label>
                            <span id="detailDefectLevel" class="detail-value"></span>
                            <select id="editDetailDefectLevel" class="detail-input" style="display: none;">
                                <option value="S">S</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="待确定">待确定</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>当前状态:</label>
                            <span id="detailCurrentStatus" class="detail-value"></span>
                            <select id="editDetailCurrentStatus" class="detail-input" style="display: none;">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Follow up">Follow up</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>复现手法:</label>
                            <div id="detailReproductionMethod" class="detail-value"></div>
                            <textarea id="editDetailReproductionMethod" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>恢复方法:</label>
                            <div id="detailRecoveryMethod" class="detail-value"></div>
                            <textarea id="editDetailRecoveryMethod" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>复现概率:</label>
                            <span id="detailReproductionProbability" class="detail-value"></span>
                            <input type="text" id="editDetailReproductionProbability" class="detail-input" style="display: none;">
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>处理信息</h3>
                        <div class="detail-row">
                            <label>测试人员:</label>
                            <span id="detailTester" class="detail-value"></span>
                            <input type="text" id="editDetailTester" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>责任部门:</label>
                            <span id="detailResponsibleDepartment" class="detail-value"></span>
                            <select id="editDetailResponsibleDepartment" class="detail-input" style="display: none;">
                                <option value="SQE">SQE</option>
                                <option value="ID">ID</option>
                                <option value="结构">结构</option>
                                <option value="研发">研发</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>分析责任人:</label>
                            <span id="detailResponsiblePerson" class="detail-value"></span>
                            <input type="text" id="editDetailResponsiblePerson" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>DQE确认:</label>
                            <span id="detailDqeConfirm" class="detail-value"></span>
                            <input type="text" id="editDetailDqeConfirm" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>研发确认:</label>
                            <span id="detailRdConfirm" class="detail-value"></span>
                            <input type="text" id="editDetailRdConfirm" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>改善对策:</label>
                            <div id="detailImprovementPlan" class="detail-value"></div>
                            <textarea id="editDetailImprovementPlan" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>DQE回复:</label>
                            <div id="detailGreenUnionDqe" class="detail-value"></div>
                            <textarea id="editDetailGreenUnionDqe" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>研发回复:</label>
                            <div id="detailGreenUnionRd" class="detail-value"></div>
                            <textarea id="editDetailGreenUnionRd" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>其他信息</h3>
                        <div class="detail-row">
                            <label>对比上一版:</label>
                            <div id="detailComparisonWithPrevious" class="detail-value"></div>
                            <textarea id="editDetailComparisonWithPrevious" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>改善后风险:</label>
                            <div id="detailPostImprovementRisk" class="detail-value"></div>
                            <textarea id="editDetailPostImprovementRisk" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>下一版回归测试:</label>
                            <div id="detailNextVersionRegressionTest" class="detail-value"></div>
                            <textarea id="editDetailNextVersionRegressionTest" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>备注:</label>
                            <div id="detailRemark" class="detail-value"></div>
                            <textarea id="editDetailRemark" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>内外贸:</label>
                            <span id="detailTestOverseas" class="detail-value"></span>
                            <select id="editDetailTestOverseas" class="detail-input" style="display: none;">
                                <option value="内贸">内贸</option>
                                <option value="外贸">外贸</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>提交时间:</label>
                            <span id="detailCreatedAt" class="detail-value"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="editProblemBtn" class="btn btn-primary" style="display: none;">编辑</button>
                <button id="saveDetailBtn" class="btn btn-success" style="display: none;">保存</button>
                <button id="cancelEditBtn" class="btn btn-secondary" style="display: none;">取消</button>
                <button id="closeDetailModal" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 编辑问题点模态框 -->
    <div id="editProblemModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>编辑问题点</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProblemForm">
                    <input type="hidden" id="editProblemId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editFullModel">完整编码:</label>
                            <input type="text" id="editFullModel" name="fullModel">
                        </div>
                        <div class="form-group">
                            <label for="editSampleStage">样品阶段:</label>
                            <select id="editSampleStage" name="sampleStage">
                                <option value="EVT">EVT</option>
                                <option value="DVT">DVT</option>
                                <option value="PVT">PVT</option>
                                <option value="MP">MP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editVersion">版本:</label>
                            <input type="text" id="editVersion" name="version">
                        </div>
                        <div class="form-group">
                            <label for="editProblemCategory">问题类别:</label>
                            <select id="editProblemCategory" name="problemCategory">
                                <option value="">请选择问题类别</option>
                                <optgroup label="视频组">
                                    <option value="视频播放问题">视频播放问题</option>
                                    <option value="视频录制问题">视频录制问题</option>
                                    <option value="视频编码问题">视频编码问题</option>
                                    <option value="视频解码问题">视频解码问题</option>
                                    <option value="视频传输问题">视频传输问题</option>
                                    <option value="视频显示问题">视频显示问题</option>
                                    <option value="视频格式问题">视频格式问题</option>
                                    <option value="视频画质问题">视频画质问题</option>
                                    <option value="视频同步问题">视频同步问题</option>
                                    <option value="视频卡顿问题">视频卡顿问题</option>
                                </optgroup>
                                <optgroup label="蓝牙组">
                                    <option value="蓝牙连接问题">蓝牙连接问题</option>
                                    <option value="蓝牙配对问题">蓝牙配对问题</option>
                                    <option value="蓝牙传输问题">蓝牙传输问题</option>
                                    <option value="蓝牙音频问题">蓝牙音频问题</option>
                                    <option value="蓝牙信号问题">蓝牙信号问题</option>
                                    <option value="蓝牙兼容性问题">蓝牙兼容性问题</option>
                                    <option value="蓝牙功耗问题">蓝牙功耗问题</option>
                                    <option value="蓝牙协议问题">蓝牙协议问题</option>
                                    <option value="蓝牙设备识别问题">蓝牙设备识别问题</option>
                                    <option value="蓝牙断连问题">蓝牙断连问题</option>
                                </optgroup>
                                <optgroup label="硬件组">
                                <option value="硬件设计问题">硬件设计问题</option>
                                <option value="生产问题">生产问题</option>
                                <option value="器件问题">器件问题</option>
                                <option value="配件问题">配件问题</option>
                                <option value="外观问题">外观问题</option>
                                <option value="PCBA问题">PCBA问题</option>
                                    <option value="电路问题">电路问题</option>
                                    <option value="接口问题">接口问题</option>
                                    <option value="散热问题">散热问题</option>
                                    <option value="机械结构问题">机械结构问题</option>
                                </optgroup>
                                <optgroup label="软件组">
                                    <option value="软件问题">软件问题</option>
                                    <option value="系统问题">系统问题</option>
                                    <option value="驱动问题">驱动问题</option>
                                    <option value="固件问题">固件问题</option>
                                    <option value="应用问题">应用问题</option>
                                    <option value="界面问题">界面问题</option>
                                    <option value="性能问题">性能问题</option>
                                    <option value="兼容性问题">兼容性问题</option>
                                    <option value="稳定性问题">稳定性问题</option>
                                    <option value="功能缺失问题">功能缺失问题</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDefectLevel">缺陷等级:</label>
                            <select id="editDefectLevel" name="defectLevel">
                                <option value="S">S</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="待确定">待确定</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editCurrentStatus">当前状态:</label>
                            <select id="editCurrentStatus" name="currentStatus">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Follow up">Follow up</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="editProblem">问题描述:</label>
                            <textarea id="editProblem" name="problem" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editProblemImage">问题图片:</label>
                            <div class="image-edit-container">
                                <textarea id="editProblemImage" name="problem_image_or_video" rows="2" placeholder="请输入图片路径，多个图片用逗号分隔，如：/imageDirectory/image1.png,/imageDirectory/image2.png"></textarea>
                                <div class="image-preview" id="editImagePreview"></div>
                                <div class="image-edit-tips">
                                    <small>支持格式：/imageDirectory/图片名称.png 或 多个路径用逗号分隔</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label for="editReproductionMethod">复现手法:</label>
                            <textarea id="editReproductionMethod" name="reproductionMethod" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editRecoveryMethod">恢复方法:</label>
                            <textarea id="editRecoveryMethod" name="recoveryMethod" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editReproductionProbability">复现概率:</label>
                            <input type="text" id="editReproductionProbability" name="reproductionProbability">
                        </div>
                        <div class="form-group">
                            <label for="editTester">测试人员:</label>
                            <input type="text" id="editTester" name="tester">
                        </div>
                        <div class="form-group">
                            <label for="editResponsibleDepartment">责任部门:</label>
                            <select id="editResponsibleDepartment" name="responsibleDepartment">
                                <option value="SQE">SQE</option>
                                <option value="ID">ID</option>
                                <option value="结构">结构</option>
                                <option value="研发">研发</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editResponsiblePerson">分析责任人:</label>
                            <input type="text" id="editResponsiblePerson" name="responsiblePerson">
                        </div>
                        <div class="form-group full-width">
                            <label for="editImprovementPlan">改善对策:</label>
                            <textarea id="editImprovementPlan" name="improvementPlan" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editGreenUnionDqe">DQE回复:</label>
                            <textarea id="editGreenUnionDqe" name="greenUnionDqe" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editGreenUnionRd">研发回复:</label>
                            <textarea id="editGreenUnionRd" name="greenUnionRd" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editTestOverseas">内外贸:</label>
                            <select id="editTestOverseas" name="testOverseas">
                                <option value="内贸">内贸</option>
                                <option value="外贸">外贸</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="editRemark">备注:</label>
                            <textarea id="editRemark" name="remark" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveProblemBtn" class="btn btn-primary">保存</button>
                <button id="cancelEditBtn" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <!-- 历史版本模态框 -->
    <div id="historyVersionsModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>历史版本</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="history-versions-container">
                    <table id="historyVersionsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>版本号</th>
                                <th>问题描述</th>
                                <th>状态</th>
                                <th>修改人</th>
                                <th>修改时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="historyVersionsTableBody">
                            <!-- 历史版本数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeHistoryModal" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 收藏夹模态框 -->
    <div id="cartModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>收藏夹管理</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="cart-controls">
                    <button id="clearCartBtn" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> 清空收藏夹
                    </button>
                    <button id="exportCartBtn" class="btn btn-success btn-sm">
                        <i class="fas fa-download"></i> 导出收藏夹数据
                    </button>
                    <button id="mergeCartBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-layer-group"></i> 合并显示
                    </button>
                </div>

                <div class="cart-items-container">
                    <table id="cartItemsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllCartItems" title="全选/取消全选">
                                </th>
                                <th>序号</th>
                                <th>筛选条件</th>
                                <th>数据量</th>
                                <th>保存时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="cartItemsTableBody">
                            <!-- 收藏夹项目将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 合并数据展示区域 -->
                <div id="mergedDataSection" class="merged-data-section" style="display: none;">
                    <h3>合并数据预览</h3>
                    <div class="merged-stats">
                        <span>总数据量: <strong id="mergedTotalCount">0</strong></span>
                        <span>去重后: <strong id="mergedUniqueCount">0</strong></span>
                    </div>
                    <div class="merged-table-container">
                        <table id="mergedDataTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>完整编码</th>
                                    <th>大类</th>
                                    <th>小类</th>
                                    <th>样品阶段</th>
                                    <th>版本</th>
                                    <th>测试平台</th>
                                    <th>显示设备</th>
                                    <th>其他设备</th>
                                    <th>问题描述</th>
                                    <th>问题类别</th>
                                    <th>缺陷等级</th>
                                    <th>当前状态</th>
                                    <th>测试人员</th>
                                    <th>DQE责任人</th>
                                    <th>责任部门</th>
                                    <th>DQE确认回复</th>
                                    <th>研发确认回复</th>
                                    <th>提交时间</th>
                                </tr>
                            </thead>
                            <tbody id="mergedDataTableBody">
                                <!-- 合并数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeCartModal" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 收藏夹详情模态框 -->
    <div id="cartDetailModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>收藏夹详情</h2>
                <span class="close" onclick="closeSpecificModal('cartDetailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="cart-detail-info">
                    <div class="detail-row">
                        <label>筛选条件:</label>
                        <span id="cartDetailFilter" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <label>数据量:</label>
                        <span id="cartDetailCount" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <label>保存时间:</label>
                        <span id="cartDetailTime" class="detail-value"></span>
                    </div>
                </div>

                <div class="cart-detail-table-container">
                    <table id="cartDetailTable" class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>完整编码</th>
                                <th>大类</th>
                                <th>小类</th>
                                <th>样品阶段</th>
                                <th>版本</th>
                                <th>测试平台</th>
                                <th>显示设备</th>
                                <th>其他设备</th>
                                <th>问题描述</th>
                                <th>问题类别</th>
                                <th>缺陷等级</th>
                                <th>当前状态</th>
                                <th>测试人员</th>
                                <th>DQE责任人</th>
                                <th>责任部门</th>
                                <th>DQE确认回复</th>
                                <th>研发确认回复</th>
                                <th>提交时间</th>
                            </tr>
                        </thead>
                        <tbody id="cartDetailTableBody">
                            <!-- 详情数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSpecificModal('cartDetailModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>加载中...</p>
        </div>
    </div>

    <!-- 自定义提示框 -->
    <div id="customToast" class="custom-toast">
        <div class="toast-content">
            <div class="toast-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="toast-message" id="toastMessage">操作成功</div>
            <div class="toast-close" id="toastClose">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-nav">
        <button class="nav-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
            <span>返回</span>
        </button>
        <button class="nav-btn" onclick="goHome()">
            <i class="fas fa-home"></i>
            <span>主页</span>
        </button>
    </div>

    <script>
        // 全局变量
        let currentUser = '';
        let currentRole = '';
        let currentPage = 1;
        let pageSize = 20;
        let totalRecords = 0;
        let filteredData = [];
        let isSuperAdmin = false; // 是否为超级管理员

        // 购物车/收藏夹相关变量
        let cartItems = []; // 收藏夹项目
        let mergedData = []; // 合并后的数据

        // 缓存相关变量
        let speciesCache = {
            bigSpecies: null,
            smallSpecies: null,
            sampleStage: null,
            fullModel: null,
            version: null,
            problemCategory: null,
            tester: null,
            responsibleDepartment: null,
            testPlatform: null,
            testDevice: null,
            lastUpdated: null
        };

        // 标准化状态显示
        function normalizeStatus(status) {
            if (!status) return '';
            const normalized = status.toLowerCase().trim();
            switch (normalized) {
                case 'open':
                    return 'Open';
                case 'closed':
                case 'close':
                    return 'Closed';
                case 'follow up':
                case 'followup':
                    return 'Follow up';
                default:
                    return status; // 保持原值
            }
        }

        // 缓存管理函数
        function getCachedSpeciesOptions(speciesType) {
            // 先从内存缓存获取
            if (speciesCache[speciesType]) {
                return speciesCache[speciesType];
            }

            // 如果内存缓存没有，从localStorage获取
            try {
                const cached = localStorage.getItem('speciesCache');
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    if (parsedCache[speciesType] && isCacheValid(parsedCache.lastUpdated)) {
                        // 恢复到内存缓存
                        speciesCache = parsedCache;
                        return speciesCache[speciesType];
                    }
                }
            } catch (e) {
                console.error('读取缓存失败:', e);
            }

            return null;
        }

        // 检查并加载缓存选项到下拉框
        function checkAndLoadCachedOptions(speciesType) {
            const cachedOptions = getCachedSpeciesOptions(speciesType);
            if (cachedOptions && cachedOptions.length > 0) {
                updateSelectOptions(speciesType + 'Filter', cachedOptions);
                return true;
            }
            return false;
        }

        function setCachedSpeciesOptions(speciesType, options) {
            // 更新内存缓存
            speciesCache[speciesType] = options;
            speciesCache.lastUpdated = new Date().getTime();

            // 保存到localStorage
            try {
                localStorage.setItem('speciesCache', JSON.stringify(speciesCache));
            } catch (e) {
                console.error('保存缓存失败:', e);
            }

            updateCacheStatusDisplay();
        }

        function isCacheValid(lastUpdated) {
            // 缓存有效期为1小时（3600000毫秒）
            const CACHE_DURATION = 60 * 60 * 1000;
            const timestamp = lastUpdated || speciesCache.lastUpdated;
            return timestamp && (new Date().getTime() - timestamp) < CACHE_DURATION;
        }

        function clearSpeciesCache() {
            // 清除内存缓存
            speciesCache = {
                bigSpecies: null,
                smallSpecies: null,
                sampleStage: null,
                fullModel: null,
                version: null,
                problemCategory: null,
                tester: null,
                responsibleDepartment: null,
                testPlatform: null,
                testDevice: null,
                lastUpdated: null
            };

            // 清除localStorage缓存
            try {
                localStorage.removeItem('speciesCache');
            } catch (e) {
                console.error('清除缓存失败:', e);
            }

            updateCacheStatusDisplay();
        }

        function loadCacheFromStorage() {
            try {
                const cached = localStorage.getItem('speciesCache');
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    if (isCacheValid(parsedCache.lastUpdated)) {
                        // 恢复缓存到内存
                        speciesCache = parsedCache;
                        // console.log('缓存已从localStorage恢复');

                        // 从缓存加载选项到下拉框
                        loadOptionsFromCache();
                    } else {
                        // console.log('localStorage中的缓存已过期');
                    }
                }
            } catch (e) {
                console.error('从localStorage加载缓存失败:', e);
            }
        }

        function loadOptionsFromCache() {
            // 加载大类选项
            if (speciesCache.bigSpecies && speciesCache.bigSpecies.length > 0) {
                updateSelectOptions('bigSpeciesFilter', speciesCache.bigSpecies);
                // console.log('大类选项已从缓存加载');
            }

            // 加载小类选项
            if (speciesCache.smallSpecies && speciesCache.smallSpecies.length > 0) {
                updateSelectOptions('smallSpeciesFilter', speciesCache.smallSpecies);
                // console.log('小类选项已从缓存加载');
            }

            // 加载样品阶段选项
            if (speciesCache.sampleStage && speciesCache.sampleStage.length > 0) {
                updateSelectOptions('sampleStageFilter', speciesCache.sampleStage);
                // console.log('样品阶段选项已从缓存加载');
            }

            // 加载完整编码选项
            if (speciesCache.fullModel && speciesCache.fullModel.length > 0) {
                updateSelectOptions('fullModelFilter', speciesCache.fullModel);
                // console.log('完整编码选项已从缓存加载');
            }

            // 加载版本选项
            if (speciesCache.version && speciesCache.version.length > 0) {
                updateSelectOptions('versionFilter', speciesCache.version);
                // console.log('版本选项已从缓存加载');
            }

            // 加载问题类别选项（三级结构）
            if (speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
                // 对于三级结构，我们不需要直接更新下拉框选项
                // 因为三级结构是通过配置文件动态生成的
                // console.log('问题类别选项已从缓存加载（三级结构）');
            }

            // 加载测试人员选项
            if (speciesCache.tester && speciesCache.tester.length > 0) {
                updateSelectOptions('testerFilter', speciesCache.tester);
                // console.log('测试人员选项已从缓存加载');
            }

            // 加载责任部门选项
            if (speciesCache.responsibleDepartment && speciesCache.responsibleDepartment.length > 0) {
                updateSelectOptions('responsibleDepartmentFilter', speciesCache.responsibleDepartment);
                // console.log('责任部门选项已从缓存加载');
            }

            // 加载测试平台选项
            if (speciesCache.testPlatform && speciesCache.testPlatform.length > 0) {
                updateSelectOptions('testPlatformFilter', speciesCache.testPlatform);
                // console.log('测试平台选项已从缓存加载');
            }

            // 加载显示设备选项
            if (speciesCache.testDevice && speciesCache.testDevice.length > 0) {
                updateSelectOptions('testDeviceFilter', speciesCache.testDevice);
                // console.log('显示设备选项已从缓存加载');
            }

            // 加载DQE负责人选项
            if (speciesCache.dqe && speciesCache.dqe.length > 0) {
                updateSelectOptions('dqeFilter', speciesCache.dqe);
                // console.log('DQE负责人选项已从缓存加载');
            }
        }

        function updateCacheStatusDisplay() {
            const cacheStatusElement = document.getElementById('cacheStatus');
            if (!cacheStatusElement) return;

            if (speciesCache.lastUpdated && isCacheValid()) {
                const timeAgo = Math.floor((new Date().getTime() - speciesCache.lastUpdated) / 1000 / 60);
                cacheStatusElement.textContent = `缓存有效 (${timeAgo}分钟前)`;
                cacheStatusElement.style.color = '#28a745';
            } else if (speciesCache.lastUpdated) {
                cacheStatusElement.textContent = '缓存已过期';
                cacheStatusElement.style.color = '#ffc107';
            } else {
                cacheStatusElement.textContent = '无缓存';
                cacheStatusElement.style.color = '#6c757d';
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户权限
            checkUserPermission();

            // 初始化事件监听器
            initEventListeners();

            // 初始化缓存状态显示
            loadCacheFromStorage();
            updateCacheStatusDisplay();

            // 初始化问题类别筛选器（在缓存加载后）
            initProblemCategoryFilter();

            // 如果问题类别缓存为空或过期，自动从数据库获取
            if (!speciesCache.problemCategory || speciesCache.problemCategory.length === 0) {
                // console.log('问题类别缓存为空，自动从数据库获取');
                fetchSpeciesOptionsFromServer('problemCategory');
            }

            // 初始化购物车
            loadCartFromStorage();
            updateCartCount();

            // 确保分页控件可见
            const paginationContainer = document.querySelector('.pagination-container');
            if (paginationContainer) {
                paginationContainer.style.display = 'flex';
                // console.log('分页控件已显示');
            } else {
                console.error('找不到分页控件');
            }

            // 加载数据
            loadProblemData();
        });

        // 初始化问题类别筛选器（三级结构）
        function initProblemCategoryFilter() {
            // 初始化一级下拉框
            const level1Select = document.getElementById('problemCategoryLevel1Filter');
            if (level1Select) {
                level1Select.innerHTML = '<option value="">全部</option>';
                
                // 优先从缓存加载，如果没有缓存则从配置文件加载
                if (speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
                    // 从缓存数据中提取一级分类
                    const level1Options = extractLevel1FromCache(speciesCache.problemCategory);
                    level1Options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        level1Select.appendChild(optionElement);
                    });
                    console.log('问题类别一级选项已从缓存加载，共', level1Options.length, '个选项');
                    console.log('一级分类选项详情:', level1Options);
                } else if (typeof getLevel1Categories === 'function') {
                    // 从配置文件加载
                    const level1Options = getLevel1Categories();
                    level1Options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        level1Select.appendChild(optionElement);
                    });
                    console.log('问题类别一级选项已从配置文件加载，共', level1Options.length, '个选项');
                    console.log('一级分类选项详情:', level1Options);
                } else {
                    // console.log('问题类别选项暂时为空，等待数据库数据加载');
                }
            }

            // 初始化二级和三级下拉框
            const level2Select = document.getElementById('problemCategoryLevel2Filter');
            const level3Select = document.getElementById('problemCategoryLevel3Filter');
            if (level2Select) level2Select.innerHTML = '<option value="">全部</option>';
            if (level3Select) level3Select.innerHTML = '<option value="">全部</option>';

            // 添加级联事件监听器（避免重复添加）
            if (level1Select && !level1Select.hasAttribute('data-listener-added')) {
                level1Select.addEventListener('change', function() {
                    updateLevel2Options();
                });
                level1Select.setAttribute('data-listener-added', 'true');
            }

            if (level2Select && !level2Select.hasAttribute('data-listener-added')) {
                level2Select.addEventListener('change', function() {
                    updateLevel3Options();
                });
                level2Select.setAttribute('data-listener-added', 'true');
            }

            // 初始化手动输入功能
            initCategoryInputHandlers();

            // 添加全局点击事件，隐藏所有建议框
            document.addEventListener('click', function(e) {
                // 检查点击是否在建议框或输入框内
                if (!e.target.closest('.input-with-suggestions') && !e.target.closest('.toggle-input-btn')) {
                    // 隐藏所有建议框
                    document.querySelectorAll('.suggestions-dropdown').forEach(suggestions => {
                        hideSuggestions(suggestions);
                    });
                }
            });

            // console.log('三级问题类别筛选器初始化完成');
        }

        // 初始化问题类别手动输入功能
        function initCategoryInputHandlers() {
            // 为所有切换按钮添加事件监听器
            document.querySelectorAll('.toggle-input-btn').forEach(btn => {
                if (!btn.hasAttribute('data-listener-added')) {
                    btn.addEventListener('click', function() {
                        const targetId = this.getAttribute('data-target');
                        const targetInput = document.getElementById(targetId);
                        const targetSelect = this.parentElement.querySelector('.category-select');
                        const level = targetId.replace('problemCategoryLevel', '').replace('Input', '');
                        const suggestionsId = `problemCategoryLevel${level}Suggestions`;
                        const suggestions = document.getElementById(suggestionsId);
                        
                        if (targetInput && targetSelect) {
                            // 切换显示状态
                            if (targetInput.style.display === 'none') {
                                // 显示输入框，隐藏下拉框
                                targetInput.style.display = 'block';
                                targetSelect.style.display = 'none';
                                this.classList.add('active');
                                this.innerHTML = '<i class="fas fa-list"></i>';
                                this.title = '切换下拉选择';
                                
                                // 清空输入框和建议框
                                targetInput.value = '';
                                if (suggestions) {
                                    hideSuggestions(suggestions);
                                }
                                
                                // 聚焦到输入框
                                setTimeout(() => targetInput.focus(), 100);
                            } else {
                                // 显示下拉框，隐藏输入框
                                targetInput.style.display = 'none';
                                targetSelect.style.display = 'block';
                                this.classList.remove('active');
                                this.innerHTML = '<i class="fas fa-edit"></i>';
                                this.title = '切换手动输入';
                                
                                // 清空输入框和建议框
                                targetInput.value = '';
                                if (suggestions) {
                                    hideSuggestions(suggestions);
                                }
                            }
                        }
                    });
                    btn.setAttribute('data-listener-added', 'true');
                }
            });

            // 为所有输入框添加事件监听器
            document.querySelectorAll('.category-input').forEach(input => {
                if (!input.hasAttribute('data-listener-added')) {
                    const level = input.id.replace('problemCategoryLevel', '').replace('Input', '');
                    const suggestionsId = `problemCategoryLevel${level}Suggestions`;
                    const suggestions = document.getElementById(suggestionsId);
                    
                    // 输入事件 - 实时搜索
                    input.addEventListener('input', function() {
                        searchCategoryOptions(level, this.value);
                    });

                    // 键盘事件 - 导航和选择
                    input.addEventListener('keydown', function(e) {
                        handleInputKeydown(e, this, suggestions, level);
                    });

                    // 失去焦点事件 - 延迟隐藏建议框
                    input.addEventListener('blur', function() {
                        setTimeout(() => {
                            hideSuggestions(suggestions);
                            const level = this.id.replace('problemCategoryLevel', '').replace('Input', '');
                            if (this.value.trim()) {
                                confirmCategoryInput(level, this.value);
                            }
                        }, 200);
                    });

                    // 获得焦点事件 - 重新显示建议
                    input.addEventListener('focus', function() {
                        if (this.value.trim()) {
                            searchCategoryOptions(level, this.value);
                        }
                    });

                    input.setAttribute('data-listener-added', 'true');
                }
            });
        }

        // 搜索问题类别选项
        function searchCategoryOptions(level, searchText) {
            const levelNum = parseInt(level);
            const inputId = `problemCategoryLevel${levelNum}Input`;
            const suggestionsId = `problemCategoryLevel${levelNum}Suggestions`;
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            if (!input || !suggestions) return;

            // 清空之前的建议
            suggestions.innerHTML = '';
            suggestions.style.display = 'none';

            if (!searchText.trim()) {
                return;
            }

            // 获取所有可用的选项
            let allOptions = [];
            if (speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
                allOptions = speciesCache.problemCategory;
            } else if (typeof getAllProblemCategories === 'function') {
                allOptions = getAllProblemCategories();
            }

            // 根据级别和搜索文本过滤选项
            const filteredOptions = filterCategoryOptionsByLevel(allOptions, levelNum, searchText);
            
            if (filteredOptions.length > 0) {
                // 显示建议下拉框
                showSuggestions(suggestions, filteredOptions, input, levelNum);
            }
        }

        // 根据级别过滤问题类别选项
        function filterCategoryOptionsByLevel(allOptions, level, searchText) {
            const results = [];
            const searchLower = searchText.toLowerCase();

            allOptions.forEach(option => {
                const parts = option.split('-');
                if (parts.length >= level) {
                    const targetPart = parts[level - 1];
                    if (targetPart && targetPart.toLowerCase().includes(searchLower)) {
                        results.push({
                            value: targetPart,
                            text: targetPart,
                            fullValue: option
                        });
                    }
                }
            });

            return results;
        }

        // 显示建议下拉框
        function showSuggestions(suggestions, options, input, level) {
            // 清空之前的建议
            suggestions.innerHTML = '';
            
            // 限制显示的建议数量
            const maxSuggestions = 10;
            const limitedOptions = options.slice(0, maxSuggestions);
            
            limitedOptions.forEach((option, index) => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.setAttribute('data-index', index);
                suggestionItem.setAttribute('data-value', option.value);
                suggestionItem.setAttribute('data-full-value', option.fullValue);
                
                // 高亮匹配的文本
                const highlightedText = highlightMatch(option.text, input.value);
                suggestionItem.innerHTML = `
                    <span class="suggestion-text">${highlightedText}</span>
                    ${option.fullValue ? `<span class="suggestion-hint">${option.fullValue}</span>` : ''}
                `;
                
                // 点击事件
                suggestionItem.addEventListener('click', function() {
                    selectSuggestion(input, option.value, level);
                    hideSuggestions(suggestions);
                });
                
                suggestions.appendChild(suggestionItem);
            });
            
            // 显示建议框
            suggestions.style.display = 'block';
            suggestions.classList.add('show');
        }

        // 高亮匹配的文本
        function highlightMatch(text, searchText) {
            if (!searchText) return text;
            
            const regex = new RegExp(`(${searchText})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        // 选择建议项
        function selectSuggestion(input, value, level) {
            input.value = value;
            
            // 触发确认输入
            confirmCategoryInput(level, value);
        }

        // 隐藏建议下拉框
        function hideSuggestions(suggestions) {
            suggestions.style.display = 'none';
            suggestions.classList.remove('show');
            suggestions.innerHTML = '';
        }

        // 处理输入框键盘事件
        function handleInputKeydown(e, input, suggestions, level) {
            const suggestionItems = suggestions.querySelectorAll('.suggestion-item');
            const highlightedItem = suggestions.querySelector('.suggestion-item.highlighted');
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (suggestionItems.length > 0) {
                        if (highlightedItem) {
                            // 移除当前高亮
                            highlightedItem.classList.remove('highlighted');
                            // 高亮下一个项目
                            const nextIndex = parseInt(highlightedItem.getAttribute('data-index')) + 1;
                            if (nextIndex < suggestionItems.length) {
                                suggestionItems[nextIndex].classList.add('highlighted');
                            } else {
                                suggestionItems[0].classList.add('highlighted');
                            }
                        } else {
                            // 高亮第一个项目
                            suggestionItems[0].classList.add('highlighted');
                        }
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (suggestionItems.length > 0) {
                        if (highlightedItem) {
                            // 移除当前高亮
                            highlightedItem.classList.remove('highlighted');
                            // 高亮上一个项目
                            const prevIndex = parseInt(highlightedItem.getAttribute('data-index')) - 1;
                            if (prevIndex >= 0) {
                                suggestionItems[prevIndex].classList.add('highlighted');
                            } else {
                                suggestionItems[suggestionItems.length - 1].classList.add('highlighted');
                            }
                        } else {
                            // 高亮最后一个项目
                            suggestionItems[suggestionItems.length - 1].classList.add('highlighted');
                        }
                    }
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (highlightedItem) {
                        // 选择高亮的项目
                        const value = highlightedItem.getAttribute('data-value');
                        selectSuggestion(input, value, level);
                        hideSuggestions(suggestions);
                    } else if (input.value.trim()) {
                        // 确认当前输入
                        confirmCategoryInput(level, input.value);
                        hideSuggestions(suggestions);
                    }
                    break;
                    
                case 'Escape':
                    e.preventDefault();
                    hideSuggestions(suggestions);
                    break;
            }
        }

        // 确认手动输入的问题类别
        function confirmCategoryInput(level, inputValue) {
            // console.log('=== 手动输入确认 ===');
            // console.log('输入级别:', level);
            // console.log('输入值:', inputValue);
            // console.log('输入值类型:', typeof inputValue);
            // console.log('输入值长度:', inputValue ? inputValue.length : 'undefined');
            
            if (!inputValue.trim()) {
                // console.log('输入值为空，退出');
                return;
            }

            const levelNum = parseInt(level);
            const selectId = `problemCategoryLevel${levelNum}Filter`;
            const select = document.getElementById(selectId);
            
            if (!select) {
                // console.log('找不到选择框:', selectId);
                return;
            }

            const trimmedValue = inputValue.trim();
            // console.log('处理后的值:', trimmedValue);
            
            // 检查该值是否已存在于下拉框中
            const existingOption = select.querySelector(`option[value="${trimmedValue}"]`);
            if (!existingOption) {
                // console.log('值不存在于下拉框中，添加新选项');
                // 如果不存在，则添加新选项
                const newOption = document.createElement('option');
                newOption.value = trimmedValue;
                newOption.textContent = trimmedValue;
                select.appendChild(newOption);
                // console.log('已添加新选项:', trimmedValue);
            } else {
                // console.log('值已存在于下拉框中');
            }

            // 设置选中的值
            select.value = trimmedValue;
            // console.log('设置选中值:', trimmedValue);
            
            // 触发级联更新
            if (levelNum === 1) {
                // console.log('触发二级分类更新');
                updateLevel2Options();
            } else if (levelNum === 2) {
                // console.log('触发三级分类更新');
                updateLevel3Options();
            }

            // 触发筛选更新
            // applyFilters();
            // console.log('=== 手动输入确认完成 ===');
        }

        // 从缓存数据中提取一级分类选项
        function extractLevel1FromCache(cachedData) {
            console.log('=== 开始提取一级分类 ===');
            console.log('问题类别全部原始数据:', cachedData);
            console.log('数据类型:', typeof cachedData, '数组长度:', cachedData ? cachedData.length : 'undefined');
            
            const level1Set = new Set();
            cachedData.forEach((item, index) => {
                console.log(`处理第${index}项:`, item, '类型:', typeof item);
                if (item && item.trim() !== '') {
                    if (item.includes('-')) {
                        // 处理有分隔符的格式：aaa-xxx-xxx
                        const parts = item.split('-');
                        console.log('分割后的部分:', parts);
                        if (parts.length >= 1 && parts[0].trim() !== '') {
                            const level1Value = parts[0].trim();
                            level1Set.add(level1Value);
                            console.log('✓ 添加有分隔符的一级分类:', level1Value);
                        }
                    } else {
                        // 处理无分隔符的格式：ccc
                        const level1Value = item.trim();
                        level1Set.add(level1Value);
                        console.log('✓ 添加无分隔符的一级分类:', level1Value);
                    }
                } else {
                    console.log('✗ 跳过空项:', item);
                }
            });
            
            const result = Array.from(level1Set).map(item => ({
                value: item,
                text: item
            }));
            console.log('=== 一级分类提取完成 ===');
            console.log('找到的一级分类:', result);
            console.log('一级分类数量:', result.length);
            return result;
        }

        // 从缓存数据中提取二级分类选项
        function extractLevel2FromCache(cachedData, level1) {
            // console.log('=== 开始提取二级分类 ===');
            // console.log('问题类别全部原始数据:', cachedData);
            // console.log('数据类型:', typeof cachedData, '数组长度:', cachedData ? cachedData.length : 'undefined');
            // console.log('选中的一级分类:', level1);
            
            const level2Set = new Set();
            const searchPrefix = level1 + '-';
            // console.log('搜索前缀:', searchPrefix);
            
            cachedData.forEach((item, index) => {
                // console.log(`\n--- 检查第${index}项 ---`);
                // console.log('原始项目:', item, '类型:', typeof item);
                
                if (item && item.trim() !== '') {
                    const trimmedItem = item.trim();
                    // console.log('处理后的项目:', trimmedItem);
                    // console.log('是否包含分隔符:', trimmedItem.includes('-'));
                    // console.log('是否以前缀开头:', trimmedItem.startsWith(searchPrefix));
                    
                    if (trimmedItem.includes('-') && trimmedItem.startsWith(searchPrefix)) {
                        // 处理有分隔符的格式：aaa-xxx-xxx
                        const parts = trimmedItem.split('-');
                        // console.log('分割后的部分:', parts);
                        // console.log('分割后长度:', parts.length);
                        
                        if (parts.length >= 2 && parts[1] && parts[1].trim() !== '') {
                            const level2Value = parts[1].trim();
                            level2Set.add(level2Value);
                            // console.log('✓ 添加二级分类:', level2Value);
                        } else {
                            // console.log('✗ 分割后第二部分为空或不存在');
                        }
                    } else if (!trimmedItem.includes('-') && trimmedItem === level1) {
                        // 处理无分隔符的格式：如果是一级分类本身，则没有二级分类
                        // console.log('○ 无分隔符的一级分类，跳过二级分类提取');
                    } else {
                        // console.log('✗ 项目不匹配一级分类');
                        // console.log('  - 项目值:', trimmedItem);
                        // console.log('  - 是否包含分隔符:', trimmedItem.includes('-'));
                        // console.log('  - 是否以前缀开头:', trimmedItem.startsWith(searchPrefix));
                        // console.log('  - 期望的前缀:', searchPrefix);
                    }
                } else {
                    // console.log('✗ 项目为空或无效:', item);
                }
            });
            
            const result = Array.from(level2Set).map(item => ({
                value: item,
                text: item
            }));
            // console.log('=== 二级分类提取完成 ===');
            // console.log('找到的二级分类:', result);
            // console.log('二级分类数量:', result.length);
            return result;
        }

        // 从缓存数据中提取三级分类选项
        function extractLevel3FromCache(cachedData, level1, level2) {
            // console.log('=== 开始提取三级分类 ===');
            // console.log('问题类别全部原始数据:', cachedData);
            // console.log('数据类型:', typeof cachedData, '数组长度:', cachedData ? cachedData.length : 'undefined');
            // console.log('选中的一级分类:', level1);
            // console.log('选中的二级分类:', level2);
            
            const level3Set = new Set();
            const prefix = level1 + '-' + level2 + '-';
            // console.log('搜索前缀:', prefix);
            
            cachedData.forEach((item, index) => {
                // console.log(`\n--- 检查第${index}项 ---`);
                // console.log('原始项目:', item, '类型:', typeof item);
                
                if (item && item.trim() !== '') {
                    const trimmedItem = item.trim();
                    // console.log('处理后的项目:', trimmedItem);
                    // console.log('是否包含分隔符:', trimmedItem.includes('-'));
                    // console.log('是否以前缀开头:', trimmedItem.startsWith(prefix));
                    
                    if (trimmedItem.includes('-') && trimmedItem.startsWith(prefix)) {
                        // 处理有分隔符的格式：aaa-xxx-xxx
                        const parts = trimmedItem.split('-');
                        // console.log('分割后的部分:', parts);
                        // console.log('分割后长度:', parts.length);
                        
                        if (parts.length >= 3 && parts[2] && parts[2].trim() !== '') {
                            const level3Value = parts[2].trim();
                            level3Set.add(level3Value);
                            // console.log('✓ 添加三级分类:', level3Value);
                        } else {
                            // console.log('✗ 分割后第三部分为空或不存在');
                        }
                    } else if (!trimmedItem.includes('-') && trimmedItem === level1) {
                        // 处理无分隔符的格式：如果是一级分类本身，则没有三级分类
                        // console.log('○ 无分隔符的一级分类，跳过三级分类提取');
                    } else {
                        // console.log('✗ 项目不匹配二级分类');
                        // console.log('  - 项目值:', trimmedItem);
                        // console.log('  - 是否包含分隔符:', trimmedItem.includes('-'));
                        // console.log('  - 是否以前缀开头:', trimmedItem.startsWith(prefix));
                        // console.log('  - 期望的前缀:', prefix);
                    }
                } else {
                    // console.log('✗ 项目为空或无效:', item);
                }
            });
            
            const result = Array.from(level3Set).map(item => ({
                value: item,
                text: item
            }));
            // console.log('=== 三级分类提取完成 ===');
            // console.log('找到的三级分类:', result);
            // console.log('三级分类数量:', result.length);
            return result;
        }

        // 更新二级下拉框选项
        function updateLevel2Options() {
            const level1Select = document.getElementById('problemCategoryLevel1Filter');
            const level2Select = document.getElementById('problemCategoryLevel2Filter');
            const level3Select = document.getElementById('problemCategoryLevel3Filter');
            
            if (!level1Select || !level2Select || !level3Select) return;

            const selectedLevel1 = level1Select.value;
            
            // 清空二级和三级下拉框
            level2Select.innerHTML = '<option value="">全部</option>';
            level3Select.innerHTML = '<option value="">全部</option>';

            if (selectedLevel1) {
                let level2Options = [];
                
                // 优先从当前搜索数据中提取二级分类
                if (filteredData && filteredData.length > 0) {
                    level2Options = extractLevel2FromCurrentData(selectedLevel1);
                }
                
                // 如果当前数据中没有找到，则从缓存数据中提取
                if (level2Options.length === 0 && speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
                    // console.log('从缓存提取二级分类，缓存数据:', speciesCache.problemCategory);
                    // console.log('选中的一级分类:', selectedLevel1);
                    level2Options = extractLevel2FromCache(speciesCache.problemCategory, selectedLevel1);
                    // console.log('提取的二级分类选项:', level2Options);
                } else if (level2Options.length === 0 && typeof getLevel2Categories === 'function') {
                    // 从配置文件获取
                    level2Options = getLevel2Categories(selectedLevel1);
                }
                
                if (level2Options.length > 0) {
                    // 有二级选项，正常添加
                    level2Options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        level2Select.appendChild(optionElement);
                    });
                } else {
                    // 没有二级选项，显示提示信息
                    level2Select.innerHTML = '<option value="">无二级分类</option>';
                }
            }

            // 如果二级输入框是显示状态，清空它
            const level2Input = document.getElementById('problemCategoryLevel2Input');
            if (level2Input && level2Input.style.display !== 'none') {
                level2Input.value = '';
            }
        }

        // 更新三级下拉框选项
        function updateLevel3Options() {
            const level1Select = document.getElementById('problemCategoryLevel1Filter');
            const level2Select = document.getElementById('problemCategoryLevel2Filter');
            const level3Select = document.getElementById('problemCategoryLevel3Filter');
            
            if (!level1Select || !level2Select || !level3Select) return;

            const selectedLevel1 = level1Select.value;
            const selectedLevel2 = level2Select.value;
            
            // 清空三级下拉框
            level3Select.innerHTML = '<option value="">全部</option>';

            if (selectedLevel1 && selectedLevel2) {
                let level3Options = [];
                
                // 优先从当前搜索数据中提取三级分类
                if (filteredData && filteredData.length > 0) {
                    level3Options = extractLevel3FromCurrentData(selectedLevel1, selectedLevel2);
                }
                
                // 如果当前数据中没有找到，则从缓存数据中提取
                if (level3Options.length === 0 && speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
                    level3Options = extractLevel3FromCache(speciesCache.problemCategory, selectedLevel1, selectedLevel2);
                } else if (level3Options.length === 0 && typeof getLevel3Categories === 'function') {
                    // 从配置文件获取
                    level3Options = getLevel3Categories(selectedLevel1, selectedLevel2);
                }
                
                if (level3Options.length > 0) {
                    // 有三级选项，正常添加
                    level3Options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        level3Select.appendChild(optionElement);
                    });
                } else {
                    // 没有三级选项，显示提示信息
                    level3Select.innerHTML = '<option value="">无三级分类</option>';
                }
            }

            // 如果三级输入框是显示状态，清空它
            const level3Input = document.getElementById('problemCategoryLevel3Input');
            if (level3Input && level3Input.style.display !== 'none') {
                level3Input.value = '';
            }
        }

        // 解析URL参数
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 检查用户权限
        function checkUserPermission() {
            // 优先从URL参数获取用户信息，其次从localStorage获取
            const urlUsername = getUrlParameter('username');
            const urlJob = getUrlParameter('job');
            
            currentUser = urlUsername || localStorage.getItem('username');
            currentRole = urlJob || localStorage.getItem('job');

            // 如果URL参数存在，更新localStorage
            if (urlUsername) {
                localStorage.setItem('username', urlUsername);
            }
            if (urlJob) {
                localStorage.setItem('job', urlJob);
            }

            if (!currentUser || !currentRole) {
                alert('请先登录并选择角色！');
                window.location.href = '/DQEIndex';
                return;
            }

            // 检查是否为超级管理员
            isSuperAdmin = (currentUser === '卢健' && currentRole === 'manager');

            // 显示用户信息
            document.getElementById('currentUser').textContent = `用户: ${currentUser}`;
            document.getElementById('currentRole').textContent = `角色: ${currentRole}`;

            // 根据权限控制界面元素
            controlEditPermissions();
        }

        // 控制编辑权限
        function controlEditPermissions() {
            // 新增问题点按钮已移除，无需控制
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 搜索按钮
            document.getElementById('searchBtn').addEventListener('click', searchProblems);

            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', resetFilters);

            // 为筛选输入框添加回车键搜索功能
            const filterInputs = [
                'fullModelFilter', 'sampleStageFilter', 'versionFilter', 'bigSpeciesFilter', 'smallSpeciesFilter',
                'testerFilter', 'dqeFilter', 'problemFilter', 'testPlatformFilter', 'testDeviceFilter', 'otherDeviceFilter'
            ];

            filterInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            searchProblems();
                        }
                    });
                }
            });

            // 导出按钮
            document.getElementById('exportBtn').addEventListener('click', exportFilteredData);

            // 加入收藏夹按钮
            document.getElementById('addToCartBtn').addEventListener('click', addToCart);

            // 查看收藏夹按钮
            document.getElementById('showCartBtn').addEventListener('click', showCartModal);

            // 收藏夹相关按钮
            document.getElementById('clearCartBtn').addEventListener('click', clearCart);
            document.getElementById('exportCartBtn').addEventListener('click', exportCartData);
            document.getElementById('mergeCartBtn').addEventListener('click', mergeCartData);
            document.getElementById('closeCartModal').addEventListener('click', function() {
                closeSpecificModal('cartModal');
            });

            // 刷新所有选项按钮
            document.getElementById('refreshAllOptionsBtn').addEventListener('click', function() {
                refreshAllOptions();
            });



            // 分页按钮
            document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));
            document.getElementById('lastPageBtn').addEventListener('click', () => goToLastPage());

            // 每页显示数量选择器
            document.getElementById('pageSizeSelect').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                renderTable();
            });

            // 页码跳转
            document.getElementById('pageJumpBtn').addEventListener('click', jumpToPage);
            document.getElementById('pageJumpInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });

            // 保存问题点
            document.getElementById('saveProblemBtn').addEventListener('click', saveProblem);

            // 取消编辑（编辑模态框的取消按钮）
            document.getElementById('cancelEditBtn').addEventListener('click', function() {
                // 检查当前是否在编辑模态框中
                const editModal = document.getElementById('editProblemModal');
                if (editModal && editModal.style.display === 'block') {
                    closeModal(); // 关闭编辑模态框
                } else {
                    exitEditMode(); // 退出详情模态框的编辑模式
                }
            });

            // 关闭历史版本模态框
            document.getElementById('closeHistoryModal').addEventListener('click', closeModal);

            // 关闭详情模态框
            document.getElementById('closeDetailModal').addEventListener('click', function() {
                closeSpecificModal('problemDetailModal');
            });

            // 详情模态框编辑按钮
            document.getElementById('editProblemBtn').addEventListener('click', function() {
                enterEditMode();
            });

            // 保存详情按钮
            document.getElementById('saveDetailBtn').addEventListener('click', function() {
                saveDetailChanges();
            });



            // 使用事件委托来处理所有关闭按钮
            document.addEventListener('click', function(event) {
                // 处理X按钮关闭
                if (event.target.classList.contains('close')) {
                    // 找到最近的模态框并关闭
                    const modal = event.target.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                    return;
                }

                // 处理点击模态框外部关闭
                if (event.target.classList.contains('modal')) {
                    // 只关闭被点击的模态框
                    event.target.style.display = 'none';
                    return;
                }
            });

            // 提示框事件监听器
            const toast = document.getElementById('customToast');
            const toastClose = document.getElementById('toastClose');

            // 点击关闭按钮
            toastClose.addEventListener('click', hideToast);

            // 点击提示框外部关闭
            toast.addEventListener('click', function(event) {
                if (event.target === toast) {
                    hideToast();
                }
            });

            // 全选收藏夹项目复选框
            document.getElementById('selectAllCartItems').addEventListener('change', toggleSelectAllCartItems);

            // 问题图片编辑字段事件监听器
            const editImageField = document.getElementById('editProblemImage');
            if (editImageField) {
                editImageField.addEventListener('input', updateImagePreview);
                editImageField.addEventListener('blur', updateImagePreview);
            }
        }

        // 加载问题点数据
        function loadProblemData() {
            showLoading();

            // 使用searchProblems接口，传入空的筛选条件来获取所有数据
            const filters = {};

            fetch('/problemLibrary/searchProblems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    filteredData = data.data;
                    updateStatistics();
                    renderTable();
                } else {
                    alert('加载数据失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('加载数据时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 生成问题类别搜索关键字
        function generateProblemCategorySearchKeyword() {
            // 获取下拉框的值
            let level1 = document.getElementById('problemCategoryLevel1Filter').value;
            let level2 = document.getElementById('problemCategoryLevel2Filter').value;
            let level3 = document.getElementById('problemCategoryLevel3Filter').value;
            
            // 检查是否有手动输入的值，如果有则优先使用手动输入的值
            const level1Input = document.getElementById('problemCategoryLevel1Input');
            const level2Input = document.getElementById('problemCategoryLevel2Input');
            const level3Input = document.getElementById('problemCategoryLevel3Input');
            
            if (level1Input && level1Input.style.display !== 'none' && level1Input.value.trim()) {
                level1 = level1Input.value.trim();
            }
            if (level2Input && level2Input.style.display !== 'none' && level2Input.value.trim()) {
                level2 = level2Input.value.trim();
            }
            if (level3Input && level3Input.style.display !== 'none' && level3Input.value.trim()) {
                level3 = level3Input.value.trim();
            }
            
            if (typeof generateSearchKeyword === 'function') {
                return generateSearchKeyword(level1, level2, level3);
            }
            
            // 备用方案：手动生成关键字
            let keyword = '';
            if (level1) {
                keyword = level1;
                if (level2) {
                    keyword += '-' + level2;
                    if (level3) {
                        keyword += '-' + level3;
                    }
                }
            }
            
            return keyword;
        }

        // 搜索问题点
        function searchProblems() {
            showLoading();

            // 生成问题类别搜索关键字
            const problemCategoryKeyword = generateProblemCategorySearchKeyword();

            const filters = {
                fullModel: document.getElementById('fullModelFilter').value,
                sampleStage: document.getElementById('sampleStageFilter').value,
                version: document.getElementById('versionFilter').value,
                bigSpecies: document.getElementById('bigSpeciesFilter').value,
                smallSpecies: document.getElementById('smallSpeciesFilter').value,
                problemCategory: problemCategoryKeyword,
                defectLevel: document.getElementById('defectLevelFilter').value,
                currentStatus: document.getElementById('currentStatusFilter').value,
                tester: document.getElementById('testerFilter').value,
                responsibleDepartment: document.getElementById('responsibleDepartmentFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value,
                dqe: document.getElementById('dqeFilter').value,
                problem: document.getElementById('problemFilter').value,
                testPlatform: document.getElementById('testPlatformFilter').value,
                testDevice: document.getElementById('testDeviceFilter').value,
                otherDevice: document.getElementById('otherDeviceFilter').value
            };

            fetch('/problemLibrary/searchProblems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    filteredData = data.data;
                    currentPage = 1;
                    updateStatistics();
                    renderTable();
                } else {
                    alert('搜索失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('搜索时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById('fullModelFilter').value = '';
            document.getElementById('sampleStageFilter').value = '';
            document.getElementById('versionFilter').value = '';
            document.getElementById('bigSpeciesFilter').value = '';
            document.getElementById('smallSpeciesFilter').value = '';
            
            // 重置三级问题类别筛选器
            document.getElementById('problemCategoryLevel1Filter').value = '';
            document.getElementById('problemCategoryLevel2Filter').value = '';
            document.getElementById('problemCategoryLevel3Filter').value = '';
            
            // 清空手动输入框
            const level1Input = document.getElementById('problemCategoryLevel1Input');
            const level2Input = document.getElementById('problemCategoryLevel2Input');
            const level3Input = document.getElementById('problemCategoryLevel3Input');
            
            if (level1Input) level1Input.value = '';
            if (level2Input) level2Input.value = '';
            if (level3Input) level3Input.value = '';
            
            // 清空二级和三级下拉框选项
            updateLevel2Options();
            
            document.getElementById('defectLevelFilter').value = '';
            document.getElementById('currentStatusFilter').value = '';
            document.getElementById('testerFilter').value = '';
            document.getElementById('responsibleDepartmentFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('dqeFilter').value = '';
            document.getElementById('problemFilter').value = '';
            document.getElementById('testPlatformFilter').value = '';
            document.getElementById('testDeviceFilter').value = '';
            document.getElementById('otherDeviceFilter').value = '';

            loadProblemData();
        }

        // 导出筛选结果
        function exportFilteredData() {
            if (filteredData.length === 0) {
                alert('没有数据可导出');
                return;
            }

            showLoading();

            // 使用当前的筛选条件
            const filters = {
                fullModel: document.getElementById('fullModelFilter').value,
                sampleStage: document.getElementById('sampleStageFilter').value,
                version: document.getElementById('versionFilter').value,
                bigSpecies: document.getElementById('bigSpeciesFilter').value,
                smallSpecies: document.getElementById('smallSpeciesFilter').value,
                problemCategory: generateProblemCategorySearchKeyword(),
                defectLevel: document.getElementById('defectLevelFilter').value,
                currentStatus: document.getElementById('currentStatusFilter').value,
                tester: document.getElementById('testerFilter').value,
                responsibleDepartment: document.getElementById('responsibleDepartmentFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value,
                dqe: document.getElementById('dqeFilter').value,
                problem: document.getElementById('problemFilter').value,
                testPlatform: document.getElementById('testPlatformFilter').value,
                testDevice: document.getElementById('testDeviceFilter').value,
                otherDevice: document.getElementById('otherDeviceFilter').value
            };

            fetch('/problemLibrary/exportProblems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('导出失败');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `问题点库_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('导出时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 显示问题点详情
        function showProblemDetail(problemId) {
            // 首先尝试从当前过滤数据中查找
            let problem = filteredData.find(p => p.id === problemId);

            // 如果没找到，说明是从历史版本模态框中点击的，需要通过API获取详情
            if (!problem) {
                showLoading();
                fetch(`/problemLibrary/getProblemById?id=${problemId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        problem = data.data;
                        displayProblemDetail(problem);
                    } else {
                        alert('获取问题点详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取问题点详情时发生错误');
                })
                .finally(() => {
                    hideLoading();
                });
                return;
            }

            displayProblemDetail(problem);
        }

        // 显示问题点详情的具体实现
        function displayProblemDetail(problem) {
            // 填充详情数据
            document.getElementById('detailFullModel').textContent = problem.full_model || '';
            document.getElementById('detailSampleId').textContent = problem.sample_id || '';
            document.getElementById('detailBigSpecies').textContent = problem.big_species || '';
            document.getElementById('detailSmallSpecies').textContent = problem.small_species || '';
            document.getElementById('detailSampleStage').textContent = problem.sample_stage || '';
            document.getElementById('detailVersion').textContent = problem.version || '';
            document.getElementById('detailChipSolution').textContent = problem.chip_solution || '';
            document.getElementById('detailTestPlatform').textContent = problem.test_platform || '';
            document.getElementById('detailTestDevice').textContent = problem.test_device || '';
            document.getElementById('detailOtherDevice').textContent = problem.other_device || '';
            document.getElementById('detailProblem').textContent = problem.problem || '';

            // 显示问题图片
            displayProblemImages(problem.problem_image_or_video);

            document.getElementById('detailProblemCategory').textContent = problem.problemCategory || '';
            document.getElementById('detailDefectLevel').textContent = problem.defect_level || '';
            document.getElementById('detailCurrentStatus').textContent = normalizeStatus(problem.current_status);
            document.getElementById('detailReproductionMethod').textContent = problem.reproduction_method || '';
            document.getElementById('detailRecoveryMethod').textContent = problem.recovery_method || '';
            document.getElementById('detailReproductionProbability').textContent = problem.reproduction_probability || '';
            document.getElementById('detailTester').textContent = problem.tester || '';
            document.getElementById('detailResponsibleDepartment').textContent = problem.responsibleDepartment || '';
            document.getElementById('detailResponsiblePerson').textContent = problem.responsible_person || '';
            document.getElementById('detailDqeConfirm').textContent = problem.dqe_confirm || '';
            document.getElementById('detailRdConfirm').textContent = problem.rd_confirm || '';
            document.getElementById('detailImprovementPlan').textContent = problem.improvement_plan || '';
            document.getElementById('detailGreenUnionDqe').textContent = problem.green_union_dqe || '';
            document.getElementById('detailGreenUnionRd').textContent = problem.green_union_rd || '';
            document.getElementById('detailComparisonWithPrevious').textContent = problem.comparison_with_previous || '';
            document.getElementById('detailPostImprovementRisk').textContent = problem.post_improvement_risk || '';
            document.getElementById('detailNextVersionRegressionTest').textContent = problem.next_version_regression_test || '';
            document.getElementById('detailRemark').textContent = problem.remark || '';
            document.getElementById('detailTestOverseas').textContent = problem.test_Overseas || '';
            document.getElementById('detailCreatedAt').textContent = problem.created_at || '';

            // 设置问题ID
            document.getElementById('editProblemId').value = problem.id;

            // 同步编辑输入框的值
            document.getElementById('editDetailFullModel').value = problem.full_model || '';
            document.getElementById('editDetailBigSpecies').value = problem.big_species || '';
            document.getElementById('editDetailSmallSpecies').value = problem.small_species || '';
            document.getElementById('editDetailSampleStage').value = problem.sample_stage || '';
            document.getElementById('editDetailVersion').value = problem.version || '';
            document.getElementById('editDetailChipSolution').value = problem.chip_solution || '';
            document.getElementById('editDetailTestPlatform').value = problem.test_platform || '';
            document.getElementById('editDetailTestDevice').value = problem.test_device || '';
            document.getElementById('editDetailOtherDevice').value = problem.other_device || '';
            document.getElementById('editDetailProblem').value = problem.problem || '';
            document.getElementById('editDetailProblemCategory').value = problem.problemCategory || '';
            document.getElementById('editDetailDefectLevel').value = problem.defect_level || '';
            document.getElementById('editDetailCurrentStatus').value = normalizeStatus(problem.current_status);
            document.getElementById('editDetailReproductionMethod').value = problem.reproduction_method || '';
            document.getElementById('editDetailRecoveryMethod').value = problem.recovery_method || '';
            document.getElementById('editDetailReproductionProbability').value = problem.reproduction_probability || '';
            document.getElementById('editDetailTester').value = problem.tester || '';
            document.getElementById('editDetailResponsibleDepartment').value = problem.responsibleDepartment || '';
            document.getElementById('editDetailResponsiblePerson').value = problem.responsible_person || '';
            document.getElementById('editDetailDqeConfirm').value = problem.dqe_confirm || '';
            document.getElementById('editDetailRdConfirm').value = problem.rd_confirm || '';
            document.getElementById('editDetailImprovementPlan').value = problem.improvement_plan || '';
            document.getElementById('editDetailGreenUnionDqe').value = problem.green_union_dqe || '';
            document.getElementById('editDetailGreenUnionRd').value = problem.green_union_rd || '';
            document.getElementById('editDetailComparisonWithPrevious').value = problem.comparison_with_previous || '';
            document.getElementById('editDetailPostImprovementRisk').value = problem.post_improvement_risk || '';
            document.getElementById('editDetailNextVersionRegressionTest').value = problem.next_version_regression_test || '';
            document.getElementById('editDetailRemark').value = problem.remark || '';
            document.getElementById('editDetailTestOverseas').value = problem.test_Overseas || '';

            // 根据权限控制编辑按钮显示
            const editBtn = document.getElementById('editProblemBtn');
            if (editBtn) {
                if (isSuperAdmin) {
                    editBtn.style.display = 'inline-flex';
                } else {
                    editBtn.style.display = 'none';
                }
            }

            // 确保退出编辑模式
            exitEditMode();

            document.getElementById('problemDetailModal').style.display = 'block';
        }

        // 显示问题图片
        function displayProblemImages(imageData) {
            const container = document.getElementById('detailProblemImage');
            container.innerHTML = '';

            if (!imageData || imageData.trim() === '') {
                container.innerHTML = '<div class="no-image">暂无问题图片</div>';
                return;
            }

            try {
                // 处理图片路径数据
                let imageUrls = [];

                // 如果是JSON字符串，尝试解析
                if (imageData.startsWith('[') || imageData.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(imageData);
                        if (Array.isArray(parsed)) {
                            imageUrls = parsed;
                        } else if (parsed.urls && Array.isArray(parsed.urls)) {
                            imageUrls = parsed.urls;
                        }
                    } catch (e) {
                        console.warn('解析图片JSON数据失败:', e);
                    }
                }

                // 如果解析失败或不是JSON，尝试按逗号分割
                if (imageUrls.length === 0) {
                    imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
                }

                if (imageUrls.length === 0) {
                    container.innerHTML = '<div class="no-image">暂无问题图片</div>';
                    return;
                }

                // 创建图片画廊
                const gallery = document.createElement('div');
                gallery.className = 'image-gallery';

                imageUrls.forEach((imagePath, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';

                    const img = document.createElement('img');

                    // 处理图片路径：如果是相对路径，直接使用；如果是绝对路径，也直接使用
                    let imageUrl = imagePath;

                    // 确保路径以/开头（服务器相对路径）
                    if (!imagePath.startsWith('/') && !imagePath.startsWith('http')) {
                        imageUrl = '/' + imagePath;
                    }

                    img.src = imageUrl;
                    img.alt = `问题图片 ${index + 1}`;
                    img.title = `点击查看大图 - ${imagePath}`;

                    // 添加点击事件，可以放大查看
                    img.addEventListener('click', function() {
                        showImageModal(imageUrl, index + 1, imageUrls.map(path => {
                            if (!path.startsWith('/') && !path.startsWith('http')) {
                                return '/' + path;
                            }
                            return path;
                        }));
                    });

                    // 添加错误处理
                    img.addEventListener('error', function() {
                        this.style.display = 'none';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'no-image';
                        errorDiv.textContent = `图片加载失败: ${imagePath}`;
                        imageItem.appendChild(errorDiv);
                    });

                    imageItem.appendChild(img);
                    gallery.appendChild(imageItem);
                });

                container.appendChild(gallery);
            } catch (error) {
                console.error('处理问题图片时发生错误:', error);
                container.innerHTML = '<div class="no-image">图片数据格式错误</div>';
            }
        }

        // 显示图片放大模态框
        function showImageModal(imageUrl, currentIndex, allUrls) {
            // 创建图片查看模态框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 20px;">
                    <div class="modal-header">
                        <h2>问题图片查看 (${currentIndex}/${allUrls.length})</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="text-align: center; overflow: auto; position: relative;">
                        <div id="imageContainer" style="position: relative; display: inline-block;">
                            <img id="modalImage" src="${imageUrl}" style="max-width: 100%; max-height: 70vh; border-radius: 4px; transition: transform 0.3s ease; cursor: zoom-in;">
                        </div>
                        <div style="margin-top: 10px;">
                            ${allUrls.length > 1 ? `
                                <button onclick="switchImage(${currentIndex - 2}, ${allUrls.length})" ${currentIndex <= 1 ? 'disabled' : ''}>上一张</button>
                                <button onclick="switchImage(${currentIndex}, ${allUrls.length})" ${currentIndex >= allUrls.length ? 'disabled' : ''}>下一张</button>
                            ` : ''}
                            <button onclick="resetImageZoom()">重置缩放</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.style.display = 'block';

            // 初始化图片缩放功能
            initImageZoom(modal);

            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 初始化图片缩放功能
        function initImageZoom(modal) {
            const img = modal.querySelector('#modalImage');
            const container = modal.querySelector('#imageContainer');
            let scale = 1;
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;

            // 鼠标滚轮缩放
            img.addEventListener('wheel', function(e) {
                e.preventDefault();

                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.max(0.1, Math.min(5, scale + delta));

                if (newScale !== scale) {
                    scale = newScale;
                    updateImageTransform();
                }
            });

            // 鼠标点击切换缩放
            img.addEventListener('click', function(e) {
                e.stopPropagation();

                if (scale === 1) {
                    scale = 2;
                    img.style.cursor = 'zoom-out';
                } else {
                    scale = 1;
                    translateX = 0;
                    translateY = 0;
                    img.style.cursor = 'zoom-in';
                }

                updateImageTransform();
            });

            // 鼠标拖拽
            img.addEventListener('mousedown', function(e) {
                if (scale > 1) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    img.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    updateImageTransform();
                }
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    img.style.cursor = scale > 1 ? 'grab' : 'zoom-in';
                }
            });

            // 更新图片变换
            function updateImageTransform() {
                img.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
            }

            // 重置缩放
            window.resetImageZoom = function() {
                scale = 1;
                translateX = 0;
                translateY = 0;
                img.style.cursor = 'zoom-in';
                updateImageTransform();
            };

            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (modal.style.display === 'block') {
                    if (e.key === 'Escape') {
                        modal.remove();
                    } else if (e.key === '0') {
                        resetImageZoom();
                    } else if (e.key === '+' || e.key === '=') {
                        scale = Math.min(5, scale + 0.2);
                        updateImageTransform();
                    } else if (e.key === '-') {
                        scale = Math.max(0.1, scale - 0.2);
                        updateImageTransform();
                    }
                }
            });
        }

        // 切换图片
        function switchImage(newIndex, totalCount) {
            if (newIndex < 0 || newIndex >= totalCount) return;

            const modal = document.querySelector('.modal[style*="z-index: 10001"]');
            if (modal) {
                const img = modal.querySelector('#modalImage');
                const allUrls = Array.from(document.querySelectorAll('.image-item img')).map(img => img.src);
                img.src = allUrls[newIndex];

                // 重置缩放状态
                img.style.transform = 'scale(1) translate(0px, 0px)';
                img.style.cursor = 'zoom-in';

                // 更新标题
                const title = modal.querySelector('h2');
                title.textContent = `问题图片查看 (${newIndex + 1}/${totalCount})`;

                // 更新按钮状态
                const prevBtn = modal.querySelector('button[onclick*="上一张"]');
                const nextBtn = modal.querySelector('button[onclick*="下一张"]');
                if (prevBtn) prevBtn.disabled = newIndex <= 0;
                if (nextBtn) nextBtn.disabled = newIndex >= totalCount - 1;

                // 重新初始化缩放功能
                initImageZoom(modal);
            }
        }

        // 显示编辑问题点模态框
        function showEditProblemModal(problemId) {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            const problem = filteredData.find(p => p.id === problemId);
            if (!problem) return;

            // 填充编辑表单
            document.getElementById('editProblemId').value = problem.id;
            document.getElementById('editFullModel').value = problem.full_model || '';
            document.getElementById('editSampleStage').value = problem.sample_stage || '';
            document.getElementById('editVersion').value = problem.version || '';
            document.getElementById('editProblemCategory').value = problem.problemCategory || '';
            document.getElementById('editDefectLevel').value = problem.defect_level || '';
            document.getElementById('editCurrentStatus').value = normalizeStatus(problem.current_status);
            document.getElementById('editProblem').value = problem.problem || '';

            // 初始化问题图片字段
            const imageField = document.getElementById('editProblemImage');
            imageField.value = problem.problem_image_or_video || '';
            updateImagePreview();

            document.getElementById('editReproductionMethod').value = problem.reproduction_method || '';
            document.getElementById('editRecoveryMethod').value = problem.recovery_method || '';
            document.getElementById('editReproductionProbability').value = problem.reproduction_probability || '';
            document.getElementById('editTester').value = problem.tester || '';
            document.getElementById('editResponsibleDepartment').value = problem.responsibleDepartment || '';
            document.getElementById('editResponsiblePerson').value = problem.responsible_person || '';
            document.getElementById('editImprovementPlan').value = problem.improvement_plan || '';
            document.getElementById('editGreenUnionDqe').value = problem.green_union_dqe || '';
            document.getElementById('editGreenUnionRd').value = problem.green_union_rd || '';
            document.getElementById('editTestOverseas').value = problem.test_Overseas || '';
            document.getElementById('editRemark').value = problem.remark || '';

            document.getElementById('editProblemModal').style.display = 'block';
        }

        // 更新图片预览
        function updateImagePreview() {
            const imageField = document.getElementById('editProblemImage');
            const previewContainer = document.getElementById('editImagePreview');

            if (!imageField || !previewContainer) return;

            const imageData = imageField.value.trim();
            previewContainer.innerHTML = '';

            if (!imageData) {
                previewContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">暂无图片预览</div>';
                return;
            }

            try {
                // 解析图片路径
                let imageUrls = [];

                // 如果是JSON字符串，尝试解析
                if (imageData.startsWith('[') || imageData.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(imageData);
                        if (Array.isArray(parsed)) {
                            imageUrls = parsed;
                        } else if (parsed.urls && Array.isArray(parsed.urls)) {
                            imageUrls = parsed.urls;
                        }
                    } catch (e) {
                        console.warn('解析图片JSON数据失败:', e);
                    }
                }

                // 如果解析失败或不是JSON，尝试按逗号分割
                if (imageUrls.length === 0) {
                    imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
                }

                if (imageUrls.length === 0) {
                    previewContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">暂无有效图片路径</div>';
                    return;
                }

                // 创建预览画廊
                const gallery = document.createElement('div');
                gallery.className = 'preview-gallery';

                imageUrls.forEach((imagePath, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';

                    const img = document.createElement('img');
                    let imageUrl = imagePath;

                    // 确保路径以/开头（服务器相对路径）
                    if (!imagePath.startsWith('/') && !imagePath.startsWith('http')) {
                        imageUrl = '/' + imagePath;
                    }

                    img.src = imageUrl;
                    img.alt = `预览图片 ${index + 1}`;
                    img.title = imagePath;

                    // 添加点击事件，可以放大查看
                    img.addEventListener('click', function() {
                        showImageModal(imageUrl, index + 1, imageUrls.map(path => {
                            if (!path.startsWith('/') && !path.startsWith('http')) {
                                return '/' + path;
                            }
                            return path;
                        }));
                    });

                    // 添加错误处理
                    img.addEventListener('error', function() {
                        this.style.display = 'none';
                        const errorDiv = document.createElement('div');
                        errorDiv.style.color = '#dc3545';
                        errorDiv.style.fontSize = '10px';
                        errorDiv.style.padding = '5px';
                        errorDiv.textContent = '加载失败';
                        previewItem.appendChild(errorDiv);
                    });

                    // 添加删除按钮
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '×';
                    removeBtn.title = '删除此图片';
                    removeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        removeImageFromEdit(index);
                    });

                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    gallery.appendChild(previewItem);
                });

                previewContainer.appendChild(gallery);
            } catch (error) {
                console.error('处理图片预览时发生错误:', error);
                previewContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">图片数据格式错误</div>';
            }
        }

        // 从编辑中删除图片
        function removeImageFromEdit(index) {
            const imageField = document.getElementById('editProblemImage');
            const imageData = imageField.value.trim();

            if (!imageData) return;

            try {
                let imageUrls = [];

                // 解析图片路径
                if (imageData.startsWith('[') || imageData.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(imageData);
                        if (Array.isArray(parsed)) {
                            imageUrls = parsed;
                        } else if (parsed.urls && Array.isArray(parsed.urls)) {
                            imageUrls = parsed.urls;
                        }
                    } catch (e) {
                        console.warn('解析图片JSON数据失败:', e);
                    }
                }

                if (imageUrls.length === 0) {
                    imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
                }

                // 删除指定索引的图片
                if (index >= 0 && index < imageUrls.length) {
                    imageUrls.splice(index, 1);

                    // 更新字段值
                    imageField.value = imageUrls.join(',');

                    // 更新预览
                    updateImagePreview();
                }
            } catch (error) {
                console.error('删除图片时发生错误:', error);
            }
        }

        // 保存问题点
        function saveProblem() {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            // 检查问题点字段是否为空
            const problemValue = document.getElementById('editProblem').value;
            if (!problemValue || problemValue.trim() === '') {
                alert('问题点字段不能为空，请填写问题描述！');
                document.getElementById('editProblem').focus();
                return;
            }

            const formData = new FormData(document.getElementById('editProblemForm'));
            const problemData = Object.fromEntries(formData.entries());
            problemData.id = document.getElementById('editProblemId').value;
            problemData.modifier = currentUser;

            showLoading();

            fetch('/problemLibrary/updateProblem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(problemData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                    closeModal();
                    loadProblemData();
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 渲染表格
        function renderTable() {
            const tbody = document.getElementById('problemTableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach(problem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${problem.id}</td>
                    <td>${problem.full_model || ''}</td>
                    <td>${problem.big_species || ''}</td>
                    <td>${problem.small_species || ''}</td>
                    <td>${problem.sample_stage || ''}</td>
                    <td>${problem.version || ''}</td>
                    <td>${problem.test_platform || ''}</td>
                    <td>${problem.test_device || ''}</td>
                    <td>${problem.other_device || ''}</td>
                    <td class="problem-desc">${(problem.problem || '').substring(0, 50)}${(problem.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${problem.problemCategory || ''}</td>
                    <td>${problem.defect_level || ''}</td>
                    <td>${normalizeStatus(problem.current_status)}</td>
                    <td>${problem.tester || ''}</td>
                    <td>${problem.dqe || ''}</td>
                    <td>${problem.responsibleDepartment || ''}</td>
                    <td>${problem.green_union_dqe || ''}</td>
                    <td>${problem.green_union_rd || ''}</td>
                    <td>${problem.created_at ? problem.created_at.substring(0, 10) : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showProblemDetail(${problem.id})">查看</button>
                        <button class="btn btn-sm btn-secondary" onclick="showHistoryVersions('${problem.sample_id}')">历史版本</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // 更新分页信息
        function updatePagination() {
            totalRecords = filteredData.length;
            const totalPages = Math.ceil(totalRecords / pageSize);
            const startRecord = totalRecords > 0 ? (currentPage - 1) * pageSize + 1 : 0;
            const endRecord = Math.min(currentPage * pageSize, totalRecords);

            // 确保当前页不超过总页数
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }

            document.getElementById('startRecord').textContent = startRecord;
            document.getElementById('endRecord').textContent = endRecord;
            document.getElementById('totalRecords').textContent = totalRecords;

            // 更新按钮状态
            document.getElementById('firstPageBtn').disabled = currentPage === 1 || totalPages === 0;
            document.getElementById('prevPageBtn').disabled = currentPage === 1 || totalPages === 0;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages || totalPages === 0;

            // 生成页码按钮
            generatePageNumbers(totalPages);

            // 更新跳转输入框的最大值
            document.getElementById('pageJumpInput').max = totalPages;

            // 调试信息
            // console.log(`分页信息: 总记录数=${totalRecords}, 总页数=${totalPages}, 当前页=${currentPage}, 每页=${pageSize}`);
        }

        // 切换页面
        function changePage(direction) {
            const totalPages = Math.ceil(totalRecords / pageSize);
            const newPage = currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // 跳转到指定页面
        function goToPage(page) {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
            }
        }

        // 跳转到最后一页
        function goToLastPage() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (totalPages > 0) {
                currentPage = totalPages;
                renderTable();
            }
        }

        // 页码跳转
        function jumpToPage() {
            const input = document.getElementById('pageJumpInput');
            const page = parseInt(input.value);
            const totalPages = Math.ceil(totalRecords / pageSize);

            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
                input.value = '';
            } else {
                alert(`请输入1到${totalPages}之间的页码`);
                input.value = '';
            }
        }

        // 生成页码按钮
        function generatePageNumbers(totalPages) {
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';

            // 即使只有一页也显示页码
            if (totalPages <= 0) return;

            if (totalPages === 1) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = '1';
                pageBtn.className = 'btn btn-sm page-number active';
                pageBtn.onclick = () => goToPage(1);
                pageNumbersContainer.appendChild(pageBtn);
                return;
            }

            const maxVisiblePages = 5; // 最多显示5个页码按钮
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // 调整起始页码
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // 添加省略号
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.className = 'btn btn-sm page-number';
                firstBtn.onclick = () => goToPage(1);
                pageNumbersContainer.appendChild(firstBtn);

                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }

            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = `btn btn-sm page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.onclick = () => goToPage(i);
                pageNumbersContainer.appendChild(pageBtn);
            }

            // 添加省略号
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    pageNumbersContainer.appendChild(ellipsis);
                }

                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.className = 'btn btn-sm page-number';
                lastBtn.onclick = () => goToPage(totalPages);
                pageNumbersContainer.appendChild(lastBtn);
            }
        }

        // 更新统计信息
        function updateStatistics() {
            const open = filteredData.filter(p => (p.current_status || '').toLowerCase() === 'open').length;
            const closed = filteredData.filter(p => {
                const status = (p.current_status || '').toLowerCase();
                return status === 'closed' || status === 'close';
            }).length;
            const followup = filteredData.filter(p => (p.current_status || '').toLowerCase() === 'follow up').length;

            document.getElementById('openCount').textContent = open;
            document.getElementById('closedCount').textContent = closed;
            document.getElementById('followupCount').textContent = followup;
            document.getElementById('filteredCount').textContent = filteredData.length;
            
            // 更新问题类别选项
            updateProblemCategoryOptionsFromCurrentData();
        }

        // 从当前搜索数据中提取问题类别选项并更新下拉框
        function updateProblemCategoryOptionsFromCurrentData() {
            if (!filteredData || filteredData.length === 0) {
                return;
            }

            // 保存当前选中的值
            const currentLevel1 = document.getElementById('problemCategoryLevel1Filter').value;
            const currentLevel2 = document.getElementById('problemCategoryLevel2Filter').value;
            const currentLevel3 = document.getElementById('problemCategoryLevel3Filter').value;

            // 提取所有问题类别
            const problemCategories = filteredData
                .map(item => item.problemCategory)
                .filter(category => category && category.trim() !== '')
                .map(category => category.trim());

            // 去重并排序
            const uniqueCategories = [...new Set(problemCategories)].sort();

            // 解析三级结构的问题类别
            const level1Categories = new Set();
            const level2Categories = new Set();
            const level3Categories = new Set();

            uniqueCategories.forEach(category => {
                // 假设问题类别使用 "-" 分隔三级结构
                const parts = category.split('-').map(part => part.trim()).filter(part => part !== '');
                
                if (parts.length >= 1) {
                    level1Categories.add(parts[0]);
                }
                if (parts.length >= 2) {
                    level2Categories.add(parts[1]);
                }
                if (parts.length >= 3) {
                    level3Categories.add(parts[2]);
                }
            });

            // 更新一级下拉框
            updateProblemCategoryLevelSelect('problemCategoryLevel1Filter', Array.from(level1Categories));
            
            // 如果一级分类有变化，清空二级和三级下拉框
            if (currentLevel1 && !level1Categories.has(currentLevel1)) {
                const level2Select = document.getElementById('problemCategoryLevel2Filter');
                const level3Select = document.getElementById('problemCategoryLevel3Filter');
                if (level2Select) {
                    level2Select.innerHTML = '<option value="">全部</option>';
                }
                if (level3Select) {
                    level3Select.innerHTML = '<option value="">全部</option>';
                }
            } else if (currentLevel1) {
                // 如果一级分类没有变化，更新二级下拉框选项但保持当前选中值
                updateLevel2OptionsFromCurrentData(currentLevel1, currentLevel2, currentLevel3);
            }

            console.log('问题类别选项已根据当前搜索数据更新');
            console.log('一级类别:', Array.from(level1Categories));
            console.log('二级类别:', Array.from(level2Categories));
            console.log('三级类别:', Array.from(level3Categories));
        }

        // 更新指定级别的问题类别下拉框
        function updateProblemCategoryLevelSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;

            // 保存当前选中的值
            const currentValue = select.value;
            
            // 清空选项（保留"全部"选项）
            select.innerHTML = '<option value="">全部</option>';
            
            // 添加新选项
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });

            // 如果之前选中的值仍然存在，则恢复选中状态
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // 从当前数据中提取二级分类
        function extractLevel2FromCurrentData(selectedLevel1) {
            if (!filteredData || filteredData.length === 0) {
                return [];
            }

            const level2Categories = new Set();
            
            filteredData.forEach(item => {
                const category = item.problemCategory;
                if (category && category.trim() !== '') {
                    const parts = category.split('-').map(part => part.trim()).filter(part => part !== '');
                    if (parts.length >= 2 && parts[0] === selectedLevel1) {
                        level2Categories.add(parts[1]);
                    }
                }
            });

            return Array.from(level2Categories).sort().map(category => ({
                value: category,
                text: category
            }));
        }

        // 从当前数据中提取三级分类
        function extractLevel3FromCurrentData(selectedLevel1, selectedLevel2) {
            if (!filteredData || filteredData.length === 0) {
                return [];
            }

            const level3Categories = new Set();
            
            filteredData.forEach(item => {
                const category = item.problemCategory;
                if (category && category.trim() !== '') {
                    const parts = category.split('-').map(part => part.trim()).filter(part => part !== '');
                    if (parts.length >= 3 && parts[0] === selectedLevel1 && parts[1] === selectedLevel2) {
                        level3Categories.add(parts[2]);
                    }
                }
            });

            return Array.from(level3Categories).sort().map(category => ({
                value: category,
                text: category
            }));
        }

        // 从当前数据更新二级和三级下拉框选项，保持当前选中值
        function updateLevel2OptionsFromCurrentData(currentLevel1, currentLevel2, currentLevel3) {
            // 更新二级下拉框
            const level2Options = extractLevel2FromCurrentData(currentLevel1);
            const level2Select = document.getElementById('problemCategoryLevel2Filter');
            
            if (level2Select) {
                // 保存当前选中的值
                const currentValue = level2Select.value;
                
                // 清空选项（保留"全部"选项）
                level2Select.innerHTML = '<option value="">全部</option>';
                
                // 添加新选项
                level2Options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    level2Select.appendChild(optionElement);
                });

                // 如果之前选中的值仍然存在，则恢复选中状态
                if (currentValue && level2Options.some(opt => opt.value === currentValue)) {
                    level2Select.value = currentValue;
                } else if (currentLevel2 && level2Options.some(opt => opt.value === currentLevel2)) {
                    // 如果当前保存的值仍然存在，使用它
                    level2Select.value = currentLevel2;
                }
            }

            // 更新三级下拉框
            const level3Options = extractLevel3FromCurrentData(currentLevel1, level2Select ? level2Select.value : '');
            const level3Select = document.getElementById('problemCategoryLevel3Filter');
            
            if (level3Select) {
                // 保存当前选中的值
                const currentValue = level3Select.value;
                
                // 清空选项（保留"全部"选项）
                level3Select.innerHTML = '<option value="">全部</option>';
                
                // 添加新选项
                level3Options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    level3Select.appendChild(optionElement);
                });

                // 如果之前选中的值仍然存在，则恢复选中状态
                if (currentValue && level3Options.some(opt => opt.value === currentValue)) {
                    level3Select.value = currentValue;
                } else if (currentLevel3 && level3Options.some(opt => opt.value === currentLevel3)) {
                    // 如果当前保存的值仍然存在，使用它
                    level3Select.value = currentLevel3;
                }
            }
        }

        // 刷新所有选项
        function refreshAllOptions() {
            showLoading();
            
            // 由于服务器返回的是所有选项的完整数据，只需要调用一次
            fetchSpeciesOptionsFromServer('all')
                .then(() => {
                    hideLoading();
                    showToast('所有选项已刷新完成！', 'success');
                })
                .catch(error => {
                    hideLoading();
                    console.error('刷新选项时出错:', error);
                    showToast('刷新选项时出现错误，请重试！', 'error');
                });
        }

        // 应用筛选条件
        function applyFilters() {
            // 执行搜索以应用当前筛选条件
            searchProblems();
        }

        // 根据状态筛选
        function filterByStatus(status) {
            // 保持其他筛选条件不变，只修改当前状态筛选
            document.getElementById('currentStatusFilter').value = status;

            // 执行搜索
            searchProblems();
        }

        // 刷新单个选项（大类或小类）
        function refreshSingleSpeciesOptions(speciesType) {
            // 直接从服务器获取最新数据，不使用缓存
            return fetchSpeciesOptionsFromServer(speciesType);
        }

        // 强制刷新（忽略缓存）
        function forceRefreshSpeciesOptions(speciesType) {
            // 清除缓存
            clearSpeciesCache();
            // 从服务器获取
            fetchSpeciesOptionsFromServer(speciesType);
        }


        // 从服务器获取选项
        function fetchSpeciesOptionsFromServer(speciesType) {
            return fetch('/problemLibrary/getSpeciesOptions', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('服务器返回的原始数据:', data.data);

                    
                    // 更新缓存（同时更新所有选项，因为服务器返回的是完整数据）
                    setCachedSpeciesOptions('bigSpecies', data.data.bigSpecies);
                    setCachedSpeciesOptions('smallSpecies', data.data.smallSpecies);
                    setCachedSpeciesOptions('sampleStage', data.data.sampleStage);
                    setCachedSpeciesOptions('fullModel', data.data.fullModel);
                    setCachedSpeciesOptions('version', data.data.version);
                    setCachedSpeciesOptions('problemCategory', data.data.problemCategory);
                    setCachedSpeciesOptions('tester', data.data.tester);
                    setCachedSpeciesOptions('responsibleDepartment', data.data.responsibleDepartment);
                    setCachedSpeciesOptions('testPlatform', data.data.testPlatform);
                    setCachedSpeciesOptions('testDevice', data.data.testDevice);
                    setCachedSpeciesOptions('dqe', data.data.dqe);

                    // 更新对应的下拉框
                    if (speciesType === 'all') {
                        // 更新所有下拉框
                        updateSelectOptions('bigSpeciesFilter', data.data.bigSpecies);
                        updateSelectOptions('smallSpeciesFilter', data.data.smallSpecies);
                        updateSelectOptions('sampleStageFilter', data.data.sampleStage);
                        updateSelectOptions('fullModelFilter', data.data.fullModel);
                        updateSelectOptions('versionFilter', data.data.version);
                        updateSelectOptions('testerFilter', data.data.tester);
                        updateSelectOptions('responsibleDepartmentFilter', data.data.responsibleDepartment);
                        updateSelectOptions('testPlatformFilter', data.data.testPlatform);
                        updateSelectOptions('testDeviceFilter', data.data.testDevice);
                        updateSelectOptions('dqeFilter', data.data.dqe);
                        // 重新初始化三级问题类别筛选器
                        initProblemCategoryFilter();
                    } else if (speciesType === 'bigSpecies') {
                        updateSelectOptions('bigSpeciesFilter', data.data.bigSpecies);
                        showToast('大类选项已刷新并缓存', 'success');
                    } else if (speciesType === 'smallSpecies') {
                        updateSelectOptions('smallSpeciesFilter', data.data.smallSpecies);
                        showToast('小类选项已刷新并缓存', 'success');
                    } else if (speciesType === 'sampleStage') {
                        updateSelectOptions('sampleStageFilter', data.data.sampleStage);
                        showToast('样品阶段选项已刷新并缓存', 'success');
                    } else if (speciesType === 'fullModel') {
                        updateSelectOptions('fullModelFilter', data.data.fullModel);
                        showToast('完整编码选项已刷新并缓存', 'success');
                    } else if (speciesType === 'version') {
                        updateSelectOptions('versionFilter', data.data.version);
                        showToast('版本选项已刷新并缓存', 'success');
                    } else if (speciesType === 'problemCategory') {
                        // 重新初始化三级问题类别筛选器
                        initProblemCategoryFilter();
                        showToast('问题类别选项已从数据库刷新并缓存', 'success');
                    } else if (speciesType === 'tester') {
                        updateSelectOptions('testerFilter', data.data.tester);
                        showToast('测试人员选项已刷新并缓存', 'success');
                    } else if (speciesType === 'responsibleDepartment') {
                        updateSelectOptions('responsibleDepartmentFilter', data.data.responsibleDepartment);
                        showToast('责任部门选项已刷新并缓存', 'success');
                    } else if (speciesType === 'testPlatform') {
                        updateSelectOptions('testPlatformFilter', data.data.testPlatform);
                        showToast('测试平台选项已刷新并缓存', 'success');
                    } else if (speciesType === 'testDevice') {
                        updateSelectOptions('testDeviceFilter', data.data.testDevice);
                        showToast('显示设备选项已刷新并缓存', 'success');
                    } else if (speciesType === 'dqe') {
                        updateSelectOptions('dqeFilter', data.data.dqe);
                        showToast('DQE负责人选项已刷新并缓存', 'success');
                    }
                    return data;
                } else {
                    showToast('刷新失败: ' + data.message, 'error');
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('刷新时发生错误', 'error');
                throw error;
            });
        }

        // 更新下拉框选项
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;

            // 保存当前选中的值
            const currentValue = select.value;

            // 清空现有选项（保留"全部"选项）
            select.innerHTML = '<option value="">全部</option>';

            // 添加新选项
            if (options && options.length > 0) {
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    // 如果选项为空字符串，显示为"空值"
                    optionElement.textContent = option === '' ? '空值' : option;
                    select.appendChild(optionElement);
                });
            }

            // 尝试恢复之前选中的值
            if (currentValue && Array.from(select.options).some(option => option.value === currentValue)) {
                select.value = currentValue;
            }
        }


        // 从配置文件刷新问题类别选项（三级结构）
        function refreshProblemCategoryFromConfig() {
            // console.log('开始从配置文件刷新问题类别...');
            // console.log('检查配置文件函数可用性:');
            // console.log('- getAllProblemCategories:', typeof getAllProblemCategories);
            // console.log('- getLevel1Categories:', typeof getLevel1Categories);
            // console.log('- getLevel2Categories:', typeof getLevel2Categories);
            // console.log('- getLevel3Categories:', typeof getLevel3Categories);
            
            // 清空问题类别缓存，强制从配置文件加载
            speciesCache.problemCategory = [];
            // console.log('已清空问题类别缓存');
            
            // 检查配置文件函数是否可用
            if (typeof getAllProblemCategories !== 'function') {
                showToast('配置文件函数不可用，请检查problemCategories.js是否正确加载', 'error');
                return;
            }
            
            // 收集所有选项值用于缓存
            const allOptions = getAllProblemCategories();
            // console.log('从配置文件获取到', allOptions.length, '个问题类别选项');
            // console.log('配置文件选项示例:', allOptions.slice(0, 5));
            
            // 将配置文件选项保存到缓存
            setCachedSpeciesOptions('problemCategory', allOptions);
            // console.log('配置文件选项已保存到缓存');
            
            // 重新初始化三级问题类别筛选器
            initProblemCategoryFilter();
            
            
            showToast('问题类别选项已从配置文件刷新并缓存，共' + allOptions.length + '个选项', 'success');
        }

        // 进入编辑模式
        function enterEditMode() {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            // 所有可编辑字段（除了提交时间）
            const editableFields = [
                'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
                'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
                'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
                'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
                'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
                'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
                'detailGreenUnionDqe', 'detailGreenUnionRd',
                'detailComparisonWithPrevious', 'detailPostImprovementRisk',
                'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
            ];

            editableFields.forEach(fieldId => {
                const displayElement = document.getElementById(fieldId);
                const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

                if (displayElement && inputElement) {
                    displayElement.style.display = 'none';
                    inputElement.style.display = 'block';
                }
            });

            // 切换按钮显示
            document.getElementById('editProblemBtn').style.display = 'none';
            document.getElementById('saveDetailBtn').style.display = 'inline-flex';
            document.getElementById('cancelEditBtn').style.display = 'inline-flex';
        }

        // 退出编辑模式
        function exitEditMode() {
            // 所有可编辑字段（除了提交时间）
            const editableFields = [
                'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
                'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
                'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
                'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
                'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
                'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
                'detailGreenUnionDqe', 'detailGreenUnionRd',
                'detailComparisonWithPrevious', 'detailPostImprovementRisk',
                'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
            ];

            editableFields.forEach(fieldId => {
                const displayElement = document.getElementById(fieldId);
                const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

                if (displayElement && inputElement) {
                    displayElement.style.display = 'block';
                    inputElement.style.display = 'none';
                }
            });

            // 切换按钮显示
            document.getElementById('editProblemBtn').style.display = 'inline-flex';
            document.getElementById('saveDetailBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // 保存详情修改
        function saveDetailChanges() {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            // 检查问题点字段是否为空
            const problemValue = document.getElementById('editDetailProblem').value;
            if (!problemValue || problemValue.trim() === '') {
                alert('问题点字段不能为空，请填写问题描述！');
                document.getElementById('editDetailProblem').focus();
                return;
            }

            // 收集修改的数据 - 只传递必要的字段
            const problemData = {
                id: document.getElementById('editProblemId').value,
                modifier: currentUser
            };

            // 只添加有值的字段
            const fields = [
                { key: 'full_model', element: 'editDetailFullModel' },
                { key: 'big_species', element: 'editDetailBigSpecies' },
                { key: 'small_species', element: 'editDetailSmallSpecies' },
                { key: 'sample_stage', element: 'editDetailSampleStage' },
                { key: 'version', element: 'editDetailVersion' },
                { key: 'chip_solution', element: 'editDetailChipSolution' },
                { key: 'test_platform', element: 'editDetailTestPlatform' },
                { key: 'test_device', element: 'editDetailTestDevice' },
                { key: 'other_device', element: 'editDetailOtherDevice' },
                { key: 'problem', element: 'editDetailProblem' },
                { key: 'problemCategory', element: 'editDetailProblemCategory' },
                { key: 'defect_level', element: 'editDetailDefectLevel' },
                { key: 'current_status', element: 'editDetailCurrentStatus' },
                { key: 'reproduction_method', element: 'editDetailReproductionMethod' },
                { key: 'recovery_method', element: 'editDetailRecoveryMethod' },
                { key: 'reproduction_probability', element: 'editDetailReproductionProbability' },
                { key: 'tester', element: 'editDetailTester' },
                { key: 'responsibleDepartment', element: 'editDetailResponsibleDepartment' },
                { key: 'responsible_person', element: 'editDetailResponsiblePerson' },
                { key: 'dqe_confirm', element: 'editDetailDqeConfirm' },
                { key: 'rd_confirm', element: 'editDetailRdConfirm' },
                { key: 'improvement_plan', element: 'editDetailImprovementPlan' },
                { key: 'green_union_dqe', element: 'editDetailGreenUnionDqe' },
                { key: 'green_union_rd', element: 'editDetailGreenUnionRd' },
                { key: 'comparison_with_previous', element: 'editDetailComparisonWithPrevious' },
                { key: 'post_improvement_risk', element: 'editDetailPostImprovementRisk' },
                { key: 'next_version_regression_test', element: 'editDetailNextVersionRegressionTest' },
                { key: 'remark', element: 'editDetailRemark' },
                { key: 'test_Overseas', element: 'editDetailTestOverseas' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.element);
                if (element && element.value !== '') {
                    problemData[field.key] = element.value;
                }
            });

            showLoading();

            fetch('/problemLibrary/updateProblem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(problemData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                    exitEditMode();
                    loadProblemData(); // 重新加载表格数据

                    // 重新获取并显示更新后的问题点详情
                    const problemId = document.getElementById('editProblemId').value;
                    fetch(`/problemLibrary/getProblemById?id=${problemId}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success && result.data) {
                                displayProblemDetail(result.data);
                            }
                        })
                        .catch(error => {
                            console.error('获取更新后数据失败:', error);
                        });
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // 显示自定义提示框
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('customToast');
            const messageEl = document.getElementById('toastMessage');
            const iconEl = toast.querySelector('.toast-icon i');

            // 设置消息内容
            messageEl.textContent = message;

            // 设置图标和样式
            toast.className = 'custom-toast ' + type;
            switch(type) {
                case 'success':
                    iconEl.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    iconEl.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    iconEl.className = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                    iconEl.className = 'fas fa-info-circle';
                    break;
            }

            // 显示提示框
            toast.classList.add('show');

            // 自动隐藏
            if (duration > 0) {
                setTimeout(() => {
                    hideToast();
                }, duration);
            }
        }

        // 隐藏自定义提示框
        function hideToast() {
            const toast = document.getElementById('customToast');
            toast.classList.remove('show');
        }

        // 关闭模态框
        function closeModal() {
            // 获取所有可见的模态框，按z-index排序
            const visibleModals = Array.from(document.querySelectorAll('.modal'))
                .filter(modal => modal.style.display === 'block')
                .sort((a, b) => {
                    const aZIndex = parseInt(window.getComputedStyle(a).zIndex) || 0;
                    const bZIndex = parseInt(window.getComputedStyle(b).zIndex) || 0;
                    return bZIndex - aZIndex; // 降序排列，z-index高的在前
                });

            if (visibleModals.length > 0) {
                // 只关闭最顶层的模态框
                visibleModals[0].style.display = 'none';
            }
        }

        // 关闭指定模态框
        function closeSpecificModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // 返回主页
        function goHome() {
            window.location.href = '/DQEIndex';
        }

        // 显示历史版本
        function showHistoryVersions(sampleId) {
            showLoading();

            fetch(`/problemLibrary/getHistoryVersions?sampleId=${sampleId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderHistoryVersions(data.data);
                    document.getElementById('historyVersionsModal').style.display = 'block';
                } else {
                    alert('获取历史版本失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取历史版本时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 渲染历史版本表格
        function renderHistoryVersions(historyVersions) {
            const tbody = document.getElementById('historyVersionsTableBody');
            tbody.innerHTML = '';

            if (!historyVersions || historyVersions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center;">暂无历史版本</td>
                `;
                tbody.appendChild(row);
                return;
            }

            historyVersions.forEach(version => {
                const row = document.createElement('tr');
                const isLatest = version.history_id === Math.max(...historyVersions.map(v => v.history_id));
                const latestBadge = isLatest ? '<span class="badge badge-primary">最新</span>' : '';

                row.innerHTML = `
                    <td>${version.history_id} ${latestBadge}</td>
                    <td class="problem-desc">${(version.problem || '').substring(0, 50)}${(version.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${normalizeStatus(version.current_status)}</td>
                    <td>${version.modifier || version.tester || ''}</td>
                    <td>${version.modify_at ? new Date(version.modify_at).toLocaleString('zh-CN') : (version.created_at ? new Date(version.created_at).toLocaleString('zh-CN') : '')}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showProblemDetail(${version.id})">查看详情</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== 购物车/收藏夹功能 ====================

        // 加入收藏夹
        function addToCart() {
            if (filteredData.length === 0) {
                alert('没有数据可以加入收藏夹，请先进行搜索！');
                return;
            }

            // 获取当前筛选条件
            const filters = getCurrentFilters();
            const filterDescription = generateFilterDescription(filters);

            // 创建收藏夹项目
            const cartItem = {
                id: Date.now(), // 使用时间戳作为唯一ID
                filters: filters,
                data: [...filteredData], // 复制当前筛选结果
                dataCount: filteredData.length,
                filterDescription: filterDescription,
                saveTime: new Date().toLocaleString('zh-CN'),
                user: currentUser
            };

            // 添加到收藏夹
            cartItems.push(cartItem);

            // 保存到本地存储
            saveCartToStorage();

            // 更新收藏夹计数
            updateCartCount();

            alert(`已成功将 ${filteredData.length} 条数据加入收藏夹！`);
        }

        // 获取当前筛选条件
        function getCurrentFilters() {
            return {
                fullModel: document.getElementById('fullModelFilter').value,
                sampleStage: document.getElementById('sampleStageFilter').value,
                version: document.getElementById('versionFilter').value,
                bigSpecies: document.getElementById('bigSpeciesFilter').value,
                smallSpecies: document.getElementById('smallSpeciesFilter').value,
                problemCategory: generateProblemCategorySearchKeyword(),
                defectLevel: document.getElementById('defectLevelFilter').value,
                currentStatus: document.getElementById('currentStatusFilter').value,
                tester: document.getElementById('testerFilter').value,
                responsibleDepartment: document.getElementById('responsibleDepartmentFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value,
                dqe: document.getElementById('dqeFilter').value,
                problem: document.getElementById('problemFilter').value,
                testPlatform: document.getElementById('testPlatformFilter').value,
                testDevice: document.getElementById('testDeviceFilter').value,
                otherDevice: document.getElementById('otherDeviceFilter').value
            };
        }

        // 生成筛选条件描述
        function generateFilterDescription(filters) {
            const descriptions = [];

            if (filters.fullModel) descriptions.push(`完整编码: ${filters.fullModel}`);
            if (filters.sampleStage) descriptions.push(`样品阶段: ${filters.sampleStage}`);
            if (filters.version) descriptions.push(`版本: ${filters.version}`);
            if (filters.bigSpecies) descriptions.push(`大类: ${filters.bigSpecies}`);
            if (filters.smallSpecies) descriptions.push(`小类: ${filters.smallSpecies}`);
            if (filters.problemCategory) descriptions.push(`问题类别: ${filters.problemCategory}`);
            if (filters.defectLevel) descriptions.push(`缺陷等级: ${filters.defectLevel}`);
            if (filters.currentStatus) descriptions.push(`当前状态: ${filters.currentStatus}`);
            if (filters.tester) descriptions.push(`测试人员: ${filters.tester}`);
            if (filters.responsibleDepartment) descriptions.push(`责任部门: ${filters.responsibleDepartment}`);
            if (filters.startDate) descriptions.push(`开始时间: ${filters.startDate}`);
            if (filters.endDate) descriptions.push(`结束时间: ${filters.endDate}`);
            if (filters.dqe) descriptions.push(`DQE负责人: ${filters.dqe}`);
            if (filters.problem) descriptions.push(`问题描述: ${filters.problem}`);
            if (filters.testPlatform) descriptions.push(`测试平台: ${filters.testPlatform}`);
            if (filters.testDevice) descriptions.push(`显示设备: ${filters.testDevice}`);
            if (filters.otherDevice) descriptions.push(`其他设备: ${filters.otherDevice}`);

            return descriptions.length > 0 ? descriptions.join(', ') : '无条件筛选';
        }

        // 显示收藏夹模态框
        function showCartModal() {
            renderCartItems();
            document.getElementById('cartModal').style.display = 'block';
        }

        // 渲染收藏夹项目
        function renderCartItems() {
            const tbody = document.getElementById('cartItemsTableBody');
            tbody.innerHTML = '';

            if (cartItems.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #666;">收藏夹为空</td>
                `;
                tbody.appendChild(row);
                return;
            }

            cartItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="cart-item-checkbox" data-item-id="${item.id}" onchange="updateSelectAllStatus()">
                    </td>
                    <td>${index + 1}</td>
                    <td class="filter-desc" title="${item.filterDescription}">${item.filterDescription.length > 50 ? item.filterDescription.substring(0, 50) + '...' : item.filterDescription}</td>
                    <td>${item.dataCount}</td>
                    <td>${item.saveTime}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewCartItem(${item.id})">查看</button>
                        <button class="btn btn-sm btn-danger" onclick="removeCartItem(${item.id})">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 全选/取消全选收藏夹项目
        function toggleSelectAllCartItems() {
            const selectAllCheckbox = document.getElementById('selectAllCartItems');
            const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');

            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // 更新全选状态
        function updateSelectAllStatus() {
            const selectAllCheckbox = document.getElementById('selectAllCartItems');
            const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');
            const checkedCount = document.querySelectorAll('.cart-item-checkbox:checked').length;

            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === itemCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // 获取选中的收藏夹项目
        function getSelectedCartItems() {
            const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            const selectedItemIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.itemId));
            return cartItems.filter(item => selectedItemIds.includes(item.id));
        }

        // 收藏夹管理模态框的 查看收藏夹项目
        function viewCartItem(itemId) {
            const item = cartItems.find(i => i.id === itemId);
            if (!item) return;

            // 显示收藏夹详情模态框
            showCartDetailModal(item);
        }

        // 显示收藏夹详情模态框
        function showCartDetailModal(item) {
            // 设置基本信息
            document.getElementById('cartDetailFilter').textContent = item.filterDescription;
            document.getElementById('cartDetailCount').textContent = item.dataCount;
            document.getElementById('cartDetailTime').textContent = item.saveTime;

            // 渲染详情表格
            renderCartDetailTable(item.data);

            // 显示模态框
            document.getElementById('cartDetailModal').style.display = 'block';
        }

        // 渲染收藏夹详情表格
        function renderCartDetailTable(data) {
            const tbody = document.getElementById('cartDetailTableBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="19" style="text-align: center; color: #666;">暂无数据</td>
                `;
                tbody.appendChild(row);
                return;
            }

            data.forEach(problem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${problem.id || ''}</td>
                    <td>${problem.full_model || ''}</td>
                    <td>${problem.big_species || ''}</td>
                    <td>${problem.small_species || ''}</td>
                    <td>${problem.sample_stage || ''}</td>
                    <td>${problem.version || ''}</td>
                    <td>${problem.test_platform || ''}</td>
                    <td>${problem.test_device || ''}</td>
                    <td>${problem.other_device || ''}</td>
                    <td class="problem-desc" title="${problem.problem || ''}">${problem.problem || ''}</td>
                    <td>${problem.problemCategory || ''}</td>
                    <td>${problem.defect_level || ''}</td>
                    <td>${problem.current_status || ''}</td>
                    <td>${problem.tester || ''}</td>
                    <td>${problem.dqe || ''}</td>
                    <td>${problem.responsibleDepartment || ''}</td>
                    <td>${problem.green_union_dqe || ''}</td>
                    <td>${problem.green_union_rd || ''}</td>
                    <td>${problem.created_at || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 删除收藏夹项目
        function removeCartItem(itemId) {
            if (confirm('确定要删除这个收藏夹项目吗？')) {
                cartItems = cartItems.filter(i => i.id !== itemId);
                saveCartToStorage();
                updateCartCount();
                renderCartItems();
            }
        }

        // 清空收藏夹
        function clearCart() {
            if (confirm('确定要清空整个收藏夹吗？此操作不可恢复！')) {
                cartItems = [];
                mergedData = [];
                saveCartToStorage();
                updateCartCount();
                renderCartItems();
                hideMergedData();
                alert('收藏夹已清空');
            }
        }

        // 合并收藏夹数据
        function mergeCartData() {
            const selectedItems = getSelectedCartItems();

            if (selectedItems.length === 0) {
                showToast('请先选择要合并的收藏夹项目！', 'warning');
                return;
            }

            // console.log('选中的收藏夹项目:', selectedItems);

            // 合并选中的收藏夹项目的数据
            mergedData = [];
            const idSet = new Set(); // 用于去重

            selectedItems.forEach(item => {
                // console.log(`处理收藏夹项目 ${item.id}:`, item.data.length, '条数据');
                item.data.forEach(problem => {
                    if (!idSet.has(problem.id)) {
                        idSet.add(problem.id);
                        mergedData.push(problem);
                    }
                });
            });

            // console.log('合并后的数据:', mergedData.length, '条');

            // 显示合并数据，传递选中的项目数量
            showMergedData(selectedItems.length);
            showToast(`已合并 ${selectedItems.length} 个收藏夹项目，共 ${mergedData.length} 条数据`, 'success');
        }

        // 显示合并数据
        function showMergedData(selectedCount = 0) {
            const section = document.getElementById('mergedDataSection');
            const totalCount = mergedData.length;
            const uniqueCount = mergedData.length; // 已经去重了

            // console.log('显示合并数据:', {
            //     selectedCount: selectedCount,
            //     totalCount: totalCount,
            //     mergedDataLength: mergedData.length
            // });

            // 先隐藏，然后显示，确保刷新
            section.style.display = 'none';

            // 更新统计信息，显示选中的项目数量
            const statsElement = document.querySelector('.merged-stats');
            if (statsElement) {
                statsElement.innerHTML = `
                    <span>选中项目: <strong>${selectedCount}</strong></span>
                    <span>总数据量: <strong>${totalCount}</strong></span>
                    <span>去重后: <strong>${uniqueCount}</strong></span>
                `;
            }

            // 渲染合并数据表格
            renderMergedDataTable();

            // 强制重新显示
            setTimeout(() => {
                section.style.display = 'block';
            }, 10);
        }

        // 隐藏合并数据
        function hideMergedData() {
            document.getElementById('mergedDataSection').style.display = 'none';
        }

        // 渲染合并数据表格
        function renderMergedDataTable() {
            const tbody = document.getElementById('mergedDataTableBody');
            tbody.innerHTML = '';

            // console.log('渲染合并数据表格，数据条数:', mergedData.length);

            if (mergedData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="19" style="text-align: center; color: #666;">没有数据</td>
                `;
                tbody.appendChild(row);
                return;
            }

            mergedData.forEach((problem, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${problem.id}</td>
                    <td>${problem.full_model || ''}</td>
                    <td>${problem.big_species || ''}</td>
                    <td>${problem.small_species || ''}</td>
                    <td>${problem.sample_stage || ''}</td>
                    <td>${problem.version || ''}</td>
                    <td>${problem.test_platform || ''}</td>
                    <td>${problem.test_device || ''}</td>
                    <td>${problem.other_device || ''}</td>
                    <td class="problem-desc">${(problem.problem || '').substring(0, 50)}${(problem.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${problem.problemCategory || ''}</td>
                    <td>${problem.defect_level || ''}</td>
                    <td>${normalizeStatus(problem.current_status)}</td>
                    <td>${problem.tester || ''}</td>
                    <td>${problem.dqe || ''}</td>
                    <td>${problem.responsibleDepartment || ''}</td>
                    <td>${problem.green_union_dqe || ''}</td>
                    <td>${problem.green_union_rd || ''}</td>
                    <td>${problem.created_at ? problem.created_at.substring(0, 10) : ''}</td>
                `;
                tbody.appendChild(row);
            });

            // console.log('合并数据表格渲染完成，实际渲染行数:', tbody.children.length);
        }

        // 导出收藏夹数据
        function exportCartData() {
            const selectedItems = getSelectedCartItems();

            if (selectedItems.length === 0) {
                showToast('请先选择要导出的收藏夹项目！', 'warning');
                return;
            }

            showLoading();

            // 合并选中的收藏夹项目的数据
            const exportMergedData = [];
            const idSet = new Set(); // 用于去重

            selectedItems.forEach(item => {
                item.data.forEach(problem => {
                    if (!idSet.has(problem.id)) {
                        idSet.add(problem.id);
                        exportMergedData.push(problem);
                    }
                });
            });


            // 准备导出数据
            const exportData = {
                data: exportMergedData,
                exportType: 'cart',
                fileName: `收藏夹合并数据_${new Date().toISOString().slice(0, 10)}.xlsx`
            };

            fetch('/problemLibrary/exportCartsData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(exportData)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('导出失败');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportData.fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast(`成功导出 ${selectedItems.length} 个收藏夹项目，共 ${exportMergedData.length} 条记录！`, 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('导出时发生错误', 'error');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 更新收藏夹计数
        function updateCartCount() {
            const countElement = document.getElementById('cartCount');
            if (countElement) {
                countElement.textContent = cartItems.length;
            }
        }

        // 保存收藏夹到本地存储
        function saveCartToStorage() {
            try {
                localStorage.setItem('problemLibraryCart', JSON.stringify(cartItems));
            } catch (e) {
                console.error('保存收藏夹失败:', e);
            }
        }

        // 从本地存储加载收藏夹
        function loadCartFromStorage() {
            try {
                const stored = localStorage.getItem('problemLibraryCart');
                if (stored) {
                    cartItems = JSON.parse(stored);
                }
            } catch (e) {
                console.error('加载收藏夹失败:', e);
                cartItems = [];
            }
        }
    </script>
</body>
</html>
