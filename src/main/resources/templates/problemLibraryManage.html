<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问题点库管理</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/problemLibraryManageStyle.css">
    <!-- 引入jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 引入钉钉JSAPI -->
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>
    <!-- 引入问题类别配置 -->
    <script src="/js/problemCategories.js"></script>
    
    <!-- 自定义提示框样式 -->
    <style>
        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .custom-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-content {
            display: flex;
            align-items: center;
            padding: 16px;
            position: relative;
        }

        .toast-icon {
            color: #28a745;
            font-size: 20px;
            margin-right: 12px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            color: #999;
            font-size: 12px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .toast-close:hover {
            background-color: #f5f5f5;
            color: #666;
        }

        .custom-toast.success .toast-icon {
            color: #28a745;
        }

        .custom-toast.error .toast-icon {
            color: #dc3545;
        }

        .custom-toast.warning .toast-icon {
            color: #ffc107;
        }

        .custom-toast.info .toast-icon {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <!-- 页面头部 -->
    <div class="header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-database"></i>
                问题点库管理
            </h1>
            <div class="user-info">
                <span id="currentUser"></span>
                <span id="currentRole"></span>
                <span id="cacheStatus" class="cache-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
            </div>
        </div>
    </div>

    <!-- 筛选和操作区域 -->
    <div class="filter-section">
        <div class="filter-container">
            <!-- 基础筛选 -->
            <div class="filter-row">
                <div class="filter-group">
                    <label>完整编码:</label>
                    <select id="fullModelFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshFullModelBtn" class="btn btn-sm btn-outline-info" title="刷新完整编码选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="filter-group">
                    <label>样品阶段:</label>
                    <select id="sampleStageFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshSampleStageBtn" class="btn btn-sm btn-outline-info" title="刷新样品阶段选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="filter-group">
                    <label>版本:</label>
                    <select id="versionFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshVersionBtn" class="btn btn-sm btn-outline-info" title="刷新版本选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="filter-group">
                    <label>大类:</label>
                    <select id="bigSpeciesFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshBigSpeciesBtn" class="btn btn-sm btn-outline-info" title="刷新大类选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="filter-group">
                    <label>小类:</label>
                    <select id="smallSpeciesFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshSmallSpeciesBtn" class="btn btn-sm btn-outline-info" title="刷新小类选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="filter-group">
                    <label>问题类别:</label>
                    <div class="filter-input-group">
                        <select id="problemCategoryFilter">
                            <option value="">全部</option>
                        </select>
                        <div class="button-group">
                            <button id="refreshProblemCategoryBtn" class="btn btn-sm btn-outline-primary" title="从数据库刷新问题类别选项">
                                <i class="fas fa-database"></i>
                            </button>
                            <button id="refreshProblemCategoryConfigBtn" class="btn btn-sm btn-outline-secondary" title="从配置文件刷新问题类别选项">
                                <i class="fas fa-file-code"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>缺陷等级:</label>
                    <select id="defectLevelFilter">
                        <option value="">全部</option>
                        <option value="S">S</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="待确定">待确定</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>当前状态:</label>
                    <select id="currentStatusFilter" data-compatible="true">
                        <option value="">全部</option>
                        <option value="Open">Open</option>
                        <option value="Closed" data-compatible-values="close,closed,Close,CLOSED">Closed</option>
                        <option value="Follow up" data-compatible-values="follow up,followup,Follow up,FOLLOW UP">Follow up</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>测试人员:</label>
                    <select id="testerFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshTesterBtn" class="btn btn-sm btn-outline-info" title="刷新测试人员选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="filter-group">
                    <label>责任部门:</label>
                    <select id="responsibleDepartmentFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshResponsibleDepartmentBtn" class="btn btn-sm btn-outline-info" title="刷新责任部门选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>提交时间:</label>
                    <input type="date" id="startDateFilter">
                    <span>至</span>
                    <input type="date" id="endDateFilter">
                </div>
                <div class="filter-group">
                    <label>DQE负责人:</label>
                    <input type="text" id="dqeFilter" placeholder="输入DQE负责人">
                </div>
                <div class="filter-group">
                    <label>问题描述:</label>
                    <input type="text" id="problemFilter" placeholder="输入问题关键词">
                </div>
                <div class="filter-group">
                    <label>测试平台:</label>
                    <select id="testPlatformFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshTestPlatformBtn" class="btn btn-sm btn-outline-info" title="刷新测试平台选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>显示设备:</label>
                    <select id="testDeviceFilter">
                        <option value="">全部</option>
                    </select>
                    <button id="refreshTestDeviceBtn" class="btn btn-sm btn-outline-info" title="刷新显示设备选项（从服务器获取最新数据）">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="filter-group">
                    <label>其他设备:</label>
                    <input type="text" id="otherDeviceFilter" placeholder="输入其他设备">
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="action-buttons">
                <button id="searchBtn" class="btn btn-primary">
                    <i class="fas fa-search"></i> 搜索
                </button>
                <button id="resetBtn" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> 重置
                </button>
                <button id="addToCartBtn" class="btn btn-warning">
                    <i class="fas fa-shopping-cart"></i> 加入收藏夹
                </button>
                <button id="exportBtn" class="btn btn-success">
                    <i class="fas fa-download"></i> 导出筛选结果
                </button>
                <button id="showCartBtn" class="btn btn-info">
                    <i class="fas fa-list"></i> 查看收藏夹 (<span id="cartCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- 数据统计区域 -->
    <div class="stats-section">
        <div class="stats-container">

            <div class="stat-item clickable-stat" onclick="filterByStatus('Open')">
                <span class="stat-label">Open:</span>
                <span class="stat-value" id="openCount">0</span>
            </div>
            <div class="stat-item clickable-stat" onclick="filterByStatus('Closed')">
                <span class="stat-label">Closed:</span>
                <span class="stat-value" id="closedCount">0</span>
            </div>
            <div class="stat-item clickable-stat" onclick="filterByStatus('Follow up')">
                <span class="stat-label">Follow up:</span>
                <span class="stat-value" id="followupCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">筛选结果:</span>
                <span class="stat-value" id="filteredCount">0</span>
            </div>
        </div>
    </div>

    <!-- 数据表格区域 -->
    <div class="table-section">
        <div class="table-container">
            <table id="problemTable" class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>完整编码</th>
                        <th>大类</th>
                        <th>小类</th>
                        <th>样品阶段</th>
                        <th>版本</th>
                        <th>测试平台</th>
                        <th>显示设备</th>
                        <th>其他设备</th>
                        <th>问题描述</th>
                        <th>问题类别</th>
                        <th>缺陷等级</th>
                        <th>当前状态</th>
                        <th>测试人员</th>
                        <th>DQE责任人</th>
                        <th>责任部门</th>
                        <th>DQE确认回复</th>
                        <th>研发确认回复</th>
                        <th>提交时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="problemTableBody">
                    <!-- 数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>

        <!-- 分页控件 -->
        <div class="pagination-container">
            <div class="pagination-info">
                <span>显示第 <span id="startRecord">1</span> - <span id="endRecord">10</span> 条，共 <span id="totalRecords">0</span> 条记录</span>
                <div class="page-size-selector">
                    <label>每页显示:</label>
                    <select id="pageSizeSelect">
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>条</span>
                </div>
            </div>
            <div class="pagination-controls">
                <button id="firstPageBtn" class="btn btn-sm" title="首页">首页</button>
                <button id="prevPageBtn" class="btn btn-sm">上一页</button>
                <div class="page-numbers" id="pageNumbers">
                    <!-- 页码按钮将通过JavaScript动态生成 -->
                </div>
                <button id="nextPageBtn" class="btn btn-sm">下一页</button>
                <button id="lastPageBtn" class="btn btn-sm" title="末页">末页</button>
                <div class="page-jump">
                    <span>跳转到</span>
                    <input type="number" id="pageJumpInput" min="1" style="width: 60px; margin: 0 5px;">
                    <span>页</span>
                    <button id="pageJumpBtn" class="btn btn-sm">跳转</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 问题点详情模态框 -->
    <div id="problemDetailModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>问题点详情</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProblemId" value="">
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>基本信息</h3>
                        <div class="detail-row">
                            <label>样品ID:</label>
                            <span id="detailSampleId" class="detail-value"></span>
                        </div>
                        <div class="detail-row">
                            <label>完整编码:</label>
                            <span id="detailFullModel" class="detail-value"></span>
                            <input type="text" id="editDetailFullModel" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>大类:</label>
                            <span id="detailBigSpecies" class="detail-value"></span>
                            <input type="text" id="editDetailBigSpecies" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>小类:</label>
                            <span id="detailSmallSpecies" class="detail-value"></span>
                            <input type="text" id="editDetailSmallSpecies" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>样品阶段:</label>
                            <span id="detailSampleStage" class="detail-value"></span>
                            <input type="text" id="editDetailSampleStage" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>版本:</label>
                            <span id="detailVersion" class="detail-value"></span>
                            <input type="text" id="editDetailVersion" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>芯片方案:</label>
                            <span id="detailChipSolution" class="detail-value"></span>
                            <input type="text" id="editDetailChipSolution" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>测试平台:</label>
                            <span id="detailTestPlatform" class="detail-value"></span>
                            <input type="text" id="editDetailTestPlatform" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>显示设备:</label>
                            <span id="detailTestDevice" class="detail-value"></span>
                            <input type="text" id="editDetailTestDevice" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>其他设备:</label>
                            <span id="detailOtherDevice" class="detail-value"></span>
                            <input type="text" id="editDetailOtherDevice" class="detail-input" style="display: none;">
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>问题信息</h3>
                        <div class="detail-row">
                            <label>问题描述:</label>
                            <div id="detailProblem" class="detail-value"></div>
                            <textarea id="editDetailProblem" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>问题类别:</label>
                            <span id="detailProblemCategory" class="detail-value"></span>
                            <select id="editDetailProblemCategory" class="detail-input" style="display: none;">
                                <option value="">请选择问题类别</option>
                                <optgroup label="视频组">
                                    <option value="视频播放问题">视频播放问题</option>
                                    <option value="视频录制问题">视频录制问题</option>
                                    <option value="视频编码问题">视频编码问题</option>
                                    <option value="视频解码问题">视频解码问题</option>
                                    <option value="视频传输问题">视频传输问题</option>
                                    <option value="视频显示问题">视频显示问题</option>
                                    <option value="视频格式问题">视频格式问题</option>
                                    <option value="视频画质问题">视频画质问题</option>
                                    <option value="视频同步问题">视频同步问题</option>
                                    <option value="视频卡顿问题">视频卡顿问题</option>
                                </optgroup>
                                <optgroup label="蓝牙组">
                                    <option value="蓝牙连接问题">蓝牙连接问题</option>
                                    <option value="蓝牙配对问题">蓝牙配对问题</option>
                                    <option value="蓝牙传输问题">蓝牙传输问题</option>
                                    <option value="蓝牙音频问题">蓝牙音频问题</option>
                                    <option value="蓝牙信号问题">蓝牙信号问题</option>
                                    <option value="蓝牙兼容性问题">蓝牙兼容性问题</option>
                                    <option value="蓝牙功耗问题">蓝牙功耗问题</option>
                                    <option value="蓝牙协议问题">蓝牙协议问题</option>
                                    <option value="蓝牙设备识别问题">蓝牙设备识别问题</option>
                                    <option value="蓝牙断连问题">蓝牙断连问题</option>
                                </optgroup>
                                <optgroup label="硬件组">
                                    <option value="硬件设计问题">硬件设计问题</option>
                                    <option value="生产问题">生产问题</option>
                                    <option value="器件问题">器件问题</option>
                                    <option value="配件问题">配件问题</option>
                                    <option value="外观问题">外观问题</option>
                                    <option value="PCBA问题">PCBA问题</option>
                                    <option value="电路问题">电路问题</option>
                                    <option value="接口问题">接口问题</option>
                                    <option value="散热问题">散热问题</option>
                                    <option value="机械结构问题">机械结构问题</option>
                                </optgroup>
                                <optgroup label="软件组">
                                    <option value="软件问题">软件问题</option>
                                    <option value="系统问题">系统问题</option>
                                    <option value="驱动问题">驱动问题</option>
                                    <option value="固件问题">固件问题</option>
                                    <option value="应用问题">应用问题</option>
                                    <option value="界面问题">界面问题</option>
                                    <option value="性能问题">性能问题</option>
                                    <option value="兼容性问题">兼容性问题</option>
                                    <option value="稳定性问题">稳定性问题</option>
                                    <option value="功能缺失问题">功能缺失问题</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>缺陷等级:</label>
                            <span id="detailDefectLevel" class="detail-value"></span>
                            <select id="editDetailDefectLevel" class="detail-input" style="display: none;">
                                <option value="S">S</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="待确定">待确定</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>当前状态:</label>
                            <span id="detailCurrentStatus" class="detail-value"></span>
                            <select id="editDetailCurrentStatus" class="detail-input" style="display: none;">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Follow up">Follow up</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>复现手法:</label>
                            <div id="detailReproductionMethod" class="detail-value"></div>
                            <textarea id="editDetailReproductionMethod" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>恢复方法:</label>
                            <div id="detailRecoveryMethod" class="detail-value"></div>
                            <textarea id="editDetailRecoveryMethod" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>复现概率:</label>
                            <span id="detailReproductionProbability" class="detail-value"></span>
                            <input type="text" id="editDetailReproductionProbability" class="detail-input" style="display: none;">
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>处理信息</h3>
                        <div class="detail-row">
                            <label>测试人员:</label>
                            <span id="detailTester" class="detail-value"></span>
                            <input type="text" id="editDetailTester" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>责任部门:</label>
                            <span id="detailResponsibleDepartment" class="detail-value"></span>
                            <select id="editDetailResponsibleDepartment" class="detail-input" style="display: none;">
                                <option value="SQE">SQE</option>
                                <option value="ID">ID</option>
                                <option value="结构">结构</option>
                                <option value="研发">研发</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>分析责任人:</label>
                            <span id="detailResponsiblePerson" class="detail-value"></span>
                            <input type="text" id="editDetailResponsiblePerson" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>DQE确认:</label>
                            <span id="detailDqeConfirm" class="detail-value"></span>
                            <input type="text" id="editDetailDqeConfirm" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>研发确认:</label>
                            <span id="detailRdConfirm" class="detail-value"></span>
                            <input type="text" id="editDetailRdConfirm" class="detail-input" style="display: none;">
                        </div>
                        <div class="detail-row">
                            <label>改善对策:</label>
                            <div id="detailImprovementPlan" class="detail-value"></div>
                            <textarea id="editDetailImprovementPlan" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>DQE回复:</label>
                            <div id="detailGreenUnionDqe" class="detail-value"></div>
                            <textarea id="editDetailGreenUnionDqe" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>研发回复:</label>
                            <div id="detailGreenUnionRd" class="detail-value"></div>
                            <textarea id="editDetailGreenUnionRd" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>其他信息</h3>
                        <div class="detail-row">
                            <label>对比上一版:</label>
                            <div id="detailComparisonWithPrevious" class="detail-value"></div>
                            <textarea id="editDetailComparisonWithPrevious" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>改善后风险:</label>
                            <div id="detailPostImprovementRisk" class="detail-value"></div>
                            <textarea id="editDetailPostImprovementRisk" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>下一版回归测试:</label>
                            <div id="detailNextVersionRegressionTest" class="detail-value"></div>
                            <textarea id="editDetailNextVersionRegressionTest" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>备注:</label>
                            <div id="detailRemark" class="detail-value"></div>
                            <textarea id="editDetailRemark" class="detail-input" rows="3" style="display: none;"></textarea>
                        </div>
                        <div class="detail-row">
                            <label>内外贸:</label>
                            <span id="detailTestOverseas" class="detail-value"></span>
                            <select id="editDetailTestOverseas" class="detail-input" style="display: none;">
                                <option value="内贸">内贸</option>
                                <option value="外贸">外贸</option>
                            </select>
                        </div>
                        <div class="detail-row">
                            <label>提交时间:</label>
                            <span id="detailCreatedAt" class="detail-value"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="editProblemBtn" class="btn btn-primary" style="display: none;">编辑</button>
                <button id="saveDetailBtn" class="btn btn-success" style="display: none;">保存</button>
                <button id="cancelEditBtn" class="btn btn-secondary" style="display: none;">取消</button>
                <button id="closeDetailModal" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 编辑问题点模态框 -->
    <div id="editProblemModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>编辑问题点</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProblemForm">
                    <input type="hidden" id="editProblemId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editFullModel">完整编码:</label>
                            <input type="text" id="editFullModel" name="fullModel">
                        </div>
                        <div class="form-group">
                            <label for="editSampleStage">样品阶段:</label>
                            <select id="editSampleStage" name="sampleStage">
                                <option value="EVT">EVT</option>
                                <option value="DVT">DVT</option>
                                <option value="PVT">PVT</option>
                                <option value="MP">MP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editVersion">版本:</label>
                            <input type="text" id="editVersion" name="version">
                        </div>
                        <div class="form-group">
                            <label for="editProblemCategory">问题类别:</label>
                            <select id="editProblemCategory" name="problemCategory">
                                <option value="">请选择问题类别</option>
                                <optgroup label="视频组">
                                    <option value="视频播放问题">视频播放问题</option>
                                    <option value="视频录制问题">视频录制问题</option>
                                    <option value="视频编码问题">视频编码问题</option>
                                    <option value="视频解码问题">视频解码问题</option>
                                    <option value="视频传输问题">视频传输问题</option>
                                    <option value="视频显示问题">视频显示问题</option>
                                    <option value="视频格式问题">视频格式问题</option>
                                    <option value="视频画质问题">视频画质问题</option>
                                    <option value="视频同步问题">视频同步问题</option>
                                    <option value="视频卡顿问题">视频卡顿问题</option>
                                </optgroup>
                                <optgroup label="蓝牙组">
                                    <option value="蓝牙连接问题">蓝牙连接问题</option>
                                    <option value="蓝牙配对问题">蓝牙配对问题</option>
                                    <option value="蓝牙传输问题">蓝牙传输问题</option>
                                    <option value="蓝牙音频问题">蓝牙音频问题</option>
                                    <option value="蓝牙信号问题">蓝牙信号问题</option>
                                    <option value="蓝牙兼容性问题">蓝牙兼容性问题</option>
                                    <option value="蓝牙功耗问题">蓝牙功耗问题</option>
                                    <option value="蓝牙协议问题">蓝牙协议问题</option>
                                    <option value="蓝牙设备识别问题">蓝牙设备识别问题</option>
                                    <option value="蓝牙断连问题">蓝牙断连问题</option>
                                </optgroup>
                                <optgroup label="硬件组">
                                <option value="硬件设计问题">硬件设计问题</option>
                                <option value="生产问题">生产问题</option>
                                <option value="器件问题">器件问题</option>
                                <option value="配件问题">配件问题</option>
                                <option value="外观问题">外观问题</option>
                                <option value="PCBA问题">PCBA问题</option>
                                    <option value="电路问题">电路问题</option>
                                    <option value="接口问题">接口问题</option>
                                    <option value="散热问题">散热问题</option>
                                    <option value="机械结构问题">机械结构问题</option>
                                </optgroup>
                                <optgroup label="软件组">
                                    <option value="软件问题">软件问题</option>
                                    <option value="系统问题">系统问题</option>
                                    <option value="驱动问题">驱动问题</option>
                                    <option value="固件问题">固件问题</option>
                                    <option value="应用问题">应用问题</option>
                                    <option value="界面问题">界面问题</option>
                                    <option value="性能问题">性能问题</option>
                                    <option value="兼容性问题">兼容性问题</option>
                                    <option value="稳定性问题">稳定性问题</option>
                                    <option value="功能缺失问题">功能缺失问题</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDefectLevel">缺陷等级:</label>
                            <select id="editDefectLevel" name="defectLevel">
                                <option value="S">S</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="待确定">待确定</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editCurrentStatus">当前状态:</label>
                            <select id="editCurrentStatus" name="currentStatus">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Follow up">Follow up</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="editProblem">问题描述:</label>
                            <textarea id="editProblem" name="problem" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editReproductionMethod">复现手法:</label>
                            <textarea id="editReproductionMethod" name="reproductionMethod" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editRecoveryMethod">恢复方法:</label>
                            <textarea id="editRecoveryMethod" name="recoveryMethod" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editReproductionProbability">复现概率:</label>
                            <input type="text" id="editReproductionProbability" name="reproductionProbability">
                        </div>
                        <div class="form-group">
                            <label for="editTester">测试人员:</label>
                            <input type="text" id="editTester" name="tester">
                        </div>
                        <div class="form-group">
                            <label for="editResponsibleDepartment">责任部门:</label>
                            <select id="editResponsibleDepartment" name="responsibleDepartment">
                                <option value="SQE">SQE</option>
                                <option value="ID">ID</option>
                                <option value="结构">结构</option>
                                <option value="研发">研发</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editResponsiblePerson">分析责任人:</label>
                            <input type="text" id="editResponsiblePerson" name="responsiblePerson">
                        </div>
                        <div class="form-group full-width">
                            <label for="editImprovementPlan">改善对策:</label>
                            <textarea id="editImprovementPlan" name="improvementPlan" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editGreenUnionDqe">DQE回复:</label>
                            <textarea id="editGreenUnionDqe" name="greenUnionDqe" rows="3"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="editGreenUnionRd">研发回复:</label>
                            <textarea id="editGreenUnionRd" name="greenUnionRd" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editTestOverseas">内外贸:</label>
                            <select id="editTestOverseas" name="testOverseas">
                                <option value="内贸">内贸</option>
                                <option value="外贸">外贸</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="editRemark">备注:</label>
                            <textarea id="editRemark" name="remark" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveProblemBtn" class="btn btn-primary">保存</button>
                <button id="cancelEditBtn" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <!-- 历史版本模态框 -->
    <div id="historyVersionsModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>历史版本</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="history-versions-container">
                    <table id="historyVersionsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>版本号</th>
                                <th>问题描述</th>
                                <th>状态</th>
                                <th>修改人</th>
                                <th>修改时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="historyVersionsTableBody">
                            <!-- 历史版本数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeHistoryModal" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 收藏夹模态框 -->
    <div id="cartModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>收藏夹管理</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="cart-controls">
                    <button id="clearCartBtn" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> 清空收藏夹
                    </button>
                    <button id="exportCartBtn" class="btn btn-success btn-sm">
                        <i class="fas fa-download"></i> 导出收藏夹数据
                    </button>
                    <button id="mergeCartBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-layer-group"></i> 合并显示
                    </button>
                </div>

                <div class="cart-items-container">
                    <table id="cartItemsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>筛选条件</th>
                                <th>数据量</th>
                                <th>保存时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="cartItemsTableBody">
                            <!-- 收藏夹项目将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 合并数据展示区域 -->
                <div id="mergedDataSection" class="merged-data-section" style="display: none;">
                    <h3>合并数据预览</h3>
                    <div class="merged-stats">
                        <span>总数据量: <strong id="mergedTotalCount">0</strong></span>
                        <span>去重后: <strong id="mergedUniqueCount">0</strong></span>
                    </div>
                    <div class="merged-table-container">
                        <table id="mergedDataTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>完整编码</th>
                                    <th>大类</th>
                                    <th>小类</th>
                                    <th>样品阶段</th>
                                    <th>版本</th>
                                    <th>测试平台</th>
                                    <th>显示设备</th>
                                    <th>其他设备</th>
                                    <th>问题描述</th>
                                    <th>问题类别</th>
                                    <th>缺陷等级</th>
                                    <th>当前状态</th>
                                    <th>测试人员</th>
                                    <th>DQE责任人</th>
                                    <th>责任部门</th>
                                    <th>DQE确认回复</th>
                                    <th>研发确认回复</th>
                                    <th>提交时间</th>
                                </tr>
                            </thead>
                            <tbody id="mergedDataTableBody">
                                <!-- 合并数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeCartModal" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>加载中...</p>
        </div>
    </div>

    <!-- 自定义提示框 -->
    <div id="customToast" class="custom-toast">
        <div class="toast-content">
            <div class="toast-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="toast-message" id="toastMessage">操作成功</div>
            <div class="toast-close" id="toastClose">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-nav">
        <button class="nav-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
            <span>返回</span>
        </button>
        <button class="nav-btn" onclick="goHome()">
            <i class="fas fa-home"></i>
            <span>主页</span>
        </button>
    </div>

    <script>
        // 全局变量
        let currentUser = '';
        let currentRole = '';
        let currentPage = 1;
        let pageSize = 20;
        let totalRecords = 0;
        let filteredData = [];
        let isSuperAdmin = false; // 是否为超级管理员

        // 购物车/收藏夹相关变量
        let cartItems = []; // 收藏夹项目
        let mergedData = []; // 合并后的数据

        // 缓存相关变量
        let speciesCache = {
            bigSpecies: null,
            smallSpecies: null,
            sampleStage: null,
            fullModel: null,
            version: null,
            problemCategory: null,
            tester: null,
            responsibleDepartment: null,
            testPlatform: null,
            testDevice: null,
            lastUpdated: null
        };

        // 标准化状态显示
        function normalizeStatus(status) {
            if (!status) return '';
            const normalized = status.toLowerCase().trim();
            switch (normalized) {
                case 'open':
                    return 'Open';
                case 'closed':
                case 'close':
                    return 'Closed';
                case 'follow up':
                case 'followup':
                    return 'Follow up';
                default:
                    return status; // 保持原值
            }
        }

        // 缓存管理函数
        function getCachedSpeciesOptions(speciesType) {
            // 先从内存缓存获取
            if (speciesCache[speciesType]) {
                return speciesCache[speciesType];
            }

            // 如果内存缓存没有，从localStorage获取
            try {
                const cached = localStorage.getItem('speciesCache');
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    if (parsedCache[speciesType] && isCacheValid(parsedCache.lastUpdated)) {
                        // 恢复到内存缓存
                        speciesCache = parsedCache;
                        return speciesCache[speciesType];
                    }
                }
            } catch (e) {
                console.error('读取缓存失败:', e);
            }

            return null;
        }

        // 检查并加载缓存选项到下拉框
        function checkAndLoadCachedOptions(speciesType) {
            const cachedOptions = getCachedSpeciesOptions(speciesType);
            if (cachedOptions && cachedOptions.length > 0) {
                updateSelectOptions(speciesType + 'Filter', cachedOptions);
                return true;
            }
            return false;
        }

        function setCachedSpeciesOptions(speciesType, options) {
            // 更新内存缓存
            speciesCache[speciesType] = options;
            speciesCache.lastUpdated = new Date().getTime();

            // 保存到localStorage
            try {
                localStorage.setItem('speciesCache', JSON.stringify(speciesCache));
            } catch (e) {
                console.error('保存缓存失败:', e);
            }

            updateCacheStatusDisplay();
        }

        function isCacheValid(lastUpdated) {
            // 缓存有效期为1小时（3600000毫秒）
            const CACHE_DURATION = 60 * 60 * 1000;
            const timestamp = lastUpdated || speciesCache.lastUpdated;
            return timestamp && (new Date().getTime() - timestamp) < CACHE_DURATION;
        }

        function clearSpeciesCache() {
            // 清除内存缓存
            speciesCache = {
                bigSpecies: null,
                smallSpecies: null,
                sampleStage: null,
                fullModel: null,
                version: null,
                problemCategory: null,
                tester: null,
                responsibleDepartment: null,
                testPlatform: null,
                testDevice: null,
                lastUpdated: null
            };

            // 清除localStorage缓存
            try {
                localStorage.removeItem('speciesCache');
            } catch (e) {
                console.error('清除缓存失败:', e);
            }

            updateCacheStatusDisplay();
        }

        function loadCacheFromStorage() {
            try {
                const cached = localStorage.getItem('speciesCache');
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    if (isCacheValid(parsedCache.lastUpdated)) {
                        // 恢复缓存到内存
                        speciesCache = parsedCache;
                        console.log('缓存已从localStorage恢复');

                        // 从缓存加载选项到下拉框
                        loadOptionsFromCache();
                    } else {
                        console.log('localStorage中的缓存已过期');
                    }
                }
            } catch (e) {
                console.error('从localStorage加载缓存失败:', e);
            }
        }

        function loadOptionsFromCache() {
            // 加载大类选项
            if (speciesCache.bigSpecies && speciesCache.bigSpecies.length > 0) {
                updateSelectOptions('bigSpeciesFilter', speciesCache.bigSpecies);
                console.log('大类选项已从缓存加载');
            }

            // 加载小类选项
            if (speciesCache.smallSpecies && speciesCache.smallSpecies.length > 0) {
                updateSelectOptions('smallSpeciesFilter', speciesCache.smallSpecies);
                console.log('小类选项已从缓存加载');
            }

            // 加载样品阶段选项
            if (speciesCache.sampleStage && speciesCache.sampleStage.length > 0) {
                updateSelectOptions('sampleStageFilter', speciesCache.sampleStage);
                console.log('样品阶段选项已从缓存加载');
            }

            // 加载完整编码选项
            if (speciesCache.fullModel && speciesCache.fullModel.length > 0) {
                updateSelectOptions('fullModelFilter', speciesCache.fullModel);
                console.log('完整编码选项已从缓存加载');
            }

            // 加载版本选项
            if (speciesCache.version && speciesCache.version.length > 0) {
                updateSelectOptions('versionFilter', speciesCache.version);
                console.log('版本选项已从缓存加载');
            }

            // 加载问题类别选项
            if (speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
                updateSelectOptions('problemCategoryFilter', speciesCache.problemCategory);
                console.log('问题类别选项已从缓存加载');
            }

            // 加载测试人员选项
            if (speciesCache.tester && speciesCache.tester.length > 0) {
                updateSelectOptions('testerFilter', speciesCache.tester);
                console.log('测试人员选项已从缓存加载');
            }

            // 加载责任部门选项
            if (speciesCache.responsibleDepartment && speciesCache.responsibleDepartment.length > 0) {
                updateSelectOptions('responsibleDepartmentFilter', speciesCache.responsibleDepartment);
                console.log('责任部门选项已从缓存加载');
            }

            // 加载测试平台选项
            if (speciesCache.testPlatform && speciesCache.testPlatform.length > 0) {
                updateSelectOptions('testPlatformFilter', speciesCache.testPlatform);
                console.log('测试平台选项已从缓存加载');
            }

            // 加载显示设备选项
            if (speciesCache.testDevice && speciesCache.testDevice.length > 0) {
                updateSelectOptions('testDeviceFilter', speciesCache.testDevice);
                console.log('显示设备选项已从缓存加载');
            }
        }

        function updateCacheStatusDisplay() {
            const cacheStatusElement = document.getElementById('cacheStatus');
            if (!cacheStatusElement) return;

            if (speciesCache.lastUpdated && isCacheValid()) {
                const timeAgo = Math.floor((new Date().getTime() - speciesCache.lastUpdated) / 1000 / 60);
                cacheStatusElement.textContent = `缓存有效 (${timeAgo}分钟前)`;
                cacheStatusElement.style.color = '#28a745';
            } else if (speciesCache.lastUpdated) {
                cacheStatusElement.textContent = '缓存已过期';
                cacheStatusElement.style.color = '#ffc107';
            } else {
                cacheStatusElement.textContent = '无缓存';
                cacheStatusElement.style.color = '#6c757d';
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户权限
            checkUserPermission();

            // 初始化问题类别筛选器
            initProblemCategoryFilter();

            // 初始化事件监听器
            initEventListeners();

            // 初始化缓存状态显示
            loadCacheFromStorage();
            updateCacheStatusDisplay();

            // 初始化购物车
            loadCartFromStorage();
            updateCartCount();

            // 确保分页控件可见
            const paginationContainer = document.querySelector('.pagination-container');
            if (paginationContainer) {
                paginationContainer.style.display = 'flex';
                console.log('分页控件已显示');
            } else {
                console.error('找不到分页控件');
            }

            // 加载数据
            loadProblemData();
        });

        // 初始化问题类别筛选器
        function initProblemCategoryFilter() {
            // 注释掉原来的配置文件方法，现在使用缓存系统
            /*
            const filterSelect = document.getElementById('problemCategoryFilter');
            if (!filterSelect) return;

            // 清空现有选项（保留"全部"选项）
            filterSelect.innerHTML = '<option value="">全部</option>';

            // 使用配置文件生成选项
            if (typeof generateFilterProblemCategorySelect === 'function') {
                const optionsHtml = generateFilterProblemCategorySelect();
                // 提取option标签
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = optionsHtml;
                const options = tempDiv.querySelectorAll('option:not(:first-child)');
                const optgroups = tempDiv.querySelectorAll('optgroup');

                // 添加optgroup和option
                optgroups.forEach(optgroup => {
                    const newOptgroup = document.createElement('optgroup');
                    newOptgroup.label = optgroup.label;
                    optgroup.querySelectorAll('option').forEach(option => {
                        const newOption = document.createElement('option');
                        newOption.value = option.value;
                        newOption.textContent = option.textContent;
                        newOptgroup.appendChild(newOption);
                    });
                    filterSelect.appendChild(newOptgroup);
                });
            }
            */

            // 现在使用缓存系统，在loadOptionsFromCache中处理
            console.log('问题类别筛选器初始化完成，将使用缓存系统');
        }

        // 检查用户权限
        function checkUserPermission() {
            currentUser = localStorage.getItem('username');
            currentRole = localStorage.getItem('job');

            if (!currentUser || !currentRole) {
                alert('请先登录并选择角色！');
                window.location.href = '/DQEIndex';
                return;
            }

            // 检查是否有权限进入问题点库管理页面
            const allowedUsers = ['邓小英', '邓令章', '卢健', '李良健', '黄家灿'];
            if (!allowedUsers.includes(currentUser)) {
                alert('您没有权限进入问题点库管理页面！');
                window.location.href = '/DQEIndex';
                return;
            }

            // 检查是否为超级管理员
            isSuperAdmin = (currentUser === '卢健' && currentRole === 'manager');

            // 显示用户信息
            document.getElementById('currentUser').textContent = `用户: ${currentUser}`;
            document.getElementById('currentRole').textContent = `角色: ${currentRole}`;

            // 根据权限控制界面元素
            controlEditPermissions();
        }

        // 控制编辑权限
        function controlEditPermissions() {
            // 新增问题点按钮已移除，无需控制
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 搜索按钮
            document.getElementById('searchBtn').addEventListener('click', searchProblems);

            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', resetFilters);

            // 为筛选输入框添加回车键搜索功能
            const filterInputs = [
                'fullModelFilter', 'sampleStageFilter', 'versionFilter', 'bigSpeciesFilter', 'smallSpeciesFilter',
                'testerFilter', 'dqeFilter', 'problemFilter', 'testPlatformFilter', 'testDeviceFilter', 'otherDeviceFilter'
            ];

            filterInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            searchProblems();
                        }
                    });
                }
            });

            // 导出按钮
            document.getElementById('exportBtn').addEventListener('click', exportFilteredData);

            // 加入收藏夹按钮
            document.getElementById('addToCartBtn').addEventListener('click', addToCart);

            // 查看收藏夹按钮
            document.getElementById('showCartBtn').addEventListener('click', showCartModal);

            // 收藏夹相关按钮
            document.getElementById('clearCartBtn').addEventListener('click', clearCart);
            document.getElementById('exportCartBtn').addEventListener('click', exportCartData);
            document.getElementById('mergeCartBtn').addEventListener('click', mergeCartData);
            document.getElementById('closeCartModal').addEventListener('click', function() {
                closeSpecificModal('cartModal');
            });

            // 刷新大类按钮
            document.getElementById('refreshBigSpeciesBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('bigSpecies');
            });

            // 刷新小类按钮
            document.getElementById('refreshSmallSpeciesBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('smallSpecies');
            });

            // 刷新样品阶段按钮
            document.getElementById('refreshSampleStageBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('sampleStage');
            });

            // 刷新完整编码按钮
            document.getElementById('refreshFullModelBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('fullModel');
            });

            // 刷新版本按钮
            document.getElementById('refreshVersionBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('version');
            });

            // 刷新问题类别按钮
            document.getElementById('refreshProblemCategoryBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('problemCategory');
            });

            // 刷新问题类别配置文件按钮
            document.getElementById('refreshProblemCategoryConfigBtn').addEventListener('click', function() {
                refreshProblemCategoryFromConfig();
            });

            // 刷新测试人员按钮
            document.getElementById('refreshTesterBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('tester');
            });

            // 刷新责任部门按钮
            document.getElementById('refreshResponsibleDepartmentBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('responsibleDepartment');
            });

            // 刷新测试平台按钮
            document.getElementById('refreshTestPlatformBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('testPlatform');
            });

            // 刷新显示设备按钮
            document.getElementById('refreshTestDeviceBtn').addEventListener('click', function() {
                refreshSingleSpeciesOptions('testDevice');
            });



            // 分页按钮
            document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));
            document.getElementById('lastPageBtn').addEventListener('click', () => goToLastPage());

            // 每页显示数量选择器
            document.getElementById('pageSizeSelect').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                renderTable();
            });

            // 页码跳转
            document.getElementById('pageJumpBtn').addEventListener('click', jumpToPage);
            document.getElementById('pageJumpInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });

            // 保存问题点
            document.getElementById('saveProblemBtn').addEventListener('click', saveProblem);

            // 取消编辑（编辑模态框的取消按钮）
            document.getElementById('cancelEditBtn').addEventListener('click', function() {
                // 检查当前是否在编辑模态框中
                const editModal = document.getElementById('editProblemModal');
                if (editModal && editModal.style.display === 'block') {
                    closeModal(); // 关闭编辑模态框
                } else {
                    exitEditMode(); // 退出详情模态框的编辑模式
                }
            });

            // 关闭历史版本模态框
            document.getElementById('closeHistoryModal').addEventListener('click', closeModal);

            // 关闭详情模态框
            document.getElementById('closeDetailModal').addEventListener('click', function() {
                closeSpecificModal('problemDetailModal');
            });

            // 详情模态框编辑按钮
            document.getElementById('editProblemBtn').addEventListener('click', function() {
                enterEditMode();
            });

            // 保存详情按钮
            document.getElementById('saveDetailBtn').addEventListener('click', function() {
                saveDetailChanges();
            });



            // 使用事件委托来处理所有关闭按钮
            document.addEventListener('click', function(event) {
                // 处理X按钮关闭
                if (event.target.classList.contains('close')) {
                    // 找到最近的模态框并关闭
                    const modal = event.target.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                    return;
                }

                // 处理点击模态框外部关闭
                if (event.target.classList.contains('modal')) {
                    // 只关闭被点击的模态框
                    event.target.style.display = 'none';
                    return;
                }
            });

            // 提示框事件监听器
            const toast = document.getElementById('customToast');
            const toastClose = document.getElementById('toastClose');
            
            // 点击关闭按钮
            toastClose.addEventListener('click', hideToast);
            
            // 点击提示框外部关闭
            toast.addEventListener('click', function(event) {
                if (event.target === toast) {
                    hideToast();
                }
            });
        }

        // 加载问题点数据
        function loadProblemData() {
            showLoading();

            fetch('/problemLibrary/getProblems', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    filteredData = data.data;
                    updateStatistics();
                    renderTable();
                } else {
                    alert('加载数据失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('加载数据时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 搜索问题点
        function searchProblems() {
            showLoading();

            const filters = {
                fullModel: document.getElementById('fullModelFilter').value,
                sampleStage: document.getElementById('sampleStageFilter').value,
                version: document.getElementById('versionFilter').value,
                bigSpecies: document.getElementById('bigSpeciesFilter').value,
                smallSpecies: document.getElementById('smallSpeciesFilter').value,
                problemCategory: document.getElementById('problemCategoryFilter').value,
                defectLevel: document.getElementById('defectLevelFilter').value,
                currentStatus: document.getElementById('currentStatusFilter').value,
                tester: document.getElementById('testerFilter').value,
                responsibleDepartment: document.getElementById('responsibleDepartmentFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value,
                dqe: document.getElementById('dqeFilter').value,
                problem: document.getElementById('problemFilter').value,
                testPlatform: document.getElementById('testPlatformFilter').value,
                testDevice: document.getElementById('testDeviceFilter').value,
                otherDevice: document.getElementById('otherDeviceFilter').value
            };

            fetch('/problemLibrary/searchProblems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    filteredData = data.data;
                    currentPage = 1;
                    updateStatistics();
                    renderTable();
                } else {
                    alert('搜索失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('搜索时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById('fullModelFilter').value = '';
            document.getElementById('sampleStageFilter').value = '';
            document.getElementById('versionFilter').value = '';
            document.getElementById('bigSpeciesFilter').value = '';
            document.getElementById('smallSpeciesFilter').value = '';
            document.getElementById('problemCategoryFilter').value = '';
            document.getElementById('defectLevelFilter').value = '';
            document.getElementById('currentStatusFilter').value = '';
            document.getElementById('testerFilter').value = '';
            document.getElementById('responsibleDepartmentFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('dqeFilter').value = '';
            document.getElementById('problemFilter').value = '';
            document.getElementById('testPlatformFilter').value = '';
            document.getElementById('testDeviceFilter').value = '';
            document.getElementById('otherDeviceFilter').value = '';

            loadProblemData();
        }

        // 导出筛选结果
        function exportFilteredData() {
            if (filteredData.length === 0) {
                alert('没有数据可导出');
                return;
            }

            showLoading();

            // 使用当前的筛选条件
            const filters = {
                fullModel: document.getElementById('fullModelFilter').value,
                sampleStage: document.getElementById('sampleStageFilter').value,
                version: document.getElementById('versionFilter').value,
                bigSpecies: document.getElementById('bigSpeciesFilter').value,
                smallSpecies: document.getElementById('smallSpeciesFilter').value,
                problemCategory: document.getElementById('problemCategoryFilter').value,
                defectLevel: document.getElementById('defectLevelFilter').value,
                currentStatus: document.getElementById('currentStatusFilter').value,
                tester: document.getElementById('testerFilter').value,
                responsibleDepartment: document.getElementById('responsibleDepartmentFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value,
                dqe: document.getElementById('dqeFilter').value,
                problem: document.getElementById('problemFilter').value,
                testPlatform: document.getElementById('testPlatformFilter').value,
                testDevice: document.getElementById('testDeviceFilter').value,
                otherDevice: document.getElementById('otherDeviceFilter').value
            };

            fetch('/problemLibrary/exportProblems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('导出失败');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `问题点库_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('导出时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 显示问题点详情
        function showProblemDetail(problemId) {
            // 首先尝试从当前过滤数据中查找
            let problem = filteredData.find(p => p.id === problemId);

            // 如果没找到，说明是从历史版本模态框中点击的，需要通过API获取详情
            if (!problem) {
                showLoading();
                fetch(`/problemLibrary/getProblemById?id=${problemId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        problem = data.data;
                        displayProblemDetail(problem);
                    } else {
                        alert('获取问题点详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取问题点详情时发生错误');
                })
                .finally(() => {
                    hideLoading();
                });
                return;
            }

            displayProblemDetail(problem);
        }

        // 显示问题点详情的具体实现
        function displayProblemDetail(problem) {
            // 填充详情数据
            document.getElementById('detailFullModel').textContent = problem.full_model || '';
            document.getElementById('detailSampleId').textContent = problem.sample_id || '';
            document.getElementById('detailBigSpecies').textContent = problem.big_species || '';
            document.getElementById('detailSmallSpecies').textContent = problem.small_species || '';
            document.getElementById('detailSampleStage').textContent = problem.sample_stage || '';
            document.getElementById('detailVersion').textContent = problem.version || '';
            document.getElementById('detailChipSolution').textContent = problem.chip_solution || '';
            document.getElementById('detailTestPlatform').textContent = problem.test_platform || '';
            document.getElementById('detailTestDevice').textContent = problem.test_device || '';
            document.getElementById('detailOtherDevice').textContent = problem.other_device || '';
            document.getElementById('detailProblem').textContent = problem.problem || '';
            document.getElementById('detailProblemCategory').textContent = problem.problemCategory || '';
            document.getElementById('detailDefectLevel').textContent = problem.defect_level || '';
            document.getElementById('detailCurrentStatus').textContent = normalizeStatus(problem.current_status);
            document.getElementById('detailReproductionMethod').textContent = problem.reproduction_method || '';
            document.getElementById('detailRecoveryMethod').textContent = problem.recovery_method || '';
            document.getElementById('detailReproductionProbability').textContent = problem.reproduction_probability || '';
            document.getElementById('detailTester').textContent = problem.tester || '';
            document.getElementById('detailResponsibleDepartment').textContent = problem.responsibleDepartment || '';
            document.getElementById('detailResponsiblePerson').textContent = problem.responsible_person || '';
            document.getElementById('detailDqeConfirm').textContent = problem.dqe_confirm || '';
            document.getElementById('detailRdConfirm').textContent = problem.rd_confirm || '';
            document.getElementById('detailImprovementPlan').textContent = problem.improvement_plan || '';
            document.getElementById('detailGreenUnionDqe').textContent = problem.green_union_dqe || '';
            document.getElementById('detailGreenUnionRd').textContent = problem.green_union_rd || '';
            document.getElementById('detailComparisonWithPrevious').textContent = problem.comparison_with_previous || '';
            document.getElementById('detailPostImprovementRisk').textContent = problem.post_improvement_risk || '';
            document.getElementById('detailNextVersionRegressionTest').textContent = problem.next_version_regression_test || '';
            document.getElementById('detailRemark').textContent = problem.remark || '';
            document.getElementById('detailTestOverseas').textContent = problem.test_Overseas || '';
            document.getElementById('detailCreatedAt').textContent = problem.created_at || '';

            // 设置问题ID
            document.getElementById('editProblemId').value = problem.id;

            // 同步编辑输入框的值
            document.getElementById('editDetailFullModel').value = problem.full_model || '';
            document.getElementById('editDetailBigSpecies').value = problem.big_species || '';
            document.getElementById('editDetailSmallSpecies').value = problem.small_species || '';
            document.getElementById('editDetailSampleStage').value = problem.sample_stage || '';
            document.getElementById('editDetailVersion').value = problem.version || '';
            document.getElementById('editDetailChipSolution').value = problem.chip_solution || '';
            document.getElementById('editDetailTestPlatform').value = problem.test_platform || '';
            document.getElementById('editDetailTestDevice').value = problem.test_device || '';
            document.getElementById('editDetailOtherDevice').value = problem.other_device || '';
            document.getElementById('editDetailProblem').value = problem.problem || '';
            document.getElementById('editDetailProblemCategory').value = problem.problemCategory || '';
            document.getElementById('editDetailDefectLevel').value = problem.defect_level || '';
            document.getElementById('editDetailCurrentStatus').value = normalizeStatus(problem.current_status);
            document.getElementById('editDetailReproductionMethod').value = problem.reproduction_method || '';
            document.getElementById('editDetailRecoveryMethod').value = problem.recovery_method || '';
            document.getElementById('editDetailReproductionProbability').value = problem.reproduction_probability || '';
            document.getElementById('editDetailTester').value = problem.tester || '';
            document.getElementById('editDetailResponsibleDepartment').value = problem.responsibleDepartment || '';
            document.getElementById('editDetailResponsiblePerson').value = problem.responsible_person || '';
            document.getElementById('editDetailDqeConfirm').value = problem.dqe_confirm || '';
            document.getElementById('editDetailRdConfirm').value = problem.rd_confirm || '';
            document.getElementById('editDetailImprovementPlan').value = problem.improvement_plan || '';
            document.getElementById('editDetailGreenUnionDqe').value = problem.green_union_dqe || '';
            document.getElementById('editDetailGreenUnionRd').value = problem.green_union_rd || '';
            document.getElementById('editDetailComparisonWithPrevious').value = problem.comparison_with_previous || '';
            document.getElementById('editDetailPostImprovementRisk').value = problem.post_improvement_risk || '';
            document.getElementById('editDetailNextVersionRegressionTest').value = problem.next_version_regression_test || '';
            document.getElementById('editDetailRemark').value = problem.remark || '';
            document.getElementById('editDetailTestOverseas').value = problem.test_Overseas || '';

            // 根据权限控制编辑按钮显示
            const editBtn = document.getElementById('editProblemBtn');
            if (editBtn) {
                if (isSuperAdmin) {
                    editBtn.style.display = 'inline-flex';
                } else {
                    editBtn.style.display = 'none';
                }
            }

            // 确保退出编辑模式
            exitEditMode();

            document.getElementById('problemDetailModal').style.display = 'block';
        }



        // 显示编辑问题点模态框
        function showEditProblemModal(problemId) {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            const problem = filteredData.find(p => p.id === problemId);
            if (!problem) return;

            // 填充编辑表单
            document.getElementById('editProblemId').value = problem.id;
            document.getElementById('editFullModel').value = problem.full_model || '';
            document.getElementById('editSampleStage').value = problem.sample_stage || '';
            document.getElementById('editVersion').value = problem.version || '';
            document.getElementById('editProblemCategory').value = problem.problemCategory || '';
            document.getElementById('editDefectLevel').value = problem.defect_level || '';
            document.getElementById('editCurrentStatus').value = normalizeStatus(problem.current_status);
            document.getElementById('editProblem').value = problem.problem || '';
            document.getElementById('editReproductionMethod').value = problem.reproduction_method || '';
            document.getElementById('editRecoveryMethod').value = problem.recovery_method || '';
            document.getElementById('editReproductionProbability').value = problem.reproduction_probability || '';
            document.getElementById('editTester').value = problem.tester || '';
            document.getElementById('editResponsibleDepartment').value = problem.responsibleDepartment || '';
            document.getElementById('editResponsiblePerson').value = problem.responsible_person || '';
            document.getElementById('editImprovementPlan').value = problem.improvement_plan || '';
            document.getElementById('editGreenUnionDqe').value = problem.green_union_dqe || '';
            document.getElementById('editGreenUnionRd').value = problem.green_union_rd || '';
            document.getElementById('editTestOverseas').value = problem.test_Overseas || '';
            document.getElementById('editRemark').value = problem.remark || '';

            document.getElementById('editProblemModal').style.display = 'block';
        }

        // 保存问题点
        function saveProblem() {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            // 检查问题点字段是否为空
            const problemValue = document.getElementById('editProblem').value;
            if (!problemValue || problemValue.trim() === '') {
                alert('问题点字段不能为空，请填写问题描述！');
                document.getElementById('editProblem').focus();
                return;
            }

            const formData = new FormData(document.getElementById('editProblemForm'));
            const problemData = Object.fromEntries(formData.entries());
            problemData.id = document.getElementById('editProblemId').value;
            problemData.modifier = currentUser;

            showLoading();

            fetch('/problemLibrary/updateProblem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(problemData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                    closeModal();
                    loadProblemData();
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 渲染表格
        function renderTable() {
            const tbody = document.getElementById('problemTableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach(problem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${problem.id}</td>
                    <td>${problem.full_model || ''}</td>
                    <td>${problem.big_species || ''}</td>
                    <td>${problem.small_species || ''}</td>
                    <td>${problem.sample_stage || ''}</td>
                    <td>${problem.version || ''}</td>
                    <td>${problem.test_platform || ''}</td>
                    <td>${problem.test_device || ''}</td>
                    <td>${problem.other_device || ''}</td>
                    <td class="problem-desc">${(problem.problem || '').substring(0, 50)}${(problem.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${problem.problemCategory || ''}</td>
                    <td>${problem.defect_level || ''}</td>
                    <td>${normalizeStatus(problem.current_status)}</td>
                    <td>${problem.tester || ''}</td>
                    <td>${problem.dqe || ''}</td>
                    <td>${problem.responsibleDepartment || ''}</td>
                    <td>${problem.green_union_dqe || ''}</td>
                    <td>${problem.green_union_rd || ''}</td>
                    <td>${problem.created_at ? problem.created_at.substring(0, 10) : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showProblemDetail(${problem.id})">查看</button>
                        <button class="btn btn-sm btn-secondary" onclick="showHistoryVersions('${problem.sample_id}')">历史版本</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // 更新分页信息
        function updatePagination() {
            totalRecords = filteredData.length;
            const totalPages = Math.ceil(totalRecords / pageSize);
            const startRecord = totalRecords > 0 ? (currentPage - 1) * pageSize + 1 : 0;
            const endRecord = Math.min(currentPage * pageSize, totalRecords);

            // 确保当前页不超过总页数
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }

            document.getElementById('startRecord').textContent = startRecord;
            document.getElementById('endRecord').textContent = endRecord;
            document.getElementById('totalRecords').textContent = totalRecords;

            // 更新按钮状态
            document.getElementById('firstPageBtn').disabled = currentPage === 1 || totalPages === 0;
            document.getElementById('prevPageBtn').disabled = currentPage === 1 || totalPages === 0;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages || totalPages === 0;

            // 生成页码按钮
            generatePageNumbers(totalPages);

            // 更新跳转输入框的最大值
            document.getElementById('pageJumpInput').max = totalPages;

            // 调试信息
            console.log(`分页信息: 总记录数=${totalRecords}, 总页数=${totalPages}, 当前页=${currentPage}, 每页=${pageSize}`);
        }

        // 切换页面
        function changePage(direction) {
            const totalPages = Math.ceil(totalRecords / pageSize);
            const newPage = currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // 跳转到指定页面
        function goToPage(page) {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
            }
        }

        // 跳转到最后一页
        function goToLastPage() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (totalPages > 0) {
                currentPage = totalPages;
                renderTable();
            }
        }

        // 页码跳转
        function jumpToPage() {
            const input = document.getElementById('pageJumpInput');
            const page = parseInt(input.value);
            const totalPages = Math.ceil(totalRecords / pageSize);

            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
                input.value = '';
            } else {
                alert(`请输入1到${totalPages}之间的页码`);
                input.value = '';
            }
        }

        // 生成页码按钮
        function generatePageNumbers(totalPages) {
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';

            // 即使只有一页也显示页码
            if (totalPages <= 0) return;

            if (totalPages === 1) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = '1';
                pageBtn.className = 'btn btn-sm page-number active';
                pageBtn.onclick = () => goToPage(1);
                pageNumbersContainer.appendChild(pageBtn);
                return;
            }

            const maxVisiblePages = 5; // 最多显示5个页码按钮
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // 调整起始页码
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // 添加省略号
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.className = 'btn btn-sm page-number';
                firstBtn.onclick = () => goToPage(1);
                pageNumbersContainer.appendChild(firstBtn);

                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }

            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = `btn btn-sm page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.onclick = () => goToPage(i);
                pageNumbersContainer.appendChild(pageBtn);
            }

            // 添加省略号
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    pageNumbersContainer.appendChild(ellipsis);
                }

                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.className = 'btn btn-sm page-number';
                lastBtn.onclick = () => goToPage(totalPages);
                pageNumbersContainer.appendChild(lastBtn);
            }
        }

        // 更新统计信息
        function updateStatistics() {
            const open = filteredData.filter(p => (p.current_status || '').toLowerCase() === 'open').length;
            const closed = filteredData.filter(p => {
                const status = (p.current_status || '').toLowerCase();
                return status === 'closed' || status === 'close';
            }).length;
            const followup = filteredData.filter(p => (p.current_status || '').toLowerCase() === 'follow up').length;

            document.getElementById('openCount').textContent = open;
            document.getElementById('closedCount').textContent = closed;
            document.getElementById('followupCount').textContent = followup;
            document.getElementById('filteredCount').textContent = filteredData.length;
        }

        // 根据状态筛选
        function filterByStatus(status) {
            // 保持其他筛选条件不变，只修改当前状态筛选
            document.getElementById('currentStatusFilter').value = status;

            // 执行搜索
            searchProblems();
        }

        // 刷新单个选项（大类或小类）
        function refreshSingleSpeciesOptions(speciesType) {
            // 直接从服务器获取最新数据，不使用缓存
            fetchSpeciesOptionsFromServer(speciesType);
        }

        // 强制刷新（忽略缓存）
        function forceRefreshSpeciesOptions(speciesType) {
            // 清除缓存
            clearSpeciesCache();
            // 从服务器获取
            fetchSpeciesOptionsFromServer(speciesType);
        }

        // 从服务器获取选项
        function fetchSpeciesOptionsFromServer(speciesType) {
            showLoading();

            fetch('/problemLibrary/getSpeciesOptions', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // console.log(data.data)
                    // 更新缓存（同时更新所有选项，因为服务器返回的是完整数据）
                    setCachedSpeciesOptions('bigSpecies', data.data.bigSpecies);
                    setCachedSpeciesOptions('smallSpecies', data.data.smallSpecies);
                    setCachedSpeciesOptions('sampleStage', data.data.sampleStage);
                    setCachedSpeciesOptions('fullModel', data.data.fullModel);
                    setCachedSpeciesOptions('version', data.data.version);
                    setCachedSpeciesOptions('problemCategory', data.data.problemCategory);
                    setCachedSpeciesOptions('tester', data.data.tester);
                    setCachedSpeciesOptions('responsibleDepartment', data.data.responsibleDepartment);
                    setCachedSpeciesOptions('testPlatform', data.data.testPlatform);
                    setCachedSpeciesOptions('testDevice', data.data.testDevice);

                    // 更新对应的下拉框
                    if (speciesType === 'bigSpecies') {
                        updateSelectOptions('bigSpeciesFilter', data.data.bigSpecies);
                        showToast('大类选项已刷新并缓存', 'success');
                    } else if (speciesType === 'smallSpecies') {
                        updateSelectOptions('smallSpeciesFilter', data.data.smallSpecies);
                        showToast('小类选项已刷新并缓存', 'success');
                    } else if (speciesType === 'sampleStage') {
                        updateSelectOptions('sampleStageFilter', data.data.sampleStage);
                        showToast('样品阶段选项已刷新并缓存', 'success');
                    } else if (speciesType === 'fullModel') {
                        updateSelectOptions('fullModelFilter', data.data.fullModel);
                        showToast('完整编码选项已刷新并缓存', 'success');
                    } else if (speciesType === 'version') {
                        updateSelectOptions('versionFilter', data.data.version);
                        showToast('版本选项已刷新并缓存', 'success');
                    } else if (speciesType === 'problemCategory') {
                        updateSelectOptions('problemCategoryFilter', data.data.problemCategory);
                        showToast('问题类别选项已刷新并缓存', 'success');
                    } else if (speciesType === 'tester') {
                        updateSelectOptions('testerFilter', data.data.tester);
                        showToast('测试人员选项已刷新并缓存', 'success');
                    } else if (speciesType === 'responsibleDepartment') {
                        updateSelectOptions('responsibleDepartmentFilter', data.data.responsibleDepartment);
                        showToast('责任部门选项已刷新并缓存', 'success');
                    } else if (speciesType === 'testPlatform') {
                        updateSelectOptions('testPlatformFilter', data.data.testPlatform);
                        showToast('测试平台选项已刷新并缓存', 'success');
                    } else if (speciesType === 'testDevice') {
                        updateSelectOptions('testDeviceFilter', data.data.testDevice);
                        showToast('显示设备选项已刷新并缓存', 'success');
                    }
                } else {
                    showToast('刷新失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('刷新时发生错误', 'error');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 更新下拉框选项
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;

            // 保存当前选中的值
            const currentValue = select.value;

            // 清空现有选项（保留"全部"选项）
            select.innerHTML = '<option value="">全部</option>';

            // 添加新选项
            if (options && options.length > 0) {
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    // 如果选项为空字符串，显示为"空值"
                    optionElement.textContent = option === '' ? '空值' : option;
                    select.appendChild(optionElement);
                });
            }

            // 尝试恢复之前选中的值
            if (currentValue && Array.from(select.options).some(option => option.value === currentValue)) {
                select.value = currentValue;
            }
        }

        // 从配置文件刷新问题类别选项
        function refreshProblemCategoryFromConfig() {
            const filterSelect = document.getElementById('problemCategoryFilter');
            if (!filterSelect) return;

            // 保存当前选中的值
            const currentValue = filterSelect.value;

            // 清空现有选项（保留"全部"选项）
            filterSelect.innerHTML = '<option value="">全部</option>';

            // 使用配置文件生成选项
            if (typeof generateFilterProblemCategorySelect === 'function') {
                const optionsHtml = generateFilterProblemCategorySelect();
                // 提取option标签
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = optionsHtml;
                const optgroups = tempDiv.querySelectorAll('optgroup');

                // 收集所有选项值用于缓存
                const allOptions = [];

                // 添加optgroup和option
                optgroups.forEach(optgroup => {
                    const newOptgroup = document.createElement('optgroup');
                    newOptgroup.label = optgroup.label;
                    optgroup.querySelectorAll('option').forEach(option => {
                        const newOption = document.createElement('option');
                        newOption.value = option.value;
                        newOption.textContent = option.textContent;
                        newOptgroup.appendChild(newOption);
                        allOptions.push(option.value);
                    });
                    filterSelect.appendChild(newOptgroup);
                });

                // 将配置文件选项保存到缓存
                setCachedSpeciesOptions('problemCategory', allOptions);

                // 尝试恢复之前选中的值
                if (currentValue && Array.from(filterSelect.options).some(option => option.value === currentValue)) {
                    filterSelect.value = currentValue;
                }

                alert('问题类别选项已从配置文件刷新并缓存');
            } else {
                alert('配置文件函数不可用，请检查problemCategories.js是否正确加载');
            }
        }

        // 进入编辑模式
        function enterEditMode() {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            // 所有可编辑字段（除了提交时间）
            const editableFields = [
                'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
                'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
                'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
                'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
                'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
                'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
                'detailGreenUnionDqe', 'detailGreenUnionRd',
                'detailComparisonWithPrevious', 'detailPostImprovementRisk',
                'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
            ];

            editableFields.forEach(fieldId => {
                const displayElement = document.getElementById(fieldId);
                const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

                if (displayElement && inputElement) {
                    displayElement.style.display = 'none';
                    inputElement.style.display = 'block';
                }
            });

            // 切换按钮显示
            document.getElementById('editProblemBtn').style.display = 'none';
            document.getElementById('saveDetailBtn').style.display = 'inline-flex';
            document.getElementById('cancelEditBtn').style.display = 'inline-flex';
        }

        // 退出编辑模式
        function exitEditMode() {
            // 所有可编辑字段（除了提交时间）
            const editableFields = [
                'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
                'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
                'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
                'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
                'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
                'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
                'detailGreenUnionDqe', 'detailGreenUnionRd',
                'detailComparisonWithPrevious', 'detailPostImprovementRisk',
                'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
            ];

            editableFields.forEach(fieldId => {
                const displayElement = document.getElementById(fieldId);
                const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

                if (displayElement && inputElement) {
                    displayElement.style.display = 'block';
                    inputElement.style.display = 'none';
                }
            });

            // 切换按钮显示
            document.getElementById('editProblemBtn').style.display = 'inline-flex';
            document.getElementById('saveDetailBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // 保存详情修改
        function saveDetailChanges() {
            // 检查权限
            if (!isSuperAdmin) {
                alert('您没有权限进行此操作！');
                return;
            }

            // 检查问题点字段是否为空
            const problemValue = document.getElementById('editDetailProblem').value;
            if (!problemValue || problemValue.trim() === '') {
                alert('问题点字段不能为空，请填写问题描述！');
                document.getElementById('editDetailProblem').focus();
                return;
            }

            // 收集修改的数据 - 只传递必要的字段
            const problemData = {
                id: document.getElementById('editProblemId').value,
                modifier: currentUser
            };

            // 只添加有值的字段
            const fields = [
                { key: 'full_model', element: 'editDetailFullModel' },
                { key: 'big_species', element: 'editDetailBigSpecies' },
                { key: 'small_species', element: 'editDetailSmallSpecies' },
                { key: 'sample_stage', element: 'editDetailSampleStage' },
                { key: 'version', element: 'editDetailVersion' },
                { key: 'chip_solution', element: 'editDetailChipSolution' },
                { key: 'test_platform', element: 'editDetailTestPlatform' },
                { key: 'test_device', element: 'editDetailTestDevice' },
                { key: 'other_device', element: 'editDetailOtherDevice' },
                { key: 'problem', element: 'editDetailProblem' },
                { key: 'problemCategory', element: 'editDetailProblemCategory' },
                { key: 'defect_level', element: 'editDetailDefectLevel' },
                { key: 'current_status', element: 'editDetailCurrentStatus' },
                { key: 'reproduction_method', element: 'editDetailReproductionMethod' },
                { key: 'recovery_method', element: 'editDetailRecoveryMethod' },
                { key: 'reproduction_probability', element: 'editDetailReproductionProbability' },
                { key: 'tester', element: 'editDetailTester' },
                { key: 'responsibleDepartment', element: 'editDetailResponsibleDepartment' },
                { key: 'responsible_person', element: 'editDetailResponsiblePerson' },
                { key: 'dqe_confirm', element: 'editDetailDqeConfirm' },
                { key: 'rd_confirm', element: 'editDetailRdConfirm' },
                { key: 'improvement_plan', element: 'editDetailImprovementPlan' },
                { key: 'green_union_dqe', element: 'editDetailGreenUnionDqe' },
                { key: 'green_union_rd', element: 'editDetailGreenUnionRd' },
                { key: 'comparison_with_previous', element: 'editDetailComparisonWithPrevious' },
                { key: 'post_improvement_risk', element: 'editDetailPostImprovementRisk' },
                { key: 'next_version_regression_test', element: 'editDetailNextVersionRegressionTest' },
                { key: 'remark', element: 'editDetailRemark' },
                { key: 'test_Overseas', element: 'editDetailTestOverseas' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.element);
                if (element && element.value !== '') {
                    problemData[field.key] = element.value;
                }
            });

            showLoading();

            fetch('/problemLibrary/updateProblem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(problemData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                    exitEditMode();
                    loadProblemData(); // 重新加载表格数据

                    // 重新获取并显示更新后的问题点详情
                    const problemId = document.getElementById('editProblemId').value;
                    fetch(`/problemLibrary/getProblemById?id=${problemId}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success && result.data) {
                                displayProblemDetail(result.data);
                            }
                        })
                        .catch(error => {
                            console.error('获取更新后数据失败:', error);
                        });
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // 显示自定义提示框
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('customToast');
            const messageEl = document.getElementById('toastMessage');
            const iconEl = toast.querySelector('.toast-icon i');
            
            // 设置消息内容
            messageEl.textContent = message;
            
            // 设置图标和样式
            toast.className = 'custom-toast ' + type;
            switch(type) {
                case 'success':
                    iconEl.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    iconEl.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    iconEl.className = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                    iconEl.className = 'fas fa-info-circle';
                    break;
            }
            
            // 显示提示框
            toast.classList.add('show');
            
            // 自动隐藏
            if (duration > 0) {
                setTimeout(() => {
                    hideToast();
                }, duration);
            }
        }

        // 隐藏自定义提示框
        function hideToast() {
            const toast = document.getElementById('customToast');
            toast.classList.remove('show');
        }

        // 关闭模态框
        function closeModal() {
            // 获取所有可见的模态框，按z-index排序
            const visibleModals = Array.from(document.querySelectorAll('.modal'))
                .filter(modal => modal.style.display === 'block')
                .sort((a, b) => {
                    const aZIndex = parseInt(window.getComputedStyle(a).zIndex) || 0;
                    const bZIndex = parseInt(window.getComputedStyle(b).zIndex) || 0;
                    return bZIndex - aZIndex; // 降序排列，z-index高的在前
                });

            if (visibleModals.length > 0) {
                // 只关闭最顶层的模态框
                visibleModals[0].style.display = 'none';
            }
        }

        // 关闭指定模态框
        function closeSpecificModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // 返回主页
        function goHome() {
            window.location.href = '/DQEIndex';
        }

        // 显示历史版本
        function showHistoryVersions(sampleId) {
            showLoading();

            fetch(`/problemLibrary/getHistoryVersions?sampleId=${sampleId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderHistoryVersions(data.data);
                    document.getElementById('historyVersionsModal').style.display = 'block';
                } else {
                    alert('获取历史版本失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取历史版本时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 渲染历史版本表格
        function renderHistoryVersions(historyVersions) {
            const tbody = document.getElementById('historyVersionsTableBody');
            tbody.innerHTML = '';

            if (!historyVersions || historyVersions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center;">暂无历史版本</td>
                `;
                tbody.appendChild(row);
                return;
            }

            historyVersions.forEach(version => {
                const row = document.createElement('tr');
                const isLatest = version.history_id === Math.max(...historyVersions.map(v => v.history_id));
                const latestBadge = isLatest ? '<span class="badge badge-primary">最新</span>' : '';

                row.innerHTML = `
                    <td>${version.history_id} ${latestBadge}</td>
                    <td class="problem-desc">${(version.problem || '').substring(0, 50)}${(version.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${normalizeStatus(version.current_status)}</td>
                    <td>${version.modifier || version.tester || ''}</td>
                    <td>${version.modify_at ? new Date(version.modify_at).toLocaleString('zh-CN') : (version.created_at ? new Date(version.created_at).toLocaleString('zh-CN') : '')}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showProblemDetail(${version.id})">查看详情</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== 购物车/收藏夹功能 ====================

        // 加入收藏夹
        function addToCart() {
            if (filteredData.length === 0) {
                alert('没有数据可以加入收藏夹，请先进行搜索！');
                return;
            }

            // 获取当前筛选条件
            const filters = getCurrentFilters();
            const filterDescription = generateFilterDescription(filters);

            // 创建收藏夹项目
            const cartItem = {
                id: Date.now(), // 使用时间戳作为唯一ID
                filters: filters,
                data: [...filteredData], // 复制当前筛选结果
                dataCount: filteredData.length,
                filterDescription: filterDescription,
                saveTime: new Date().toLocaleString('zh-CN'),
                user: currentUser
            };

            // 添加到收藏夹
            cartItems.push(cartItem);

            // 保存到本地存储
            saveCartToStorage();

            // 更新收藏夹计数
            updateCartCount();

            alert(`已成功将 ${filteredData.length} 条数据加入收藏夹！`);
        }

        // 获取当前筛选条件
        function getCurrentFilters() {
            return {
                fullModel: document.getElementById('fullModelFilter').value,
                sampleStage: document.getElementById('sampleStageFilter').value,
                version: document.getElementById('versionFilter').value,
                bigSpecies: document.getElementById('bigSpeciesFilter').value,
                smallSpecies: document.getElementById('smallSpeciesFilter').value,
                problemCategory: document.getElementById('problemCategoryFilter').value,
                defectLevel: document.getElementById('defectLevelFilter').value,
                currentStatus: document.getElementById('currentStatusFilter').value,
                tester: document.getElementById('testerFilter').value,
                responsibleDepartment: document.getElementById('responsibleDepartmentFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value,
                dqe: document.getElementById('dqeFilter').value,
                problem: document.getElementById('problemFilter').value,
                testPlatform: document.getElementById('testPlatformFilter').value,
                testDevice: document.getElementById('testDeviceFilter').value,
                otherDevice: document.getElementById('otherDeviceFilter').value
            };
        }

        // 生成筛选条件描述
        function generateFilterDescription(filters) {
            const descriptions = [];

            if (filters.fullModel) descriptions.push(`完整编码: ${filters.fullModel}`);
            if (filters.sampleStage) descriptions.push(`样品阶段: ${filters.sampleStage}`);
            if (filters.version) descriptions.push(`版本: ${filters.version}`);
            if (filters.bigSpecies) descriptions.push(`大类: ${filters.bigSpecies}`);
            if (filters.smallSpecies) descriptions.push(`小类: ${filters.smallSpecies}`);
            if (filters.problemCategory) descriptions.push(`问题类别: ${filters.problemCategory}`);
            if (filters.defectLevel) descriptions.push(`缺陷等级: ${filters.defectLevel}`);
            if (filters.currentStatus) descriptions.push(`当前状态: ${filters.currentStatus}`);
            if (filters.tester) descriptions.push(`测试人员: ${filters.tester}`);
            if (filters.responsibleDepartment) descriptions.push(`责任部门: ${filters.responsibleDepartment}`);
            if (filters.startDate) descriptions.push(`开始时间: ${filters.startDate}`);
            if (filters.endDate) descriptions.push(`结束时间: ${filters.endDate}`);
            if (filters.dqe) descriptions.push(`DQE负责人: ${filters.dqe}`);
            if (filters.problem) descriptions.push(`问题描述: ${filters.problem}`);
            if (filters.testPlatform) descriptions.push(`测试平台: ${filters.testPlatform}`);
            if (filters.testDevice) descriptions.push(`显示设备: ${filters.testDevice}`);
            if (filters.otherDevice) descriptions.push(`其他设备: ${filters.otherDevice}`);

            return descriptions.length > 0 ? descriptions.join(', ') : '无条件筛选';
        }

        // 显示收藏夹模态框
        function showCartModal() {
            renderCartItems();
            document.getElementById('cartModal').style.display = 'block';
        }

        // 渲染收藏夹项目
        function renderCartItems() {
            const tbody = document.getElementById('cartItemsTableBody');
            tbody.innerHTML = '';

            if (cartItems.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" style="text-align: center; color: #666;">收藏夹为空</td>
                `;
                tbody.appendChild(row);
                return;
            }

            cartItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="filter-desc" title="${item.filterDescription}">${item.filterDescription.length > 50 ? item.filterDescription.substring(0, 50) + '...' : item.filterDescription}</td>
                    <td>${item.dataCount}</td>
                    <td>${item.saveTime}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewCartItem(${item.id})">查看</button>
                        <button class="btn btn-sm btn-danger" onclick="removeCartItem(${item.id})">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 查看收藏夹项目
        function viewCartItem(itemId) {
            const item = cartItems.find(i => i.id === itemId);
            if (!item) return;

            // 将收藏夹数据设置为当前筛选结果
            filteredData = [...item.data];
            currentPage = 1;
            updateStatistics();
            renderTable();

            // 关闭收藏夹模态框
            closeSpecificModal('cartModal');

            alert(`已加载收藏夹项目，共 ${item.dataCount} 条数据`);
        }

        // 删除收藏夹项目
        function removeCartItem(itemId) {
            if (confirm('确定要删除这个收藏夹项目吗？')) {
                cartItems = cartItems.filter(i => i.id !== itemId);
                saveCartToStorage();
                updateCartCount();
                renderCartItems();
            }
        }

        // 清空收藏夹
        function clearCart() {
            if (confirm('确定要清空整个收藏夹吗？此操作不可恢复！')) {
                cartItems = [];
                mergedData = [];
                saveCartToStorage();
                updateCartCount();
                renderCartItems();
                hideMergedData();
                alert('收藏夹已清空');
            }
        }

        // 合并收藏夹数据
        function mergeCartData() {
            if (cartItems.length === 0) {
                alert('收藏夹为空，无法合并数据！');
                return;
            }

            // 合并所有收藏夹项目的数据
            mergedData = [];
            const idSet = new Set(); // 用于去重

            cartItems.forEach(item => {
                item.data.forEach(problem => {
                    if (!idSet.has(problem.id)) {
                        idSet.add(problem.id);
                        mergedData.push(problem);
                    }
                });
            });

            // 显示合并数据
            showMergedData();
        }

        // 显示合并数据
        function showMergedData() {
            const section = document.getElementById('mergedDataSection');
            const totalCount = mergedData.length;
            const uniqueCount = mergedData.length; // 已经去重了

            document.getElementById('mergedTotalCount').textContent = totalCount;
            document.getElementById('mergedUniqueCount').textContent = uniqueCount;

            // 渲染合并数据表格
            renderMergedDataTable();

            section.style.display = 'block';
        }

        // 隐藏合并数据
        function hideMergedData() {
            document.getElementById('mergedDataSection').style.display = 'none';
        }

        // 渲染合并数据表格
        function renderMergedDataTable() {
            const tbody = document.getElementById('mergedDataTableBody');
            tbody.innerHTML = '';

            mergedData.forEach(problem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${problem.id}</td>
                    <td>${problem.full_model || ''}</td>
                    <td>${problem.big_species || ''}</td>
                    <td>${problem.small_species || ''}</td>
                    <td>${problem.sample_stage || ''}</td>
                    <td>${problem.version || ''}</td>
                    <td>${problem.test_platform || ''}</td>
                    <td>${problem.test_device || ''}</td>
                    <td>${problem.other_device || ''}</td>
                    <td class="problem-desc">${(problem.problem || '').substring(0, 50)}${(problem.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${problem.problemCategory || ''}</td>
                    <td>${problem.defect_level || ''}</td>
                    <td>${normalizeStatus(problem.current_status)}</td>
                    <td>${problem.tester || ''}</td>
                    <td>${problem.dqe_responsible || ''}</td>
                    <td>${problem.responsibleDepartment || ''}</td>
                    <td>${problem.dqe_reply || ''}</td>
                    <td>${problem.rd_reply || ''}</td>
                    <td>${problem.created_at ? problem.created_at.substring(0, 10) : ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 导出收藏夹数据
        function exportCartData() {
            if (cartItems.length === 0) {
                alert('收藏夹为空，无法导出数据！');
                return;
            }

            showLoading();

            // 直接复制合并显示的逻辑
            const exportMergedData = [];
            const idSet = new Set(); // 用于去重

            cartItems.forEach(item => {
                item.data.forEach(problem => {
                    if (!idSet.has(problem.id)) {
                        idSet.add(problem.id);
                        exportMergedData.push(problem);
                    }
                });
            });


            // 准备导出数据
            const exportData = {
                data: exportMergedData,
                exportType: 'cart',
                fileName: `收藏夹合并数据_${new Date().toISOString().slice(0, 10)}.xlsx`
            };

            fetch('/problemLibrary/exportCartsData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(exportData)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('导出失败');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportData.fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                alert(`成功导出收藏夹合并数据，共 ${exportMergedData.length} 条记录！`);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('导出时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 更新收藏夹计数
        function updateCartCount() {
            const countElement = document.getElementById('cartCount');
            if (countElement) {
                countElement.textContent = cartItems.length;
            }
        }

        // 保存收藏夹到本地存储
        function saveCartToStorage() {
            try {
                localStorage.setItem('problemLibraryCart', JSON.stringify(cartItems));
            } catch (e) {
                console.error('保存收藏夹失败:', e);
            }
        }

        // 从本地存储加载收藏夹
        function loadCartFromStorage() {
            try {
                const stored = localStorage.getItem('problemLibraryCart');
                if (stored) {
                    cartItems = JSON.parse(stored);
                }
            } catch (e) {
                console.error('加载收藏夹失败:', e);
                cartItems = [];
            }
        }
    </script>
</body>
</html>
