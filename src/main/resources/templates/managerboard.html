<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">æ•°æ®çœ‹æ¿</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 80px 20px 20px;
            background: #f5f5f5;
        }
        .BackBtn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
        }
        .BackBtn:hover { background: #0056b3; }

        /* é¡¹ç›®ä¸“å‘˜æ•°æ®çœ‹æ¿æŒ‰é’®æ ·å¼ */
        .specialist-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰è®¸æ¢¦ç‘¶æ‰èƒ½çœ‹åˆ° */
        }
        .specialist-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #333; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
        }
        .card-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            color: #333;
        }
        .card-description {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin-bottom: 25px;
            width: 100%;
            overflow-x: hidden;
        }
        .chart-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        /* çŠ¶æ€é¢œè‰² */
        .status-not-started { color: #ffc107; }
        .status-in-progress { color: #17a2b8; }
        .status-completed { color: #a72828; }
        .status-overdue { color: #28a745; }
        .status-total { color: #6c757d; }

        /* æ—¶é—´è¿‡æ»¤å™¨æ ·å¼ */
        .time-filter-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-group label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .filter-group .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .filter-separator {
            color: #666;
            font-weight: bold;
        }

        .filter-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .filter-btn:hover {
            background: #0056b3;
        }

        .filter-btn:active {
            transform: translateY(1px);
        }

        /* é¡¹ç›®è¯¦æƒ…è¡¨æ ¼æ ·å¼ */
        .project-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
            min-width: 100%;
        }
        .project-table th, .project-table td {
            border: 1px solid #ddd;
            padding: 8px 6px;
            text-align: left;
            font-size: 12px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .project-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .project-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .project-table tr:hover {
            background-color: #f0f0f0;
        }

        /* ä¸ºä¸åŒåˆ—è®¾ç½®åˆé€‚çš„å®½åº¦ */
        .project-table th:nth-child(1), .project-table td:nth-child(1) { width: 8%; } /* æ ·å“ç¼–å· */
        .project-table th:nth-child(2), .project-table td:nth-child(2) { width: 10%; } /* äº§å“åç§° */
        .project-table th:nth-child(3), .project-table td:nth-child(3) { width: 6%; } /* äº§å“ç±»åˆ« */
        .project-table th:nth-child(4), .project-table td:nth-child(4) { width: 8%; } /* å¤§ç¼–ç  */
        .project-table th:nth-child(5), .project-table td:nth-child(5) { width: 8%; } /* ç‰©æ–™ç¼–ç  */
        .project-table th:nth-child(6), .project-table td:nth-child(6) { width: 4%; } /* ç‰ˆæœ¬ */
        .project-table th:nth-child(7), .project-table td:nth-child(7) { width: 6%; } /* é¡¹ç›®è´Ÿè´£äºº */
        .project-table th:nth-child(8), .project-table td:nth-child(8) { width: 6%; } /* å½“å‰è¿›åº¦ */
        .project-table th:nth-child(9), .project-table td:nth-child(9) { width: 6%; } /* æµ‹è¯•è´Ÿè´£äºº */
        .project-table th:nth-child(10), .project-table td:nth-child(10) { width: 6%; } /* DQEè´Ÿè´£äºº */
        .project-table th:nth-child(11), .project-table td:nth-child(11) { width: 6%; } /* ç ”å‘è´Ÿè´£äºº */
        .project-table th:nth-child(12), .project-table td:nth-child(12) { width: 5%; } /* é€æ ·äºº */
        .project-table th:nth-child(13), .project-table td:nth-child(13) { width: 5%; } /* é€æ ·ç±»åˆ« */
        .project-table th:nth-child(14), .project-table td:nth-child(14) { width: 4%; } /* é€æ ·æ•°é‡ */
        .project-table th:nth-child(15), .project-table td:nth-child(15) { width: 4%; } /* æ˜¯å¦é«˜é¢‘ */
        .project-table th:nth-child(16), .project-table td:nth-child(16) { width: 6%; } /* æå•æ—¶é—´ */
        .project-table th:nth-child(17), .project-table td:nth-child(17) { width: 4%; } /* æ’æœŸå¤©æ•° */
        .project-table th:nth-child(18), .project-table td:nth-child(18) { width: 6%; } /* æ’æœŸå¼€å§‹ */
        .project-table th:nth-child(19), .project-table td:nth-child(19) { width: 6%; } /* æ’æœŸç»“æŸ */
        .project-table th:nth-child(20), .project-table td:nth-child(20) { width: 6%; } /* å®é™…å¼€å§‹æ—¶é—´ */
        .project-table th:nth-child(21), .project-table td:nth-child(21) { width: 6%; } /* å®é™…å®Œæˆæ—¶é—´ */
        .project-table th:nth-child(22), .project-table td:nth-child(22) { width: 6%; } /* DQEæ‰¿è®¤ç»“æœ */
        .project-table th:nth-child(23), .project-table td:nth-child(23) { width: 6%; } /* ç ”å‘æ‰¿è®¤ç»“æœ */

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 95%;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }

        /* æœç´¢å’Œç­›é€‰æ ·å¼ */
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn:hover {
            background: #0056b3;
        }

        /* è§†å›¾æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .view-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .view-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .view-btn.active {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        .view-btn.active:hover {
            background: #218838;
        }

        /* å¯¹æ¯”åˆ†ææŒ‰é’®æ ·å¼ */
        .comparison-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .comparison-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .comparison-btn.active {
            background: #fd7e14;
            box-shadow: 0 2px 4px rgba(253, 126, 20, 0.3);
        }

        .comparison-btn.active:hover {
            background: #e8650e;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .card {
                padding: 20px;
            }
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* æ”¾å¤§ç¼©å°æŒ‰é’®æ ·å¼ */
        .zoom-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }
        .chart-nav-item:hover {
            background: #e9ecef !important;
            border-color: #007bff !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .zoom-btn:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }
    </style>
</head>
<body>
<button class="BackBtn" onclick="location.href='/DQEIndex'">è¿”å›<br>ä¸»é¡µ</button>
<!-- å°è´¦å±•ç¤ºæŒ‰é’® -->
<button onclick="showLedgerModal()" style="position: fixed; top: 20px; right: 200px; padding: 15px 25px; background-color: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1000; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#138496'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';" onmouseout="this.style.backgroundColor='#17a2b8'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';">
    ğŸ“Š å°è´¦å±•ç¤º
</button>
<button class="specialist-btn" id="specialistBtn" onclick="showSpecialistDashboard()">é¡¹ç›®ä¸“å‘˜<br>æ•°æ®çœ‹æ¿</button>

<div class="container">
    <div class="header">
        <h1 id="dashboardTitle">æ•°æ®çœ‹æ¿</h1>
        <p>ç ”å‘è´¨é‡ç®¡ç†ç³»ç»Ÿ - ç”µæ°”æµ‹è¯•é¡¹ç›®æ•°æ®å±•ç¤º</p>

        <!-- æå•æ—¶é—´è¿‡æ»¤å™¨ -->
        <div class="time-filter-container">
            <div class="filter-group">
                <label for="createTimeStart">æå•æ—¶é—´å¼€å§‹ï¼š</label>
                <input type="date" id="createTimeStart" class="filter-input">
                <span class="filter-separator">è‡³</span>
                <label for="createTimeEnd">ç»“æŸï¼š</label>
                <input type="date" id="createTimeEnd" class="filter-input">
                <button class="filter-btn" onclick="applyTimeFilter()">åº”ç”¨ç­›é€‰</button>
                <button class="filter-btn" onclick="resetTimeFilter()">é‡ç½®ç­›é€‰</button>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card" onclick="showProjectDetails('total')">
            <div class="card-value status-total" id="totalCount">0</div>
            <div class="card-title">é¡¹ç›®æ€»æ•°</div>
            <div class="card-description">æ‰€æœ‰ç”µæ°”æµ‹è¯•é¡¹ç›®</div>
        </div>
        <div class="card" onclick="showProjectDetails('not-started')">
            <div class="card-value status-not-started" id="notStartedCount">0</div>
            <div class="card-title">æœªå¼€å§‹é¡¹ç›®</div>
            <div class="card-description">ç­‰å¾…å¼€å§‹æµ‹è¯•çš„é¡¹ç›®</div>
        </div>
        <div class="card" onclick="showProjectDetails('in-progress')">
            <div class="card-value status-in-progress" id="inProgressCount">0</div>
            <div class="card-title">è¿›è¡Œä¸­é¡¹ç›®</div>
            <div class="card-description">æ­£åœ¨æµ‹è¯•ä¸­çš„é¡¹ç›®</div>
        </div>
        <div class="card" onclick="showProjectDetails('completed')">
            <div class="card-value status-completed" id="completedCount">0</div>
            <div class="card-title">å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®</div>
            <div class="card-description">æµ‹è¯•å®Œæˆä½†æœªç­¾æ ·</div>
        </div>
        <div class="card" onclick="showProjectDetails('overdue')">
            <div class="card-value status-overdue" id="closedCount">0</div>
            <div class="card-title">å·²ç¡®è®¤é¡¹ç›®</div>
            <div class="card-description">æŠ¥å‘Šå®Œæˆå·²ç¡®è®¤ç»“æœçš„é¡¹ç›®</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">é¡¹ç›®è¿›åº¦æ¦‚è§ˆ</div>
        <div class="filter-section">
            <input type="text" class="filter-input" id="searchInput" placeholder="æœç´¢æ ·å“ç¼–å·æˆ–äº§å“åç§°...">
            <select class="filter-input" id="categoryFilter">
                <option value="">æ‰€æœ‰ç±»åˆ«</option>
            </select>
            <select class="filter-input" id="statusFilter">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="æœªå¼€å§‹">æœªå¼€å§‹</option>
                <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                <option value="å·²å®Œæˆæœªç¡®è®¤">å·²å®Œæˆæœªç¡®è®¤</option>
                <option value="å·²ç¡®è®¤">å·²ç¡®è®¤</option>
            </select>

            <button class="filter-btn" onclick="applyFilters()">ç­›é€‰</button>
            <button class="filter-btn" onclick="resetFilters()">é‡ç½®</button>
        </div>
        <div id="projectTableContainer">
            <!-- é¡¹ç›®è¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="projectModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeProjectModal()">&times;</span>
        <h2 id="modalTitle">é¡¹ç›®è¯¦æƒ…</h2>
        <div id="modalContent">
            <!-- æ¨¡æ€æ¡†å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<script>
    function getParams() {
        let query = window.location.search;

        return new URLSearchParams(query);
    }

    let projectData = [];
    let filteredData = [];
    let originalProjectData = []; // ä¿å­˜åŸå§‹æ•°æ®

    // é¡¹ç›®ä¸“å‘˜æ•°æ®çœ‹æ¿ä¸“ç”¨æ•°æ®
    let specialistProjectData = []; // å­˜å‚¨æ‰€æœ‰é¡¹ç›®æ•°æ®ç”¨äºç»Ÿè®¡
    let originalSpecialistProjectData = []; // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºç­›é€‰
    let filteredSpecialistProjectData = []; // ç­›é€‰åçš„æ•°æ®

    // æ ¹æ®jobå‚æ•°è®¾ç½®é¡µé¢æ ‡é¢˜å’Œè§’è‰²ä¿¡æ¯
    function initializeRoleBasedContent() {
        const urlParams = new URLSearchParams(window.location.search);
        const job = urlParams.get('job') || 'manager';

        const roleConfig = {
            'DQE': {
                title: 'DQEæ•°æ®çœ‹æ¿',
                dashboardTitle: 'DQEæ•°æ®çœ‹æ¿'
            },
            'rd': {
                title: 'ç ”å‘æ•°æ®çœ‹æ¿',
                dashboardTitle: 'ç ”å‘æ•°æ®çœ‹æ¿'
            },
            'manager': {
                title: 'ç®¡ç†æ•°æ®çœ‹æ¿',
                dashboardTitle: 'ä¸»ç®¡çº§åˆ«ä»¥ä¸Šæ•°æ®çœ‹æ¿'
            },
            'tester': {
                title: 'æµ‹è¯•äººå‘˜æ•°æ®çœ‹æ¿',
                dashboardTitle: 'æµ‹è¯•äººå‘˜æ•°æ®çœ‹æ¿'
            }
        };

        const config = roleConfig[job] || roleConfig['manager'];

        // è®¾ç½®é¡µé¢æ ‡é¢˜
        document.getElementById('pageTitle').textContent = config.title;
        document.getElementById('dashboardTitle').textContent = config.dashboardTitle;
        
        // å¦‚æœæ˜¯testerè§’è‰²ï¼Œéšè—è¿”å›ä¸»é¡µæŒ‰é’®
        if (job === 'tester') {
            const backBtn = document.querySelector('.BackBtn');
            if (backBtn) {
                backBtn.style.display = 'none';
            }
        }

        // å­˜å‚¨å½“å‰è§’è‰²ä¿¡æ¯ï¼Œä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨
        window.currentRole = job;
    }

    // é¡µé¢åŠ è½½å®Œæˆåè·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        initializeRoleBasedContent();
        loadProjectData();
    });

    // åŠ è½½é¡¹ç›®æ•°æ®
    function loadProjectData() {
        const urlParams = getParams();
        let username = urlParams.get('username');
        let job = urlParams.get('job');

        if (!username) {
            alert('è¯·å…ˆè¾“å…¥ç”¨æˆ·åï¼');
            return;
        }

        localStorage.setItem("username",username);
        localStorage.setItem("job",job);

        // æ£€æŸ¥æ˜¯å¦ä¸ºè®¸æ¢¦ç‘¶ï¼Œæ˜¾ç¤ºä¸“å±æŒ‰é’®
        if (username === 'è®¸æ¢¦ç‘¶' || username === 'å¢å¥' || username === 'æè‰¯å¥' || username === 'é»„å®¶ç¿' ||
        username === 'è£æˆå½§') {
            document.getElementById('specialistBtn').style.display = 'block';
        }

        // è°ƒç”¨DQEä¸ªäººæ•°æ®æ¥å£
        fetch(`/DQEIndex/getElectricProjectData?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    originalProjectData = data.data; // ä¿å­˜åŸå§‹æ•°æ®
                    projectData = [...originalProjectData];
                    filteredData = [...originalProjectData];

                    // è°ƒè¯•ï¼šæ£€æŸ¥APIè¿”å›çš„æ•°æ®ç»“æ„
                    console.log('APIè¿”å›çš„åŸå§‹æ•°æ®:', data);
                    if (data.data && data.data.length > 0) {
                        console.log('ç¬¬ä¸€ä¸ªé¡¹ç›®æ•°æ®:', data.data[0]);
                        console.log('å¤§ç¼–ç å­—æ®µ:', data.data[0].sample_model);
                        console.log('ç‰ˆæœ¬å­—æ®µ:', data.data[0].version);
                        console.log('æ‰€æœ‰å­—æ®µ:', Object.keys(data.data[0]));
                    }

                    updateDashboard();
                    updateProjectTable();
                    updateCategoryFilter();
                } else {
                    console.error('è·å–DQEä¸ªäººæ•°æ®å¤±è´¥:', data.error);
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    loadMockData();
                }
            })
            .catch(error => {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                loadMockData();
            });
    }

    // åŠ è½½æ¨¡æ‹Ÿæ•°æ®ï¼ˆå½“APIä¸å¯ç”¨æ—¶ï¼‰
    function loadMockData() {
        filteredData = [...projectData];
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // æ˜¾ç¤ºé¡¹ç›®ä¸“å‘˜æ•°æ®çœ‹æ¿
    function showSpecialistDashboard() {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'specialistModal';
        modal.style.display = 'block';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 95vw; width: 95vw; height: 95vh; max-height: 95vh; padding: 0; border-radius: 20px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none; flex-shrink: 0;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">ğŸ“Š</span>
                        é¡¹ç›®ä¸“å‘˜æ•°æ®çœ‹æ¿
                    </h3>
                    <span class="close" onclick="closeSpecialistModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
                </div>
                <div style="display: flex; height: calc(100% - 80px); overflow: hidden;">
                    <!-- å·¦ä¾§å¯¼èˆªæ  -->
                    <div id="specialistSidebar" style="width: 280px; background: #f8f9fa; border-right: 2px solid #e9ecef; overflow-y: auto; flex-shrink: 0;">
                        <div style="padding: 20px;">
                            <h4 style="color: #333; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ“ˆ æ•°æ®å›¾è¡¨</h4>
                            <div id="specialistMenuItems" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
                    <div id="specialistContent" style="flex: 1; padding: 30px; overflow-y: auto; background: #ffffff;">
                        <!-- æ¥å•æ—¶é—´ç­›é€‰å™¨ -->
                        <div id="specialistFilterContainer" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                <span>ğŸ”</span>
                                æ¥å•æ—¶é—´ç­›é€‰
                            </h4>
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-weight: 500; color: #555; white-space: nowrap;">å¼€å§‹æ—¶é—´:</label>
                                    <input type="date" id="specialistOrderTimeStart" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-weight: 500; color: #555; white-space: nowrap;">ç»“æŸæ—¶é—´:</label>
                                    <input type="date" id="specialistOrderTimeEnd" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="applySpecialistOrderTimeFilter()" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        åº”ç”¨ç­›é€‰
                                    </button>
                                    <button onclick="resetSpecialistOrderTimeFilter()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(108, 117, 125, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        é‡ç½®ç­›é€‰
                                    </button>
                                </div>
                                <div style="margin-left: auto; color: #666; font-size: 13px;">
                                    <span id="specialistFilterStatus">æ˜¾ç¤ºå…¨éƒ¨æ•°æ®</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="specialistChartContainer" style="width: 100%; height: calc(100% - 120px); background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                            <div style="text-align: center; padding: 50px; color: #666;">
                                <div style="font-size: 18px; margin-bottom: 20px;">è¯·é€‰æ‹©å·¦ä¾§èœå•æŸ¥çœ‹æ•°æ®å›¾è¡¨</div>
                                <div style="font-size: 14px; color: #999;">ç‚¹å‡»å·¦ä¾§èœå•é¡¹å¼€å§‹æµè§ˆæ•°æ®</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // åˆå§‹åŒ–å¯¼èˆªèœå•
        initSpecialistMenu();

        // åŠ è½½æ‰€æœ‰é¡¹ç›®æ•°æ®
        loadAllProjectData();
    }

    // å…³é—­é¡¹ç›®ä¸“å‘˜æ•°æ®çœ‹æ¿æ¨¡æ€æ¡†
    function closeSpecialistModal() {
        const modal = document.getElementById('specialistModal');
        if (modal) {
            modal.remove();
        }
    }

    // åŠ è½½æ‰€æœ‰é¡¹ç›®æ•°æ®
    function loadAllProjectData() {
        fetch('/DQEIndex/getElectricProjectData')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    originalSpecialistProjectData = data.data; // ä¿å­˜åŸå§‹æ•°æ®
                    specialistProjectData = [...originalSpecialistProjectData];
                    filteredSpecialistProjectData = [...originalSpecialistProjectData];
                    console.log('é¡¹ç›®ä¸“å‘˜æ•°æ®çœ‹æ¿åŠ è½½äº†', specialistProjectData.length, 'ä¸ªé¡¹ç›®æ•°æ®');

                    // æ•°æ®åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨ç‚¹å‡»ç¬¬ä¸€ä¸ªèœå•é¡¹
                    autoClickFirstMenuItem();
                } else {
                    console.error('è·å–é¡¹ç›®æ•°æ®å¤±è´¥:', data.error);
                    specialistProjectData = [];
                    originalSpecialistProjectData = [];
                    filteredSpecialistProjectData = [];
                }
            })
            .catch(error => {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                specialistProjectData = [];
                originalSpecialistProjectData = [];
                filteredSpecialistProjectData = [];
            });
    }

    // è‡ªåŠ¨ç‚¹å‡»ç¬¬ä¸€ä¸ªèœå•é¡¹
    function autoClickFirstMenuItem() {
        const firstMenuItem = document.getElementById('menu-schedule-distribution');
        if (firstMenuItem) {
            firstMenuItem.click();
        }
    }

    // åº”ç”¨æ¥å•æ—¶é—´ç­›é€‰
    function applySpecialistOrderTimeFilter() {
        const startDate = document.getElementById('specialistOrderTimeStart').value;
        const endDate = document.getElementById('specialistOrderTimeEnd').value;

        if (!startDate && !endDate) {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            specialistProjectData = [...originalSpecialistProjectData];
            filteredSpecialistProjectData = [...originalSpecialistProjectData];
            updateSpecialistFilterStatus('æ˜¾ç¤ºå…¨éƒ¨æ•°æ®');
        } else {
            // ç­›é€‰æ•°æ®
            const filtered = originalSpecialistProjectData.filter(project => {
                if (!project.create_time) return false;

                const createDate = new Date(project.create_time);
                let matchesStart = true;
                let matchesEnd = true;

                if (startDate) {
                    const start = new Date(startDate);
                    matchesStart = createDate >= start;
                }

                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999); // ç»“æŸæ—¥æœŸè®¾ä¸ºå½“å¤©çš„æœ€åä¸€ç§’
                    matchesEnd = createDate <= end;
                }

                return matchesStart && matchesEnd;
            });

            specialistProjectData = [...filtered];
            filteredSpecialistProjectData = [...filtered];
            
            const statusText = startDate && endDate 
                ? `ç­›é€‰æ—¶é—´èŒƒå›´: ${startDate} è‡³ ${endDate} (${filtered.length}æ¡æ•°æ®)`
                : startDate 
                ? `ç­›é€‰å¼€å§‹æ—¶é—´: ${startDate} ä¹‹å (${filtered.length}æ¡æ•°æ®)`
                : `ç­›é€‰ç»“æŸæ—¶é—´: ${endDate} ä¹‹å‰ (${filtered.length}æ¡æ•°æ®)`;
            updateSpecialistFilterStatus(statusText);
        }

        // é‡æ–°åŠ è½½å½“å‰å›¾è¡¨
        refreshCurrentSpecialistChart();
    }

    // é‡ç½®æ¥å•æ—¶é—´ç­›é€‰
    function resetSpecialistOrderTimeFilter() {
        document.getElementById('specialistOrderTimeStart').value = '';
        document.getElementById('specialistOrderTimeEnd').value = '';
        
        specialistProjectData = [...originalSpecialistProjectData];
        filteredSpecialistProjectData = [...originalSpecialistProjectData];
        updateSpecialistFilterStatus('æ˜¾ç¤ºå…¨éƒ¨æ•°æ®');
        
        // é‡æ–°åŠ è½½å½“å‰å›¾è¡¨
        refreshCurrentSpecialistChart();
    }

    // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
    function updateSpecialistFilterStatus(status) {
        const statusElement = document.getElementById('specialistFilterStatus');
        if (statusElement) {
            statusElement.textContent = status;
        }
    }

    // åˆ·æ–°å½“å‰å›¾è¡¨
    function refreshCurrentSpecialistChart() {
        // è·å–å½“å‰æ¿€æ´»çš„èœå•é¡¹
        const activeMenuItem = document.querySelector('.specialist-menu-item[style*="background: linear-gradient"]');
        if (activeMenuItem) {
            const menuId = activeMenuItem.id.replace('menu-', '');
            const menuItems = [
                { id: 'schedule-distribution', action: 'loadScheduleDistributionData' },
                { id: 'schedule-days-distribution', action: 'loadScheduleDaysDistributionData' },
                { id: 'project-status', action: 'loadProjectStatusData' },
                { id: 'category-distribution', action: 'loadCategoryDistributionData' },
                { id: 'priority-distribution', action: 'loadPriorityDistributionData' },
                { id: 'tester-distribution', action: 'loadTesterDistributionData' },
                { id: 'monthly-trend', action: 'loadMonthlyTrendData' }
            ];
            
            const menuItem = menuItems.find(item => item.id === menuId);
            if (menuItem && window[menuItem.action]) {
                window[menuItem.action]();
            }
        }
    }

    // åˆå§‹åŒ–é¡¹ç›®ä¸“å‘˜å¯¼èˆªèœå•
    function initSpecialistMenu() {
        const menuItems = [
            {
                id: 'schedule-distribution',
                title: 'æ’æœŸæ—¶é—´åˆ†å¸ƒ',
                icon: 'ğŸ“…',
                description: 'æŸ¥çœ‹é¡¹ç›®æ’æœŸæ—¶é—´å®Œæ•´æ€§åˆ†å¸ƒ',
                action: 'loadScheduleDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'schedule-days-distribution',
                title: 'æ’æœŸå¤©æ•°åˆ†å¸ƒ',
                icon: 'ğŸ“†',
                description: 'æŸ¥çœ‹é¡¹ç›®æ’æœŸå¤©æ•°åˆ†å¸ƒæƒ…å†µ',
                action: 'loadScheduleDaysDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'project-status',
                title: 'é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ',
                icon: 'ğŸ“Š',
                description: 'æŸ¥çœ‹é¡¹ç›®å½“å‰çŠ¶æ€åˆ†å¸ƒæƒ…å†µ',
                action: 'loadProjectStatusData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'category-distribution',
                title: 'æ ·å“ç±»åˆ«åˆ†å¸ƒ',
                icon: 'ğŸ·ï¸',
                description: 'æŸ¥çœ‹ä¸åŒæ ·å“ç±»åˆ«çš„é¡¹ç›®åˆ†å¸ƒ',
                action: 'loadCategoryDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'priority-distribution',
                title: 'ä¼˜å…ˆçº§åˆ†å¸ƒ',
                icon: 'â­',
                description: 'æŸ¥çœ‹é¡¹ç›®ä¼˜å…ˆçº§åˆ†å¸ƒæƒ…å†µ',
                action: 'loadPriorityDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'tester-distribution',
                title: 'æµ‹è¯•å‘˜åˆ†å¸ƒ',
                icon: 'ğŸ‘¨â€ğŸ’»',
                description: 'æŸ¥çœ‹æµ‹è¯•å‘˜è´Ÿè´£é¡¹ç›®åˆ†å¸ƒ',
                action: 'loadTesterDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'monthly-trend',
                title: 'æœˆåº¦è¶‹åŠ¿',
                icon: 'ğŸ“ˆ',
                description: 'æŸ¥çœ‹é¡¹ç›®åˆ›å»ºæœˆåº¦è¶‹åŠ¿',
                action: 'loadMonthlyTrendData',
                hasMonthlyAnalysis: false
            }
        ];

        const menuContainer = document.getElementById('specialistMenuItems');
        menuContainer.innerHTML = '';

        menuItems.forEach((item, index) => {
            const menuItem = document.createElement('div');
            menuItem.className = 'specialist-menu-item';
            menuItem.id = `menu-${item.id}`;
            menuItem.style.cssText = `
                padding: 15px 20px;
                background: white;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 8px;
            `;

            menuItem.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 20px;">${item.icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 4px;">${item.title}</div>
                        <div style="font-size: 12px; color: #666; line-height: 1.3;">${item.description}</div>
                        ${item.hasMonthlyAnalysis ? '<div style="font-size: 10px; color: #667eea; margin-top: 2px;">ğŸ“Š æ”¯æŒæœˆåº¦åˆ†æ</div>' : ''}
                    </div>
                </div>
            `;

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            menuItem.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
                this.style.borderColor = '#667eea';
                this.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.2)';
            });

            menuItem.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
                this.style.borderColor = 'transparent';
                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            });

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            menuItem.addEventListener('click', function() {
                // ç§»é™¤å…¶ä»–èœå•é¡¹çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.specialist-menu-item').forEach(item => {
                    item.style.background = 'white';
                    item.style.borderColor = 'transparent';
                });

                // è®¾ç½®å½“å‰èœå•é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
                this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                this.style.borderColor = '#667eea';
                this.style.color = 'white';

                // æ‰§è¡Œå¯¹åº”çš„æ•°æ®åŠ è½½å‡½æ•°
                window[item.action]();
            });

            menuContainer.appendChild(menuItem);
        });
    }

    // åŠ è½½æ’æœŸæ—¶é—´åˆ†å¸ƒæ•°æ®
    function loadScheduleDistributionData() {
        showSpecialistLoading('æ’æœŸæ—¶é—´åˆ†å¸ƒ');

        if (specialistProjectData.length === 0) {
            showSpecialistError('æ’æœŸæ—¶é—´åˆ†å¸ƒ', 'é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        // åŸºäºç­›é€‰åçš„é¡¹ç›®æ•°æ®è®¡ç®—æ’æœŸæ—¶é—´åˆ†å¸ƒ
        const distribution = calculateScheduleDistribution(specialistProjectData);
        renderSpecialistChart('æ’æœŸæ—¶é—´åˆ†å¸ƒ', distribution, 'schedule');
    }

    // åŠ è½½æ’æœŸå¤©æ•°åˆ†å¸ƒæ•°æ®
    function loadScheduleDaysDistributionData() {
        showSpecialistLoading('æ’æœŸå¤©æ•°åˆ†å¸ƒ');

        if (specialistProjectData.length === 0) {
            showSpecialistError('æ’æœŸå¤©æ•°åˆ†å¸ƒ', 'é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        // åŸºäºç­›é€‰åçš„é¡¹ç›®æ•°æ®è®¡ç®—æ’æœŸå¤©æ•°åˆ†å¸ƒ
        const distribution = calculateScheduleDaysDistribution(specialistProjectData);
        renderSpecialistChart('æ’æœŸå¼€å§‹æ—¶é—´æœˆä»½åˆ†å¸ƒ', distribution, 'scheduleDays');
    }

    // è®¡ç®—æ’æœŸæ—¶é—´åˆ†å¸ƒ
    function calculateScheduleDistribution(projects) {
        const distribution = {
            '1å¤©å†…å¼€å§‹æ’æœŸ': 0,
            '2-3å¤©å¼€å§‹æ’æœŸ': 0,
            '4-7å¤©å¼€å§‹æ’æœŸ': 0,
            '8-15å¤©å¼€å§‹æ’æœŸ': 0,
            '16-30å¤©å¼€å§‹æ’æœŸ': 0,
            '30å¤©ä»¥ä¸Šå¼€å§‹æ’æœŸ': 0,
            'æ— ç¬¬ä¸€æ¬¡æ’æœŸæ—¶é—´': 0
        };

        projects.forEach(project => {
            const category = calculateScheduleCategory(project);
            if (distribution.hasOwnProperty(category)) {
                distribution[category]++;
            }
        });

        return distribution;
    }

    // è®¡ç®—æ’æœŸå¼€å§‹æ—¶é—´æœˆä»½åˆ†å¸ƒ
    function calculateScheduleDaysDistribution(projects) {
        const distribution = {};

        projects.forEach(project => {
            const scheduleStartDate = project.schedule_start_date;

            if (scheduleStartDate && scheduleStartDate !== '-') {
                try {
                    const date = new Date(scheduleStartDate);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const monthKey = `${year}å¹´${month}æœˆ`;
                    distribution[monthKey] = (distribution[monthKey] || 0) + 1;
                } catch (e) {
                    // æ—¥æœŸè§£æå¤±è´¥
                    distribution['æ—¥æœŸè§£æé”™è¯¯'] = (distribution['æ—¥æœŸè§£æé”™è¯¯'] || 0) + 1;
                }
            } else {
                // æ²¡æœ‰æ’æœŸå¼€å§‹æ—¶é—´
                distribution['æœªè®¾ç½®æ’æœŸå¼€å§‹æ—¶é—´'] = (distribution['æœªè®¾ç½®æ’æœŸå¼€å§‹æ—¶é—´'] || 0) + 1;
            }
        });

        // å¯¹æœˆä»½è¿›è¡Œæ’åºï¼Œç¡®ä¿å›¾è¡¨æ˜¾ç¤ºæœ‰åº
        const sortedEntries = Object.entries(distribution).sort(([a], [b]) => {
            if (a === 'æœªè®¾ç½®æ’æœŸå¼€å§‹æ—¶é—´') return 1;
            if (b === 'æœªè®¾ç½®æ’æœŸå¼€å§‹æ—¶é—´') return -1;
            if (a === 'æ—¥æœŸè§£æé”™è¯¯') return 1;
            if (b === 'æ—¥æœŸè§£æé”™è¯¯') return -1;

            // æå–å¹´ä»½å’Œæœˆä»½è¿›è¡Œæ¯”è¾ƒ
            const aMatch = a.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
            const bMatch = b.match(/(\d{4})å¹´(\d{1,2})æœˆ/);

            if (!aMatch) return 1;
            if (!bMatch) return -1;

            const aYear = parseInt(aMatch[1]);
            const aMonth = parseInt(aMatch[2]);
            const bYear = parseInt(bMatch[1]);
            const bMonth = parseInt(bMatch[2]);

            if (aYear !== bYear) {
                return aYear - bYear;
            }
            return aMonth - bMonth;
        });

        return Object.fromEntries(sortedEntries);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showSpecialistLoading(chartTitle) {
        const container = document.getElementById('specialistChartContainer');
        container.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #666;">
                <div style="font-size: 18px; margin-bottom: 20px;">æ­£åœ¨åŠ è½½${chartTitle}æ•°æ®...</div>
                <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        `;
    }

    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    function showSpecialistError(chartTitle, errorMessage) {
        const container = document.getElementById('specialistChartContainer');
        container.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #dc3545;">
                <div style="font-size: 18px; margin-bottom: 10px;">${chartTitle}æ•°æ®åŠ è½½å¤±è´¥</div>
                <div style="font-size: 14px; margin-bottom: 20px;">${errorMessage}</div>
                <button onclick="loadScheduleDistributionData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é‡æ–°åŠ è½½</button>
            </div>
        `;
    }

    // é€šç”¨å›¾è¡¨æ¸²æŸ“å‡½æ•°
    function renderSpecialistChart(title, data, chartType) {
        const container = document.getElementById('specialistChartContainer');

        if (!data || Object.keys(data).length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">æš‚æ— ${title}æ•°æ®</div>
                    <div style="font-size: 14px;">å½“å‰æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç›¸å…³æ•°æ®</div>
                </div>
            `;
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æ”¯æŒæœˆåº¦åˆ†æ
        const supportsMonthlyAnalysis = ['schedule', 'scheduleDays', 'status', 'category', 'priority', 'tester'].includes(chartType);

        // åˆ›å»ºå›¾è¡¨HTML
        const chartHTML = `
            <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px; flex-shrink: 0;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">${title}ç»Ÿè®¡</h4>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        ${supportsMonthlyAnalysis ? `
                            <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <button onclick="showTrendAnalysis('${chartType}')" title="è¶‹åŠ¿åˆ†æ" style="background: #4ecdc4; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</button>
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <button onclick="refreshSpecialistChart('${chartType}')" title="åˆ·æ–°å›¾è¡¨" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ”„</button>
                            <button onclick="exportSpecialistData('${chartType}')" title="å¯¼å‡ºæ•°æ®" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“Š</button>
                        </div>
                    </div>
                </div>
                <div id="specialistChart" style="flex: 1; min-height: 400px; overflow-y: auto;">
                    ${createSpecialistChart(data, chartType)}
                </div>
            </div>
        `;

        container.innerHTML = chartHTML;
    }

    // é€šç”¨å›¾è¡¨åˆ›å»ºå‡½æ•°
    function createSpecialistChart(data, chartType) {
        const categories = Object.keys(data);
        const values = Object.values(data);

        if (categories.length === 0) {
            return '<div style="text-align: center; color: #666; font-size: 16px;">æš‚æ— æ•°æ®</div>';
        }

        // è®¡ç®—æœ€å¤§å€¼å’Œé¢œè‰²
        const maxValue = Math.max(...values);
        const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'];

        let chartHTML = '<div style="display: flex; flex-direction: column; gap: 10px; width: 100%; padding: 5px;">';

        categories.forEach((category, index) => {
            const value = values[index];
            const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
            const color = colors[index % colors.length];

            chartHTML += `
                <div onclick="showSpecialistDetails('${category}', '${chartType}')" style="display: flex; align-items: center; gap: 12px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; flex-shrink: 0;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.borderColor='${color}'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.1)'; this.style.borderColor='transparent'">
                    <div style="min-width: 100px; font-weight: 600; color: #333; font-size: 13px; word-break: break-word; line-height: 1.3;">${category}</div>
                    <div style="flex: 1; position: relative; min-width: 0;">
                        <div style="background: #f0f0f0; height: 24px; border-radius: 12px; overflow: hidden; position: relative;">
                            <div style="background: linear-gradient(90deg, ${color} 0%, ${color}dd 100%); height: 100%; width: ${percentage}%; border-radius: 12px; transition: width 0.8s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${value}
                            </div>
                        </div>
                    </div>
                    <div style="min-width: 50px; text-align: right; font-weight: bold; color: #333; font-size: 14px;">${value}</div>
                    <div style="min-width: 16px; text-align: center; color: #666; font-size: 12px;">ğŸ‘†</div>
                </div>
            `;
        });

        chartHTML += '</div>';

        return chartHTML;
    }

    // å…¶ä»–æ•°æ®åŠ è½½å‡½æ•°
    function loadProjectStatusData() {
        showSpecialistLoading('é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ');

        if (specialistProjectData.length === 0) {
            showSpecialistError('é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ', 'é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        // åŸºäºç­›é€‰åçš„é¡¹ç›®æ•°æ®è®¡ç®—é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ
        const distribution = calculateProjectStatusDistribution(specialistProjectData);
        renderSpecialistChart('é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ', distribution, 'status');
    }

    function loadCategoryDistributionData() {
        showSpecialistLoading('æ ·å“ç±»åˆ«åˆ†å¸ƒ');

        if (specialistProjectData.length === 0) {
            showSpecialistError('æ ·å“ç±»åˆ«åˆ†å¸ƒ', 'é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        // åŸºäºç­›é€‰åçš„é¡¹ç›®æ•°æ®è®¡ç®—æ ·å“ç±»åˆ«åˆ†å¸ƒ
        const distribution = calculateCategoryDistribution(specialistProjectData);
        renderSpecialistChart('æ ·å“ç±»åˆ«åˆ†å¸ƒ', distribution, 'category');
    }

    function loadPriorityDistributionData() {
        showSpecialistLoading('ä¼˜å…ˆçº§åˆ†å¸ƒ');

        if (specialistProjectData.length === 0) {
            showSpecialistError('ä¼˜å…ˆçº§åˆ†å¸ƒ', 'é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        // åŸºäºç­›é€‰åçš„é¡¹ç›®æ•°æ®è®¡ç®—ä¼˜å…ˆçº§åˆ†å¸ƒ
        const distribution = calculatePriorityDistribution(specialistProjectData);
        renderSpecialistChart('ä¼˜å…ˆçº§åˆ†å¸ƒ', distribution, 'priority');
    }

    function loadTesterDistributionData() {
        showSpecialistLoading('æµ‹è¯•å‘˜åˆ†å¸ƒ');

        if (specialistProjectData.length === 0) {
            showSpecialistError('æµ‹è¯•å‘˜åˆ†å¸ƒ', 'é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        // åŸºäºç­›é€‰åçš„é¡¹ç›®æ•°æ®è®¡ç®—æµ‹è¯•å‘˜åˆ†å¸ƒ
        const distribution = calculateTesterDistribution(specialistProjectData);
        renderSpecialistChart('æµ‹è¯•å‘˜åˆ†å¸ƒ', distribution, 'tester');
    }

    function loadMonthlyTrendData() {
        showSpecialistLoading('æœˆåº¦è¶‹åŠ¿');

        if (specialistProjectData.length === 0) {
            showSpecialistError('æœˆåº¦è¶‹åŠ¿', 'é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
            return;
        }

        // åŸºäºç­›é€‰åçš„é¡¹ç›®æ•°æ®è®¡ç®—æœˆåº¦è¶‹åŠ¿
        const distribution = calculateMonthlyTrend(specialistProjectData);
        renderSpecialistChart('æœˆåº¦è¶‹åŠ¿', distribution, 'monthly');
    }

    // æ˜¾ç¤ºé¡¹ç›®ä¸“å‘˜è¯¦æƒ…
    function showSpecialistDetails(category, chartType) {
        // æ ¹æ®å›¾è¡¨ç±»å‹è°ƒç”¨ä¸åŒçš„è¯¦æƒ…æŸ¥çœ‹å‡½æ•°
        switch(chartType) {
            case 'schedule':
                showScheduleDetails(category);
                break;
            case 'scheduleDays':
                showScheduleDaysDetails(category);
                break;
            case 'status':
                showProjectStatusDetails(category);
                break;
            case 'category':
                showCategoryDetails(category);
                break;
            case 'priority':
                showPriorityDetails(category);
                break;
            case 'tester':
                showTesterDetails(category);
                break;
            case 'monthly':
                showMonthlyDetails(category);
                break;
            default:
                alert('è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½å¼€å‘ä¸­...');
        }
    }

    // æ˜¾ç¤ºæ’æœŸå¤©æ•°è¯¦æƒ…
    function showScheduleDaysDetails(monthCategory) {
        const filteredProjects = specialistProjectData.filter(project => {
            const scheduleStartDate = project.schedule_start_date;

            if (monthCategory === 'æœªè®¾ç½®æ’æœŸå¼€å§‹æ—¶é—´') {
                return !scheduleStartDate || scheduleStartDate === '-';
            } else if (monthCategory === 'æ—¥æœŸè§£æé”™è¯¯') {
                if (!scheduleStartDate || scheduleStartDate === '-') return false;
                try {
                    new Date(scheduleStartDate);
                    return false; // èƒ½è§£ææˆåŠŸï¼Œä¸æ˜¯é”™è¯¯
                } catch (e) {
                    return true; // è§£æå¤±è´¥ï¼Œæ˜¯é”™è¯¯
                }
            } else {
                // è§£ææœˆä»½ï¼Œå¦‚ "2024å¹´3æœˆ" -> 2024, 3
                const match = monthCategory.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                if (!match) return false;

                const targetYear = parseInt(match[1]);
                const targetMonth = parseInt(match[2]);

                if (!scheduleStartDate || scheduleStartDate === '-') return false;

                try {
                    const date = new Date(scheduleStartDate);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    return year === targetYear && month === targetMonth;
                } catch (e) {
                    return false;
                }
            }
        });

        showSpecialistDetailsModal(`${monthCategory}æ’æœŸé¡¹ç›®è¯¦æƒ…`, filteredProjects);
    }

    // æ˜¾ç¤ºé¡¹ç›®çŠ¶æ€è¯¦æƒ…
    function showProjectStatusDetails(status) {
        const filteredProjects = specialistProjectData.filter(project => {
            const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
            const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
            const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';

            if (status === 'æœªå¼€å§‹') return !hasActualStart;
            if (status === 'è¿›è¡Œä¸­') return hasActualStart && !hasActualFinish;
            if (status === 'å·²å®Œæˆæœªç¡®è®¤') return hasActualFinish && !hasRecognizeResult;
            if (status === 'å·²ç¡®è®¤') return hasRecognizeResult;
            return false;
        });

        showSpecialistDetailsModal(`${status}é¡¹ç›®è¯¦æƒ…`, filteredProjects);
    }

    // æ˜¾ç¤ºæ ·å“ç±»åˆ«è¯¦æƒ…
    function showCategoryDetails(category) {
        const filteredProjects = specialistProjectData.filter(project => {
            const projectCategory = project.sample_category || 'æœªåˆ†ç±»';
            return projectCategory === category;
        });

        showSpecialistDetailsModal(`${category}ç±»åˆ«é¡¹ç›®è¯¦æƒ…`, filteredProjects);
    }

    // æ˜¾ç¤ºä¼˜å…ˆçº§è¯¦æƒ…
    function showPriorityDetails(priority) {
        const filteredProjects = specialistProjectData.filter(project => {
            const projectPriority = project.priority || '';
            if (priority === 'é«˜') return projectPriority.includes('é«˜') || projectPriority.includes('ç´§æ€¥');
            if (priority === 'ä¸­') return projectPriority.includes('ä¸­') || projectPriority.includes('æ™®é€š');
            if (priority === 'ä½') return projectPriority.includes('ä½') || projectPriority.includes('ä¸€èˆ¬');
            if (priority === 'æœªè®¾ç½®') return !projectPriority || projectPriority.trim() === '';
            return false;
        });

        showSpecialistDetailsModal(`${priority}ä¼˜å…ˆçº§é¡¹ç›®è¯¦æƒ…`, filteredProjects);
    }

    // æ˜¾ç¤ºæµ‹è¯•å‘˜è¯¦æƒ…
    function showTesterDetails(tester) {
        const filteredProjects = specialistProjectData.filter(project => {
            const projectTester = project.tester || 'æœªåˆ†é…';
            return projectTester === tester;
        });

        showSpecialistDetailsModal(`${tester}è´Ÿè´£çš„é¡¹ç›®è¯¦æƒ…`, filteredProjects);
    }

    // æ˜¾ç¤ºæœˆåº¦è¯¦æƒ…
    function showMonthlyDetails(month) {
        const filteredProjects = specialistProjectData.filter(project => {
            if (project.create_time) {
                const date = new Date(project.create_time);
                const year = date.getFullYear();
                const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                const key = `${year}-${monthStr}`;
                return key === month;
            }
            return false;
        });

        showSpecialistDetailsModal(`${month}æœˆä»½é¡¹ç›®è¯¦æƒ…`, filteredProjects);
    }

    // æ˜¾ç¤ºé¡¹ç›®ä¸“å‘˜è¯¦æƒ…æ¨¡æ€æ¡†
    function showSpecialistDetailsModal(title, projects) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'specialistDetailsModal';
        modal.style.display = 'block';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1400px; width: 95%;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">ğŸ“‹</span>
                        ${title} (${projects.length}ä¸ªé¡¹ç›®)
                    </h3>
                    <span class="close" onclick="closeSpecialistDetailsModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
                </div>
                <div class="modal-body" style="padding: 30px; height: calc(100vh - 200px); overflow-y: auto;">
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button onclick="exportSpecialistDetailsExcel('${title}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ“Š å¯¼å‡ºExcel</button>
                        <button onclick="refreshSpecialistDetails('${title}')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    </div>
                    <div id="specialistDetailsContent">
                        ${createSpecialistDetailsTable(projects)}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        lockPageScroll();
    }

    // åˆ›å»ºé¡¹ç›®ä¸“å‘˜è¯¦æƒ…è¡¨æ ¼
    function createSpecialistDetailsTable(projects) {
        if (!projects || projects.length === 0) {
            return '<div style="text-align: center; padding: 50px; color: #666;">æš‚æ— é¡¹ç›®æ•°æ®</div>';
        }

        let tableHTML = `
            <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“ç¼–å·</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“åç§°</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“ç±»åˆ«</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“å‹å·</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">ç‰ˆæœ¬</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">é¡¹ç›®è´Ÿè´£äºº</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">å½“å‰è¿›åº¦</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ’æœŸå¤©æ•°</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ’æœŸå¼€å§‹æ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ’æœŸç»“æŸæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">å®é™…å¼€å§‹æ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">å®é™…å®Œæˆæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        projects.forEach((project, index) => {
            const rowStyle = index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';

            // è®¡ç®—å½“å‰è¿›åº¦çŠ¶æ€
            const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
            const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
            const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';

            let progressStatus = 'æœªå¼€å§‹';
            let statusColor = '#ffc107'; // é»˜è®¤é¢œè‰²

            if (!hasActualStart) {
                progressStatus = 'æœªå¼€å§‹';
                statusColor = '#ffc107'; // é»„è‰²
            } else if (hasActualStart && !hasActualFinish) {
                progressStatus = 'è¿›è¡Œä¸­';
                statusColor = '#17a2b8'; // è“è‰²
            } else if (hasActualFinish && !hasRecognizeResult) {
                progressStatus = 'å·²å®Œæˆå¾…ç¡®è®¤';
                statusColor = '#a72828'; // çº¢è‰²
            } else if (hasRecognizeResult) {
                progressStatus = 'å·²ç¡®è®¤';
                statusColor = '#28a745'; // ç»¿è‰²
            }

            // æ ¼å¼åŒ–æ’æœŸå¤©æ•°
            const scheduleDays = project.scheduleDays;
            const scheduleDaysDisplay = scheduleDays && !isNaN(scheduleDays) && scheduleDays > 0 ? `${scheduleDays}å¤©` : 'æœªè®¾ç½®';

            tableHTML += `
                <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; font-weight: 500; color: #333;">${project.sample_id || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_name || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_category || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_model || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.version || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_leader || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">
                        <span style="color: ${statusColor}; font-weight: bold;">${progressStatus}</span>
                    </td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333; text-align: center;">${scheduleDaysDisplay}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_start_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_end_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_start_time || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_finish_time || '-'}</td>
                    <td style="padding: 12px; color: #333;">${project.remark || '-'}</td>
                </tr>
            `;
        });

        tableHTML += `
                    </tbody>
                </table>
            </div>
        `;

        return tableHTML;
    }

    // å…³é—­é¡¹ç›®ä¸“å‘˜è¯¦æƒ…æ¨¡æ€æ¡†
    function closeSpecialistDetailsModal() {
        const modal = document.getElementById('specialistDetailsModal');
        if (modal) {
            modal.remove();
            unlockPageScroll();
        }
    }

    // åˆ·æ–°é¡¹ç›®ä¸“å‘˜è¯¦æƒ…
    function refreshSpecialistDetails(title) {
        // é‡æ–°åŠ è½½æ•°æ®
        loadAllProjectData();
        alert('æ•°æ®å·²åˆ·æ–°ï¼Œè¯·é‡æ–°é€‰æ‹©æŸ¥çœ‹');
    }

    // å¯¼å‡ºé¡¹ç›®ä¸“å‘˜è¯¦æƒ…Excel
    function exportSpecialistDetailsExcel(title) {
        alert(`${title}Excelå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...`);
    }


    // åˆ·æ–°é¡¹ç›®ä¸“å‘˜å›¾è¡¨
    function refreshSpecialistChart(chartType) {
        switch(chartType) {
            case 'schedule':
                loadScheduleDistributionData();
                break;
            case 'scheduleDays':
                loadScheduleDaysDistributionData();
                break;
            case 'status':
                loadProjectStatusData();
                break;
            case 'category':
                loadCategoryDistributionData();
                break;
            case 'priority':
                loadPriorityDistributionData();
                break;
            case 'tester':
                loadTesterDistributionData();
                break;
            case 'monthly':
                loadMonthlyTrendData();
                break;
        }
    }

    // å¯¼å‡ºé¡¹ç›®ä¸“å‘˜æ•°æ®
    function exportSpecialistData(chartType) {
        alert(`${chartType}æ•°æ®å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...`);
    }

    // è®¡ç®—é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ
    function calculateProjectStatusDistribution(projects) {
        const distribution = {
            'æœªå¼€å§‹': 0,
            'è¿›è¡Œä¸­': 0,
            'å·²å®Œæˆæœªç¡®è®¤': 0,
            'å·²ç¡®è®¤': 0
        };

        projects.forEach(project => {
            const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
            const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
            const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';

            if (!hasActualStart) {
                // ç‰¹æ®Šå¤„ç†ï¼šæµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿï¼Œä¸”æ˜¯é«˜é¢‘é¡¹ç›®ï¼Œä¸”æ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»ä¸€å¤©
                if ((project.tester === 'è”¡ä¹‰ä¼š' || project.tester === 'å»–å»ºä¼Ÿ') && project.high_frequency === 'æ˜¯') {
                    if (project.schedule_end_date) {
                        const today = new Date();
                        const scheduleEnd = new Date(project.schedule_end_date);
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        // å¦‚æœæ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»äº†ä¸€å¤©ï¼Œåˆ™ä¸ç»Ÿè®¡åœ¨æœªå¼€å§‹é¡¹ç›®ä¸­
                        if (scheduleEnd < yesterday) {
                            return;
                        }
                    }
                }
                distribution['æœªå¼€å§‹']++;
            } else if (hasActualStart && !hasActualFinish) {
                distribution['è¿›è¡Œä¸­']++;
            } else if (hasActualFinish && !hasRecognizeResult) {
                distribution['å·²å®Œæˆæœªç¡®è®¤']++;
            } else if (hasRecognizeResult) {
                distribution['å·²ç¡®è®¤']++;
            }
        });

        return distribution;
    }

    // è®¡ç®—æ ·å“ç±»åˆ«åˆ†å¸ƒ
    function calculateCategoryDistribution(projects) {
        const distribution = {};

        projects.forEach(project => {
            const category = project.sample_category || 'æœªåˆ†ç±»';
            distribution[category] = (distribution[category] || 0) + 1;
        });

        // æŒ‰æ•°é‡æ’åºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç±»åˆ«
        const sortedEntries = Object.entries(distribution)
            .sort(([,a], [,b]) => b - a);

        return Object.fromEntries(sortedEntries);
    }

    // è®¡ç®—ä¼˜å…ˆçº§åˆ†å¸ƒ
    function calculatePriorityDistribution(projects) {
        const distribution = {
            'é«˜': 0,
            'ä¸­': 0,
            'ä½': 0,
            'æœªè®¾ç½®': 0
        };

        projects.forEach(project => {
            const priority = project.priority || '';
            if (priority.includes('é«˜') || priority.includes('ç´§æ€¥')) {
                distribution['é«˜']++;
            } else if (priority.includes('ä¸­') || priority.includes('æ™®é€š')) {
                distribution['ä¸­']++;
            } else if (priority.includes('ä½') || priority.includes('ä¸€èˆ¬')) {
                distribution['ä½']++;
            } else {
                distribution['æœªè®¾ç½®']++;
            }
        });

        return distribution;
    }

    // è®¡ç®—æµ‹è¯•å‘˜åˆ†å¸ƒ
    function calculateTesterDistribution(projects) {
        const distribution = {};

        projects.forEach(project => {
            const tester = project.tester || 'æœªåˆ†é…';
            distribution[tester] = (distribution[tester] || 0) + 1;
        });

        // æŒ‰æ•°é‡æ’åºï¼Œæ˜¾ç¤ºæ‰€æœ‰æµ‹è¯•å‘˜
        const sortedEntries = Object.entries(distribution)
            .sort(([,a], [,b]) => b - a);

        return Object.fromEntries(sortedEntries);
    }

    // è®¡ç®—æœˆåº¦è¶‹åŠ¿
    function calculateMonthlyTrend(projects) {
        const distribution = {};

        projects.forEach(project => {
            if (project.create_time) {
                const date = new Date(project.create_time);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const key = `${year}-${month}`;
                distribution[key] = (distribution[key] || 0) + 1;
            }
        });

        // æŒ‰æœˆä»½æ’åº
        const sortedEntries = Object.entries(distribution)
            .sort(([a], [b]) => a.localeCompare(b))
            .slice(-12); // åªæ˜¾ç¤ºæœ€è¿‘12ä¸ªæœˆ

        return Object.fromEntries(sortedEntries);
    }

    // è®¡ç®—æœˆåº¦åˆ†ææ•°æ®
    function calculateMonthlyAnalysis(projects, chartType) {
        const monthlyData = {};
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        // è·å–æœ€è¿‘12ä¸ªæœˆçš„æ•°æ®
        for (let i = 11; i >= 0; i--) {
            const date = new Date(currentYear, currentMonth - 1 - i, 1);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const monthKey = `${year}-${month}`;

            monthlyData[monthKey] = {
                total: 0,
                distribution: {}
            };
        }

        // æ ¹æ®å›¾è¡¨ç±»å‹è®¡ç®—åˆ†å¸ƒ
        projects.forEach(project => {
            if (!project.create_time) return;

            const projectDate = new Date(project.create_time);
            const year = projectDate.getFullYear();
            const month = String(projectDate.getMonth() + 1).padStart(2, '0');
            const monthKey = `${year}-${month}`;

            if (monthlyData[monthKey]) {
                monthlyData[monthKey].total++;

                let category = '';
                switch(chartType) {
                    case 'schedule':
                        category = calculateScheduleCategory(project);
                        break;
                    case 'scheduleDays':
                        category = calculateScheduleDaysCategory(project);
                        break;
                    case 'status':
                        category = calculateStatusCategory(project);
                        break;
                    case 'category':
                        category = project.sample_category || 'æœªåˆ†ç±»';
                        break;
                    case 'priority':
                        category = calculatePriorityCategory(project);
                        break;
                    case 'tester':
                        category = project.tester || 'æœªæŒ‡å®š';
                        break;
                }

                if (category) {
                    monthlyData[monthKey].distribution[category] = (monthlyData[monthKey].distribution[category] || 0) + 1;
                }
            }
        });

        return monthlyData;
    }

    // è®¡ç®—æ’æœŸæ—¶é—´åˆ†ç±»
    function calculateScheduleCategory(project) {
        const createTime = project.create_time;
        const firstScheduleTime = getFirstScheduleTime(project.changeRecord, project.first_schedule_time_from_records);

        if (!createTime || !firstScheduleTime || firstScheduleTime === '-') {
            return 'æ— ç¬¬ä¸€æ¬¡æ’æœŸæ—¶é—´';
        }

        try {
            const createDate = new Date(createTime);
            createDate.setHours(0, 0, 0, 0);

            const firstScheduleDate = new Date(firstScheduleTime);
            firstScheduleDate.setHours(0, 0, 0, 0);

            const diffDays = Math.ceil((firstScheduleDate - createDate) / (1000 * 60 * 60 * 24));

            if (diffDays <= 1) return '1å¤©å†…å¼€å§‹æ’æœŸ';
            if (diffDays <= 3) return '2-3å¤©å¼€å§‹æ’æœŸ';
            if (diffDays <= 7) return '4-7å¤©å¼€å§‹æ’æœŸ';
            if (diffDays <= 15) return '8-15å¤©å¼€å§‹æ’æœŸ';
            if (diffDays <= 30) return '16-30å¤©å¼€å§‹æ’æœŸ';
            return '30å¤©ä»¥ä¸Šå¼€å§‹æ’æœŸ';
        } catch (e) {
            return 'æ— ç¬¬ä¸€æ¬¡æ’æœŸæ—¶é—´';
        }
    }

    // è®¡ç®—æ’æœŸå¤©æ•°åˆ†ç±»
    function calculateScheduleDaysCategory(project) {
        const scheduleDays = project.scheduleDays;
        if (scheduleDays && !isNaN(scheduleDays) && scheduleDays > 0) {
            return `${scheduleDays}å¤©`;
        }
        return 'æœªè®¾ç½®';
    }

    // è®¡ç®—é¡¹ç›®çŠ¶æ€åˆ†ç±»
    function calculateStatusCategory(project) {
        const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
        const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
        const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';

        if (!hasActualStart) return 'æœªå¼€å§‹';
        if (hasActualStart && !hasActualFinish) return 'è¿›è¡Œä¸­';
        if (hasActualFinish && !hasRecognizeResult) return 'å·²å®Œæˆæœªç¡®è®¤';
        if (hasRecognizeResult) return 'å·²ç¡®è®¤';
        return 'æœªå¼€å§‹';
    }

    // è®¡ç®—ä¼˜å…ˆçº§åˆ†ç±»
    function calculatePriorityCategory(project) {
        const priority = project.priority || '';
        if (priority.includes('é«˜') || priority.includes('ç´§æ€¥')) return 'é«˜';
        if (priority.includes('ä¸­') || priority.includes('æ™®é€š')) return 'ä¸­';
        if (priority.includes('ä½') || priority.includes('ä¸€èˆ¬')) return 'ä½';
        return 'æœªè®¾ç½®';
    }

    // è®¡ç®—åŒæ¯”ç¯æ¯”æ•°æ®
    function calculateComparisonData(monthlyData) {
        const months = Object.keys(monthlyData).sort();
        const comparisonData = {};

        months.forEach((month, index) => {
            const currentData = monthlyData[month];
            const prevMonth = months[index - 1];
            const prevYearMonth = getPreviousYearMonth(month);

            comparisonData[month] = {
                ...currentData,
                monthOverMonth: prevMonth ? calculateGrowthRate(monthlyData[prevMonth].total, currentData.total) : 0,
                yearOverYear: monthlyData[prevYearMonth] ? calculateGrowthRate(monthlyData[prevYearMonth].total, currentData.total) : 0
            };
        });

        return comparisonData;
    }

    // è·å–å»å¹´åŒæœŸæœˆä»½
    function getPreviousYearMonth(monthKey) {
        const [year, month] = monthKey.split('-');
        const prevYear = parseInt(year) - 1;
        return `${prevYear}-${month}`;
    }

    // è®¡ç®—å¢é•¿ç‡
    function calculateGrowthRate(previous, current) {
        if (previous === 0) return current > 0 ? 100 : 0;
        return ((current - previous) / previous * 100).toFixed(1);
    }

    // è®¡ç®—å„åˆ†ç±»çš„æœˆåº¦åˆ†ææ•°æ®
    function calculateCategoryMonthlyAnalysis(monthlyData) {
        const months = Object.keys(monthlyData).sort();
        const categoryAnalysis = {};

        // æ”¶é›†æ‰€æœ‰åˆ†ç±»
        const allCategories = new Set();
        months.forEach(month => {
            Object.keys(monthlyData[month].distribution).forEach(category => {
                allCategories.add(category);
            });
        });

        // ä¸ºæ¯ä¸ªåˆ†ç±»è®¡ç®—æœˆåº¦æ•°æ®
        allCategories.forEach(category => {
            categoryAnalysis[category] = {
                monthlyData: {},
                trend: 'stable',
                growthRate: 0,
                peakMonth: '',
                totalCount: 0
            };

            let monthlyValues = [];
            let validMonths = []; // åªè®°å½•æœ‰æ•°æ®çš„æœˆä»½

            months.forEach(month => {
                const value = monthlyData[month].distribution[category] || 0;
                if (value > 0) { // åªè®°å½•æœ‰æ•°æ®çš„æœˆä»½
                    categoryAnalysis[category].monthlyData[month] = value;
                    monthlyValues.push(value);
                    validMonths.push(month);
                }
                categoryAnalysis[category].totalCount += value;
            });

            // è®¡ç®—è¶‹åŠ¿ï¼ˆåªåŸºäºæœ‰æ•°æ®çš„æœˆä»½ï¼‰
            if (monthlyValues.length >= 2) {
                const firstHalf = monthlyValues.slice(0, Math.floor(monthlyValues.length / 2));
                const secondHalf = monthlyValues.slice(Math.floor(monthlyValues.length / 2));
                const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

                if (secondAvg > firstAvg * 1.1) {
                    categoryAnalysis[category].trend = 'rising';
                } else if (secondAvg < firstAvg * 0.9) {
                    categoryAnalysis[category].trend = 'declining';
                }

                // è®¡ç®—æ€»ä½“å¢é•¿ç‡
                const firstValue = monthlyValues[0];
                const lastValue = monthlyValues[monthlyValues.length - 1];
                categoryAnalysis[category].growthRate = calculateGrowthRate(firstValue, lastValue);
            }

            // æ‰¾åˆ°å³°å€¼æœˆä»½
            if (monthlyValues.length > 0) {
                const maxValue = Math.max(...monthlyValues);
                const peakIndex = monthlyValues.indexOf(maxValue);
                if (peakIndex !== -1) {
                    categoryAnalysis[category].peakMonth = validMonths[peakIndex];
                }
            }
        });

        return categoryAnalysis;
    }

    // æ˜¾ç¤ºåˆ†ç±»åˆ†æ
    function showCategoryAnalysis(chartType) {
        const container = document.getElementById('specialistChartContainer');

        if (specialistProjectData.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">æš‚æ— æ•°æ®</div>
                    <div style="font-size: 14px;">é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•</div>
                </div>
            `;
            return;
        }

        const monthlyData = calculateMonthlyAnalysis(specialistProjectData, chartType);
        const categoryAnalysis = calculateCategoryMonthlyAnalysis(monthlyData);
        const chartTitle = getChartTitle(chartType);

        container.innerHTML = `
            <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px; flex-shrink: 0;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">${chartTitle} - åˆ†ç±»åˆ†æ</h4>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button onclick="showTrendAnalysis('${chartType}')" title="è¶‹åŠ¿åˆ†æ" style="background: #4ecdc4; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</button>
                        <button onclick="refreshSpecialistChart('${chartType}')" title="è¿”å›åŸå›¾" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ”™ è¿”å›åŸå›¾</button>
                    </div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 20px; min-height: 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; min-height: 0;">
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden;">
                            <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">ğŸ“Š å„åˆ†ç±»è¶‹åŠ¿æ¦‚è§ˆ</h5>
                            ${createCategoryOverviewChart(categoryAnalysis)}
                        </div>
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden;">
                            <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">ğŸ“ˆ åˆ†ç±»å¢é•¿ç‡æ’å</h5>
                            ${createCategoryGrowthRanking(categoryAnalysis)}
                        </div>
                    </div>
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex: 1; min-height: 0; overflow: hidden;">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">ğŸ” å„åˆ†ç±»è¯¦ç»†æœˆåº¦å˜åŒ–</h5>
                        ${createDetailedCategoryAnalysis(categoryAnalysis, monthlyData)}
                    </div>
                </div>
            </div>
        `;
    }

    // æ˜¾ç¤ºæœˆåº¦åˆ†æ
    function showMonthlyAnalysis(chartType) {
        const container = document.getElementById('specialistChartContainer');

        if (specialistProjectData.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">æš‚æ— æ•°æ®</div>
                    <div style="font-size: 14px;">é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•</div>
                </div>
            `;
            return;
        }

        const monthlyData = calculateMonthlyAnalysis(specialistProjectData, chartType);
        const comparisonData = calculateComparisonData(monthlyData);
        const categoryAnalysis = calculateCategoryMonthlyAnalysis(monthlyData);

        const chartTitle = getChartTitle(chartType);

        container.innerHTML = `
            <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px; flex-shrink: 0;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">${chartTitle} - æœˆåº¦åˆ†æ</h4>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button onclick="showTrendAnalysis('${chartType}')" title="è¶‹åŠ¿åˆ†æ" style="background: #4ecdc4; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</button>
                        <button onclick="showCategoryAnalysis('${chartType}')" title="åˆ†ç±»åˆ†æ" style="background: #ff9f43; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ” åˆ†ç±»åˆ†æ</button>
                        <button onclick="refreshSpecialistChart('${chartType}')" title="è¿”å›åŸå›¾" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ”™ è¿”å›åŸå›¾</button>
                    </div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; overflow-y: auto;">
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px; flex-shrink: 0;">ğŸ” å„åˆ†ç±»æœˆåº¦å˜åŒ–è¶‹åŠ¿</h5>
                        <div style="flex: 1; overflow: hidden;">
                            ${createCategoryTrendAnalysis(categoryAnalysis)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // æ˜¾ç¤ºè¶‹åŠ¿åˆ†æ
    function showTrendAnalysis(chartType) {
        const container = document.getElementById('specialistChartContainer');

        if (specialistProjectData.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">æš‚æ— æ•°æ®</div>
                    <div style="font-size: 14px;">é¡¹ç›®æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•</div>
                </div>
            `;
            return;
        }

        const monthlyData = calculateMonthlyAnalysis(specialistProjectData, chartType);
        const chartTitle = getChartTitle(chartType);

        container.innerHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1;">${chartTitle} - è¶‹åŠ¿åˆ†æ</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <button onclick="showTrendChart('${chartType}', 'heatmap')" id="heatmapBtn" title="çƒ­åŠ›å›¾" style="background: #4ecdc4; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ”¥ çƒ­åŠ›å›¾</button>
                            <button onclick="showTrendChart('${chartType}', 'line')" id="lineBtn" title="æŠ˜çº¿å›¾" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“ˆ æŠ˜çº¿å›¾</button>
                        </div>
                        <button onclick="refreshSpecialistChart('${chartType}')" title="è¿”å›åŸå›¾" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ”™ è¿”å›åŸå›¾</button>
                    </div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: calc(100% - 80px);">
                    <div id="trendChartContent">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">ğŸ“ˆ å„ç»´åº¦è¶‹åŠ¿çƒ­åŠ›å›¾</h5>
                        ${createTrendHeatmap(monthlyData, chartType)}
                    </div>
                </div>
            </div>
        `;
        
        // é»˜è®¤æ¿€æ´»çƒ­åŠ›å›¾æŒ‰é’®
        document.getElementById('heatmapBtn').style.background = '#4ecdc4';
        document.getElementById('lineBtn').style.background = '#6c757d';
    }

    // æ˜¾ç¤ºè¶‹åŠ¿å›¾è¡¨ï¼ˆçƒ­åŠ›å›¾æˆ–æŠ˜çº¿å›¾ï¼‰
    function showTrendChart(chartType, chartViewType) {
        const monthlyData = calculateMonthlyAnalysis(specialistProjectData, chartType);
        const chartContent = document.getElementById('trendChartContent');
        const heatmapBtn = document.getElementById('heatmapBtn');
        const lineBtn = document.getElementById('lineBtn');
        
        if (chartViewType === 'heatmap') {
            chartContent.innerHTML = `
                <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">ğŸ“ˆ å„ç»´åº¦è¶‹åŠ¿çƒ­åŠ›å›¾</h5>
                ${createTrendHeatmap(monthlyData, chartType)}
            `;
            heatmapBtn.style.background = '#4ecdc4';
            lineBtn.style.background = '#6c757d';
        } else if (chartViewType === 'line') {
            chartContent.innerHTML = `
                <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">ğŸ“ˆ å„ç»´åº¦è¶‹åŠ¿æŠ˜çº¿å›¾</h5>
                ${createTrendLineChart(monthlyData, chartType)}
            `;
            heatmapBtn.style.background = '#6c757d';
            lineBtn.style.background = '#4ecdc4';
        }
    }

    // è·å–å›¾è¡¨æ ‡é¢˜
    function getChartTitle(chartType) {
        const titles = {
            'schedule': 'æ’æœŸæ—¶é—´åˆ†å¸ƒ',
            'scheduleDays': 'æ’æœŸå¤©æ•°åˆ†å¸ƒ',
            'status': 'é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ',
            'category': 'æ ·å“ç±»åˆ«åˆ†å¸ƒ',
            'priority': 'ä¼˜å…ˆçº§åˆ†å¸ƒ',
            'tester': 'æµ‹è¯•å‘˜åˆ†å¸ƒ'
        };
        return titles[chartType] || 'æ•°æ®åˆ†å¸ƒ';
    }

    // åˆ›å»ºæœˆåº¦è¶‹åŠ¿å›¾è¡¨
    function createMonthlyTrendChart(comparisonData) {
        const months = Object.keys(comparisonData).sort();
        const totals = months.map(month => comparisonData[month].total);
        const maxTotal = Math.max(...totals);

        let chartHTML = `
            <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin: 10px 0;">
                <div style="display: flex; align-items: end; gap: 12px; height: 200px; position: relative; padding-left: 40px;">
                    <!-- Yè½´æ ‡ç­¾ -->
                    <div style="position: absolute; left: 0; top: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between; font-size: 11px; color: #666; width: 35px;">
                        <span>${maxTotal}</span>
                        <span>${Math.floor(maxTotal * 0.75)}</span>
                        <span>${Math.floor(maxTotal * 0.5)}</span>
                        <span>${Math.floor(maxTotal * 0.25)}</span>
                        <span>0</span>
                    </div>
                    
                    <!-- ç½‘æ ¼çº¿ -->
                    <div style="position: absolute; left: 40px; top: 0; right: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        <div style="border-top: 1px solid #e9ecef; opacity: 0.3;"></div>
                        <div style="border-top: 1px solid #e9ecef; opacity: 0.3;"></div>
                        <div style="border-top: 1px solid #e9ecef; opacity: 0.3;"></div>
                        <div style="border-top: 1px solid #e9ecef; opacity: 0.3;"></div>
                    </div>
        `;

        months.forEach((month, index) => {
            const height = (comparisonData[month].total / maxTotal) * 100;
            const monthLabel = month.substring(5); // åªæ˜¾ç¤ºæœˆä»½
            const isCurrentMonth = index === months.length - 1;
            const isPeak = comparisonData[month].total === maxTotal;
            
            const barColor = isCurrentMonth ? 
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 
                isPeak ? 
                'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)' :
                'linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)';

            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1; position: relative;">
                    <div style="
                        width: 100%;
                        height: ${height}%;
                        background: ${barColor};
                        border-radius: 6px 6px 0 0;
                        position: relative;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        border: 2px solid transparent;
                    "
                    onmouseover="
                        this.style.transform='scale(1.05)';
                        this.style.boxShadow='0 6px 20px rgba(0,0,0,0.25)';
                        this.style.borderColor='${isCurrentMonth ? '#667eea' : isPeak ? '#ff6b6b' : '#4ecdc4'}';
                        this.style.zIndex='10';
                    "
                    onmouseout="
                        this.style.transform='scale(1)';
                        this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';
                        this.style.borderColor='transparent';
                        this.style.zIndex='1';
                    "
                    title="${month}: ${comparisonData[month].total}ä¸ªé¡¹ç›®">
                        <!-- æ•°å€¼æ ‡ç­¾ -->
                        <div style="
                            position: absolute; 
                            top: -30px; 
                            left: 50%; 
                            transform: translateX(-50%); 
                            font-size: 12px; 
                            font-weight: bold; 
                            color: #333; 
                            white-space: nowrap;
                            background: white;
                            padding: 4px 8px;
                            border-radius: 6px;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                        ">
                            ${comparisonData[month].total}
                        </div>
                        <!-- ç‰¹æ®Šæ ‡è¯† -->
                        ${isCurrentMonth ? `
                            <div style="
                                position: absolute;
                                top: -45px;
                                left: 50%;
                                transform: translateX(-50%);
                                font-size: 10px;
                                color: #667eea;
                                font-weight: bold;
                                background: white;
                                padding: 2px 6px;
                                border-radius: 4px;
                            ">å½“å‰</div>
                        ` : ''}
                        ${isPeak && !isCurrentMonth ? `
                            <div style="
                                position: absolute;
                                top: -45px;
                                left: 50%;
                                transform: translateX(-50%);
                                font-size: 10px;
                                color: #ff6b6b;
                                font-weight: bold;
                                background: white;
                                padding: 2px 6px;
                                border-radius: 4px;
                            ">å³°å€¼</div>
                        ` : ''}
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: #666; font-weight: 500; text-align: center;">
                        ${monthLabel}æœˆ
                    </div>
                </div>
            `;
        });

        chartHTML += `
                </div>
                
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                    <span>ğŸ“Š æ€»é¡¹ç›®æ•°: ${totals.reduce((a, b) => a + b, 0)}</span>
                    <span>ğŸ“ˆ å¹³å‡æ¯æœˆ: ${Math.round(totals.reduce((a, b) => a + b, 0) / totals.length)}</span>
                    <span>ğŸ“… æ—¶é—´è·¨åº¦: ${months.length}ä¸ªæœˆ</span>
                </div>
            </div>
        `;
        
        return chartHTML;
    }

    // åˆ›å»ºåŒæ¯”ç¯æ¯”åˆ†æå›¾è¡¨
    function createComparisonChart(comparisonData) {
        const months = Object.keys(comparisonData).sort();

        let chartHTML = '<div style="height: 100%; overflow-y: auto; min-height: 250px;">';

        months.forEach(month => {
            const data = comparisonData[month];
            const monthLabel = month.substring(5);
            const momRate = parseFloat(data.monthOverMonth);
            const yoyRate = parseFloat(data.yearOverYear);

            chartHTML += `
                <div style="
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 10px;
                    border-left: 4px solid #667eea;
                    transition: all 0.3s ease;
                "
                onmouseover="this.style.background='#e9ecef'; this.style.transform='translateX(5px)'"
                onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateX(0)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #333; font-size: 14px;">${monthLabel}æœˆ</div>
                        <div style="font-weight: bold; color: #667eea; font-size: 16px;">${data.total}ä¸ªé¡¹ç›®</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">ç¯æ¯”ä¸Šæœˆ</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${momRate >= 0 ? '#28a745' : '#dc3545'};">
                                ${momRate >= 0 ? '+' : ''}${momRate}%
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">åŒæ¯”å»å¹´</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${yoyRate >= 0 ? '#28a745' : '#dc3545'};">
                                ${yoyRate >= 0 ? '+' : ''}${yoyRate}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        chartHTML += '</div>';
        return chartHTML;
    }

    // åˆ›å»ºè¶‹åŠ¿çƒ­åŠ›å›¾
    function createTrendHeatmap(monthlyData, chartType) {
        const months = Object.keys(monthlyData).sort();
        const allCategories = new Set();

        // æ”¶é›†æ‰€æœ‰åˆ†ç±»
        months.forEach(month => {
            Object.keys(monthlyData[month].distribution).forEach(category => {
                allCategories.add(category);
            });
        });

        const categories = Array.from(allCategories);
        const maxValue = Math.max(...months.map(month =>
            Math.max(...Object.values(monthlyData[month].distribution))
        ));

        let chartHTML = `
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">åˆ†ç±»</th>
        `;

        months.forEach(month => {
            const monthLabel = month.substring(5);
            chartHTML += `<th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">${monthLabel}æœˆ</th>`;
        });

        chartHTML += '</tr></thead><tbody>';

        categories.forEach(category => {
            chartHTML += `<tr>`;
            chartHTML += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">${category}</td>`;

            months.forEach(month => {
                const value = monthlyData[month].distribution[category] || 0;
                const intensity = maxValue > 0 ? value / maxValue : 0;
                const color = getHeatmapColor(intensity);

                chartHTML += `
                    <td style="
                        padding: 10px;
                        text-align: center;
                        border: 1px solid #dee2e6;
                        background: ${color};
                        color: ${intensity > 0.5 ? 'white' : '#333'};
                        font-weight: bold;
                    " title="${month}: ${value}ä¸ªé¡¹ç›®">
                        ${value}
                    </td>
                `;
            });

            chartHTML += '</tr>';
        });

        chartHTML += '</tbody></table></div>';
        return chartHTML;
    }

    // åˆ›å»ºè¶‹åŠ¿æŠ˜çº¿å›¾
    function createTrendLineChart(monthlyData, chartType) {
        const months = Object.keys(monthlyData).sort();
        const allCategories = new Set();

        // æ”¶é›†æ‰€æœ‰åˆ†ç±»
        months.forEach(month => {
            Object.keys(monthlyData[month].distribution).forEach(category => {
                allCategories.add(category);
            });
        });

        const categories = Array.from(allCategories);
        const maxValue = Math.max(...months.map(month =>
            Math.max(...Object.values(monthlyData[month].distribution))
        ));

        // å®šä¹‰é¢œè‰²æ–¹æ¡ˆ
        const colors = [
            '#4ecdc4', '#ff6b6b', '#45b7d1', '#96ceb4', '#feca57',
            '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
            '#10ac84', '#ee5a24', '#0984e3', '#6c5ce7', '#a29bfe'
        ];

        let chartHTML = `
            <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin: 10px 0;">
                <div style="position: relative; height: 400px; background: white; border-radius: 8px; padding: 20px;">
                    <svg width="100%" height="100%" style="overflow: visible;">
                        <!-- ç½‘æ ¼çº¿ -->
                        <defs>
                            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e9ecef" stroke-width="1" opacity="0.3"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid)" />
                        
                        <!-- Yè½´æ ‡ç­¾ -->
                        <g font-family="Arial, sans-serif" font-size="12" fill="#666">
        `;

        // æ·»åŠ Yè½´æ ‡ç­¾
        for (let i = 0; i <= 5; i++) {
            const value = Math.floor((maxValue * i) / 5);
            const y = 20 + (350 * (5 - i)) / 5;
            chartHTML += `<text x="10" y="${y + 4}" text-anchor="start">${value}</text>`;
        }

        chartHTML += `
                        </g>
                        
                        <!-- Xè½´æ ‡ç­¾ -->
                        <g font-family="Arial, sans-serif" font-size="12" fill="#666">
        `;

        // æ·»åŠ Xè½´æ ‡ç­¾
        months.forEach((month, index) => {
            const x = months.length === 1 ? 460 : 60 + (index * (800 / Math.max(1, months.length - 1)));
            const monthLabel = month.substring(5);
            chartHTML += `<text x="${x}" y="390" text-anchor="middle">${monthLabel}æœˆ</text>`;
        });

        chartHTML += `
                        </g>
        `;

        // ä¸ºæ¯ä¸ªåˆ†ç±»ç»˜åˆ¶æŠ˜çº¿
        categories.forEach((category, categoryIndex) => {
            const color = colors[categoryIndex % colors.length];
            const points = [];
            
            months.forEach((month, monthIndex) => {
                const value = monthlyData[month].distribution[category] || 0;
                const x = months.length === 1 ? 460 : 60 + (monthIndex * (800 / Math.max(1, months.length - 1)));
                const y = 20 + (350 * (1 - value / maxValue));
                points.push(`${x},${y}`);
            });

            // ç»˜åˆ¶æŠ˜çº¿
            chartHTML += `
                <polyline
                    points="${points.join(' ')}"
                    fill="none"
                    stroke="${color}"
                    stroke-width="3"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.8"
                />
            `;

            // ç»˜åˆ¶æ•°æ®ç‚¹
            months.forEach((month, monthIndex) => {
                const value = monthlyData[month].distribution[category] || 0;
                const x = months.length === 1 ? 460 : 60 + (monthIndex * (800 / Math.max(1, months.length - 1)));
                const y = 20 + (350 * (1 - value / maxValue));
                
                chartHTML += `
                    <circle
                        cx="${x}"
                        cy="${y}"
                        r="4"
                        fill="${color}"
                        stroke="white"
                        stroke-width="2"
                        style="cursor: pointer;"
                        title="${category} - ${month}: ${value}ä¸ªé¡¹ç›®"
                    />
                `;
            });
        });

        chartHTML += `
                    </svg>
                </div>
                
                <!-- å›¾ä¾‹ -->
                <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        `;

        categories.forEach((category, index) => {
            const color = colors[index % colors.length];
            chartHTML += `
                <div style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <div style="width: 12px; height: 3px; background: ${color}; border-radius: 2px;"></div>
                    <span style="color: #333;">${category}</span>
                </div>
            `;
        });

        chartHTML += `
                </div>
            </div>
        `;

        return chartHTML;
    }

    // è·å–çƒ­åŠ›å›¾é¢œè‰²
    function getHeatmapColor(intensity) {
        if (intensity === 0) return '#f8f9fa';
        if (intensity <= 0.2) return '#d4edda';
        if (intensity <= 0.4) return '#c3e6cb';
        if (intensity <= 0.6) return '#a3d9a4';
        if (intensity <= 0.8) return '#7dd87d';
        return '#28a745';
    }



    // åˆ›å»ºåˆ†ç±»è¶‹åŠ¿åˆ†æå›¾è¡¨
    function createCategoryTrendAnalysis(categoryAnalysis) {
        const categories = Object.keys(categoryAnalysis);
        
        // æ”¶é›†æ‰€æœ‰æœˆä»½æ•°æ®
        const allMonths = new Set();
        categories.forEach(category => {
            const data = categoryAnalysis[category];
            Object.keys(data.monthlyData).forEach(month => allMonths.add(month));
        });
        
        // ç”Ÿæˆæœ€è¿‘12ä¸ªæœˆçš„å®Œæ•´åˆ—è¡¨
        const currentDate = new Date();
        const completeMonths = [];
        for (let i = 11; i >= 0; i--) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
            const monthStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
            completeMonths.push(monthStr);
        }
        
        const sortedMonths = completeMonths.filter(month => allMonths.has(month)).length > 0 ? 
            completeMonths : Array.from(allMonths).sort();
        if (sortedMonths.length === 0) {
            return '<div style="text-align: center; color: #666; font-size: 16px; padding: 50px;">æš‚æ— æ•°æ®</div>';
        }

        // ç®€æ´é…è‰²æ–¹æ¡ˆ
        const colors = [
            '#4F46E5', '#059669', '#DC2626', '#7C3AED', '#EA580C',
            '#0891B2', '#65A30D', '#BE185D', '#0D9488', '#9333EA'
        ];

        // è®¡ç®—æ•°æ®
        const monthlyTotals = {};
        const categoryData = {};
        const categoryTotals = {};
        
        sortedMonths.forEach(month => {
            monthlyTotals[month] = 0;
            categoryData[month] = {};
            
            categories.forEach(category => {
                const value = categoryAnalysis[category].monthlyData[month] || 0;
                monthlyTotals[month] += value;
                categoryData[month][category] = value;
                categoryTotals[category] = (categoryTotals[category] || 0) + value;
            });
        });

        const maxTotal = Math.max(...Object.values(monthlyTotals));
        const totalProjects = Object.values(monthlyTotals).reduce((a, b) => a + b, 0);

        let chartHTML = `
            <div style="height: 100%; overflow-y: auto; min-height: 500px; padding: 20px;">
                <!-- æ ‡é¢˜åŒºåŸŸ -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 600; color: #1F2937;">æœˆåº¦æ•°æ®åˆ†æ</h3>
                    <p style="margin: 0; font-size: 14px; color: #6B7280;">å„åˆ†ç±»é¡¹ç›®åˆ†å¸ƒè¶‹åŠ¿å¯¹æ¯”</p>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #4F46E5; margin-bottom: 4px;">${totalProjects}</div>
                        <div style="font-size: 12px; color: #6B7280;">æ€»é¡¹ç›®æ•°</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #059669; margin-bottom: 4px;">${Math.round(totalProjects / sortedMonths.length)}</div>
                        <div style="font-size: 12px; color: #6B7280;">å¹³å‡æ¯æœˆ</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #DC2626; margin-bottom: 4px;">${Math.max(...Object.values(monthlyTotals))}</div>
                        <div style="font-size: 12px; color: #6B7280;">å³°å€¼æœˆä»½</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #7C3AED; margin-bottom: 4px;">${categories.length}</div>
                        <div style="font-size: 12px; color: #6B7280;">åˆ†ç±»æ•°é‡</div>
                    </div>
                </div>

                <!-- ä¸»å›¾è¡¨åŒºåŸŸ -->
                <div style="background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <!-- å›¾ä¾‹ -->
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; justify-content: center;">
        `;

        // æŒ‰æ€»é‡æ’åºåˆ†ç±»
        const sortedCategories = categories.sort((a, b) => categoryTotals[b] - categoryTotals[a]);
        
        sortedCategories.forEach((category, index) => {
            const data = categoryAnalysis[category];
            const trendIcon = data.trend === 'rising' ? 'â†—' : data.trend === 'declining' ? 'â†˜' : 'â†’';
            const color = colors[index % colors.length];
            const percentage = ((categoryTotals[category] / totalProjects) * 100).toFixed(1);
            
            chartHTML += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #F9FAFB; border-radius: 6px; border: 1px solid #E5E7EB;">
                    <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px;"></div>
                    <span style="font-size: 12px; font-weight: 500; color: #374151;">${trendIcon} ${category}</span>
                    <span style="font-size: 11px; color: #6B7280;">${categoryTotals[category]} (${percentage}%)</span>
                </div>
            `;
        });

        chartHTML += `
                    </div>
                    
                    <!-- æŸ±çŠ¶å›¾å®¹å™¨ -->
                    <div style="background: #F9FAFB; border-radius: 6px; padding: 20px; position: relative; overflow-x: auto;">
                        <div style="display: flex; align-items: end; gap: 4px; height: 250px; position: relative; padding-left: 50px; min-width: ${Math.max(800, sortedMonths.length * 70)}px;">
                            <!-- Yè½´æ ‡ç­¾ -->
                            <div style="position: absolute; left: 0; top: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between; font-size: 11px; color: #6B7280; width: 45px;">
                                <span>${maxTotal}</span>
                                <span>${Math.floor(maxTotal * 0.75)}</span>
                                <span>${Math.floor(maxTotal * 0.5)}</span>
                                <span>${Math.floor(maxTotal * 0.25)}</span>
                                <span>0</span>
                            </div>
                            
                            <!-- ç½‘æ ¼çº¿ -->
                            <div style="position: absolute; left: 50px; top: 0; right: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                <div style="border-top: 1px solid #E5E7EB; opacity: 0.5;"></div>
                                <div style="border-top: 1px solid #E5E7EB; opacity: 0.5;"></div>
                                <div style="border-top: 1px solid #E5E7EB; opacity: 0.5;"></div>
                                <div style="border-top: 1px solid #E5E7EB; opacity: 0.5;"></div>
                            </div>
        `;

        // åˆ›å»ºæŸ±çŠ¶å›¾
        sortedMonths.forEach((month, monthIndex) => {
            const monthLabel = month.substring(5);
            const monthData = categoryData[month];
            const total = monthlyTotals[month];
            const isCurrentMonth = monthIndex === sortedMonths.length - 1;
            
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; min-width: 50px; max-width: 70px;">
                    <div style="display: flex; flex-direction: column; align-items: center; width: 100%; height: ${(total / maxTotal) * 100}%; position: relative; border-radius: 4px 4px 0 0; overflow: hidden;">
            `;

            // åˆ›å»ºå †å éƒ¨åˆ†
            sortedCategories.forEach((category, categoryIndex) => {
                const value = monthData[category] || 0;
                if (value > 0) {
                    const height = (value / total) * 100;
                    const color = colors[categoryIndex % colors.length];
                    
                    chartHTML += `
                        <div style="
                            width: 100%;
                            height: ${height}%;
                            background: ${color};
                            position: relative;
                            transition: all 0.2s ease;
                            cursor: pointer;
                        "
                        onmouseover="
                            this.style.opacity='0.8';
                            this.style.transform='scale(1.02)';
                        "
                        onmouseout="
                            this.style.opacity='1';
                            this.style.transform='scale(1)';
                        "
                        title="${category}: ${value}ä¸ªé¡¹ç›®">
                    `;
                    
                    // æ•°å€¼æ ‡ç­¾
                    if (value >= total * 0.25) {
                        chartHTML += `
                            <div style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                font-size: 8px;
                                font-weight: 600;
                                color: white;
                                text-shadow: 0 1px 2px rgba(0,0,0,0.5);
                                white-space: nowrap;
                            ">${value}</div>
                        `;
                    }
                    
                    chartHTML += `</div>`;
                }
            });

            chartHTML += `
                    </div>
                    
                    <!-- æ€»æ•°å€¼æ ‡ç­¾ -->
                    <div style="
                        position: absolute;
                        top: -25px;
                        left: 50%;
                        transform: translateX(-50%);
                        font-size: 10px;
                        font-weight: 600;
                        color: #1F2937;
                        background: white;
                        padding: 4px 6px;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        white-space: nowrap;
                    ">${total}</div>
                </div>
            `;
        });

        chartHTML += `
                        </div>
                        
                        <!-- Xè½´æ ‡ç­¾ -->
                        <div style="margin-top: 15px; display: flex; justify-content: space-between; padding-left: 50px; min-width: ${Math.max(800, sortedMonths.length * 70)}px;">
        `;

        // æ·»åŠ æœˆä»½æ ‡ç­¾
        sortedMonths.forEach((month, monthIndex) => {
            const monthLabel = month.substring(5);
            const isCurrentMonth = monthIndex === sortedMonths.length - 1;
            
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 50px; max-width: 70px;">
                    <div style="
                        font-size: 11px; 
                        color: ${isCurrentMonth ? '#4F46E5' : '#6B7280'}; 
                        font-weight: 600; 
                        text-align: center; 
                        white-space: nowrap; 
                        background: ${isCurrentMonth ? '#EEF2FF' : '#F9FAFB'}; 
                        padding: 6px 10px; 
                        border-radius: 4px; 
                        border: 1px solid ${isCurrentMonth ? '#4F46E5' : '#E5E7EB'};
                        margin-bottom: 6px;
                    ">
                        ${monthLabel}æœˆ
                    </div>
                    <div style="font-size: 9px; color: #9CA3AF; text-align: center; line-height: 1.2;">
            `;
            
            // æ·»åŠ åˆ†ç±»ç»Ÿè®¡
            const monthData = categoryData[month];
            const categoryStats = [];
            sortedCategories.forEach((category, categoryIndex) => {
                const value = monthData[category] || 0;
                if (value > 0) {
                    const color = colors[categoryIndex % colors.length];
                    categoryStats.push(`<span style="color: ${color}; font-weight: 500;">${category}: ${value}</span>`);
                }
            });
            
            if (categoryStats.length > 0) {
                chartHTML += categoryStats.join('<br>');
            } else {
                chartHTML += '<span style="color: #D1D5DB;">æ— æ•°æ®</span>';
            }
            
            chartHTML += `
                    </div>
                </div>
            `;
        });

        chartHTML += `
                        </div>
                    </div>
                </div>

                <!-- è¶‹åŠ¿åˆ†æ -->
                <div style="background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600; color: #1F2937;">è¶‹åŠ¿åˆ†æ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        `;

        // æ·»åŠ è¶‹åŠ¿åˆ†æå¡ç‰‡
        sortedCategories.forEach((category, index) => {
            const data = categoryAnalysis[category];
            const trendIcon = data.trend === 'rising' ? 'â†—' : data.trend === 'declining' ? 'â†˜' : 'â†’';
            const trendColor = data.trend === 'rising' ? '#059669' : data.trend === 'declining' ? '#DC2626' : '#6B7280';
            const color = colors[index % colors.length];
            
            chartHTML += `
                <div style="background: #F9FAFB; padding: 15px; border-radius: 6px; border-left: 3px solid ${color};">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <div style="width: 24px; height: 24px; background: ${color}; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">${trendIcon}</div>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: #1F2937;">${category}</div>
                            <div style="font-size: 11px; color: #6B7280;">æ€»è®¡ ${data.totalCount} ä¸ªé¡¹ç›®</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 11px; color: #6B7280;">å¢é•¿ç‡</div>
                        <div style="font-size: 14px; font-weight: 600; color: ${trendColor};">
                            ${data.growthRate >= 0 ? '+' : ''}${data.growthRate}%
                        </div>
                    </div>
                </div>
            `;
        });

        chartHTML += `
                    </div>
                </div>
            </div>
        `;

        return chartHTML;
    }

    // åˆ›å»ºåˆ†ç±»æ¦‚è§ˆå›¾è¡¨
    function createCategoryOverviewChart(categoryAnalysis) {
        const categories = Object.keys(categoryAnalysis);

        let chartHTML = '<div style="height: 400px; overflow-y: auto;">';

        categories.forEach(category => {
            const data = categoryAnalysis[category];
            const trendIcon = data.trend === 'rising' ? 'ğŸ“ˆ' : data.trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸';
            const trendColor = data.trend === 'rising' ? '#28a745' : data.trend === 'declining' ? '#dc3545' : '#6c757d';

            chartHTML += `
                <div style="
                    margin-bottom: 15px;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                    border-left: 4px solid ${trendColor};
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.15)'"
                onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">${trendIcon}</span>
                            <h6 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">${category}</h6>
                        </div>
                        <div style="font-size: 16px; font-weight: bold; color: ${trendColor};">
                            ${data.totalCount}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <div style="color: #666; margin-bottom: 2px;">å¢é•¿ç‡</div>
                            <div style="font-weight: bold; color: ${trendColor};">
                                ${data.growthRate >= 0 ? '+' : ''}${data.growthRate}%
                            </div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <div style="color: #666; margin-bottom: 2px;">å³°å€¼æœˆä»½</div>
                            <div style="font-weight: bold; color: #333;">
                                ${data.peakMonth ? data.peakMonth.substring(5) + 'æœˆ' : '-'}
                            </div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <div style="color: #666; margin-bottom: 2px;">è¶‹åŠ¿</div>
                            <div style="font-weight: bold; color: ${trendColor};">
                                ${data.trend === 'rising' ? 'ä¸Šå‡' : data.trend === 'declining' ? 'ä¸‹é™' : 'ç¨³å®š'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        chartHTML += '</div>';
        return chartHTML;
    }

    // åˆ›å»ºåˆ†ç±»å¢é•¿ç‡æ’å
    function createCategoryGrowthRanking(categoryAnalysis) {
        const categories = Object.keys(categoryAnalysis);
        const sortedCategories = categories.sort((a, b) =>
            parseFloat(categoryAnalysis[b].growthRate) - parseFloat(categoryAnalysis[a].growthRate)
        );

        let chartHTML = '<div style="height: 400px; overflow-y: auto;">';

        sortedCategories.forEach((category, index) => {
            const data = categoryAnalysis[category];
            const growthRate = parseFloat(data.growthRate);
            const rankColor = index < 3 ? '#ff6b6b' : index < 6 ? '#ffa726' : '#66bb6a';
            const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ”¸';

            chartHTML += `
                <div style="
                    margin-bottom: 12px;
                    padding: 12px;
                    background: white;
                    border-radius: 8px;
                    border-left: 4px solid ${rankColor};
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='translateX(3px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">${rankIcon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333; font-size: 14px;">${category}</div>
                                <div style="font-size: 12px; color: #666;">æ€»è®¡: ${data.totalCount}ä¸ªé¡¹ç›®</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: ${rankColor};">
                                ${growthRate >= 0 ? '+' : ''}${growthRate}%
                            </div>
                            <div style="font-size: 10px; color: #666;">ç¬¬${index + 1}å</div>
                        </div>
                    </div>
                </div>
            `;
        });

        chartHTML += '</div>';
        return chartHTML;
    }

    // åˆ›å»ºè¯¦ç»†åˆ†ç±»åˆ†æ
    function createDetailedCategoryAnalysis(categoryAnalysis, monthlyData) {
        const categories = Object.keys(categoryAnalysis);
        const months = Object.keys(monthlyData).sort();

        let chartHTML = `
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600; position: sticky; left: 0; background: #f8f9fa;">åˆ†ç±»</th>
        `;

        months.forEach(month => {
            const monthLabel = month.substring(5);
            chartHTML += `<th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">${monthLabel}æœˆ</th>`;
        });

        chartHTML += `
                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">æ€»è®¡</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">å¢é•¿ç‡</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">è¶‹åŠ¿</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        categories.forEach(category => {
            const data = categoryAnalysis[category];
            const trendIcon = data.trend === 'rising' ? 'ğŸ“ˆ' : data.trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸';
            const trendColor = data.trend === 'rising' ? '#28a745' : data.trend === 'declining' ? '#dc3545' : '#6c757d';

            chartHTML += `<tr style="border-bottom: 1px solid #dee2e6;">`;
            chartHTML += `<td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 500; position: sticky; left: 0; background: white;">${category}</td>`;

            months.forEach(month => {
                const value = data.monthlyData[month] || 0;
                chartHTML += `
                    <td style="
                        padding: 12px;
                        text-align: center;
                        border: 1px solid #dee2e6;
                        font-weight: bold;
                    ">
                        ${value}
                    </td>
                `;
            });

            chartHTML += `
                <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; color: #667eea;">
                    ${data.totalCount}
                </td>
                <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; color: ${trendColor};">
                    ${data.growthRate >= 0 ? '+' : ''}${data.growthRate}%
                </td>
                <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; color: ${trendColor};">
                    ${trendIcon}
                </td>
            </tr>`;
        });

        chartHTML += '</tbody></table></div>';
        return chartHTML;
    }

    // åˆ·æ–°æ’æœŸå›¾è¡¨
    function refreshScheduleChart() {
        loadScheduleDistributionData();
    }

    // å¯¼å‡ºæ’æœŸæ•°æ®
    function exportScheduleData() {
        // è¿™é‡Œå¯ä»¥å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½
        alert('æ•°æ®å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
    }

    // æ˜¾ç¤ºæ’æœŸæ—¶é—´è¯¦æƒ…
    function showScheduleDetails(scheduleStatus) {
        // ä½¿ç”¨å‰ç«¯æ•°æ®è¿‡æ»¤é¡¹ç›®
        const filteredProjects = specialistProjectData.filter(project => {
            const category = calculateScheduleCategory(project);
            return category === scheduleStatus;
        });

        showScheduleDetailsModal(scheduleStatus, filteredProjects);
    }

    // æ˜¾ç¤ºæ’æœŸè¯¦æƒ…æ¨¡æ€æ¡†
    function showScheduleDetailsModal(scheduleStatus, projects) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'scheduleDetailsModal';
        modal.style.display = 'block';

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1400px; width: 95%;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">ğŸ“‹</span>
                        ${scheduleStatus} - é¡¹ç›®è¯¦æƒ… (${projects.length}ä¸ªé¡¹ç›®)
                    </h3>
                    <span class="close" onclick="closeScheduleDetailsModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
                </div>
                <div class="modal-body" style="padding: 30px; height: calc(100vh - 200px); overflow-y: auto;">
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button onclick="exportScheduleDetailsExcel('${scheduleStatus}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ“Š å¯¼å‡ºExcel</button>
                        <button onclick="refreshScheduleDetails('${scheduleStatus}')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    </div>
                    <div id="scheduleDetailsContent">
                        ${createScheduleDetailsTable(projects)}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        lockPageScroll();
    }

    // è§£æç¬¬ä¸€æ¬¡æ’æœŸæ—¶é—´
    function getFirstScheduleTime(changeRecord, firstScheduleTimeFromRecords) {
        // ä¼˜å…ˆä»change_recordsè¡¨è·å–ç¬¬ä¸€æ¬¡æ’æœŸæ—¶é—´
        if (firstScheduleTimeFromRecords && firstScheduleTimeFromRecords !== 'null' && firstScheduleTimeFromRecords.trim() !== '') {
            return firstScheduleTimeFromRecords;
        }

        // å¦‚æœchange_recordsè¡¨ä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™ä»changeRecordå­—æ®µè§£æ
        if (!changeRecord || changeRecord.trim() === '') {
            return '-';
        }

        try {
            const firstRecord = changeRecord.split('|')[0];
            if (firstRecord && firstRecord.trim() !== '') {
                const parts = firstRecord.trim().split('#');
                if (parts.length >= 4) {
                    // å–ç¬¬å››ä¸ª"#"çš„å€¼ï¼Œä¹Ÿå°±æ˜¯update_timeå­—æ®µ
                    const updateTime = parts[3];
                    if (updateTime && updateTime !== 'null' && updateTime.trim() !== '') {
                        return updateTime;
                    }
                }
            }
        } catch (e) {
            // è§£æå¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼
            console.error('è§£æchangeRecordå¤±è´¥:', e, changeRecord);
        }

        return '-';
    }

    // åˆ›å»ºæ’æœŸè¯¦æƒ…è¡¨æ ¼
    function createScheduleDetailsTable(projects) {
        if (!projects || projects.length === 0) {
            return '<div style="text-align: center; padding: 50px; color: #666;">æš‚æ— é¡¹ç›®æ•°æ®</div>';
        }

        let tableHTML = `
            <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“ç¼–å·</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“åç§°</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“ç±»åˆ«</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ ·å“å‹å·</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">ç‰ˆæœ¬</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">é¡¹ç›®è´Ÿè´£äºº</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">å½“å‰è¿›åº¦</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ¥å•æ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">ç¬¬ä¸€æ¬¡æ’æœŸæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ’æœŸå¼€å§‹æ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">æ’æœŸç»“æŸæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">å®é™…å¼€å§‹æ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">å®é™…å®Œæˆæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        projects.forEach((project, index) => {
            const rowStyle = index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';

            // è°ƒè¯•ä¿¡æ¯
            if (project.changeRecord) {
                console.log('é¡¹ç›®', project.sample_id, 'çš„changeRecord:', project.changeRecord);
                console.log('è§£æç»“æœ:', getFirstScheduleTime(project.changeRecord, project.first_schedule_time_from_records));
            }

            tableHTML += `
                <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; font-weight: 500; color: #333;">${project.sample_id || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_name || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_category || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_model || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.version || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_leader || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${formatDateTime(project.create_time) || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${getFirstScheduleTime(project.changeRecord, project.first_schedule_time_from_records)}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_start_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_end_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_start_time || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_finish_time || '-'}</td>
                    <td style="padding: 12px; color: #333;">${project.remark || '-'}</td>
                </tr>
            `;
        });

        tableHTML += `
                    </tbody>
                </table>
            </div>
        `;

        return tableHTML;
    }

    // å…³é—­æ’æœŸè¯¦æƒ…æ¨¡æ€æ¡†
    function closeScheduleDetailsModal() {
        const modal = document.getElementById('scheduleDetailsModal');
        if (modal) {
            modal.remove();
            unlockPageScroll();
        }
    }

    // åˆ·æ–°æ’æœŸè¯¦æƒ…
    function refreshScheduleDetails(scheduleStatus) {
        showScheduleDetails(scheduleStatus);
    }

    // å¯¼å‡ºæ’æœŸè¯¦æƒ…Excel
    function exportScheduleDetailsExcel(scheduleStatus) {
        // è¿™é‡Œå¯ä»¥å®ç°Excelå¯¼å‡ºåŠŸèƒ½
        alert('Excelå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
    }

    // æ›´æ–°çœ‹æ¿æ•°æ®
    function updateDashboard() {
        // æ ¹æ®electric_infoè¡¨çš„æ•°æ®ç»“æ„æ¥åˆ¤æ–­é¡¹ç›®çŠ¶æ€
        const notStarted = projectData.filter(p => {
            // åŸºæœ¬æ¡ä»¶ï¼šæ²¡æœ‰å®é™…å¼€å§‹æ—¶é—´ä¸”è¿›åº¦ä¸æ˜¯å·²å®Œæˆ
            if (p.actual_start_time || p.schedule === 'å·²å®Œæˆ') {
                return false;
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼šæµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿï¼Œä¸”æ˜¯é«˜é¢‘é¡¹ç›®ï¼Œä¸”æ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»ä¸€å¤©
            if ((p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ') && p.high_frequency === 'æ˜¯') {
                if (p.schedule_end_date) {
                    const today = new Date();
                    const scheduleEnd = new Date(p.schedule_end_date);
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    // å¦‚æœæ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»äº†ä¸€å¤©ï¼Œåˆ™ä¸ç»Ÿè®¡åœ¨æœªå¼€å§‹é¡¹ç›®ä¸­
                    if (scheduleEnd < yesterday) {
                        return false;
                    }
                }
            }
            
            return true;
        }).length;

        const inProgress = projectData.filter(p =>
            p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
        ).length;

        const completed = projectData.filter(p =>
            p.actual_finish_time && !p.sampleRecognizeResult
        ).length;

        const confirmed = projectData.filter(p => {
            // ç‰¹æ®Šå¤„ç†ï¼šé«˜é¢‘é¡¹ç›®ä¸”æµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿçš„æƒ…å†µ
            if (p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')) {
                // éœ€è¦æ»¡è¶³æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                if (p.schedule_end_date) {
                    const today = new Date();
                    const scheduleEndDate = new Date(p.schedule_end_date);
                    const nextDay = new Date(scheduleEndDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    nextDay.setHours(0, 0, 0, 0);
                    today.setHours(0, 0, 0, 0);
                    
                    // åªæœ‰å½“å‰æ—¶é—´å·²è¿‡æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                    if (today < nextDay) {
                        return false;
                    } else {
                        return true; // é«˜é¢‘é¡¹ç›®æ»¡è¶³æ—¶é—´æ¡ä»¶å°±ç›´æ¥é€šè¿‡ï¼Œä¸éœ€è¦DQEæ‰¿è®¤ç»“æœ
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰æ’æœŸç»“æŸæ—¶é—´ï¼Œåˆ™ä¸ç®—å·²ç¡®è®¤
                    return false;
                }
            }
            
            // æ™®é€šé¡¹ç›®ï¼šåŸºæœ¬æ¡ä»¶æ˜¯æœ‰DQEæ‰¿è®¤ç»“æœ
            if (!p.sampleRecognizeResult || p.sampleRecognizeResult.trim() === '') {
                return false;
            }
            
            return true;
        }).length;

        // è®¡ç®—è¿‡æ»¤åçš„é¡¹ç›®æ€»æ•°ï¼ˆæ’é™¤é«˜é¢‘é¡¹ç›®å’ŒæŒ‡å®šæµ‹è¯•è´Ÿè´£äººçš„é¡¹ç›®ï¼‰
        const filteredTotal = projectData.filter(p => {
            // ç‰¹æ®Šå¤„ç†ï¼šæµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿï¼Œä¸”æ˜¯é«˜é¢‘é¡¹ç›®ï¼Œä¸”æ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»ä¸€å¤©
            if ((p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ') && p.high_frequency === 'æ˜¯') {
                if (p.schedule_end_date) {
                    const today = new Date();
                    const scheduleEnd = new Date(p.schedule_end_date);
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    // å¦‚æœæ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»äº†ä¸€å¤©ï¼Œåˆ™ä¸ç»Ÿè®¡åœ¨é¡¹ç›®æ€»æ•°ä¸­
                    if (scheduleEnd < yesterday) {
                        return false;
                    }
                }
            }
            
            return true;
        }).length;

        document.getElementById('totalCount').textContent = filteredTotal;
        document.getElementById('notStartedCount').textContent = notStarted;
        document.getElementById('inProgressCount').textContent = inProgress;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('closedCount').textContent = confirmed;
    }

    // æ›´æ–°é¡¹ç›®è¡¨æ ¼
    function updateProjectTable() {
        const container = document.getElementById('projectTableContainer');

        if (filteredData.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';
            return;
        }

        let tableHTML = `
                <table class="project-table">
                    <thead>
                        <tr>
                            <th>æ ·å“ç¼–å·</th>
                            <th>äº§å“åç§°</th>
                            <th>äº§å“ç±»åˆ«</th>
                            <th>å¤§ç¼–ç </th>
                            <th>ç‰©æ–™ç¼–ç </th>
                            <th>ç‰ˆæœ¬</th>
                            <th>é¡¹ç›®è´Ÿè´£äºº</th>
                            <th>å½“å‰è¿›åº¦</th>
                            <th>æµ‹è¯•è´Ÿè´£äºº</th>
                            <th>é€æ ·äºº</th>
                            <th>é€æ ·ç±»åˆ«</th>
                            <th>é€æ ·æ•°é‡</th>
                            <th>æ˜¯å¦é«˜é¢‘</th>
                            <th>æå•æ—¶é—´</th>
                            <th>æ’æœŸå¤©æ•°</th>
                            <th>æ’æœŸå¼€å§‹</th>
                            <th>æ’æœŸç»“æŸ</th>
                            <th>å®é™…å¼€å§‹æ—¶é—´</th>
                            <th>å®é™…å®Œæˆæ—¶é—´</th>
                             <th>DQEæ‰¿è®¤ç»“æœ</th>
                             <th>ç ”å‘æ‰¿è®¤ç»“æœ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        filteredData.forEach(project => {
            const isOverdue = project.schedule_end_date && project.schedule !== 'å·²å®Œæˆ' &&
                new Date(project.schedule_end_date) < new Date();

            // æ ¹æ®å®é™…æ—¶é—´åˆ¤æ–­é¡¹ç›®çŠ¶æ€
            let statusText = 'æœªå¼€å§‹';
            let statusColor = '#ffc107';

            if (project.actual_start_time && !project.actual_finish_time) {
                statusText = 'è¿›è¡Œä¸­';
                statusColor = '#17a2b8';
            } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                statusText = 'å·²å®Œæˆæœªç¡®è®¤';
                statusColor = '#a72828';
            }else if (project.actual_finish_time && project.sampleRecognizeResult){
                statusText = 'æŠ¥å‘Šç¡®è®¤é—­ç¯'
                statusColor = '#28a745';
            }

            tableHTML += `
                    <tr style="${isOverdue ? 'background-color: #ffe6e6;' : ''}">
                        <td><strong>${project.sample_id || '-'}</strong></td>
                        <td>${project.sample_name || '-'}</td>
                        <td>${project.sample_category || '-'}</td>
                        <td>${project.sample_model || '-'}</td>
                        <td>${project.materialCode || '-'}</td>
                        <td>${project.version || '-'}</td>
                        <td>${project.sample_leader || '-'}</td>
                        <td>
                            <span style="color: ${statusColor}; font-weight: bold;">
                                ${statusText}
                            </span>
                        </td>
                        <td>${project.tester || '-'}</td>
                        <td>${project.sample_sender || '-'}</td>
                        <td>${project.sample_type || '-'}</td>
                        <td>${project.sample_quantity || '-'}</td>
                        <td>${project.high_frequency || '-'}</td>
                        <td>${formatDateTime(project.create_time) || '-'}</td>
                        <td>${project.scheduleDays || '-'}</td>
                        <td>${formatDate(project.schedule_start_date) || '-'}</td>
                        <td style="${isOverdue ? 'color: red; font-weight: bold;' : ''}">
                            ${formatDate(project.schedule_end_date) || '-'}
                        </td>
                        <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                        <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                         <td>${project.sampleRecognizeResult || '-'}</td>
                         <td>${project.rd_sampleRecognizeResult || '-'}</td>
                    </tr>
                `;
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    // æ›´æ–°ç±»åˆ«ç­›é€‰å™¨
    function updateCategoryFilter() {
        const categories = [...new Set(projectData.map(p => p.sample_category).filter(Boolean))];
        const filter = document.getElementById('categoryFilter');

        filter.innerHTML = '<option value="">æ‰€æœ‰ç±»åˆ«</option>';
        categories.forEach(category => {
            filter.innerHTML += `<option value="${category}">${category}</option>`;
        });
    }

    // åº”ç”¨ç­›é€‰
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;

        filteredData = projectData.filter(project => {
            const matchesSearch = !searchTerm ||
                (project.sample_id && project.sample_id.toLowerCase().includes(searchTerm)) ||
                (project.sample_name && project.sample_name.toLowerCase().includes(searchTerm));

            const matchesCategory = !category || project.sample_category === category;

            // æ ¹æ®å®é™…æ—¶é—´åˆ¤æ–­é¡¹ç›®çŠ¶æ€è¿›è¡Œç­›é€‰
            let projectStatus = 'æœªå¼€å§‹';
            if (project.actual_start_time && !project.actual_finish_time) {
                projectStatus = 'è¿›è¡Œä¸­';
            } else if (project.actual_finish_time) {
                if (project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '') {
                    projectStatus = 'å·²ç¡®è®¤';
                } else {
                    projectStatus = 'å·²å®Œæˆæœªç¡®è®¤';
                }
            }

            const matchesStatus = !status || projectStatus === status;

            return matchesSearch && matchesCategory && matchesStatus;
        });

        updateProjectTable();
    }

    // é‡ç½®ç­›é€‰
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        filteredData = [...projectData];
        updateProjectTable();
    }

    // åº”ç”¨æ—¶é—´ç­›é€‰
    function applyTimeFilter() {
        const startDate = document.getElementById('createTimeStart').value;
        const endDate = document.getElementById('createTimeEnd').value;

        if (!startDate && !endDate) {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            // æ¢å¤åŸå§‹æ•°æ®
            projectData = [...originalProjectData];
            filteredData = [...originalProjectData];
        } else {
            // ç­›é€‰æ•°æ®
            const filtered = originalProjectData.filter(project => {
                if (!project.create_time) return false;

                const createDate = new Date(project.create_time);
                let matchesStart = true;
                let matchesEnd = true;

                if (startDate) {
                    const start = new Date(startDate);
                    matchesStart = createDate >= start;
                }

                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999); // ç»“æŸæ—¥æœŸè®¾ä¸ºå½“å¤©çš„æœ€åä¸€ç§’
                    matchesEnd = createDate <= end;
                }

                return matchesStart && matchesEnd;
            });

            // æ›´æ–°projectDataä¸ºç­›é€‰åçš„æ•°æ®
            projectData = [...filtered];
            filteredData = [...filtered];
        }

        // æ›´æ–°çœ‹æ¿å’Œè¡¨æ ¼
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // é‡ç½®æ—¶é—´ç­›é€‰
    function resetTimeFilter() {
        document.getElementById('createTimeStart').value = '';
        document.getElementById('createTimeEnd').value = '';
        // æ¢å¤åŸå§‹æ•°æ®
        projectData = [...originalProjectData];
        filteredData = [...originalProjectData];
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
    function showProjectDetails(status) {
        let title = '';
        let projects = [];

        switch(status) {
            case 'total':
                title = 'é¡¹ç›®æ€»æ•°';
                projects = projectData.filter(p => {
                    // ç‰¹æ®Šå¤„ç†ï¼šæµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿï¼Œä¸”æ˜¯é«˜é¢‘é¡¹ç›®ï¼Œä¸”æ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»ä¸€å¤©
                    if ((p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ') && p.high_frequency === 'æ˜¯') {
                        if (p.schedule_end_date) {
                            const today = new Date();
                            const scheduleEnd = new Date(p.schedule_end_date);
                            const yesterday = new Date(today);
                            yesterday.setDate(yesterday.getDate() - 1);
                            
                            // å¦‚æœæ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»äº†ä¸€å¤©ï¼Œåˆ™ä¸ç»Ÿè®¡åœ¨é¡¹ç›®æ€»æ•°ä¸­
                            if (scheduleEnd < yesterday) {
                                return false;
                            }
                        }
                    }
                    
                    return true;
                });
                break;
            case 'not-started':
                title = 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…';
                projects = projectData.filter(p => {
                    // æ’é™¤å·²æ’æœŸä½†æœªåˆ°å¼€å§‹æ—¶é—´çš„é¡¹ç›®
                    if (p.schedule_start_date) {
                        const now = new Date();
                        const scheduleStart = new Date(p.schedule_start_date);
                        // å¦‚æœå·²æ’æœŸä½†è¿˜æ²¡åˆ°å¼€å§‹æ—¶é—´ï¼Œåˆ™æ’é™¤
                        if (scheduleStart > now) {
                            return false;
                        }
                    }
                    // åªæ˜¾ç¤ºçœŸæ­£æœªå¼€å§‹çš„é¡¹ç›®ï¼ˆæ²¡æœ‰å®é™…å¼€å§‹æ—¶é—´ï¼‰
                    if (p.actual_start_time) {
                        return false;
                    }
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šæµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿï¼Œä¸”æ˜¯é«˜é¢‘é¡¹ç›®ï¼Œä¸”æ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»ä¸€å¤©
                    if ((p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ') && p.high_frequency === 'æ˜¯') {
                        if (p.schedule_end_date) {
                            const today = new Date();
                            const scheduleEnd = new Date(p.schedule_end_date);
                            const yesterday = new Date(today);
                            yesterday.setDate(yesterday.getDate() - 1);
                            
                            // å¦‚æœæ’æœŸç»“æŸæ—¶é—´å·²ç»è¿‡å»äº†ä¸€å¤©ï¼Œåˆ™ä¸ç»Ÿè®¡åœ¨æœªå¼€å§‹é¡¹ç›®ä¸­
                            if (scheduleEnd < yesterday) {
                                return false;
                            }
                        }
                    }
                    
                    return true;
                });
                break;
            case 'in-progress':
                title = 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…';
                projects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'completed':
                title = 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…';
                projects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case 'overdue':
                title = 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…';
                
                // å…ˆæ‰“å°æ‰€æœ‰åŸå§‹æ•°æ®ä¸­çš„é«˜é¢‘é¡¹ç›®
                console.log('=== åŸå§‹æ•°æ®ä¸­çš„é«˜é¢‘é¡¹ç›® ===');
                const allHighFreqProjects = projectData.filter(p => 
                    p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')
                );
                console.log('åŸå§‹æ•°æ®ä¸­é«˜é¢‘é¡¹ç›®æ•°é‡:', allHighFreqProjects.length);
                allHighFreqProjects.forEach((project, index) => {
                    console.log(`åŸå§‹é«˜é¢‘é¡¹ç›® ${index + 1}:`, {
                        æ ·å“ç¼–å·: project.sample_number,
                        äº§å“åç§°: project.product_name,
                        æµ‹è¯•è´Ÿè´£äºº: project.tester,
                        æ˜¯å¦é«˜é¢‘: project.high_frequency,
                        DQEæ‰¿è®¤ç»“æœ: project.sampleRecognizeResult,
                        æ’æœŸç»“æŸæ—¶é—´: project.schedule_end_date,
                        å½“å‰æ—¶é—´: new Date().toISOString().split('T')[0]
                    });
                });
                
                projects = projectData.filter(p => {
                    // ç‰¹æ®Šå¤„ç†ï¼šé«˜é¢‘é¡¹ç›®ä¸”æµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿçš„æƒ…å†µ
                    if (p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')) {
                        console.log('å¤„ç†é«˜é¢‘é¡¹ç›®:', {
                            æ ·å“ç¼–å·: p.sample_number,
                            äº§å“åç§°: p.product_name,
                            æµ‹è¯•è´Ÿè´£äºº: p.tester,
                            æ’æœŸç»“æŸæ—¶é—´: p.schedule_end_date,
                            DQEæ‰¿è®¤ç»“æœ: p.sampleRecognizeResult
                        });
                        
                        // éœ€è¦æ»¡è¶³æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                        if (p.schedule_end_date) {
                            const today = new Date();
                            const scheduleEndDate = new Date(p.schedule_end_date);
                            const nextDay = new Date(scheduleEndDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                            nextDay.setHours(0, 0, 0, 0);
                            today.setHours(0, 0, 0, 0);
                            
                            console.log('æ—¶é—´è®¡ç®—:', {
                                'æ’æœŸç»“æŸæ—¶é—´': p.schedule_end_date,
                                'æ’æœŸç»“æŸæ—¶é—´å¯¹è±¡': scheduleEndDate,
                                'ç¬¬äºŒå¤©': nextDay,
                                'å½“å‰æ—¶é—´': today,
                                'å½“å‰æ—¶é—´ < ç¬¬äºŒå¤©': today < nextDay,
                                'æ˜¯å¦é€šè¿‡': today >= nextDay
                            });
                            
                            // åªæœ‰å½“å‰æ—¶é—´å·²è¿‡æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                            if (today < nextDay) {
                                console.log('é«˜é¢‘é¡¹ç›®è¢«è¿‡æ»¤æ‰ï¼ˆæ—¶é—´æœªåˆ°ï¼‰:', p.sample_number);
                                return false;
                            } else {
                                console.log('é«˜é¢‘é¡¹ç›®é€šè¿‡æ—¶é—´æ£€æŸ¥ï¼Œç›´æ¥ç®—ä½œå·²ç¡®è®¤:', p.sample_number);
                                return true; // é«˜é¢‘é¡¹ç›®æ»¡è¶³æ—¶é—´æ¡ä»¶å°±ç›´æ¥é€šè¿‡ï¼Œä¸éœ€è¦DQEæ‰¿è®¤ç»“æœ
                            }
                        } else {
                            console.log('é«˜é¢‘é¡¹ç›®è¢«è¿‡æ»¤æ‰ï¼ˆæ— æ’æœŸç»“æŸæ—¶é—´ï¼‰:', p.sample_number);
                            // å¦‚æœæ²¡æœ‰æ’æœŸç»“æŸæ—¶é—´ï¼Œåˆ™ä¸ç®—å·²ç¡®è®¤
                            return false;
                        }
                    }
                    
                    // æ™®é€šé¡¹ç›®ï¼šåŸºæœ¬æ¡ä»¶æ˜¯æœ‰DQEæ‰¿è®¤ç»“æœ
                    if (!p.sampleRecognizeResult || p.sampleRecognizeResult.trim() === '') {
                        return false;
                    }
                    
                    return true;
                });
                
                // æ‰“å°å·²ç¡®è®¤é¡¹ç›®æ•°æ®åˆ°æ§åˆ¶å°
                console.log('=== å·²ç¡®è®¤é¡¹ç›®æ•°æ®è°ƒè¯•ä¿¡æ¯ ===');
                console.log('è¿‡æ»¤åçš„å·²ç¡®è®¤é¡¹ç›®æ•°é‡:', projects.length);
                console.log('å·²ç¡®è®¤é¡¹ç›®è¯¦ç»†æ•°æ®:', projects);
                
                // æ‰“å°é«˜é¢‘é¡¹ç›®ç‰¹æ®Šå¤„ç†çš„æ•°æ®
                const highFrequencyProjects = projects.filter(p => 
                    p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')
                );
                console.log('é«˜é¢‘é¡¹ç›®ï¼ˆè”¡ä¹‰ä¼š/å»–å»ºä¼Ÿï¼‰æ•°é‡:', highFrequencyProjects.length);
                console.log('é«˜é¢‘é¡¹ç›®è¯¦ç»†æ•°æ®:', highFrequencyProjects);
                
                // æ‰“å°æ¯ä¸ªé«˜é¢‘é¡¹ç›®çš„æ—¶é—´ä¿¡æ¯
                highFrequencyProjects.forEach((project, index) => {
                    console.log(`é«˜é¢‘é¡¹ç›® ${index + 1}:`, {
                        æ ·å“ç¼–å·: project.sample_number,
                        äº§å“åç§°: project.product_name,
                        æµ‹è¯•è´Ÿè´£äºº: project.tester,
                        æ’æœŸç»“æŸæ—¶é—´: project.schedule_end_date,
                        å½“å‰æ—¶é—´: new Date().toISOString().split('T')[0],
                        æ˜¯å¦æ»¡è¶³æ—¶é—´æ¡ä»¶: project.schedule_end_date ? 
                            new Date() >= new Date(new Date(project.schedule_end_date).getTime() + 24 * 60 * 60 * 1000) : 'æ— æ’æœŸç»“æŸæ—¶é—´'
                    });
                });
                console.log('=== å·²ç¡®è®¤é¡¹ç›®æ•°æ®è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
                break;
        }

        // ä¼ é€’çŠ¶æ€ä¿¡æ¯åˆ°æ¨¡æ€æ¡†ï¼Œç”¨äºåç»­çš„è¿‡æ»¤å™¨è®¾ç½®
        showProjectModal(title, projects, status);
    }

    // é”å®šé¡µé¢æ»šåŠ¨
    function lockPageScroll() {
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
    }

    // æ¢å¤é¡µé¢æ»šåŠ¨
    function unlockPageScroll() {
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
    }

    // æ˜¾ç¤ºé¡¹ç›®æ¨¡æ€æ¡†
    function showProjectModal(title, projects, status) {
        document.getElementById('modalTitle').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${title}</span>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <!-- è§†å›¾æ§åˆ¶æŒ‰é’® -->
                        <div style="display: flex; gap: 5px; margin-right: 10px;">
                            <button class="view-btn" onclick="switchView('day', '${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')" id="dayViewBtn">æ—¥è§†å›¾</button>
                            <button class="view-btn" onclick="switchView('week', '${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')" id="weekViewBtn">å‘¨è§†å›¾</button>
                            <button class="view-btn" onclick="switchView('month', '${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')" id="monthViewBtn">æœˆè§†å›¾</button>
                        </div>
                        <!-- å¯¹æ¯”åˆ†ææŒ‰é’® -->
                        <div style="display: flex; gap: 5px; margin-right: 10px;">
                            <button class="comparison-btn" onclick="showComparison('ring', '${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')" id="ringComparisonBtn">ç¯æ¯”</button>
                            <button class="comparison-btn" onclick="showComparison('year', '${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')" id="yearComparisonBtn">åŒæ¯”</button>
                        </div>
                        <!-- åŸæœ‰åŠŸèƒ½æŒ‰é’® -->
                        <button class="filter-btn" onclick="showModalCharts('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            æŸ¥çœ‹å›¾è¡¨
                        </button>
                        <button class="filter-btn" onclick="showModalDataList('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            æŸ¥çœ‹æ•°æ®åˆ—è¡¨
                        </button>
                        <button class="filter-btn" onclick="showDynamicChartModal('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            è‡ªå®šä¹‰å›¾è¡¨
                        </button>
                        <button class="filter-btn" onclick="exportModalExcel('${title}')">
                            å¯¼å‡ºExcel
                        </button>
                    </div>
                </div>
            `;

        // é»˜è®¤æ˜¾ç¤ºå›¾è¡¨ï¼Œä¼ é€’çŠ¶æ€ä¿¡æ¯
        showModalCharts(title, projects, status);

        // é”å®šé¡µé¢æ»šåŠ¨
        lockPageScroll();

        document.getElementById('projectModal').style.display = 'block';
    }

    // æ˜¾ç¤ºæ¨¡æ€æ¡†å›¾è¡¨
    function showModalCharts(title, projects, status) {
        let contentHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ</h3>
                    <p>å…±æ‰¾åˆ° <strong>${projects.length}</strong> ä¸ªé¡¹ç›®</p>
                </div>
            `;

        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è‡ªå®šä¹‰å›¾è¡¨
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const chartKey = `${title}_${status}`;
        let savedChartsList = savedCharts[chartKey];

        // ç¡®ä¿savedChartsListæ˜¯æ•°ç»„
        if (savedChartsList && !Array.isArray(savedChartsList)) {
            // å¦‚æœæ˜¯æ—§æ ¼å¼çš„å•ä¸ªå›¾è¡¨ï¼Œè½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
            if (savedChartsList.fieldName) {
                savedChartsList = [savedChartsList];
                // æ›´æ–°localStorageä¸ºæ–°çš„æ•°ç»„æ ¼å¼
                savedCharts[chartKey] = savedChartsList;
                localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
            } else {
                savedChartsList = null;
            }
        }

        // åˆ›å»ºå›¾è¡¨å¯¼èˆªå’Œæ˜¾ç¤ºåŒºåŸŸ
        contentHTML += `
            <div style="display: flex; gap: 20px; height: 600px;">
                <!-- å·¦ä¾§å¯¼èˆªæ  -->
                <div style="width: 250px; background: #f8f9fa; border-radius: 10px; padding: 20px; overflow-y: auto;">
                    <h4 style="color: #333; margin-bottom: 15px; font-size: 16px;">å›¾è¡¨å¯¼èˆª</h4>
                    <div id="chartNavList" style="display: flex; flex-direction: column; gap: 8px;">
                    </div>
                </div>

                <!-- å³ä¾§å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
                <div style="flex: 1; background: #fff; border-radius: 10px; padding: 20px; border: 1px solid #e9ecef;">
                    <div id="chartDisplayArea" style="height: 100%; display: flex; align-items: center; justify-content: center;">
                        <p style="color: #666; text-align: center;">è¯·é€‰æ‹©å·¦ä¾§å›¾è¡¨è¿›è¡ŒæŸ¥çœ‹</p>
                    </div>
                </div>
            </div>
        `;

        // å¦‚æœæœ‰ä¿å­˜çš„è‡ªå®šä¹‰å›¾è¡¨ï¼Œæ·»åŠ åˆ°å¯¼èˆªä¸­
        if (savedChartsList && savedChartsList.length > 0) {
            contentHTML += `
                <div style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="color: #333; margin: 0; font-size: 18px; font-weight: 600;">
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ“Š è‡ªå®šä¹‰å›¾è¡¨ç®¡ç†</span>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-left: 10px; font-weight: 500;">${savedChartsList.length}ä¸ªå›¾è¡¨</span>
                        </h4>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                `;

            savedChartsList.forEach((savedChart, index) => {
                const chartTypeIcon = {
                    'bar': 'ğŸ“Š',
                    'pie': 'ğŸ¥§',
                    'line': 'ğŸ“ˆ'
                }[savedChart.chartType] || 'ğŸ“Š';

                const chartTypeColor = {
                    'bar': '#4CAF50',
                    'pie': '#FF9800',
                    'line': '#2196F3'
                }[savedChart.chartType] || '#4CAF50';

                contentHTML += `
                        <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
                                    padding: 20px;
                                    border-radius: 16px;
                                    border: 1px solid #e9ecef;
                                    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                                    transition: all 0.3s ease;
                                    position: relative;
                                    overflow: hidden;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">

                             <!-- è£…é¥°æ€§èƒŒæ™¯ -->
                             <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: ${chartTypeColor}20; border-radius: 50%; opacity: 0.3;"></div>

                             <!-- å›¾è¡¨ç±»å‹å›¾æ ‡ -->
                             <div style="position: absolute; top: 15px; right: 15px; font-size: 24px; opacity: 0.6;">${chartTypeIcon}</div>

                             <!-- å›¾è¡¨æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯ -->
                             <div style="margin-bottom: 15px; padding-right: 50px;">
                                 <h6 style="color: #2c3e50; margin: 0 0 8px 0; font-size: 16px; font-weight: 600; line-height: 1.3;">
                                     ${savedChart.title}
                                 </h6>
                                 <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                                     <span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                         ğŸ“‹ ${savedChart.fieldLabel}
                                     </span>
                                     <span style="background: #f3e5f5; color: #7b1fa2; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                         ${chartTypeIcon} ${getChartTypeName(savedChart.chartType)}
                                     </span>
                                     <span style="background: #e8f5e8; color: #2e7d32; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                         ğŸ”¢ å‰${savedChart.topN}ä¸ª
                                     </span>
                                 </div>
                                 <div style="color: #6c757d; font-size: 11px; margin-top: 5px;">
                                     <span>ğŸ•’ ${savedChart.createTime || 'åˆšåˆšåˆ›å»º'}</span>
                                 </div>
                             </div>

                             <!-- æ“ä½œæŒ‰é’® -->
                             <div style="display: flex; gap: 8px; margin-top: 15px;">
                                 <button onclick="showCustomChart('${chartKey}', ${savedChart.id})"
                                         style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                border: none; color: white; padding: 10px 16px; border-radius: 8px;
                                                font-size: 13px; font-weight: 500; cursor: pointer;
                                                transition: all 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);"
                                         onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                                     ğŸ‘ï¸ æŸ¥çœ‹å›¾è¡¨
                                 </button>
                                 <button onclick="removeSavedChart('${chartKey}', ${savedChart.id})"
                                         style="background: #dc3545; border: none; color: white; padding: 10px 12px; border-radius: 8px;
                                                font-size: 13px; cursor: pointer; transition: all 0.2s;"
                                         onmouseover="this.style.background='#c82333'; this.style.transform='translateY(-1px)'"
                                         onmouseout="this.style.background='#dc3545'; this.style.transform='translateY(0)'"
                                         title="åˆ é™¤å›¾è¡¨">
                                     ğŸ—‘ï¸
                                 </button>
                             </div>
                        </div>
                    `;
            });

            contentHTML += `</div></div>`;
        }

        if (projects.length > 0) {
            // äº§å“ç±»åˆ«ç»Ÿè®¡
            const categoryStats = {};
            projects.forEach(project => {
                const category = project.sample_category && project.sample_category.trim() !== '' ? project.sample_category : 'æœªåˆ†ç±»';
                categoryStats[category] = (categoryStats[category] || 0) + 1;
            });

            // é¡¹ç›®è´Ÿè´£äººç»Ÿè®¡
            const leaderStats = {};
            projects.forEach(project => {
                const leader = project.sample_leader && project.sample_leader.trim() !== '' ? project.sample_leader : 'æœªæŒ‡å®š';
                leaderStats[leader] = (leaderStats[leader] || 0) + 1;
            });

            // æµ‹è¯•è´Ÿè´£äººç»Ÿè®¡
            const testerStats = {};
            projects.forEach(project => {
                const tester = project.tester && project.tester.trim() !== '' ? project.tester : 'æœªæŒ‡å®š';
                testerStats[tester] = (testerStats[tester] || 0) + 1;
            });

            // DQEè´Ÿè´£äººç»Ÿè®¡
            const dqeLeaderStats = {};
            projects.forEach(project => {
                const dqeLeader = project.dqe_leader && project.dqe_leader.trim() !== '' ? project.dqe_leader : 'æœªæŒ‡å®š';
                dqeLeaderStats[dqeLeader] = (dqeLeaderStats[dqeLeader] || 0) + 1;
            });

            // ç ”å‘è´Ÿè´£äººç»Ÿè®¡
            const rdLeaderStats = {};
            projects.forEach(project => {
                const rdLeader = project.rd_leader && project.rd_leader.trim() !== '' ? project.rd_leader : 'æœªæŒ‡å®š';
                rdLeaderStats[rdLeader] = (rdLeaderStats[rdLeader] || 0) + 1;
            });

            // é€æ ·äººç»Ÿè®¡
            const sampleSenderStats = {};
            projects.forEach(project => {
                const sampleSender = project.sample_sender && project.sample_sender.trim() !== '' ? project.sample_sender : 'æœªæŒ‡å®š';
                sampleSenderStats[sampleSender] = (sampleSenderStats[sampleSender] || 0) + 1;
            });

            // ç¡®è®¤ç»“æœåˆ†å¸ƒç»Ÿè®¡
            const confirmResultStats = {};
            projects.forEach(project => {
                // æ£€æŸ¥ç ”å‘æ‰¿è®¤ç»“æœ
                if (project.rd_sampleRecognizeResult) {
                    const rdResult = project.rd_sampleRecognizeResult.trim();
                    if (rdResult !== '') {
                        confirmResultStats[`ç ”å‘-${rdResult}`] = (confirmResultStats[`ç ”å‘-${rdResult}`] || 0) + 1;
                    }
                }

                // æ£€æŸ¥DQEæ‰¿è®¤ç»“æœ
                if (project.sampleRecognizeResult) {
                    const dqeResult = project.sampleRecognizeResult.trim();
                    if (dqeResult !== '') {
                        confirmResultStats[`DQE-${dqeResult}`] = (confirmResultStats[`DQE-${dqeResult}`] || 0) + 1;
                    }
                }

                // ç»Ÿè®¡æœªç¡®è®¤çš„é¡¹ç›®
                if ((!project.rd_sampleRecognizeResult || project.rd_sampleRecognizeResult.trim() === '') &&
                    (!project.sampleRecognizeResult || project.sampleRecognizeResult.trim() === '')) {
                    confirmResultStats['DQE-æœªç¡®è®¤'] = (confirmResultStats['DQE-æœªç¡®è®¤'] || 0) + 1;
                }
            });

            // æ’æœŸå¤©æ•°åˆ†å¸ƒç»Ÿè®¡
            const scheduleDaysStats = {};
            projects.forEach(project => {
                const days = project.scheduleDays;
                if (days && !isNaN(days)) {
                    // ç›´æ¥ä½¿ç”¨å…·ä½“å¤©æ•°ä½œä¸ºé”®
                    scheduleDaysStats[days] = (scheduleDaysStats[days] || 0) + 1;
                } else {
                    scheduleDaysStats['æœªè®¾ç½®'] = (scheduleDaysStats['æœªè®¾ç½®'] || 0) + 1;
                }
            });

            // å¯¹å¤©æ•°è¿›è¡Œæ’åºï¼Œç¡®ä¿å›¾è¡¨æ˜¾ç¤ºæœ‰åº
            const sortedScheduleDays = Object.keys(scheduleDaysStats)
                .filter(key => key !== 'æœªè®¾ç½®')
                .sort((a, b) => parseInt(a) - parseInt(b));

            // é‡æ–°æ„å»ºæœ‰åºçš„ç»Ÿè®¡æ•°æ®
            const orderedScheduleDaysStats = {};
            sortedScheduleDays.forEach(days => {
                orderedScheduleDaysStats[days + 'å¤©'] = scheduleDaysStats[days];
            });
            // å°†"æœªè®¾ç½®"æ”¾åœ¨æœ€å
            if (scheduleDaysStats['æœªè®¾ç½®']) {
                orderedScheduleDaysStats['æœªè®¾ç½®'] = scheduleDaysStats['æœªè®¾ç½®'];
            }

            // æœªå¼€å§‹å¤©æ•°åˆ†å¸ƒç»Ÿè®¡ï¼ˆåªåœ¨æœªå¼€å§‹é¡¹ç›®ä¸­æ˜¾ç¤ºï¼‰
            let notStartedDaysStats = {};
            if (status === 'not-started') {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºä»Šå¤©çš„å¼€å§‹æ—¶é—´

                projects.forEach(project => {
                    if (project.create_time) {
                        try {
                            const createDate = new Date(project.create_time);
                            createDate.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºåˆ›å»ºæ—¥æœŸçš„å¼€å§‹æ—¶é—´

                            // è®¡ç®—å¤©æ•°å·®
                            const timeDiff = today.getTime() - createDate.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                            if (daysDiff >= 0) {
                                // ç›´æ¥ä½¿ç”¨å…·ä½“å¤©æ•°ä½œä¸ºé”®
                                const daysKey = daysDiff === 0 ? 'ä»Šå¤©' : daysDiff === 1 ? 'æ˜¨å¤©' : `${daysDiff}å¤©`;
                                notStartedDaysStats[daysKey] = (notStartedDaysStats[daysKey] || 0) + 1;
                            }
                        } catch (e) {
                            // å¦‚æœæ—¥æœŸè§£æå¤±è´¥ï¼Œå½’ç±»ä¸º"æ—¥æœŸæ— æ•ˆ"
                            notStartedDaysStats['æ—¥æœŸæ— æ•ˆ'] = (notStartedDaysStats['æ—¥æœŸæ— æ•ˆ'] || 0) + 1;
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰æå•æ—¶é—´ï¼Œå½’ç±»ä¸º"æœªè®¾ç½®"
                        notStartedDaysStats['æœªè®¾ç½®'] = (notStartedDaysStats['æœªè®¾ç½®'] || 0) + 1;
                    }
                });

                // å¯¹å¤©æ•°è¿›è¡Œæ’åºï¼Œç¡®ä¿å›¾è¡¨æ˜¾ç¤ºæœ‰åº
                const sortedDays = Object.keys(notStartedDaysStats)
                    .filter(key => key !== 'ä»Šå¤©' && key !== 'æ˜¨å¤©' && key !== 'æ—¥æœŸæ— æ•ˆ' && key !== 'æœªè®¾ç½®')
                    .sort((a, b) => parseInt(a) - parseInt(b));

                // é‡æ–°æ„å»ºæœ‰åºçš„ç»Ÿè®¡æ•°æ®
                const orderedNotStartedDaysStats = {};

                // å…ˆæ·»åŠ ç‰¹æ®Šå€¼
                if (notStartedDaysStats['ä»Šå¤©']) {
                    orderedNotStartedDaysStats['ä»Šå¤©'] = notStartedDaysStats['ä»Šå¤©'];
                }
                if (notStartedDaysStats['æ˜¨å¤©']) {
                    orderedNotStartedDaysStats['æ˜¨å¤©'] = notStartedDaysStats['æ˜¨å¤©'];
                }

                // å†æ·»åŠ æŒ‰å¤©æ•°æ’åºçš„æ•°æ®
                sortedDays.forEach(days => {
                    orderedNotStartedDaysStats[days] = notStartedDaysStats[days];
                });

                // æœ€åæ·»åŠ ç‰¹æ®Šå€¼
                if (notStartedDaysStats['æ—¥æœŸæ— æ•ˆ']) {
                    orderedNotStartedDaysStats['æ—¥æœŸæ— æ•ˆ'] = notStartedDaysStats['æ—¥æœŸæ— æ•ˆ'];
                }
                if (notStartedDaysStats['æœªè®¾ç½®']) {
                    orderedNotStartedDaysStats['æœªè®¾ç½®'] = notStartedDaysStats['æœªè®¾ç½®'];
                }

                // æ›´æ–°å˜é‡å¼•ç”¨
                notStartedDaysStats = orderedNotStartedDaysStats;
            }

            // å®šä¹‰å›¾è¡¨é…ç½®æ•°ç»„
            const chartConfigs = [
                {
                    id: 'categoryChart',
                    title: status === 'not-started' ? 'äº§å“ç±»åˆ«åˆ†å¸ƒ' : status === 'in-progress' ? 'äº§å“ç±»åˆ«åˆ†å¸ƒ' : status === 'completed' ? 'äº§å“ç±»åˆ«åˆ†å¸ƒ' : 'äº§å“ç±»åˆ«åˆ†å¸ƒ',
                    data: categoryStats,
                    icon: 'ğŸ“Š'
                },
                {
                    id: 'leaderChart',
                    title: status === 'not-started' ? 'é¡¹ç›®è´Ÿè´£äººåˆ†å¸ƒ' : status === 'in-progress' ? 'é¡¹ç›®è´Ÿè´£äººåˆ†å¸ƒ' : status === 'completed' ? 'é¡¹ç›®è´Ÿè´£äººåˆ†å¸ƒ' : 'é¡¹ç›®è´Ÿè´£äººåˆ†å¸ƒ',
                    data: leaderStats,
                    icon: 'ğŸ‘¤'
                },
                {
                    id: 'testerChart',
                    title: status === 'not-started' ? 'æµ‹è¯•è´Ÿè´£äººåˆ†å¸ƒ' : status === 'in-progress' ? 'æµ‹è¯•è´Ÿè´£äººåˆ†å¸ƒ' : status === 'completed' ? 'æµ‹è¯•è´Ÿè´£äººåˆ†å¸ƒ' : 'æµ‹è¯•è´Ÿè´£äººåˆ†å¸ƒ',
                    data: testerStats,
                    icon: 'ğŸ§ª'
                },
                {
                    id: 'dqeLeaderChart',
                    title: status === 'not-started' ? 'DQEè´Ÿè´£äººåˆ†å¸ƒ' : status === 'in-progress' ? 'DQEè´Ÿè´£äººåˆ†å¸ƒ' : status === 'completed' ? 'DQEè´Ÿè´£äººåˆ†å¸ƒ' : 'DQEè´Ÿè´£äººåˆ†å¸ƒ',
                    data: dqeLeaderStats,
                    icon: 'ğŸ”'
                },
                {
                    id: 'rdLeaderChart',
                    title: status === 'not-started' ? 'ç ”å‘è´Ÿè´£äººåˆ†å¸ƒ' : status === 'in-progress' ? 'ç ”å‘è´Ÿè´£äººåˆ†å¸ƒ' : status === 'completed' ? 'ç ”å‘è´Ÿè´£äººåˆ†å¸ƒ' : 'ç ”å‘è´Ÿè´£äººåˆ†å¸ƒ',
                    data: rdLeaderStats,
                    icon: 'ğŸ’»'
                },
                {
                    id: 'sampleSenderChart',
                    title: status === 'not-started' ? 'é€æ ·äººåˆ†å¸ƒ' : status === 'in-progress' ? 'é€æ ·äººåˆ†å¸ƒ' : status === 'completed' ? 'é€æ ·äººåˆ†å¸ƒ' : 'é€æ ·äººåˆ†å¸ƒ',
                    data: sampleSenderStats,
                    icon: 'ğŸ“¦'
                },
                {
                    id: 'scheduleChart',
                    title: status === 'not-started' ? 'æ’æœŸå¤©æ•°åˆ†å¸ƒ' : status === 'in-progress' ? 'æ’æœŸå¤©æ•°åˆ†å¸ƒ' : status === 'completed' ? 'æ’æœŸå¤©æ•°åˆ†å¸ƒ' : 'æ’æœŸå¤©æ•°åˆ†å¸ƒ',
                    data: orderedScheduleDaysStats,
                    icon: 'ğŸ“…'
                },
                {
                    id: 'confirmResultChart',
                    title: status === 'not-started' ? 'ç¡®è®¤ç»“æœåˆ†å¸ƒ' : status === 'in-progress' ? 'ç¡®è®¤ç»“æœåˆ†å¸ƒ' : status === 'completed' ? 'ç¡®è®¤ç»“æœåˆ†å¸ƒ' : 'ç¡®è®¤ç»“æœåˆ†å¸ƒ',
                    data: confirmResultStats,
                    icon: 'âœ…'
                }
            ];

            // å¦‚æœæ˜¯æœªå¼€å§‹é¡¹ç›®ï¼Œæ·»åŠ æœªå¼€å§‹å¤©æ•°åˆ†å¸ƒå›¾è¡¨
            if (status === 'not-started') {
                chartConfigs.push({
                    id: 'notStartedDaysChart',
                    title: 'æœªå¼€å§‹å¤©æ•°åˆ†å¸ƒ',
                    data: notStartedDaysStats,
                    icon: 'â°'
                });
            }

            // å°†å›¾è¡¨é…ç½®å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œä¾›åç»­ä½¿ç”¨
            window.currentChartConfigs = chartConfigs;
            window.currentProjects = projects;
            window.currentStatus = status;
            window.currentDisplayLimit = 10; // é»˜è®¤æ˜¾ç¤ºå‰10ç»„æ•°æ®

        } else {
            contentHTML += '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';
        }

        document.getElementById('modalContent').innerHTML = contentHTML;

        // åˆå§‹åŒ–å¯¼èˆªæ å’Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªå›¾è¡¨
        if (projects.length > 0) {
            initializeChartNavigation();
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªå›¾è¡¨
            if (window.currentChartConfigs && window.currentChartConfigs.length > 0) {
                showSelectedChart(0);
            }
        }
    }

        // åˆå§‹åŒ–å›¾è¡¨å¯¼èˆªæ 
        function initializeChartNavigation() {
            const navList = document.getElementById('chartNavList');
            if (!navList || !window.currentChartConfigs) return;

            navList.innerHTML = '';

            window.currentChartConfigs.forEach((config, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'chart-nav-item';
                navItem.style.cssText = `
                padding: 12px 16px;
                background: #fff;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
                navItem.innerHTML = `
                <span style="font-size: 18px;">${config.icon}</span>
                <span style="font-size: 14px; color: #333;">${config.title}</span>
            `;
                navItem.onclick = () => showSelectedChart(index);
                navList.appendChild(navItem);
            });
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„å›¾è¡¨
        function showSelectedChart(index) {
            if (!window.currentChartConfigs || !window.currentChartConfigs[index]) return;

            const config = window.currentChartConfigs[index];
            const displayArea = document.getElementById('chartDisplayArea');

            if (!displayArea) return;

            // æ›´æ–°å¯¼èˆªæ é€‰ä¸­çŠ¶æ€
            const navItems = document.querySelectorAll('.chart-nav-item');
            navItems.forEach((item, i) => {
                if (i === index) {
                    item.style.background = '#007bff';
                    item.style.color = '#fff';
                    item.style.borderColor = '#007bff';
                } else {
                    item.style.background = '#fff';
                    item.style.color = '#333';
                    item.style.borderColor = '#e9ecef';
                }
            });

            // åº”ç”¨æ•°æ®é™åˆ¶
            const limitedData = applyDataLimit(config.data, window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10);

            // æ›´æ–°æ•°æ®ç»„æ•°æ˜¾ç¤º
            const dataCountElement = document.getElementById('currentDataCount');
            if (dataCountElement) {
                const totalCount = Object.keys(config.data).length;
                const displayCount = Object.keys(limitedData).length;
                if (window.currentDisplayLimit === 0) {
                    dataCountElement.textContent = `å…¨éƒ¨(${totalCount})`;
                } else if (displayCount < totalCount) {
                    dataCountElement.textContent = `${displayCount}/${totalCount}...`;
                } else {
                    dataCountElement.textContent = `${displayCount}/${totalCount}`;
                }
            }

            // ç”Ÿæˆå›¾è¡¨HTML
            const chartHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1;">${config.title}</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <!-- å›¾è¡¨æ§åˆ¶æŒ‰é’® -->
                        <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <button class="zoom-btn" onclick="zoomChart('${config.id}', -1)" title="ç¼©å°" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">âˆ’</button>
                            <button class="zoom-btn" onclick="zoomChart('${config.id}', 1)" title="æ”¾å¤§" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                            <button class="zoom-btn" onclick="toggleChartType('${config.id}', '${JSON.stringify(limitedData).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“Š</button>
                        </div>
                        <!-- æ•°æ®ç»„æ•°æ§åˆ¶ -->
                        <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-size: 12px; color: #666; font-weight: 500;">æ•°æ®ç»„æ•°:</span>
                            <select id="chartDisplayLimit" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s;" onchange="updateChartDisplayLimit()" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#ddd'">
                                <option value="10">å‰10ç»„</option>
                                <option value="20">å‰20ç»„</option>
                                <option value="50">å‰50ç»„</option>
                                <option value="0">å…¨éƒ¨æ•°æ®</option>
                            </select>
                            <span id="currentDataCount" style="font-size: 12px; color: #007bff; font-weight: 600; min-width: 40px; text-align: center;">10</span>
                            <button onclick="toggleDisplayMode()" style="background: #007bff; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;" title="å¿«é€Ÿåˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                ğŸ”„
                            </button>
                        </div>
                    </div>
                </div>
                <div id="${config.id}" style="height: 450px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                    ${createBarChart(limitedData, config.id)}
                </div>
            </div>
        `;

            displayArea.innerHTML = chartHTML;

            // ç¡®ä¿selectå…ƒç´ çš„å€¼æ­£ç¡®è®¾ç½®
            const selectElement = document.getElementById('chartDisplayLimit');
            if (selectElement) {
                selectElement.value = window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10;
            }

            // ç»‘å®šå›¾è¡¨äº‹ä»¶
            setTimeout(() => {
                bindChartClickEvents(config.id);
                bindTooltipEvents(config.id);
                updateZoomButtons(config.id, 450);
            }, 100);
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰å›¾è¡¨
        function showCustomChart(chartKey, chartId) {
            const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
            const savedChartsList = savedCharts[chartKey];
            const savedChart = savedChartsList.find(chart => chart.id === chartId);

            if (!savedChart || !window.currentProjects) return;

            const displayArea = document.getElementById('chartDisplayArea');
            if (!displayArea) return;

            // è·å–å›¾è¡¨æ•°æ®
            const chartData = getChartDataFromSavedChart(savedChart, window.currentProjects);

            // å°†è‡ªå®šä¹‰å›¾è¡¨é…ç½®æ·»åŠ åˆ° currentChartConfigs ä¸­ï¼Œä»¥ä¾¿ refreshCurrentChart èƒ½å¤Ÿæ‰¾åˆ°
            const customChartConfig = {
                id: `customChart_${chartId}`,
                title: savedChart.title,
                data: chartData,
                fieldName: savedChart.fieldName,
                fieldLabel: savedChart.fieldLabel,
                chartType: savedChart.chartType,
                topN: savedChart.topN,
                icon: 'ğŸ“Š'
            };
            
            // æ›´æ–° currentChartConfigsï¼Œç¡®ä¿è‡ªå®šä¹‰å›¾è¡¨é…ç½®åœ¨å…¶ä¸­
            if (!window.currentChartConfigs) {
                window.currentChartConfigs = [];
            }
            
            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è‡ªå®šä¹‰å›¾è¡¨é…ç½®
            const existingIndex = window.currentChartConfigs.findIndex(c => c.id === `customChart_${chartId}`);
            if (existingIndex !== -1) {
                window.currentChartConfigs[existingIndex] = customChartConfig;
            } else {
                window.currentChartConfigs.push(customChartConfig);
            }

            // åº”ç”¨æ•°æ®é™åˆ¶
            const limitedData = applyDataLimit(chartData, window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10);

            const chartHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1;">${savedChart.title}</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <!-- å›¾è¡¨æ§åˆ¶æŒ‰é’® -->
                        <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <button class="zoom-btn" onclick="zoomChart('customChart_${chartId}', -1)" title="ç¼©å°" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">âˆ’</button>
                            <button class="zoom-btn" onclick="zoomChart('customChart_${chartId}', 1)" title="æ”¾å¤§" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                            <button class="zoom-btn" onclick="toggleChartType('customChart_${chartId}', '${JSON.stringify(limitedData).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“Š</button>
                        </div>
                        <!-- æ•°æ®ç»„æ•°æ§åˆ¶ -->
                        <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-size: 12px; color: #666; font-weight: 500;">æ•°æ®ç»„æ•°:</span>
                            <select id="chartDisplayLimit" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s;" onchange="updateChartDisplayLimit()" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#ddd'">
                                <option value="10" ${window.currentDisplayLimit === 10 ? 'selected' : ''}>å‰10ç»„</option>
                                <option value="20" ${window.currentDisplayLimit === 20 ? 'selected' : ''}>å‰20ç»„</option>
                                <option value="50" ${window.currentDisplayLimit === 50 ? 'selected' : ''}>å‰50ç»„</option>
                                <option value="0" ${window.currentDisplayLimit === 0 ? 'selected' : ''}>å…¨éƒ¨æ•°æ®</option>
                            </select>
                            <span id="currentDataCount" style="font-size: 12px; color: #007bff; font-weight: 600; min-width: 40px; text-align: center;">${window.currentDisplayLimit === 0 ? `å…¨éƒ¨(${Object.keys(chartData).length})` : (Object.keys(limitedData).length < Object.keys(chartData).length ? `${Object.keys(limitedData).length}/${Object.keys(chartData).length}...` : `${Object.keys(limitedData).length}/${Object.keys(chartData).length}`)}</span>
                            <button onclick="toggleDisplayMode()" style="background: #007bff; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;" title="å¿«é€Ÿåˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                ğŸ”„
                            </button>
                        </div>
                    </div>
                </div>
                <div id="customChart_${chartId}" style="height: 450px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                    ${savedChart.chartType === 'pie' ? createPieChart(limitedData, `customChart_${chartId}`) : createBarChart(limitedData, `customChart_${chartId}`)}
                </div>
            </div>
        `;

            displayArea.innerHTML = chartHTML;

            // ç¡®ä¿selectå…ƒç´ çš„å€¼æ­£ç¡®è®¾ç½®
            const selectElement = document.getElementById('chartDisplayLimit');
            if (selectElement) {
                selectElement.value = window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10;
            }

            // ç»‘å®šå›¾è¡¨äº‹ä»¶
            setTimeout(() => {
                bindChartClickEvents(`customChart_${chartId}`);
                bindTooltipEvents(`customChart_${chartId}`);
                updateZoomButtons(`customChart_${chartId}`, 450);
            }, 100);
        }

        // ä»ä¿å­˜çš„å›¾è¡¨é…ç½®ä¸­è·å–æ•°æ®
        function getChartDataFromSavedChart(savedChart, projects) {
            if (!savedChart || !projects) return {};

            // ç»Ÿè®¡æ•°æ®
            const stats = {};
            projects.forEach(project => {
                let value = project[savedChart.fieldName];

                // å¤„ç†ä¸åŒç±»å‹çš„å€¼ï¼ˆä¸generateDynamicChartä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
                if (value === null || value === undefined || value === '') {
                    value = 'æœªè®¾ç½®';
                } else if (savedChart.fieldName === 'scheduleDays') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å¤©';
                } else if (savedChart.fieldName === 'testDuration') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å°æ—¶';
                } else if (savedChart.fieldName === 'sample_frequency') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'æ¬¡';
                } else if (savedChart.fieldName === 'isUsed') {
                    value = value === 1 ? 'å·²ç”¨' : value === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
                } else if (savedChart.fieldName === 'isCancel') {
                    value = value === 1 ? 'å·²ä½œåºŸ' : value === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
                } else if (savedChart.fieldName === 'high_frequency') {
                    value = value === '1' || value === 1 ? 'æ˜¯' : value === '0' || value === 0 ? 'å¦' : value || 'æœªè®¾ç½®';
                } else if (savedChart.fieldName.includes('date') || savedChart.fieldName.includes('time') || savedChart.fieldName === 'reportReviewTime') {
                    if (value && value !== 'æœªè®¾ç½®') {
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                value = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            value = 'æ— æ•ˆæ—¥æœŸ';
                        }
                    }
                } else if (savedChart.fieldName === 'priority') {
                    if (value && value.trim() !== '') {
                        value = value.trim();
                    } else {
                        value = 'æœªè®¾ç½®';
                    }
                } else if (savedChart.fieldName === 'schedule') {
                    if (value !== null && value !== undefined && value !== '') {
                        const progressMap = {
                            '0': 'æœªå¼€å§‹',
                            '1': 'è¿›è¡Œä¸­',
                            '2': 'å·²å®Œæˆæœªç¡®è®¤',
                            '3': 'æŠ¥å‘Šç¡®è®¤é—­ç¯'
                        };
                        value = progressMap[value.toString()] || `è¿›åº¦${value}`;
                    } else {
                        value = 'æœªè®¾ç½®';
                    }
                } else if (savedChart.fieldName === 'sample_type') {
                    if (value && value.trim() !== '') {
                        value = value.trim();
                    } else {
                        value = 'æœªè®¾ç½®';
                    }
                }

                stats[value] = (stats[value] || 0) + 1;
            });

            // æ’åºå¹¶å–å‰Nä¸ª
            let sortedStats;

            // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¶é—´å­—æ®µï¼Œå¦‚æœæ˜¯åˆ™æŒ‰æ—¶é—´é¡ºåºæ’åº
            if (savedChart.fieldName.includes('date') || savedChart.fieldName.includes('time') || savedChart.fieldName === 'reportReviewTime') {
                // å¯¹æ—¶é—´å­—æ®µæŒ‰æ—¶é—´é¡ºåºæ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
                sortedStats = Object.entries(stats)
                    .filter(([key]) => key !== 'æœªè®¾ç½®' && key !== 'æ— æ•ˆæ—¥æœŸ') // å…ˆè¿‡æ»¤æ‰ç‰¹æ®Šå€¼
                    .sort((a, b) => {
                        // å°è¯•è§£ææ—¥æœŸè¿›è¡Œæ¯”è¾ƒ
                        try {
                            const dateA = new Date(a[0]);
                            const dateB = new Date(b[0]);
                            if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                                return dateA - dateB; // æŒ‰æ—¶é—´ä»æ—©åˆ°æ™šæ’åº
                            }
                            return a[0].localeCompare(b[0]); // å¦‚æœè§£æå¤±è´¥ï¼ŒæŒ‰å­—ç¬¦ä¸²æ’åº
                        } catch (e) {
                            return a[0].localeCompare(b[0]);
                        }
                    })
                    .slice(0, savedChart.topN);

                // å¦‚æœæœ‰ç‰¹æ®Šå€¼ï¼Œæ·»åŠ åˆ°æœ«å°¾
                if (stats['æœªè®¾ç½®']) {
                    sortedStats.push(['æœªè®¾ç½®', stats['æœªè®¾ç½®']]);
                }
                if (stats['æ— æ•ˆæ—¥æœŸ']) {
                    sortedStats.push(['æ— æ•ˆæ—¥æœŸ', stats['æ— æ•ˆæ—¥æœŸ']]);
                }
            } else {
                // éæ—¶é—´å­—æ®µæŒ‰å€¼ä»é«˜åˆ°ä½æ’åº
                sortedStats = Object.entries(stats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, savedChart.topN);
            }

            // é‡æ–°æ„å»ºç»Ÿè®¡æ•°æ®
            const finalStats = {};
            sortedStats.forEach(([key, value]) => {
                finalStats[key] = value;
            });

            return finalStats;
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†æ•°æ®åˆ—è¡¨
        function showModalDataList(title, projects, status, preserveValues = false) {
            // ä¿å­˜å½“å‰è¿‡æ»¤å™¨çš„å€¼
            let currentFilters = {};
            if (preserveValues) {
                const categoryFilter = document.getElementById('modalCategoryFilter');
                const testerFilter = document.getElementById('modalTesterFilter');
                const leaderFilter = document.getElementById('modalLeaderFilter');
                const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
                const startDateInput = document.getElementById('modalStartDate');
                const endDateInput = document.getElementById('modalEndDate');

                if (categoryFilter) currentFilters.category = categoryFilter.value;
                if (testerFilter) currentFilters.tester = testerFilter.value;
                if (leaderFilter) currentFilters.leader = leaderFilter.value;
                if (scheduleDaysFilter) currentFilters.scheduleDays = scheduleDaysFilter.value;
                if (startDateInput) currentFilters.startDate = startDateInput.value;
                if (endDateInput) currentFilters.endDate = endDateInput.value;
            }

            let contentHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">è¯¦ç»†æ•°æ®åˆ—è¡¨</h3>
                    <p>å…±æ‰¾åˆ° <strong>${projects.length}</strong> ä¸ªé¡¹ç›®</p>
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">ç±»åˆ«:</label>
                            <select class="filter-input" id="modalCategoryFilter">
                                <option value="">æ‰€æœ‰ç±»åˆ«</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">æµ‹è¯•è´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalTesterFilter">
                                <option value="">æ‰€æœ‰æµ‹è¯•è´Ÿè´£äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">é¡¹ç›®è´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalLeaderFilter">
                                <option value="">æ‰€æœ‰é¡¹ç›®è´Ÿè´£äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">DQEè´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalDqeLeaderFilter">
                                <option value="">æ‰€æœ‰DQEè´Ÿè´£äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">ç ”å‘è´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalRdLeaderFilter">
                                <option value="">æ‰€æœ‰ç ”å‘è´Ÿè´£äºº</option>
                            </select>
                        </div>
                         <div style="display: flex; gap: 10px; align-items: center;">
                             <label style="font-size: 14px; color: #333;">é€æ ·äºº:</label>
                             <select class="filter-input" id="modalSampleSenderFilter">
                                 <option value="">æ‰€æœ‰é€æ ·äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">æ’æœŸå¤©æ•°:</label>
                            <select class="filter-input" id="modalScheduleDaysFilter">
                                <option value="">æ‰€æœ‰æ’æœŸå¤©æ•°</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">æå•æ—¶é—´:</label>
                            <input type="date" class="filter-input" id="modalStartDate" placeholder="å¼€å§‹æ—¥æœŸ">
                            <span style="color: #666;">è‡³</span>
                            <input type="date" class="filter-input" id="modalEndDate" placeholder="ç»“æŸæ—¥æœŸ">
                        </div>
                        <button class="filter-btn" onclick="applyModalFilters()">ç­›é€‰</button>
                        <button class="filter-btn" onclick="resetModalFilters()">é‡ç½®</button>
                    </div>
                </div>
            `;

            if (projects.length > 0) {
                contentHTML += `
                    <table class="project-table">
                        <thead>
                            <tr>
                                <th>æ ·å“ç¼–å·</th>
                                <th>äº§å“åç§°</th>
                                <th>äº§å“ç±»åˆ«</th>
                                <th>å¤§ç¼–ç </th>
                                <th>ç‰©æ–™ç¼–ç </th>
                                <th>ç‰ˆæœ¬</th>
                                <th>é¡¹ç›®è´Ÿè´£äºº</th>
                                <th>å½“å‰è¿›åº¦</th>
                                <th>æµ‹è¯•è´Ÿè´£äºº</th>
                                <th>DQEè´Ÿè´£äºº</th>
                                <th>ç ”å‘è´Ÿè´£äºº</th>
                                <th>é€æ ·äºº</th>
                                <th>é€æ ·ç±»åˆ«</th>
                                <th>é€æ ·æ•°é‡</th>
                                <th>æ˜¯å¦é«˜é¢‘</th>
                                <th>æå•æ—¶é—´</th>
                                <th>æ’æœŸå¤©æ•°</th>
                                <th>æ’æœŸå¼€å§‹</th>
                                <th>æ’æœŸç»“æŸ</th>
                                <th>å®é™…å¼€å§‹æ—¶é—´</th>
                                <th>å®é™…å®Œæˆæ—¶é—´</th>
                                <th>DQEæ‰¿è®¤ç»“æœ</th>
                                <th>ç ”å‘æ‰¿è®¤ç»“æœ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                projects.forEach(project => {
                    const isOverdue = project.schedule_end_date && project.schedule !== 'å·²å®Œæˆ' &&
                        new Date(project.schedule_end_date) < new Date();

                    // æ ¹æ®å®é™…æ—¶é—´åˆ¤æ–­é¡¹ç›®çŠ¶æ€
                    let statusText = 'æœªå¼€å§‹';
                    let statusColor = '#ffc107';

                    if (project.actual_start_time && !project.actual_finish_time) {
                        statusText = 'è¿›è¡Œä¸­';
                        statusColor = '#17a2b8';
                    } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                        statusText = 'å·²å®Œæˆæœªç¡®è®¤';
                        statusColor = '#a72828';
                    } else if (project.actual_finish_time && project.sampleRecognizeResult) {
                        statusText = 'æŠ¥å‘Šç¡®è®¤é—­ç¯';
                        statusColor = '#28a745';
                    }

                    contentHTML += `
                        <tr style="${(isOverdue && !project.sampleRecognizeResult) ? 'background-color: #ffe6e6;' : ''}">
                            <td><strong>${project.sample_id || '-'}</strong></td>
                            <td>${project.sample_name || '-'}</td>
                            <td>${project.sample_category || '-'}</td>
                            <td>${project.sample_model || '-'}</td>
                            <td>${project.materialCode || '-'}</td>
                            <td>${project.version || '-'}</td>
                            <td>${project.sample_leader || '-'}</td>
                            <td>
                                <span style="color: ${statusColor}; font-weight: bold;">
                                    ${statusText}
                                </span>
                            </td>
                            <td>${project.tester || '-'}</td>
                            <td>${project.dqe_leader || '-'}</td>
                            <td>${project.rd_leader || '-'}</td>
                            <td>${project.sample_sender || '-'}</td>
                            <td>${project.sample_type || '-'}</td>
                            <td>${project.sample_quantity || '-'}</td>
                            <td>${project.high_frequency || '-'}</td>
                            <td>${formatDateTime(project.create_time) || '-'}</td>
                            <td>${project.scheduleDays || '-'}</td>
                            <td>${formatDate(project.schedule_start_date) || '-'}</td>
                            <td style="${(isOverdue && !project.sampleRecognizeResult) ? 'color: red; font-weight: bold;' : ''}">
                                ${formatDate(project.schedule_end_date) || '-'}
                            </td>
                            <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                            <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                            <td>${project.sampleRecognizeResult || '-'}</td>
                            <td>${project.sampleRecognizeResult || '-'}</td>
                            <td>${project.rd_sampleRecognizeResult || '-'}</td>
                        </tr>
                    `;
                });

                contentHTML += '</tbody></table>';
            }

            document.getElementById('modalContent').innerHTML = contentHTML;

            // å¡«å……è¿‡æ»¤å™¨é€‰é¡¹
            populateModalFilters(projects);

            // æ¢å¤è¿‡æ»¤å™¨çš„å€¼
            if (preserveValues && Object.keys(currentFilters).length > 0) {
                setTimeout(() => {
                    const categoryFilter = document.getElementById('modalCategoryFilter');
                    const testerFilter = document.getElementById('modalTesterFilter');
                    const leaderFilter = document.getElementById('modalLeaderFilter');
                    const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
                    const startDateInput = document.getElementById('modalStartDate');
                    const endDateInput = document.getElementById('modalEndDate');

                    if (categoryFilter && currentFilters.category) categoryFilter.value = currentFilters.category;
                    if (testerFilter && currentFilters.tester) testerFilter.value = currentFilters.tester;
                    if (leaderFilter && currentFilters.leader) leaderFilter.value = currentFilters.leader;
                    if (scheduleDaysFilter && currentFilters.scheduleDays) scheduleDaysFilter.value = currentFilters.scheduleDays;
                    if (startDateInput && currentFilters.startDate) startDateInput.value = currentFilters.startDate;
                    if (endDateInput && currentFilters.endDate) endDateInput.value = currentFilters.endDate;
                }, 100);
            }
        }

        // å¡«å……æ¨¡æ€æ¡†è¿‡æ»¤å™¨é€‰é¡¹
        function populateModalFilters(projects) {
            // å¡«å……ç±»åˆ«è¿‡æ»¤å™¨
            const categories = [...new Set(projects.map(p => p.sample_category).filter(cat => cat && cat.trim() !== ''))];
            const categoryFilter = document.getElementById('modalCategoryFilter');
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="">æ‰€æœ‰ç±»åˆ«</option>';
                categories.forEach(category => {
                    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                });
                // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªåˆ†ç±»"é€‰é¡¹
                if (projects.some(p => !p.sample_category || p.sample_category.trim() === '')) {
                    categoryFilter.innerHTML += '<option value="">æœªåˆ†ç±»</option>';
                }
            }

            // å¡«å……æµ‹è¯•è´Ÿè´£äººè¿‡æ»¤å™¨
            const testers = [...new Set(projects.map(p => p.tester).filter(tester => tester && tester.trim() !== ''))];
            const testerFilter = document.getElementById('modalTesterFilter');
            if (testerFilter) {
                testerFilter.innerHTML = '<option value="">æ‰€æœ‰æµ‹è¯•è´Ÿè´£äºº</option>';
                testers.forEach(tester => {
                    testerFilter.innerHTML += `<option value="${tester}">${tester}</option>`;
                });
                // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
                if (projects.some(p => !p.tester || p.tester.trim() === '')) {
                    testerFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
                }
            }

            // å¡«å……é¡¹ç›®è´Ÿè´£äººè¿‡æ»¤å™¨
            const leaders = [...new Set(projects.map(p => p.sample_leader).filter(leader => leader && leader.trim() !== ''))];
            const leaderFilter = document.getElementById('modalLeaderFilter');
            if (leaderFilter) {
                leaderFilter.innerHTML = '<option value="">æ‰€æœ‰é¡¹ç›®è´Ÿè´£äºº</option>';
                leaders.forEach(leader => {
                    leaderFilter.innerHTML += `<option value="${leader}">${leader}</option>`;
                });
                // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
                if (projects.some(p => !p.sample_leader || p.sample_leader.trim() === '')) {
                    leaderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
                }
            }

            // å¡«å……DQEè´Ÿè´£äººè¿‡æ»¤å™¨
            const dqeLeaders = [...new Set(projects.map(p => p.dqe_leader).filter(dqeLeader => dqeLeader && dqeLeader.trim() !== ''))];
            const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
            if (dqeLeaderFilter) {
                dqeLeaderFilter.innerHTML = '<option value="">æ‰€æœ‰DQEè´Ÿè´£äºº</option>';
                dqeLeaders.forEach(dqeLeader => {
                    dqeLeaderFilter.innerHTML += `<option value="${dqeLeader}">${dqeLeader}</option>`;
                });
                // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
                if (projects.some(p => !p.dqe_leader || p.dqe_leader.trim() === '')) {
                    dqeLeaderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
                }
            }

            // å¡«å……ç ”å‘è´Ÿè´£äººè¿‡æ»¤å™¨
            const rdLeaders = [...new Set(projects.map(p => p.rd_leader).filter(rdLeader => rdLeader && rdLeader.trim() !== ''))];
            const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
            if (rdLeaderFilter) {
                rdLeaderFilter.innerHTML = '<option value="">æ‰€æœ‰ç ”å‘è´Ÿè´£äºº</option>';
                rdLeaders.forEach(rdLeader => {
                    rdLeaderFilter.innerHTML += `<option value="${rdLeader}">${rdLeader}</option>`;
                });
                // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
                if (projects.some(p => !p.rd_leader || p.rd_leader.trim() === '')) {
                    rdLeaderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
                }
            }

            // å¡«å……é€æ ·äººè¿‡æ»¤å™¨
            const sampleSenders = [...new Set(projects.map(p => p.sample_sender).filter(sender => sender && sender.trim() !== ''))];
            const sampleSenderFilter = document.getElementById('modalSampleSenderFilter');
            if (sampleSenderFilter) {
                sampleSenderFilter.innerHTML = '<option value="">æ‰€æœ‰é€æ ·äºº</option>';
                sampleSenders.forEach(sender => {
                    sampleSenderFilter.innerHTML += `<option value="${sender}">${sender}</option>`;
                });
                // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
                if (projects.some(p => !p.sample_sender || p.sample_sender.trim() === '')) {
                    sampleSenderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
                }
            }

            // å¡«å……æ’æœŸå¤©æ•°è¿‡æ»¤å™¨
            const scheduleDays = [...new Set(projects.map(p => p.scheduleDays).filter(days => days && !isNaN(days)))];
            const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
            if (scheduleDaysFilter) {
                scheduleDaysFilter.innerHTML = '<option value="">æ‰€æœ‰æ’æœŸå¤©æ•°</option>';
                scheduleDays.sort((a, b) => parseInt(a) - parseInt(b));
                scheduleDays.forEach(days => {
                    scheduleDaysFilter.innerHTML += `<option value="${days}">${days}å¤©</option>`;
                });
                // æ·»åŠ "æœªè®¾ç½®"é€‰é¡¹
                if (projects.some(p => !p.scheduleDays || isNaN(p.scheduleDays))) {
                    scheduleDaysFilter.innerHTML += '<option value="æœªè®¾ç½®">æœªè®¾ç½®</option>';
                }
            }
        }

        // åˆ›å»ºé¥¼å›¾
        function createPieChart(data, containerId) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

            if (labels.length === 0) return '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';

            const total = values.reduce((a, b) => a + b, 0);
            if (total === 0) return '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';

            // åˆ›å»ºSVGé¥¼å›¾
            const radius = 100;
            const centerX = 125;
            const centerY = 125;

            let chartHTML = `
                    <div style="position: relative; width: 250px; height: 250px; margin: 0 auto;">
                        <svg width="250" height="250" viewBox="0 0 250 250">
                `;

            let currentAngle = 0;
            labels.forEach((label, index) => {
                const value = values[index];
                const percentage = (value / total) * 100;
                const angle = (value / total) * 360;

                if (angle > 0) {
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + angle;

                    // è®¡ç®—å¼§çº¿è·¯å¾„
                    const startX = centerX + radius * Math.cos(startAngle * Math.PI / 180);
                    const startY = centerY + radius * Math.sin(startAngle * Math.PI / 180);
                    const endX = centerX + radius * Math.cos(endAngle * Math.PI / 180);
                    const endY = centerY + radius * Math.sin(endAngle * Math.PI / 180);

                    // åˆ¤æ–­æ˜¯å¦éœ€è¦ç»˜åˆ¶å¤§å¼§çº¿
                    const largeArcFlag = angle > 180 ? 1 : 0;

                    const pathData = `M ${centerX} ${centerY} L ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;

                    // ä¸ºæ¯ä¸ªæ‰‡å½¢æ·»åŠ é¼ æ ‡äº‹ä»¶å’Œtooltip
                    const segmentId = `segment_${containerId}_${index}`;

                    // æ£€æŸ¥æ˜¯å¦ä¸ºä¿å­˜çš„å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    const isSavedChart = containerId.startsWith('savedChart_');
                    const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

                    chartHTML += `
                        <path id="${segmentId}" d="${pathData}" fill="${colors[index % colors.length]}" stroke="white" stroke-width="2"
                              style="cursor: pointer;"
                              data-label="${label}"
                              data-value="${value}"
                              onmouseover="showSegmentTooltip(event, '${label}', ${value}, ${percentage.toFixed(1)})"
                              onmouseout="hideSegmentTooltip()"
                              ${clickEvent}/>
                    `;

                    // åªæœ‰å½“æ‰‡å½¢è¶³å¤Ÿå¤§æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼ˆè§’åº¦å¤§äº15åº¦ï¼‰
                    if (angle > 15) {
                        // åœ¨æ‰‡å½¢ä¸­å¿ƒä½ç½®æ·»åŠ æ ‡ç­¾
                        const midAngle = startAngle + angle / 2;
                        const labelRadius = radius * 0.5; // æ ‡ç­¾ä½ç½®åœ¨æ‰‡å½¢ä¸­å¿ƒæ›´å†…ï¼Œé¿å…è¢«è¾¹ç¼˜é®æŒ¡
                        const labelX = centerX + labelRadius * Math.cos(midAngle * Math.PI / 180);
                        const labelY = centerY + labelRadius * Math.sin(midAngle * Math.PI / 180);

                        // è®¡ç®—æ–‡æœ¬é”šç‚¹ï¼Œç¡®ä¿æ–‡æœ¬åœ¨æ‰‡å½¢ä¸­å¿ƒ
                        let textAnchor = 'middle';
                        let dominantBaseline = 'middle';

                        // æ ¹æ®è§’åº¦è°ƒæ•´æ–‡æœ¬ä½ç½®ï¼Œé¿å…é‡å 
                        if (midAngle > 45 && midAngle < 135) {
                            dominantBaseline = 'hanging'; // ä¸ŠåŠéƒ¨åˆ†
                        } else if (midAngle > 225 && midAngle < 315) {
                            dominantBaseline = 'auto'; // ä¸‹åŠéƒ¨åˆ†
                        }

                        if (midAngle > 90 && midAngle < 270) {
                            textAnchor = 'end'; // å·¦åŠéƒ¨åˆ†
                        } else {
                            textAnchor = 'start'; // å³åŠéƒ¨åˆ†
                        }

                        // æ·»åŠ æ ‡ç­¾æ–‡æœ¬ï¼Œè¿™é‡Œæ˜¯é¥¼çŠ¶å›¾ä¸Šçš„å­—ä½“
                        chartHTML += `
                        <text x="${labelX}" y="${labelY}"
                              text-anchor="${textAnchor}"
                              dominant-baseline="${dominantBaseline}"
                              fill="white"
                              font-size="12"
                              font-weight="bold"
                              stroke="gray"
                              style="pointer-events: none; font-family: 'Microsoft YaHei', Arial, sans-serif;">
                            ${label}
                        </text>
                    `;

                        // æ·»åŠ æ•°å€¼
                        const valueRadius = radius * 0.3; // æ•°å€¼ä½ç½®åœ¨æ‰‡å½¢ä¸­å¿ƒæ›´å†…ï¼Œé¿å…è¢«è¾¹ç¼˜é®æŒ¡
                        const valueX = centerX + valueRadius * Math.cos(midAngle * Math.PI / 180);
                        const valueY = centerY + valueRadius * Math.sin(midAngle * Math.PI / 180);

                        chartHTML += `
                        <text x="${valueX}" y="${valueY}"
                              text-anchor="middle"
                              dominant-baseline="middle"
                              fill="white"
                              font-size="12"
                              font-weight="bold"
                              stroke="black"
                              stroke-width="1"
                              style="pointer-events: none; font-family: 'Microsoft YaHei', Arial, sans-serif;">
                            ${value}
                        </text>
                    `;
                    }

                    currentAngle = endAngle;
                }
            });

            chartHTML += '</svg>';

            // æ·»åŠ tooltipå®¹å™¨
            chartHTML += `
                <div id="tooltip_${containerId}" style="
                    position: fixed;
                    display: none;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    pointer-events: none;
                    z-index: 1000;
                    white-space: nowrap;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                "></div>
            `;

            chartHTML += '</div>';

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºçœç•¥å·
            const originalData = window.currentChartConfigs ?
                window.currentChartConfigs.find(c => c.id === containerId)?.data : null;
            const hasMoreData = originalData && Object.keys(originalData).length > labels.length;

            if (hasMoreData) {
                chartHTML += `
                <div style="margin-top: 15px; text-align: center;">
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 16px; border-radius: 20px; border: 1px solid #e9ecef; color: #6c757d; font-size: 12px;">
                        <span>â‹¯</span>
                        <span>è¿˜æœ‰ ${Object.keys(originalData).length - labels.length} ç»„æ•°æ®æœªæ˜¾ç¤º</span>
                        <span>â‹¯</span>
                    </div>
                </div>
            `;
            }

            return chartHTML;
        }

        // åˆ›å»ºæŸ±çŠ¶å›¾
        function createBarChart(data, containerId) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            const maxValue = Math.max(...values);
            const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

            if (labels.length === 0) return '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';

            // åˆ›å»ºæ ‡ç­¾å’Œå€¼çš„é…å¯¹æ•°ç»„ï¼Œå¹¶æŒ‰å€¼ä»é«˜åˆ°ä½æ’åº
            const sortedData = labels.map((label, index) => ({
                label: label,
                value: values[index],
                color: colors[index % colors.length]
            })).sort((a, b) => b.value - a.value);

            // æ ¹æ®æŸ±å­æ•°é‡è°ƒæ•´å¸ƒå±€
            const isManyBars = labels.length > 8;
            const barWidth = isManyBars ? 35 : 50;
            //  ä¸‹è¾¹è¿™ä¸ªæ˜¯ä¿®æ”¹æŸ±çŠ¶å›¾æ ‡ç­¾ä¹‹é—´çš„é—´è·çš„
            const barSpacing = isManyBars ? 15 : 25;

            // è®¡ç®—æ€»å®½åº¦ï¼Œç¡®ä¿æŸ±å­èƒ½å¤Ÿå±…ä¸­æ˜¾ç¤º
            const totalWidth = sortedData.length * (barWidth + barSpacing) - barSpacing;

            let chartHTML = `<div style="display: flex; flex-direction: column; align-items: center; height: 280px; padding: 20px; overflow-x: auto;">
                <div style="display: flex; align-items: end; justify-content: center; gap: ${barSpacing}px; width: ${totalWidth}px;">`;

            sortedData.forEach((item, index) => {
                const height = maxValue > 0 ? (item.value / maxValue) * 180 : 0;

                // æ£€æŸ¥æ˜¯å¦ä¸ºä¿å­˜çš„å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const isSavedChart = containerId.startsWith('savedChart_');
                const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center; width: ${barWidth}px;">
                        <div style="width: ${barWidth}px; height: ${height}px; background: ${item.color}; border-radius: 6px 6px 0 0; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: ${isManyBars ? '14px' : '16px'}; cursor: pointer; transition: all 0.2s ease;"
                             data-label="${item.label}"
                             data-value="${item.value}"
                             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
                             ${clickEvent}>
                            ${item.value}
                        </div>
                        <div style="font-size: ${isManyBars ? '12px' : '14px'}; color: #666; max-width: ${barWidth + 10}px; word-wrap: break-word; text-align: center; height: 40px; display: flex; align-items: center; justify-content: center; line-height: 1.2;">
                            ${item.label}
                        </div>
                    </div>
                `;
            });

            chartHTML += '</div>';

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºçœç•¥å·
            const originalData = window.currentChartConfigs ?
                window.currentChartConfigs.find(c => c.id === containerId)?.data : null;
            const hasMoreData = originalData && Object.keys(originalData).length > sortedData.length;

            if (hasMoreData) {
                chartHTML += `
                <div style="margin-top: 15px; text-align: center;">
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 16px; border-radius: 20px; border: 1px solid #e9ecef; color: #6c757d; font-size: 12px;">
                        <span>â‹¯</span>
                        <span>è¿˜æœ‰ ${Object.keys(originalData).length - sortedData.length} ç»„æ•°æ®æœªæ˜¾ç¤º</span>
                        <span>â‹¯</span>
                    </div>
                </div>
            `;
            }

            chartHTML += '</div>';
            return chartHTML;
        }

        // åˆ›å»ºæŠ˜çº¿å›¾
        function createLineChart(data, containerId) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            const maxValue = Math.max(...values);
            const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

            if (labels.length === 0) return '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';

            // åˆ›å»ºæ ‡ç­¾å’Œå€¼çš„é…å¯¹æ•°ç»„ï¼Œå¹¶æŒ‰å€¼ä»é«˜åˆ°ä½æ’åº
            const sortedData = labels.map((label, index) => ({
                label: label,
                value: values[index],
                color: colors[index % colors.length]
            })).sort((a, b) => b.value - a.value);

            // æŠ˜çº¿å›¾å‚æ•°
            const chartWidth = 400;
            const chartHeight = 250;
            const padding = 40;
            const plotWidth = chartWidth - 2 * padding;
            const plotHeight = chartHeight - 2 * padding;

            // æ£€æŸ¥æ˜¯å¦ä¸ºä¿å­˜çš„å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const isSavedChart = containerId.startsWith('savedChart_');
            const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

            let chartHTML = `
            <div style="position: relative; width: ${chartWidth}px; height: ${chartHeight}px; margin: 0 auto;">
                <svg width="${chartWidth}" height="${chartHeight}" viewBox="0 0 ${chartWidth} ${chartHeight}">
                    <!-- èƒŒæ™¯ç½‘æ ¼çº¿ -->
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" opacity="0.3"/>

                    <!-- Yè½´æ ‡ç­¾ -->
                    <g font-family="Arial, sans-serif" font-size="12" fill="#666">
                        ${Array.from({length: 6}, (_, i) => {
                const value = (maxValue / 5) * (5 - i);
                const y = padding + (plotHeight / 5) * i;
                return `<text x="${padding - 10}" y="${y + 4}" text-anchor="end">${Math.round(value)}</text>`;
            }).join('')}
                    </g>

                    <!-- Xè½´æ ‡ç­¾ -->
                    <g font-family="Arial, sans-serif" font-size="12" fill="#666">
                        ${sortedData.map((item, index) => {
                const x = padding + (plotWidth / (sortedData.length - 1)) * index;
                const label = item.label.length > 8 ? item.label.substring(0, 8) + '...' : item.label;
                return `<text x="${x}" y="${chartHeight - padding + 20}" text-anchor="middle">${label}</text>`;
            }).join('')}
                    </g>

                    <!-- åæ ‡è½´ -->
                    <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${chartHeight - padding}" stroke="#333" stroke-width="2"/>
                    <line x1="${padding}" y1="${chartHeight - padding}" x2="${chartWidth - padding}" y2="${chartHeight - padding}" stroke="#333" stroke-width="2"/>

                    <!-- æŠ˜çº¿è·¯å¾„ -->
                    <path d="${sortedData.map((item, index) => {
                const x = padding + (plotWidth / (sortedData.length - 1)) * index;
                const y = chartHeight - padding - (item.value / maxValue) * plotHeight;
                return `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
            }).join(' ')}"
                          fill="none"
                          stroke="#36A2EB"
                          stroke-width="3"
                          stroke-linecap="round"
                          stroke-linejoin="round"/>

                    <!-- æ•°æ®ç‚¹ -->
                    ${sortedData.map((item, index) => {
                const x = padding + (plotWidth / (sortedData.length - 1)) * index;
                const y = chartHeight - padding - (item.value / maxValue) * plotHeight;
                return `<circle cx="${x}" cy="${y}" r="6" fill="#36A2EB" stroke="white" stroke-width="2"
                                style="cursor: pointer; transition: all 0.2s ease;"
                                data-label="${item.label}"
                                data-value="${item.value}"
                                onmouseover="this.style.r='8'; this.style.fill='#FF6384'"
                                onmouseout="this.style.r='6'; this.style.fill='#36A2EB'"
                                ${clickEvent}/>`;
            }).join('')}
                </svg>
            </div>
        `;

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºçœç•¥å·
            const originalData = window.currentChartConfigs ?
                window.currentChartConfigs.find(c => c.id === containerId)?.data : null;
            const hasMoreData = originalData && Object.keys(originalData).length > sortedData.length;

            if (hasMoreData) {
                chartHTML += `
                <div style="margin-top: 15px; text-align: center;">
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 16px; border-radius: 20px; border: 1px solid #e9ecef; color: #6c757d; font-size: 12px;">
                        <span>â‹¯</span>
                        <span>è¿˜æœ‰ ${Object.keys(originalData).length - sortedData.length} ç»„æ•°æ®æœªæ˜¾ç¤º</span>
                        <span>â‹¯</span>
                    </div>
                </div>
            `;
            }

            return chartHTML;
        }

        // å…³é—­é¡¹ç›®æ¨¡æ€æ¡†
        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
            // æ¢å¤é¡µé¢æ»šåŠ¨
            unlockPageScroll();
        }

        // è·å–çŠ¶æ€é¢œè‰²
        function getStatusColor(status) {
            switch(status) {
                case 'æœªå¼€å§‹': return '#ffc107';
                case 'è¿›è¡Œä¸­': return '#17a2b8';
                case 'å·²å®Œæˆ': return '#28a745';
                default: return '#6c757d';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            try {
                const date = new Date(dateTimeStr);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('projectModal');
            if (event.target === modal) {
                modal.style.display = 'none';
                // æ¢å¤é¡µé¢æ»šåŠ¨
                unlockPageScroll();
            }
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('projectModal');
            if (event.key === 'Escape' && modal.style.display === 'block') {
                closeProjectModal();
            }
        });

        // å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆæ¯5åˆ†é’Ÿï¼‰
        setInterval(loadProjectData, 5 * 60 * 1000);

        // æ˜¾ç¤ºæ‰‡å½¢tooltip
        function showSegmentTooltip(event, label, value, percentage) {
            const tooltip = document.querySelector('[id^="tooltip_"]');
            if (tooltip) {
                tooltip.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">${label}</div>
                    <div>æ•°é‡: ${value}</div>
                    <div>å æ¯”: ${percentage}%</div>
                `;
                tooltip.style.display = 'block';

                // è·å–é¼ æ ‡ä½ç½®
                const mouseX = event.clientX;
                const mouseY = event.clientY;

                // è·å–tooltipå°ºå¯¸
                const tooltipRect = tooltip.getBoundingClientRect();
                const tooltipWidth = tooltipRect.width;
                const tooltipHeight = tooltipRect.height;

                // è·å–è§†å£å°ºå¯¸
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // è®¡ç®—tooltipä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†å£è¾¹ç•Œ
                let left = mouseX + 15; // é¼ æ ‡å³ä¾§15px
                let top = mouseY - tooltipHeight - 10; // é¼ æ ‡ä¸Šæ–¹10px

                // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œåˆ™æ˜¾ç¤ºåœ¨é¼ æ ‡å·¦ä¾§
                if (left + tooltipWidth > viewportWidth) {
                    left = mouseX - tooltipWidth - 15;
                }

                // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œåˆ™æ˜¾ç¤ºåœ¨é¼ æ ‡ä¸‹æ–¹
                if (top < 0) {
                    top = mouseY + 15;
                }

                // ç¡®ä¿ä¸è¶…å‡ºå·¦è¾¹ç•Œ
                if (left < 0) {
                    left = 10;
                }

                // ç¡®ä¿ä¸è¶…å‡ºä¸‹è¾¹ç•Œ
                if (top + tooltipHeight > viewportHeight) {
                    top = viewportHeight - tooltipHeight - 10;
                }

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }
        }

        // éšè—æ‰‡å½¢tooltip
        function hideSegmentTooltip() {
            const tooltip = document.querySelector('[id^="tooltip_"]');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        // ç‚¹å‡»å›¾è¡¨å…ƒç´ è·³è½¬åˆ°å¯¹åº”æ•°æ®åˆ—è¡¨
        function filterByChartSegment(chartId, label, value) {
            // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
            const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
            let originalProjects = [];

            // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
            switch(modalTitle) {
                case 'é¡¹ç›®æ€»æ•°':
                    originalProjects = projectData;
                    break;
                case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p => {
                        // ç‰¹æ®Šå¤„ç†ï¼šé«˜é¢‘é¡¹ç›®ä¸”æµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿçš„æƒ…å†µ
                        if (p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')) {
                            // éœ€è¦æ»¡è¶³æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                            if (p.schedule_end_date) {
                                const today = new Date();
                                const scheduleEndDate = new Date(p.schedule_end_date);
                                const nextDay = new Date(scheduleEndDate);
                                nextDay.setDate(nextDay.getDate() + 1);
                                nextDay.setHours(0, 0, 0, 0);
                                today.setHours(0, 0, 0, 0);
                                
                                // åªæœ‰å½“å‰æ—¶é—´å·²è¿‡æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                                if (today < nextDay) {
                                    return false;
                                }
                                return true; // é«˜é¢‘é¡¹ç›®æ»¡è¶³æ—¶é—´æ¡ä»¶å°±ç®—å·²ç¡®è®¤
                            } else {
                                // å¦‚æœæ²¡æœ‰æ’æœŸç»“æŸæ—¶é—´ï¼Œåˆ™ä¸ç®—å·²ç¡®è®¤
                                return false;
                            }
                        }
                        
                        // æ™®é€šé¡¹ç›®ï¼šåŸºæœ¬æ¡ä»¶æ˜¯æœ‰DQEæ‰¿è®¤ç»“æœ
                        if (!p.sampleRecognizeResult || p.sampleRecognizeResult.trim() === '') {
                            return false;
                        }
                        
                        return true;
                    });
                    break;
            }

            // æ ¹æ®å›¾è¡¨ç±»å‹å’Œæ ‡ç­¾è¿›è¡Œç­›é€‰
            let filteredProjects = [];

            if (chartId === 'categoryChart') {
                // äº§å“ç±»åˆ«ç­›é€‰
                if (label === 'æœªåˆ†ç±»') {
                    filteredProjects = originalProjects.filter(project =>
                        !project.sample_category || project.sample_category.trim() === ''
                    );
                } else {
                    filteredProjects = originalProjects.filter(project =>
                        project.sample_category === label
                    );
                }
            } else if (chartId === 'leaderChart') {
                // é¡¹ç›®è´Ÿè´£äººç­›é€‰
                if (label === 'æœªæŒ‡å®š') {
                    filteredProjects = originalProjects.filter(project =>
                        !project.sample_leader || project.sample_leader.trim() === ''
                    );
                } else {
                    filteredProjects = originalProjects.filter(project =>
                        project.sample_leader === label
                    );
                }
            } else if (chartId === 'testerChart') {
                // æµ‹è¯•è´Ÿè´£äººç­›é€‰
                if (label === 'æœªæŒ‡å®š') {
                    filteredProjects = originalProjects.filter(project =>
                        !project.tester || project.tester.trim() === ''
                    );
                } else {
                    filteredProjects = originalProjects.filter(project =>
                        project.tester === label
                    );
                }
            } else if (chartId === 'dqeLeaderChart') {
                // DQEè´Ÿè´£äººç­›é€‰
                if (label === 'æœªæŒ‡å®š') {
                    filteredProjects = originalProjects.filter(project =>
                        !project.dqe_leader || project.dqe_leader.trim() === ''
                    );
                } else {
                    filteredProjects = originalProjects.filter(project =>
                        project.dqe_leader === label
                    );
                }
            } else if (chartId === 'rdLeaderChart') {
                // ç ”å‘è´Ÿè´£äººç­›é€‰
                if (label === 'æœªæŒ‡å®š') {
                    filteredProjects = originalProjects.filter(project =>
                        !project.rd_leader || project.rd_leader.trim() === ''
                    );
                } else {
                    filteredProjects = originalProjects.filter(project =>
                        project.rd_leader === label
                    );
                }
            } else if (chartId === 'sampleSenderChart') {
                // é€æ ·äººç­›é€‰
                if (label === 'æœªæŒ‡å®š') {
                    filteredProjects = originalProjects.filter(project =>
                        !project.sample_sender || project.sample_sender.trim() === ''
                    );
                } else {
                    filteredProjects = originalProjects.filter(project =>
                        project.sample_sender === label
                    );
                }
            } else if (chartId === 'scheduleChart') {
                // æ’æœŸå¤©æ•°ç­›é€‰
                if (label === 'æœªè®¾ç½®') {
                    filteredProjects = originalProjects.filter(project =>
                        !project.scheduleDays || isNaN(project.scheduleDays)
                    );
                } else {
                    const days = parseInt(label.replace('å¤©', ''));
                    filteredProjects = originalProjects.filter(project =>
                        project.scheduleDays === days
                    );
                }
            } else if (chartId === 'confirmResultChart') {
                // ç¡®è®¤ç»“æœç­›é€‰
                if (label === 'DQE-æœªç¡®è®¤') {
                    filteredProjects = originalProjects.filter(project =>
                        (!project.rd_sampleRecognizeResult || project.rd_sampleRecognizeResult.trim() === '') &&
                        (!project.sampleRecognizeResult || project.sampleRecognizeResult.trim() === '')
                    );
                } else if (label.startsWith('ç ”å‘-')) {
                    const rdResult = label.replace('ç ”å‘-', '');
                    filteredProjects = originalProjects.filter(project =>
                        project.rd_sampleRecognizeResult && project.rd_sampleRecognizeResult.trim() === rdResult
                    );
                } else if (label.startsWith('DQE-')) {
                    const dqeResult = label.replace('DQE-', '');
                    filteredProjects = originalProjects.filter(project =>
                        project.sampleRecognizeResult && project.sampleRecognizeResult.trim() === dqeResult
                    );
                }
            } else if (chartId === 'notStartedDaysChart') {
                // æœªå¼€å§‹å¤©æ•°åˆ†å¸ƒç­›é€‰
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (label === 'ä»Šå¤©') {
                    filteredProjects = originalProjects.filter(project => {
                        if (!project.create_time) return false;
                        try {
                            const createDate = new Date(project.create_time);
                            createDate.setHours(0, 0, 0, 0);
                            const timeDiff = today.getTime() - createDate.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            return daysDiff === 0;
                        } catch (e) {
                            return false;
                        }
                    });
                } else if (label === 'æ˜¨å¤©') {
                    filteredProjects = originalProjects.filter(project => {
                        if (!project.create_time) return false;
                        try {
                            const createDate = new Date(project.create_time);
                            createDate.setHours(0, 0, 0, 0);
                            const timeDiff = today.getTime() - createDate.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            return daysDiff === 1;
                        } catch (e) {
                            return false;
                        }
                    });
                } else if (label.endsWith('å¤©')) {
                    // å¤„ç†å…·ä½“å¤©æ•°ï¼Œå¦‚"2å¤©"ã€"3å¤©"ç­‰
                    const days = parseInt(label.replace('å¤©', ''));
                    if (!isNaN(days)) {
                        filteredProjects = originalProjects.filter(project => {
                            if (!project.create_time) return false;
                            try {
                                const createDate = new Date(project.create_time);
                                createDate.setHours(0, 0, 0, 0);
                                const timeDiff = today.getTime() - createDate.getTime();
                                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                                return daysDiff === days;
                            } catch (e) {
                                return false;
                            }
                        });
                    }
                } else if (label === 'æ—¥æœŸæ— æ•ˆ') {
                    filteredProjects = originalProjects.filter(project => {
                        if (!project.create_time) return false;
                        try {
                            new Date(project.create_time);
                            return false; // å¦‚æœæ—¥æœŸæœ‰æ•ˆï¼Œä¸åŒ…å«åœ¨æ­¤ç»„
                        } catch (e) {
                            return true; // å¦‚æœæ—¥æœŸæ— æ•ˆï¼ŒåŒ…å«åœ¨æ­¤ç»„
                        }
                    });
                } else if (label === 'æœªè®¾ç½®') {
                    filteredProjects = originalProjects.filter(project => !project.create_time);
                }
            }

            // æ˜¾ç¤ºç­›é€‰åçš„æ•°æ®åˆ—è¡¨ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„è¿‡æ»¤å™¨
            showModalDataList(`${modalTitle} - ${label}`, filteredProjects, null, true);

            // è®¾ç½®å¯¹åº”çš„è¿‡æ»¤å™¨å€¼
            setFilterValues(chartId, label);

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showFilterNotification(`${label}: å…±æ‰¾åˆ° ${filteredProjects.length} ä¸ªé¡¹ç›®`);
        }

        // è®¾ç½®è¿‡æ»¤å™¨å€¼
        function setFilterValues(chartId, label) {
            // ç­‰å¾…DOMæ›´æ–°å®Œæˆåè®¾ç½®è¿‡æ»¤å™¨å€¼
            setTimeout(() => {
                if (chartId === 'categoryChart') {
                    const categoryFilter = document.getElementById('modalCategoryFilter');
                    if (categoryFilter) {
                        if (label === 'æœªåˆ†ç±»') {
                            categoryFilter.value = ''; // æœªåˆ†ç±»å¯¹åº”ç©ºå€¼
                        } else {
                            categoryFilter.value = label;
                        }
                    }
                } else if (chartId === 'leaderChart') {
                    const leaderFilter = document.getElementById('modalLeaderFilter');
                    if (leaderFilter) {
                        if (label === 'æœªæŒ‡å®š') {
                            leaderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                        } else {
                            leaderFilter.value = label;
                        }
                    }
                } else if (chartId === 'testerChart') {
                    const testerFilter = document.getElementById('modalTesterFilter');
                    if (testerFilter) {
                        if (label === 'æœªæŒ‡å®š') {
                            testerFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                        } else {
                            testerFilter.value = label;
                        }
                    }
                } else if (chartId === 'dqeLeaderChart') {
                    // DQEè´Ÿè´£äººç­›é€‰å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
                    if (dqeLeaderFilter) {
                        if (label === 'æœªæŒ‡å®š') {
                            dqeLeaderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                        } else {
                            dqeLeaderFilter.value = label;
                        }
                    }
                } else if (chartId === 'rdLeaderChart') {
                    // ç ”å‘è´Ÿè´£äººç­›é€‰å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
                    if (rdLeaderFilter) {
                        if (label === 'æœªæŒ‡å®š') {
                            rdLeaderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                        } else {
                            rdLeaderFilter.value = label;
                        }
                    }
                } else if (chartId === 'sampleSenderChart') {
                    // é€æ ·äººç­›é€‰å™¨
                    const sampleSenderFilter = document.getElementById('modalSampleSenderFilter');
                    if (sampleSenderFilter) {
                        if (label === 'æœªæŒ‡å®š') {
                            sampleSenderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                        } else {
                            sampleSenderFilter.value = label;
                        }
                    }
                } else if (chartId === 'scheduleChart') {
                    const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
                    if (scheduleDaysFilter) {
                        if (label === 'æœªè®¾ç½®') {
                            scheduleDaysFilter.value = 'æœªè®¾ç½®';
                        } else {
                            const days = parseInt(label.replace('å¤©', ''));
                            scheduleDaysFilter.value = days;
                        }
                    }
                }
            }, 100);
        }

        // æ˜¾ç¤ºç­›é€‰é€šçŸ¥
        function showFilterNotification(message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);

            // æ·»åŠ æ»‘å‡ºåŠ¨ç”»
            const slideOutStyle = document.createElement('style');
            slideOutStyle.textContent = `
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(slideOutStyle);
        }

        // å›¾è¡¨æ”¾å¤§ç¼©å°åŠŸèƒ½
        function zoomChart(chartId, direction) {
            const chartContainer = document.getElementById(chartId);
            if (!chartContainer) return;

            // æ£€æŸ¥å½“å‰å›¾è¡¨ç±»å‹
            const svg = chartContainer.querySelector('svg');
            const flexContainer = chartContainer.querySelector('div[style*="display: flex"]');

            // å¦‚æœæ˜¯æŸ±çŠ¶å›¾ï¼ˆflexå®¹å™¨ï¼‰ï¼Œåˆ™ä¸æ‰§è¡Œç¼©æ”¾
            if (flexContainer && !svg) {
                console.log('æŸ±çŠ¶å›¾ä¸æ”¯æŒç¼©æ”¾åŠŸèƒ½');
                return;
            }

            // è·å–å½“å‰å°ºå¯¸
            const currentHeight = parseInt(chartContainer.style.height) || 350;
            const currentWidth = chartContainer.offsetWidth;

            // è®¡ç®—æ–°çš„å°ºå¯¸ï¼ˆæ¯æ¬¡è°ƒæ•´20pxï¼‰
            const newHeight = Math.max(250, Math.min(600, currentHeight + (direction * 20)));

            // åº”ç”¨æ–°å°ºå¯¸
            chartContainer.style.height = newHeight + 'px';

            // å¦‚æœé«˜åº¦å˜åŒ–è¾ƒå¤§ï¼Œè°ƒæ•´SVGå°ºå¯¸
            if (svg) {
                const scale = newHeight / 350; // åŸºäºåŸå§‹é«˜åº¦350pxè®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                const newSvgSize = 250 * scale;
                svg.style.width = newSvgSize + 'px';
                svg.style.height = newSvgSize + 'px';
                svg.style.transform = `scale(${scale})`;
                svg.style.transformOrigin = 'center center';
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateZoomButtons(chartId, newHeight);
        }

        // æ›´æ–°æ”¾å¤§ç¼©å°æŒ‰é’®çŠ¶æ€
        function updateZoomButtons(chartId, currentHeight) {
            const chartContainer = document.getElementById(chartId);
            if (!chartContainer) return;

            const container = chartContainer.closest('.chart-container, div[style*="background: #f8f9fa"]');
            if (!container) return;

            const zoomOutBtn = container.querySelector('button[onclick*="-1"]');
            const zoomInBtn = container.querySelector('button[onclick*="1"]');

            // æ£€æŸ¥å½“å‰å›¾è¡¨ç±»å‹
            const svg = chartContainer.querySelector('svg');
            const flexContainer = chartContainer.querySelector('div[style*="display: flex"]');

            // å¦‚æœæ˜¯æŸ±çŠ¶å›¾ï¼Œç¦ç”¨æ”¾å¤§ç¼©å°æŒ‰é’®ï¼ˆæŠ˜çº¿å›¾å’Œé¥¼å›¾éƒ½æ”¯æŒç¼©æ”¾ï¼‰
            if (flexContainer && !svg) {
                if (zoomOutBtn) {
                    zoomOutBtn.disabled = true;
                    zoomOutBtn.style.opacity = '0.3';
                    zoomOutBtn.style.cursor = 'not-allowed';
                    zoomOutBtn.title = 'æŸ±çŠ¶å›¾ä¸æ”¯æŒç¼©æ”¾';
                }
                if (zoomInBtn) {
                    zoomInBtn.disabled = true;
                    zoomInBtn.style.opacity = '0.3';
                    zoomInBtn.style.cursor = 'not-allowed';
                    zoomInBtn.title = 'æŸ±çŠ¶å›¾ä¸æ”¯æŒç¼©æ”¾';
                }
                return;
            }

            // é¥¼å›¾çš„æ­£å¸¸æŒ‰é’®çŠ¶æ€æ›´æ–°
            if (zoomOutBtn) {
                zoomOutBtn.disabled = currentHeight <= 250;
                zoomOutBtn.style.opacity = currentHeight <= 250 ? '0.5' : '1';
                zoomOutBtn.style.cursor = currentHeight <= 250 ? 'not-allowed' : 'pointer';
                zoomOutBtn.title = 'ç¼©å°';
            }

            if (zoomInBtn) {
                zoomInBtn.disabled = currentHeight >= 600;
                zoomInBtn.style.opacity = currentHeight >= 600 ? '0.5' : '1';
                zoomInBtn.style.cursor = currentHeight >= 600 ? 'not-allowed' : 'pointer';
                zoomInBtn.title = 'æ”¾å¤§';
            }
        }

        // å¯¼å‡ºå½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„æ•°æ®
        function exportCurrentModalData(title) {
            // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
            const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
            let projectsToExport = [];

            // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
            switch(modalTitle) {
                case 'é¡¹ç›®æ€»æ•°':
                    projectsToExport = projectData;
                    break;
                case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p => {
                        // ç‰¹æ®Šå¤„ç†ï¼šé«˜é¢‘é¡¹ç›®ä¸”æµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿçš„æƒ…å†µ
                        if (p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')) {
                            // éœ€è¦æ»¡è¶³æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                            if (p.schedule_end_date) {
                                const today = new Date();
                                const scheduleEndDate = new Date(p.schedule_end_date);
                                const nextDay = new Date(scheduleEndDate);
                                nextDay.setDate(nextDay.getDate() + 1);
                                nextDay.setHours(0, 0, 0, 0);
                                today.setHours(0, 0, 0, 0);
                                
                                // åªæœ‰å½“å‰æ—¶é—´å·²è¿‡æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                                if (today < nextDay) {
                                    return false;
                                }
                                return true; // é«˜é¢‘é¡¹ç›®æ»¡è¶³æ—¶é—´æ¡ä»¶å°±ç®—å·²ç¡®è®¤
                            } else {
                                // å¦‚æœæ²¡æœ‰æ’æœŸç»“æŸæ—¶é—´ï¼Œåˆ™ä¸ç®—å·²ç¡®è®¤
                                return false;
                            }
                        }
                        
                        // æ™®é€šé¡¹ç›®ï¼šåŸºæœ¬æ¡ä»¶æ˜¯æœ‰DQEæ‰¿è®¤ç»“æœ
                        if (!p.sampleRecognizeResult || p.sampleRecognizeResult.trim() === '') {
                            return false;
                        }
                        
                        return true;
                    });
                    break;
                default:
                    // å¦‚æœæ ‡é¢˜åŒ…å«ç­›é€‰ä¿¡æ¯ï¼ˆå¦‚"é¡¹ç›®æ€»æ•° - äº§å“ç±»åˆ«"ï¼‰
                    if (modalTitle.includes(' - ')) {
                        const [baseTitle, filterValue] = modalTitle.split(' - ');

                        // æ ¹æ®åŸºç¡€æ ‡é¢˜è·å–åŸå§‹æ•°æ®
                        let baseProjects = [];
                        switch(baseTitle) {
                            case 'é¡¹ç›®æ€»æ•°':
                                baseProjects = projectData;
                                break;
                            case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p =>
                                    !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                                );
                                break;
                            case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p =>
                                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                                );
                                break;
                            case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p =>
                                    p.actual_finish_time && !p.sampleRecognizeResult
                                );
                                break;
                            case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p => {
                                    // ç‰¹æ®Šå¤„ç†ï¼šé«˜é¢‘é¡¹ç›®ä¸”æµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿçš„æƒ…å†µ
                                    if (p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')) {
                                        // éœ€è¦æ»¡è¶³æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                                        if (p.schedule_end_date) {
                                            const today = new Date();
                                            const scheduleEndDate = new Date(p.schedule_end_date);
                                            const nextDay = new Date(scheduleEndDate);
                                            nextDay.setDate(nextDay.getDate() + 1);
                                            nextDay.setHours(0, 0, 0, 0);
                                            today.setHours(0, 0, 0, 0);
                                            
                                            // åªæœ‰å½“å‰æ—¶é—´å·²è¿‡æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                                            if (today < nextDay) {
                                                return false;
                                            }
                                            return true; // é«˜é¢‘é¡¹ç›®æ»¡è¶³æ—¶é—´æ¡ä»¶å°±ç®—å·²ç¡®è®¤
                                        } else {
                                            // å¦‚æœæ²¡æœ‰æ’æœŸç»“æŸæ—¶é—´ï¼Œåˆ™ä¸ç®—å·²ç¡®è®¤
                                            return false;
                                        }
                                    }
                                    
                                    // æ™®é€šé¡¹ç›®ï¼šåŸºæœ¬æ¡ä»¶æ˜¯æœ‰DQEæ‰¿è®¤ç»“æœ
                                    if (!p.sampleRecognizeResult || p.sampleRecognizeResult.trim() === '') {
                                        return false;
                                    }
                                    
                                    return true;
                                });
                                break;
                        }

                        // æ ¹æ®ç­›é€‰å€¼è¿›ä¸€æ­¥ç­›é€‰
                        if (filterValue && baseProjects.length > 0) {
                            if (filterValue.includes('å¤©')) {
                                // æ’æœŸå¤©æ•°ç­›é€‰
                                if (filterValue === 'æœªè®¾ç½®') {
                                    projectsToExport = baseProjects.filter(project =>
                                        !project.scheduleDays || isNaN(project.scheduleDays)
                                    );
                                } else {
                                    const days = parseInt(filterValue.replace('å¤©', ''));
                                    projectsToExport = baseProjects.filter(project =>
                                        project.scheduleDays === days
                                    );
                                }
                            } else {
                                // å…¶ä»–ç­›é€‰ï¼ˆäº§å“ç±»åˆ«ã€è´Ÿè´£äººç­‰ï¼‰
                                projectsToExport = baseProjects.filter(project => {
                                    return project.sample_category === filterValue ||
                                        project.sample_leader === filterValue ||
                                        project.tester === filterValue;
                                });
                            }
                        } else {
                            projectsToExport = baseProjects;
                        }
                    } else {
                        projectsToExport = projectData;
                    }
                    break;
            }

            // åº”ç”¨æ‰€æœ‰ç­›é€‰æ¡ä»¶ï¼ˆå¦‚æœè®¾ç½®äº†ç­›é€‰ï¼‰
            const startDate = document.getElementById('modalStartDate')?.value;
            const endDate = document.getElementById('modalEndDate')?.value;
            const category = document.getElementById('modalCategoryFilter')?.value;
            const tester = document.getElementById('modalTesterFilter')?.value;
            const leader = document.getElementById('modalLeaderFilter')?.value;
            const dqeLeader = document.getElementById('modalDqeLeaderFilter')?.value;
            const rdLeader = document.getElementById('modalRdLeaderFilter')?.value;
            const scheduleDays = document.getElementById('modalScheduleDaysFilter')?.value;

            if (startDate || endDate || category || tester || leader || dqeLeader || rdLeader || scheduleDays) {
                projectsToExport = projectsToExport.filter(project => {
                    // ç±»åˆ«ç­›é€‰
                    if (category && project.sample_category !== category) {
                        return false;
                    }

                    // æµ‹è¯•è´Ÿè´£äººç­›é€‰
                    if (tester && project.tester !== tester) {
                        return false;
                    }

                    // é¡¹ç›®è´Ÿè´£äººç­›é€‰
                    if (leader && project.sample_leader !== leader) {
                        return false;
                    }

                    // DQEè´Ÿè´£äººç­›é€‰
                    if (dqeLeader && project.dqe_leader !== dqeLeader) {
                        return false;
                    }

                    // ç ”å‘è´Ÿè´£äººç­›é€‰
                    if (rdLeader && project.rd_leader !== rdLeader) {
                        return false;
                    }

                    // æ’æœŸå¤©æ•°ç­›é€‰
                    if (scheduleDays) {
                        if (scheduleDays === 'æœªè®¾ç½®') {
                            if (project.scheduleDays && !isNaN(project.scheduleDays)) {
                                return false;
                            }
                        } else {
                            if (project.scheduleDays !== parseInt(scheduleDays)) {
                                return false;
                            }
                        }
                    }

                    // æ—¶é—´ç­›é€‰
                    if (startDate || endDate) {
                        if (!project.create_time) return false;

                        const createDate = new Date(project.create_time);
                        let matchesDate = true;

                        if (startDate) {
                            const start = new Date(startDate);
                            matchesDate = matchesDate && createDate >= start;
                        }

                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && createDate <= end;
                        }

                        if (!matchesDate) return false;
                    }

                    return true;
                });
            }

            if (projectsToExport.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
                return;
            }

            console.log('å¯¼å‡ºç­›é€‰åçš„æ•°æ®ï¼Œæ•°é‡1:', projectsToExport.length);
            console.log('ç­›é€‰åçš„æ•°æ®:', projectsToExport);

            // è°ƒç”¨åŸæœ‰çš„å¯¼å‡ºå‡½æ•°ï¼Œä¼ å…¥ç­›é€‰åçš„æ•°æ®
            exportToExcel(title, projectsToExport);
        }

        // å¯¼å‡ºExcelåŠŸèƒ½
        function exportToExcel(title, projectsToExport) {
            console.log('å¼€å§‹å¯¼å‡ºExcelï¼Œæ ‡é¢˜:', title);
            console.log('SheetJSåº“æ˜¯å¦å¯ç”¨:', typeof XLSX !== 'undefined');
            console.log('è¦å¯¼å‡ºçš„æ•°æ®é•¿åº¦:', projectsToExport.length);
            console.log('è¦å¯¼å‡ºçš„æ•°æ®:', projectsToExport);

            // è°ƒè¯•ï¼šæ£€æŸ¥å‰å‡ ä¸ªé¡¹ç›®çš„æ•°æ®ç»“æ„
            if (projectsToExport.length > 0) {
                console.log('ç¬¬ä¸€ä¸ªé¡¹ç›®çš„æ•°æ®ç»“æ„:', projectsToExport[0]);
                console.log('å¤§ç¼–ç å­—æ®µå€¼:', projectsToExport[0].sample_model);
                console.log('ç‰ˆæœ¬å­—æ®µå€¼:', projectsToExport[0].version);
                console.log('æ‰€æœ‰å¯ç”¨å­—æ®µ:', Object.keys(projectsToExport[0]));
            }


            // ä½¿ç”¨ä¼ å…¥çš„projectsToExportï¼Œè€Œä¸æ˜¯é‡æ–°ç­›é€‰
            const projects = projectsToExport;

            if (projects.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
                return;
            }

            try {
                // å‡†å¤‡è¡¨å¤´
                const headers = [
                    'æ ·å“ç¼–å·', 'äº§å“åç§°', 'äº§å“ç±»åˆ«', 'å¤§ç¼–ç ', 'ç‰©æ–™ç¼–ç ', 'ç‰ˆæœ¬', 'é¡¹ç›®è´Ÿè´£äºº',
                    'å½“å‰è¿›åº¦', 'æµ‹è¯•è´Ÿè´£äºº', 'DQEè´Ÿè´£äºº', 'ç ”å‘è´Ÿè´£äºº', 'é€æ ·äºº', 'é€æ ·ç±»åˆ«', 'é€æ ·æ•°é‡', 'æ˜¯å¦é«˜é¢‘', 'æå•æ—¶é—´', 'æ’æœŸå¤©æ•°',
                    'æ’æœŸå¼€å§‹', 'æ’æœŸç»“æŸ', 'å®é™…å¼€å§‹æ—¶é—´', 'å®é™…å®Œæˆæ—¶é—´', 'DQEæ‰¿è®¤ç»“æœ', 'ç ”å‘æ‰¿è®¤ç»“æœ'
                ];

                // å‡†å¤‡æ•°æ®
                const data = projects.map(project => [
                    project.sample_id || '',
                    project.sample_name || '',
                    project.sample_category || '',
                    project.sample_model || ' ', // å¦‚æœå­—æ®µä¸å­˜åœ¨ï¼Œæ˜¾ç¤º"å¾…è¡¥å……"
                    project.materialCode || '',
                    project.version || ' ', // å¦‚æœå­—æ®µä¸å­˜åœ¨ï¼Œæ˜¾ç¤º"å¾…è¡¥å……"
                    project.sample_leader || '',
                    getProjectStatus(project),
                    project.tester || '',
                    project.dqe_leader || '',
                    project.rd_leader || '',
                    project.sample_sender || '',
                    project.sample_type || '',
                    project.sample_quantity || '',
                    project.high_frequency || '',
                    formatDateTime(project.create_time) || '',
                    project.scheduleDays || '',
                    formatDate(project.schedule_start_date) || '',
                    formatDate(project.schedule_end_date) || '',
                    formatDateTime(project.actual_start_time) || '',
                    formatDateTime(project.actual_finish_time) || '',
                    project.sampleRecognizeResult || '',
                    project.rd_sampleRecognizeResult || ''
                ]);

                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

                // è®¾ç½®åˆ—å®½
                const colWidths = headers.map(() => ({ wch: 15 }));
                ws['!cols'] = colWidths;

                // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, 'é¡¹ç›®æ•°æ®');

                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `${title}_${new Date().toISOString().slice(0, 10)}.xlsx`;

                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, fileName);

                alert('å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ï¼');
            }
        }

        // è·å–é¡¹ç›®çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
        function getProjectStatus(project) {
            if (!project.actual_start_time) {
                return 'æœªå¼€å§‹';
            } else if (project.actual_start_time && !project.actual_finish_time) {
                return 'è¿›è¡Œä¸­';
            } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                return 'å·²å®Œæˆæœªç¡®è®¤';
            } else if (project.actual_finish_time && project.sampleRecognizeResult) {
                return 'å·²ç¡®è®¤';
            }
            return 'æœªçŸ¥çŠ¶æ€';
        }

        // æ¨¡æ€æ¡†ç­›é€‰åŠŸèƒ½
        function applyModalFilters() {
            const startDate = document.getElementById('modalStartDate').value;
            const endDate = document.getElementById('modalEndDate').value;
            const category = document.getElementById('modalCategoryFilter')?.value;
            const tester = document.getElementById('modalTesterFilter')?.value;
            const leader = document.getElementById('modalLeaderFilter')?.value;
            const dqeLeader = document.getElementById('modalDqeLeaderFilter')?.value;
            const rdLeader = document.getElementById('modalRdLeaderFilter')?.value;
            const scheduleDays = document.getElementById('modalScheduleDaysFilter')?.value;

            // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
            const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
            let originalProjects = [];

            // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
            switch(modalTitle) {
                case 'é¡¹ç›®æ€»æ•°':
                    originalProjects = projectData;
                    break;
                case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p => {
                        // ç‰¹æ®Šå¤„ç†ï¼šé«˜é¢‘é¡¹ç›®ä¸”æµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿçš„æƒ…å†µ
                        if (p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')) {
                            // éœ€è¦æ»¡è¶³æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                            if (p.schedule_end_date) {
                                const today = new Date();
                                const scheduleEndDate = new Date(p.schedule_end_date);
                                const nextDay = new Date(scheduleEndDate);
                                nextDay.setDate(nextDay.getDate() + 1);
                                nextDay.setHours(0, 0, 0, 0);
                                today.setHours(0, 0, 0, 0);
                                
                                // åªæœ‰å½“å‰æ—¶é—´å·²è¿‡æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                                if (today < nextDay) {
                                    return false;
                                }
                                return true; // é«˜é¢‘é¡¹ç›®æ»¡è¶³æ—¶é—´æ¡ä»¶å°±ç®—å·²ç¡®è®¤
                            } else {
                                // å¦‚æœæ²¡æœ‰æ’æœŸç»“æŸæ—¶é—´ï¼Œåˆ™ä¸ç®—å·²ç¡®è®¤
                                return false;
                            }
                        }
                        
                        // æ™®é€šé¡¹ç›®ï¼šåŸºæœ¬æ¡ä»¶æ˜¯æœ‰DQEæ‰¿è®¤ç»“æœ
                        if (!p.sampleRecognizeResult || p.sampleRecognizeResult.trim() === '') {
                            return false;
                        }
                        
                        return true;
                    });
                    break;
            }

            // åº”ç”¨æ‰€æœ‰ç­›é€‰æ¡ä»¶
            let filteredProjects = originalProjects.filter(project => {
                // ç±»åˆ«ç­›é€‰
                if (category && project.sample_category !== category) {
                    return false;
                }

                // æµ‹è¯•è´Ÿè´£äººç­›é€‰
                if (tester && project.tester !== tester) {
                    return false;
                }

                // é¡¹ç›®è´Ÿè´£äººç­›é€‰
                if (leader && project.sample_leader !== leader) {
                    return false;
                }

                // DQEè´Ÿè´£äººç­›é€‰
                if (dqeLeader && project.dqe_leader !== dqeLeader) {
                    return false;
                }

                // ç ”å‘è´Ÿè´£äººç­›é€‰
                if (rdLeader && project.rd_leader !== rdLeader) {
                    return false;
                }

                // æ’æœŸå¤©æ•°ç­›é€‰
                if (scheduleDays) {
                    if (scheduleDays === 'æœªè®¾ç½®') {
                        if (project.scheduleDays && !isNaN(project.scheduleDays)) {
                            return false;
                        }
                    } else {
                        if (project.scheduleDays !== parseInt(scheduleDays)) {
                            return false;
                        }
                    }
                }

                // æ—¶é—´ç­›é€‰
                if (startDate || endDate) {
                    if (!project.create_time) return false;

                    const createDate = new Date(project.create_time);
                    let matchesDate = true;

                    if (startDate) {
                        const start = new Date(startDate);
                        matchesDate = matchesDate && createDate >= start;
                    }

                    if (endDate) {
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        matchesDate = matchesDate && createDate <= end;
                    }

                    if (!matchesDate) return false;
                }

                return true;
            });

            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹ - ä¿æŒå½“å‰æ˜¾ç¤ºæ¨¡å¼
            const currentContent = document.getElementById('modalContent').innerHTML;
            if (currentContent.includes('æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ')) {
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯å›¾è¡¨ï¼Œåˆ™æ›´æ–°å›¾è¡¨
                showModalCharts(modalTitle, filteredProjects);
            } else {
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨ï¼Œåˆ™æ›´æ–°æ•°æ®åˆ—è¡¨ï¼Œä¿æŒè¿‡æ»¤å™¨å€¼
                showModalDataList(modalTitle, filteredProjects, null, true);
            }
        }

        // é‡ç½®æ¨¡æ€æ¡†ç­›é€‰
        function resetModalFilters() {
            // é‡ç½®æ‰€æœ‰è¿‡æ»¤å™¨
            document.getElementById('modalStartDate').value = '';
            document.getElementById('modalEndDate').value = '';

            const categoryFilter = document.getElementById('modalCategoryFilter');
            if (categoryFilter) categoryFilter.value = '';

            const testerFilter = document.getElementById('modalTesterFilter');
            if (testerFilter) testerFilter.value = '';

            const leaderFilter = document.getElementById('modalLeaderFilter');
            if (leaderFilter) leaderFilter.value = '';

            const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
            if (dqeLeaderFilter) dqeLeaderFilter.value = '';

            const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
            if (rdLeaderFilter) rdLeaderFilter.value = '';

            const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
            if (scheduleDaysFilter) scheduleDaysFilter.value = '';

            // é‡æ–°æ˜¾ç¤ºåŸå§‹æ•°æ®
            const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
            let originalProjects = [];

            switch(modalTitle) {
                case 'é¡¹ç›®æ€»æ•°':
                    originalProjects = projectData;
                    break;
                case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p => {
                        // ç‰¹æ®Šå¤„ç†ï¼šé«˜é¢‘é¡¹ç›®ä¸”æµ‹è¯•è´Ÿè´£äººæ˜¯è”¡ä¹‰ä¼šæˆ–å»–å»ºä¼Ÿçš„æƒ…å†µ
                        if (p.high_frequency === 'æ˜¯' && (p.tester === 'è”¡ä¹‰ä¼š' || p.tester === 'å»–å»ºä¼Ÿ')) {
                            // éœ€è¦æ»¡è¶³æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                            if (p.schedule_end_date) {
                                const today = new Date();
                                const scheduleEndDate = new Date(p.schedule_end_date);
                                const nextDay = new Date(scheduleEndDate);
                                nextDay.setDate(nextDay.getDate() + 1);
                                nextDay.setHours(0, 0, 0, 0);
                                today.setHours(0, 0, 0, 0);
                                
                                // åªæœ‰å½“å‰æ—¶é—´å·²è¿‡æ’æœŸç»“æŸæ—¶é—´çš„ç¬¬äºŒå¤©æ‰ç®—å·²ç¡®è®¤
                                if (today < nextDay) {
                                    return false;
                                }
                                return true; // é«˜é¢‘é¡¹ç›®æ»¡è¶³æ—¶é—´æ¡ä»¶å°±ç®—å·²ç¡®è®¤
                            } else {
                                // å¦‚æœæ²¡æœ‰æ’æœŸç»“æŸæ—¶é—´ï¼Œåˆ™ä¸ç®—å·²ç¡®è®¤
                                return false;
                            }
                        }
                        
                        // æ™®é€šé¡¹ç›®ï¼šåŸºæœ¬æ¡ä»¶æ˜¯æœ‰DQEæ‰¿è®¤ç»“æœ
                        if (!p.sampleRecognizeResult || p.sampleRecognizeResult.trim() === '') {
                            return false;
                        }
                        
                        return true;
                    });
                    break;
            }

            // ä¿æŒå½“å‰æ˜¾ç¤ºæ¨¡å¼
            const currentContent = document.getElementById('modalContent').innerHTML;
            if (currentContent.includes('æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ')) {
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯å›¾è¡¨ï¼Œåˆ™æ›´æ–°å›¾è¡¨
                showModalCharts(modalTitle, originalProjects);
            } else {
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨ï¼Œåˆ™æ›´æ–°æ•°æ®åˆ—è¡¨ï¼Œä¿æŒè¿‡æ»¤å™¨å€¼
                showModalDataList(modalTitle, originalProjects, null, true);
            }
        }

        // åˆ‡æ¢å›¾è¡¨ç±»å‹ï¼ˆæŸ±çŠ¶å›¾/é¥¼çŠ¶å›¾/æŠ˜çº¿å›¾ï¼‰
        function toggleChartType(chartId, dataJson) {
            try {
                const data = JSON.parse(dataJson);
                const chartContainer = document.getElementById(chartId);
                const toggleBtn = chartContainer.parentElement.querySelector('button[onclick*="toggleChartType"]');

                if (!chartContainer || !toggleBtn) return;

                // åº”ç”¨æ•°æ®é™åˆ¶
                const limitedData = applyDataLimit(data, window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10);

                // æ£€æŸ¥å½“å‰å›¾è¡¨ç±»å‹
                const currentChart = chartContainer.querySelector('svg, div[style*="display: flex"]');
                const isCurrentlyBar = currentChart && currentChart.style.display === 'flex';
                const isCurrentlyPie = currentChart && currentChart.tagName === 'svg' && currentChart.querySelector('path[id^="segment_"]');
                const isCurrentlyLine = currentChart && currentChart.tagName === 'svg' && currentChart.querySelector('path[stroke="#36A2EB"]');

                // ç¡®å®šä¸‹ä¸€ä¸ªå›¾è¡¨ç±»å‹
                let nextChartType;
                let nextIcon;
                let nextTitle;

                if (isCurrentlyBar) {
                    // å½“å‰æ˜¯æŸ±çŠ¶å›¾ï¼Œåˆ‡æ¢åˆ°é¥¼çŠ¶å›¾
                    nextChartType = 'pie';
                    nextIcon = 'ğŸ•';
                    nextTitle = 'åˆ‡æ¢åˆ°æŠ˜çº¿å›¾';
                } else if (isCurrentlyPie) {
                    // å½“å‰æ˜¯é¥¼çŠ¶å›¾ï¼Œåˆ‡æ¢åˆ°æŠ˜çº¿å›¾
                    nextChartType = 'line';
                    nextIcon = 'ğŸ“ˆ';
                    nextTitle = 'åˆ‡æ¢åˆ°æŸ±çŠ¶å›¾';
                } else {
                    // å½“å‰æ˜¯æŠ˜çº¿å›¾æˆ–å…¶ä»–ï¼Œåˆ‡æ¢åˆ°æŸ±çŠ¶å›¾
                    nextChartType = 'bar';
                    nextIcon = 'ğŸ“Š';
                    nextTitle = 'åˆ‡æ¢åˆ°é¥¼çŠ¶å›¾';
                }

                // æ ¹æ®ä¸‹ä¸€ä¸ªå›¾è¡¨ç±»å‹åˆ›å»ºå›¾è¡¨
                switch (nextChartType) {
                    case 'bar':
                        chartContainer.innerHTML = createBarChart(limitedData, chartId);
                        break;
                    case 'pie':
                        chartContainer.innerHTML = createPieChart(limitedData, chartId);
                        break;
                    case 'line':
                        chartContainer.innerHTML = createLineChart(limitedData, chartId);
                        break;
                }

                // æ›´æ–°æŒ‰é’®å›¾æ ‡å’Œæç¤º
                toggleBtn.innerHTML = nextIcon;
                toggleBtn.title = nextTitle;

                // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå› ä¸ºé‡æ–°ç”Ÿæˆäº†HTMLï¼‰
                bindChartClickEvents(chartId);

                // é‡æ–°ç»‘å®štooltipäº‹ä»¶
                bindTooltipEvents(chartId);

            } catch (error) {
                console.error('åˆ‡æ¢å›¾è¡¨ç±»å‹å¤±è´¥:', error);
            }
        }

        // ç»‘å®šå›¾è¡¨ç‚¹å‡»äº‹ä»¶
        function bindChartClickEvents(chartId) {
            const chartContainer = document.getElementById(chartId);
            if (!chartContainer) return;

            // ä¸ºé¥¼å›¾çš„æ‰‡å½¢æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
            segments.forEach(segment => {
                const label = segment.getAttribute('data-label');
                const value = segment.getAttribute('data-value');
                if (label && value) {
                    segment.onclick = () => filterByChartSegment(chartId, label, parseInt(value));
                }
            });

            // ä¸ºæŸ±çŠ¶å›¾çš„æŸ±å­æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const bars = chartContainer.querySelectorAll('div[data-label][data-value]');
            bars.forEach(bar => {
                const label = bar.getAttribute('data-label');
                const value = bar.getAttribute('data-value');
                if (label && value) {
                    // ç¡®ä¿è¿™æ˜¯çœŸæ­£çš„æŸ±å­ï¼ˆæœ‰èƒŒæ™¯è‰²çš„divï¼‰
                    if (bar.style.background || bar.style.backgroundColor) {
                        bar.onclick = () => filterByChartSegment(chartId, label, parseInt(value));
                    }
                }
            });
        }

        // ç»‘å®štooltipäº‹ä»¶
        function bindTooltipEvents(chartId) {
            const chartContainer = document.getElementById(chartId);
            if (!chartContainer) return;

            // ä¸ºé¥¼å›¾çš„æ‰‡å½¢æ·»åŠ tooltipäº‹ä»¶
            const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
            segments.forEach(segment => {
                const label = segment.getAttribute('data-label');
                const value = segment.getAttribute('data-value');
                if (label && value) {
                    segment.onmouseover = (event) => showSegmentTooltip(event, label, parseInt(value), ((parseInt(value) / getTotalValue(chartId)) * 100).toFixed(1));
                    segment.onmouseout = hideSegmentTooltip;
                }
            });
        }

        // è·å–å›¾è¡¨æ•°æ®æ€»å’Œ
        function getTotalValue(chartId) {
            const chartContainer = document.getElementById(chartId);
            if (!chartContainer) return 0;

            // å°è¯•ä»dataå±æ€§è·å–å€¼
            const elements = chartContainer.querySelectorAll('[data-value]');
            let total = 0;
            elements.forEach(element => {
                const value = parseInt(element.getAttribute('data-value'));
                if (!isNaN(value)) {
                    total += value;
                }
            });

            return total;
        }

        // æ¨¡æ€æ¡†å¯¼å‡ºExcelåŠŸèƒ½ï¼ˆå¯¼å‡ºç­›é€‰åçš„æ•°æ®ï¼‰
        function exportModalExcel(title) {
            // è·å–å½“å‰æ¨¡æ€æ¡†ä¸­å®é™…æ˜¾ç¤ºçš„æ•°æ®
            let projectsToExport = [];

            // æ£€æŸ¥å½“å‰æ¨¡æ€æ¡†æ˜¯å¦æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨
            const modalContent = document.getElementById('modalContent');
            if (modalContent && modalContent.innerHTML.includes('è¯¦ç»†æ•°æ®åˆ—è¡¨')) {
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨ï¼Œè·å–è¡¨æ ¼ä¸­çš„å®é™…æ•°æ®
                const tableRows = modalContent.querySelectorAll('table tbody tr');
                if (tableRows.length > 0) {
                    // ä»è¡¨æ ¼è¡Œä¸­æå–æ•°æ®
                    projectsToExport = Array.from(tableRows).map(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 23) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                            return {
                                sample_id: cells[0].textContent.trim(),
                                sample_name: cells[1].textContent.trim(),
                                sample_category: cells[2].textContent.trim(),
                                sample_model: cells[3].textContent.trim(),
                                materialCode: cells[4].textContent.trim(),
                                version: cells[5].textContent.trim(),
                                sample_leader: cells[6].textContent.trim(),
                                schedule: cells[7].textContent.trim(),
                                tester: cells[8].textContent.trim(),
                                dqe_leader: cells[9].textContent.trim(),
                                rd_leader: cells[10].textContent.trim(),
                                sample_sender: cells[11].textContent.trim(),
                                sample_type: cells[12].textContent.trim(),
                                sample_quantity: cells[13].textContent.trim(),
                                high_frequency: cells[14].textContent.trim(),
                                create_time: cells[15].textContent.trim(),
                                scheduleDays: cells[16].textContent.trim(),
                                schedule_start_date: cells[17].textContent.trim(),
                                schedule_end_date: cells[18].textContent.trim(),
                                actual_start_time: cells[19].textContent.trim(),
                                actual_finish_time: cells[20].textContent.trim(),
                                sampleRecognizeResult: cells[21].textContent.trim(),
                                rd_sampleRecognizeResult: cells[22] ? cells[22].textContent.trim() : ''
                            };
                        }
                        return null;
                    }).filter(Boolean);
                }
            }

            // å¦‚æœæ— æ³•ä»è¡¨æ ¼è·å–æ•°æ®ï¼Œåˆ™æ ¹æ®æ ‡é¢˜è·å–åŸºç¡€æ•°æ®
            if (projectsToExport.length === 0) {
                switch(title) {
                    case 'é¡¹ç›®æ€»æ•°':
                        projectsToExport = projectData;
                        break;
                    case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                        projectsToExport = projectData.filter(p =>
                            !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                        );
                        break;
                    case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                        projectsToExport = projectData.filter(p =>
                            p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                        );
                        break;
                    case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                        projectsToExport = projectData.filter(p =>
                            p.actual_finish_time && !p.sampleRecognizeResult
                        );
                        break;
                    case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                        projectsToExport = projectData.filter(p =>
                            p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                        );
                        break;
                    default:
                        // å¦‚æœæ ‡é¢˜åŒ…å«ç­›é€‰ä¿¡æ¯ï¼ˆå¦‚"é¡¹ç›®æ€»æ•° - äº§å“ç±»åˆ«"ï¼‰
                        if (title.includes(' - ')) {
                            const [baseTitle, filterValue] = title.split(' - ');

                            // æ ¹æ®åŸºç¡€æ ‡é¢˜è·å–åŸå§‹é¡¹ç›®æ•°æ®
                            let baseProjects = [];
                            switch(baseTitle) {
                                case 'é¡¹ç›®æ€»æ•°':
                                    baseProjects = projectData;
                                    break;
                                case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                                    baseProjects = projectData.filter(p =>
                                        !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                                    );
                                    break;
                                case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                                    baseProjects = projectData.filter(p =>
                                        p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                                    );
                                    break;
                                case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                                    baseProjects = projectData.filter(p =>
                                        p.actual_finish_time && !p.sampleRecognizeResult
                                    );
                                    break;
                                case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                                    baseProjects = projectData.filter(p =>
                                        p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                                    );
                                    break;
                            }


                            // æ ¹æ®ç­›é€‰å€¼è¿›ä¸€æ­¥ç­›é€‰
                            if (filterValue && baseProjects.length > 0) {
                                if (filterValue.includes('å¤©')) {
                                    // æ’æœŸå¤©æ•°ç­›é€‰
                                    if (filterValue === 'æœªè®¾ç½®') {
                                        projectsToExport = baseProjects.filter(project =>
                                            !project.scheduleDays || isNaN(project.scheduleDays)
                                        );
                                    } else {
                                        const days = parseInt(filterValue.replace('å¤©', ''));
                                        projectsToExport = baseProjects.filter(project =>
                                            project.scheduleDays === days
                                        );
                                    }
                                } else {
                                    // å…¶ä»–ç­›é€‰ï¼ˆäº§å“ç±»åˆ«ã€è´Ÿè´£äººç­‰ï¼‰
                                    projectsToExport = baseProjects.filter(project => {
                                        return project.sample_category === filterValue ||
                                            project.sample_leader === filterValue ||
                                            project.tester === filterValue ||
                                            project.dqe_leader === filterValue ||
                                            project.rd_leader === filterValue ||
                                            project.sample_sender === filterValue;
                                    });
                                }
                            } else {
                                projectsToExport = baseProjects;
                            }
                        } else {
                            projectsToExport = projectData;
                        }
                        break;
                }
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯ä»¥å¯¼å‡º
            if (projectsToExport.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
                return;
            }

            console.log('å¯¼å‡ºæ•°æ®ï¼Œæ ‡é¢˜2:', title, 'æ•°é‡:', projectsToExport.length);
            console.log('å¯¼å‡ºçš„æ•°æ®:', projectsToExport);

            // è°ƒç”¨åŸæœ‰çš„å¯¼å‡ºå‡½æ•°ï¼Œä¼ å…¥ç­›é€‰åçš„æ•°æ®
            exportToExcel(title, projectsToExport);
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰å›¾è¡¨æ¨¡æ€æ¡†
        function showDynamicChartModal(title, projects, status) {
            // å¡«å……å­—æ®µé€‰æ‹©å™¨
            populateFieldSelector();

            // å­˜å‚¨å½“å‰é¡¹ç›®æ•°æ®ä¾›å›¾è¡¨ç”Ÿæˆä½¿ç”¨
            window.currentProjectsForChart = projects;
            window.currentChartTitle = title;
            window.currentChartStatus = status;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('dynamicChartModal').style.display = 'block';

            // å¡«å……å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨
            populateSavedChartsList();
        }

        // å…³é—­è‡ªå®šä¹‰å›¾è¡¨æ¨¡æ€æ¡†
        function closeDynamicChartModal() {
            document.getElementById('dynamicChartModal').style.display = 'none';
        }

        // å¡«å……å­—æ®µé€‰æ‹©å™¨
        function populateFieldSelector() {
            const fieldSelector = document.getElementById('fieldSelector');
            const fields = [
                { value: 'sample_id', label: 'æ ·å“ç¼–å·' },
                { value: 'sample_name', label: 'äº§å“åç§°' },
                { value: 'sample_category', label: 'äº§å“ç±»åˆ«' },
                { value: 'sample_model', label: 'å¤§ç¼–ç ' },
                { value: 'version', label: 'ç‰ˆæœ¬å·' },
                { value: 'sample_leader', label: 'é¡¹ç›®è´Ÿè´£äºº' },
                { value: 'tester', label: 'æµ‹è¯•è´Ÿè´£äºº' },
                { value: 'dqe_leader', label: 'DQEè´Ÿè´£äºº' },
                { value: 'rd_leader', label: 'ç ”å‘è´Ÿè´£äºº' },
                { value: 'sample_sender', label: 'é€æ ·äºº' },
                { value: 'sample_type', label: 'é€æ ·ç±»åˆ«' },
                { value: 'create_time', label: 'æå•æ—¶é—´' },
                { value: 'scheduleDays', label: 'æ’æœŸå¤©æ•°' },
                { value: 'schedule_start_date', label: 'æ’æœŸå¼€å§‹æ—¶é—´' },
                { value: 'schedule_end_date', label: 'æ’æœŸç»“æŸæ—¶é—´' },
                { value: 'actual_start_time', label: 'å®é™…å¼€å§‹æµ‹è¯•æ—¶é—´' },
                { value: 'actual_finish_time', label: 'å®é™…å®Œæˆæ—¶é—´' },
                { value: 'sampleRecognizeResult', label: 'DQEæ‰¿è®¤ç»“æœ' },
                { value: 'rd_sampleRecognizeResult', label: 'ç ”å‘æ‰¿è®¤ç»“æœ' }
            ];

            fieldSelector.innerHTML = '<option value="">è¯·é€‰æ‹©è¦åˆ†æçš„å­—æ®µ</option>';
            fields.forEach(field => {
                fieldSelector.innerHTML += `<option value="${field.value}">${field.label}</option>`;
            });
        }

        // ç”Ÿæˆè‡ªå®šä¹‰å›¾è¡¨
        function generateDynamicChart() {
            const fieldName = document.getElementById('fieldSelector').value;
            const chartType = document.getElementById('chartTypeSelector').value;
            const topN = parseInt(document.getElementById('topNSelector').value) || 10;

            if (!fieldName) {
                alert('è¯·é€‰æ‹©è¦åˆ†æçš„å­—æ®µï¼');
                return;
            }

            if (!window.currentProjectsForChart || window.currentProjectsForChart.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥åˆ†æï¼');
                return;
            }

            // ç»Ÿè®¡æ•°æ®
            const stats = {};
            window.currentProjectsForChart.forEach(project => {
                let value = project[fieldName];

                // å¤„ç†ä¸åŒç±»å‹çš„å€¼
                if (value === null || value === undefined || value === '') {
                    value = 'æœªè®¾ç½®';
                } else if (fieldName === 'scheduleDays') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å¤©';
                } else if (fieldName === 'testDuration') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å°æ—¶';
                } else if (fieldName === 'sample_frequency') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'æ¬¡';
                } else if (fieldName === 'isUsed') {
                    value = value === 1 ? 'å·²ç”¨' : value === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
                } else if (fieldName === 'isCancel') {
                    value = value === 1 ? 'å·²ä½œåºŸ' : value === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
                } else if (fieldName === 'high_frequency') {
                    value = value === '1' || value === 1 ? 'æ˜¯' : value === '0' || value === 0 ? 'å¦' : value || 'æœªè®¾ç½®';
                } else if (fieldName.includes('date') || fieldName.includes('time') || fieldName === 'reportReviewTime') {
                    // å¯¹äºæ—¥æœŸæ—¶é—´å­—æ®µï¼Œæå–å¹´æœˆæ—¥
                    if (value && value !== 'æœªè®¾ç½®') {
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                value = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            value = 'æ— æ•ˆæ—¥æœŸ';
                        }
                    }
                } else if (fieldName === 'priority') {
                    // ä¼˜å…ˆçº§å­—æ®µç‰¹æ®Šå¤„ç†
                    if (value && value.trim() !== '') {
                        value = value.trim();
                    } else {
                        value = 'æœªè®¾ç½®';
                    }
                } else if (fieldName === 'schedule') {
                    // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                    if (value !== null && value !== undefined && value !== '') {
                        // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                        const progressMap = {
                            '0': 'æœªå¼€å§‹',
                            '1': 'è¿›è¡Œä¸­',
                            '2': 'å·²å®Œæˆæœªç¡®è®¤',
                            '3': 'æŠ¥å‘Šç¡®è®¤é—­ç¯'
                        };
                        value = progressMap[value.toString()] || `è¿›åº¦${value}`;
                    } else {
                        value = 'æœªè®¾ç½®';
                    }
                } else if (fieldName === 'sample_type') {
                    // é€æ ·ç±»åˆ«å­—æ®µç‰¹æ®Šå¤„ç†
                    if (value && value.trim() !== '') {
                        value = value.trim();
                    } else {
                        value = 'æœªè®¾ç½®';
                    }
                }

                stats[value] = (stats[value] || 0) + 1;
            });

            // æ’åºå¹¶å–å‰Nä¸ª
            let sortedStats;

            // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¶é—´å­—æ®µï¼Œå¦‚æœæ˜¯åˆ™æŒ‰æ—¶é—´é¡ºåºæ’åº
            if (fieldName.includes('date') || fieldName.includes('time') || fieldName === 'reportReviewTime') {
                // å¯¹æ—¶é—´å­—æ®µæŒ‰æ—¶é—´é¡ºåºæ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
                sortedStats = Object.entries(stats)
                    .filter(([key]) => key !== 'æœªè®¾ç½®' && key !== 'æ— æ•ˆæ—¥æœŸ') // å…ˆè¿‡æ»¤æ‰ç‰¹æ®Šå€¼
                    .sort((a, b) => {
                        // å°è¯•è§£ææ—¥æœŸè¿›è¡Œæ¯”è¾ƒ
                        try {
                            const dateA = new Date(a[0]);
                            const dateB = new Date(b[0]);
                            if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                                return dateA - dateB; // æŒ‰æ—¶é—´ä»æ—©åˆ°æ™šæ’åº
                            }
                            return a[0].localeCompare(b[0]); // å¦‚æœè§£æå¤±è´¥ï¼ŒæŒ‰å­—ç¬¦ä¸²æ’åº
                        } catch (e) {
                            return a[0].localeCompare(b[0]);
                        }
                    })
                    .slice(0, topN);

                // å¦‚æœæœ‰ç‰¹æ®Šå€¼ï¼Œæ·»åŠ åˆ°æœ«å°¾
                if (stats['æœªè®¾ç½®']) {
                    sortedStats.push(['æœªè®¾ç½®', stats['æœªè®¾ç½®']]);
                }
                if (stats['æ— æ•ˆæ—¥æœŸ']) {
                    sortedStats.push(['æ— æ•ˆæ—¥æœŸ', stats['æ— æ•ˆæ—¥æœŸ']]);
                }
            } else {
                // éæ—¶é—´å­—æ®µæŒ‰å€¼ä»é«˜åˆ°ä½æ’åº
                sortedStats = Object.entries(stats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, topN);
            }

            // é‡æ–°æ„å»ºç»Ÿè®¡æ•°æ®
            const finalStats = {};
            sortedStats.forEach(([key, value]) => {
                finalStats[key] = value;
            });

            // ç”Ÿæˆå›¾è¡¨
            const chartContainer = document.getElementById('dynamicChartContainer');
            if (chartType === 'pie') {
                chartContainer.innerHTML = createPieChart(finalStats, 'dynamicChart');
            } else if (chartType === 'line') {
                chartContainer.innerHTML = createLineChart(finalStats, 'dynamicChart');
            } else {
                chartContainer.innerHTML = createBarChart(finalStats, 'dynamicChart');
            }

            // ç»‘å®šå›¾è¡¨äº‹ä»¶
            bindDynamicChartEvents();
        }

        // æ¸…é™¤è‡ªå®šä¹‰å›¾è¡¨
        function clearDynamicChart() {
            document.getElementById('dynamicChartContainer').innerHTML = `
                <div style="text-align: center; color: #666;">
                    <p>è¯·é€‰æ‹©å­—æ®µå¹¶ç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®</p>
                </div>
            `;
        }

        // ä¿å­˜å›¾è¡¨åˆ°é¡¹ç›®è¯¦æƒ…
        function saveChartToProjectDetails() {
            const fieldName = document.getElementById('fieldSelector').value;
            const chartType = document.getElementById('chartTypeSelector').value;
            const topN = parseInt(document.getElementById('topNSelector').value) || 10;

            if (!fieldName) {
                alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨ï¼');
                return;
            }

            // è·å–å­—æ®µæ ‡ç­¾
            const fieldSelector = document.getElementById('fieldSelector');
            const selectedOption = fieldSelector.options[fieldSelector.selectedIndex];
            const fieldLabel = selectedOption ? selectedOption.text : fieldName;

            // åˆ›å»ºå›¾è¡¨é…ç½®å¯¹è±¡
            const chartConfig = {
                id: Date.now(), // å”¯ä¸€ID
                fieldName: fieldName,
                fieldLabel: fieldLabel,
                chartType: chartType,
                topN: topN,
                title: `${fieldLabel}åˆ†å¸ƒ`,
                projects: window.currentProjectsForChart,
                status: window.currentChartStatus,
                createTime: new Date().toLocaleString('zh-CN')
            };

            // ä¿å­˜åˆ°localStorageï¼Œæ”¯æŒå¤šä¸ªå›¾è¡¨
            const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
            const key = `${window.currentChartTitle}_${window.currentChartStatus}`;

            if (!savedCharts[key]) {
                savedCharts[key] = [];
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå­—æ®µçš„å›¾è¡¨
            const existingIndex = savedCharts[key].findIndex(chart => chart.fieldName === fieldName);
            if (existingIndex !== -1) {
                if (confirm(`å·²å­˜åœ¨"${fieldLabel}"çš„å›¾è¡¨ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ`)) {
                    savedCharts[key][existingIndex] = chartConfig;
                } else {
                    return; // ç”¨æˆ·å–æ¶ˆæ›¿æ¢
                }
            } else {
                savedCharts[key].push(chartConfig);
            }

            localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));

            alert(`å›¾è¡¨å·²ä¿å­˜ï¼ä¸‹æ¬¡è¿›å…¥"${window.currentChartTitle}"æ—¶å°†è‡ªåŠ¨æ˜¾ç¤ºæ­¤å›¾è¡¨ã€‚`);

            // åˆ·æ–°å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨
            populateSavedChartsList();
        }

        // ç»‘å®šè‡ªå®šä¹‰å›¾è¡¨äº‹ä»¶
        function bindDynamicChartEvents() {
            const chartContainer = document.getElementById('dynamicChartContainer');

            // ä¸ºé¥¼å›¾çš„æ‰‡å½¢æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
            segments.forEach(segment => {
                const label = segment.getAttribute('data-label');
                const value = segment.getAttribute('data-value');
                if (label && value) {
                    segment.onclick = () => {
                        alert(`ç‚¹å‡»äº†: ${label}, æ•°é‡: ${value}`);
                    };
                }
            });

            // ä¸ºæŸ±çŠ¶å›¾çš„æŸ±å­æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const bars = chartContainer.querySelectorAll('div[data-label][data-value]');
            bars.forEach(bar => {
                const label = bar.getAttribute('data-label');
                const value = bar.getAttribute('data-value');
                if (label && value) {
                    if (bar.style.background || bar.style.backgroundColor) {
                        bar.onclick = () => {
                            alert(`ç‚¹å‡»äº†: ${label}, æ•°é‡: ${value}`);
                        };
                    }
                }
            });
        }

        // åˆ›å»ºæŠ˜çº¿å›¾
        function createLineChart(data, chartId) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            const maxValue = Math.max(...values);

            let svg = `<svg width="100%" height="100%" viewBox="0 0 800 400">`;

            // ç»˜åˆ¶åæ ‡è½´
            svg += `<line x1="50" y1="350" x2="750" y2="350" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="50" y1="50" x2="50" y2="350" stroke="#333" stroke-width="2"/>`;

            // ç»˜åˆ¶æŠ˜çº¿
            if (labels.length > 1) {
                let pathData = '';
                labels.forEach((label, index) => {
                    const x = 50 + (index * 700) / (labels.length - 1);
                    const y = 350 - (values[index] * 300) / maxValue;

                    if (index === 0) {
                        pathData = `M ${x} ${y}`;
                    } else {
                        pathData += ` L ${x} ${y}`;
                    }
                });

                svg += `<path d="${pathData}" stroke="#007bff" stroke-width="3" fill="none"/>`;

                // ç»˜åˆ¶æ•°æ®ç‚¹
                labels.forEach((label, index) => {
                    const x = 50 + (index * 700) / (labels.length - 1);
                    const y = 350 - (values[index] * 300) / maxValue;

                    // æ£€æŸ¥æ˜¯å¦ä¸ºä¿å­˜çš„å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    const isSavedChart = chartId.startsWith('savedChart_');
                    const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${chartId}', event)"` : '';

                    svg += `<circle cx="${x}" cy="${y}" r="5" fill="#007bff" style="cursor: pointer;" data-label="${label}" data-value="${values[index]}" ${clickEvent}/>`;
                    svg += `<text x="${x}" y="${y + 20}" text-anchor="middle" font-size="12" fill="#333">${values[index]}</text>`;
                });
            }

            // ç»˜åˆ¶æ ‡ç­¾
            labels.forEach((label, index) => {
                const x = 50 + (index * 700) / (labels.length - 1);
                svg += `<text x="${x}" y="380" text-anchor="middle" font-size="10" fill="#666">${label}</text>`;
            });

            svg += `</svg>`;
            return svg;
        }

        // è·å–å›¾è¡¨ç±»å‹åç§°
        function getChartTypeName(chartType) {
            const typeNames = {
                'bar': 'æŸ±çŠ¶å›¾',
                'pie': 'é¥¼å›¾',
                'line': 'æŠ˜çº¿å›¾'
            };
            return typeNames[chartType] || chartType;
        }

        // ç”Ÿæˆä¿å­˜çš„å›¾è¡¨
        function generateSavedChart(chartConfig, projects, containerId) {
            // ç»Ÿè®¡æ•°æ®
            const stats = {};
            const valueToProjects = {}; // å­˜å‚¨æ¯ä¸ªå€¼å¯¹åº”çš„é¡¹ç›®åˆ—è¡¨

            projects.forEach(project => {
                let value = project[chartConfig.fieldName];

                // å¤„ç†ä¸åŒç±»å‹çš„å€¼ï¼ˆä¸generateDynamicChartä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
                if (value === null || value === undefined || value === '') {
                    value = 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName === 'scheduleDays') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å¤©';
                } else if (chartConfig.fieldName === 'testDuration') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å°æ—¶';
                } else if (chartConfig.fieldName === 'sample_frequency') {
                    value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'æ¬¡';
                } else if (chartConfig.fieldName === 'isUsed') {
                    value = value === 1 ? 'å·²ç”¨' : value === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName === 'isCancel') {
                    value = value === 1 ? 'å·²ä½œåºŸ' : value === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName === 'high_frequency') {
                    value = value === '1' || value === 1 ? 'æ˜¯' : value === '0' || value === 0 ? 'å¦' : value || 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
                    if (value && value !== 'æœªè®¾ç½®') {
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                value = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            value = 'æ— æ•ˆæ—¥æœŸ';
                        }
                    }
                } else if (['priority', 'sample_type'].includes(chartConfig.fieldName)) {
                    if (value && value.trim() !== '') {
                        value = value.trim();
                    } else {
                        value = value || 'æœªè®¾ç½®';
                    }
                } else if (chartConfig.fieldName === 'schedule') {
                    // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                    if (value !== null && value !== undefined && value !== '') {
                        // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                        const progressMap = {
                            '0': 'æœªå¼€å§‹',
                            '1': 'è¿›è¡Œä¸­',
                            '2': 'å·²å®Œæˆ',
                            '3': 'å·²æš‚åœ',
                            '4': 'å·²å–æ¶ˆ'
                        };
                        value = progressMap[value.toString()] || `è¿›åº¦${value}`;
                    } else {
                        value = 'æœªè®¾ç½®';
                    }
                }

                stats[value] = (stats[value] || 0) + 1;

                // å­˜å‚¨æ¯ä¸ªå€¼å¯¹åº”çš„é¡¹ç›®åˆ—è¡¨
                if (!valueToProjects[value]) {
                    valueToProjects[value] = [];
                }
                valueToProjects[value].push(project);
            });

            // æ’åºå¹¶å–å‰Nä¸ª
            let sortedStats;

            // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¶é—´å­—æ®µï¼Œå¦‚æœæ˜¯åˆ™æŒ‰æ—¶é—´é¡ºåºæ’åº
            if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
                // å¯¹æ—¶é—´å­—æ®µæŒ‰æ—¶é—´é¡ºåºæ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
                sortedStats = Object.entries(stats)
                    .filter(([key]) => key !== 'æœªè®¾ç½®' && key !== 'æ— æ•ˆæ—¥æœŸ') // å…ˆè¿‡æ»¤æ‰ç‰¹æ®Šå€¼
                    .sort((a, b) => {
                        // å°è¯•è§£ææ—¥æœŸè¿›è¡Œæ¯”è¾ƒ
                        try {
                            const dateA = new Date(a[0]);
                            const dateB = new Date(b[0]);
                            if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                                return dateA - dateB; // æŒ‰æ—¶é—´ä»æ—©åˆ°æ™šæ’åº
                            }
                            return a[0].localeCompare(b[0]); // å¦‚æœè§£æå¤±è´¥ï¼ŒæŒ‰å­—ç¬¦ä¸²æ’åº
                        } catch (e) {
                            return a[0].localeCompare(b[0]);
                        }
                    })
                    .slice(0, chartConfig.topN);

                // å¦‚æœæœ‰ç‰¹æ®Šå€¼ï¼Œæ·»åŠ åˆ°æœ«å°¾
                if (stats['æœªè®¾ç½®']) {
                    sortedStats.push(['æœªè®¾ç½®', stats['æœªè®¾ç½®']]);
                }
                if (stats['æ— æ•ˆæ—¥æœŸ']) {
                    sortedStats.push(['æ— æ•ˆæ—¥æœŸ', stats['æ— æ•ˆæ—¥æœŸ']]);
                }
            } else {
                // éæ—¶é—´å­—æ®µæŒ‰å€¼ä»é«˜åˆ°ä½æ’åº
                sortedStats = Object.entries(stats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, chartConfig.topN);
            }

            // é‡æ–°æ„å»ºç»Ÿè®¡æ•°æ®
            const finalStats = {};
            sortedStats.forEach(([key, value]) => {
                finalStats[key] = value;
            });

            // ä¸ºå›¾è¡¨æ·»åŠ ç‚¹å‡»äº‹ä»¶æ•°æ®
            const chartId = containerId || `savedChart_${chartConfig.id || Date.now()}`;
            const clickData = {
                chartConfig: chartConfig,
                valueToProjects: valueToProjects,
                projects: projects
            };

            // å­˜å‚¨ç‚¹å‡»æ•°æ®åˆ°å…¨å±€å˜é‡
            window.savedChartClickData = window.savedChartClickData || {};
            window.savedChartClickData[chartId] = clickData;

            // ç”Ÿæˆå›¾è¡¨å¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶æ ‡è¯†
            let chartHTML = '';
            if (chartConfig.chartType === 'pie') {
                chartHTML = createPieChart(finalStats, chartId);
            } else if (chartConfig.chartType === 'line') {
                chartHTML = createLineChart(finalStats, chartId);
            } else {
                chartHTML = createBarChart(finalStats, chartId);
            }

            return chartHTML;
        }

        // åˆ é™¤ä¿å­˜çš„å›¾è¡¨
        function removeSavedChart(chartKey, chartId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰å›¾è¡¨å—ï¼Ÿ')) {
                const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');

                if (savedCharts[chartKey]) {
                    // ä»æ•°ç»„ä¸­åˆ é™¤æŒ‡å®šIDçš„å›¾è¡¨
                    savedCharts[chartKey] = savedCharts[chartKey].filter(chart => chart.id !== chartId);

                    // å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ é™¤æ•´ä¸ªkey
                    if (savedCharts[chartKey].length === 0) {
                        delete savedCharts[chartKey];
                    }

                    localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
                }

                // é‡æ–°åŠ è½½å›¾è¡¨ç®¡ç†ç•Œé¢
                const currentTitle = window.currentChartTitle;
                const currentProjects = window.currentProjectsForChart;
                const currentStatus = window.currentChartStatus;

                if (currentTitle && currentProjects) {
                    showModalCharts(currentTitle, currentProjects, currentStatus);
                }
            }
        }

        // å¡«å……å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨
        function populateSavedChartsList() {
            const savedChartsList = document.getElementById('savedChartsList');
            const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
            const chartKey = `${window.currentChartTitle}_${window.currentChartStatus}`;
            let charts = savedCharts[chartKey] || [];

            // ç¡®ä¿chartsæ˜¯æ•°ç»„
            if (!Array.isArray(charts)) {
                // å¦‚æœæ˜¯æ—§æ ¼å¼çš„å•ä¸ªå›¾è¡¨ï¼Œè½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
                if (charts && typeof charts === 'object' && charts.fieldName) {
                    charts = [charts];
                    // æ›´æ–°localStorageä¸ºæ–°çš„æ•°ç»„æ ¼å¼
                    savedCharts[chartKey] = charts;
                    localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
                } else {
                    charts = [];
                }
            }

            if (charts.length === 0) {
                savedChartsList.innerHTML = '<p style="color: #666; text-align: center;">æš‚æ— ä¿å­˜çš„å›¾è¡¨</p>';
                return;
            }

            let html = '';
            charts.forEach((chart, index) => {
                html += `
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #333;">${chart.title}</strong>
                                <span style="color: #666; font-size: 12px; margin-left: 10px;">å­—æ®µ: ${chart.fieldLabel}</span>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-outline-primary" onclick="loadSavedChart('${chartKey}', ${chart.id})" title="åŠ è½½æ­¤å›¾è¡¨">ğŸ“Š</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeSavedChart('${chartKey}', ${chart.id})" title="åˆ é™¤æ­¤å›¾è¡¨">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ç±»å‹: ${getChartTypeName(chart.chartType)} | æ˜¾ç¤º: å‰${chart.topN}ä¸ª | åˆ›å»º: ${chart.createTime}
                        </div>
                    </div>
                `;
            });

            savedChartsList.innerHTML = html;
        }

        // åŠ è½½ä¿å­˜çš„å›¾è¡¨åˆ°å›¾è¡¨å®¹å™¨
        function loadSavedChart(chartKey, chartId) {
            const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
            const charts = savedCharts[chartKey] || [];
            const chart = charts.find(c => c.id === chartId);

            if (chart) {
                // è®¾ç½®å­—æ®µé€‰æ‹©å™¨
                document.getElementById('fieldSelector').value = chart.fieldName;
                document.getElementById('chartTypeSelector').value = chart.chartType;
                document.getElementById('topNSelector').value = chart.topN;

                // ç”Ÿæˆå›¾è¡¨
                generateDynamicChart();

                alert(`å·²åŠ è½½"${chart.title}"å›¾è¡¨é…ç½®`);
            }
        }

        // å¤„ç†ä¿å­˜å›¾è¡¨çš„ç‚¹å‡»äº‹ä»¶
        function handleSavedChartClick(chartId, event) {
            console.log('ä¿å­˜å›¾è¡¨ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼ŒchartId:', chartId);

            const clickData = window.savedChartClickData[chartId];
            if (!clickData) {
                console.error('æœªæ‰¾åˆ°å›¾è¡¨ç‚¹å‡»æ•°æ®ï¼ŒchartId:', chartId);
                return;
            }

            // è·å–ç‚¹å‡»çš„å…ƒç´ 
            const target = event.target;
            let label = '';
            let value = 0;

            // æ ¹æ®å›¾è¡¨ç±»å‹è·å–ç‚¹å‡»çš„æ ‡ç­¾å’Œå€¼
            if (clickData.chartConfig.chartType === 'pie') {
                // é¥¼å›¾ï¼šä»pathå…ƒç´ è·å–æ•°æ®
                if (target.tagName === 'path' && target.getAttribute('data-label')) {
                    label = target.getAttribute('data-label');
                    value = parseInt(target.getAttribute('data-value')) || 0;
                }
            } else if (clickData.chartConfig.chartType === 'bar') {
                // æŸ±çŠ¶å›¾ï¼šä»divå…ƒç´ è·å–æ•°æ®
                if (target.getAttribute('data-label')) {
                    label = target.getAttribute('data-label');
                    value = parseInt(target.getAttribute('data-value')) || 0;
                }
            } else if (clickData.chartConfig.chartType === 'line') {
                // æŠ˜çº¿å›¾ï¼šä»circleå…ƒç´ è·å–æ•°æ®
                if (target.tagName === 'circle') {
                    label = target.getAttribute('data-label');
                    value = parseInt(target.getAttribute('data-value')) || 0;
                }
            }

            if (label && value > 0) {
                // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
                const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
                let originalProjects = [];

                // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
                switch(modalTitle) {
                    case 'é¡¹ç›®æ€»æ•°':
                        originalProjects = projectData;
                        break;
                    case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                        originalProjects = projectData.filter(p =>
                            !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                        );
                        break;
                    case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                        originalProjects = projectData.filter(p =>
                            p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                        );
                        break;
                    case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                        originalProjects = projectData.filter(p =>
                            p.actual_finish_time && !p.sampleRecognizeResult
                        );
                        break;
                    case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                        originalProjects = projectData.filter(p =>
                            p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                        );
                        break;
                }

                // æ ¹æ®è‡ªå®šä¹‰å›¾è¡¨çš„å­—æ®µå’Œæ ‡ç­¾ç­›é€‰é¡¹ç›®
                let filteredProjects = originalProjects.filter(project => {
                    let projectValue = project[clickData.chartConfig.fieldName];

                    // å¤„ç†ä¸åŒç±»å‹çš„å€¼ï¼Œä¸ç”Ÿæˆå›¾è¡¨æ—¶çš„é€»è¾‘ä¿æŒä¸€è‡´
                    if (projectValue === null || projectValue === undefined || projectValue === '') {
                        projectValue = 'æœªè®¾ç½®';
                    } else if (clickData.chartConfig.fieldName === 'scheduleDays') {
                        projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å¤©';
                    } else if (clickData.chartConfig.fieldName === 'testDuration') {
                        projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å°æ—¶';
                    } else if (clickData.chartConfig.fieldName === 'sample_frequency') {
                        projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'æ¬¡';
                    } else if (clickData.chartConfig.fieldName === 'isUsed') {
                        projectValue = projectValue === 1 ? 'å·²ç”¨' : projectValue === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
                    } else if (clickData.chartConfig.fieldName === 'isCancel') {
                        projectValue = projectValue === 1 ? 'å·²ä½œåºŸ' : projectValue === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
                    } else if (clickData.chartConfig.fieldName === 'high_frequency') {
                        projectValue = projectValue === '1' || projectValue === 1 ? 'æ˜¯' : projectValue === '0' || projectValue === 0 ? 'å¦' : projectValue || 'æœªè®¾ç½®';
                    } else if (clickData.chartConfig.fieldName.includes('date') || clickData.chartConfig.fieldName.includes('time') || clickData.chartConfig.fieldName === 'reportReviewTime') {
                        if (projectValue && projectValue !== 'æœªè®¾ç½®') {
                            try {
                                const date = new Date(projectValue);
                                if (!isNaN(date.getTime())) {
                                    projectValue = date.toLocaleDateString('zh-CN');
                                }
                            } catch (e) {
                                projectValue = 'æ— æ•ˆæ—¥æœŸ';
                            }
                        }
                    } else if (['priority', 'sample_type'].includes(clickData.chartConfig.fieldName)) {
                        if (projectValue && projectValue.trim() !== '') {
                            projectValue = projectValue.trim();
                        } else {
                            projectValue = projectValue || 'æœªè®¾ç½®';
                        }
                    } else if (clickData.chartConfig.fieldName === 'schedule') {
                        // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                        if (projectValue !== null && projectValue !== undefined && projectValue !== '') {
                            // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                            const progressMap = {
                                '0': 'æœªå¼€å§‹',
                                '1': 'è¿›è¡Œä¸­',
                                '2': 'å·²å®Œæˆ',
                                '3': 'å·²æš‚åœ',
                                '4': 'å·²å–æ¶ˆ'
                            };
                            projectValue = progressMap[projectValue.toString()] || `è¿›åº¦${projectValue}`;
                        } else {
                            projectValue = 'æœªè®¾ç½®';
                        }
                    }

                    return projectValue === label;
                });

                // æ˜¾ç¤ºç­›é€‰åçš„æ•°æ®åˆ—è¡¨ï¼Œå°±åƒé»˜è®¤å›¾è¡¨ä¸€æ ·
                showModalDataList(`${modalTitle} - ${label}`, filteredProjects, null, true);

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                showFilterNotification(`${label}: å…±æ‰¾åˆ° ${filteredProjects.length} ä¸ªé¡¹ç›®`);
            }
        }

        // æ˜¾ç¤ºä¿å­˜å›¾è¡¨çš„æ•°æ®è¯¦æƒ…æ¨¡æ€æ¡†
        function showSavedChartDataModal(clickData, label, value) {
            const { chartConfig, valueToProjects, projects } = clickData;

            // è·å–å¯¹åº”æ ‡ç­¾çš„é¡¹ç›®åˆ—è¡¨
            let filteredProjects = [];
            if (valueToProjects[label]) {
                filteredProjects = valueToProjects[label];
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»åŸå§‹æ•°æ®ä¸­ç­›é€‰
                filteredProjects = projects.filter(project => {
                    let projectValue = project[chartConfig.fieldName];

                    // å¤„ç†ä¸åŒç±»å‹çš„å€¼
                    if (projectValue === null || projectValue === undefined || projectValue === '') {
                        projectValue = 'æœªè®¾ç½®';
                    } else if (chartConfig.fieldName === 'scheduleDays') {
                        projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å¤©';
                    } else if (chartConfig.fieldName === 'testDuration') {
                        projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å°æ—¶';
                    } else if (chartConfig.fieldName === 'sample_frequency') {
                        projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'æ¬¡';
                    } else if (chartConfig.fieldName === 'isUsed') {
                        projectValue = projectValue === 1 ? 'å·²ç”¨' : value === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
                    } else if (chartConfig.fieldName === 'isCancel') {
                        projectValue = projectValue === 1 ? 'å·²ä½œåºŸ' : projectValue === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
                    } else if (chartConfig.fieldName === 'high_frequency') {
                        projectValue = projectValue === '1' || projectValue === 1 ? 'æ˜¯' : projectValue === '0' || projectValue === 0 ? 'å¦' : projectValue || 'æœªè®¾ç½®';
                    } else if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
                        if (projectValue && projectValue !== 'æœªè®¾ç½®') {
                            try {
                                const date = new Date(projectValue);
                                if (!isNaN(date.getTime())) {
                                    projectValue = date.toLocaleDateString('zh-CN');
                                }
                            } catch (e) {
                                projectValue = 'æ— æ•ˆæ—¥æœŸ';
                            }
                        }
                    } else if (['priority', 'sample_type'].includes(chartConfig.fieldName)) {
                        if (projectValue && projectValue.trim() !== '') {
                            projectValue = projectValue.trim();
                        } else {
                            projectValue = 'æœªè®¾ç½®';
                        }
                    } else if (chartConfig.fieldName === 'schedule') {
                        // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                        if (projectValue !== null && projectValue !== undefined && projectValue !== '') {
                            // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                            const progressMap = {
                                '0': 'æœªå¼€å§‹',
                                '1': 'è¿›è¡Œä¸­',
                                '2': 'å·²å®Œæˆ',
                                '3': 'å·²æš‚åœ',
                                '4': 'å·²å–æ¶ˆ'
                            };
                            projectValue = progressMap[projectValue.toString()] || `è¿›åº¦${projectValue}`;
                        } else {
                            projectValue = 'æœªè®¾ç½®';
                        }
                    }

                    return projectValue === label;
                });
            }

            // åˆ›å»ºæ•°æ®è¯¦æƒ…æ¨¡æ€æ¡†
            const modalHTML = `
                <div id="savedChartDataModal" class="modal">
                    <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90%; max-height: 800px;">
                        <div class="modal-header">
                            <h3>${chartConfig.title} - ${label} (${filteredProjects.length}ä¸ªé¡¹ç›®)</h3>
                            <span class="close" onclick="closeSavedChartDataModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span style="color: #666;">å­—æ®µ: ${chartConfig.fieldLabel}</span>
                                    <span style="color: #666;">|</span>
                                    <span style="color: #666;">å›¾è¡¨ç±»å‹: ${getChartTypeName(chartConfig.chartType)}</span>
                                    <span style="color: #666;">|</span>
                                    <span style="color: #666;">æ˜¾ç¤ºæ•°é‡: å‰${chartConfig.topN}ä¸ª</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th>æ ·å“ç¼–å·</th>
                                            <th>äº§å“åç§°</th>
                                            <th>äº§å“ç±»åˆ«</th>
                                            <th>å¤§ç¼–ç </th>
                                            <th>ç‰©æ–™ç¼–ç </th>
                                            <th>ç‰ˆæœ¬</th>
                                            <th>é¡¹ç›®è´Ÿè´£äºº</th>
                                            <th>å½“å‰è¿›åº¦</th>
                                            <th>æµ‹è¯•è´Ÿè´£äºº</th>
                                            <th>DQEè´Ÿè´£äºº</th>
                                            <th>ç ”å‘è´Ÿè´£äºº</th>
                                            <th>é€æ ·äºº</th>
                                            <th>é€æ ·ç±»åˆ«</th>
                                            <th>é€æ ·æ•°é‡</th>
                                            <th>æ˜¯å¦é«˜é¢‘</th>
                                            <th>æå•æ—¶é—´</th>
                                            <th>æ’æœŸå¤©æ•°</th>
                                            <th>æ’æœŸå¼€å§‹</th>
                                            <th>æ’æœŸç»“æŸ</th>
                                            <th>å®é™…å¼€å§‹æ—¶é—´</th>
                                            <th>å®é™…å®Œæˆæ—¶é—´</th>
                                            <th>DQEæ‰¿è®¤ç»“æœ</th>
                                            <th>ç ”å‘æ‰¿è®¤ç»“æœ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredProjects.map(project => {
                // æ ¹æ®å®é™…æ—¶é—´åˆ¤æ–­é¡¹ç›®çŠ¶æ€
                let statusText = 'æœªå¼€å§‹';
                let statusColor = '#ffc107';

                if (project.actual_start_time && !project.actual_finish_time) {
                    statusText = 'è¿›è¡Œä¸­';
                    statusColor = '#17a2b8';
                } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                    statusText = 'å·²å®Œæˆæœªç¡®è®¤';
                    statusColor = '#a72828';
                } else if (project.actual_finish_time && project.sampleRecognizeResult) {
                    statusText = 'æŠ¥å‘Šç¡®è®¤é—­ç¯';
                    statusColor = '#28a745';
                }

                return `
                                                <tr>
                                                    <td><strong>${project.sample_id || '-'}</strong></td>
                                                    <td>${project.sample_name || '-'}</td>
                                                    <td>${project.sample_category || '-'}</td>
                                                    <td>${project.sample_model || '-'}</td>
                                                    <td>${project.materialCode || '-'}</td>
                                                    <td>${project.version || '-'}</td>
                                                    <td>${project.sample_leader || '-'}</td>
                                                    <td>
                                                        <span style="color: ${statusColor}; font-weight: bold;">
                                                            ${statusText}
                                                        </span>
                                                    </td>
                                                    <td>${project.tester || '-'}</td>
                                                    <td>${project.dqe_leader || '-'}</td>
                                                    <td>${project.rd_leader || '-'}</td>
                                                    <td>${project.sample_sender || '-'}</td>
                                                    <td>${project.sample_type || '-'}</td>
                                                    <td>${project.sample_quantity || '-'}</td>
                                                    <td>${project.high_frequency || '-'}</td>
                                                    <td>${formatDateTime(project.create_time) || '-'}</td>
                                                    <td>${project.scheduleDays || '-'}</td>
                                                    <td>${formatDate(project.schedule_start_date) || '-'}</td>
                                                    <td>${formatDate(project.schedule_end_date) || '-'}</td>
                                                    <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                                                    <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                                                    <td>${project.sampleRecognizeResult || '-'}</td>
                                                    <td>${project.sampleRecognizeResult || '-'}</td>
                                                    <td>${project.rd_sampleRecognizeResult || '-'}</td>
                                                </tr>
                                            `;
            }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('savedChartDataModal').style.display = 'block';
        }

        // å…³é—­ä¿å­˜å›¾è¡¨çš„æ•°æ®è¯¦æƒ…æ¨¡æ€æ¡†
        function closeSavedChartDataModal() {
            const modal = document.getElementById('savedChartDataModal');
            if (modal) {
                modal.remove();
            }
        }





        // è½¬æ¢ä¸ºCSVæ ¼å¼
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [];

            // æ·»åŠ æ ‡é¢˜è¡Œ
            csvRows.push(headers.join(','));

            // æ·»åŠ æ•°æ®è¡Œ
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    // å¤„ç†åŒ…å«é€—å·çš„å€¼
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                });
                csvRows.push(values.join(','));
            });

            return csvRows.join('\n');
        }

        // åº”ç”¨æ•°æ®é™åˆ¶
        function applyDataLimit(data, limit) {
            if (!data || typeof data !== 'object') return data;

            // å¦‚æœé™åˆ¶ä¸º0ï¼Œæ˜¾ç¤ºå…¨éƒ¨æ•°æ®
            if (limit === 0) return data;

            // å°†æ•°æ®è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰å€¼æ’åº
            const entries = Object.entries(data);
            const sortedEntries = entries.sort((a, b) => b[1] - a[1]);

            // å–å‰Nä¸ª
            const limitedEntries = sortedEntries.slice(0, limit);

            // è½¬æ¢å›å¯¹è±¡
            const limitedData = {};
            limitedEntries.forEach(([key, value]) => {
                limitedData[key] = value;
            });

            return limitedData;
        }

        // æ›´æ–°å›¾è¡¨æ˜¾ç¤ºé™åˆ¶
        function updateChartDisplayLimit() {
            const selectElement = document.getElementById('chartDisplayLimit');
            if (!selectElement) return;

            const newLimit = parseInt(selectElement.value);
            window.currentDisplayLimit = newLimit;

            // ç›´æ¥åˆ·æ–°å½“å‰å›¾è¡¨
            refreshCurrentChart();
        }

        // åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼
        function toggleDisplayMode() {
            console.log('toggleDisplayMode è¢«è°ƒç”¨');
            const selectElement = document.getElementById('chartDisplayLimit');
            if (!selectElement) {
                console.log('æ²¡æœ‰æ‰¾åˆ°é€‰æ‹©å™¨å…ƒç´ ');
                return;
            }

            // åœ¨å¸¸ç”¨é€‰é¡¹ä¹‹é—´åˆ‡æ¢
            const currentValue = parseInt(selectElement.value);
            let newValue;

            switch (currentValue) {
                case 10:
                    newValue = 20;
                    break;
                case 20:
                    newValue = 50;
                    break;
                case 50:
                    newValue = 0;
                    break;
                case 0:
                    newValue = 10;
                    break;
                default:
                    newValue = 10;
            }

            console.log('åˆ‡æ¢ä»', currentValue, 'åˆ°', newValue);
            selectElement.value = newValue;
            updateChartDisplayLimit();
        }

        // åˆ·æ–°å½“å‰å›¾è¡¨ï¼ˆç›´æ¥æ–¹æ³•ï¼‰
        function refreshCurrentChart() {
            console.log('refreshCurrentChart è¢«è°ƒç”¨');

            if (!window.currentChartConfigs || window.currentChartConfigs.length === 0) {
                console.log('æ²¡æœ‰æ‰¾åˆ°å›¾è¡¨é…ç½®');
                return;
            }

            // æ‰¾åˆ°å½“å‰æ˜¾ç¤ºçš„å›¾è¡¨
            const chartDisplayArea = document.getElementById('chartDisplayArea');
            if (!chartDisplayArea) {
                console.log('æ²¡æœ‰æ‰¾åˆ°å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ');
                return;
            }

            // å°è¯•å¤šç§æ–¹å¼æ‰¾åˆ°å›¾è¡¨å…ƒç´ 
            let currentChartElement = chartDisplayArea.querySelector('[id^="chart"]:not(#chartDisplayLimit)');
            if (!currentChartElement) {
                // å°è¯•æŸ¥æ‰¾è‡ªå®šä¹‰å›¾è¡¨å®¹å™¨
                currentChartElement = chartDisplayArea.querySelector('[id^="customChart_"]');
            }
            if (!currentChartElement) {
                // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å›¾è¡¨å®¹å™¨ï¼Œæ’é™¤æ§åˆ¶å…ƒç´ 
                currentChartElement = chartDisplayArea.querySelector('div[id]:not(#chartDisplayLimit):not(#currentDataCount)');
            }
            if (!currentChartElement) {
                console.log('æ²¡æœ‰æ‰¾åˆ°å½“å‰å›¾è¡¨å…ƒç´ ');
                return;
            }

            const currentChartId = currentChartElement.id;
            console.log('å½“å‰å›¾è¡¨ID:', currentChartId);

            const config = window.currentChartConfigs.find(c => c.id === currentChartId);
            if (!config) {
                console.log('æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å›¾è¡¨é…ç½®ï¼Œå½“å‰å›¾è¡¨ID:', currentChartId);
                console.log('å¯ç”¨çš„å›¾è¡¨é…ç½®:', window.currentChartConfigs.map(c => c.id));
                
                // å¦‚æœæ˜¯è‡ªå®šä¹‰å›¾è¡¨ï¼Œå°è¯•ä»localStorageä¸­è·å–é…ç½®
                if (currentChartId.startsWith('customChart_')) {
                    const chartId = currentChartId.replace('customChart_', '');
                    console.log('å°è¯•ä»localStorageè·å–è‡ªå®šä¹‰å›¾è¡¨é…ç½®ï¼ŒchartId:', chartId);
                    
                    // ä»localStorageä¸­è·å–è‡ªå®šä¹‰å›¾è¡¨é…ç½®
                    const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
                    const chartKey = `${window.currentChartTitle}_${window.currentChartStatus}`;
                    const savedChartsList = savedCharts[chartKey];
                    const savedChart = savedChartsList ? savedChartsList.find(chart => chart.id == chartId) : null;
                    
                    if (savedChart && window.currentProjects) {
                        console.log('æ‰¾åˆ°è‡ªå®šä¹‰å›¾è¡¨é…ç½®ï¼Œå­—æ®µ:', savedChart.fieldName);
                        
                        // é‡æ–°ç”Ÿæˆæ•°æ®
                        const chartData = getChartDataFromSavedChart(savedChart, window.currentProjects);
                        const limitedData = applyDataLimit(chartData, window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10);
                        
                        // æ›´æ–°æ•°æ®ç»„æ•°æ˜¾ç¤º
                        const dataCountElement = document.getElementById('currentDataCount');
                        if (dataCountElement) {
                            const totalCount = Object.keys(chartData).length;
                            const displayCount = Object.keys(limitedData).length;
                            if (window.currentDisplayLimit === 0) {
                                dataCountElement.textContent = `å…¨éƒ¨(${totalCount})`;
                            } else if (displayCount < totalCount) {
                                dataCountElement.textContent = `${displayCount}/${totalCount}...`;
                            } else {
                                dataCountElement.textContent = `${displayCount}/${totalCount}`;
                            }
                        }
                        
                        // æ£€æµ‹å½“å‰å›¾è¡¨ç±»å‹å¹¶é‡æ–°ç”Ÿæˆ
                        const svgElement = currentChartElement.querySelector('svg');
                        const flexElement = currentChartElement.querySelector('div[style*="display: flex"]');
                        
                        if (svgElement) {
                            // å½“å‰æ˜¯é¥¼å›¾ï¼Œé‡æ–°ç”Ÿæˆé¥¼å›¾
                            console.log('é‡æ–°ç”Ÿæˆè‡ªå®šä¹‰é¥¼å›¾');
                            currentChartElement.innerHTML = createPieChart(limitedData, currentChartId);
                        } else if (flexElement) {
                            // å½“å‰æ˜¯æŸ±çŠ¶å›¾ï¼Œé‡æ–°ç”ŸæˆæŸ±çŠ¶å›¾
                            console.log('é‡æ–°ç”Ÿæˆè‡ªå®šä¹‰æŸ±çŠ¶å›¾');
                            currentChartElement.innerHTML = createBarChart(limitedData, currentChartId);
                        } else {
                            // é»˜è®¤ç”ŸæˆæŸ±çŠ¶å›¾
                            console.log('é»˜è®¤ç”Ÿæˆè‡ªå®šä¹‰æŸ±çŠ¶å›¾');
                            currentChartElement.innerHTML = createBarChart(limitedData, currentChartId);
                        }
                        
                        // é‡æ–°ç»‘å®šäº‹ä»¶
                        bindChartClickEvents(currentChartId);
                        bindTooltipEvents(currentChartId);
                        
                        console.log('è‡ªå®šä¹‰å›¾è¡¨åˆ·æ–°å®Œæˆ');
                        return;
                    }
                }
                
                console.log('æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å›¾è¡¨é…ç½®ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®');
                // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„é…ç½®ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®
                const firstConfig = window.currentChartConfigs[0];
                if (firstConfig) {
                console.log('ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®:', firstConfig.title);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°ç”Ÿæˆæ•°æ®
                let chartData = firstConfig.data;
                if (firstConfig.fieldName && window.currentProjects) {
                    // è¿™æ˜¯è‡ªå®šä¹‰å›¾è¡¨ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆæ•°æ®
                    console.log('é‡æ–°ç”Ÿæˆè‡ªå®šä¹‰å›¾è¡¨æ•°æ®ï¼Œå­—æ®µ:', firstConfig.fieldName);
                    chartData = getChartDataFromSavedChart(firstConfig, window.currentProjects);
                }
                
                // é‡æ–°ç”Ÿæˆæ•´ä¸ªå›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ
                const limitedData = applyDataLimit(chartData, window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10);

                // æ›´æ–°æ•°æ®ç»„æ•°æ˜¾ç¤º
                const dataCountElement = document.getElementById('currentDataCount');
                if (dataCountElement) {
                    const totalCount = Object.keys(chartData).length;
                    const displayCount = Object.keys(limitedData).length;
                    if (window.currentDisplayLimit === 0) {
                        dataCountElement.textContent = `å…¨éƒ¨(${totalCount})`;
                    } else if (displayCount < totalCount) {
                        dataCountElement.textContent = `${displayCount}/${totalCount}...`;
                    } else {
                        dataCountElement.textContent = `${displayCount}/${totalCount}`;
                    }
                }

                    // é‡æ–°ç”Ÿæˆæ•´ä¸ªå›¾è¡¨HTML
                    const chartHTML = `
                    <div style="width: 100%; height: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1;">${firstConfig.title}</h4>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <!-- å›¾è¡¨æ§åˆ¶æŒ‰é’® -->
                                <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <button class="zoom-btn" onclick="zoomChart('${firstConfig.id}', -1)" title="ç¼©å°" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('${firstConfig.id}', 1)" title="æ”¾å¤§" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('${firstConfig.id}', '${JSON.stringify(limitedData).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“Š</button>
                                </div>
                                <!-- æ•°æ®ç»„æ•°æ§åˆ¶ -->
                                <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <span style="font-size: 12px; color: #666; font-weight: 500;">æ•°æ®ç»„æ•°:</span>
                                    <select id="chartDisplayLimit" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s;" onchange="updateChartDisplayLimit()" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#ddd'">
                                        <option value="10" ${window.currentDisplayLimit === 10 ? 'selected' : ''}>å‰10ç»„</option>
                                        <option value="20" ${window.currentDisplayLimit === 20 ? 'selected' : ''}>å‰20ç»„</option>
                                        <option value="50" ${window.currentDisplayLimit === 50 ? 'selected' : ''}>å‰50ç»„</option>
                                        <option value="0" ${window.currentDisplayLimit === 0 ? 'selected' : ''}>å…¨éƒ¨æ•°æ®</option>
                                    </select>
                                    <span id="currentDataCount" style="font-size: 12px; color: #007bff; font-weight: 600; min-width: 40px; text-align: center;">${window.currentDisplayLimit === 0 ? `å…¨éƒ¨(${Object.keys(chartData).length})` : (Object.keys(limitedData).length < Object.keys(chartData).length ? `${Object.keys(limitedData).length}/${Object.keys(chartData).length}...` : `${Object.keys(limitedData).length}/${Object.keys(chartData).length}`)}</span>
                                    <button onclick="toggleDisplayMode()" style="background: #007bff; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;" title="å¿«é€Ÿåˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                        ğŸ”„
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="${firstConfig.id}" style="height: 450px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                            ${createBarChart(limitedData, firstConfig.id)}
                        </div>
                    </div>
                `;

                    chartDisplayArea.innerHTML = chartHTML;

                    // ç¡®ä¿selectå…ƒç´ çš„å€¼æ­£ç¡®è®¾ç½®
                    const newSelectElement = document.getElementById('chartDisplayLimit');
                    if (newSelectElement) {
                        newSelectElement.value = window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10;
                    }

                    // é‡æ–°ç»‘å®šäº‹ä»¶
                    bindChartClickEvents(firstConfig.id);
                    bindTooltipEvents(firstConfig.id);

                    console.log('å›¾è¡¨åˆ·æ–°å®Œæˆï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®ï¼‰');
                    return;
                }
            }

            console.log('æ‰¾åˆ°å›¾è¡¨é…ç½®:', config.title);

            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°ç”Ÿæˆæ•°æ®
            let chartData = config.data;
            if (config.fieldName && window.currentProjects) {
                // è¿™æ˜¯è‡ªå®šä¹‰å›¾è¡¨ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆæ•°æ®
                console.log('é‡æ–°ç”Ÿæˆè‡ªå®šä¹‰å›¾è¡¨æ•°æ®ï¼Œå­—æ®µ:', config.fieldName);
                chartData = getChartDataFromSavedChart(config, window.currentProjects);
            }

            // åº”ç”¨æ•°æ®é™åˆ¶
            const limitedData = applyDataLimit(chartData, window.currentDisplayLimit !== undefined ? window.currentDisplayLimit : 10);
            console.log('é™åˆ¶åçš„æ•°æ®:', limitedData);

            // æ›´æ–°æ•°æ®ç»„æ•°æ˜¾ç¤º
            const dataCountElement = document.getElementById('currentDataCount');
            if (dataCountElement) {
                const totalCount = Object.keys(chartData).length;
                const displayCount = Object.keys(limitedData).length;
                if (window.currentDisplayLimit === 0) {
                    dataCountElement.textContent = `å…¨éƒ¨(${totalCount})`;
                } else if (displayCount < totalCount) {
                    dataCountElement.textContent = `${displayCount}/${totalCount}...`;
                } else {
                    dataCountElement.textContent = `${displayCount}/${totalCount}`;
                }
                console.log('æ›´æ–°æ•°æ®ç»„æ•°æ˜¾ç¤º:', dataCountElement.textContent);
            }

            // æ£€æµ‹å½“å‰å›¾è¡¨ç±»å‹å¹¶é‡æ–°ç”Ÿæˆ
            const svgElement = currentChartElement.querySelector('svg');
            const flexElement = currentChartElement.querySelector('div[style*="display: flex"]');

            console.log('SVGå…ƒç´ :', svgElement);
            console.log('Flexå…ƒç´ :', flexElement);

            if (svgElement) {
                // å½“å‰æ˜¯é¥¼å›¾ï¼Œé‡æ–°ç”Ÿæˆé¥¼å›¾
                console.log('é‡æ–°ç”Ÿæˆé¥¼å›¾');
                currentChartElement.innerHTML = createPieChart(limitedData, currentChartId);
            } else if (flexElement) {
                // å½“å‰æ˜¯æŸ±çŠ¶å›¾ï¼Œé‡æ–°ç”ŸæˆæŸ±çŠ¶å›¾
                console.log('é‡æ–°ç”ŸæˆæŸ±çŠ¶å›¾');
                currentChartElement.innerHTML = createBarChart(limitedData, currentChartId);
            } else {
                // é»˜è®¤ç”ŸæˆæŸ±çŠ¶å›¾
                console.log('é»˜è®¤ç”ŸæˆæŸ±çŠ¶å›¾');
                currentChartElement.innerHTML = createBarChart(limitedData, currentChartId);
            }

            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindChartClickEvents(currentChartId);
            bindTooltipEvents(currentChartId);

            console.log('å›¾è¡¨åˆ·æ–°å®Œæˆ');
        }

        // è§†å›¾åˆ‡æ¢åŠŸèƒ½
        function switchView(viewType, title, projects, status) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(viewType + 'ViewBtn').classList.add('active');
            
            // æ ¹æ®è§†å›¾ç±»å‹è¿‡æ»¤æ•°æ®
            let filteredProjects = filterProjectsByView(projects, viewType);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„å¯¹æ¯”åˆ†ææŒ‰é’®
            const activeComparisonBtn = document.querySelector('.comparison-btn.active');
            let comparisonType = null;
            if (activeComparisonBtn) {
                comparisonType = activeComparisonBtn.id.replace('ComparisonBtn', '');
            }
            
            // æ›´æ–°æ˜¾ç¤ºå†…å®¹
            showModalCharts(title, filteredProjects, status);
            
            // æ›´æ–°å…¨å±€å˜é‡ï¼Œç¡®ä¿å›¾è¡¨å¯¼èˆªä½¿ç”¨æ­£ç¡®çš„æ•°æ®
            window.currentProjectsForChart = filteredProjects;
            window.currentChartTitle = title;
            window.currentChartStatus = status;
            
            // å¦‚æœä¹‹å‰æœ‰å¯¹æ¯”åˆ†æï¼Œé‡æ–°æ˜¾ç¤ºå¯¹æ¯”åˆ†æ
            if (comparisonType) {
                // é‡æ–°è®¡ç®—å¯¹æ¯”åˆ†ææ•°æ®ï¼ˆä½¿ç”¨è¿‡æ»¤åçš„æ•°æ®ï¼‰
                let comparisonData = {};
                let comparisonTitle = '';
                
                if (comparisonType === 'ring') {
                    comparisonData = calculateRingComparison(filteredProjects);
                    comparisonTitle = 'ç¯æ¯”åˆ†æ';
                } else if (comparisonType === 'year') {
                    comparisonData = calculateYearComparison(filteredProjects);
                    comparisonTitle = 'åŒæ¯”åˆ†æ';
                }
                
                // æ˜¾ç¤ºå¯¹æ¯”åˆ†æç»“æœ
                displayComparisonResults(comparisonTitle, comparisonData, title, filteredProjects, status);
            }
        }

        // æ ¹æ®è§†å›¾ç±»å‹è¿‡æ»¤é¡¹ç›®æ•°æ®
        function filterProjectsByView(projects, viewType) {
            const now = new Date();
            let filteredProjects = [];
            
            switch(viewType) {
                case 'day':
                    // æ—¥è§†å›¾ï¼šæ˜¾ç¤ºä»Šå¤©çš„æ•°æ®
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    
                    filteredProjects = projects.filter(project => {
                        const projectDate = new Date(project.actual_start_time || project.schedule_start_date || project.created_time);
                        return projectDate >= today && projectDate < tomorrow;
                    });
                    break;
                    
                case 'week':
                    // å‘¨è§†å›¾ï¼šæ˜¾ç¤ºæœ¬å‘¨çš„æ•°æ®
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 7);
                    
                    filteredProjects = projects.filter(project => {
                        const projectDate = new Date(project.actual_start_time || project.schedule_start_date || project.created_time);
                        return projectDate >= startOfWeek && projectDate < endOfWeek;
                    });
                    break;
                    
                case 'month':
                    // æœˆè§†å›¾ï¼šæ˜¾ç¤ºæœ¬æœˆçš„æ•°æ®
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    
                    filteredProjects = projects.filter(project => {
                        const projectDate = new Date(project.actual_start_time || project.schedule_start_date || project.created_time);
                        return projectDate >= startOfMonth && projectDate < endOfMonth;
                    });
                    break;
                    
                default:
                    filteredProjects = projects;
            }
            
            return filteredProjects;
        }

        // å¯¹æ¯”åˆ†æåŠŸèƒ½
        function showComparison(comparisonType, title, projects, status) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.comparison-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(comparisonType + 'ComparisonBtn').classList.add('active');
            
            let comparisonData = {};
            let comparisonTitle = '';
            
            if (comparisonType === 'ring') {
                // ç¯æ¯”åˆ†æï¼šä¸ä¸Šä¸€å‘¨æœŸå¯¹æ¯”
                comparisonData = calculateRingComparison(projects);
                comparisonTitle = 'ç¯æ¯”åˆ†æ';
            } else if (comparisonType === 'year') {
                // åŒæ¯”åˆ†æï¼šä¸å»å¹´åŒæœŸå¯¹æ¯”
                comparisonData = calculateYearComparison(projects);
                comparisonTitle = 'åŒæ¯”åˆ†æ';
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡å¯¹æ¯”åˆ†æï¼Œå¦‚æœæ˜¾ç¤ºè¿‡åˆ™å…ˆæ¸…é™¤
            const existingComparison = document.querySelector('.comparison-analysis-section');
            if (existingComparison) {
                existingComparison.remove();
            }
            
            // æ˜¾ç¤ºå¯¹æ¯”åˆ†æç»“æœ
            displayComparisonResults(comparisonTitle, comparisonData, title, projects, status);
        }

        // è®¡ç®—ç¯æ¯”æ•°æ®
        function calculateRingComparison(projects) {
            const now = new Date();
            const currentPeriod = getCurrentPeriod(projects, now);
            const previousPeriod = getPreviousPeriod(projects, now);
            
            return {
                current: currentPeriod,
                previous: previousPeriod,
                growth: calculateGrowthRate(currentPeriod.total, previousPeriod.total),
                trends: calculateTrends(currentPeriod, previousPeriod)
            };
        }

        // è®¡ç®—åŒæ¯”æ•°æ®
        function calculateYearComparison(projects) {
            const now = new Date();
            const currentYear = getCurrentYearData(projects, now);
            const lastYear = getLastYearData(projects, now);
            
            return {
                current: currentYear,
                previous: lastYear,
                growth: calculateGrowthRate(currentYear.total, lastYear.total),
                trends: calculateTrends(currentYear, lastYear)
            };
        }

        // è·å–å½“å‰å‘¨æœŸæ•°æ®
        function getCurrentPeriod(projects, date) {
            const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 1);
            
            const currentProjects = projects.filter(project => {
                const projectDate = new Date(project.actual_start_time || project.schedule_start_date || project.created_time);
                return projectDate >= startOfMonth && projectDate < endOfMonth;
            });
            
            return {
                total: currentProjects.length,
                byStatus: groupByStatus(currentProjects),
                byCategory: groupByCategory(currentProjects)
            };
        }

        // è·å–ä¸Šä¸€å‘¨æœŸæ•°æ®
        function getPreviousPeriod(projects, date) {
            const startOfLastMonth = new Date(date.getFullYear(), date.getMonth() - 1, 1);
            const endOfLastMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            
            const previousProjects = projects.filter(project => {
                const projectDate = new Date(project.actual_start_time || project.schedule_start_date || project.created_time);
                return projectDate >= startOfLastMonth && projectDate < endOfLastMonth;
            });
            
            return {
                total: previousProjects.length,
                byStatus: groupByStatus(previousProjects),
                byCategory: groupByCategory(previousProjects)
            };
        }

        // è·å–å½“å‰å¹´æ•°æ®
        function getCurrentYearData(projects, date) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const endOfYear = new Date(date.getFullYear() + 1, 0, 1);
            
            const currentYearProjects = projects.filter(project => {
                const projectDate = new Date(project.actual_start_time || project.schedule_start_date || project.created_time);
                return projectDate >= startOfYear && projectDate < endOfYear;
            });
            
            return {
                total: currentYearProjects.length,
                byStatus: groupByStatus(currentYearProjects),
                byCategory: groupByCategory(currentYearProjects)
            };
        }

        // è·å–å»å¹´æ•°æ®
        function getLastYearData(projects, date) {
            const startOfLastYear = new Date(date.getFullYear() - 1, 0, 1);
            const endOfLastYear = new Date(date.getFullYear(), 0, 1);
            
            const lastYearProjects = projects.filter(project => {
                const projectDate = new Date(project.actual_start_time || project.schedule_start_date || project.created_time);
                return projectDate >= startOfLastYear && projectDate < endOfLastYear;
            });
            
            return {
                total: lastYearProjects.length,
                byStatus: groupByStatus(lastYearProjects),
                byCategory: groupByCategory(lastYearProjects)
            };
        }

        // æŒ‰çŠ¶æ€åˆ†ç»„
        function groupByStatus(projects) {
            const groups = {};
            projects.forEach(project => {
                const status = project.schedule || 'æœªå¼€å§‹';
                groups[status] = (groups[status] || 0) + 1;
            });
            return groups;
        }

        // æŒ‰ç±»åˆ«åˆ†ç»„
        function groupByCategory(projects) {
            const groups = {};
            projects.forEach(project => {
                const category = project.product_category || 'æœªåˆ†ç±»';
                groups[category] = (groups[category] || 0) + 1;
            });
            return groups;
        }

        // è®¡ç®—å¢é•¿ç‡
        function calculateGrowthRate(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous * 100).toFixed(2);
        }

        // è®¡ç®—è¶‹åŠ¿
        function calculateTrends(current, previous) {
            const trends = {};
            
            // çŠ¶æ€è¶‹åŠ¿
            Object.keys(current.byStatus).forEach(status => {
                const currentCount = current.byStatus[status] || 0;
                const previousCount = previous.byStatus[status] || 0;
                trends[status] = calculateGrowthRate(currentCount, previousCount);
            });
            
            return trends;
        }

        // æ˜¾ç¤ºå¯¹æ¯”åˆ†æç»“æœ
        function displayComparisonResults(title, comparisonData, originalTitle, projects, status) {
            const contentHTML = `
                <div class="comparison-analysis-section" style="margin-bottom: 20px; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <h3 style="color: #333; margin-bottom: 15px;">${title}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <!-- æ€»ä½“å¯¹æ¯” -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">æ€»ä½“å¯¹æ¯”</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: #007bff;">${comparisonData.current.total}</div>
                                    <div style="color: #666; font-size: 14px;">å½“å‰å‘¨æœŸ</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; color: #666;">${comparisonData.previous.total}</div>
                                    <div style="color: #666; font-size: 14px;">ä¸ŠæœŸ</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: bold; color: ${comparisonData.growth >= 0 ? '#28a745' : '#dc3545'};">
                                        ${comparisonData.growth >= 0 ? '+' : ''}${comparisonData.growth}%
                                    </div>
                                    <div style="color: #666; font-size: 12px;">å¢é•¿ç‡</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- çŠ¶æ€å¯¹æ¯” -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h4 style="margin: 0 0 15px 0; color: #333;">çŠ¶æ€åˆ†å¸ƒå¯¹æ¯”</h4>
                            ${Object.keys(comparisonData.current.byStatus).map(status => {
                                const currentCount = comparisonData.current.byStatus[status] || 0;
                                const previousCount = comparisonData.previous.byStatus[status] || 0;
                                const growth = calculateGrowthRate(currentCount, previousCount);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                        <span style="font-weight: 500;">${status}</span>
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <span>${currentCount}</span>
                                            <span style="color: #666;">${previousCount}</span>
                                            <span style="color: ${growth >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                                ${growth >= 0 ? '+' : ''}${growth}%
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- ç±»åˆ«å¯¹æ¯” -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <h4 style="margin: 0 0 15px 0; color: #333;">ç±»åˆ«åˆ†å¸ƒå¯¹æ¯”</h4>
                            ${Object.keys(comparisonData.current.byCategory).map(category => {
                                const currentCount = comparisonData.current.byCategory[category] || 0;
                                const previousCount = comparisonData.previous.byCategory[category] || 0;
                                const growth = calculateGrowthRate(currentCount, previousCount);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                        <span style="font-weight: 500;">${category}</span>
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <span>${currentCount}</span>
                                            <span style="color: #666;">${previousCount}</span>
                                            <span style="color: ${growth >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                                ${growth >= 0 ? '+' : ''}${growth}%
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // å°†å¯¹æ¯”åˆ†æç»“æœæ·»åŠ åˆ°ç°æœ‰å†…å®¹çš„ä¸‹æ–¹ï¼Œè€Œä¸æ˜¯æ›¿æ¢
            const modalContent = document.getElementById('modalContent');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentHTML;
            
            // å°†æ–°å†…å®¹è¿½åŠ åˆ°ç°æœ‰å†…å®¹åé¢
            while (tempDiv.firstChild) {
                modalContent.appendChild(tempDiv.firstChild);
            }
        }
</script>

<!-- è‡ªå®šä¹‰å›¾è¡¨æ¨¡æ€æ¡† -->
<div id="dynamicChartModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90%; max-height: 800px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none;">
            <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 28px;">ğŸ“Š</span>
                è‡ªå®šä¹‰å›¾è¡¨ç”Ÿæˆå™¨
            </h3>
            <span class="close" onclick="closeDynamicChartModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
        </div>
        <div class="modal-body" style="padding: 30px; height: calc(100% - 80px); overflow-y: auto;">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block; font-size: 14px;">ğŸ“‹ é€‰æ‹©åˆ†æå­—æ®µ</label>
                        <select id="fieldSelector" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                            <option value="">è¯·é€‰æ‹©è¦åˆ†æçš„å­—æ®µ</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block; font-size: 14px;">ğŸ“ˆ å›¾è¡¨ç±»å‹</label>
                        <select id="chartTypeSelector" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                            <option value="bar">ğŸ“Š æŸ±çŠ¶å›¾</option>
                            <option value="pie">ğŸ¥§ é¥¼å›¾</option>
                            <option value="line">ğŸ“ˆ æŠ˜çº¿å›¾</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block; font-size: 14px;">ğŸ”¢ æ˜¾ç¤ºæ•°é‡</label>
                        <input type="number" id="topNSelector" value="10" min="1" max="50" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                        <span style="color: #6c757d; font-size: 12px; margin-top: 4px; display: block;">æ˜¾ç¤ºå‰Nä¸ªæœ€å¤šçš„å€¼</span>
                    </div>
                    <div style="display: flex; align-items: end; gap: 12px;">
                        <button onclick="generateDynamicChart()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                            ğŸš€ ç”Ÿæˆå›¾è¡¨
                        </button>
                    </div>
                    <div style="display: flex; align-items: end; gap: 12px;">
                        <button onclick="saveChartToProjectDetails()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                            ğŸ’¾ ä¿å­˜å›¾è¡¨
                        </button>
                        <button onclick="clearDynamicChart()" style="background: #6c757d; border: none; color: white; padding: 12px 16px; border-radius: 10px; font-size: 14px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0)'">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="dynamicChartContainer" style="height: 500px; border: 2px dashed #e9ecef; border-radius: 16px; padding: 30px; background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); display: flex; align-items: center; justify-content: center; margin-bottom: 25px; transition: all 0.3s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e9ecef'">
                <div style="text-align: center; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.6;">ğŸ“Š</div>
                    <p style="font-size: 16px; margin: 0; font-weight: 500;">è¯·é€‰æ‹©å­—æ®µå¹¶ç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®</p>
                    <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.7;">æ”¯æŒæŸ±çŠ¶å›¾ã€é¥¼å›¾å’ŒæŠ˜çº¿å›¾ä¸‰ç§ç±»å‹</p>
                </div>
            </div>

            <!-- å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨ -->
            <div style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #2c3e50; margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ“š</span>
                        å·²ä¿å­˜çš„å›¾è¡¨
                    </h4>
                </div>
                <div id="savedChartsList" style="max-height: 300px; overflow-y: auto; padding-right: 8px;">
                    <!-- åŠ¨æ€å¡«å……å·²ä¿å­˜çš„å›¾è¡¨ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å°è´¦å±•ç¤ºæ¨¡æ€æ¡† -->
<div id="ledgerModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; background: white; border-radius: 8px; padding: 0; max-width: 800px; width: 90%; max-height: 90vh; box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 400px; min-height: 300px; flex-direction: column; box-sizing: border-box;">
    <!-- æ‹–åŠ¨æ¡å’Œå…³é—­æŒ‰é’® -->
    <div id="ledgerModalHeader" style="position: relative; padding: 15px 30px; border-bottom: 2px solid #007bff; cursor: move; user-select: none; flex-shrink: 0;">
        <h2 style="margin: 0; color: #333; display: inline-block;">å°è´¦å±•ç¤º</h2>
        <!-- æ—¶é—´æ®µå°è´¦æŸ¥è¯¢æŒ‰é’® -->
        <button onclick="showLedgerDateRangeModal()" style="position: absolute; top: 50%; right: 50px; transform: translateY(-50%); padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;" onmouseover="this.style.backgroundColor='#218838'; this.style.transform='translateY(-50%) scale(1.05)';" onmouseout="this.style.backgroundColor='#28a745'; this.style.transform='translateY(-50%) scale(1)';">
            ğŸ“… æ—¶é—´æ®µæŸ¥è¯¢
        </button>
        <button onclick="closeLedgerModal()" style="position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #999; line-height: 1; padding: 0; width: 30px; height: 30px;">&times;</button>
    </div>
    <div id="ledgerModalContent" style="padding: 30px; flex: 1; overflow-y: auto; box-sizing: border-box; min-height: 0;">
        
        <div class="ledger-stats" style="display: flex; gap: 30px; flex-wrap: wrap; margin-bottom: 20px;">
            <div class="ledger-stat-item" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 16px; color: #666; margin-bottom: 15px; font-weight: 500;">è¿›è´¦</div>
                <div id="ledgerInCount" onclick="showLedgerDetail('in')" style="font-size: 48px; font-weight: bold; color: #28a745; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'; this.style.opacity='0.8';" onmouseout="this.style.transform='scale(1)'; this.style.opacity='1';">-</div>
                <div style="font-size: 13px; color: #999;">ä»Šæ—¥æ–°å¢ï¼ˆä¸å«CDï¼‰</div>
            </div>
            <div class="ledger-stat-item" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 16px; color: #666; margin-bottom: 15px; font-weight: 500;">å‡ºè´¦</div>
                <div id="ledgerOutCount" onclick="showLedgerDetail('out')" style="font-size: 48px; font-weight: bold; color: #dc3545; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'; this.style.opacity='0.8';" onmouseout="this.style.transform='scale(1)'; this.style.opacity='1';">-</div>
                <div style="font-size: 13px; color: #999;">ä»Šæ—¥ç»“æŸï¼ˆä¸å«CDï¼‰</div>
            </div>
            <div class="ledger-stat-item" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 16px; color: #666; margin-bottom: 15px; font-weight: 500;">å­˜è´¦</div>
                <div id="ledgerStockCount" onclick="showLedgerDetail('stock')" style="font-size: 48px; font-weight: bold; color: #007bff; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'; this.style.opacity='0.8';" onmouseout="this.style.transform='scale(1)'; this.style.opacity='1';">-</div>
                <div style="font-size: 13px; color: #999;">æ˜¨å¤©å­˜æ•°+ï¼ˆè¿›-å‡ºï¼‰</div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid #eee;">
            <div id="setInitialStockBtnContainer" style="display: none;">
                <button onclick="showSetInitialStockModal()" style="padding: 8px 16px; background-color: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">âš ï¸ è®¾ç½®åˆå§‹å­˜è´¦</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="refreshLedgerData()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button onclick="closeLedgerModal()" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- è®¾ç½®åˆå§‹å­˜è´¦æ¨¡æ€æ¡† -->
<div id="setInitialStockModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10001; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">è®¾ç½®åˆå§‹å­˜è´¦å€¼</h3>
        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">è¯·è¾“å…¥ä¹‹å‰çš„å­˜è´¦æ€»æ•°ï¼ˆæ­¤æ“ä½œåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œè¯·è°¨æ…å¡«å†™ï¼‰</p>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; color: #333; font-weight: bold;">åˆå§‹å­˜è´¦æ•°é‡ï¼š</label>
            <input type="number" id="initialStockCountInput" min="0" step="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" placeholder="è¯·è¾“å…¥æ•°å­—">
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeSetInitialStockModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
            <button onclick="confirmSetInitialStock()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">ç¡®è®¤è®¾ç½®</button>
        </div>
    </div>
</div>

<!-- æ—¶é—´æ®µå°è´¦æŸ¥è¯¢æ¨¡æ€æ¡† -->
<div id="ledgerDateRangeModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10003; background: white; border-radius: 8px; padding: 0; max-width: 900px; width: 90%; max-height: 90vh; box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 500px; min-height: 400px; flex-direction: column; box-sizing: border-box;">
    <!-- æ‹–åŠ¨æ¡å’Œå…³é—­æŒ‰é’® -->
    <div id="ledgerDateRangeModalHeader" style="position: relative; padding: 15px 30px; border-bottom: 2px solid #28a745; cursor: move; user-select: none; flex-shrink: 0;">
        <h2 style="margin: 0; color: #333; display: inline-block;">æ—¶é—´æ®µå°è´¦æŸ¥è¯¢</h2>
        <button onclick="closeLedgerDateRangeModal()" style="position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #999; line-height: 1; padding: 0; width: 30px; height: 30px;">&times;</button>
    </div>
    <div id="ledgerDateRangeModalContent" style="padding: 30px; flex: 1; overflow-y: auto; box-sizing: border-box; min-height: 0;">
        <!-- æ—¶é—´é€‰æ‹©åŒºåŸŸ -->
        <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: bold; font-size: 14px;">å¼€å§‹æ—¶é—´ï¼š</label>
                    <input type="date" id="ledgerDateRangeStart" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: bold; font-size: 14px;">ç»“æŸæ—¶é—´ï¼š</label>
                    <input type="date" id="ledgerDateRangeEnd" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px;">
                <div style="font-size: 13px; color: #0066cc;">
                    <strong>æç¤ºï¼š</strong>å¦‚æœå·²åœ¨æœç´¢æŸ¥è¯¢ä¸­ç­›é€‰äº†æ—¶é—´æ®µï¼Œå°†è‡ªåŠ¨ä½¿ç”¨è¯¥æ—¶é—´æ®µã€‚æ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨é€‰æ‹©å…¶ä»–æ—¶é—´æ®µè¿›è¡ŒæŸ¥è¯¢ã€‚
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="ledger-stats" style="display: flex; gap: 30px; flex-wrap: wrap; margin-bottom: 20px;">
            <div class="ledger-stat-item" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 16px; color: #666; margin-bottom: 15px; font-weight: 500;">è¿›è´¦</div>
                <div id="ledgerDateRangeInCount" style="font-size: 48px; font-weight: bold; color: #28a745; margin-bottom: 10px;">-</div>
                <div style="font-size: 13px; color: #999;">æ—¶é—´æ®µå†…æ–°å¢ï¼ˆä¸å«CDï¼‰</div>
            </div>
            <div class="ledger-stat-item" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 16px; color: #666; margin-bottom: 15px; font-weight: 500;">å‡ºè´¦</div>
                <div id="ledgerDateRangeOutCount" style="font-size: 48px; font-weight: bold; color: #dc3545; margin-bottom: 10px;">-</div>
                <div style="font-size: 13px; color: #999;">æ—¶é—´æ®µå†…ç»“æŸï¼ˆä¸å«CDï¼‰</div>
            </div>
            <div class="ledger-stat-item" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                <div style="font-size: 16px; color: #666; margin-bottom: 15px; font-weight: 500;">å­˜è´¦</div>
                <div id="ledgerDateRangeStockCount" style="font-size: 48px; font-weight: bold; color: #007bff; margin-bottom: 10px;">-</div>
                <div style="font-size: 13px; color: #999;">æ—¶é—´æ®µç»“æŸæ—¶çš„å­˜æ•°</div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid #eee;">
            <div style="font-size: 13px; color: #666;">
                <span id="ledgerDateRangeInfo">è¯·é€‰æ‹©æ—¶é—´æ®µåç‚¹å‡»æŸ¥è¯¢</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="queryLedgerDateRange()" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ” æŸ¥è¯¢</button>
                <button onclick="closeLedgerDateRangeModal()" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- å°è´¦è¯¦ç»†æ•°æ®å±•ç¤ºæ¨¡æ€æ¡† -->
<div id="ledgerDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 10002; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 12px; padding: 0; max-width: 1100px; width: 95%; max-height: 90vh; box-shadow: 0 10px 40px rgba(0,0,0,0.3); min-width: 700px; flex-direction: column; box-sizing: border-box; display: flex; overflow: hidden;">
        <!-- å¤´éƒ¨ -->
        <div style="position: relative; padding: 20px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); flex-shrink: 0; border-radius: 12px 12px 0 0;">
            <h2 id="ledgerDetailTitle" style="margin: 0; color: white; display: inline-block; font-size: 20px; font-weight: 600; letter-spacing: 0.5px;">å°è´¦è¯¦ç»†æ•°æ®</h2>
            <button onclick="closeLedgerDetailModal()" style="position: absolute; top: 50%; right: 20px; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; font-size: 24px; cursor: pointer; color: white; line-height: 1; padding: 0; width: 32px; height: 32px; border-radius: 50%; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-50%) scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-50%) scale(1)';">&times;</button>
        </div>
        <!-- ç»´åº¦åˆ‡æ¢å’Œå†…å®¹ -->
        <div style="padding: 25px 30px; flex: 1; overflow-y: auto; box-sizing: border-box; min-height: 0; background-color: #f8f9fa;">
            <!-- ç»´åº¦åˆ‡æ¢æŒ‰é’® -->
            <div style="display: flex; gap: 12px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef;">
                <button id="dimensionCategoryBtn" onclick="switchLedgerDimension('category')" style="padding: 10px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">ğŸ“Š æŒ‰å°ç±»</button>
                <button id="dimensionTesterBtn" onclick="switchLedgerDimension('tester')" style="padding: 10px 24px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; letter-spacing: 0.5px;" onmouseover="if(this.style.background === '' || this.style.background === 'none') { this.style.backgroundColor='#5a6268'; } this.style.transform='translateY(-2px)';" onmouseout="if(this.style.background === '' || this.style.background === 'none') { this.style.backgroundColor='#6c757d'; } this.style.transform='translateY(0)';">ğŸ‘¤ æŒ‰æµ‹è¯•äººå‘˜</button>
            </div>
            <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
            <div id="ledgerDetailContent" style="min-height: 200px; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="text-align: center; padding: 60px 40px; color: #999; font-size: 16px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // å°è´¦å±•ç¤ºç›¸å…³å‡½æ•°
    function showLedgerModal() {
        const modal = document.getElementById('ledgerModal');
        if (modal) {
            modal.style.display = 'flex';
            // æ‰“å¼€æ¨¡æ€æ¡†æ—¶åŠ è½½æ•°æ®
            loadLedgerData();
            // åˆå§‹åŒ–æ‹–åŠ¨åŠŸèƒ½
            initLedgerModalDrag();
        }
    }
    
    // åˆå§‹åŒ–å°è´¦æ¨¡æ€æ¡†æ‹–åŠ¨å’Œè°ƒæ•´å¤§å°åŠŸèƒ½
    let ledgerModalDragHandler = null;
    let ledgerModalResizeHandler = null;
    const RESIZE_THRESHOLD = 10; // è¾¹ç¼˜æ£€æµ‹é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
    
    function initLedgerModalDrag() {
        const modal = document.getElementById('ledgerModal');
        const header = document.getElementById('ledgerModalHeader');
        if (!modal || !header) return;
        
        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œå…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        if (ledgerModalDragHandler) {
            header.removeEventListener('mousedown', ledgerModalDragHandler.dragStart);
            document.removeEventListener('mousemove', ledgerModalDragHandler.drag);
            document.removeEventListener('mouseup', ledgerModalDragHandler.dragEnd);
        }
        
        if (ledgerModalResizeHandler) {
            modal.removeEventListener('mousemove', ledgerModalResizeHandler.handleMouseMove);
            modal.removeEventListener('mousedown', ledgerModalResizeHandler.handleMouseDown);
            document.removeEventListener('mousemove', ledgerModalResizeHandler.handleResize);
            document.removeEventListener('mouseup', ledgerModalResizeHandler.handleResizeEnd);
        }
        
        let isDragging = false;
        let isResizing = false;
        let resizeDirection = '';
        let currentX = 0;
        let currentY = 0;
        let initialX;
        let initialY;
        let startWidth = 0;
        let startHeight = 0;
        let startX = 0;
        let startY = 0;
        
        // è·å–æ¨¡æ€æ¡†çš„åˆå§‹ä½ç½®ï¼ˆå±…ä¸­ä½ç½®ï¼‰
        const rect = modal.getBoundingClientRect();
        currentX = rect.left;
        currentY = rect.top;
        
        // æ£€æµ‹é¼ æ ‡æ˜¯å¦åœ¨è¾¹ç¼˜
        const getResizeDirection = function(e, element) {
            const rect = element.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const width = rect.width;
            const height = rect.height;
            
            let direction = '';
            
            // æ£€æµ‹æ˜¯å¦åœ¨è¾¹ç¼˜åŒºåŸŸ
            if (x <= RESIZE_THRESHOLD) {
                direction += 'w'; // å·¦è¾¹ç¼˜
            } else if (x >= width - RESIZE_THRESHOLD) {
                direction += 'e'; // å³è¾¹ç¼˜
            }
            
            if (y <= RESIZE_THRESHOLD) {
                direction += 'n'; // ä¸Šè¾¹ç¼˜
            } else if (y >= height - RESIZE_THRESHOLD) {
                direction += 's'; // ä¸‹è¾¹ç¼˜
            }
            
            return direction;
        };
        
        // æ ¹æ®æ–¹å‘è®¾ç½®å…‰æ ‡
        const setCursor = function(direction) {
            const cursors = {
                '': 'default',
                'n': 'n-resize',
                's': 's-resize',
                'e': 'e-resize',
                'w': 'w-resize',
                'ne': 'ne-resize',
                'nw': 'nw-resize',
                'se': 'se-resize',
                'sw': 'sw-resize'
            };
            modal.style.cursor = cursors[direction] || 'default';
        };
        
        // é¼ æ ‡ç§»åŠ¨æ—¶æ£€æµ‹è¾¹ç¼˜
        const handleMouseMove = function(e) {
            if (isDragging || isResizing) return;
            
            // å¦‚æœé¼ æ ‡åœ¨æ ‡é¢˜æ ä¸Šï¼Œä¸æ£€æµ‹è¾¹ç¼˜
            if (header.contains(e.target)) {
                modal.style.cursor = 'move';
                return;
            }
            
            const direction = getResizeDirection(e, modal);
            setCursor(direction);
        };
        
        // å¼€å§‹è°ƒæ•´å¤§å°
        const handleMouseDown = function(e) {
            if (e.target.tagName === 'BUTTON') return; // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸å¤„ç†
            if (header.contains(e.target)) return; // å¦‚æœç‚¹å‡»çš„æ˜¯æ ‡é¢˜æ ï¼Œç”±æ‹–åŠ¨å¤„ç†
            
            const direction = getResizeDirection(e, modal);
            if (direction) {
                isResizing = true;
                resizeDirection = direction;
                
                // åœ¨å¼€å§‹è°ƒæ•´å¤§å°å‰ï¼Œç¡®ä¿ç§»é™¤transformå¹¶è®¾ç½®æ­£ç¡®çš„ä½ç½®
                const rect = modal.getBoundingClientRect();
                currentX = rect.left;
                currentY = rect.top;
                
                // å¦‚æœè¿˜åœ¨ä½¿ç”¨transformå±…ä¸­ï¼Œå…ˆç§»é™¤å¹¶è®¾ç½®å®é™…ä½ç½®
                if (modal.style.transform && modal.style.transform.includes('translate')) {
                    modal.style.left = currentX + 'px';
                    modal.style.top = currentY + 'px';
                    modal.style.transform = 'none';
                }
                
                // é‡æ–°è·å–ä½ç½®ï¼ˆç¡®ä¿å‡†ç¡®ï¼‰
                const newRect = modal.getBoundingClientRect();
                startWidth = newRect.width;
                startHeight = newRect.height;
                currentX = newRect.left;
                currentY = newRect.top;
                startX = e.clientX;
                startY = e.clientY;
                
                e.preventDefault();
                e.stopPropagation();
            }
        };
        
        // è°ƒæ•´å¤§å°
        const handleResize = function(e) {
            if (!isResizing) return;
            
            e.preventDefault();
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = currentX;
            let newTop = currentY;
            
            // æ ¹æ®æ–¹å‘è°ƒæ•´å¤§å°å’Œä½ç½®
            if (resizeDirection.includes('e')) {
                // ä»å³ä¾§è°ƒæ•´ï¼Œåªæ”¹å˜å®½åº¦
                newWidth = Math.max(parseInt(modal.style.minWidth) || 400, startWidth + deltaX);
            }
            if (resizeDirection.includes('w')) {
                // ä»å·¦ä¾§è°ƒæ•´ï¼Œæ”¹å˜å®½åº¦å’Œä½ç½®
                const minWidth = parseInt(modal.style.minWidth) || 400;
                const widthChange = startWidth - deltaX;
                if (widthChange >= minWidth) {
                    newWidth = widthChange;
                    newLeft = currentX + deltaX;
                } else {
                    // å¦‚æœè¾¾åˆ°æœ€å°å®½åº¦ï¼Œä¿æŒæœ€å°å®½åº¦ï¼Œè°ƒæ•´ä½ç½®
                    newWidth = minWidth;
                    newLeft = currentX + (startWidth - minWidth);
                }
            }
            if (resizeDirection.includes('s')) {
                // ä»ä¸‹ä¾§è°ƒæ•´ï¼Œåªæ”¹å˜é«˜åº¦
                newHeight = Math.max(parseInt(modal.style.minHeight) || 300, startHeight + deltaY);
            }
            if (resizeDirection.includes('n')) {
                // ä»ä¸Šä¾§è°ƒæ•´ï¼Œæ”¹å˜é«˜åº¦å’Œä½ç½®
                const minHeight = parseInt(modal.style.minHeight) || 300;
                const heightChange = startHeight - deltaY;
                if (heightChange >= minHeight) {
                    newHeight = heightChange;
                    newTop = currentY + deltaY;
                } else {
                    // å¦‚æœè¾¾åˆ°æœ€å°é«˜åº¦ï¼Œä¿æŒæœ€å°é«˜åº¦ï¼Œè°ƒæ•´ä½ç½®
                    newHeight = minHeight;
                    newTop = currentY + (startHeight - minHeight);
                }
            }
            
            // ç¡®ä¿transformå·²ç»è¢«ç§»é™¤
            modal.style.transform = 'none';
            
            // åº”ç”¨æ–°çš„å¤§å°
            modal.style.width = newWidth + 'px';
            modal.style.height = newHeight + 'px';
            modal.style.maxWidth = 'none';
            modal.style.maxHeight = 'none';
            
            // åº”ç”¨æ–°çš„ä½ç½®ï¼ˆåªåœ¨éœ€è¦æ—¶æ›´æ–°ï¼‰
            if (resizeDirection.includes('w')) {
                modal.style.left = newLeft + 'px';
            }
            if (resizeDirection.includes('n')) {
                modal.style.top = newTop + 'px';
            }
            
            modal.style.display = 'flex'; // ä½¿ç”¨flexå¸ƒå±€ä»¥ä¾¿å†…å®¹åŒºåŸŸè‡ªé€‚åº”
        };
        
        // ç»“æŸè°ƒæ•´å¤§å°
        const handleResizeEnd = function(e) {
            if (isResizing) {
                isResizing = false;
                resizeDirection = '';
                modal.style.cursor = 'default';
            }
        };
        
        // æ‹–åŠ¨åŠŸèƒ½
        const dragStart = function(e) {
            if (e.target.tagName === 'BUTTON') return; // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸æ‹–åŠ¨
            if (isResizing) return; // å¦‚æœæ­£åœ¨è°ƒæ•´å¤§å°ï¼Œä¸æ‹–åŠ¨
            
            if (e.target === header || header.contains(e.target)) {
                isDragging = true;
                header.style.cursor = 'grabbing';
                
                // è·å–å½“å‰æ¨¡æ€æ¡†ä½ç½®
                const rect = modal.getBoundingClientRect();
                currentX = rect.left;
                currentY = rect.top;
                
                // å¦‚æœè¿˜åœ¨ä½¿ç”¨transformå±…ä¸­ï¼Œå…ˆç§»é™¤å¹¶è®¾ç½®å®é™…ä½ç½®
                if (modal.style.transform && modal.style.transform.includes('translate')) {
                    modal.style.left = currentX + 'px';
                    modal.style.top = currentY + 'px';
                    modal.style.transform = 'none';
                    // é‡æ–°è·å–ä½ç½®
                    const newRect = modal.getBoundingClientRect();
                    currentX = newRect.left;
                    currentY = newRect.top;
                }
                
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
            }
        };
        
        const drag = function(e) {
            if (isDragging && !isResizing) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                // ç¡®ä¿transformå·²ç»è¢«ç§»é™¤
                modal.style.transform = 'none';
                
                // æ›´æ–°æ¨¡æ€æ¡†ä½ç½®
                modal.style.left = currentX + 'px';
                modal.style.top = currentY + 'px';
            }
        };
        
        const dragEnd = function(e) {
            if (isDragging) {
                isDragging = false;
                header.style.cursor = 'move';
            }
        };
        
        // ä¿å­˜äº‹ä»¶å¤„ç†å‡½æ•°å¼•ç”¨ï¼Œä»¥ä¾¿åç»­ç§»é™¤
        ledgerModalDragHandler = { dragStart, drag, dragEnd };
        ledgerModalResizeHandler = { handleMouseMove, handleMouseDown, handleResize, handleResizeEnd };
        
        // ç»‘å®šæ‹–åŠ¨äº‹ä»¶
        header.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        // ç»‘å®šè°ƒæ•´å¤§å°äº‹ä»¶
        modal.addEventListener('mousemove', handleMouseMove);
        modal.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', handleResizeEnd);
    }

    // å…³é—­å°è´¦æ¨¡æ€æ¡†
    function closeLedgerModal() {
        const modal = document.getElementById('ledgerModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // åŠ è½½å°è´¦æ•°æ®
    function loadLedgerData() {
        fetch('/scheduleBoardController/getLedgerStats')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const stats = data.data;
                    // æ›´æ–°è¿›è´¦æ•°é‡
                    const inCount = stats.in_count || 0;
                    const inCountEl = document.getElementById('ledgerInCount');
                    if (inCountEl) inCountEl.textContent = inCount;
                    
                    // æ›´æ–°å‡ºè´¦æ•°é‡
                    const outCount = stats.out_count || 0;
                    const outCountEl = document.getElementById('ledgerOutCount');
                    if (outCountEl) outCountEl.textContent = outCount;
                    
                    // æ›´æ–°å­˜è´¦æ•°é‡
                    const stockCount = stats.stock_count || 0;
                    const stockCountEl = document.getElementById('ledgerStockCount');
                    if (stockCountEl) stockCountEl.textContent = stockCount;
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºè®¾ç½®åˆå§‹å€¼æŒ‰é’®
                    checkAndShowSetInitialStockButton(stats.has_initial_stock);
                } else {
                    console.error('è·å–å°è´¦æ•°æ®å¤±è´¥:', data.message || 'æœªçŸ¥é”™è¯¯');
                    const inCountEl = document.getElementById('ledgerInCount');
                    const outCountEl = document.getElementById('ledgerOutCount');
                    const stockCountEl = document.getElementById('ledgerStockCount');
                    if (inCountEl) inCountEl.textContent = '-';
                    if (outCountEl) outCountEl.textContent = '-';
                    if (stockCountEl) stockCountEl.textContent = '-';
                }
            })
            .catch(error => {
                console.error('åŠ è½½å°è´¦æ•°æ®å‡ºé”™:', error);
                const inCountEl = document.getElementById('ledgerInCount');
                const outCountEl = document.getElementById('ledgerOutCount');
                const stockCountEl = document.getElementById('ledgerStockCount');
                if (inCountEl) inCountEl.textContent = '-';
                if (outCountEl) outCountEl.textContent = '-';
                if (stockCountEl) stockCountEl.textContent = '-';
            });
    }

    // æ£€æŸ¥å¹¶æ˜¾ç¤ºè®¾ç½®åˆå§‹å­˜è´¦æŒ‰é’®
    function checkAndShowSetInitialStockButton(hasInitialStock) {
        const username = localStorage.getItem('username') || '';
        const allowedUsers = ['è®¸æ¢¦ç‘¶', 'å¢å¥'];
        
        // åªæœ‰æˆæƒç”¨æˆ·ä¸”æœªè®¾ç½®åˆå§‹å€¼æ—¶æ‰æ˜¾ç¤ºæŒ‰é’®
        if (allowedUsers.includes(username) && !hasInitialStock) {
            document.getElementById('setInitialStockBtnContainer').style.display = 'block';
        } else {
            document.getElementById('setInitialStockBtnContainer').style.display = 'none';
        }
    }

    // æ˜¾ç¤ºè®¾ç½®åˆå§‹å­˜è´¦æ¨¡æ€æ¡†
    function showSetInitialStockModal() {
        document.getElementById('setInitialStockModal').style.display = 'flex';
        document.getElementById('initialStockCountInput').value = '';
        document.getElementById('initialStockCountInput').focus();
    }

    // å…³é—­è®¾ç½®åˆå§‹å­˜è´¦æ¨¡æ€æ¡†
    function closeSetInitialStockModal() {
        document.getElementById('setInitialStockModal').style.display = 'none';
    }

    // ç¡®è®¤è®¾ç½®åˆå§‹å­˜è´¦
    function confirmSetInitialStock() {
        const input = document.getElementById('initialStockCountInput');
        const initialStockCount = parseInt(input.value);
        const username = localStorage.getItem('username') || '';
        
        if (isNaN(initialStockCount) || initialStockCount < 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼ˆå¤§äºç­‰äº0ï¼‰');
            return;
        }
        
        if (!username) {
            alert('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }
        
        // å‘é€è¯·æ±‚è®¾ç½®åˆå§‹å­˜è´¦
        fetch('/scheduleBoardController/setInitialStockCount', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                initialStockCount: initialStockCount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('åˆå§‹å­˜è´¦å€¼è®¾ç½®æˆåŠŸï¼');
                closeSetInitialStockModal();
                // å¦‚æœå°è´¦æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œé‡æ–°åŠ è½½å°è´¦æ•°æ®
                const ledgerModal = document.getElementById('ledgerModal');
                if (ledgerModal && ledgerModal.style.display === 'flex') {
                    loadLedgerData();
                }
            } else {
                alert('è®¾ç½®å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('è®¾ç½®åˆå§‹å­˜è´¦å€¼å‡ºé”™:', error);
            alert('è®¾ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    // åˆ·æ–°å°è´¦æ•°æ®
    function refreshLedgerData() {
        loadLedgerData();
    }

    // æ˜¾ç¤ºæ—¶é—´æ®µå°è´¦æŸ¥è¯¢æ¨¡æ€æ¡†
    function showLedgerDateRangeModal() {
        const modal = document.getElementById('ledgerDateRangeModal');
        if (modal) {
            modal.style.display = 'flex';
            
            // å°è¯•ä»æœç´¢æŸ¥è¯¢ä¸­è·å–å·²ç­›é€‰çš„æ—¶é—´æ®µ
            const searchCreateTimeStart = document.getElementById('searchCreateTimeStart');
            const searchCreateTimeEnd = document.getElementById('searchCreateTimeEnd');
            
            const startInput = document.getElementById('ledgerDateRangeStart');
            const endInput = document.getElementById('ledgerDateRangeEnd');
            
            // å¦‚æœæœç´¢æŸ¥è¯¢ä¸­æœ‰æ—¶é—´æ®µï¼Œè‡ªåŠ¨å¡«å……
            if (searchCreateTimeStart && searchCreateTimeStart.value) {
                startInput.value = searchCreateTimeStart.value;
            }
            if (searchCreateTimeEnd && searchCreateTimeEnd.value) {
                endInput.value = searchCreateTimeEnd.value;
            }
            
            // å¦‚æœæ²¡æœ‰è®¾ç½®æ—¶é—´ï¼Œé»˜è®¤ä½¿ç”¨ä»Šå¤©
            if (!startInput.value) {
                const today = new Date().toISOString().split('T')[0];
                startInput.value = today;
                endInput.value = today;
            }
            
            // åˆå§‹åŒ–æ¨¡æ€æ¡†æ‹–åŠ¨åŠŸèƒ½
            initLedgerDateRangeModalDrag();
        }
    }

    // å…³é—­æ—¶é—´æ®µå°è´¦æŸ¥è¯¢æ¨¡æ€æ¡†
    function closeLedgerDateRangeModal() {
        const modal = document.getElementById('ledgerDateRangeModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // åˆå§‹åŒ–æ—¶é—´æ®µå°è´¦æŸ¥è¯¢æ¨¡æ€æ¡†æ‹–åŠ¨åŠŸèƒ½
    let ledgerDateRangeModalDragHandler = null;
    function initLedgerDateRangeModalDrag() {
        const modal = document.getElementById('ledgerDateRangeModal');
        const header = document.getElementById('ledgerDateRangeModalHeader');
        
        if (!modal || !header) return;
        
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        if (ledgerDateRangeModalDragHandler) {
            header.removeEventListener('mousedown', ledgerDateRangeModalDragHandler.dragStart);
            document.removeEventListener('mousemove', ledgerDateRangeModalDragHandler.drag);
            document.removeEventListener('mouseup', ledgerDateRangeModalDragHandler.dragEnd);
        }
        
        let isDragging = false;
        let currentX = 0;
        let currentY = 0;
        let initialX = 0;
        let initialY = 0;
        
        const dragStart = (e) => {
            if (e.target.tagName === 'BUTTON') return;
            initialX = e.clientX - currentX;
            initialY = e.clientY - currentY;
            
            if (e.target === header || header.contains(e.target)) {
                isDragging = true;
            }
        };
        
        const drag = (e) => {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                modal.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
            }
        };
        
        const dragEnd = () => {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        };
        
        header.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        ledgerDateRangeModalDragHandler = { dragStart, drag, dragEnd };
    }

    // æŸ¥è¯¢æ—¶é—´æ®µå†…çš„å°è´¦æ•°æ®
    function queryLedgerDateRange() {
        const startDate = document.getElementById('ledgerDateRangeStart').value;
        const endDate = document.getElementById('ledgerDateRangeEnd').value;
        
        if (!startDate || !endDate) {
            alert('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
            return;
        }
        
        if (startDate > endDate) {
            alert('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´');
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('ledgerDateRangeInCount').textContent = '...';
        document.getElementById('ledgerDateRangeOutCount').textContent = '...';
        document.getElementById('ledgerDateRangeStockCount').textContent = '...';
        document.getElementById('ledgerDateRangeInfo').textContent = 'æŸ¥è¯¢ä¸­...';
        
        // å‘é€æŸ¥è¯¢è¯·æ±‚
        fetch('/scheduleBoardController/getLedgerStatsByDateRange', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                startDate: startDate,
                endDate: endDate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                const stats = data.data;
                // æ›´æ–°è¿›è´¦æ•°é‡
                const inCount = stats.in_count || 0;
                document.getElementById('ledgerDateRangeInCount').textContent = inCount;
                
                // æ›´æ–°å‡ºè´¦æ•°é‡
                const outCount = stats.out_count || 0;
                document.getElementById('ledgerDateRangeOutCount').textContent = outCount;
                
                // æ›´æ–°å­˜è´¦æ•°é‡
                const stockCount = stats.stock_count || 0;
                document.getElementById('ledgerDateRangeStockCount').textContent = stockCount;
                
                // æ›´æ–°ä¿¡æ¯æç¤º
                document.getElementById('ledgerDateRangeInfo').textContent = 
                    `æŸ¥è¯¢æ—¶é—´æ®µï¼š${startDate} è‡³ ${endDate}`;
            } else {
                console.error('è·å–æ—¶é—´æ®µå°è´¦æ•°æ®å¤±è´¥:', data.message || 'æœªçŸ¥é”™è¯¯');
                document.getElementById('ledgerDateRangeInCount').textContent = '-';
                document.getElementById('ledgerDateRangeOutCount').textContent = '-';
                document.getElementById('ledgerDateRangeStockCount').textContent = '-';
                document.getElementById('ledgerDateRangeInfo').textContent = 'æŸ¥è¯¢å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯');
            }
        })
        .catch(error => {
            console.error('æŸ¥è¯¢æ—¶é—´æ®µå°è´¦æ•°æ®å‡ºé”™:', error);
            document.getElementById('ledgerDateRangeInCount').textContent = '-';
            document.getElementById('ledgerDateRangeOutCount').textContent = '-';
            document.getElementById('ledgerDateRangeStockCount').textContent = '-';
            document.getElementById('ledgerDateRangeInfo').textContent = 'æŸ¥è¯¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•';
        });
    }

    // å½“å‰å°è´¦è¯¦ç»†æ•°æ®ç±»å‹å’Œç»´åº¦
    let currentLedgerType = ''; // 'in', 'out', 'stock'
    let currentLedgerDimension = 'category'; // 'category', 'tester'

    // æ˜¾ç¤ºå°è´¦è¯¦ç»†æ•°æ®æ¨¡æ€æ¡†
    function showLedgerDetail(type) {
        currentLedgerType = type;
        currentLedgerDimension = 'category'; // é»˜è®¤æŒ‰å°ç±»å±•ç¤º
        
        // è®¾ç½®æ ‡é¢˜
        const titleMap = {
            'in': 'è¿›è´¦è¯¦ç»†æ•°æ®',
            'out': 'å‡ºè´¦è¯¦ç»†æ•°æ®',
            'stock': 'å­˜è´¦è¯¦ç»†æ•°æ®'
        };
        document.getElementById('ledgerDetailTitle').textContent = titleMap[type] || 'å°è´¦è¯¦ç»†æ•°æ®';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = document.getElementById('ledgerDetailModal');
        if (modal) {
            modal.style.display = 'flex';
            // é‡ç½®ç»´åº¦æŒ‰é’®çŠ¶æ€
            const categoryBtn = document.getElementById('dimensionCategoryBtn');
            const testerBtn = document.getElementById('dimensionTesterBtn');
            // æ¿€æ´»æŒ‰å°ç±»æŒ‰é’®
            categoryBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            categoryBtn.style.backgroundColor = ''; // æ¸…é™¤ backgroundColor
            categoryBtn.style.fontWeight = '600';
            categoryBtn.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
            // å–æ¶ˆæ¿€æ´»æŒ‰æµ‹è¯•äººå‘˜æŒ‰é’®
            testerBtn.style.background = 'none';
            testerBtn.style.backgroundColor = '#6c757d';
            testerBtn.style.fontWeight = '500';
            testerBtn.style.boxShadow = 'none';
            // åŠ è½½æ•°æ®
            loadLedgerDetailData();
        }
    }

    // å…³é—­å°è´¦è¯¦ç»†æ•°æ®æ¨¡æ€æ¡†
    function closeLedgerDetailModal() {
        const modal = document.getElementById('ledgerDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // åˆ‡æ¢å°è´¦è¯¦ç»†æ•°æ®ç»´åº¦
    function switchLedgerDimension(dimension) {
        currentLedgerDimension = dimension;
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        const categoryBtn = document.getElementById('dimensionCategoryBtn');
        const testerBtn = document.getElementById('dimensionTesterBtn');
        
        if (dimension === 'category') {
            // æ¿€æ´»æŒ‰å°ç±»æŒ‰é’®
            categoryBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            categoryBtn.style.backgroundColor = ''; // æ¸…é™¤ backgroundColor
            categoryBtn.style.fontWeight = '600';
            categoryBtn.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
            // å–æ¶ˆæ¿€æ´»æŒ‰æµ‹è¯•äººå‘˜æŒ‰é’®
            testerBtn.style.background = 'none';
            testerBtn.style.backgroundColor = '#6c757d';
            testerBtn.style.fontWeight = '500';
            testerBtn.style.boxShadow = 'none';
        } else {
            // æ¿€æ´»æŒ‰æµ‹è¯•äººå‘˜æŒ‰é’®
            testerBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            testerBtn.style.backgroundColor = ''; // æ¸…é™¤ backgroundColor
            testerBtn.style.fontWeight = '600';
            testerBtn.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
            // å–æ¶ˆæ¿€æ´»æŒ‰å°ç±»æŒ‰é’®
            categoryBtn.style.background = 'none';
            categoryBtn.style.backgroundColor = '#6c757d';
            categoryBtn.style.fontWeight = '500';
            categoryBtn.style.boxShadow = 'none';
        }
        
        // é‡æ–°åŠ è½½æ•°æ®
        loadLedgerDetailData();
    }

    // åŠ è½½å°è´¦è¯¦ç»†æ•°æ®
    function loadLedgerDetailData() {
        const contentEl = document.getElementById('ledgerDetailContent');
        if (!contentEl) return;
        
        contentEl.innerHTML = `
            <div style="text-align: center; padding: 60px 40px; color: #999; font-size: 16px;">
                <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        `;
        
        fetch(`/scheduleBoardController/getLedgerDetailByDimension?type=${currentLedgerType}&dimension=${currentLedgerDimension}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    renderLedgerDetailData(data.data);
                } else {
                    contentEl.innerHTML = `
                        <div style="text-align: center; padding: 60px 40px; color: #dc3545; font-size: 16px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
                            <div>åŠ è½½å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('åŠ è½½å°è´¦è¯¦ç»†æ•°æ®å‡ºé”™:', error);
                contentEl.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px; color: #dc3545; font-size: 16px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
                        <div>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
                    </div>
                `;
            });
    }

    // æ¸²æŸ“å°è´¦è¯¦ç»†æ•°æ®
    function renderLedgerDetailData(dataList) {
        const contentEl = document.getElementById('ledgerDetailContent');
        if (!contentEl || !dataList || dataList.length === 0) {
            contentEl.innerHTML = `
                <div style="text-align: center; padding: 60px 40px; color: #999; font-size: 16px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“­</div>
                    <div>æš‚æ— æ•°æ®</div>
                </div>
            `;
            return;
        }
        
        const dimensionLabel = currentLedgerDimension === 'category' ? 'å°ç±»' : 'æµ‹è¯•äººå‘˜';
        const icon = currentLedgerDimension === 'category' ? 'ğŸ“¦' : 'ğŸ‘¤';
        
        // æŒ‰ç»´åº¦å€¼åˆ†ç»„
        const groupedData = {};
        dataList.forEach(item => {
            const key = item.dimension_value || (currentLedgerDimension === 'category' ? 'æœªåˆ†ç±»' : 'æœªåˆ†é…');
            if (!groupedData[key]) {
                groupedData[key] = [];
            }
            groupedData[key].push(item);
        });
        
        // è®¡ç®—æ€»æ•°é‡
        const totalCount = dataList.length;
        
        let html = `
            <div style="padding: 20px 25px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-bottom: 2px solid #dee2e6;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">${icon}</span>
                        <span style="font-size: 16px; font-weight: 600; color: #333;">${dimensionLabel}ç»Ÿè®¡</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px; color: #666;">åˆè®¡ï¼š</span>
                        <span style="font-size: 18px; font-weight: bold; color: #007bff;">${totalCount}</span>
                        <span style="font-size: 14px; color: #666;">é¡¹</span>
                    </div>
                </div>
            </div>
        `;
        
        // æŒ‰æ•°é‡æ’åº
        const sortedGroups = Object.keys(groupedData).sort((a, b) => groupedData[b].length - groupedData[a].length);
        
        sortedGroups.forEach((key, index) => {
            const items = groupedData[key];
            const count = items.length;
            const percentage = ((count / totalCount) * 100).toFixed(1);
            
            html += `
                <div style="padding: 20px 25px; border-bottom: 1px solid #e9ecef; ${index % 2 === 0 ? 'background-color: #ffffff;' : 'background-color: #f8f9fa;'}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px; font-weight: bold; color: #667eea; min-width: 30px;">${index + 1}</span>
                            <span style="font-size: 16px; font-weight: 600; color: #333;">${key}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 14px; color: #666;">æ•°é‡ï¼š</span>
                            <span style="font-size: 18px; font-weight: bold; color: #28a745;">${count}</span>
                            <span style="font-size: 14px; color: #999;">(${percentage}%)</span>
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
            `;
            
            items.forEach(item => {
                html += `
                    <div style="padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6; font-size: 13px; color: #495057;">
                        <div style="font-weight: 600; margin-bottom: 4px; color: #212529;">${item.project_name || 'æœªçŸ¥é¡¹ç›®'}</div>
                        <div style="color: #6c757d; font-size: 12px;">${item.create_time || ''}</div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        });
        
        contentEl.innerHTML = html;
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­å’ŒESCé”®å…³é—­
    document.addEventListener('DOMContentLoaded', function() {
        // è®¾ç½®åˆå§‹å­˜è´¦æ¨¡æ€æ¡†
        const setInitialStockModal = document.getElementById('setInitialStockModal');
        if (setInitialStockModal) {
            setInitialStockModal.addEventListener('click', function(e) {
                if (e.target === setInitialStockModal) {
                    closeSetInitialStockModal();
                }
            });
        }
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const setInitialStockModal = document.getElementById('setInitialStockModal');
                const ledgerModal = document.getElementById('ledgerModal');
                const ledgerDetailModal = document.getElementById('ledgerDetailModal');
                const ledgerDateRangeModal = document.getElementById('ledgerDateRangeModal');
                if (setInitialStockModal && setInitialStockModal.style.display === 'flex') {
                    closeSetInitialStockModal();
                }
                if (ledgerDateRangeModal && ledgerDateRangeModal.style.display === 'flex') {
                    closeLedgerDateRangeModal();
                }
                if (ledgerDetailModal && ledgerDetailModal.style.display === 'flex') {
                    closeLedgerDetailModal();
                }
                if (ledgerModal && ledgerModal.style.display === 'flex') {
                    closeLedgerModal();
                }
            }
        });
        
        // ç‚¹å‡»æ—¶é—´æ®µå°è´¦æŸ¥è¯¢æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        const ledgerDateRangeModal = document.getElementById('ledgerDateRangeModal');
        if (ledgerDateRangeModal) {
            ledgerDateRangeModal.addEventListener('click', function(e) {
                if (e.target === ledgerDateRangeModal) {
                    closeLedgerDateRangeModal();
                }
            });
        }
        
        // ç‚¹å‡»å°è´¦è¯¦ç»†æ•°æ®æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        const ledgerDetailModal = document.getElementById('ledgerDetailModal');
        if (ledgerDetailModal) {
            ledgerDetailModal.addEventListener('click', function(e) {
                // ç‚¹å‡»èƒŒæ™¯ï¼ˆæ¨¡æ€æ¡†æœ¬èº«ï¼‰æ—¶å…³é—­ï¼Œä½†ä¸å…³é—­å†…éƒ¨çš„div
                if (e.target === ledgerDetailModal) {
                    closeLedgerDetailModal();
                }
            });
        }
    });
</script>
</body>
</html>
</html>
