<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">数据看板</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 80px 20px 20px;
            background: #f5f5f5;
        }
        .BackBtn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
        }
        .BackBtn:hover { background: #0056b3; }
        
        /* 项目专员数据看板按钮样式 */
        .specialist-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: none; /* 默认隐藏，只有许梦瑶才能看到 */
        }
        .specialist-btn:hover { 
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        /* 加载动画 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #333; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
        }
        .card-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            color: #333;
        }
        .card-description {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin-bottom: 25px;
            width: 100%;
            overflow-x: hidden;
        }
        .chart-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        /* 状态颜色 */
        .status-not-started { color: #ffc107; }
        .status-in-progress { color: #17a2b8; }
        .status-completed { color: #a72828; }
        .status-overdue { color: #28a745; }
        .status-total { color: #6c757d; }

        /* 时间过滤器样式 */
        .time-filter-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-group label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .filter-group .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .filter-separator {
            color: #666;
            font-weight: bold;
        }

        .filter-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .filter-btn:hover {
            background: #0056b3;
        }

        .filter-btn:active {
            transform: translateY(1px);
        }

        /* 项目详情表格样式 */
        .project-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
            min-width: 100%;
        }
        .project-table th, .project-table td {
            border: 1px solid #ddd;
            padding: 8px 6px;
            text-align: left;
            font-size: 12px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .project-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .project-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .project-table tr:hover {
            background-color: #f0f0f0;
        }
        
        /* 为不同列设置合适的宽度 */
        .project-table th:nth-child(1), .project-table td:nth-child(1) { width: 8%; } /* 样品编号 */
        .project-table th:nth-child(2), .project-table td:nth-child(2) { width: 10%; } /* 产品名称 */
        .project-table th:nth-child(3), .project-table td:nth-child(3) { width: 6%; } /* 产品类别 */
        .project-table th:nth-child(4), .project-table td:nth-child(4) { width: 8%; } /* 大编码 */
        .project-table th:nth-child(5), .project-table td:nth-child(5) { width: 8%; } /* 物料编码 */
        .project-table th:nth-child(6), .project-table td:nth-child(6) { width: 4%; } /* 版本 */
        .project-table th:nth-child(7), .project-table td:nth-child(7) { width: 6%; } /* 项目负责人 */
        .project-table th:nth-child(8), .project-table td:nth-child(8) { width: 6%; } /* 当前进度 */
        .project-table th:nth-child(9), .project-table td:nth-child(9) { width: 6%; } /* 测试负责人 */
        .project-table th:nth-child(10), .project-table td:nth-child(10) { width: 6%; } /* DQE负责人 */
        .project-table th:nth-child(11), .project-table td:nth-child(11) { width: 6%; } /* 研发负责人 */
        .project-table th:nth-child(12), .project-table td:nth-child(12) { width: 5%; } /* 送样人 */
        .project-table th:nth-child(13), .project-table td:nth-child(13) { width: 5%; } /* 送样类别 */
        .project-table th:nth-child(14), .project-table td:nth-child(14) { width: 4%; } /* 送样数量 */
        .project-table th:nth-child(15), .project-table td:nth-child(15) { width: 4%; } /* 是否高频 */
        .project-table th:nth-child(16), .project-table td:nth-child(16) { width: 6%; } /* 提单时间 */
        .project-table th:nth-child(17), .project-table td:nth-child(17) { width: 4%; } /* 排期天数 */
        .project-table th:nth-child(18), .project-table td:nth-child(18) { width: 6%; } /* 排期开始 */
        .project-table th:nth-child(19), .project-table td:nth-child(19) { width: 6%; } /* 排期结束 */
        .project-table th:nth-child(20), .project-table td:nth-child(20) { width: 6%; } /* 实际开始时间 */
        .project-table th:nth-child(21), .project-table td:nth-child(21) { width: 6%; } /* 实际完成时间 */
        .project-table th:nth-child(22), .project-table td:nth-child(22) { width: 6%; } /* DQE承认结果 */
        .project-table th:nth-child(23), .project-table td:nth-child(23) { width: 6%; } /* 研发承认结果 */

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 95%;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }

        /* 搜索和筛选样式 */
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn:hover {
            background: #0056b3;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .card {
                padding: 20px;
            }
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* 放大缩小按钮样式 */
        .zoom-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }
        .chart-nav-item:hover {
            background: #e9ecef !important;
            border-color: #007bff !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .zoom-btn:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }
    </style>
</head>
<body>
<button class="BackBtn" onclick="location.href='/DQEIndex'">返回<br>主页</button>
<button class="specialist-btn" id="specialistBtn" onclick="showSpecialistDashboard()">项目专员<br>数据看板</button>

<div class="container">
    <div class="header">
        <h1 id="dashboardTitle">数据看板</h1>
        <p>研发质量管理系统 - 电气测试项目数据展示</p>

        <!-- 提单时间过滤器 -->
        <div class="time-filter-container">
            <div class="filter-group">
                <label for="createTimeStart">提单时间开始：</label>
                <input type="date" id="createTimeStart" class="filter-input">
                <span class="filter-separator">至</span>
                <label for="createTimeEnd">结束：</label>
                <input type="date" id="createTimeEnd" class="filter-input">
                <button class="filter-btn" onclick="applyTimeFilter()">应用筛选</button>
                <button class="filter-btn" onclick="resetTimeFilter()">重置筛选</button>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card" onclick="showProjectDetails('total')">
            <div class="card-value status-total" id="totalCount">0</div>
            <div class="card-title">项目总数</div>
            <div class="card-description">所有电气测试项目</div>
        </div>
        <div class="card" onclick="showProjectDetails('not-started')">
            <div class="card-value status-not-started" id="notStartedCount">0</div>
            <div class="card-title">未开始项目</div>
            <div class="card-description">等待开始测试的项目</div>
        </div>
        <div class="card" onclick="showProjectDetails('in-progress')">
            <div class="card-value status-in-progress" id="inProgressCount">0</div>
            <div class="card-title">进行中项目</div>
            <div class="card-description">正在测试中的项目</div>
        </div>
        <div class="card" onclick="showProjectDetails('completed')">
            <div class="card-value status-completed" id="completedCount">0</div>
            <div class="card-title">已完成未确认项目</div>
            <div class="card-description">测试完成但未签样</div>
        </div>
        <div class="card" onclick="showProjectDetails('overdue')">
            <div class="card-value status-overdue" id="closedCount">0</div>
            <div class="card-title">已确认项目</div>
            <div class="card-description">报告完成已确认结果的项目</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">项目进度概览</div>
        <div class="filter-section">
            <input type="text" class="filter-input" id="searchInput" placeholder="搜索样品编号或产品名称...">
            <select class="filter-input" id="categoryFilter">
                <option value="">所有类别</option>
            </select>
            <select class="filter-input" id="statusFilter">
                <option value="">所有状态</option>
                <option value="未开始">未开始</option>
                <option value="进行中">进行中</option>
                <option value="已完成未确认">已完成未确认</option>
                <option value="已确认">已确认</option>
            </select>

            <button class="filter-btn" onclick="applyFilters()">筛选</button>
            <button class="filter-btn" onclick="resetFilters()">重置</button>
        </div>
        <div id="projectTableContainer">
            <!-- 项目表格将在这里动态生成 -->
        </div>
    </div>
</div>

<!-- 项目详情模态框 -->
<div id="projectModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeProjectModal()">&times;</span>
        <h2 id="modalTitle">项目详情</h2>
        <div id="modalContent">
            <!-- 模态框内容将在这里动态生成 -->
        </div>
    </div>
</div>

<script>
    function getParams() {
        let query = window.location.search;

        return new URLSearchParams(query);
    }

    let projectData = [];
    let filteredData = [];
    let originalProjectData = []; // 保存原始数据
    
    // 项目专员数据看板专用数据
    let specialistProjectData = []; // 存储所有项目数据用于统计

    // 根据job参数设置页面标题和角色信息
    function initializeRoleBasedContent() {
        const urlParams = new URLSearchParams(window.location.search);
        const job = urlParams.get('job') || 'manager';
        
        const roleConfig = {
            'DQE': {
                title: 'DQE数据看板',
                dashboardTitle: 'DQE数据看板'
            },
            'rd': {
                title: '研发数据看板', 
                dashboardTitle: '研发数据看板'
            },
            'manager': {
                title: '管理数据看板',
                dashboardTitle: '主管级别以上数据看板'
            }
        };
        
        const config = roleConfig[job] || roleConfig['manager'];
        
        // 设置页面标题
        document.getElementById('pageTitle').textContent = config.title;
        document.getElementById('dashboardTitle').textContent = config.dashboardTitle;
        
        // 存储当前角色信息，供其他功能使用
        window.currentRole = job;
    }

    // 页面加载完成后获取数据
    document.addEventListener('DOMContentLoaded', function() {
        initializeRoleBasedContent();
        loadProjectData();
    });

    // 加载项目数据
    function loadProjectData() {
        const urlParams = getParams();
        let username = urlParams.get('username');
        let job = urlParams.get('job');

        if (!username) {
            alert('请先输入用户名！');
            return;
        }

        localStorage.setItem("username",username);
        localStorage.setItem("job",job);
        
        // 检查是否为许梦瑶，显示专属按钮
        if (username === '许梦瑶') {
            document.getElementById('specialistBtn').style.display = 'block';
        }

        // 调用DQE个人数据接口
        fetch(`/DQEIndex/getElectricProjectData?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    originalProjectData = data.data; // 保存原始数据
                    projectData = [...originalProjectData];
                    filteredData = [...originalProjectData];
                    
                    // 调试：检查API返回的数据结构
                    console.log('API返回的原始数据:', data);
                    if (data.data && data.data.length > 0) {
                        console.log('第一个项目数据:', data.data[0]);
                        console.log('大编码字段:', data.data[0].sample_model);
                        console.log('版本字段:', data.data[0].version);
                        console.log('所有字段:', Object.keys(data.data[0]));
                    }
                    
                    updateDashboard();
                    updateProjectTable();
                    updateCategoryFilter();
                } else {
                    console.error('获取DQE个人数据失败:', data.error);
                    // 使用模拟数据
                    loadMockData();
                }
            })
            .catch(error => {
                console.error('API调用失败:', error);
                // 使用模拟数据
                loadMockData();
            });
    }

    // 加载模拟数据（当API不可用时）
    function loadMockData() {
        filteredData = [...projectData];
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // 显示项目专员数据看板
    function showSpecialistDashboard() {
        // 创建模态框
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'specialistModal';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 95vw; width: 95vw; height: 95vh; max-height: 95vh; padding: 0; border-radius: 20px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none; flex-shrink: 0;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">📊</span>
                        项目专员数据看板
                    </h3>
                    <span class="close" onclick="closeSpecialistModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
                </div>
                <div style="display: flex; height: calc(100% - 80px); overflow: hidden;">
                    <!-- 左侧导航栏 -->
                    <div id="specialistSidebar" style="width: 280px; background: #f8f9fa; border-right: 2px solid #e9ecef; overflow-y: auto; flex-shrink: 0;">
                        <div style="padding: 20px;">
                            <h4 style="color: #333; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">📈 数据图表</h4>
                            <div id="specialistMenuItems" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- 菜单项将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                    <!-- 右侧内容区域 -->
                    <div id="specialistContent" style="flex: 1; padding: 30px; overflow-y: auto; background: #ffffff;">
                        <div id="specialistChartContainer" style="width: 100%; height: 100%; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                            <div style="text-align: center; padding: 50px; color: #666;">
                                <div style="font-size: 18px; margin-bottom: 20px;">请选择左侧菜单查看数据图表</div>
                                <div style="font-size: 14px; color: #999;">点击左侧菜单项开始浏览数据</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // 初始化导航菜单
        initSpecialistMenu();
        
        // 加载所有项目数据
        loadAllProjectData();
    }

    // 关闭项目专员数据看板模态框
    function closeSpecialistModal() {
        const modal = document.getElementById('specialistModal');
        if (modal) {
            modal.remove();
        }
    }

    // 加载所有项目数据
    function loadAllProjectData() {
        fetch('/DQEIndex/getElectricProjectData')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    specialistProjectData = data.data;
                    console.log('项目专员数据看板加载了', specialistProjectData.length, '个项目数据');
                    
                    // 数据加载完成后，自动点击第一个菜单项
                    autoClickFirstMenuItem();
                } else {
                    console.error('获取项目数据失败:', data.error);
                    specialistProjectData = [];
                }
            })
            .catch(error => {
                console.error('API调用失败:', error);
                specialistProjectData = [];
            });
    }
    
    // 自动点击第一个菜单项
    function autoClickFirstMenuItem() {
        const firstMenuItem = document.getElementById('menu-schedule-distribution');
        if (firstMenuItem) {
            firstMenuItem.click();
        }
    }

    // 初始化项目专员导航菜单
    function initSpecialistMenu() {
        const menuItems = [
            {
                id: 'schedule-distribution',
                title: '排期时间分布',
                icon: '📅',
                description: '查看项目排期时间完整性分布',
                action: 'loadScheduleDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'schedule-days-distribution',
                title: '排期天数分布',
                icon: '📆',
                description: '查看项目排期天数分布情况',
                action: 'loadScheduleDaysDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'project-status',
                title: '项目状态分布',
                icon: '📊',
                description: '查看项目当前状态分布情况',
                action: 'loadProjectStatusData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'category-distribution',
                title: '样品类别分布',
                icon: '🏷️',
                description: '查看不同样品类别的项目分布',
                action: 'loadCategoryDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'priority-distribution',
                title: '优先级分布',
                icon: '⭐',
                description: '查看项目优先级分布情况',
                action: 'loadPriorityDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'tester-distribution',
                title: '测试员分布',
                icon: '👨‍💻',
                description: '查看测试员负责项目分布',
                action: 'loadTesterDistributionData',
                hasMonthlyAnalysis: true
            },
            {
                id: 'monthly-trend',
                title: '月度趋势',
                icon: '📈',
                description: '查看项目创建月度趋势',
                action: 'loadMonthlyTrendData',
                hasMonthlyAnalysis: false
            },
            {
                id: 'monthly-analysis',
                title: '月度分析总览',
                icon: '📊',
                description: '查看各维度月度对比分析',
                action: 'loadMonthlyAnalysisOverview',
                hasMonthlyAnalysis: false
            }
        ];

        const menuContainer = document.getElementById('specialistMenuItems');
        menuContainer.innerHTML = '';

        menuItems.forEach((item, index) => {
            const menuItem = document.createElement('div');
            menuItem.className = 'specialist-menu-item';
            menuItem.id = `menu-${item.id}`;
            menuItem.style.cssText = `
                padding: 15px 20px;
                background: white;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 8px;
            `;
            
            menuItem.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 20px;">${item.icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 4px;">${item.title}</div>
                        <div style="font-size: 12px; color: #666; line-height: 1.3;">${item.description}</div>
                        ${item.hasMonthlyAnalysis ? '<div style="font-size: 10px; color: #667eea; margin-top: 2px;">📊 支持月度分析</div>' : ''}
                    </div>
                </div>
            `;

            // 添加悬停效果
            menuItem.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
                this.style.borderColor = '#667eea';
                this.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.2)';
            });

            menuItem.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
                this.style.borderColor = 'transparent';
                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            });

            // 添加点击事件
            menuItem.addEventListener('click', function() {
                // 移除其他菜单项的选中状态
                document.querySelectorAll('.specialist-menu-item').forEach(item => {
                    item.style.background = 'white';
                    item.style.borderColor = 'transparent';
                });
                
                // 设置当前菜单项为选中状态
                this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                this.style.borderColor = '#667eea';
                this.style.color = 'white';
                
                // 执行对应的数据加载函数
                window[item.action]();
            });

            menuContainer.appendChild(menuItem);
        });
    }

    // 加载排期时间分布数据
    function loadScheduleDistributionData() {
        showSpecialistLoading('排期时间分布');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('排期时间分布', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        // 基于项目数据计算排期时间分布
        const distribution = calculateScheduleDistribution(specialistProjectData);
        renderSpecialistChart('排期时间分布', distribution, 'schedule');
    }

    // 加载排期天数分布数据
    function loadScheduleDaysDistributionData() {
        showSpecialistLoading('排期天数分布');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('排期天数分布', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        // 基于项目数据计算排期天数分布
        const distribution = calculateScheduleDaysDistribution(specialistProjectData);
        renderSpecialistChart('排期天数分布', distribution, 'scheduleDays');
    }

    // 计算排期时间分布
    function calculateScheduleDistribution(projects) {
        const distribution = {
            '1天内开始排期': 0,
            '2-3天开始排期': 0,
            '4-7天开始排期': 0,
            '8-15天开始排期': 0,
            '16-30天开始排期': 0,
            '30天以上开始排期': 0,
            '无排期开始时间': 0
        };
        
        projects.forEach(project => {
            const hasStartDate = project.schedule_start_date && project.schedule_start_date.trim() !== '';
            const createTime = project.create_time;
            
            if (!hasStartDate) {
                // 没有排期开始时间的数据
                distribution['无排期开始时间']++;
            } else {
                // 有排期开始时间的数据：计算从创建时间到排期开始时间的天数
                if (createTime) {
                    try {
                        const createDate = new Date(createTime);
                        createDate.setHours(0, 0, 0, 0);
                        
                        const startDate = new Date(project.schedule_start_date);
                        startDate.setHours(0, 0, 0, 0);
                        
                        const timeDiff = startDate.getTime() - createDate.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        
                        if (daysDiff <= 1) {
                            distribution['1天内开始排期']++;
                        } else if (daysDiff <= 3) {
                            distribution['2-3天开始排期']++;
                        } else if (daysDiff <= 7) {
                            distribution['4-7天开始排期']++;
                        } else if (daysDiff <= 15) {
                            distribution['8-15天开始排期']++;
                        } else if (daysDiff <= 30) {
                            distribution['16-30天开始排期']++;
                        } else {
                            distribution['30天以上开始排期']++;
                        }
                    } catch (e) {
                        distribution['无排期开始时间']++;
                    }
                } else {
                    distribution['无排期开始时间']++;
                }
            }
        });
        
        return distribution;
    }

    // 计算排期天数分布
    function calculateScheduleDaysDistribution(projects) {
        const distribution = {};
        
        projects.forEach(project => {
            const scheduleDays = project.scheduleDays;
            
            if (scheduleDays && !isNaN(scheduleDays) && scheduleDays > 0) {
                // 将排期天数转换为字符串作为键
                const daysKey = `${scheduleDays}天`;
                distribution[daysKey] = (distribution[daysKey] || 0) + 1;
            } else {
                // 没有排期天数或无效数据
                distribution['未设置'] = (distribution['未设置'] || 0) + 1;
            }
        });
        
        // 对天数进行排序，确保图表显示有序
        const sortedEntries = Object.entries(distribution).sort(([a], [b]) => {
            if (a === '未设置') return 1;
            if (b === '未设置') return -1;
            
            const aDays = parseInt(a.replace('天', ''));
            const bDays = parseInt(b.replace('天', ''));
            
            if (isNaN(aDays)) return 1;
            if (isNaN(bDays)) return -1;
            
            return aDays - bDays;
        });
        
        return Object.fromEntries(sortedEntries);
    }

    // 显示加载状态
    function showSpecialistLoading(chartTitle) {
        const container = document.getElementById('specialistChartContainer');
        container.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #666;">
                <div style="font-size: 18px; margin-bottom: 20px;">正在加载${chartTitle}数据...</div>
                <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        `;
    }

    // 显示错误状态
    function showSpecialistError(chartTitle, errorMessage) {
        const container = document.getElementById('specialistChartContainer');
        container.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #dc3545;">
                <div style="font-size: 18px; margin-bottom: 10px;">${chartTitle}数据加载失败</div>
                <div style="font-size: 14px; margin-bottom: 20px;">${errorMessage}</div>
                <button onclick="loadScheduleDistributionData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">重新加载</button>
            </div>
        `;
    }

    // 通用图表渲染函数
    function renderSpecialistChart(title, data, chartType) {
        const container = document.getElementById('specialistChartContainer');
        
        if (!data || Object.keys(data).length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">暂无${title}数据</div>
                    <div style="font-size: 14px;">当前没有找到任何相关数据</div>
                </div>
            `;
            return;
        }

        // 检查是否支持月度分析
        const supportsMonthlyAnalysis = ['schedule', 'scheduleDays', 'status', 'category', 'priority', 'tester'].includes(chartType);

        // 创建图表HTML
        const chartHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">${title}统计</h4>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        ${supportsMonthlyAnalysis ? `
                            <div style="display: flex; gap: 4px; background: white; padding: 6px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <button onclick="showMonthlyAnalysis('${chartType}')" title="月度分析" style="background: #ff6b6b; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">📊 月度</button>
                                <button onclick="showTrendAnalysis('${chartType}')" title="趋势分析" style="background: #4ecdc4; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">📈 趋势</button>
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 4px; background: white; padding: 6px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <button onclick="refreshSpecialistChart('${chartType}')" title="刷新图表" style="background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">🔄</button>
                            <button onclick="exportSpecialistData('${chartType}')" title="导出数据" style="background: #007bff; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">📊</button>
                        </div>
                    </div>
                </div>
                <div id="specialistChart" style="height: 500px; display: flex; align-items: center; justify-content: center;">
                    ${createSpecialistChart(data, chartType)}
                </div>
            </div>
        `;
        
        container.innerHTML = chartHTML;
    }

    // 通用图表创建函数
    function createSpecialistChart(data, chartType) {
        const categories = Object.keys(data);
        const values = Object.values(data);
        
        if (categories.length === 0) {
            return '<div style="text-align: center; color: #666; font-size: 16px;">暂无数据</div>';
        }

        // 计算最大值和颜色
        const maxValue = Math.max(...values);
        const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'];
        
        let chartHTML = '<div style="display: flex; flex-direction: column; gap: 15px; width: 100%;">';
        
        categories.forEach((category, index) => {
            const value = values[index];
            const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
            const color = colors[index % colors.length];
            
            chartHTML += `
                <div onclick="showSpecialistDetails('${category}', '${chartType}')" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'; this.style.borderColor='${color}'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='transparent'">
                    <div style="min-width: 120px; font-weight: 600; color: #333;">${category}</div>
                    <div style="flex: 1; position: relative;">
                        <div style="background: #f0f0f0; height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                            <div style="background: linear-gradient(90deg, ${color} 0%, ${color}dd 100%); height: 100%; width: ${percentage}%; border-radius: 15px; transition: width 0.8s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                                ${value}
                            </div>
                        </div>
                    </div>
                    <div style="min-width: 60px; text-align: right; font-weight: bold; color: #333; font-size: 16px;">${value}</div>
                    <div style="min-width: 20px; text-align: center; color: #666; font-size: 14px;">👆</div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        
        return chartHTML;
    }

    // 其他数据加载函数
    function loadProjectStatusData() {
        showSpecialistLoading('项目状态分布');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('项目状态分布', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        const distribution = calculateProjectStatusDistribution(specialistProjectData);
        renderSpecialistChart('项目状态分布', distribution, 'status');
    }

    function loadCategoryDistributionData() {
        showSpecialistLoading('样品类别分布');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('样品类别分布', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        const distribution = calculateCategoryDistribution(specialistProjectData);
        renderSpecialistChart('样品类别分布', distribution, 'category');
    }

    function loadPriorityDistributionData() {
        showSpecialistLoading('优先级分布');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('优先级分布', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        const distribution = calculatePriorityDistribution(specialistProjectData);
        renderSpecialistChart('优先级分布', distribution, 'priority');
    }

    function loadTesterDistributionData() {
        showSpecialistLoading('测试员分布');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('测试员分布', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        const distribution = calculateTesterDistribution(specialistProjectData);
        renderSpecialistChart('测试员分布', distribution, 'tester');
    }

    function loadMonthlyTrendData() {
        showSpecialistLoading('月度趋势');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('月度趋势', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        const distribution = calculateMonthlyTrend(specialistProjectData);
        renderSpecialistChart('月度趋势', distribution, 'monthly');
    }

    // 显示项目专员详情
    function showSpecialistDetails(category, chartType) {
        // 根据图表类型调用不同的详情查看函数
        switch(chartType) {
            case 'schedule':
                showScheduleDetails(category);
                break;
            case 'scheduleDays':
                showScheduleDaysDetails(category);
                break;
            case 'status':
                showProjectStatusDetails(category);
                break;
            case 'category':
                showCategoryDetails(category);
                break;
            case 'priority':
                showPriorityDetails(category);
                break;
            case 'tester':
                showTesterDetails(category);
                break;
            case 'monthly':
                showMonthlyDetails(category);
                break;
            default:
                alert('详情查看功能开发中...');
        }
    }

    // 显示排期天数详情
    function showScheduleDaysDetails(daysCategory) {
        const filteredProjects = specialistProjectData.filter(project => {
            const scheduleDays = project.scheduleDays;
            
            if (daysCategory === '未设置') {
                return !scheduleDays || isNaN(scheduleDays) || scheduleDays <= 0;
            } else {
                // 解析天数，如 "5天" -> 5
                const expectedDays = parseInt(daysCategory.replace('天', ''));
                return scheduleDays && !isNaN(scheduleDays) && scheduleDays === expectedDays;
            }
        });
        
        showSpecialistDetailsModal(`${daysCategory}排期项目详情`, filteredProjects);
    }

    // 显示项目状态详情
    function showProjectStatusDetails(status) {
        const filteredProjects = specialistProjectData.filter(project => {
            const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
            const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
            const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';
            
            if (status === '未开始') return !hasActualStart;
            if (status === '进行中') return hasActualStart && !hasActualFinish;
            if (status === '已完成未确认') return hasActualFinish && !hasRecognizeResult;
            if (status === '已确认') return hasRecognizeResult;
            return false;
        });
        
        showSpecialistDetailsModal(`${status}项目详情`, filteredProjects);
    }

    // 显示样品类别详情
    function showCategoryDetails(category) {
        const filteredProjects = specialistProjectData.filter(project => {
            const projectCategory = project.sample_category || '未分类';
            return projectCategory === category;
        });
        
        showSpecialistDetailsModal(`${category}类别项目详情`, filteredProjects);
    }

    // 显示优先级详情
    function showPriorityDetails(priority) {
        const filteredProjects = specialistProjectData.filter(project => {
            const projectPriority = project.priority || '';
            if (priority === '高') return projectPriority.includes('高') || projectPriority.includes('紧急');
            if (priority === '中') return projectPriority.includes('中') || projectPriority.includes('普通');
            if (priority === '低') return projectPriority.includes('低') || projectPriority.includes('一般');
            if (priority === '未设置') return !projectPriority || projectPriority.trim() === '';
            return false;
        });
        
        showSpecialistDetailsModal(`${priority}优先级项目详情`, filteredProjects);
    }

    // 显示测试员详情
    function showTesterDetails(tester) {
        const filteredProjects = specialistProjectData.filter(project => {
            const projectTester = project.tester || '未分配';
            return projectTester === tester;
        });
        
        showSpecialistDetailsModal(`${tester}负责的项目详情`, filteredProjects);
    }

    // 显示月度详情
    function showMonthlyDetails(month) {
        const filteredProjects = specialistProjectData.filter(project => {
            if (project.create_time) {
                const date = new Date(project.create_time);
                const year = date.getFullYear();
                const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                const key = `${year}-${monthStr}`;
                return key === month;
            }
            return false;
        });
        
        showSpecialistDetailsModal(`${month}月份项目详情`, filteredProjects);
    }

    // 显示项目专员详情模态框
    function showSpecialistDetailsModal(title, projects) {
        // 创建模态框
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'specialistDetailsModal';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1400px; width: 95%;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">📋</span>
                        ${title} (${projects.length}个项目)
                    </h3>
                    <span class="close" onclick="closeSpecialistDetailsModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
                </div>
                <div class="modal-body" style="padding: 30px; height: calc(100vh - 200px); overflow-y: auto;">
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button onclick="exportSpecialistDetailsExcel('${title}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">📊 导出Excel</button>
                        <button onclick="refreshSpecialistDetails('${title}')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">🔄 刷新数据</button>
                    </div>
                    <div id="specialistDetailsContent">
                        ${createSpecialistDetailsTable(projects)}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        lockPageScroll();
    }

    // 创建项目专员详情表格
    function createSpecialistDetailsTable(projects) {
        if (!projects || projects.length === 0) {
            return '<div style="text-align: center; padding: 50px; color: #666;">暂无项目数据</div>';
        }

        let tableHTML = `
            <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品编号</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品名称</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品类别</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品型号</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">版本</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">项目负责人</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">当前进度</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">排期天数</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">排期开始时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">排期结束时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">实际开始时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">实际完成时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">备注</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        projects.forEach((project, index) => {
            const rowStyle = index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';
            
            // 计算当前进度状态
            const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
            const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
            const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';
            
            let progressStatus = '未开始';
            let statusColor = '#ffc107'; // 默认颜色
            
            if (!hasActualStart) {
                progressStatus = '未开始';
                statusColor = '#ffc107'; // 黄色
            } else if (hasActualStart && !hasActualFinish) {
                progressStatus = '进行中';
                statusColor = '#17a2b8'; // 蓝色
            } else if (hasActualFinish && !hasRecognizeResult) {
                progressStatus = '已完成待确认';
                statusColor = '#a72828'; // 红色
            } else if (hasRecognizeResult) {
                progressStatus = '已确认';
                statusColor = '#28a745'; // 绿色
            }
            
            // 格式化排期天数
            const scheduleDays = project.scheduleDays;
            const scheduleDaysDisplay = scheduleDays && !isNaN(scheduleDays) && scheduleDays > 0 ? `${scheduleDays}天` : '未设置';
            
            tableHTML += `
                <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; font-weight: 500; color: #333;">${project.sample_id || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_name || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_category || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_model || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.version || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_leader || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">
                        <span style="color: ${statusColor}; font-weight: bold;">${progressStatus}</span>
                    </td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333; text-align: center;">${scheduleDaysDisplay}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_start_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_end_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_start_time || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_finish_time || '-'}</td>
                    <td style="padding: 12px; color: #333;">${project.remark || '-'}</td>
                </tr>
            `;
        });

        tableHTML += `
                    </tbody>
                </table>
            </div>
        `;

        return tableHTML;
    }

    // 关闭项目专员详情模态框
    function closeSpecialistDetailsModal() {
        const modal = document.getElementById('specialistDetailsModal');
        if (modal) {
            modal.remove();
            unlockPageScroll();
        }
    }

    // 刷新项目专员详情
    function refreshSpecialistDetails(title) {
        // 重新加载数据
        loadAllProjectData();
        alert('数据已刷新，请重新选择查看');
    }

    // 导出项目专员详情Excel
    function exportSpecialistDetailsExcel(title) {
        alert(`${title}Excel导出功能开发中...`);
    }


    // 刷新项目专员图表
    function refreshSpecialistChart(chartType) {
        switch(chartType) {
            case 'schedule':
                loadScheduleDistributionData();
                break;
            case 'scheduleDays':
                loadScheduleDaysDistributionData();
                break;
            case 'status':
                loadProjectStatusData();
                break;
            case 'category':
                loadCategoryDistributionData();
                break;
            case 'priority':
                loadPriorityDistributionData();
                break;
            case 'tester':
                loadTesterDistributionData();
                break;
            case 'monthly':
                loadMonthlyTrendData();
                break;
        }
    }

    // 导出项目专员数据
    function exportSpecialistData(chartType) {
        alert(`${chartType}数据导出功能开发中...`);
    }

    // 计算项目状态分布
    function calculateProjectStatusDistribution(projects) {
        const distribution = {
            '未开始': 0,
            '进行中': 0,
            '已完成未确认': 0,
            '已确认': 0
        };
        
        projects.forEach(project => {
            const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
            const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
            const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';
            
            if (!hasActualStart) {
                distribution['未开始']++;
            } else if (hasActualStart && !hasActualFinish) {
                distribution['进行中']++;
            } else if (hasActualFinish && !hasRecognizeResult) {
                distribution['已完成未确认']++;
            } else if (hasRecognizeResult) {
                distribution['已确认']++;
            }
        });
        
        return distribution;
    }

    // 计算样品类别分布
    function calculateCategoryDistribution(projects) {
        const distribution = {};
        
        projects.forEach(project => {
            const category = project.sample_category || '未分类';
            distribution[category] = (distribution[category] || 0) + 1;
        });
        
        // 按数量排序
        const sortedEntries = Object.entries(distribution)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10); // 只显示前10个类别
        
        return Object.fromEntries(sortedEntries);
    }

    // 计算优先级分布
    function calculatePriorityDistribution(projects) {
        const distribution = {
            '高': 0,
            '中': 0,
            '低': 0,
            '未设置': 0
        };
        
        projects.forEach(project => {
            const priority = project.priority || '';
            if (priority.includes('高') || priority.includes('紧急')) {
                distribution['高']++;
            } else if (priority.includes('中') || priority.includes('普通')) {
                distribution['中']++;
            } else if (priority.includes('低') || priority.includes('一般')) {
                distribution['低']++;
            } else {
                distribution['未设置']++;
            }
        });
        
        return distribution;
    }

    // 计算测试员分布
    function calculateTesterDistribution(projects) {
        const distribution = {};
        
        projects.forEach(project => {
            const tester = project.tester || '未分配';
            distribution[tester] = (distribution[tester] || 0) + 1;
        });
        
        // 按数量排序，只显示前10个测试员
        const sortedEntries = Object.entries(distribution)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10);
        
        return Object.fromEntries(sortedEntries);
    }

    // 计算月度趋势
    function calculateMonthlyTrend(projects) {
        const distribution = {};
        
        projects.forEach(project => {
            if (project.create_time) {
                const date = new Date(project.create_time);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const key = `${year}-${month}`;
                distribution[key] = (distribution[key] || 0) + 1;
            }
        });
        
        // 按月份排序
        const sortedEntries = Object.entries(distribution)
            .sort(([a], [b]) => a.localeCompare(b))
            .slice(-12); // 只显示最近12个月
        
        return Object.fromEntries(sortedEntries);
    }

    // 计算月度分析数据
    function calculateMonthlyAnalysis(projects, chartType) {
        const monthlyData = {};
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;
        
        // 获取最近12个月的数据
        for (let i = 11; i >= 0; i--) {
            const date = new Date(currentYear, currentMonth - 1 - i, 1);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const monthKey = `${year}-${month}`;
            
            monthlyData[monthKey] = {
                total: 0,
                distribution: {}
            };
        }
        
        // 根据图表类型计算分布
        projects.forEach(project => {
            if (!project.create_time) return;
            
            const projectDate = new Date(project.create_time);
            const year = projectDate.getFullYear();
            const month = String(projectDate.getMonth() + 1).padStart(2, '0');
            const monthKey = `${year}-${month}`;
            
            if (monthlyData[monthKey]) {
                monthlyData[monthKey].total++;
                
                let category = '';
                switch(chartType) {
                    case 'schedule':
                        category = calculateScheduleCategory(project);
                        break;
                    case 'scheduleDays':
                        category = calculateScheduleDaysCategory(project);
                        break;
                    case 'status':
                        category = calculateStatusCategory(project);
                        break;
                    case 'category':
                        category = project.sample_category || '未分类';
                        break;
                    case 'priority':
                        category = calculatePriorityCategory(project);
                        break;
                    case 'tester':
                        category = project.tester || '未指定';
                        break;
                }
                
                if (category) {
                    monthlyData[monthKey].distribution[category] = (monthlyData[monthKey].distribution[category] || 0) + 1;
                }
            }
        });
        
        return monthlyData;
    }

    // 计算排期时间分类
    function calculateScheduleCategory(project) {
        const hasStartDate = project.schedule_start_date && project.schedule_start_date.trim() !== '';
        const createTime = project.create_time;
        
        if (!hasStartDate) {
            return '无排期开始时间';
        } else if (createTime) {
            try {
                const createDate = new Date(createTime);
                createDate.setHours(0, 0, 0, 0);
                
                const startDate = new Date(project.schedule_start_date);
                startDate.setHours(0, 0, 0, 0);
                
                const diffDays = Math.ceil((startDate - createDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 1) return '1天内开始排期';
                if (diffDays <= 3) return '2-3天开始排期';
                if (diffDays <= 7) return '4-7天开始排期';
                if (diffDays <= 15) return '8-15天开始排期';
                if (diffDays <= 30) return '16-30天开始排期';
                return '30天以上开始排期';
            } catch (e) {
                return '无排期开始时间';
            }
        }
        return '无排期开始时间';
    }

    // 计算排期天数分类
    function calculateScheduleDaysCategory(project) {
        const scheduleDays = project.scheduleDays;
        if (scheduleDays && !isNaN(scheduleDays) && scheduleDays > 0) {
            return `${scheduleDays}天`;
        }
        return '未设置';
    }

    // 计算项目状态分类
    function calculateStatusCategory(project) {
        const hasActualStart = project.actual_start_time && project.actual_start_time.trim() !== '';
        const hasActualFinish = project.actual_finish_time && project.actual_finish_time.trim() !== '';
        const hasRecognizeResult = project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '';
        
        if (!hasActualStart) return '未开始';
        if (hasActualStart && !hasActualFinish) return '进行中';
        if (hasActualFinish && !hasRecognizeResult) return '已完成未确认';
        if (hasRecognizeResult) return '已确认';
        return '未开始';
    }

    // 计算优先级分类
    function calculatePriorityCategory(project) {
        const priority = project.priority || '';
        if (priority.includes('高') || priority.includes('紧急')) return '高';
        if (priority.includes('中') || priority.includes('普通')) return '中';
        if (priority.includes('低') || priority.includes('一般')) return '低';
        return '未设置';
    }

    // 计算同比环比数据
    function calculateComparisonData(monthlyData) {
        const months = Object.keys(monthlyData).sort();
        const comparisonData = {};
        
        months.forEach((month, index) => {
            const currentData = monthlyData[month];
            const prevMonth = months[index - 1];
            const prevYearMonth = getPreviousYearMonth(month);
            
            comparisonData[month] = {
                ...currentData,
                monthOverMonth: prevMonth ? calculateGrowthRate(monthlyData[prevMonth].total, currentData.total) : 0,
                yearOverYear: monthlyData[prevYearMonth] ? calculateGrowthRate(monthlyData[prevYearMonth].total, currentData.total) : 0
            };
        });
        
        return comparisonData;
    }

    // 获取去年同期月份
    function getPreviousYearMonth(monthKey) {
        const [year, month] = monthKey.split('-');
        const prevYear = parseInt(year) - 1;
        return `${prevYear}-${month}`;
    }

    // 计算增长率
    function calculateGrowthRate(previous, current) {
        if (previous === 0) return current > 0 ? 100 : 0;
        return ((current - previous) / previous * 100).toFixed(1);
    }

    // 计算各分类的月度分析数据
    function calculateCategoryMonthlyAnalysis(monthlyData) {
        const months = Object.keys(monthlyData).sort();
        const categoryAnalysis = {};
        
        // 收集所有分类
        const allCategories = new Set();
        months.forEach(month => {
            Object.keys(monthlyData[month].distribution).forEach(category => {
                allCategories.add(category);
            });
        });
        
        // 为每个分类计算月度数据
        allCategories.forEach(category => {
            categoryAnalysis[category] = {
                monthlyData: {},
                trend: 'stable',
                growthRate: 0,
                peakMonth: '',
                totalCount: 0
            };
            
            let monthlyValues = [];
            months.forEach(month => {
                const value = monthlyData[month].distribution[category] || 0;
                categoryAnalysis[category].monthlyData[month] = value;
                monthlyValues.push(value);
                categoryAnalysis[category].totalCount += value;
            });
            
            // 计算趋势
            if (monthlyValues.length >= 2) {
                const firstHalf = monthlyValues.slice(0, Math.floor(monthlyValues.length / 2));
                const secondHalf = monthlyValues.slice(Math.floor(monthlyValues.length / 2));
                const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
                
                if (secondAvg > firstAvg * 1.1) {
                    categoryAnalysis[category].trend = 'rising';
                } else if (secondAvg < firstAvg * 0.9) {
                    categoryAnalysis[category].trend = 'declining';
                }
                
                // 计算总体增长率
                const firstValue = monthlyValues[0];
                const lastValue = monthlyValues[monthlyValues.length - 1];
                categoryAnalysis[category].growthRate = calculateGrowthRate(firstValue, lastValue);
            }
            
            // 找到峰值月份
            const maxValue = Math.max(...monthlyValues);
            const peakIndex = monthlyValues.indexOf(maxValue);
            if (peakIndex !== -1) {
                categoryAnalysis[category].peakMonth = months[peakIndex];
            }
        });
        
        return categoryAnalysis;
    }

    // 显示分类分析
    function showCategoryAnalysis(chartType) {
        const container = document.getElementById('specialistChartContainer');
        
        if (specialistProjectData.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">暂无数据</div>
                    <div style="font-size: 14px;">项目数据未加载完成，请稍后重试</div>
                </div>
            `;
            return;
        }
        
        const monthlyData = calculateMonthlyAnalysis(specialistProjectData, chartType);
        const categoryAnalysis = calculateCategoryMonthlyAnalysis(monthlyData);
        const chartTitle = getChartTitle(chartType);
        
        container.innerHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">${chartTitle} - 分类分析</h4>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <button onclick="showMonthlyAnalysis('${chartType}')" title="月度分析" style="background: #ff6b6b; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">📊 月度</button>
                        <button onclick="showTrendAnalysis('${chartType}')" title="趋势分析" style="background: #4ecdc4; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">📈 趋势</button>
                        <button onclick="refreshSpecialistChart('${chartType}')" title="返回原图" style="background: #6c757d; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">🔙 返回</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100% - 80px);">
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">📊 各分类趋势概览</h5>
                        ${createCategoryOverviewChart(categoryAnalysis)}
                    </div>
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">📈 分类增长率排名</h5>
                        ${createCategoryGrowthRanking(categoryAnalysis)}
                    </div>
                </div>
                <div style="margin-top: 20px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">🔍 各分类详细月度变化</h5>
                    ${createDetailedCategoryAnalysis(categoryAnalysis, monthlyData)}
                </div>
            </div>
        `;
    }

    // 显示月度分析
    function showMonthlyAnalysis(chartType) {
        const container = document.getElementById('specialistChartContainer');
        
        if (specialistProjectData.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">暂无数据</div>
                    <div style="font-size: 14px;">项目数据未加载完成，请稍后重试</div>
                </div>
            `;
            return;
        }
        
        const monthlyData = calculateMonthlyAnalysis(specialistProjectData, chartType);
        const comparisonData = calculateComparisonData(monthlyData);
        const categoryAnalysis = calculateCategoryMonthlyAnalysis(monthlyData);
        
        const chartTitle = getChartTitle(chartType);
        
        container.innerHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">${chartTitle} - 月度分析</h4>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <button onclick="showTrendAnalysis('${chartType}')" title="趋势分析" style="background: #4ecdc4; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">📈 趋势</button>
                        <button onclick="showCategoryAnalysis('${chartType}')" title="分类分析" style="background: #ff9f43; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">🔍 分类</button>
                        <button onclick="refreshSpecialistChart('${chartType}')" title="返回原图" style="background: #6c757d; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">🔙 返回</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100% - 80px);">
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">📊 月度总量趋势</h5>
                        ${createMonthlyTrendChart(comparisonData)}
                    </div>
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">📈 同比环比分析</h5>
                        ${createComparisonChart(comparisonData)}
                    </div>
                </div>
                <div style="margin-top: 20px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">🔍 各分类月度变化趋势</h5>
                    ${createCategoryTrendAnalysis(categoryAnalysis)}
                </div>
            </div>
        `;
    }

    // 显示趋势分析
    function showTrendAnalysis(chartType) {
        const container = document.getElementById('specialistChartContainer');
        
        if (specialistProjectData.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 18px; margin-bottom: 10px;">暂无数据</div>
                    <div style="font-size: 14px;">项目数据未加载完成，请稍后重试</div>
                </div>
            `;
            return;
        }
        
        const monthlyData = calculateMonthlyAnalysis(specialistProjectData, chartType);
        const chartTitle = getChartTitle(chartType);
        
        container.innerHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">${chartTitle} - 趋势分析</h4>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <button onclick="showMonthlyAnalysis('${chartType}')" title="月度分析" style="background: #ff6b6b; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">📊 月度</button>
                        <button onclick="refreshSpecialistChart('${chartType}')" title="返回原图" style="background: #6c757d; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">🔙 返回</button>
                    </div>
                </div>
                <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: calc(100% - 80px);">
                    <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">📈 各维度趋势热力图</h5>
                    ${createTrendHeatmap(monthlyData, chartType)}
                </div>
            </div>
        `;
    }

    // 获取图表标题
    function getChartTitle(chartType) {
        const titles = {
            'schedule': '排期时间分布',
            'scheduleDays': '排期天数分布',
            'status': '项目状态分布',
            'category': '样品类别分布',
            'priority': '优先级分布',
            'tester': '测试员分布'
        };
        return titles[chartType] || '数据分布';
    }

    // 创建月度趋势图表
    function createMonthlyTrendChart(comparisonData) {
        const months = Object.keys(comparisonData).sort();
        const totals = months.map(month => comparisonData[month].total);
        const maxTotal = Math.max(...totals);
        
        let chartHTML = '<div style="height: 300px; display: flex; align-items: end; gap: 8px; padding: 20px 0;">';
        
        months.forEach((month, index) => {
            const height = (comparisonData[month].total / maxTotal) * 250;
            const monthLabel = month.substring(5); // 只显示月份
            const isCurrentMonth = index === months.length - 1;
            
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div style="
                        width: 100%; 
                        height: ${height}px; 
                        background: ${isCurrentMonth ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)'};
                        border-radius: 4px 4px 0 0;
                        position: relative;
                        transition: all 0.3s ease;
                        cursor: pointer;
                    " 
                    onmouseover="this.style.transform='scale(1.05)'" 
                    onmouseout="this.style.transform='scale(1)'"
                    title="${month}: ${comparisonData[month].total}个项目">
                        <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: bold; color: #333;">
                            ${comparisonData[month].total}
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: #666; font-weight: 500;">
                        ${monthLabel}月
                    </div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建同比环比分析图表
    function createComparisonChart(comparisonData) {
        const months = Object.keys(comparisonData).sort();
        
        let chartHTML = '<div style="height: 300px; overflow-y: auto;">';
        
        months.forEach(month => {
            const data = comparisonData[month];
            const monthLabel = month.substring(5);
            const momRate = parseFloat(data.monthOverMonth);
            const yoyRate = parseFloat(data.yearOverYear);
            
            chartHTML += `
                <div style="
                    background: #f8f9fa; 
                    border-radius: 8px; 
                    padding: 15px; 
                    margin-bottom: 10px; 
                    border-left: 4px solid #667eea;
                    transition: all 0.3s ease;
                " 
                onmouseover="this.style.background='#e9ecef'; this.style.transform='translateX(5px)'" 
                onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateX(0)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #333; font-size: 14px;">${monthLabel}月</div>
                        <div style="font-weight: bold; color: #667eea; font-size: 16px;">${data.total}个项目</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">环比上月</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${momRate >= 0 ? '#28a745' : '#dc3545'};">
                                ${momRate >= 0 ? '+' : ''}${momRate}%
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">同比去年</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${yoyRate >= 0 ? '#28a745' : '#dc3545'};">
                                ${yoyRate >= 0 ? '+' : ''}${yoyRate}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建趋势热力图
    function createTrendHeatmap(monthlyData, chartType) {
        const months = Object.keys(monthlyData).sort();
        const allCategories = new Set();
        
        // 收集所有分类
        months.forEach(month => {
            Object.keys(monthlyData[month].distribution).forEach(category => {
                allCategories.add(category);
            });
        });
        
        const categories = Array.from(allCategories);
        const maxValue = Math.max(...months.map(month => 
            Math.max(...Object.values(monthlyData[month].distribution))
        ));
        
        let chartHTML = `
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">分类</th>
        `;
        
        months.forEach(month => {
            const monthLabel = month.substring(5);
            chartHTML += `<th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">${monthLabel}月</th>`;
        });
        
        chartHTML += '</tr></thead><tbody>';
        
        categories.forEach(category => {
            chartHTML += `<tr>`;
            chartHTML += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">${category}</td>`;
            
            months.forEach(month => {
                const value = monthlyData[month].distribution[category] || 0;
                const intensity = maxValue > 0 ? value / maxValue : 0;
                const color = getHeatmapColor(intensity);
                
                chartHTML += `
                    <td style="
                        padding: 10px; 
                        text-align: center; 
                        border: 1px solid #dee2e6; 
                        background: ${color};
                        color: ${intensity > 0.5 ? 'white' : '#333'};
                        font-weight: bold;
                    " title="${month}: ${value}个项目">
                        ${value}
                    </td>
                `;
            });
            
            chartHTML += '</tr>';
        });
        
        chartHTML += '</tbody></table></div>';
        return chartHTML;
    }

    // 获取热力图颜色
    function getHeatmapColor(intensity) {
        if (intensity === 0) return '#f8f9fa';
        if (intensity <= 0.2) return '#d4edda';
        if (intensity <= 0.4) return '#c3e6cb';
        if (intensity <= 0.6) return '#a3d9a4';
        if (intensity <= 0.8) return '#7dd87d';
        return '#28a745';
    }

    // 加载月度分析总览
    function loadMonthlyAnalysisOverview() {
        showSpecialistLoading('月度分析总览');
        
        if (specialistProjectData.length === 0) {
            showSpecialistError('月度分析总览', '项目数据未加载完成，请稍后重试');
            return;
        }
        
        const container = document.getElementById('specialistChartContainer');
        
        // 计算各维度的月度数据
        const dimensions = ['schedule', 'scheduleDays', 'status', 'category', 'priority', 'tester'];
        const monthlyAnalysisData = {};
        
        dimensions.forEach(dimension => {
            monthlyAnalysisData[dimension] = calculateMonthlyAnalysis(specialistProjectData, dimension);
        });
        
        container.innerHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1; min-width: 200px;">📊 月度分析总览</h4>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <button onclick="refreshSpecialistChart('monthly-analysis')" title="刷新数据" style="background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">🔄 刷新</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100% - 80px);">
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">📈 各维度月度趋势对比</h5>
                        ${createOverviewTrendChart(monthlyAnalysisData)}
                    </div>
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h5 style="color: #333; margin-bottom: 15px; font-size: 16px;">📊 最近3个月数据对比</h5>
                        ${createRecentMonthsComparison(monthlyAnalysisData)}
                    </div>
                </div>
            </div>
        `;
    }

    // 创建总览趋势图表
    function createOverviewTrendChart(monthlyAnalysisData) {
        const months = Object.keys(monthlyAnalysisData.schedule).sort();
        const dimensions = [
            { key: 'schedule', name: '排期时间', color: '#667eea' },
            { key: 'scheduleDays', name: '排期天数', color: '#4ecdc4' },
            { key: 'status', name: '项目状态', color: '#ff6b6b' },
            { key: 'category', name: '样品类别', color: '#feca57' },
            { key: 'priority', name: '优先级', color: '#48dbfb' },
            { key: 'tester', name: '测试员', color: '#ff9ff3' }
        ];
        
        let chartHTML = '<div style="height: 400px; overflow-y: auto;">';
        
        dimensions.forEach(dimension => {
            const data = monthlyAnalysisData[dimension.key];
            const totals = months.map(month => data[month].total);
            const maxTotal = Math.max(...totals);
            
            chartHTML += `
                <div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h6 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">${dimension.name}</h6>
                        <div style="font-size: 12px; color: #666;">总计: ${totals.reduce((a, b) => a + b, 0)}个项目</div>
                    </div>
                    <div style="display: flex; align-items: end; gap: 4px; height: 60px;">
            `;
            
            months.forEach((month, index) => {
                const height = maxTotal > 0 ? (data[month].total / maxTotal) * 50 : 0;
                const monthLabel = month.substring(5);
                
                chartHTML += `
                    <div style="
                        flex: 1; 
                        height: ${height}px; 
                        background: ${dimension.color}; 
                        border-radius: 2px 2px 0 0;
                        position: relative;
                        transition: all 0.3s ease;
                        cursor: pointer;
                    " 
                    onmouseover="this.style.opacity='0.8'" 
                    onmouseout="this.style.opacity='1'"
                    title="${month}: ${data[month].total}个项目">
                        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: bold; color: #333; white-space: nowrap;">
                            ${data[month].total}
                        </div>
                    </div>
                `;
            });
            
            chartHTML += `
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 10px; color: #666;">
                        <span>${months[0].substring(5)}月</span>
                        <span>${months[months.length-1].substring(5)}月</span>
                    </div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建最近3个月对比
    function createRecentMonthsComparison(monthlyAnalysisData) {
        const months = Object.keys(monthlyAnalysisData.schedule).sort();
        const recentMonths = months.slice(-3);
        
        let chartHTML = '<div style="height: 400px; overflow-y: auto;">';
        
        recentMonths.forEach(month => {
            const monthLabel = month.substring(5);
            const monthData = {};
            
            Object.keys(monthlyAnalysisData).forEach(dimension => {
                monthData[dimension] = monthlyAnalysisData[dimension][month].total;
            });
            
            const totalProjects = Object.values(monthData).reduce((a, b) => a + b, 0);
            
            chartHTML += `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h6 style="margin: 0; color: #333; font-size: 16px; font-weight: 600;">${monthLabel}月</h6>
                        <div style="font-size: 14px; color: #667eea; font-weight: bold;">总计: ${totalProjects}个项目</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            `;
            
            const dimensions = [
                { key: 'schedule', name: '排期时间', color: '#667eea' },
                { key: 'scheduleDays', name: '排期天数', color: '#4ecdc4' },
                { key: 'status', name: '项目状态', color: '#ff6b6b' },
                { key: 'category', name: '样品类别', color: '#feca57' },
                { key: 'priority', name: '优先级', color: '#48dbfb' },
                { key: 'tester', name: '测试员', color: '#ff9ff3' }
            ];
            
            dimensions.forEach(dimension => {
                const value = monthData[dimension.key] || 0;
                const percentage = totalProjects > 0 ? ((value / totalProjects) * 100).toFixed(1) : 0;
                
                chartHTML += `
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${dimension.name}</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${dimension.color}; margin-bottom: 3px;">${value}</div>
                        <div style="font-size: 10px; color: #999;">${percentage}%</div>
                    </div>
                `;
            });
            
            chartHTML += `
                    </div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建分类趋势分析图表
    function createCategoryTrendAnalysis(categoryAnalysis) {
        const categories = Object.keys(categoryAnalysis);
        const months = Object.keys(categoryAnalysis[categories[0]]?.monthlyData || {}).sort();
        
        let chartHTML = '<div style="height: 400px; overflow-y: auto;">';
        
        categories.forEach(category => {
            const data = categoryAnalysis[category];
            const monthlyValues = months.map(month => data.monthlyData[month] || 0);
            const maxValue = Math.max(...monthlyValues);
            const trendIcon = data.trend === 'rising' ? '📈' : data.trend === 'declining' ? '📉' : '➡️';
            const trendColor = data.trend === 'rising' ? '#28a745' : data.trend === 'declining' ? '#dc3545' : '#6c757d';
            
            chartHTML += `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${trendColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">${trendIcon}</span>
                            <h6 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">${category}</h6>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="font-size: 12px; color: #666;">总计: ${data.totalCount}</div>
                            <div style="font-size: 12px; color: ${trendColor}; font-weight: bold;">
                                增长率: ${data.growthRate >= 0 ? '+' : ''}${data.growthRate}%
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: end; gap: 3px; height: 40px; margin-bottom: 8px;">
            `;
            
            monthlyValues.forEach((value, index) => {
                const height = maxValue > 0 ? (value / maxValue) * 35 : 0;
                const monthLabel = months[index].substring(5);
                
                chartHTML += `
                    <div style="
                        flex: 1; 
                        height: ${height}px; 
                        background: ${trendColor}; 
                        border-radius: 2px 2px 0 0;
                        position: relative;
                        transition: all 0.3s ease;
                        cursor: pointer;
                    " 
                    onmouseover="this.style.opacity='0.8'" 
                    onmouseout="this.style.opacity='1'"
                    title="${months[index]}: ${value}个项目">
                        <div style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 9px; font-weight: bold; color: #333; white-space: nowrap;">
                            ${value}
                        </div>
                    </div>
                `;
            });
            
            chartHTML += `
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666;">
                        <span>${months[0].substring(5)}月</span>
                        <span>峰值: ${data.peakMonth.substring(5)}月</span>
                        <span>${months[months.length-1].substring(5)}月</span>
                    </div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建分类概览图表
    function createCategoryOverviewChart(categoryAnalysis) {
        const categories = Object.keys(categoryAnalysis);
        
        let chartHTML = '<div style="height: 400px; overflow-y: auto;">';
        
        categories.forEach(category => {
            const data = categoryAnalysis[category];
            const trendIcon = data.trend === 'rising' ? '📈' : data.trend === 'declining' ? '📉' : '➡️';
            const trendColor = data.trend === 'rising' ? '#28a745' : data.trend === 'declining' ? '#dc3545' : '#6c757d';
            
            chartHTML += `
                <div style="
                    margin-bottom: 15px; 
                    padding: 15px; 
                    background: white; 
                    border-radius: 8px; 
                    border-left: 4px solid ${trendColor};
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                " 
                onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.15)'" 
                onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">${trendIcon}</span>
                            <h6 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">${category}</h6>
                        </div>
                        <div style="font-size: 16px; font-weight: bold; color: ${trendColor};">
                            ${data.totalCount}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <div style="color: #666; margin-bottom: 2px;">增长率</div>
                            <div style="font-weight: bold; color: ${trendColor};">
                                ${data.growthRate >= 0 ? '+' : ''}${data.growthRate}%
                            </div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <div style="color: #666; margin-bottom: 2px;">峰值月份</div>
                            <div style="font-weight: bold; color: #333;">
                                ${data.peakMonth ? data.peakMonth.substring(5) + '月' : '-'}
                            </div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <div style="color: #666; margin-bottom: 2px;">趋势</div>
                            <div style="font-weight: bold; color: ${trendColor};">
                                ${data.trend === 'rising' ? '上升' : data.trend === 'declining' ? '下降' : '稳定'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建分类增长率排名
    function createCategoryGrowthRanking(categoryAnalysis) {
        const categories = Object.keys(categoryAnalysis);
        const sortedCategories = categories.sort((a, b) => 
            parseFloat(categoryAnalysis[b].growthRate) - parseFloat(categoryAnalysis[a].growthRate)
        );
        
        let chartHTML = '<div style="height: 400px; overflow-y: auto;">';
        
        sortedCategories.forEach((category, index) => {
            const data = categoryAnalysis[category];
            const growthRate = parseFloat(data.growthRate);
            const rankColor = index < 3 ? '#ff6b6b' : index < 6 ? '#ffa726' : '#66bb6a';
            const rankIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🔸';
            
            chartHTML += `
                <div style="
                    margin-bottom: 12px; 
                    padding: 12px; 
                    background: white; 
                    border-radius: 8px; 
                    border-left: 4px solid ${rankColor};
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                " 
                onmouseover="this.style.transform='translateX(3px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">${rankIcon}</span>
                            <div>
                                <div style="font-weight: 600; color: #333; font-size: 14px;">${category}</div>
                                <div style="font-size: 12px; color: #666;">总计: ${data.totalCount}个项目</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: ${rankColor};">
                                ${growthRate >= 0 ? '+' : ''}${growthRate}%
                            </div>
                            <div style="font-size: 10px; color: #666;">第${index + 1}名</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建详细分类分析
    function createDetailedCategoryAnalysis(categoryAnalysis, monthlyData) {
        const categories = Object.keys(categoryAnalysis);
        const months = Object.keys(monthlyData).sort();
        
        let chartHTML = `
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600; position: sticky; left: 0; background: #f8f9fa;">分类</th>
        `;
        
        months.forEach(month => {
            const monthLabel = month.substring(5);
            chartHTML += `<th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">${monthLabel}月</th>`;
        });
        
        chartHTML += `
                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">总计</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">增长率</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">趋势</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        categories.forEach(category => {
            const data = categoryAnalysis[category];
            const trendIcon = data.trend === 'rising' ? '📈' : data.trend === 'declining' ? '📉' : '➡️';
            const trendColor = data.trend === 'rising' ? '#28a745' : data.trend === 'declining' ? '#dc3545' : '#6c757d';
            
            chartHTML += `<tr style="border-bottom: 1px solid #dee2e6;">`;
            chartHTML += `<td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 500; position: sticky; left: 0; background: white;">${category}</td>`;
            
            months.forEach(month => {
                const value = data.monthlyData[month] || 0;
                chartHTML += `
                    <td style="
                        padding: 12px; 
                        text-align: center; 
                        border: 1px solid #dee2e6; 
                        font-weight: bold;
                    ">
                        ${value}
                    </td>
                `;
            });
            
            chartHTML += `
                <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; color: #667eea;">
                    ${data.totalCount}
                </td>
                <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; color: ${trendColor};">
                    ${data.growthRate >= 0 ? '+' : ''}${data.growthRate}%
                </td>
                <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; color: ${trendColor};">
                    ${trendIcon}
                </td>
            </tr>`;
        });
        
        chartHTML += '</tbody></table></div>';
        return chartHTML;
    }

    // 刷新排期图表
    function refreshScheduleChart() {
        loadScheduleDistributionData();
    }

    // 导出排期数据
    function exportScheduleData() {
        // 这里可以实现数据导出功能
        alert('数据导出功能开发中...');
    }

    // 显示排期时间详情
    function showScheduleDetails(scheduleStatus) {
        // 调用后端接口获取该排期状态下的项目详情
        fetch(`/DQEIndex/getScheduleDetails?scheduleStatus=${encodeURIComponent(scheduleStatus)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showScheduleDetailsModal(scheduleStatus, data.data);
                } else {
                    console.error('获取排期详情失败:', data.error);
                    alert('获取排期详情失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('API调用失败:', error);
                alert('获取排期详情失败，请稍后重试');
            });
    }

    // 显示排期详情模态框
    function showScheduleDetailsModal(scheduleStatus, projects) {
        // 创建模态框
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'scheduleDetailsModal';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1400px; width: 95%;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 28px;">📋</span>
                        ${scheduleStatus} - 项目详情 (${projects.length}个项目)
                    </h3>
                    <span class="close" onclick="closeScheduleDetailsModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
                </div>
                <div class="modal-body" style="padding: 30px; height: calc(100vh - 200px); overflow-y: auto;">
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button onclick="exportScheduleDetailsExcel('${scheduleStatus}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">📊 导出Excel</button>
                        <button onclick="refreshScheduleDetails('${scheduleStatus}')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">🔄 刷新数据</button>
                    </div>
                    <div id="scheduleDetailsContent">
                        ${createScheduleDetailsTable(projects)}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        lockPageScroll();
    }

    // 解析第一次排期时间
    function getFirstScheduleTime(changeRecord) {
        if (!changeRecord || changeRecord.trim() === '') {
            return '-';
        }
        
        try {
            const firstRecord = changeRecord.split('|')[0];
            if (firstRecord && firstRecord.trim() !== '') {
                const parts = firstRecord.trim().split('#');
                if (parts.length >= 4) {
                    // 取第四个"#"的值，也就是update_time字段
                    const updateTime = parts[3];
                    if (updateTime && updateTime !== 'null' && updateTime.trim() !== '') {
                        return updateTime;
                    }
                }
            }
        } catch (e) {
            // 解析失败，返回默认值
            console.error('解析changeRecord失败:', e, changeRecord);
        }
        
        return '-';
    }

    // 创建排期详情表格
    function createScheduleDetailsTable(projects) {
        if (!projects || projects.length === 0) {
            return '<div style="text-align: center; padding: 50px; color: #666;">暂无项目数据</div>';
        }

        let tableHTML = `
            <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品编号</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品名称</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品类别</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">样品型号</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">版本</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">项目负责人</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">当前进度</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">接单时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">第一次排期时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">排期开始时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">排期结束时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">实际开始时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333; border-right: 1px solid #dee2e6;">实际完成时间</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">备注</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        projects.forEach((project, index) => {
            const rowStyle = index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';
            
            // 调试信息
            if (project.changeRecord) {
                console.log('项目', project.sample_id, '的changeRecord:', project.changeRecord);
                console.log('解析结果:', getFirstScheduleTime(project.changeRecord));
            }
            
            tableHTML += `
                <tr style="${rowStyle} border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; font-weight: 500; color: #333;">${project.sample_id || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_name || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_category || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_model || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.version || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.sample_leader || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${formatDateTime(project.create_time) || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${getFirstScheduleTime(project.changeRecord)}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_start_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.schedule_end_date || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_start_time || '-'}</td>
                    <td style="padding: 12px; border-right: 1px solid #dee2e6; color: #333;">${project.actual_finish_time || '-'}</td>
                    <td style="padding: 12px; color: #333;">${project.remark || '-'}</td>
                </tr>
            `;
        });

        tableHTML += `
                    </tbody>
                </table>
            </div>
        `;

        return tableHTML;
    }

    // 关闭排期详情模态框
    function closeScheduleDetailsModal() {
        const modal = document.getElementById('scheduleDetailsModal');
        if (modal) {
            modal.remove();
            unlockPageScroll();
        }
    }

    // 刷新排期详情
    function refreshScheduleDetails(scheduleStatus) {
        showScheduleDetails(scheduleStatus);
    }

    // 导出排期详情Excel
    function exportScheduleDetailsExcel(scheduleStatus) {
        // 这里可以实现Excel导出功能
        alert('Excel导出功能开发中...');
    }

    // 更新看板数据
    function updateDashboard() {
        // 根据electric_info表的数据结构来判断项目状态
        const notStarted = projectData.filter(p =>
            !p.actual_start_time && p.schedule !== '已完成'
        ).length;

        const inProgress = projectData.filter(p =>
            p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
        ).length;

        const completed = projectData.filter(p =>
            p.actual_finish_time && !p.sampleRecognizeResult
        ).length;

        const confirmed = projectData.filter(p =>
            p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
        ).length;

        document.getElementById('totalCount').textContent = projectData.length;
        document.getElementById('notStartedCount').textContent = notStarted;
        document.getElementById('inProgressCount').textContent = inProgress;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('closedCount').textContent = confirmed;
    }

    // 更新项目表格
    function updateProjectTable() {
        const container = document.getElementById('projectTableContainer');

        if (filteredData.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">暂无数据</p>';
            return;
        }

        let tableHTML = `
                <table class="project-table">
                    <thead>
                        <tr>
                            <th>样品编号</th>
                            <th>产品名称</th>
                            <th>产品类别</th>
                            <th>大编码</th>
                            <th>物料编码</th>
                            <th>版本</th>
                            <th>项目负责人</th>
                            <th>当前进度</th>
                            <th>测试负责人</th>
                            <th>送样人</th>
                            <th>送样类别</th>
                            <th>送样数量</th>
                            <th>是否高频</th>
                            <th>提单时间</th>
                            <th>排期天数</th>
                            <th>排期开始</th>
                            <th>排期结束</th>
                            <th>实际开始时间</th>
                            <th>实际完成时间</th>
                             <th>DQE承认结果</th>
                             <th>研发承认结果</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        filteredData.forEach(project => {
            const isOverdue = project.schedule_end_date && project.schedule !== '已完成' &&
                new Date(project.schedule_end_date) < new Date();

            // 根据实际时间判断项目状态
            let statusText = '未开始';
            let statusColor = '#ffc107';

            if (project.actual_start_time && !project.actual_finish_time) {
                statusText = '进行中';
                statusColor = '#17a2b8';
            } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                statusText = '已完成未确认';
                statusColor = '#a72828';
            }else if (project.actual_finish_time && project.sampleRecognizeResult){
                statusText = '报告确认闭环'
                statusColor = '#28a745';
            }

            tableHTML += `
                    <tr style="${isOverdue ? 'background-color: #ffe6e6;' : ''}">
                        <td><strong>${project.sample_id || '-'}</strong></td>
                        <td>${project.sample_name || '-'}</td>
                        <td>${project.sample_category || '-'}</td>
                        <td>${project.sample_model || '-'}</td>
                        <td>${project.materialCode || '-'}</td>
                        <td>${project.version || '-'}</td>
                        <td>${project.sample_leader || '-'}</td>
                        <td>
                            <span style="color: ${statusColor}; font-weight: bold;">
                                ${statusText}
                            </span>
                        </td>
                        <td>${project.tester || '-'}</td>
                        <td>${project.sample_sender || '-'}</td>
                        <td>${project.sample_type || '-'}</td>
                        <td>${project.sample_quantity || '-'}</td>
                        <td>${project.high_frequency || '-'}</td>
                        <td>${formatDateTime(project.create_time) || '-'}</td>
                        <td>${project.scheduleDays || '-'}</td>
                        <td>${formatDate(project.schedule_start_date) || '-'}</td>
                        <td style="${isOverdue ? 'color: red; font-weight: bold;' : ''}">
                            ${formatDate(project.schedule_end_date) || '-'}
                        </td>
                        <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                        <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                         <td>${project.sampleRecognizeResult || '-'}</td>
                         <td>${project.rd_sampleRecognizeResult || '-'}</td>
                    </tr>
                `;
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    // 更新类别筛选器
    function updateCategoryFilter() {
        const categories = [...new Set(projectData.map(p => p.sample_category).filter(Boolean))];
        const filter = document.getElementById('categoryFilter');

        filter.innerHTML = '<option value="">所有类别</option>';
        categories.forEach(category => {
            filter.innerHTML += `<option value="${category}">${category}</option>`;
        });
    }

    // 应用筛选
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;

        filteredData = projectData.filter(project => {
            const matchesSearch = !searchTerm ||
                (project.sample_id && project.sample_id.toLowerCase().includes(searchTerm)) ||
                (project.sample_name && project.sample_name.toLowerCase().includes(searchTerm));

            const matchesCategory = !category || project.sample_category === category;

            // 根据实际时间判断项目状态进行筛选
            let projectStatus = '未开始';
            if (project.actual_start_time && !project.actual_finish_time) {
                projectStatus = '进行中';
            } else if (project.actual_finish_time) {
                if (project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '') {
                    projectStatus = '已确认';
                } else {
                    projectStatus = '已完成未确认';
                }
            }

            const matchesStatus = !status || projectStatus === status;

            return matchesSearch && matchesCategory && matchesStatus;
        });

        updateProjectTable();
    }

    // 重置筛选
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        filteredData = [...projectData];
        updateProjectTable();
    }

    // 应用时间筛选
    function applyTimeFilter() {
        const startDate = document.getElementById('createTimeStart').value;
        const endDate = document.getElementById('createTimeEnd').value;

        if (!startDate && !endDate) {
            // 如果没有选择日期，显示所有数据
            // 恢复原始数据
            projectData = [...originalProjectData];
            filteredData = [...originalProjectData];
        } else {
            // 筛选数据
            const filtered = originalProjectData.filter(project => {
                if (!project.create_time) return false;

                const createDate = new Date(project.create_time);
                let matchesStart = true;
                let matchesEnd = true;

                if (startDate) {
                    const start = new Date(startDate);
                    matchesStart = createDate >= start;
                }

                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999); // 结束日期设为当天的最后一秒
                    matchesEnd = createDate <= end;
                }

                return matchesStart && matchesEnd;
            });

            // 更新projectData为筛选后的数据
            projectData = [...filtered];
            filteredData = [...filtered];
        }

        // 更新看板和表格
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // 重置时间筛选
    function resetTimeFilter() {
        document.getElementById('createTimeStart').value = '';
        document.getElementById('createTimeEnd').value = '';
        // 恢复原始数据
        projectData = [...originalProjectData];
        filteredData = [...originalProjectData];
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // 显示项目详情
    function showProjectDetails(status) {
        let title = '';
        let projects = [];

        switch(status) {
            case 'total':
                title = '项目总数';
                projects = projectData;
                break;
            case 'not-started':
                title = '未开始项目详情';
                projects = projectData.filter(p => {
                    // 排除已排期但未到开始时间的项目
                    if (p.schedule_start_date) {
                        const now = new Date();
                        const scheduleStart = new Date(p.schedule_start_date);
                        // 如果已排期但还没到开始时间，则排除
                        if (scheduleStart > now) {
                            return false;
                        }
                    }
                    // 只显示真正未开始的项目（没有实际开始时间）
                    return !p.actual_start_time;
                });
                break;
            case 'in-progress':
                title = '进行中项目详情';
                projects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                );
                break;
            case 'completed':
                title = '已完成未确认项目详情';
                projects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case 'overdue':
                title = '已确认项目详情';
                projects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // 传递状态信息到模态框，用于后续的过滤器设置
        showProjectModal(title, projects, status);
    }

    // 锁定页面滚动
    function lockPageScroll() {
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
    }

    // 恢复页面滚动
    function unlockPageScroll() {
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
    }

    // 显示项目模态框
    function showProjectModal(title, projects, status) {
        document.getElementById('modalTitle').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${title}</span>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <button class="filter-btn" onclick="showModalCharts('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            查看图表
                        </button>
                        <button class="filter-btn" onclick="showModalDataList('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            查看数据列表
                        </button>
                        <button class="filter-btn" onclick="showDynamicChartModal('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            自定义图表
                        </button>
                        <button class="filter-btn" onclick="exportModalExcel('${title}')">
                            导出Excel
                        </button>
                    </div>
                </div>
            `;

        // 默认显示图表，传递状态信息
        showModalCharts(title, projects, status);

        // 锁定页面滚动
        lockPageScroll();

        document.getElementById('projectModal').style.display = 'block';
    }

    // 显示模态框图表
    function showModalCharts(title, projects, status) {
        let contentHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">数据统计概览</h3>
                    <p>共找到 <strong>${projects.length}</strong> 个项目</p>
                </div>
            `;

        // 检查是否有保存的自定义图表
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const chartKey = `${title}_${status}`;
        let savedChartsList = savedCharts[chartKey];

        // 确保savedChartsList是数组
        if (savedChartsList && !Array.isArray(savedChartsList)) {
            // 如果是旧格式的单个图表，转换为数组格式
            if (savedChartsList.fieldName) {
                savedChartsList = [savedChartsList];
                // 更新localStorage为新的数组格式
                savedCharts[chartKey] = savedChartsList;
                localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
            } else {
                savedChartsList = null;
            }
        }

        // 创建图表导航和显示区域
        contentHTML += `
            <div style="display: flex; gap: 20px; height: 600px;">
                <!-- 左侧导航栏 -->
                <div style="width: 250px; background: #f8f9fa; border-radius: 10px; padding: 20px; overflow-y: auto;">
                    <h4 style="color: #333; margin-bottom: 15px; font-size: 16px;">图表导航</h4>
                    <div id="chartNavList" style="display: flex; flex-direction: column; gap: 8px;">
                    </div>
                </div>
                
                <!-- 右侧图表显示区域 -->
                <div style="flex: 1; background: #fff; border-radius: 10px; padding: 20px; border: 1px solid #e9ecef;">
                    <div id="chartDisplayArea" style="height: 100%; display: flex; align-items: center; justify-content: center;">
                        <p style="color: #666; text-align: center;">请选择左侧图表进行查看</p>
                    </div>
                </div>
            </div>
        `;

        // 如果有保存的自定义图表，添加到导航中
        if (savedChartsList && savedChartsList.length > 0) {
            contentHTML += `
                <div style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="color: #333; margin: 0; font-size: 18px; font-weight: 600;">
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">📊 自定义图表管理</span>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-left: 10px; font-weight: 500;">${savedChartsList.length}个图表</span>
                        </h4>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                `;

            savedChartsList.forEach((savedChart, index) => {
                const chartTypeIcon = {
                    'bar': '📊',
                    'pie': '🥧', 
                    'line': '📈'
                }[savedChart.chartType] || '📊';
                
                const chartTypeColor = {
                    'bar': '#4CAF50',
                    'pie': '#FF9800',
                    'line': '#2196F3'
                }[savedChart.chartType] || '#4CAF50';

                contentHTML += `
                        <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); 
                                    padding: 20px; 
                                    border-radius: 16px; 
                                    border: 1px solid #e9ecef;
                                    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                                    transition: all 0.3s ease;
                                    position: relative;
                                    overflow: hidden;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">
                             
                             <!-- 装饰性背景 -->
                             <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: ${chartTypeColor}20; border-radius: 50%; opacity: 0.3;"></div>
                             
                             <!-- 图表类型图标 -->
                             <div style="position: absolute; top: 15px; right: 15px; font-size: 24px; opacity: 0.6;">${chartTypeIcon}</div>
                             
                             <!-- 图表标题和基本信息 -->
                             <div style="margin-bottom: 15px; padding-right: 50px;">
                                 <h6 style="color: #2c3e50; margin: 0 0 8px 0; font-size: 16px; font-weight: 600; line-height: 1.3;">
                                     ${savedChart.title}
                                 </h6>
                                 <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                                     <span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                         📋 ${savedChart.fieldLabel}
                                     </span>
                                     <span style="background: #f3e5f5; color: #7b1fa2; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                         ${chartTypeIcon} ${getChartTypeName(savedChart.chartType)}
                                     </span>
                                     <span style="background: #e8f5e8; color: #2e7d32; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                         🔢 前${savedChart.topN}个
                                     </span>
                                 </div>
                                 <div style="color: #6c757d; font-size: 11px; margin-top: 5px;">
                                     <span>🕒 ${savedChart.createTime || '刚刚创建'}</span>
                                 </div>
                             </div>
                             
                             <!-- 操作按钮 -->
                             <div style="display: flex; gap: 8px; margin-top: 15px;">
                                 <button onclick="showCustomChart('${chartKey}', ${savedChart.id})" 
                                         style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                                border: none; color: white; padding: 10px 16px; border-radius: 8px; 
                                                font-size: 13px; font-weight: 500; cursor: pointer; 
                                                transition: all 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);"
                                         onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                                     👁️ 查看图表
                                 </button>
                                 <button onclick="removeSavedChart('${chartKey}', ${savedChart.id})" 
                                         style="background: #dc3545; border: none; color: white; padding: 10px 12px; border-radius: 8px; 
                                                font-size: 13px; cursor: pointer; transition: all 0.2s;"
                                         onmouseover="this.style.background='#c82333'; this.style.transform='translateY(-1px)'"
                                         onmouseout="this.style.background='#dc3545'; this.style.transform='translateY(0)'"
                                         title="删除图表">
                                     🗑️
                                 </button>
                             </div>
                        </div>
                    `;
            });

            contentHTML += `</div></div>`;
        }

        if (projects.length > 0) {
            // 产品类别统计
            const categoryStats = {};
            projects.forEach(project => {
                const category = project.sample_category && project.sample_category.trim() !== '' ? project.sample_category : '未分类';
                categoryStats[category] = (categoryStats[category] || 0) + 1;
            });

            // 项目负责人统计
            const leaderStats = {};
            projects.forEach(project => {
                const leader = project.sample_leader && project.sample_leader.trim() !== '' ? project.sample_leader : '未指定';
                leaderStats[leader] = (leaderStats[leader] || 0) + 1;
            });

            // 测试负责人统计
            const testerStats = {};
            projects.forEach(project => {
                const tester = project.tester && project.tester.trim() !== '' ? project.tester : '未指定';
                testerStats[tester] = (testerStats[tester] || 0) + 1;
            });

            // DQE负责人统计
            const dqeLeaderStats = {};
            projects.forEach(project => {
                const dqeLeader = project.dqe_leader && project.dqe_leader.trim() !== '' ? project.dqe_leader : '未指定';
                dqeLeaderStats[dqeLeader] = (dqeLeaderStats[dqeLeader] || 0) + 1;
            });

            // 研发负责人统计
            const rdLeaderStats = {};
            projects.forEach(project => {
                const rdLeader = project.rd_leader && project.rd_leader.trim() !== '' ? project.rd_leader : '未指定';
                rdLeaderStats[rdLeader] = (rdLeaderStats[rdLeader] || 0) + 1;
            });

            // 送样人统计
            const sampleSenderStats = {};
            projects.forEach(project => {
                const sampleSender = project.sample_sender && project.sample_sender.trim() !== '' ? project.sample_sender : '未指定';
                sampleSenderStats[sampleSender] = (sampleSenderStats[sampleSender] || 0) + 1;
            });

            // 确认结果分布统计
            const confirmResultStats = {};
            projects.forEach(project => {
                // 检查研发承认结果
                if (project.rd_sampleRecognizeResult) {
                    const rdResult = project.rd_sampleRecognizeResult.trim();
                    if (rdResult !== '') {
                        confirmResultStats[`研发-${rdResult}`] = (confirmResultStats[`研发-${rdResult}`] || 0) + 1;
                    }
                }

                // 检查DQE承认结果
                if (project.sampleRecognizeResult) {
                    const dqeResult = project.sampleRecognizeResult.trim();
                    if (dqeResult !== '') {
                        confirmResultStats[`DQE-${dqeResult}`] = (confirmResultStats[`DQE-${dqeResult}`] || 0) + 1;
                    }
                }

                // 统计未确认的项目
                if ((!project.rd_sampleRecognizeResult || project.rd_sampleRecognizeResult.trim() === '') &&
                    (!project.sampleRecognizeResult || project.sampleRecognizeResult.trim() === '')) {
                    confirmResultStats['DQE-未确认'] = (confirmResultStats['DQE-未确认'] || 0) + 1;
                }
            });

            // 排期天数分布统计
            const scheduleDaysStats = {};
            projects.forEach(project => {
                const days = project.scheduleDays;
                if (days && !isNaN(days)) {
                    // 直接使用具体天数作为键
                    scheduleDaysStats[days] = (scheduleDaysStats[days] || 0) + 1;
                } else {
                    scheduleDaysStats['未设置'] = (scheduleDaysStats['未设置'] || 0) + 1;
                }
            });

            // 对天数进行排序，确保图表显示有序
            const sortedScheduleDays = Object.keys(scheduleDaysStats)
                .filter(key => key !== '未设置')
                .sort((a, b) => parseInt(a) - parseInt(b));

            // 重新构建有序的统计数据
            const orderedScheduleDaysStats = {};
            sortedScheduleDays.forEach(days => {
                orderedScheduleDaysStats[days + '天'] = scheduleDaysStats[days];
            });
            // 将"未设置"放在最后
            if (scheduleDaysStats['未设置']) {
                orderedScheduleDaysStats['未设置'] = scheduleDaysStats['未设置'];
            }

            // 未开始天数分布统计（只在未开始项目中显示）
            let notStartedDaysStats = {};
            if (status === 'not-started') {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // 设置为今天的开始时间

                projects.forEach(project => {
                    if (project.create_time) {
                        try {
                            const createDate = new Date(project.create_time);
                            createDate.setHours(0, 0, 0, 0); // 设置为创建日期的开始时间

                            // 计算天数差
                            const timeDiff = today.getTime() - createDate.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                            if (daysDiff >= 0) {
                                // 直接使用具体天数作为键
                                const daysKey = daysDiff === 0 ? '今天' : daysDiff === 1 ? '昨天' : `${daysDiff}天`;
                                notStartedDaysStats[daysKey] = (notStartedDaysStats[daysKey] || 0) + 1;
                            }
                        } catch (e) {
                            // 如果日期解析失败，归类为"日期无效"
                            notStartedDaysStats['日期无效'] = (notStartedDaysStats['日期无效'] || 0) + 1;
                        }
                    } else {
                        // 如果没有提单时间，归类为"未设置"
                        notStartedDaysStats['未设置'] = (notStartedDaysStats['未设置'] || 0) + 1;
                    }
                });

                // 对天数进行排序，确保图表显示有序
                const sortedDays = Object.keys(notStartedDaysStats)
                    .filter(key => key !== '今天' && key !== '昨天' && key !== '日期无效' && key !== '未设置')
                    .sort((a, b) => parseInt(a) - parseInt(b));

                // 重新构建有序的统计数据
                const orderedNotStartedDaysStats = {};

                // 先添加特殊值
                if (notStartedDaysStats['今天']) {
                    orderedNotStartedDaysStats['今天'] = notStartedDaysStats['今天'];
                }
                if (notStartedDaysStats['昨天']) {
                    orderedNotStartedDaysStats['昨天'] = notStartedDaysStats['昨天'];
                }

                // 再添加按天数排序的数据
                sortedDays.forEach(days => {
                    orderedNotStartedDaysStats[days] = notStartedDaysStats[days];
                });

                // 最后添加特殊值
                if (notStartedDaysStats['日期无效']) {
                    orderedNotStartedDaysStats['日期无效'] = notStartedDaysStats['日期无效'];
                }
                if (notStartedDaysStats['未设置']) {
                    orderedNotStartedDaysStats['未设置'] = notStartedDaysStats['未设置'];
                }

                // 更新变量引用
                notStartedDaysStats = orderedNotStartedDaysStats;
            }

            // 定义图表配置数组
            const chartConfigs = [
                {
                    id: 'categoryChart',
                    title: status === 'not-started' ? '产品类别分布' : status === 'in-progress' ? '产品类别分布' : status === 'completed' ? '产品类别分布' : '产品类别分布',
                    data: categoryStats,
                    icon: '📊'
                },
                {
                    id: 'leaderChart',
                    title: status === 'not-started' ? '项目负责人分布' : status === 'in-progress' ? '项目负责人分布' : status === 'completed' ? '项目负责人分布' : '项目负责人分布',
                    data: leaderStats,
                    icon: '👤'
                },
                {
                    id: 'testerChart',
                    title: status === 'not-started' ? '测试负责人分布' : status === 'in-progress' ? '测试负责人分布' : status === 'completed' ? '测试负责人分布' : '测试负责人分布',
                    data: testerStats,
                    icon: '🧪'
                },
                {
                    id: 'dqeLeaderChart',
                    title: status === 'not-started' ? 'DQE负责人分布' : status === 'in-progress' ? 'DQE负责人分布' : status === 'completed' ? 'DQE负责人分布' : 'DQE负责人分布',
                    data: dqeLeaderStats,
                    icon: '🔍'
                },
                {
                    id: 'rdLeaderChart',
                    title: status === 'not-started' ? '研发负责人分布' : status === 'in-progress' ? '研发负责人分布' : status === 'completed' ? '研发负责人分布' : '研发负责人分布',
                    data: rdLeaderStats,
                    icon: '💻'
                },
                {
                    id: 'sampleSenderChart',
                    title: status === 'not-started' ? '送样人分布' : status === 'in-progress' ? '送样人分布' : status === 'completed' ? '送样人分布' : '送样人分布',
                    data: sampleSenderStats,
                    icon: '📦'
                },
                {
                    id: 'scheduleChart',
                    title: status === 'not-started' ? '排期天数分布' : status === 'in-progress' ? '排期天数分布' : status === 'completed' ? '排期天数分布' : '排期天数分布',
                    data: orderedScheduleDaysStats,
                    icon: '📅'
                },
                {
                    id: 'confirmResultChart',
                    title: status === 'not-started' ? '确认结果分布' : status === 'in-progress' ? '确认结果分布' : status === 'completed' ? '确认结果分布' : '确认结果分布',
                    data: confirmResultStats,
                    icon: '✅'
                }
            ];

            // 如果是未开始项目，添加未开始天数分布图表
            if (status === 'not-started') {
                chartConfigs.push({
                    id: 'notStartedDaysChart',
                    title: '未开始天数分布',
                    data: notStartedDaysStats,
                    icon: '⏰'
                });
            }

            // 将图表配置存储到全局变量中，供后续使用
            window.currentChartConfigs = chartConfigs;
            window.currentProjects = projects;
            window.currentStatus = status;
            window.currentDisplayLimit = 10; // 默认显示前10组数据

        } else {
            contentHTML += '<p style="text-align: center; color: #666;">暂无数据</p>';
        }

        document.getElementById('modalContent').innerHTML = contentHTML;

        // 初始化导航栏和显示第一个图表
        if (projects.length > 0) {
            initializeChartNavigation();
            // 默认显示第一个图表
            if (window.currentChartConfigs && window.currentChartConfigs.length > 0) {
                showSelectedChart(0);
            }
        }
    }

    // 初始化图表导航栏
    function initializeChartNavigation() {
        const navList = document.getElementById('chartNavList');
        if (!navList || !window.currentChartConfigs) return;

        navList.innerHTML = '';
        
        window.currentChartConfigs.forEach((config, index) => {
            const navItem = document.createElement('div');
            navItem.className = 'chart-nav-item';
            navItem.style.cssText = `
                padding: 12px 16px;
                background: #fff;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            navItem.innerHTML = `
                <span style="font-size: 18px;">${config.icon}</span>
                <span style="font-size: 14px; color: #333;">${config.title}</span>
            `;
            navItem.onclick = () => showSelectedChart(index);
            navList.appendChild(navItem);
        });
    }

    // 显示选中的图表
    function showSelectedChart(index) {
        if (!window.currentChartConfigs || !window.currentChartConfigs[index]) return;

        const config = window.currentChartConfigs[index];
        const displayArea = document.getElementById('chartDisplayArea');
        
        if (!displayArea) return;

        // 更新导航栏选中状态
        const navItems = document.querySelectorAll('.chart-nav-item');
        navItems.forEach((item, i) => {
            if (i === index) {
                item.style.background = '#007bff';
                item.style.color = '#fff';
                item.style.borderColor = '#007bff';
            } else {
                item.style.background = '#fff';
                item.style.color = '#333';
                item.style.borderColor = '#e9ecef';
            }
        });

        // 应用数据限制
        const limitedData = applyDataLimit(config.data, window.currentDisplayLimit || 10);
        
        // 更新数据组数显示
        const dataCountElement = document.getElementById('currentDataCount');
        if (dataCountElement) {
            const totalCount = Object.keys(config.data).length;
            const displayCount = Object.keys(limitedData).length;
            if (window.currentDisplayLimit === 0) {
                dataCountElement.textContent = `全部(${totalCount})`;
            } else if (displayCount < totalCount) {
                dataCountElement.textContent = `${displayCount}/${totalCount}...`;
            } else {
                dataCountElement.textContent = `${displayCount}/${totalCount}`;
            }
        }

        // 生成图表HTML
        const chartHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1;">${config.title}</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <!-- 图表控制按钮 -->
                        <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <button class="zoom-btn" onclick="zoomChart('${config.id}', -1)" title="缩小" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">−</button>
                            <button class="zoom-btn" onclick="zoomChart('${config.id}', 1)" title="放大" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                            <button class="zoom-btn" onclick="toggleChartType('${config.id}', '${JSON.stringify(limitedData).replace(/"/g, '&quot;')}')" title="切换图表类型" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">📊</button>
                        </div>
                        <!-- 数据组数控制 -->
                        <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-size: 12px; color: #666; font-weight: 500;">数据组数:</span>
                            <select id="chartDisplayLimit" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s;" onchange="updateChartDisplayLimit()" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#ddd'">
                                <option value="10">前10组</option>
                                <option value="20">前20组</option>
                                <option value="50">前50组</option>
                                <option value="0">全部数据</option>
                            </select>
                            <span id="currentDataCount" style="font-size: 12px; color: #007bff; font-weight: 600; min-width: 40px; text-align: center;">10</span>
                            <button onclick="toggleDisplayMode()" style="background: #007bff; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;" title="快速切换显示模式" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                🔄
                            </button>
                        </div>
                    </div>
                </div>
                <div id="${config.id}" style="height: 450px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                    ${createBarChart(limitedData, config.id)}
                </div>
            </div>
        `;

        displayArea.innerHTML = chartHTML;

        // 绑定图表事件
        setTimeout(() => {
            bindChartClickEvents(config.id);
            bindTooltipEvents(config.id);
            updateZoomButtons(config.id, 450);
        }, 100);
    }

    // 显示自定义图表
    function showCustomChart(chartKey, chartId) {
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const savedChartsList = savedCharts[chartKey];
        const savedChart = savedChartsList.find(chart => chart.id === chartId);
        
        if (!savedChart || !window.currentProjects) return;

        const displayArea = document.getElementById('chartDisplayArea');
        if (!displayArea) return;

        // 获取图表数据
        const chartData = getChartDataFromSavedChart(savedChart, window.currentProjects);
        
        // 应用数据限制
        const limitedData = applyDataLimit(chartData, window.currentDisplayLimit || 10);

        const chartHTML = `
            <div style="width: 100%; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1;">${savedChart.title}</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <!-- 图表控制按钮 -->
                        <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <button class="zoom-btn" onclick="zoomChart('customChart_${chartId}', -1)" title="缩小" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">−</button>
                            <button class="zoom-btn" onclick="zoomChart('customChart_${chartId}', 1)" title="放大" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                            <button class="zoom-btn" onclick="toggleChartType('customChart_${chartId}', '${JSON.stringify(limitedData).replace(/"/g, '&quot;')}')" title="切换图表类型" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">📊</button>
                        </div>
                        <!-- 数据组数控制 -->
                        <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-size: 12px; color: #666; font-weight: 500;">数据组数:</span>
                            <select id="chartDisplayLimit" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s;" onchange="updateChartDisplayLimit()" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#ddd'">
                                <option value="10" ${window.currentDisplayLimit === 10 ? 'selected' : ''}>前10组</option>
                                <option value="20" ${window.currentDisplayLimit === 20 ? 'selected' : ''}>前20组</option>
                                <option value="50" ${window.currentDisplayLimit === 50 ? 'selected' : ''}>前50组</option>
                                <option value="0" ${window.currentDisplayLimit === 0 ? 'selected' : ''}>全部数据</option>
                            </select>
                            <span id="currentDataCount" style="font-size: 12px; color: #007bff; font-weight: 600; min-width: 40px; text-align: center;">${window.currentDisplayLimit === 0 ? `全部(${Object.keys(chartData).length})` : (Object.keys(limitedData).length < Object.keys(chartData).length ? `${Object.keys(limitedData).length}/${Object.keys(chartData).length}...` : `${Object.keys(limitedData).length}/${Object.keys(chartData).length}`)}</span>
                            <button onclick="toggleDisplayMode()" style="background: #007bff; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;" title="快速切换显示模式" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                🔄
                            </button>
                        </div>
                    </div>
                </div>
                <div id="customChart_${chartId}" style="height: 450px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                    ${savedChart.chartType === 'pie' ? createPieChart(limitedData, `customChart_${chartId}`) : createBarChart(limitedData, `customChart_${chartId}`)}
                </div>
            </div>
        `;

        displayArea.innerHTML = chartHTML;

        // 绑定图表事件
        setTimeout(() => {
            bindChartClickEvents(`customChart_${chartId}`);
            bindTooltipEvents(`customChart_${chartId}`);
            updateZoomButtons(`customChart_${chartId}`, 450);
        }, 100);
    }

    // 从保存的图表配置中获取数据
    function getChartDataFromSavedChart(savedChart, projects) {
        if (!savedChart || !projects) return {};
        
        // 统计数据
        const stats = {};
        projects.forEach(project => {
            let value = project[savedChart.fieldName];

            // 处理不同类型的值（与generateDynamicChart中的逻辑一致）
            if (value === null || value === undefined || value === '') {
                value = '未设置';
            } else if (savedChart.fieldName === 'scheduleDays') {
                value = isNaN(value) ? '未设置' : value + '天';
            } else if (savedChart.fieldName === 'testDuration') {
                value = isNaN(value) ? '未设置' : value + '小时';
            } else if (savedChart.fieldName === 'sample_frequency') {
                value = isNaN(value) ? '未设置' : value + '次';
            } else if (savedChart.fieldName === 'isUsed') {
                value = value === 1 ? '已用' : value === 0 ? '未用' : '未设置';
            } else if (savedChart.fieldName === 'isCancel') {
                value = value === 1 ? '已作废' : value === 0 ? '未作废' : '未设置';
            } else if (savedChart.fieldName === 'high_frequency') {
                value = value === '1' || value === 1 ? '是' : value === '0' || value === 0 ? '否' : value || '未设置';
            } else if (savedChart.fieldName.includes('date') || savedChart.fieldName.includes('time') || savedChart.fieldName === 'reportReviewTime') {
                if (value && value !== '未设置') {
                    try {
                        const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                            value = date.toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        value = '无效日期';
                    }
                }
            } else if (savedChart.fieldName === 'priority') {
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = '未设置';
                }
            } else if (savedChart.fieldName === 'schedule') {
                if (value !== null && value !== undefined && value !== '') {
                    const progressMap = {
                        '0': '未开始',
                        '1': '进行中',
                        '2': '已完成未确认',
                        '3': '报告确认闭环'
                    };
                    value = progressMap[value.toString()] || `进度${value}`;
                } else {
                    value = '未设置';
                }
            } else if (savedChart.fieldName === 'sample_type') {
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = '未设置';
                }
            }

            stats[value] = (stats[value] || 0) + 1;
        });

        // 排序并取前N个
        let sortedStats;
        
        // 检查是否为时间字段，如果是则按时间顺序排序
        if (savedChart.fieldName.includes('date') || savedChart.fieldName.includes('time') || savedChart.fieldName === 'reportReviewTime') {
            // 对时间字段按时间顺序排序（从早到晚）
            sortedStats = Object.entries(stats)
                .filter(([key]) => key !== '未设置' && key !== '无效日期') // 先过滤掉特殊值
                .sort((a, b) => {
                    // 尝试解析日期进行比较
                    try {
                        const dateA = new Date(a[0]);
                        const dateB = new Date(b[0]);
                        if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                            return dateA - dateB; // 按时间从早到晚排序
                        }
                        return a[0].localeCompare(b[0]); // 如果解析失败，按字符串排序
                    } catch (e) {
                        return a[0].localeCompare(b[0]);
                    }
                })
                .slice(0, savedChart.topN);
            
            // 如果有特殊值，添加到末尾
            if (stats['未设置']) {
                sortedStats.push(['未设置', stats['未设置']]);
            }
            if (stats['无效日期']) {
                sortedStats.push(['无效日期', stats['无效日期']]);
            }
        } else {
            // 非时间字段按值从高到低排序
            sortedStats = Object.entries(stats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, savedChart.topN);
        }

        // 重新构建统计数据
        const finalStats = {};
        sortedStats.forEach(([key, value]) => {
            finalStats[key] = value;
        });

        return finalStats;
    }

    // 显示模态框数据列表
    function showModalDataList(title, projects, status, preserveValues = false) {
        // 保存当前过滤器的值
        let currentFilters = {};
        if (preserveValues) {
            const categoryFilter = document.getElementById('modalCategoryFilter');
            const testerFilter = document.getElementById('modalTesterFilter');
            const leaderFilter = document.getElementById('modalLeaderFilter');
            const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
            const startDateInput = document.getElementById('modalStartDate');
            const endDateInput = document.getElementById('modalEndDate');

            if (categoryFilter) currentFilters.category = categoryFilter.value;
            if (testerFilter) currentFilters.tester = testerFilter.value;
            if (leaderFilter) currentFilters.leader = leaderFilter.value;
            if (scheduleDaysFilter) currentFilters.scheduleDays = scheduleDaysFilter.value;
            if (startDateInput) currentFilters.startDate = startDateInput.value;
            if (endDateInput) currentFilters.endDate = endDateInput.value;
        }

        let contentHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">详细数据列表</h3>
                    <p>共找到 <strong>${projects.length}</strong> 个项目</p>
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">类别:</label>
                            <select class="filter-input" id="modalCategoryFilter">
                                <option value="">所有类别</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">测试负责人:</label>
                            <select class="filter-input" id="modalTesterFilter">
                                <option value="">所有测试负责人</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">项目负责人:</label>
                            <select class="filter-input" id="modalLeaderFilter">
                                <option value="">所有项目负责人</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">DQE负责人:</label>
                            <select class="filter-input" id="modalDqeLeaderFilter">
                                <option value="">所有DQE负责人</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">研发负责人:</label>
                            <select class="filter-input" id="modalRdLeaderFilter">
                                <option value="">所有研发负责人</option>
                            </select>
                        </div>
                         <div style="display: flex; gap: 10px; align-items: center;">
                             <label style="font-size: 14px; color: #333;">送样人:</label>
                             <select class="filter-input" id="modalSampleSenderFilter">
                                 <option value="">所有送样人</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">排期天数:</label>
                            <select class="filter-input" id="modalScheduleDaysFilter">
                                <option value="">所有排期天数</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">提单时间:</label>
                            <input type="date" class="filter-input" id="modalStartDate" placeholder="开始日期">
                            <span style="color: #666;">至</span>
                            <input type="date" class="filter-input" id="modalEndDate" placeholder="结束日期">
                        </div>
                        <button class="filter-btn" onclick="applyModalFilters()">筛选</button>
                        <button class="filter-btn" onclick="resetModalFilters()">重置</button>
                    </div>
                </div>
            `;

        if (projects.length > 0) {
            contentHTML += `
                    <table class="project-table">
                        <thead>
                            <tr>
                                <th>样品编号</th>
                                <th>产品名称</th>
                                <th>产品类别</th>
                                <th>大编码</th>
                                <th>物料编码</th>
                                <th>版本</th>
                                <th>项目负责人</th>
                                <th>当前进度</th>
                                <th>测试负责人</th>
                                <th>DQE负责人</th>
                                <th>研发负责人</th>
                                <th>送样人</th>
                                <th>送样类别</th>
                                <th>送样数量</th>
                                <th>是否高频</th>
                                <th>提单时间</th>
                                <th>排期天数</th>
                                <th>排期开始</th>
                                <th>排期结束</th>
                                <th>实际开始时间</th>
                                <th>实际完成时间</th>
                                <th>DQE承认结果</th>
                                <th>研发承认结果</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

            projects.forEach(project => {
                const isOverdue = project.schedule_end_date && project.schedule !== '已完成' &&
                    new Date(project.schedule_end_date) < new Date();

                // 根据实际时间判断项目状态
                let statusText = '未开始';
                let statusColor = '#ffc107';

                if (project.actual_start_time && !project.actual_finish_time) {
                    statusText = '进行中';
                    statusColor = '#17a2b8';
                } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                    statusText = '已完成未确认';
                    statusColor = '#a72828';
                } else if (project.actual_finish_time && project.sampleRecognizeResult) {
                    statusText = '报告确认闭环';
                    statusColor = '#28a745';
                }

                contentHTML += `
                        <tr style="${(isOverdue && !project.sampleRecognizeResult) ? 'background-color: #ffe6e6;' : ''}">
                            <td><strong>${project.sample_id || '-'}</strong></td>
                            <td>${project.sample_name || '-'}</td>
                            <td>${project.sample_category || '-'}</td>
                            <td>${project.sample_model || '-'}</td>
                            <td>${project.materialCode || '-'}</td>
                            <td>${project.version || '-'}</td>
                            <td>${project.sample_leader || '-'}</td>
                            <td>
                                <span style="color: ${statusColor}; font-weight: bold;">
                                    ${statusText}
                                </span>
                            </td>
                            <td>${project.tester || '-'}</td>
                            <td>${project.dqe_leader || '-'}</td>
                            <td>${project.rd_leader || '-'}</td>
                            <td>${project.sample_sender || '-'}</td>
                            <td>${project.sample_type || '-'}</td>
                            <td>${project.sample_quantity || '-'}</td>
                            <td>${project.high_frequency || '-'}</td>
                            <td>${formatDateTime(project.create_time) || '-'}</td>
                            <td>${project.scheduleDays || '-'}</td>
                            <td>${formatDate(project.schedule_start_date) || '-'}</td>
                            <td style="${(isOverdue && !project.sampleRecognizeResult) ? 'color: red; font-weight: bold;' : ''}">
                                ${formatDate(project.schedule_end_date) || '-'}
                            </td>
                            <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                            <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                            <td>${project.sampleRecognizeResult || '-'}</td>
                            <td>${project.sampleRecognizeResult || '-'}</td>
                            <td>${project.rd_sampleRecognizeResult || '-'}</td>
                        </tr>
                    `;
            });

            contentHTML += '</tbody></table>';
        }

        document.getElementById('modalContent').innerHTML = contentHTML;

        // 填充过滤器选项
        populateModalFilters(projects);

        // 恢复过滤器的值
        if (preserveValues && Object.keys(currentFilters).length > 0) {
            setTimeout(() => {
                const categoryFilter = document.getElementById('modalCategoryFilter');
                const testerFilter = document.getElementById('modalTesterFilter');
                const leaderFilter = document.getElementById('modalLeaderFilter');
                const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
                const startDateInput = document.getElementById('modalStartDate');
                const endDateInput = document.getElementById('modalEndDate');

                if (categoryFilter && currentFilters.category) categoryFilter.value = currentFilters.category;
                if (testerFilter && currentFilters.tester) testerFilter.value = currentFilters.tester;
                if (leaderFilter && currentFilters.leader) leaderFilter.value = currentFilters.leader;
                if (scheduleDaysFilter && currentFilters.scheduleDays) scheduleDaysFilter.value = currentFilters.scheduleDays;
                if (startDateInput && currentFilters.startDate) startDateInput.value = currentFilters.startDate;
                if (endDateInput && currentFilters.endDate) endDateInput.value = currentFilters.endDate;
            }, 100);
        }
    }

    // 填充模态框过滤器选项
    function populateModalFilters(projects) {
        // 填充类别过滤器
        const categories = [...new Set(projects.map(p => p.sample_category).filter(cat => cat && cat.trim() !== ''))];
        const categoryFilter = document.getElementById('modalCategoryFilter');
        if (categoryFilter) {
            categoryFilter.innerHTML = '<option value="">所有类别</option>';
            categories.forEach(category => {
                categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
            });
            // 如果有空值的数据，添加"未分类"选项
            if (projects.some(p => !p.sample_category || p.sample_category.trim() === '')) {
                categoryFilter.innerHTML += '<option value="">未分类</option>';
            }
        }

        // 填充测试负责人过滤器
        const testers = [...new Set(projects.map(p => p.tester).filter(tester => tester && tester.trim() !== ''))];
        const testerFilter = document.getElementById('modalTesterFilter');
        if (testerFilter) {
            testerFilter.innerHTML = '<option value="">所有测试负责人</option>';
            testers.forEach(tester => {
                testerFilter.innerHTML += `<option value="${tester}">${tester}</option>`;
            });
            // 如果有空值的数据，添加"未指定"选项
            if (projects.some(p => !p.tester || p.tester.trim() === '')) {
                testerFilter.innerHTML += '<option value="">未指定</option>';
            }
        }

        // 填充项目负责人过滤器
        const leaders = [...new Set(projects.map(p => p.sample_leader).filter(leader => leader && leader.trim() !== ''))];
        const leaderFilter = document.getElementById('modalLeaderFilter');
        if (leaderFilter) {
            leaderFilter.innerHTML = '<option value="">所有项目负责人</option>';
            leaders.forEach(leader => {
                leaderFilter.innerHTML += `<option value="${leader}">${leader}</option>`;
            });
            // 如果有空值的数据，添加"未指定"选项
            if (projects.some(p => !p.sample_leader || p.sample_leader.trim() === '')) {
                leaderFilter.innerHTML += '<option value="">未指定</option>';
            }
        }

        // 填充DQE负责人过滤器
        const dqeLeaders = [...new Set(projects.map(p => p.dqe_leader).filter(dqeLeader => dqeLeader && dqeLeader.trim() !== ''))];
        const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
        if (dqeLeaderFilter) {
            dqeLeaderFilter.innerHTML = '<option value="">所有DQE负责人</option>';
            dqeLeaders.forEach(dqeLeader => {
                dqeLeaderFilter.innerHTML += `<option value="${dqeLeader}">${dqeLeader}</option>`;
            });
            // 如果有空值的数据，添加"未指定"选项
            if (projects.some(p => !p.dqe_leader || p.dqe_leader.trim() === '')) {
                dqeLeaderFilter.innerHTML += '<option value="">未指定</option>';
            }
        }

        // 填充研发负责人过滤器
        const rdLeaders = [...new Set(projects.map(p => p.rd_leader).filter(rdLeader => rdLeader && rdLeader.trim() !== ''))];
        const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
        if (rdLeaderFilter) {
            rdLeaderFilter.innerHTML = '<option value="">所有研发负责人</option>';
            rdLeaders.forEach(rdLeader => {
                rdLeaderFilter.innerHTML += `<option value="${rdLeader}">${rdLeader}</option>`;
            });
            // 如果有空值的数据，添加"未指定"选项
            if (projects.some(p => !p.rd_leader || p.rd_leader.trim() === '')) {
                rdLeaderFilter.innerHTML += '<option value="">未指定</option>';
            }
        }

        // 填充送样人过滤器
        const sampleSenders = [...new Set(projects.map(p => p.sample_sender).filter(sender => sender && sender.trim() !== ''))];
        const sampleSenderFilter = document.getElementById('modalSampleSenderFilter');
        if (sampleSenderFilter) {
            sampleSenderFilter.innerHTML = '<option value="">所有送样人</option>';
            sampleSenders.forEach(sender => {
                sampleSenderFilter.innerHTML += `<option value="${sender}">${sender}</option>`;
            });
            // 如果有空值的数据，添加"未指定"选项
            if (projects.some(p => !p.sample_sender || p.sample_sender.trim() === '')) {
                sampleSenderFilter.innerHTML += '<option value="">未指定</option>';
            }
        }

        // 填充排期天数过滤器
        const scheduleDays = [...new Set(projects.map(p => p.scheduleDays).filter(days => days && !isNaN(days)))];
        const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
        if (scheduleDaysFilter) {
            scheduleDaysFilter.innerHTML = '<option value="">所有排期天数</option>';
            scheduleDays.sort((a, b) => parseInt(a) - parseInt(b));
            scheduleDays.forEach(days => {
                scheduleDaysFilter.innerHTML += `<option value="${days}">${days}天</option>`;
            });
            // 添加"未设置"选项
            if (projects.some(p => !p.scheduleDays || isNaN(p.scheduleDays))) {
                scheduleDaysFilter.innerHTML += '<option value="未设置">未设置</option>';
            }
        }
    }

    // 创建饼图
    function createPieChart(data, containerId) {
        const labels = Object.keys(data);
        const values = Object.values(data);
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

        if (labels.length === 0) return '<p style="text-align: center; color: #666;">暂无数据</p>';

        const total = values.reduce((a, b) => a + b, 0);
        if (total === 0) return '<p style="text-align: center; color: #666;">暂无数据</p>';

        // 创建SVG饼图
        const radius = 100;
        const centerX = 125;
        const centerY = 125;

        let chartHTML = `
                    <div style="position: relative; width: 250px; height: 250px; margin: 0 auto;">
                        <svg width="250" height="250" viewBox="0 0 250 250">
                `;

        let currentAngle = 0;
        labels.forEach((label, index) => {
            const value = values[index];
            const percentage = (value / total) * 100;
            const angle = (value / total) * 360;

            if (angle > 0) {
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;

                // 计算弧线路径
                const startX = centerX + radius * Math.cos(startAngle * Math.PI / 180);
                const startY = centerY + radius * Math.sin(startAngle * Math.PI / 180);
                const endX = centerX + radius * Math.cos(endAngle * Math.PI / 180);
                const endY = centerY + radius * Math.sin(endAngle * Math.PI / 180);

                // 判断是否需要绘制大弧线
                const largeArcFlag = angle > 180 ? 1 : 0;

                const pathData = `M ${centerX} ${centerY} L ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;

                // 为每个扇形添加鼠标事件和tooltip
                const segmentId = `segment_${containerId}_${index}`;

                // 检查是否为保存的图表，如果是则添加点击事件
                const isSavedChart = containerId.startsWith('savedChart_');
                const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

                chartHTML += `
                        <path id="${segmentId}" d="${pathData}" fill="${colors[index % colors.length]}" stroke="white" stroke-width="2"
                              style="cursor: pointer;"
                              data-label="${label}"
                              data-value="${value}"
                              onmouseover="showSegmentTooltip(event, '${label}', ${value}, ${percentage.toFixed(1)})"
                              onmouseout="hideSegmentTooltip()"
                              ${clickEvent}/>
                    `;

                // 只有当扇形足够大时才显示标签（角度大于15度）
                if (angle > 15) {
                    // 在扇形中心位置添加标签
                    const midAngle = startAngle + angle / 2;
                    const labelRadius = radius * 0.5; // 标签位置在扇形中心更内，避免被边缘遮挡
                    const labelX = centerX + labelRadius * Math.cos(midAngle * Math.PI / 180);
                    const labelY = centerY + labelRadius * Math.sin(midAngle * Math.PI / 180);

                    // 计算文本锚点，确保文本在扇形中心
                    let textAnchor = 'middle';
                    let dominantBaseline = 'middle';

                    // 根据角度调整文本位置，避免重叠
                    if (midAngle > 45 && midAngle < 135) {
                        dominantBaseline = 'hanging'; // 上半部分
                    } else if (midAngle > 225 && midAngle < 315) {
                        dominantBaseline = 'auto'; // 下半部分
                    }

                    if (midAngle > 90 && midAngle < 270) {
                        textAnchor = 'end'; // 左半部分
                    } else {
                        textAnchor = 'start'; // 右半部分
                    }

                    // 添加标签文本，这里是饼状图上的字体
                    chartHTML += `
                        <text x="${labelX}" y="${labelY}"
                              text-anchor="${textAnchor}"
                              dominant-baseline="${dominantBaseline}"
                              fill="white"
                              font-size="12"
                              font-weight="bold"
                              stroke="gray"
                              style="pointer-events: none; font-family: 'Microsoft YaHei', Arial, sans-serif;">
                            ${label}
                        </text>
                    `;

                    // 添加数值
                    const valueRadius = radius * 0.3; // 数值位置在扇形中心更内，避免被边缘遮挡
                    const valueX = centerX + valueRadius * Math.cos(midAngle * Math.PI / 180);
                    const valueY = centerY + valueRadius * Math.sin(midAngle * Math.PI / 180);

                    chartHTML += `
                        <text x="${valueX}" y="${valueY}"
                              text-anchor="middle"
                              dominant-baseline="middle"
                              fill="white"
                              font-size="12"
                              font-weight="bold"
                              stroke="black"
                              stroke-width="1"
                              style="pointer-events: none; font-family: 'Microsoft YaHei', Arial, sans-serif;">
                            ${value}
                        </text>
                    `;
                }

                currentAngle = endAngle;
            }
        });

        chartHTML += '</svg>';

        // 添加tooltip容器
        chartHTML += `
                <div id="tooltip_${containerId}" style="
                    position: fixed;
                    display: none;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    pointer-events: none;
                    z-index: 1000;
                    white-space: nowrap;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                "></div>
            `;

        chartHTML += '</div>';
        
        // 检查是否需要显示省略号
        const originalData = window.currentChartConfigs ? 
            window.currentChartConfigs.find(c => c.id === containerId)?.data : null;
        const hasMoreData = originalData && Object.keys(originalData).length > labels.length;
        
        if (hasMoreData) {
            chartHTML += `
                <div style="margin-top: 15px; text-align: center;">
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 16px; border-radius: 20px; border: 1px solid #e9ecef; color: #6c757d; font-size: 12px;">
                        <span>⋯</span>
                        <span>还有 ${Object.keys(originalData).length - labels.length} 组数据未显示</span>
                        <span>⋯</span>
                    </div>
                </div>
            `;
        }

        return chartHTML;
    }

    // 创建柱状图
    function createBarChart(data, containerId) {
        const labels = Object.keys(data);
        const values = Object.values(data);
        const maxValue = Math.max(...values);
        const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

        if (labels.length === 0) return '<p style="text-align: center; color: #666;">暂无数据</p>';

        // 创建标签和值的配对数组，并按值从高到低排序
        const sortedData = labels.map((label, index) => ({
            label: label,
            value: values[index],
            color: colors[index % colors.length]
        })).sort((a, b) => b.value - a.value);

        // 根据柱子数量调整布局
        const isManyBars = labels.length > 8;
        const barWidth = isManyBars ? 35 : 50;
        //  下边这个是修改柱状图标签之间的间距的
        const barSpacing = isManyBars ? 15 : 25;

        // 计算总宽度，确保柱子能够居中显示
        const totalWidth = sortedData.length * (barWidth + barSpacing) - barSpacing;

        let chartHTML = `<div style="display: flex; flex-direction: column; align-items: center; height: 280px; padding: 20px; overflow-x: auto;">
                <div style="display: flex; align-items: end; justify-content: center; gap: ${barSpacing}px; width: ${totalWidth}px;">`;

        sortedData.forEach((item, index) => {
            const height = maxValue > 0 ? (item.value / maxValue) * 180 : 0;

            // 检查是否为保存的图表，如果是则添加点击事件
            const isSavedChart = containerId.startsWith('savedChart_');
            const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

            chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center; width: ${barWidth}px;">
                        <div style="width: ${barWidth}px; height: ${height}px; background: ${item.color}; border-radius: 6px 6px 0 0; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: ${isManyBars ? '14px' : '16px'}; cursor: pointer; transition: all 0.2s ease;"
                             data-label="${item.label}"
                             data-value="${item.value}"
                             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
                             ${clickEvent}>
                            ${item.value}
                        </div>
                        <div style="font-size: ${isManyBars ? '12px' : '14px'}; color: #666; max-width: ${barWidth + 10}px; word-wrap: break-word; text-align: center; height: 40px; display: flex; align-items: center; justify-content: center; line-height: 1.2;">
                            ${item.label}
                        </div>
                    </div>
                `;
        });

        chartHTML += '</div>';
        
        // 检查是否需要显示省略号
        const originalData = window.currentChartConfigs ? 
            window.currentChartConfigs.find(c => c.id === containerId)?.data : null;
        const hasMoreData = originalData && Object.keys(originalData).length > sortedData.length;
        
        if (hasMoreData) {
            chartHTML += `
                <div style="margin-top: 15px; text-align: center;">
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 16px; border-radius: 20px; border: 1px solid #e9ecef; color: #6c757d; font-size: 12px;">
                        <span>⋯</span>
                        <span>还有 ${Object.keys(originalData).length - sortedData.length} 组数据未显示</span>
                        <span>⋯</span>
                    </div>
                </div>
            `;
        }
        
        chartHTML += '</div>';
        return chartHTML;
    }

    // 创建折线图
    function createLineChart(data, containerId) {
        const labels = Object.keys(data);
        const values = Object.values(data);
        const maxValue = Math.max(...values);
        const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

        if (labels.length === 0) return '<p style="text-align: center; color: #666;">暂无数据</p>';

        // 创建标签和值的配对数组，并按值从高到低排序
        const sortedData = labels.map((label, index) => ({
            label: label,
            value: values[index],
            color: colors[index % colors.length]
        })).sort((a, b) => b.value - a.value);

        // 折线图参数
        const chartWidth = 400;
        const chartHeight = 250;
        const padding = 40;
        const plotWidth = chartWidth - 2 * padding;
        const plotHeight = chartHeight - 2 * padding;

        // 检查是否为保存的图表，如果是则添加点击事件
        const isSavedChart = containerId.startsWith('savedChart_');
        const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

        let chartHTML = `
            <div style="position: relative; width: ${chartWidth}px; height: ${chartHeight}px; margin: 0 auto;">
                <svg width="${chartWidth}" height="${chartHeight}" viewBox="0 0 ${chartWidth} ${chartHeight}">
                    <!-- 背景网格线 -->
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" opacity="0.3"/>
                    
                    <!-- Y轴标签 -->
                    <g font-family="Arial, sans-serif" font-size="12" fill="#666">
                        ${Array.from({length: 6}, (_, i) => {
                            const value = (maxValue / 5) * (5 - i);
                            const y = padding + (plotHeight / 5) * i;
                            return `<text x="${padding - 10}" y="${y + 4}" text-anchor="end">${Math.round(value)}</text>`;
                        }).join('')}
                    </g>
                    
                    <!-- X轴标签 -->
                    <g font-family="Arial, sans-serif" font-size="12" fill="#666">
                        ${sortedData.map((item, index) => {
                            const x = padding + (plotWidth / (sortedData.length - 1)) * index;
                            const label = item.label.length > 8 ? item.label.substring(0, 8) + '...' : item.label;
                            return `<text x="${x}" y="${chartHeight - padding + 20}" text-anchor="middle">${label}</text>`;
                        }).join('')}
                    </g>
                    
                    <!-- 坐标轴 -->
                    <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${chartHeight - padding}" stroke="#333" stroke-width="2"/>
                    <line x1="${padding}" y1="${chartHeight - padding}" x2="${chartWidth - padding}" y2="${chartHeight - padding}" stroke="#333" stroke-width="2"/>
                    
                    <!-- 折线路径 -->
                    <path d="${sortedData.map((item, index) => {
                        const x = padding + (plotWidth / (sortedData.length - 1)) * index;
                        const y = chartHeight - padding - (item.value / maxValue) * plotHeight;
                        return `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
                    }).join(' ')}" 
                          fill="none" 
                          stroke="#36A2EB" 
                          stroke-width="3" 
                          stroke-linecap="round" 
                          stroke-linejoin="round"/>
                    
                    <!-- 数据点 -->
                    ${sortedData.map((item, index) => {
                        const x = padding + (plotWidth / (sortedData.length - 1)) * index;
                        const y = chartHeight - padding - (item.value / maxValue) * plotHeight;
                        return `<circle cx="${x}" cy="${y}" r="6" fill="#36A2EB" stroke="white" stroke-width="2" 
                                style="cursor: pointer; transition: all 0.2s ease;"
                                data-label="${item.label}"
                                data-value="${item.value}"
                                onmouseover="this.style.r='8'; this.style.fill='#FF6384'"
                                onmouseout="this.style.r='6'; this.style.fill='#36A2EB'"
                                ${clickEvent}/>`;
                    }).join('')}
                </svg>
            </div>
        `;

        // 检查是否需要显示省略号
        const originalData = window.currentChartConfigs ? 
            window.currentChartConfigs.find(c => c.id === containerId)?.data : null;
        const hasMoreData = originalData && Object.keys(originalData).length > sortedData.length;
        
        if (hasMoreData) {
            chartHTML += `
                <div style="margin-top: 15px; text-align: center;">
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 16px; border-radius: 20px; border: 1px solid #e9ecef; color: #6c757d; font-size: 12px;">
                        <span>⋯</span>
                        <span>还有 ${Object.keys(originalData).length - sortedData.length} 组数据未显示</span>
                        <span>⋯</span>
                    </div>
                </div>
            `;
        }

        return chartHTML;
    }

    // 关闭项目模态框
    function closeProjectModal() {
        document.getElementById('projectModal').style.display = 'none';
        // 恢复页面滚动
        unlockPageScroll();
    }

    // 获取状态颜色
    function getStatusColor(status) {
        switch(status) {
            case '未开始': return '#ffc107';
            case '进行中': return '#17a2b8';
            case '已完成': return '#28a745';
            default: return '#6c757d';
        }
    }

    // 格式化日期
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        } catch (e) {
            return dateStr;
        }
    }

    // 格式化日期时间
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '-';
        try {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN');
        } catch (e) {
            return dateStr;
        }
    }

    // 点击模态框外部关闭
    window.onclick = function(event) {
        const modal = document.getElementById('projectModal');
        if (event.target === modal) {
            modal.style.display = 'none';
            // 恢复页面滚动
            unlockPageScroll();
        }
    }

    // 键盘事件处理
    document.addEventListener('keydown', function(event) {
        const modal = document.getElementById('projectModal');
        if (event.key === 'Escape' && modal.style.display === 'block') {
            closeProjectModal();
        }
    });

    // 定时刷新数据（每5分钟）
    setInterval(loadProjectData, 5 * 60 * 1000);

    // 显示扇形tooltip
    function showSegmentTooltip(event, label, value, percentage) {
        const tooltip = document.querySelector('[id^="tooltip_"]');
        if (tooltip) {
            tooltip.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">${label}</div>
                    <div>数量: ${value}</div>
                    <div>占比: ${percentage}%</div>
                `;
            tooltip.style.display = 'block';

            // 获取鼠标位置
            const mouseX = event.clientX;
            const mouseY = event.clientY;

            // 获取tooltip尺寸
            const tooltipRect = tooltip.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width;
            const tooltipHeight = tooltipRect.height;

            // 获取视口尺寸
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // 计算tooltip位置，确保不超出视口边界
            let left = mouseX + 15; // 鼠标右侧15px
            let top = mouseY - tooltipHeight - 10; // 鼠标上方10px

            // 如果右侧空间不够，则显示在鼠标左侧
            if (left + tooltipWidth > viewportWidth) {
                left = mouseX - tooltipWidth - 15;
            }

            // 如果上方空间不够，则显示在鼠标下方
            if (top < 0) {
                top = mouseY + 15;
            }

            // 确保不超出左边界
            if (left < 0) {
                left = 10;
            }

            // 确保不超出下边界
            if (top + tooltipHeight > viewportHeight) {
                top = viewportHeight - tooltipHeight - 10;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
    }

    // 隐藏扇形tooltip
    function hideSegmentTooltip() {
        const tooltip = document.querySelector('[id^="tooltip_"]');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    // 点击图表元素跳转到对应数据列表
    function filterByChartSegment(chartId, label, value) {
        // 获取当前模态框显示的项目数据
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let originalProjects = [];

        // 根据标题重新获取原始项目数据
        switch(modalTitle) {
            case '项目总数':
                originalProjects = projectData;
                break;
            case '未开始项目详情':
                originalProjects = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== '已完成'
                );
                break;
            case '进行中项目详情':
                originalProjects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                );
                break;
            case '已完成未确认项目详情':
                originalProjects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case '已确认项目详情':
                originalProjects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // 根据图表类型和标签进行筛选
        let filteredProjects = [];

        if (chartId === 'categoryChart') {
            // 产品类别筛选
            if (label === '未分类') {
                filteredProjects = originalProjects.filter(project =>
                    !project.sample_category || project.sample_category.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.sample_category === label
                );
            }
        } else if (chartId === 'leaderChart') {
            // 项目负责人筛选
            if (label === '未指定') {
                filteredProjects = originalProjects.filter(project =>
                    !project.sample_leader || project.sample_leader.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.sample_leader === label
                );
            }
        } else if (chartId === 'testerChart') {
            // 测试负责人筛选
            if (label === '未指定') {
                filteredProjects = originalProjects.filter(project =>
                    !project.tester || project.tester.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.tester === label
                );
            }
        } else if (chartId === 'dqeLeaderChart') {
            // DQE负责人筛选
            if (label === '未指定') {
                filteredProjects = originalProjects.filter(project =>
                    !project.dqe_leader || project.dqe_leader.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.dqe_leader === label
                );
            }
        } else if (chartId === 'rdLeaderChart') {
            // 研发负责人筛选
            if (label === '未指定') {
                filteredProjects = originalProjects.filter(project =>
                    !project.rd_leader || project.rd_leader.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.rd_leader === label
                );
            }
        } else if (chartId === 'sampleSenderChart') {
            // 送样人筛选
            if (label === '未指定') {
                filteredProjects = originalProjects.filter(project =>
                    !project.sample_sender || project.sample_sender.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.sample_sender === label
                );
            }
        } else if (chartId === 'scheduleChart') {
            // 排期天数筛选
            if (label === '未设置') {
                filteredProjects = originalProjects.filter(project =>
                    !project.scheduleDays || isNaN(project.scheduleDays)
                );
            } else {
                const days = parseInt(label.replace('天', ''));
                filteredProjects = originalProjects.filter(project =>
                    project.scheduleDays === days
                );
            }
        } else if (chartId === 'confirmResultChart') {
            // 确认结果筛选
            if (label === 'DQE-未确认') {
                filteredProjects = originalProjects.filter(project =>
                    (!project.rd_sampleRecognizeResult || project.rd_sampleRecognizeResult.trim() === '') &&
                    (!project.sampleRecognizeResult || project.sampleRecognizeResult.trim() === '')
                );
            } else if (label.startsWith('研发-')) {
                const rdResult = label.replace('研发-', '');
                filteredProjects = originalProjects.filter(project =>
                    project.rd_sampleRecognizeResult && project.rd_sampleRecognizeResult.trim() === rdResult
                );
            } else if (label.startsWith('DQE-')) {
                const dqeResult = label.replace('DQE-', '');
                filteredProjects = originalProjects.filter(project =>
                    project.sampleRecognizeResult && project.sampleRecognizeResult.trim() === dqeResult
                );
            }
        } else if (chartId === 'notStartedDaysChart') {
            // 未开始天数分布筛选
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (label === '今天') {
                filteredProjects = originalProjects.filter(project => {
                    if (!project.create_time) return false;
                    try {
                        const createDate = new Date(project.create_time);
                        createDate.setHours(0, 0, 0, 0);
                        const timeDiff = today.getTime() - createDate.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        return daysDiff === 0;
                    } catch (e) {
                        return false;
                    }
                });
            } else if (label === '昨天') {
                filteredProjects = originalProjects.filter(project => {
                    if (!project.create_time) return false;
                    try {
                        const createDate = new Date(project.create_time);
                        createDate.setHours(0, 0, 0, 0);
                        const timeDiff = today.getTime() - createDate.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        return daysDiff === 1;
                    } catch (e) {
                        return false;
                    }
                });
            } else if (label.endsWith('天')) {
                // 处理具体天数，如"2天"、"3天"等
                const days = parseInt(label.replace('天', ''));
                if (!isNaN(days)) {
                    filteredProjects = originalProjects.filter(project => {
                        if (!project.create_time) return false;
                        try {
                            const createDate = new Date(project.create_time);
                            createDate.setHours(0, 0, 0, 0);
                            const timeDiff = today.getTime() - createDate.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            return daysDiff === days;
                        } catch (e) {
                            return false;
                        }
                    });
                }
            } else if (label === '日期无效') {
                filteredProjects = originalProjects.filter(project => {
                    if (!project.create_time) return false;
                    try {
                        new Date(project.create_time);
                        return false; // 如果日期有效，不包含在此组
                    } catch (e) {
                        return true; // 如果日期无效，包含在此组
                    }
                });
            } else if (label === '未设置') {
                filteredProjects = originalProjects.filter(project => !project.create_time);
            }
        }

        // 显示筛选后的数据列表，并设置对应的过滤器
        showModalDataList(`${modalTitle} - ${label}`, filteredProjects, null, true);

        // 设置对应的过滤器值
        setFilterValues(chartId, label);

        // 显示提示信息
        showFilterNotification(`${label}: 共找到 ${filteredProjects.length} 个项目`);
    }

    // 设置过滤器值
    function setFilterValues(chartId, label) {
        // 等待DOM更新完成后设置过滤器值
        setTimeout(() => {
            if (chartId === 'categoryChart') {
                const categoryFilter = document.getElementById('modalCategoryFilter');
                if (categoryFilter) {
                    if (label === '未分类') {
                        categoryFilter.value = ''; // 未分类对应空值
                    } else {
                        categoryFilter.value = label;
                    }
                }
            } else if (chartId === 'leaderChart') {
                const leaderFilter = document.getElementById('modalLeaderFilter');
                if (leaderFilter) {
                    if (label === '未指定') {
                        leaderFilter.value = ''; // 未指定对应空值
                    } else {
                        leaderFilter.value = label;
                    }
                }
            } else if (chartId === 'testerChart') {
                const testerFilter = document.getElementById('modalTesterFilter');
                if (testerFilter) {
                    if (label === '未指定') {
                        testerFilter.value = ''; // 未指定对应空值
                    } else {
                        testerFilter.value = label;
                    }
                }
            } else if (chartId === 'dqeLeaderChart') {
                // DQE负责人筛选器（如果有的话）
                const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
                if (dqeLeaderFilter) {
                    if (label === '未指定') {
                        dqeLeaderFilter.value = ''; // 未指定对应空值
                    } else {
                        dqeLeaderFilter.value = label;
                    }
                }
            } else if (chartId === 'rdLeaderChart') {
                // 研发负责人筛选器（如果有的话）
                const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
                if (rdLeaderFilter) {
                    if (label === '未指定') {
                        rdLeaderFilter.value = ''; // 未指定对应空值
                    } else {
                        rdLeaderFilter.value = label;
                    }
                }
            } else if (chartId === 'sampleSenderChart') {
                // 送样人筛选器
                const sampleSenderFilter = document.getElementById('modalSampleSenderFilter');
                if (sampleSenderFilter) {
                    if (label === '未指定') {
                        sampleSenderFilter.value = ''; // 未指定对应空值
                    } else {
                        sampleSenderFilter.value = label;
                    }
                }
            } else if (chartId === 'scheduleChart') {
                const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
                if (scheduleDaysFilter) {
                    if (label === '未设置') {
                        scheduleDaysFilter.value = '未设置';
                    } else {
                        const days = parseInt(label.replace('天', ''));
                        scheduleDaysFilter.value = days;
                    }
                }
            }
        }, 100);
    }

    // 显示筛选通知
    function showFilterNotification(message) {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
        notification.textContent = message;

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
        document.head.appendChild(style);

        document.body.appendChild(notification);

        // 3秒后自动移除
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);

        // 添加滑出动画
        const slideOutStyle = document.createElement('style');
        slideOutStyle.textContent = `
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
        document.head.appendChild(slideOutStyle);
    }

    // 图表放大缩小功能
    function zoomChart(chartId, direction) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        // 检查当前图表类型
        const svg = chartContainer.querySelector('svg');
        const flexContainer = chartContainer.querySelector('div[style*="display: flex"]');

        // 如果是柱状图（flex容器），则不执行缩放
        if (flexContainer && !svg) {
            console.log('柱状图不支持缩放功能');
            return;
        }

        // 获取当前尺寸
        const currentHeight = parseInt(chartContainer.style.height) || 350;
        const currentWidth = chartContainer.offsetWidth;

        // 计算新的尺寸（每次调整20px）
        const newHeight = Math.max(250, Math.min(600, currentHeight + (direction * 20)));

        // 应用新尺寸
        chartContainer.style.height = newHeight + 'px';

        // 如果高度变化较大，调整SVG尺寸
        if (svg) {
            const scale = newHeight / 350; // 基于原始高度350px计算缩放比例
            const newSvgSize = 250 * scale;
            svg.style.width = newSvgSize + 'px';
            svg.style.height = newSvgSize + 'px';
            svg.style.transform = `scale(${scale})`;
            svg.style.transformOrigin = 'center center';
        }

        // 更新按钮状态
        updateZoomButtons(chartId, newHeight);
    }

    // 更新放大缩小按钮状态
    function updateZoomButtons(chartId, currentHeight) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        const container = chartContainer.closest('.chart-container, div[style*="background: #f8f9fa"]');
        if (!container) return;

        const zoomOutBtn = container.querySelector('button[onclick*="-1"]');
        const zoomInBtn = container.querySelector('button[onclick*="1"]');

        // 检查当前图表类型
        const svg = chartContainer.querySelector('svg');
        const flexContainer = chartContainer.querySelector('div[style*="display: flex"]');

        // 如果是柱状图，禁用放大缩小按钮（折线图和饼图都支持缩放）
        if (flexContainer && !svg) {
            if (zoomOutBtn) {
                zoomOutBtn.disabled = true;
                zoomOutBtn.style.opacity = '0.3';
                zoomOutBtn.style.cursor = 'not-allowed';
                zoomOutBtn.title = '柱状图不支持缩放';
            }
            if (zoomInBtn) {
                zoomInBtn.disabled = true;
                zoomInBtn.style.opacity = '0.3';
                zoomInBtn.style.cursor = 'not-allowed';
                zoomInBtn.title = '柱状图不支持缩放';
            }
            return;
        }

        // 饼图的正常按钮状态更新
        if (zoomOutBtn) {
            zoomOutBtn.disabled = currentHeight <= 250;
            zoomOutBtn.style.opacity = currentHeight <= 250 ? '0.5' : '1';
            zoomOutBtn.style.cursor = currentHeight <= 250 ? 'not-allowed' : 'pointer';
            zoomOutBtn.title = '缩小';
        }

        if (zoomInBtn) {
            zoomInBtn.disabled = currentHeight >= 600;
            zoomInBtn.style.opacity = currentHeight >= 600 ? '0.5' : '1';
            zoomInBtn.style.cursor = currentHeight >= 600 ? 'not-allowed' : 'pointer';
            zoomInBtn.title = '放大';
        }
    }

    // 导出当前模态框显示的数据
    function exportCurrentModalData(title) {
        // 获取当前模态框显示的项目数据
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let projectsToExport = [];

        // 根据标题重新获取原始项目数据
        switch(modalTitle) {
            case '项目总数':
                projectsToExport = projectData;
                break;
            case '未开始项目详情':
                projectsToExport = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== '已完成'
                );
                break;
            case '进行中项目详情':
                projectsToExport = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                );
                break;
            case '已完成未确认项目详情':
                projectsToExport = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case '已确认项目详情':
                projectsToExport = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
            default:
                // 如果标题包含筛选信息（如"项目总数 - 产品类别"）
                if (modalTitle.includes(' - ')) {
                    const [baseTitle, filterValue] = modalTitle.split(' - ');

                    // 根据基础标题获取原始数据
                    let baseProjects = [];
                    switch(baseTitle) {
                        case '项目总数':
                            baseProjects = projectData;
                            break;
                        case '未开始项目详情':
                            baseProjects = projectData.filter(p =>
                                !p.actual_start_time && p.schedule !== '已完成'
                            );
                            break;
                        case '进行中项目详情':
                            baseProjects = projectData.filter(p =>
                                p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                            );
                            break;
                        case '已完成未确认项目详情':
                            baseProjects = projectData.filter(p =>
                                p.actual_finish_time && !p.sampleRecognizeResult
                            );
                            break;
                        case '已确认项目详情':
                            baseProjects = projectData.filter(p =>
                                p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                            );
                            break;
                    }

                    // 根据筛选值进一步筛选
                    if (filterValue && baseProjects.length > 0) {
                        if (filterValue.includes('天')) {
                            // 排期天数筛选
                            if (filterValue === '未设置') {
                                projectsToExport = baseProjects.filter(project =>
                                    !project.scheduleDays || isNaN(project.scheduleDays)
                                );
                            } else {
                                const days = parseInt(filterValue.replace('天', ''));
                                projectsToExport = baseProjects.filter(project =>
                                    project.scheduleDays === days
                                );
                            }
                        } else {
                            // 其他筛选（产品类别、负责人等）
                            projectsToExport = baseProjects.filter(project => {
                                return project.sample_category === filterValue ||
                                    project.sample_leader === filterValue ||
                                    project.tester === filterValue;
                            });
                        }
                    } else {
                        projectsToExport = baseProjects;
                    }
                } else {
                    projectsToExport = projectData;
                }
                break;
        }

        // 应用所有筛选条件（如果设置了筛选）
        const startDate = document.getElementById('modalStartDate')?.value;
        const endDate = document.getElementById('modalEndDate')?.value;
        const category = document.getElementById('modalCategoryFilter')?.value;
        const tester = document.getElementById('modalTesterFilter')?.value;
        const leader = document.getElementById('modalLeaderFilter')?.value;
        const dqeLeader = document.getElementById('modalDqeLeaderFilter')?.value;
        const rdLeader = document.getElementById('modalRdLeaderFilter')?.value;
        const scheduleDays = document.getElementById('modalScheduleDaysFilter')?.value;

        if (startDate || endDate || category || tester || leader || dqeLeader || rdLeader || scheduleDays) {
            projectsToExport = projectsToExport.filter(project => {
                // 类别筛选
                if (category && project.sample_category !== category) {
                    return false;
                }

                // 测试负责人筛选
                if (tester && project.tester !== tester) {
                    return false;
                }

                // 项目负责人筛选
                if (leader && project.sample_leader !== leader) {
                    return false;
                }

                // DQE负责人筛选
                if (dqeLeader && project.dqe_leader !== dqeLeader) {
                    return false;
                }

                // 研发负责人筛选
                if (rdLeader && project.rd_leader !== rdLeader) {
                    return false;
                }

                // 排期天数筛选
                if (scheduleDays) {
                    if (scheduleDays === '未设置') {
                        if (project.scheduleDays && !isNaN(project.scheduleDays)) {
                            return false;
                        }
                    } else {
                        if (project.scheduleDays !== parseInt(scheduleDays)) {
                            return false;
                        }
                    }
                }

                // 时间筛选
                if (startDate || endDate) {
                    if (!project.create_time) return false;

                    const createDate = new Date(project.create_time);
                    let matchesDate = true;

                    if (startDate) {
                        const start = new Date(startDate);
                        matchesDate = matchesDate && createDate >= start;
                    }

                    if (endDate) {
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        matchesDate = matchesDate && createDate <= end;
                    }

                    if (!matchesDate) return false;
                }

                return true;
            });
        }

        if (projectsToExport.length === 0) {
            alert('没有数据可以导出！');
            return;
        }

        console.log('导出筛选后的数据，数量1:', projectsToExport.length);
        console.log('筛选后的数据:', projectsToExport);

        // 调用原有的导出函数，传入筛选后的数据
        exportToExcel(title, projectsToExport);
    }

    // 导出Excel功能
    function exportToExcel(title, projectsToExport) {
        console.log('开始导出Excel，标题:', title);
        console.log('SheetJS库是否可用:', typeof XLSX !== 'undefined');
        console.log('要导出的数据长度:', projectsToExport.length);
        console.log('要导出的数据:', projectsToExport);
        
        // 调试：检查前几个项目的数据结构
        if (projectsToExport.length > 0) {
            console.log('第一个项目的数据结构:', projectsToExport[0]);
            console.log('大编码字段值:', projectsToExport[0].sample_model);
            console.log('版本字段值:', projectsToExport[0].version);
            console.log('所有可用字段:', Object.keys(projectsToExport[0]));
        }


        // 使用传入的projectsToExport，而不是重新筛选
        const projects = projectsToExport;

        if (projects.length === 0) {
            alert('没有数据可以导出！');
            return;
        }

        try {
            // 准备表头
            const headers = [
                '样品编号', '产品名称', '产品类别', '大编码', '物料编码', '版本', '项目负责人',
                '当前进度', '测试负责人', 'DQE负责人', '研发负责人', '送样人', '送样类别', '送样数量', '是否高频', '提单时间', '排期天数',
                '排期开始', '排期结束', '实际开始时间', '实际完成时间', 'DQE承认结果', '研发承认结果'
            ];

            // 准备数据
            const data = projects.map(project => [
                project.sample_id || '',
                project.sample_name || '',
                project.sample_category || '',
                project.sample_model || ' ', // 如果字段不存在，显示"待补充"
                project.materialCode || '',
                project.version || ' ', // 如果字段不存在，显示"待补充"
                project.sample_leader || '',
                getProjectStatus(project),
                project.tester || '',
                project.dqe_leader || '',
                project.rd_leader || '',
                project.sample_sender || '',
                project.sample_type || '',
                project.sample_quantity || '',
                project.high_frequency || '',
                formatDateTime(project.create_time) || '',
                project.scheduleDays || '',
                formatDate(project.schedule_start_date) || '',
                formatDate(project.schedule_end_date) || '',
                formatDateTime(project.actual_start_time) || '',
                formatDateTime(project.actual_finish_time) || '',
                project.sampleRecognizeResult || '',
                project.rd_sampleRecognizeResult || ''
            ]);

            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

            // 设置列宽
            const colWidths = headers.map(() => ({ wch: 15 }));
            ws['!cols'] = colWidths;

            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, ws, '项目数据');

            // 生成文件名
            const fileName = `${title}_${new Date().toISOString().slice(0, 10)}.xlsx`;

            // 导出文件
            XLSX.writeFile(wb, fileName);

            alert('导出成功！');
        } catch (error) {
            console.error('导出失败:', error);
            alert('导出失败，请检查控制台错误信息！');
        }
    }

    // 获取项目状态的辅助函数
    function getProjectStatus(project) {
        if (!project.actual_start_time) {
            return '未开始';
        } else if (project.actual_start_time && !project.actual_finish_time) {
            return '进行中';
        } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
            return '已完成未确认';
        } else if (project.actual_finish_time && project.sampleRecognizeResult) {
            return '已确认';
        }
        return '未知状态';
    }

    // 模态框筛选功能
    function applyModalFilters() {
        const startDate = document.getElementById('modalStartDate').value;
        const endDate = document.getElementById('modalEndDate').value;
        const category = document.getElementById('modalCategoryFilter')?.value;
        const tester = document.getElementById('modalTesterFilter')?.value;
        const leader = document.getElementById('modalLeaderFilter')?.value;
        const dqeLeader = document.getElementById('modalDqeLeaderFilter')?.value;
        const rdLeader = document.getElementById('modalRdLeaderFilter')?.value;
        const scheduleDays = document.getElementById('modalScheduleDaysFilter')?.value;

        // 获取当前模态框显示的项目数据
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let originalProjects = [];

        // 根据标题重新获取原始项目数据
        switch(modalTitle) {
            case '项目总数':
                originalProjects = projectData;
                break;
            case '未开始项目详情':
                originalProjects = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== '已完成'
                );
                break;
            case '进行中项目详情':
                originalProjects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                );
                break;
            case '已完成未确认项目详情':
                originalProjects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case '已确认项目详情':
                originalProjects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // 应用所有筛选条件
        let filteredProjects = originalProjects.filter(project => {
            // 类别筛选
            if (category && project.sample_category !== category) {
                return false;
            }

            // 测试负责人筛选
            if (tester && project.tester !== tester) {
                return false;
            }

            // 项目负责人筛选
            if (leader && project.sample_leader !== leader) {
                return false;
            }

            // DQE负责人筛选
            if (dqeLeader && project.dqe_leader !== dqeLeader) {
                return false;
            }

            // 研发负责人筛选
            if (rdLeader && project.rd_leader !== rdLeader) {
                return false;
            }

            // 排期天数筛选
            if (scheduleDays) {
                if (scheduleDays === '未设置') {
                    if (project.scheduleDays && !isNaN(project.scheduleDays)) {
                        return false;
                    }
                } else {
                    if (project.scheduleDays !== parseInt(scheduleDays)) {
                        return false;
                    }
                }
            }

            // 时间筛选
            if (startDate || endDate) {
                if (!project.create_time) return false;

                const createDate = new Date(project.create_time);
                let matchesDate = true;

                if (startDate) {
                    const start = new Date(startDate);
                    matchesDate = matchesDate && createDate >= start;
                }

                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    matchesDate = matchesDate && createDate <= end;
                }

                if (!matchesDate) return false;
            }

            return true;
        });

        // 更新模态框内容 - 保持当前显示模式
        const currentContent = document.getElementById('modalContent').innerHTML;
        if (currentContent.includes('数据统计概览')) {
            // 如果当前显示的是图表，则更新图表
            showModalCharts(modalTitle, filteredProjects);
        } else {
            // 如果当前显示的是数据列表，则更新数据列表，保持过滤器值
            showModalDataList(modalTitle, filteredProjects, null, true);
        }
    }

    // 重置模态框筛选
    function resetModalFilters() {
        // 重置所有过滤器
        document.getElementById('modalStartDate').value = '';
        document.getElementById('modalEndDate').value = '';

        const categoryFilter = document.getElementById('modalCategoryFilter');
        if (categoryFilter) categoryFilter.value = '';

        const testerFilter = document.getElementById('modalTesterFilter');
        if (testerFilter) testerFilter.value = '';

        const leaderFilter = document.getElementById('modalLeaderFilter');
        if (leaderFilter) leaderFilter.value = '';

        const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
        if (dqeLeaderFilter) dqeLeaderFilter.value = '';

        const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
        if (rdLeaderFilter) rdLeaderFilter.value = '';

        const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
        if (scheduleDaysFilter) scheduleDaysFilter.value = '';

        // 重新显示原始数据
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let originalProjects = [];

        switch(modalTitle) {
            case '项目总数':
                originalProjects = projectData;
                break;
            case '未开始项目详情':
                originalProjects = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== '已完成'
                );
                break;
            case '进行中项目详情':
                originalProjects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                );
                break;
            case '已完成未确认项目详情':
                originalProjects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case '已确认项目详情':
                originalProjects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // 保持当前显示模式
        const currentContent = document.getElementById('modalContent').innerHTML;
        if (currentContent.includes('数据统计概览')) {
            // 如果当前显示的是图表，则更新图表
            showModalCharts(modalTitle, originalProjects);
        } else {
            // 如果当前显示的是数据列表，则更新数据列表，保持过滤器值
            showModalDataList(modalTitle, originalProjects, null, true);
        }
    }

    // 切换图表类型（柱状图/饼状图/折线图）
    function toggleChartType(chartId, dataJson) {
        try {
            const data = JSON.parse(dataJson);
            const chartContainer = document.getElementById(chartId);
            const toggleBtn = chartContainer.parentElement.querySelector('button[onclick*="toggleChartType"]');

            if (!chartContainer || !toggleBtn) return;

            // 应用数据限制
            const limitedData = applyDataLimit(data, window.currentDisplayLimit || 10);

            // 检查当前图表类型
            const currentChart = chartContainer.querySelector('svg, div[style*="display: flex"]');
            const isCurrentlyBar = currentChart && currentChart.style.display === 'flex';
            const isCurrentlyPie = currentChart && currentChart.tagName === 'svg' && currentChart.querySelector('path[id^="segment_"]');
            const isCurrentlyLine = currentChart && currentChart.tagName === 'svg' && currentChart.querySelector('path[stroke="#36A2EB"]');

            // 确定下一个图表类型
            let nextChartType;
            let nextIcon;
            let nextTitle;

            if (isCurrentlyBar) {
                // 当前是柱状图，切换到饼状图
                nextChartType = 'pie';
                nextIcon = '🍕';
                nextTitle = '切换到折线图';
            } else if (isCurrentlyPie) {
                // 当前是饼状图，切换到折线图
                nextChartType = 'line';
                nextIcon = '📈';
                nextTitle = '切换到柱状图';
            } else {
                // 当前是折线图或其他，切换到柱状图
                nextChartType = 'bar';
                nextIcon = '📊';
                nextTitle = '切换到饼状图';
            }

            // 根据下一个图表类型创建图表
            switch (nextChartType) {
                case 'bar':
                    chartContainer.innerHTML = createBarChart(limitedData, chartId);
                    break;
                case 'pie':
                    chartContainer.innerHTML = createPieChart(limitedData, chartId);
                    break;
                case 'line':
                    chartContainer.innerHTML = createLineChart(limitedData, chartId);
                    break;
            }

            // 更新按钮图标和提示
            toggleBtn.innerHTML = nextIcon;
            toggleBtn.title = nextTitle;

            // 重新绑定点击事件（因为重新生成了HTML）
            bindChartClickEvents(chartId);

            // 重新绑定tooltip事件
            bindTooltipEvents(chartId);

        } catch (error) {
            console.error('切换图表类型失败:', error);
        }
    }

    // 绑定图表点击事件
    function bindChartClickEvents(chartId) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        // 为饼图的扇形添加点击事件
        const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
        segments.forEach(segment => {
            const label = segment.getAttribute('data-label');
            const value = segment.getAttribute('data-value');
            if (label && value) {
                segment.onclick = () => filterByChartSegment(chartId, label, parseInt(value));
            }
        });

        // 为柱状图的柱子添加点击事件
        const bars = chartContainer.querySelectorAll('div[data-label][data-value]');
        bars.forEach(bar => {
            const label = bar.getAttribute('data-label');
            const value = bar.getAttribute('data-value');
            if (label && value) {
                // 确保这是真正的柱子（有背景色的div）
                if (bar.style.background || bar.style.backgroundColor) {
                    bar.onclick = () => filterByChartSegment(chartId, label, parseInt(value));
                }
            }
        });
    }

    // 绑定tooltip事件
    function bindTooltipEvents(chartId) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        // 为饼图的扇形添加tooltip事件
        const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
        segments.forEach(segment => {
            const label = segment.getAttribute('data-label');
            const value = segment.getAttribute('data-value');
            if (label && value) {
                segment.onmouseover = (event) => showSegmentTooltip(event, label, parseInt(value), ((parseInt(value) / getTotalValue(chartId)) * 100).toFixed(1));
                segment.onmouseout = hideSegmentTooltip;
            }
        });
    }

    // 获取图表数据总和
    function getTotalValue(chartId) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return 0;

        // 尝试从data属性获取值
        const elements = chartContainer.querySelectorAll('[data-value]');
        let total = 0;
        elements.forEach(element => {
            const value = parseInt(element.getAttribute('data-value'));
            if (!isNaN(value)) {
                total += value;
            }
        });

        return total;
    }

    // 模态框导出Excel功能（导出筛选后的数据）
    function exportModalExcel(title) {
        // 获取当前模态框中实际显示的数据
        let projectsToExport = [];

        // 检查当前模态框是否显示的是数据列表
        const modalContent = document.getElementById('modalContent');
        if (modalContent && modalContent.innerHTML.includes('详细数据列表')) {
            // 如果当前显示的是数据列表，获取表格中的实际数据
            const tableRows = modalContent.querySelectorAll('table tbody tr');
            if (tableRows.length > 0) {
                // 从表格行中提取数据
                projectsToExport = Array.from(tableRows).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 23) { // 确保有足够的列
                        return {
                            sample_id: cells[0].textContent.trim(),
                            sample_name: cells[1].textContent.trim(),
                            sample_category: cells[2].textContent.trim(),
                            sample_model: cells[3].textContent.trim(),
                            materialCode: cells[4].textContent.trim(),
                            version: cells[5].textContent.trim(),
                            sample_leader: cells[6].textContent.trim(),
                            schedule: cells[7].textContent.trim(),
                            tester: cells[8].textContent.trim(),
                            dqe_leader: cells[9].textContent.trim(),
                            rd_leader: cells[10].textContent.trim(),
                            sample_sender: cells[11].textContent.trim(),
                            sample_type: cells[12].textContent.trim(),
                            sample_quantity: cells[13].textContent.trim(),
                            high_frequency: cells[14].textContent.trim(),
                            create_time: cells[15].textContent.trim(),
                            scheduleDays: cells[16].textContent.trim(),
                            schedule_start_date: cells[17].textContent.trim(),
                            schedule_end_date: cells[18].textContent.trim(),
                            actual_start_time: cells[19].textContent.trim(),
                            actual_finish_time: cells[20].textContent.trim(),
                            sampleRecognizeResult: cells[21].textContent.trim(),
                            rd_sampleRecognizeResult: cells[22] ? cells[22].textContent.trim() : ''
                        };
                    }
                    return null;
                }).filter(Boolean);
            }
        }

        // 如果无法从表格获取数据，则根据标题获取基础数据
        if (projectsToExport.length === 0) {
            switch(title) {
                case '项目总数':
                    projectsToExport = projectData;
                    break;
                case '未开始项目详情':
                    projectsToExport = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== '已完成'
                    );
                    break;
                case '进行中项目详情':
                    projectsToExport = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                    );
                    break;
                case '已完成未确认项目详情':
                    projectsToExport = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case '已确认项目详情':
                    projectsToExport = projectData.filter(p =>
                        p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                    );
                    break;
                default:
                    // 如果标题包含筛选信息（如"项目总数 - 产品类别"）
                    if (title.includes(' - ')) {
                        const [baseTitle, filterValue] = title.split(' - ');

                        // 根据基础标题获取原始项目数据
                        let baseProjects = [];
                        switch(baseTitle) {
                            case '项目总数':
                                baseProjects = projectData;
                                break;
                            case '未开始项目详情':
                                baseProjects = projectData.filter(p =>
                                    !p.actual_start_time && p.schedule !== '已完成'
                                );
                                break;
                            case '进行中项目详情':
                                baseProjects = projectData.filter(p =>
                                    p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                                );
                                break;
                            case '已完成未确认项目详情':
                                baseProjects = projectData.filter(p =>
                                    p.actual_finish_time && !p.sampleRecognizeResult
                                );
                                break;
                            case '已确认项目详情':
                                baseProjects = projectData.filter(p =>
                                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                                );
                                break;
                        }


                        // 根据筛选值进一步筛选
                        if (filterValue && baseProjects.length > 0) {
                            if (filterValue.includes('天')) {
                                // 排期天数筛选
                                if (filterValue === '未设置') {
                                    projectsToExport = baseProjects.filter(project =>
                                        !project.scheduleDays || isNaN(project.scheduleDays)
                                    );
                                } else {
                                    const days = parseInt(filterValue.replace('天', ''));
                                    projectsToExport = baseProjects.filter(project =>
                                        project.scheduleDays === days
                                    );
                                }
                            } else {
                                // 其他筛选（产品类别、负责人等）
                                projectsToExport = baseProjects.filter(project => {
                                    return project.sample_category === filterValue ||
                                        project.sample_leader === filterValue ||
                                        project.tester === filterValue ||
                                        project.dqe_leader === filterValue ||
                                        project.rd_leader === filterValue ||
                                        project.sample_sender === filterValue;
                                });
                            }
                        } else {
                            projectsToExport = baseProjects;
                        }
                    } else {
                        projectsToExport = projectData;
                    }
                    break;
            }
        }

        // 检查是否有数据可以导出
        if (projectsToExport.length === 0) {
            alert('没有数据可以导出！');
            return;
        }

        console.log('导出数据，标题2:', title, '数量:', projectsToExport.length);
        console.log('导出的数据:', projectsToExport);

        // 调用原有的导出函数，传入筛选后的数据
        exportToExcel(title, projectsToExport);
    }

    // 显示自定义图表模态框
    function showDynamicChartModal(title, projects, status) {
        // 填充字段选择器
        populateFieldSelector();

        // 存储当前项目数据供图表生成使用
        window.currentProjectsForChart = projects;
        window.currentChartTitle = title;
        window.currentChartStatus = status;

        // 显示模态框
        document.getElementById('dynamicChartModal').style.display = 'block';

        // 填充已保存的图表列表
        populateSavedChartsList();
    }

    // 关闭自定义图表模态框
    function closeDynamicChartModal() {
        document.getElementById('dynamicChartModal').style.display = 'none';
    }

    // 填充字段选择器
    function populateFieldSelector() {
        const fieldSelector = document.getElementById('fieldSelector');
        const fields = [
            { value: 'sample_id', label: '样品编号' },
            { value: 'sample_name', label: '产品名称' },
            { value: 'sample_category', label: '产品类别' },
            { value: 'sample_model', label: '大编码' },
            { value: 'version', label: '版本号' },
            { value: 'sample_leader', label: '项目负责人' },
            { value: 'tester', label: '测试负责人' },
            { value: 'dqe_leader', label: 'DQE负责人' },
            { value: 'rd_leader', label: '研发负责人' },
            { value: 'sample_sender', label: '送样人' },
            { value: 'sample_type', label: '送样类别' },
            { value: 'create_time', label: '提单时间' },
            { value: 'scheduleDays', label: '排期天数' },
            { value: 'schedule_start_date', label: '排期开始时间' },
            { value: 'schedule_end_date', label: '排期结束时间' },
            { value: 'actual_start_time', label: '实际开始测试时间' },
            { value: 'actual_finish_time', label: '实际完成时间' },
            { value: 'sampleRecognizeResult', label: 'DQE承认结果' },
            { value: 'rd_sampleRecognizeResult', label: '研发承认结果' }
        ];

        fieldSelector.innerHTML = '<option value="">请选择要分析的字段</option>';
        fields.forEach(field => {
            fieldSelector.innerHTML += `<option value="${field.value}">${field.label}</option>`;
        });
    }

    // 生成自定义图表
    function generateDynamicChart() {
        const fieldName = document.getElementById('fieldSelector').value;
        const chartType = document.getElementById('chartTypeSelector').value;
        const topN = parseInt(document.getElementById('topNSelector').value) || 10;

        if (!fieldName) {
            alert('请选择要分析的字段！');
            return;
        }

        if (!window.currentProjectsForChart || window.currentProjectsForChart.length === 0) {
            alert('没有数据可以分析！');
            return;
        }

        // 统计数据
        const stats = {};
        window.currentProjectsForChart.forEach(project => {
            let value = project[fieldName];

            // 处理不同类型的值
            if (value === null || value === undefined || value === '') {
                value = '未设置';
            } else if (fieldName === 'scheduleDays') {
                value = isNaN(value) ? '未设置' : value + '天';
            } else if (fieldName === 'testDuration') {
                value = isNaN(value) ? '未设置' : value + '小时';
            } else if (fieldName === 'sample_frequency') {
                value = isNaN(value) ? '未设置' : value + '次';
            } else if (fieldName === 'isUsed') {
                value = value === 1 ? '已用' : value === 0 ? '未用' : '未设置';
            } else if (fieldName === 'isCancel') {
                value = value === 1 ? '已作废' : value === 0 ? '未作废' : '未设置';
            } else if (fieldName === 'high_frequency') {
                value = value === '1' || value === 1 ? '是' : value === '0' || value === 0 ? '否' : value || '未设置';
            } else if (fieldName.includes('date') || fieldName.includes('time') || fieldName === 'reportReviewTime') {
                // 对于日期时间字段，提取年月日
                if (value && value !== '未设置') {
                    try {
                        const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                            value = date.toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        value = '无效日期';
                    }
                }
            } else if (fieldName === 'priority') {
                // 优先级字段特殊处理
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = '未设置';
                }
            } else if (fieldName === 'schedule') {
                // 进度字段特殊处理 - 数据库值为0,1,2,3,4
                if (value !== null && value !== undefined && value !== '') {
                    // 将数字转换为对应的进度描述
                    const progressMap = {
                        '0': '未开始',
                        '1': '进行中',
                        '2': '已完成未确认',
                        '3': '报告确认闭环'
                    };
                    value = progressMap[value.toString()] || `进度${value}`;
                } else {
                    value = '未设置';
                }
            } else if (fieldName === 'sample_type') {
                // 送样类别字段特殊处理
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = '未设置';
                }
            }

            stats[value] = (stats[value] || 0) + 1;
        });

        // 排序并取前N个
        let sortedStats;
        
        // 检查是否为时间字段，如果是则按时间顺序排序
        if (fieldName.includes('date') || fieldName.includes('time') || fieldName === 'reportReviewTime') {
            // 对时间字段按时间顺序排序（从早到晚）
            sortedStats = Object.entries(stats)
                .filter(([key]) => key !== '未设置' && key !== '无效日期') // 先过滤掉特殊值
                .sort((a, b) => {
                    // 尝试解析日期进行比较
                    try {
                        const dateA = new Date(a[0]);
                        const dateB = new Date(b[0]);
                        if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                            return dateA - dateB; // 按时间从早到晚排序
                        }
                        return a[0].localeCompare(b[0]); // 如果解析失败，按字符串排序
                    } catch (e) {
                        return a[0].localeCompare(b[0]);
                    }
                })
                .slice(0, topN);
            
            // 如果有特殊值，添加到末尾
            if (stats['未设置']) {
                sortedStats.push(['未设置', stats['未设置']]);
            }
            if (stats['无效日期']) {
                sortedStats.push(['无效日期', stats['无效日期']]);
            }
        } else {
            // 非时间字段按值从高到低排序
            sortedStats = Object.entries(stats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
        }

        // 重新构建统计数据
        const finalStats = {};
        sortedStats.forEach(([key, value]) => {
            finalStats[key] = value;
        });

        // 生成图表
        const chartContainer = document.getElementById('dynamicChartContainer');
        if (chartType === 'pie') {
            chartContainer.innerHTML = createPieChart(finalStats, 'dynamicChart');
        } else if (chartType === 'line') {
            chartContainer.innerHTML = createLineChart(finalStats, 'dynamicChart');
        } else {
            chartContainer.innerHTML = createBarChart(finalStats, 'dynamicChart');
        }

        // 绑定图表事件
        bindDynamicChartEvents();
    }

    // 清除自定义图表
    function clearDynamicChart() {
        document.getElementById('dynamicChartContainer').innerHTML = `
                <div style="text-align: center; color: #666;">
                    <p>请选择字段并点击"生成图表"按钮</p>
                </div>
            `;
    }

    // 保存图表到项目详情
    function saveChartToProjectDetails() {
        const fieldName = document.getElementById('fieldSelector').value;
        const chartType = document.getElementById('chartTypeSelector').value;
        const topN = parseInt(document.getElementById('topNSelector').value) || 10;

        if (!fieldName) {
            alert('请先生成图表！');
            return;
        }

        // 获取字段标签
        const fieldSelector = document.getElementById('fieldSelector');
        const selectedOption = fieldSelector.options[fieldSelector.selectedIndex];
        const fieldLabel = selectedOption ? selectedOption.text : fieldName;

        // 创建图表配置对象
        const chartConfig = {
            id: Date.now(), // 唯一ID
            fieldName: fieldName,
            fieldLabel: fieldLabel,
            chartType: chartType,
            topN: topN,
            title: `${fieldLabel}分布`,
            projects: window.currentProjectsForChart,
            status: window.currentChartStatus,
            createTime: new Date().toLocaleString('zh-CN')
        };

        // 保存到localStorage，支持多个图表
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const key = `${window.currentChartTitle}_${window.currentChartStatus}`;

        if (!savedCharts[key]) {
            savedCharts[key] = [];
        }

        // 检查是否已存在相同字段的图表
        const existingIndex = savedCharts[key].findIndex(chart => chart.fieldName === fieldName);
        if (existingIndex !== -1) {
            if (confirm(`已存在"${fieldLabel}"的图表，是否替换？`)) {
                savedCharts[key][existingIndex] = chartConfig;
            } else {
                return; // 用户取消替换
            }
        } else {
            savedCharts[key].push(chartConfig);
        }

        localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));

        alert(`图表已保存！下次进入"${window.currentChartTitle}"时将自动显示此图表。`);

        // 刷新已保存的图表列表
        populateSavedChartsList();
    }

    // 绑定自定义图表事件
    function bindDynamicChartEvents() {
        const chartContainer = document.getElementById('dynamicChartContainer');

        // 为饼图的扇形添加点击事件
        const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
        segments.forEach(segment => {
            const label = segment.getAttribute('data-label');
            const value = segment.getAttribute('data-value');
            if (label && value) {
                segment.onclick = () => {
                    alert(`点击了: ${label}, 数量: ${value}`);
                };
            }
        });

        // 为柱状图的柱子添加点击事件
        const bars = chartContainer.querySelectorAll('div[data-label][data-value]');
        bars.forEach(bar => {
            const label = bar.getAttribute('data-label');
            const value = bar.getAttribute('data-value');
            if (label && value) {
                if (bar.style.background || bar.style.backgroundColor) {
                    bar.onclick = () => {
                        alert(`点击了: ${label}, 数量: ${value}`);
                    };
                }
            }
        });
    }

    // 创建折线图
    function createLineChart(data, chartId) {
        const labels = Object.keys(data);
        const values = Object.values(data);
        const maxValue = Math.max(...values);

        let svg = `<svg width="100%" height="100%" viewBox="0 0 800 400">`;

        // 绘制坐标轴
        svg += `<line x1="50" y1="350" x2="750" y2="350" stroke="#333" stroke-width="2"/>`;
        svg += `<line x1="50" y1="50" x2="50" y2="350" stroke="#333" stroke-width="2"/>`;

        // 绘制折线
        if (labels.length > 1) {
            let pathData = '';
            labels.forEach((label, index) => {
                const x = 50 + (index * 700) / (labels.length - 1);
                const y = 350 - (values[index] * 300) / maxValue;

                if (index === 0) {
                    pathData = `M ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                }
            });

            svg += `<path d="${pathData}" stroke="#007bff" stroke-width="3" fill="none"/>`;

            // 绘制数据点
            labels.forEach((label, index) => {
                const x = 50 + (index * 700) / (labels.length - 1);
                const y = 350 - (values[index] * 300) / maxValue;

                // 检查是否为保存的图表，如果是则添加点击事件
                const isSavedChart = chartId.startsWith('savedChart_');
                const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${chartId}', event)"` : '';

                svg += `<circle cx="${x}" cy="${y}" r="5" fill="#007bff" style="cursor: pointer;" data-label="${label}" data-value="${values[index]}" ${clickEvent}/>`;
                svg += `<text x="${x}" y="${y + 20}" text-anchor="middle" font-size="12" fill="#333">${values[index]}</text>`;
            });
        }

        // 绘制标签
        labels.forEach((label, index) => {
            const x = 50 + (index * 700) / (labels.length - 1);
            svg += `<text x="${x}" y="380" text-anchor="middle" font-size="10" fill="#666">${label}</text>`;
        });

        svg += `</svg>`;
        return svg;
    }

    // 获取图表类型名称
    function getChartTypeName(chartType) {
        const typeNames = {
            'bar': '柱状图',
            'pie': '饼图',
            'line': '折线图'
        };
        return typeNames[chartType] || chartType;
    }

    // 生成保存的图表
    function generateSavedChart(chartConfig, projects, containerId) {
        // 统计数据
        const stats = {};
        const valueToProjects = {}; // 存储每个值对应的项目列表

        projects.forEach(project => {
            let value = project[chartConfig.fieldName];

            // 处理不同类型的值（与generateDynamicChart中的逻辑一致）
            if (value === null || value === undefined || value === '') {
                value = '未设置';
            } else if (chartConfig.fieldName === 'scheduleDays') {
                value = isNaN(value) ? '未设置' : value + '天';
            } else if (chartConfig.fieldName === 'testDuration') {
                value = isNaN(value) ? '未设置' : value + '小时';
            } else if (chartConfig.fieldName === 'sample_frequency') {
                value = isNaN(value) ? '未设置' : value + '次';
            } else if (chartConfig.fieldName === 'isUsed') {
                value = value === 1 ? '已用' : value === 0 ? '未用' : '未设置';
            } else if (chartConfig.fieldName === 'isCancel') {
                value = value === 1 ? '已作废' : value === 0 ? '未作废' : '未设置';
            } else if (chartConfig.fieldName === 'high_frequency') {
                value = value === '1' || value === 1 ? '是' : value === '0' || value === 0 ? '否' : value || '未设置';
            } else if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
                if (value && value !== '未设置') {
                    try {
                        const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                            value = date.toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        value = '无效日期';
                    }
                }
            } else if (['priority', 'sample_type'].includes(chartConfig.fieldName)) {
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = value || '未设置';
                }
            } else if (chartConfig.fieldName === 'schedule') {
                // 进度字段特殊处理 - 数据库值为0,1,2,3,4
                if (value !== null && value !== undefined && value !== '') {
                    // 将数字转换为对应的进度描述
                    const progressMap = {
                        '0': '未开始',
                        '1': '进行中',
                        '2': '已完成',
                        '3': '已暂停',
                        '4': '已取消'
                    };
                    value = progressMap[value.toString()] || `进度${value}`;
                } else {
                    value = '未设置';
                }
            }

            stats[value] = (stats[value] || 0) + 1;

            // 存储每个值对应的项目列表
            if (!valueToProjects[value]) {
                valueToProjects[value] = [];
            }
            valueToProjects[value].push(project);
        });

        // 排序并取前N个
        let sortedStats;
        
        // 检查是否为时间字段，如果是则按时间顺序排序
        if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
            // 对时间字段按时间顺序排序（从早到晚）
            sortedStats = Object.entries(stats)
                .filter(([key]) => key !== '未设置' && key !== '无效日期') // 先过滤掉特殊值
                .sort((a, b) => {
                    // 尝试解析日期进行比较
                    try {
                        const dateA = new Date(a[0]);
                        const dateB = new Date(b[0]);
                        if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                            return dateA - dateB; // 按时间从早到晚排序
                        }
                        return a[0].localeCompare(b[0]); // 如果解析失败，按字符串排序
                    } catch (e) {
                        return a[0].localeCompare(b[0]);
                    }
                })
                .slice(0, chartConfig.topN);
            
            // 如果有特殊值，添加到末尾
            if (stats['未设置']) {
                sortedStats.push(['未设置', stats['未设置']]);
            }
            if (stats['无效日期']) {
                sortedStats.push(['无效日期', stats['无效日期']]);
            }
        } else {
            // 非时间字段按值从高到低排序
            sortedStats = Object.entries(stats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, chartConfig.topN);
        }

        // 重新构建统计数据
        const finalStats = {};
        sortedStats.forEach(([key, value]) => {
            finalStats[key] = value;
        });

        // 为图表添加点击事件数据
        const chartId = containerId || `savedChart_${chartConfig.id || Date.now()}`;
        const clickData = {
            chartConfig: chartConfig,
            valueToProjects: valueToProjects,
            projects: projects
        };

        // 存储点击数据到全局变量
        window.savedChartClickData = window.savedChartClickData || {};
        window.savedChartClickData[chartId] = clickData;

        // 生成图表并添加点击事件标识
        let chartHTML = '';
        if (chartConfig.chartType === 'pie') {
            chartHTML = createPieChart(finalStats, chartId);
        } else if (chartConfig.chartType === 'line') {
            chartHTML = createLineChart(finalStats, chartId);
        } else {
            chartHTML = createBarChart(finalStats, chartId);
        }

        return chartHTML;
    }

    // 删除保存的图表
    function removeSavedChart(chartKey, chartId) {
        if (confirm('确定要删除这个自定义图表吗？')) {
            const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');

            if (savedCharts[chartKey]) {
                // 从数组中删除指定ID的图表
                savedCharts[chartKey] = savedCharts[chartKey].filter(chart => chart.id !== chartId);

                // 如果数组为空，删除整个key
                if (savedCharts[chartKey].length === 0) {
                    delete savedCharts[chartKey];
                }

                localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
            }

            // 重新加载图表管理界面
            const currentTitle = window.currentChartTitle;
            const currentProjects = window.currentProjectsForChart;
            const currentStatus = window.currentChartStatus;
            
            if (currentTitle && currentProjects) {
                showModalCharts(currentTitle, currentProjects, currentStatus);
            }
        }
    }

    // 填充已保存的图表列表
    function populateSavedChartsList() {
        const savedChartsList = document.getElementById('savedChartsList');
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const chartKey = `${window.currentChartTitle}_${window.currentChartStatus}`;
        let charts = savedCharts[chartKey] || [];

        // 确保charts是数组
        if (!Array.isArray(charts)) {
            // 如果是旧格式的单个图表，转换为数组格式
            if (charts && typeof charts === 'object' && charts.fieldName) {
                charts = [charts];
                // 更新localStorage为新的数组格式
                savedCharts[chartKey] = charts;
                localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
            } else {
                charts = [];
            }
        }

        if (charts.length === 0) {
            savedChartsList.innerHTML = '<p style="color: #666; text-align: center;">暂无保存的图表</p>';
            return;
        }

        let html = '';
        charts.forEach((chart, index) => {
            html += `
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #333;">${chart.title}</strong>
                                <span style="color: #666; font-size: 12px; margin-left: 10px;">字段: ${chart.fieldLabel}</span>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-outline-primary" onclick="loadSavedChart('${chartKey}', ${chart.id})" title="加载此图表">📊</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeSavedChart('${chartKey}', ${chart.id})" title="删除此图表">🗑️</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            类型: ${getChartTypeName(chart.chartType)} | 显示: 前${chart.topN}个 | 创建: ${chart.createTime}
                        </div>
                    </div>
                `;
        });

        savedChartsList.innerHTML = html;
    }

    // 加载保存的图表到图表容器
    function loadSavedChart(chartKey, chartId) {
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const charts = savedCharts[chartKey] || [];
        const chart = charts.find(c => c.id === chartId);

        if (chart) {
            // 设置字段选择器
            document.getElementById('fieldSelector').value = chart.fieldName;
            document.getElementById('chartTypeSelector').value = chart.chartType;
            document.getElementById('topNSelector').value = chart.topN;

            // 生成图表
            generateDynamicChart();

            alert(`已加载"${chart.title}"图表配置`);
        }
    }

    // 处理保存图表的点击事件
    function handleSavedChartClick(chartId, event) {
        console.log('保存图表点击事件触发，chartId:', chartId);

        const clickData = window.savedChartClickData[chartId];
        if (!clickData) {
            console.error('未找到图表点击数据，chartId:', chartId);
            return;
        }

        // 获取点击的元素
        const target = event.target;
        let label = '';
        let value = 0;

        // 根据图表类型获取点击的标签和值
        if (clickData.chartConfig.chartType === 'pie') {
            // 饼图：从path元素获取数据
            if (target.tagName === 'path' && target.getAttribute('data-label')) {
                label = target.getAttribute('data-label');
                value = parseInt(target.getAttribute('data-value')) || 0;
            }
        } else if (clickData.chartConfig.chartType === 'bar') {
            // 柱状图：从div元素获取数据
            if (target.getAttribute('data-label')) {
                label = target.getAttribute('data-label');
                value = parseInt(target.getAttribute('data-value')) || 0;
            }
        } else if (clickData.chartConfig.chartType === 'line') {
            // 折线图：从circle元素获取数据
            if (target.tagName === 'circle') {
                label = target.getAttribute('data-label');
                value = parseInt(target.getAttribute('data-value')) || 0;
            }
        }

        if (label && value > 0) {
            // 获取当前模态框显示的项目数据
            const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
            let originalProjects = [];

            // 根据标题重新获取原始项目数据
            switch(modalTitle) {
                case '项目总数':
                    originalProjects = projectData;
                    break;
                case '未开始项目详情':
                    originalProjects = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== '已完成'
                    );
                    break;
                case '进行中项目详情':
                    originalProjects = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== '已完成'
                    );
                    break;
                case '已完成未确认项目详情':
                    originalProjects = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case '已确认项目详情':
                    originalProjects = projectData.filter(p =>
                        p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                    );
                    break;
            }

            // 根据自定义图表的字段和标签筛选项目
            let filteredProjects = originalProjects.filter(project => {
                let projectValue = project[clickData.chartConfig.fieldName];

                // 处理不同类型的值，与生成图表时的逻辑保持一致
                if (projectValue === null || projectValue === undefined || projectValue === '') {
                    projectValue = '未设置';
                } else if (clickData.chartConfig.fieldName === 'scheduleDays') {
                    projectValue = isNaN(projectValue) ? '未设置' : projectValue + '天';
                } else if (clickData.chartConfig.fieldName === 'testDuration') {
                    projectValue = isNaN(projectValue) ? '未设置' : projectValue + '小时';
                } else if (clickData.chartConfig.fieldName === 'sample_frequency') {
                    projectValue = isNaN(projectValue) ? '未设置' : projectValue + '次';
                } else if (clickData.chartConfig.fieldName === 'isUsed') {
                    projectValue = projectValue === 1 ? '已用' : projectValue === 0 ? '未用' : '未设置';
                } else if (clickData.chartConfig.fieldName === 'isCancel') {
                    projectValue = projectValue === 1 ? '已作废' : projectValue === 0 ? '未作废' : '未设置';
                } else if (clickData.chartConfig.fieldName === 'high_frequency') {
                    projectValue = projectValue === '1' || projectValue === 1 ? '是' : projectValue === '0' || projectValue === 0 ? '否' : projectValue || '未设置';
                } else if (clickData.chartConfig.fieldName.includes('date') || clickData.chartConfig.fieldName.includes('time') || clickData.chartConfig.fieldName === 'reportReviewTime') {
                    if (projectValue && projectValue !== '未设置') {
                        try {
                            const date = new Date(projectValue);
                            if (!isNaN(date.getTime())) {
                                projectValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            projectValue = '无效日期';
                        }
                    }
                } else if (['priority', 'sample_type'].includes(clickData.chartConfig.fieldName)) {
                    if (projectValue && projectValue.trim() !== '') {
                        projectValue = projectValue.trim();
                    } else {
                        projectValue = projectValue || '未设置';
                    }
                } else if (clickData.chartConfig.fieldName === 'schedule') {
                    // 进度字段特殊处理 - 数据库值为0,1,2,3,4
                    if (projectValue !== null && projectValue !== undefined && projectValue !== '') {
                        // 将数字转换为对应的进度描述
                        const progressMap = {
                            '0': '未开始',
                            '1': '进行中',
                            '2': '已完成',
                            '3': '已暂停',
                            '4': '已取消'
                        };
                        projectValue = progressMap[projectValue.toString()] || `进度${projectValue}`;
                    } else {
                        projectValue = '未设置';
                    }
                }

                return projectValue === label;
            });

            // 显示筛选后的数据列表，就像默认图表一样
            showModalDataList(`${modalTitle} - ${label}`, filteredProjects, null, true);

            // 显示提示信息
            showFilterNotification(`${label}: 共找到 ${filteredProjects.length} 个项目`);
        }
    }

    // 显示保存图表的数据详情模态框
    function showSavedChartDataModal(clickData, label, value) {
        const { chartConfig, valueToProjects, projects } = clickData;

        // 获取对应标签的项目列表
        let filteredProjects = [];
        if (valueToProjects[label]) {
            filteredProjects = valueToProjects[label];
        } else {
            // 如果没有找到，尝试从原始数据中筛选
            filteredProjects = projects.filter(project => {
                let projectValue = project[chartConfig.fieldName];

                // 处理不同类型的值
                if (projectValue === null || projectValue === undefined || projectValue === '') {
                    projectValue = '未设置';
                } else if (chartConfig.fieldName === 'scheduleDays') {
                    projectValue = isNaN(projectValue) ? '未设置' : projectValue + '天';
                } else if (chartConfig.fieldName === 'testDuration') {
                    projectValue = isNaN(projectValue) ? '未设置' : projectValue + '小时';
                } else if (chartConfig.fieldName === 'sample_frequency') {
                    projectValue = isNaN(projectValue) ? '未设置' : projectValue + '次';
                } else if (chartConfig.fieldName === 'isUsed') {
                    projectValue = projectValue === 1 ? '已用' : value === 0 ? '未用' : '未设置';
                } else if (chartConfig.fieldName === 'isCancel') {
                    projectValue = projectValue === 1 ? '已作废' : projectValue === 0 ? '未作废' : '未设置';
                } else if (chartConfig.fieldName === 'high_frequency') {
                    projectValue = projectValue === '1' || projectValue === 1 ? '是' : projectValue === '0' || projectValue === 0 ? '否' : projectValue || '未设置';
                } else if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
                    if (projectValue && projectValue !== '未设置') {
                        try {
                            const date = new Date(projectValue);
                            if (!isNaN(date.getTime())) {
                                projectValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            projectValue = '无效日期';
                        }
                    }
                } else if (['priority', 'sample_type'].includes(chartConfig.fieldName)) {
                    if (projectValue && projectValue.trim() !== '') {
                        projectValue = projectValue.trim();
                    } else {
                        projectValue = '未设置';
                    }
                } else if (chartConfig.fieldName === 'schedule') {
                    // 进度字段特殊处理 - 数据库值为0,1,2,3,4
                    if (projectValue !== null && projectValue !== undefined && projectValue !== '') {
                        // 将数字转换为对应的进度描述
                        const progressMap = {
                            '0': '未开始',
                            '1': '进行中',
                            '2': '已完成',
                            '3': '已暂停',
                            '4': '已取消'
                        };
                        projectValue = progressMap[projectValue.toString()] || `进度${projectValue}`;
                    } else {
                        projectValue = '未设置';
                    }
                }

                return projectValue === label;
            });
        }

        // 创建数据详情模态框
        const modalHTML = `
                <div id="savedChartDataModal" class="modal">
                    <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90%; max-height: 800px;">
                        <div class="modal-header">
                            <h3>${chartConfig.title} - ${label} (${filteredProjects.length}个项目)</h3>
                            <span class="close" onclick="closeSavedChartDataModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span style="color: #666;">字段: ${chartConfig.fieldLabel}</span>
                                    <span style="color: #666;">|</span>
                                    <span style="color: #666;">图表类型: ${getChartTypeName(chartConfig.chartType)}</span>
                                    <span style="color: #666;">|</span>
                                    <span style="color: #666;">显示数量: 前${chartConfig.topN}个</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th>样品编号</th>
                                            <th>产品名称</th>
                                            <th>产品类别</th>
                                            <th>大编码</th>
                                            <th>物料编码</th>
                                            <th>版本</th>
                                            <th>项目负责人</th>
                                            <th>当前进度</th>
                                            <th>测试负责人</th>
                                            <th>DQE负责人</th>
                                            <th>研发负责人</th>
                                            <th>送样人</th>
                                            <th>送样类别</th>
                                            <th>送样数量</th>
                                            <th>是否高频</th>
                                            <th>提单时间</th>
                                            <th>排期天数</th>
                                            <th>排期开始</th>
                                            <th>排期结束</th>
                                            <th>实际开始时间</th>
                                            <th>实际完成时间</th>
                                            <th>DQE承认结果</th>
                                            <th>研发承认结果</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredProjects.map(project => {
                                            // 根据实际时间判断项目状态
                                            let statusText = '未开始';
                                            let statusColor = '#ffc107';

                                            if (project.actual_start_time && !project.actual_finish_time) {
                                                statusText = '进行中';
                                                statusColor = '#17a2b8';
                                            } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                                                statusText = '已完成未确认';
                                                statusColor = '#a72828';
                                            } else if (project.actual_finish_time && project.sampleRecognizeResult) {
                                                statusText = '报告确认闭环';
                                                statusColor = '#28a745';
                                            }

                                            return `
                                                <tr>
                                                    <td><strong>${project.sample_id || '-'}</strong></td>
                                                    <td>${project.sample_name || '-'}</td>
                                                    <td>${project.sample_category || '-'}</td>
                                                    <td>${project.sample_model || '-'}</td>
                                                    <td>${project.materialCode || '-'}</td>
                                                    <td>${project.version || '-'}</td>
                                                    <td>${project.sample_leader || '-'}</td>
                                                    <td>
                                                        <span style="color: ${statusColor}; font-weight: bold;">
                                                            ${statusText}
                                                        </span>
                                                    </td>
                                                    <td>${project.tester || '-'}</td>
                                                    <td>${project.dqe_leader || '-'}</td>
                                                    <td>${project.rd_leader || '-'}</td>
                                                    <td>${project.sample_sender || '-'}</td>
                                                    <td>${project.sample_type || '-'}</td>
                                                    <td>${project.sample_quantity || '-'}</td>
                                                    <td>${project.high_frequency || '-'}</td>
                                                    <td>${formatDateTime(project.create_time) || '-'}</td>
                                                    <td>${project.scheduleDays || '-'}</td>
                                                    <td>${formatDate(project.schedule_start_date) || '-'}</td>
                                                    <td>${formatDate(project.schedule_end_date) || '-'}</td>
                                                    <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                                                    <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                                                    <td>${project.sampleRecognizeResult || '-'}</td>
                                                    <td>${project.sampleRecognizeResult || '-'}</td>
                                                    <td>${project.rd_sampleRecognizeResult || '-'}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // 添加模态框到页面
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // 显示模态框
        document.getElementById('savedChartDataModal').style.display = 'block';
    }

    // 关闭保存图表的数据详情模态框
    function closeSavedChartDataModal() {
        const modal = document.getElementById('savedChartDataModal');
        if (modal) {
            modal.remove();
        }
    }





    // 转换为CSV格式
    function convertToCSV(data) {
        if (!data || data.length === 0) return '';
        
        const headers = Object.keys(data[0]);
        const csvRows = [];
        
        // 添加标题行
        csvRows.push(headers.join(','));
        
        // 添加数据行
        data.forEach(row => {
            const values = headers.map(header => {
                const value = row[header];
                // 处理包含逗号的值
                return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
            });
            csvRows.push(values.join(','));
        });
        
        return csvRows.join('\n');
    }

    // 应用数据限制
    function applyDataLimit(data, limit) {
        if (!data || typeof data !== 'object') return data;
        
        // 如果限制为0，显示全部数据
        if (limit === 0) return data;
        
        // 将数据转换为数组并按值排序
        const entries = Object.entries(data);
        const sortedEntries = entries.sort((a, b) => b[1] - a[1]);
        
        // 取前N个
        const limitedEntries = sortedEntries.slice(0, limit);
        
        // 转换回对象
        const limitedData = {};
        limitedEntries.forEach(([key, value]) => {
            limitedData[key] = value;
        });
        
        return limitedData;
    }

    // 更新图表显示限制
    function updateChartDisplayLimit() {
        const selectElement = document.getElementById('chartDisplayLimit');
        if (!selectElement) return;
        
        const newLimit = parseInt(selectElement.value);
        window.currentDisplayLimit = newLimit;
        
        // 直接刷新当前图表
        refreshCurrentChart();
    }

    // 切换显示模式
    function toggleDisplayMode() {
        console.log('toggleDisplayMode 被调用');
        const selectElement = document.getElementById('chartDisplayLimit');
        if (!selectElement) {
            console.log('没有找到选择器元素');
            return;
        }
        
        // 在常用选项之间切换
        const currentValue = parseInt(selectElement.value);
        let newValue;
        
        switch (currentValue) {
            case 10:
                newValue = 20;
                break;
            case 20:
                newValue = 50;
                break;
            case 50:
                newValue = 0;
                break;
            case 0:
                newValue = 10;
                break;
            default:
                newValue = 10;
        }
        
        console.log('切换从', currentValue, '到', newValue);
        selectElement.value = newValue;
        updateChartDisplayLimit();
    }

    // 刷新当前图表（直接方法）
    function refreshCurrentChart() {
        console.log('refreshCurrentChart 被调用');
        
        if (!window.currentChartConfigs || window.currentChartConfigs.length === 0) {
            console.log('没有找到图表配置');
            return;
        }
        
        // 找到当前显示的图表
        const chartDisplayArea = document.getElementById('chartDisplayArea');
        if (!chartDisplayArea) {
            console.log('没有找到图表显示区域');
            return;
        }
        
        // 尝试多种方式找到图表元素
        let currentChartElement = chartDisplayArea.querySelector('[id^="chart"]');
        if (!currentChartElement) {
            // 尝试查找所有可能的图表容器
            currentChartElement = chartDisplayArea.querySelector('div[id]');
        }
        if (!currentChartElement) {
            console.log('没有找到当前图表元素');
            return;
        }
        
        const currentChartId = currentChartElement.id;
        console.log('当前图表ID:', currentChartId);
        
        const config = window.currentChartConfigs.find(c => c.id === currentChartId);
        if (!config) {
            console.log('没有找到对应的图表配置，尝试使用第一个配置');
            // 如果找不到对应的配置，使用第一个配置
            const firstConfig = window.currentChartConfigs[0];
            if (firstConfig) {
                console.log('使用第一个配置:', firstConfig.title);
                // 重新生成整个图表显示区域
                const limitedData = applyDataLimit(firstConfig.data, window.currentDisplayLimit || 10);
                
                // 更新数据组数显示
                const dataCountElement = document.getElementById('currentDataCount');
                if (dataCountElement) {
                    const totalCount = Object.keys(firstConfig.data).length;
                    const displayCount = Object.keys(limitedData).length;
                    if (window.currentDisplayLimit === 0) {
                        dataCountElement.textContent = `全部(${totalCount})`;
                    } else if (displayCount < totalCount) {
                        dataCountElement.textContent = `${displayCount}/${totalCount}...`;
                    } else {
                        dataCountElement.textContent = `${displayCount}/${totalCount}`;
                    }
                }
                
                // 重新生成整个图表HTML
                const chartHTML = `
                    <div style="width: 100%; height: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #333; margin: 0; font-size: 18px; flex: 1;">${firstConfig.title}</h4>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <!-- 图表控制按钮 -->
                                <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <button class="zoom-btn" onclick="zoomChart('${firstConfig.id}', -1)" title="缩小" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">−</button>
                                    <button class="zoom-btn" onclick="zoomChart('${firstConfig.id}', 1)" title="放大" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('${firstConfig.id}', '${JSON.stringify(limitedData).replace(/"/g, '&quot;')}')" title="切换图表类型" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">📊</button>
                                </div>
                                <!-- 数据组数控制 -->
                                <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <span style="font-size: 12px; color: #666; font-weight: 500;">数据组数:</span>
                                    <select id="chartDisplayLimit" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s;" onchange="updateChartDisplayLimit()" onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='#ddd'">
                                        <option value="10" ${window.currentDisplayLimit === 10 ? 'selected' : ''}>前10组</option>
                                        <option value="20" ${window.currentDisplayLimit === 20 ? 'selected' : ''}>前20组</option>
                                        <option value="50" ${window.currentDisplayLimit === 50 ? 'selected' : ''}>前50组</option>
                                        <option value="0" ${window.currentDisplayLimit === 0 ? 'selected' : ''}>全部数据</option>
                                    </select>
                                    <span id="currentDataCount" style="font-size: 12px; color: #007bff; font-weight: 600; min-width: 40px; text-align: center;">${window.currentDisplayLimit === 0 ? `全部(${Object.keys(firstConfig.data).length})` : (Object.keys(limitedData).length < Object.keys(firstConfig.data).length ? `${Object.keys(limitedData).length}/${Object.keys(firstConfig.data).length}...` : `${Object.keys(limitedData).length}/${Object.keys(firstConfig.data).length}`)}</span>
                                    <button onclick="toggleDisplayMode()" style="background: #007bff; border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;" title="快速切换显示模式" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                        🔄
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="${firstConfig.id}" style="height: 450px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                            ${createBarChart(limitedData, firstConfig.id)}
                        </div>
                    </div>
                `;
                
                chartDisplayArea.innerHTML = chartHTML;
                
                // 重新绑定事件
                bindChartClickEvents(firstConfig.id);
                bindTooltipEvents(firstConfig.id);
                
                console.log('图表刷新完成（使用第一个配置）');
                return;
            }
        }
        
        console.log('找到图表配置:', config.title);
        
        // 应用数据限制
        const limitedData = applyDataLimit(config.data, window.currentDisplayLimit || 10);
        console.log('限制后的数据:', limitedData);
        
        // 更新数据组数显示
        const dataCountElement = document.getElementById('currentDataCount');
        if (dataCountElement) {
            const totalCount = Object.keys(config.data).length;
            const displayCount = Object.keys(limitedData).length;
            if (window.currentDisplayLimit === 0) {
                dataCountElement.textContent = `全部(${totalCount})`;
            } else if (displayCount < totalCount) {
                dataCountElement.textContent = `${displayCount}/${totalCount}...`;
            } else {
                dataCountElement.textContent = `${displayCount}/${totalCount}`;
            }
            console.log('更新数据组数显示:', dataCountElement.textContent);
        }
        
        // 检测当前图表类型并重新生成
        const svgElement = currentChartElement.querySelector('svg');
        const flexElement = currentChartElement.querySelector('div[style*="display: flex"]');
        
        console.log('SVG元素:', svgElement);
        console.log('Flex元素:', flexElement);
        
        if (svgElement) {
            // 当前是饼图，重新生成饼图
            console.log('重新生成饼图');
            currentChartElement.innerHTML = createPieChart(limitedData, currentChartId);
        } else if (flexElement) {
            // 当前是柱状图，重新生成柱状图
            console.log('重新生成柱状图');
            currentChartElement.innerHTML = createBarChart(limitedData, currentChartId);
        } else {
            // 默认生成柱状图
            console.log('默认生成柱状图');
            currentChartElement.innerHTML = createBarChart(limitedData, currentChartId);
        }
        
        // 重新绑定事件
        bindChartClickEvents(currentChartId);
        bindTooltipEvents(currentChartId);
        
        console.log('图表刷新完成');
    }
</script>

<!-- 自定义图表模态框 -->
<div id="dynamicChartModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90%; max-height: 800px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; border: none;">
            <h3 style="margin: 0; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 28px;">📊</span>
                自定义图表生成器
            </h3>
            <span class="close" onclick="closeDynamicChartModal()" style="color: white; font-size: 28px; font-weight: bold; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</span>
        </div>
        <div class="modal-body" style="padding: 30px; height: calc(100% - 80px); overflow-y: auto;">
            <!-- 控制面板 -->
            <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block; font-size: 14px;">📋 选择分析字段</label>
                        <select id="fieldSelector" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                            <option value="">请选择要分析的字段</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block; font-size: 14px;">📈 图表类型</label>
                        <select id="chartTypeSelector" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                            <option value="bar">📊 柱状图</option>
                            <option value="pie">🥧 饼图</option>
                            <option value="line">📈 折线图</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                    <div>
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block; font-size: 14px;">🔢 显示数量</label>
                        <input type="number" id="topNSelector" value="10" min="1" max="50" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                        <span style="color: #6c757d; font-size: 12px; margin-top: 4px; display: block;">显示前N个最多的值</span>
                    </div>
                    <div style="display: flex; align-items: end; gap: 12px;">
                        <button onclick="generateDynamicChart()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                            🚀 生成图表
                        </button>
                    </div>
                    <div style="display: flex; align-items: end; gap: 12px;">
                        <button onclick="saveChartToProjectDetails()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                            💾 保存图表
                        </button>
                        <button onclick="clearDynamicChart()" style="background: #6c757d; border: none; color: white; padding: 12px 16px; border-radius: 10px; font-size: 14px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0)'">
                            🗑️
                        </button>
                    </div>
                </div>
            </div>

            <!-- 图表显示区域 -->
            <div id="dynamicChartContainer" style="height: 500px; border: 2px dashed #e9ecef; border-radius: 16px; padding: 30px; background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); display: flex; align-items: center; justify-content: center; margin-bottom: 25px; transition: all 0.3s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e9ecef'">
                <div style="text-align: center; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.6;">📊</div>
                    <p style="font-size: 16px; margin: 0; font-weight: 500;">请选择字段并点击"生成图表"按钮</p>
                    <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.7;">支持柱状图、饼图和折线图三种类型</p>
                </div>
            </div>

            <!-- 已保存的图表列表 -->
            <div style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #2c3e50; margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span>📚</span>
                        已保存的图表
                    </h4>
                </div>
                <div id="savedChartsList" style="max-height: 300px; overflow-y: auto; padding-right: 8px;">
                    <!-- 动态填充已保存的图表 -->
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
</html>
