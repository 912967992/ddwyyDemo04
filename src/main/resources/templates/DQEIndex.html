<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>研发质量管理系统主页</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/DQEIndexStyle.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        /* 代理人设置模态框样式 */
        .agent-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }
        
        .agentInput {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .agentInput:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .remove-agent-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: background-color 0.3s ease;
        }
        
        .remove-agent-btn:hover {
            background: #ff3742;
        }
        
        .agent-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-agent-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .add-agent-btn:hover:not(:disabled) {
            background: #218838;
        }
        
        .add-agent-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .save-agents-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .save-agents-btn:hover:not(:disabled) {
            background: #0056b3;
        }
        
        .save-agents-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        #agentTips {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        
        #agentTips p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        /* 设置代理人按钮样式 */
        #setupAgentBtn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s ease;
        }
        
        #setupAgentBtn:hover {
            background: #138496;
        }
    </style>


</head>
<body>

    <!-- 现代化页面头部 -->
    <div class="page-header">
        <div class="header-content">
            <div class="title-section">
                <div class="title-icon">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="title-text">
                    <h1 id="indexTitle">研发质量管理系统</h1>
<!--                    <p class="subtitle">智能项目管理与质量监控平台</p>-->
                </div>
            </div>
            
            <!-- 项目统计汇总卡片 -->
            <div class="stats-grid">
                <div class="stat-card primary" onclick="showProjectModal('ladingBillWaitTest')">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="ladingBillWaitTest">0</div>
                        <div class="stat-label">提单待测试</div>
                    </div>
                </div>

                <div class="stat-card warning" onclick="showProjectModal('testing')">
                    <div class="stat-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="testing">0</div>
                        <div class="stat-label">测试进行中</div>
                    </div>
                </div>

                <div class="stat-card info" onclick="showProjectModal('recentCount')">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="recentCount">0</div>
                        <div class="stat-label">完成待审核</div>
                    </div>
                </div>

                <div class="stat-card danger" onclick="showProjectModal('overdueCount')">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="overdueCount">0</div>
                        <div class="stat-label">节点超期项目</div>
                    </div>
                </div>

                <div class="stat-card success" onclick="showProjectModal('closedCount')">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="closedCount">0</div>
                        <div class="stat-label">报告完成确认</div>
                    </div>
                </div>

                <div class="stat-card total" onclick="showProjectModal('projectCount')">
                    <div class="stat-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="projectCount">0</div>
                        <div class="stat-label">项目总数</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 控制中心切换按钮 -->
    <button id="controlPanelToggle" class="control-panel-toggle">
        <i class="fas fa-cog"></i>
    </button>

    <!-- 现代化侧边控制面板 -->
    <div class="control-panel" id="controlPanel">
        <div class="panel-header">
            <div class="panel-icon">
                <i class="fas fa-cog"></i>
            </div>
            <h3>控制中心</h3>
            <button id="closeControlPanel" class="close-control-panel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="panel-section">
            <button id="downloadGuidelineBtn" class="modern-btn primary">
                <i class="fas fa-download"></i>
                <span>操作指导书下载</span>
            </button>
        </div>

        <div id="buttonContainer" class="panel-section"></div>

        <!-- 角色切换区域 -->
        <div class="panel-section">
            <h4 class="section-title">角色切换</h4>
            <div id="buttonsDiv" class="role-buttons">
                <button id="dqeBtn" class="role-btn">
                    <i class="fas fa-shield-alt"></i>
                    <span>DQE</span>
                </button>
                <button id="rdBtn" class="role-btn">
                    <i class="fas fa-code"></i>
                    <span>研发</span>
                </button>
                <button id="projectBtn" class="role-btn">
                    <i class="fas fa-project-diagram"></i>
                    <span>项目</span>
                </button>
                <button id="managerBtn" class="role-btn">
                    <i class="fas fa-user-tie"></i>
                    <span>主管</span>
                </button>
            </div>
        </div>

        <!-- 用户信息区域 -->
        <div class="panel-section">
            <h4 class="section-title">用户信息</h4>
            <div id="usernameDiv" class="user-input-group">
                <div class="input-wrapper">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="usernameInput" placeholder="输入你的名字" />
                </div>
                <button id="saveUsernameBtn" class="modern-btn success">
                    <i class="fas fa-save"></i>
                    <span>保存</span>
                </button>
            </div>
        </div>

        <!-- 项目管理按钮 -->
        <div class="panel-section">
            <h4 class="section-title">项目管理</h4>
            <div class="project-buttons">
                <button id="viewOverdueButton" class="modern-btn danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>查看超时项目</span>
                </button>
                <button id="viewRecentNotificationsButton" class="modern-btn info">
                    <i class="fas fa-bell"></i>
                    <span>查看近期通知</span>
                </button>
                <button id="setupAgentBtn" class="modern-btn secondary">
                    <i class="fas fa-user-friends"></i>
                    <span>设置代理人</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 管理配置模态框 -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">配置选项</h2>
            <div class="input-group">
                <label for="warningDays" id="warningLabel">警示天数：</label>
                <input type="number" id="warningDays" value="2" min="0">
            </div>
            <button id="saveButton">保存</button>
        </div>
    </div>

    <!-- 超时项目模态框 -->
    <div id="overdueModal" class="modal">
        <div class="modal-content">
            <span class="close overdue-close">&times;</span>
            <div class="modal-header-mobile">
                <h3>超时项目列表</h3>
                <div class="search-controls">
                    <input type="text" id="overdueSearch" placeholder="输入关键字搜索..." class="search-input">
                    <button onclick="searchOverdueTable()" class="search-btn">搜索</button>
                    <button id="saveOverdueReasons" class="save-btn">提交超时原因</button>
                </div>
            </div>

            <div class="table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table id="overdueTable">
                    <thead>
                    <tr>
                        <th>列表ID</th>
                        <th>样品ID</th>
                        <th>超时节点</th>
                        <th>当前进度</th>
                        <th>创建时间</th>
                        <th>警告时间</th>
                        <th>第一次超时通知主管时间</th>
                        <th>第二次超时通知经理时间</th>
                        <th>大小编码</th>
                        <th>大类</th>
                        <th>小类</th>
                        <th>类别</th>
                        <th>版本</th>
                        <th>任务属性</th>
                        <th>节点负责人</th>
                        <th>超期原因<br>(点上方按钮保存)</th>
                    </tr>
                    </thead>
                    <tbody id="overdueProjectList"></tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- 代理人设置模态框 -->
    <div id="agentModal" class="modal">
        <div class="modal-content">
            <span class="close agent-close">&times;</span>
            <h2>设置授权代理人</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">设置代理人在您不在时可以帮助处理相关事务</p>
            <div id="agentList">
                <div class="agent-input-group">
                    <input type="text" class="agentInput" placeholder="输入代理人姓名" maxlength="20">
                    <button type="button" class="remove-agent-btn" style="display: none;">×</button>
                </div>
            </div>
            <div class="agent-buttons">
                <button id="addAgentBtn" class="add-agent-btn">+ 添加代理人</button>
                <button id="saveAgentsBtn" class="save-agents-btn">保存设置</button>
            </div>
            <div id="agentTips" style="margin-top: 10px; font-size: 12px; color: #999;">
                <p>• 最多可设置5个代理人</p>
                <p>• 代理人姓名不能为空</p>
                <p>• 代理人名字请跟钉钉名字统一，有数字记得也要带上</p>
                <p>• 点击×按钮可删除对应代理人</p>
            </div>
        </div>
    </div>
    <!-- 近期通知项目模态框 -->
    <div id="recentNotificationsModal" class="modal">
        <div class="modal-content">
            <span class="close recent-notifications-close">&times;</span>
            <h2>近期通知项目列表</h2>
            <div class="table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table id="recentNotificationsTable">
                    <thead>
                    <tr>
                        <th>列表ID</th>
                        <th>样品ID</th>
                        <th>通知节点</th>
                        <th>当前进度</th>
                        <th>创建时间</th>
                        <th>超时预警时间</th>
                        <th>大小编码</th>
                        <th>大类</th>
                        <th>小类</th>
                        <th>类别</th>
                        <th>版本</th>
                        <th>任务属性</th>
                        <th>节点负责人</th>
                    </tr>
                    </thead>
                    <tbody id="recentNotificationsProjectList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 项目详情模态框 -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content">
            <span class="close project-detail-close">&times;</span>
            <h2 id="projectDetailTitle">项目详情列表</h2>
            <div class="table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table id="projectDetailTable">
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>样品ID</th>
                        <th>当前节点</th>
                        <th>当前进度</th>
                        <th>创建时间</th>
                        <th>大小编码</th>
                        <th>大类</th>
                        <th>大货/功能</th>
                        <th>类别</th>
                        <th>版本</th>
                        <th>节点负责人</th>
                    </tr>
                    </thead>
                    <tbody id="projectDetailList"></tbody>
                </table>
            </div>
        </div>
    </div>


    <div class="main-container">
        <!-- 数据看板 - 改为使用现代化卡片设计 -->
        <div class="dashboard-card" onclick="goToDashboard()">
            <div class="card-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="card-content">
                <h3>数据看板</h3>
                <p>项目统计和数据分析</p>
            </div>
            <div class="card-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </div>

        <div class="dashboard-card" onclick="goToSmartProjectAnalyzer()">
            <div class="card-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="card-content">
                <h3>智能项目识别与统计分析系统</h3>
                <p>AI驱动的项目智能分析</p>
            </div>
            <div class="card-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </div>

        <div class="grid-container">
            <div class="module-card highlighted" onclick="redirectToPage()">
                <div class="card-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="card-content">
                    <h3>DQE/研发审核</h3>
                    <p>质量审核管理</p>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>
            
            <div class="module-card highlighted" onclick="checkProblemLibraryPermission()">
                <div class="card-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="card-content">
                    <h3>问题点库管理</h3>
                    <p>问题库维护</p>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>
            
            <div class="module-card highlighted" onclick="goToReviewResult()">
                <div class="card-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="card-content">
                    <h3>新品质量问题管理</h3>
                    <p>评审问题相关</p>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>
            
            <div class="module-card highlighted" onclick="goToQualityProgress()">
                <div class="card-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="card-content">
                    <h3>新品质量进度管理</h3>
                    <p>任务状态大盘</p>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>
            
            <div class="module-card highlighted" onclick="location.href='/labModuleTester'">
                <div class="card-icon">
                    <i class="fas fa-flask"></i>
                </div>
                <div class="card-content">
                    <h3>实验室模块</h3>
                    <p>实验测试管理</p>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>
            
            <div class="module-card highlighted" onclick="goToScheduleBoard()">
                <div class="card-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="card-content">
                    <h3>项目排期</h3>
                    <p>项目进度管理</p>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>
            
            <div class="module-card" onclick="checkAndRedirect()">
                <div class="card-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="card-content">
                    <h3>其他模块</h3>
                    <p>更多功能</p>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </div>
        </div>
    </div>



    <!-- 现代化底部导航栏 -->
    <div class="btn-container">
        <hr class="divider"> <!-- 按钮上方的横线 -->
        <!-- 主页按钮 -->
        <button class="btn" id="homeBtn" title="主页">
            <i class="fas fa-home"></i>
        </button>
        <!-- 搜索资源库按钮 -->
        <button class="btn" id="cloudBtn" title="搜索资源库">
            <i class="fas fa-cloud"></i>
        </button>
        <!-- 个人界面按钮 -->
        <button class="btn" id="profileBtn" title="个人中心">
            <i class="fas fa-user"></i>
        </button>
    </div>

    <!-- 模态框结构 -->
    <div id="guidelineModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000;">
        <p style="margin: 0 0 20px;">注意：手机端下载此指导书需要先在钉钉创建一个钉盘的文件夹，不然您最后无法选择确认并发送，PC端则不用。此按钮原理是先把文件下载到钉盘再转发给你实现在线编辑查看的功能，此为钉钉官方应用的bug。</p>
        <button id="closeModal" style="background-color: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px;">关闭</button>
    </div>
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

    <!-- 下载按钮 -->
<!--    <button id="downloadGuidelineBtn">下载操作指导书</button>-->



    <!-- 确认模态框的 HTML 结构 -->
    <div id="confirm-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div id="confirm-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
            <div id="confirm-message" style="margin-bottom: 20px;">确认信息</div>
            <button id="confirm-yes" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">确认</button>
            <button id="confirm-no" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">取消</button>
        </div>
    </div>


    <!-- 模态框的 HTML 结构 -->
    <div id="alert-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1005;">
        <div id="alert-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
            <div id="alert-message" style="margin-bottom: 20px;">提示信息</div>
            <button id="alert-confirm" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">确认</button>
        </div>
    </div>

    <script>
        // 移动端检测和优化
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768);
        }
        
        // 移动端触摸优化
        function addTouchOptimizations() {
            if (isMobileDevice()) {
                // 为所有可点击元素添加触摸反馈
                const clickableElements = document.querySelectorAll('.module-card, .dashboard-card, .stat-card, .modern-btn, .role-btn, .btn');
                clickableElements.forEach(element => {
                    element.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.95)';
                    });
                    element.addEventListener('touchend', function() {
                        this.style.transform = 'scale(1)';
                    });
                });
                
                // 优化模态框在移动端的显示
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.addEventListener('show', function() {
                        document.body.style.overflow = 'hidden';
                    });
                    modal.addEventListener('hide', function() {
                        document.body.style.overflow = 'auto';
                    });
                });
            }
        }
        
        // 页面加载完成后应用移动端优化
        document.addEventListener('DOMContentLoaded', function() {
            addTouchOptimizations();
            initControlPanel();
            initBottomButtons();
        });
        
        // 初始化底部按钮
        function initBottomButtons() {
            const buttons = document.querySelectorAll('.btn');
            
            buttons.forEach(button => {
                // 添加点击波纹效果
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
                
                // 添加键盘支持
                button.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        }
        
        // 初始化控制面板
        function initControlPanel() {
            const controlPanel = document.getElementById('controlPanel');
            const toggleBtn = document.getElementById('controlPanelToggle');
            const closeBtn = document.getElementById('closeControlPanel');
            
            // 切换控制面板显示/隐藏
            toggleBtn.addEventListener('click', function() {
                controlPanel.classList.toggle('show');
                if (controlPanel.classList.contains('show')) {
                    toggleBtn.style.display = 'none';
                }
            });
            
            // 关闭控制面板
            closeBtn.addEventListener('click', function() {
                controlPanel.classList.remove('show');
                toggleBtn.style.display = 'flex';
            });
            
            // 点击控制面板外部区域关闭面板
            document.addEventListener('click', function(event) {
                if (!controlPanel.contains(event.target) && !toggleBtn.contains(event.target)) {
                    controlPanel.classList.remove('show');
                    toggleBtn.style.display = 'flex';
                }
            });
            
            // 移动端特殊处理
            if (isMobileDevice()) {
                // 在移动端，控制面板从上方滑入
                controlPanel.style.transform = 'translateY(-100%)';
                controlPanel.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            }
        }

        function checkAndRedirect() {
            if (username === "许梦瑶"||username === "姚遥" ||username === "卢健"  || username === "占海英" || username === "陈少侠" || username === "郭丽纯" || username === "刘定荣" || username === "卢绮敏") {
                location.href = "/loginTestEnvironment";
            } else {
                alert("您无权限进入该页面");
            }

        }

        function checkProblemLibraryPermission() {
            const allowedUsers = ['邓小英', '邓令章', '卢健','许梦瑶','卢绮敏', '李良健', '黄家灿', '荣成彧'];
            if (allowedUsers.includes(username)) {
                // 检查是否在钉钉环境中
                const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
                const url = 'http://219.134.191.195:64000/problemLibraryManage?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
                // const url = 'http://e888ccd6.natappfree.cc/problemLibraryManage?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);

                if (isDingTalk) {
                    // 在钉钉环境中，先保存用户信息到localStorage，然后跳转
                    localStorage.setItem('username', username);
                    localStorage.setItem('job', job);
                    
                    dd.openLink({
                        url: url,
                        success: function() {
                            console.log('成功打开问题点库管理页面');
                        },
                        fail: function(err) {
                            alert('打开页面失败：' + JSON.stringify(err));
                            console.error('dd.openLink fail:', err);
                        }
                    });
                } else {
                    // 非钉钉环境使用普通跳转
                    window.location.href = url;
                }
            } else {
                alert("您无权限进入问题点库管理页面");
            }
            // // 检查是否在钉钉环境中
            // const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
            // const url = 'http://219.134.191.195:64000/problemLibraryManage?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
            // // const url = 'http://e888ccd6.natappfree.cc/problemLibraryManage?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
            //
            // if (isDingTalk) {
            //     dd.openLink({
            //         url: url,
            //         success: function() {
            //             console.log('成功打开问题点库管理页面');
            //         },
            //         fail: function(err) {
            //             alert('打开页面失败：' + JSON.stringify(err));
            //             console.error('dd.openLink fail:', err);
            //         }
            //     });
            // } else {
            //     // 非钉钉环境使用普通跳转
            //     window.location.href = url;
            // }
        }

        function goToScheduleBoard() {
            if (username === "许梦瑶"||username === "姚遥" ||username === "卢健"  || username === "占海英" || username === "陈少侠" || username === "郭丽纯" || username === "刘定荣" || username === "卢绮敏" || username === "李良健") {
                // 检查是否在钉钉环境中
                const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';

                const url = 'http://219.134.191.195:64000/scheduleBoard?username=' + encodeURIComponent(username);
                // const url = 'http://e888ccd6.natappfree.cc/scheduleBoard?username=' + encodeURIComponent(username);

                if (isDingTalk) {
                    // 在钉钉环境中，先保存用户信息到localStorage，然后跳转
                    localStorage.setItem('username', username);
                    localStorage.setItem('job', job);
                    
                    dd.openLink({
                        url: url,
                        success: function() {
                            console.log('成功打开项目排期看板');
                        },
                        fail: function(err) {
                            alert('打开页面失败：' + JSON.stringify(err));
                            console.error('dd.openLink fail:', err);
                        }
                    });
                } else {
                    // 非钉钉环境使用普通跳转
                    window.location.href = url;
                }
            } else {
                alert("您无权限进入该页面");
            }
        }

        // 跳转到评审结果页面
        function goToReviewResult() {
            if (!username) {
                alert("请先输入用户名！");
                return;
            }
            
            if (!job) {
                alert("请先选择角色！");
                return;
            }

            // 只检查角色是否为DQE
            if (job === 'DQE' || job === 'manager') {
                // 检查是否在钉钉环境中
                const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
                const url = 'http://219.134.191.195:64000/reviewResults?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
                // const url = 'http://e888ccd6.natappfree.cc/reviewResults?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);

                if (isDingTalk) {
                    // 在钉钉环境中，先保存用户信息到localStorage，然后跳转
                    localStorage.setItem('username', username);
                    localStorage.setItem('job', job);
                    
                    dd.openLink({
                        url: url,
                        success: function() {
                            console.log('成功打开问题点库管理页面');
                        },
                        fail: function(err) {
                            alert('打开页面失败：' + JSON.stringify(err));
                            console.error('dd.openLink fail:', err);
                        }
                    });
                } else {
                    // 非钉钉环境使用普通跳转
                    window.location.href = url;
                }
            } else {
                alert("只有DQE角色才能进入问题点库管理页面");
            }

        }

        // 跳转到新品质量进度管理页面
        function goToQualityProgress() {
            if (!username) {
                alert("请先输入用户名！");
                return;
            }
            
            if (!job) {
                alert("请先选择角色！");
                return;
            }

            if (job === 'DQE' || job === 'manager') {
                // 检查是否在钉钉环境中
                const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
                const url = 'http://219.134.191.195:64000/qualityProgress?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);

                if (isDingTalk) {
                    // 在钉钉环境中，先保存用户信息到localStorage，然后跳转
                    localStorage.setItem('username', username);
                    localStorage.setItem('job', job);
                    
                    dd.openLink({
                        url: url,
                        success: function() {
                            console.log('成功打开新品质量进度管理页面');
                        },
                        fail: function(err) {
                            alert('打开页面失败：' + JSON.stringify(err));
                            console.error('dd.openLink fail:', err);
                        }
                    });
                } else {
                    // 非钉钉环境使用普通跳转
                    window.location.href = url;
                }
            }

        }

        // 根据角色跳转到不同的数据看板页面
        function goToDashboard() {
            if (!username) {
                alert("请先输入用户名！");
                return;
            }
            
            if (!job) {
                alert("请先选择角色！");
                return;
            }

            // 检查是否在钉钉环境中
            const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
            const url = 'http://219.134.191.195:64000/' + getDashboardPath(job) + '?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
            // const url = 'http://x446fd53.natappfree.cc/' + getDashboardPath(job) + '?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);

            if (isDingTalk) {
                // 在钉钉环境中，先保存用户信息到localStorage，然后跳转
                localStorage.setItem('username', username);
                localStorage.setItem('job', job);
                
                dd.openLink({
                    url: url,
                    success: function() {
                        console.log('成功打开 ' + job + ' 看板');
                    },
                    fail: function(err) {
                        alert('打开页面失败：' + JSON.stringify(err));
                        console.error('dd.openLink fail:', err);
                    }
                });
            } else {
                // 非钉钉环境使用普通跳转
                window.location.href = url;
            }
        }

        // 跳转到智能项目识别与统计分析系统
        function goToSmartProjectAnalyzer() {
            if (!username) {
                alert("请先输入用户名！");
                return;
            }
            
            if (!job) {
                alert("请先选择角色！");
                return;
            }

            if(job === 'manager'){

                // 检查是否在钉钉环境中
                const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
                const url = 'http://219.134.191.195:64000/smart-project-analyzer?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);

                if (isDingTalk) {
                    // 在钉钉环境中，先保存用户信息到localStorage，然后跳转
                    localStorage.setItem('username', username);
                    localStorage.setItem('job', job);
                    
                    dd.openLink({
                        url: url,
                        success: function() {
                            console.log('成功打开智能项目识别与统计分析系统');
                        },
                        fail: function(err) {
                            alert('打开页面失败：' + JSON.stringify(err));
                            console.error('dd.openLink fail:', err);
                        }
                    });
                } else {
                    // 非钉钉环境使用普通跳转
                    window.location.href = url;
                }
            }else{
                alert("只有李良健才有权限进入该页面")
            }

        }

        // 辅助函数：根据角色获取看板路径
        function getDashboardPath(job) {
            switch(job) {
                case 'DQE':
                case 'projectLeader':
                    return 'dqeDashboard';
                case 'rd':
                    return 'rdDashboard';
                case 'manager':
                    return 'managerboard';
                default:
                    return 'managerboard';
            }
        }

        // 覆盖原生 alert 方法
        window.alert = function(message) {
            // 获取模态框元素
            const overlay = document.getElementById('alert-overlay');
            const modal = document.getElementById('alert-modal');
            const messageElem = document.getElementById('alert-message');
            const confirmButton = document.getElementById('alert-confirm');

            // 设置消息文本
            messageElem.textContent = message;

            // 显示模态框
            overlay.style.display = 'block';
            modal.style.display = 'block';

            // 点击确认按钮时关闭模态框
            confirmButton.onclick = () => {
                overlay.style.display = 'none';
                modal.style.display = 'none';
                // 调用原本的alert回调
            };
        };


    // 覆盖原生 confirm 方法
    window.confirm = function(message) {
        return new Promise(function(resolve, reject) {
            const overlay = document.getElementById('confirm-overlay');
            const modal = document.getElementById('confirm-modal');
            const messageElem = document.getElementById('confirm-message');
            const yesButton = document.getElementById('confirm-yes');
            const noButton = document.getElementById('confirm-no');

            // 设置消息文本
            messageElem.textContent = message;

            // 显示模态框
            overlay.style.display = 'block';
            modal.style.display = 'block';

            // 点击“确认”按钮时，关闭模态框并返回 true
            yesButton.onclick = () => {
                overlay.style.display = 'none';
                modal.style.display = 'none';
                resolve(true); // 返回 true 表示用户点击了确认
            };

            // 点击“取消”按钮时，关闭模态框并返回 false
            noButton.onclick = () => {
                overlay.style.display = 'none';
                modal.style.display = 'none';
                reject(false); // 返回 false 表示用户点击了取消
            };
        });
    };



    // 将数据保存到 localStorage
    let username = localStorage.getItem('username');
    let job = localStorage.getItem('job');

    // 更新用户名和职位的函数
    const buttonsDiv = document.getElementById('buttonsDiv');
    const usernameDiv = document.getElementById('usernameDiv')

    const corp_id = localStorage.getItem('corp_id');
    readyConfig();

    // 页面加载完成后获取项目统计数据
    document.addEventListener('DOMContentLoaded', function() {
        if (username) {
            updateProjectSummary();
        }
    });

    // 更新项目统计汇总的函数
    function updateProjectSummary() {
        if (!username) return;

        // 获取项目统计信息（包括提单待测试和测试进行中的数量）
        fetch(`/DQEIndex/getProjectTotal?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新提单待测试的数量
                    document.getElementById('ladingBillWaitTest').textContent = data.ladingBillWaitTest || 0;
                    
                    // 更新测试进行中的数量
                    document.getElementById('testing').textContent = data.testing || 0;
                    
                    // 更新闭环完成的数量
                    document.getElementById('closedCount').textContent = data.closedCount || 0;
                    
                    document.getElementById('projectCount').textContent = data.projectCount || 0;
                } else {
                    console.error("获取项目统计信息失败:", data.error);
                }
            })
            .catch(error => console.error("获取项目统计信息时出错:", error));

        // 获取近期通知项目数量
        fetch(`/DQEIndex/getRecentNotifications?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                let recentCount = 0;
                data.forEach(combinedTaskNode => {
                    let personInCharge = "";
                    if (combinedTaskNode.taskNode.node_number === "1") {
                        personInCharge = combinedTaskNode.dqe;
                    } else if (combinedTaskNode.taskNode.node_number === "2") {
                        personInCharge = combinedTaskNode.rd;
                    } else if (combinedTaskNode.taskNode.node_number === "4") {
                        personInCharge = combinedTaskNode.projectLeader;
                    }
                    
                    if (personInCharge === username) {
                        recentCount++;
                    }
                });
                
                document.getElementById('recentCount').textContent = recentCount;
            })
            .catch(error => console.error("获取近期通知项目数量时出错:", error));
        
        // 获取超期项目数量
        fetch('/DQEIndex/getOverdueSample')
            .then(response => response.json())
            .then(data => {
                let overdueCount = 0;
                data.forEach(combinedTaskNode => {
                    const personInCharge = ["1", "3"].includes(String(combinedTaskNode.taskNode.node_number))
                        ? combinedTaskNode.dqe
                        : String(combinedTaskNode.taskNode.node_number) === "2"
                            ? combinedTaskNode.rd ? combinedTaskNode.rd : ""
                            : "";
                    
                    // 根据 Job 过滤数据
                    let shouldDisplay = false;
                    if (job === "DQE" || job === "manager") {
                        shouldDisplay = ["1", "3"].includes(String(combinedTaskNode.taskNode.node_number));
                    } else if (job === "rd") {
                        shouldDisplay = String(combinedTaskNode.taskNode.node_number) === "2";
                    }
                    
                    if (shouldDisplay && personInCharge === username) {
                        overdueCount++;
                    }
                });
                
                document.getElementById('overdueCount').textContent = overdueCount;
            })
            .catch(error => console.error("获取超期项目数量时出错:", error));
    }


    function readyConfig(){
        // 调用后端接口获取配置信息
        $.ajax({
            url: '/getJsapiConfig',
            type: 'GET',
            data: { url: encodeURIComponent(location.href.split('#')[0]) },
            success: function(config) {
                // 使用获取的配置信息初始化钉钉JSAPI
                dd.config({
                    agentId: config.agentId,
                    corpId: config.corpId,
                    timeStamp: config.timeStamp,
                    nonceStr: config.nonceStr,
                    signature: config.signature,
                    jsApiList: config.jsApiList // 必填，需要使用的jsapi列表
                });

            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

        document.getElementById('downloadGuidelineBtn').addEventListener('click', function() {
            // 显示模态框
            document.getElementById('guidelineModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        });

        // 关闭模态框
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('guidelineModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            // 开始下载指导书
            downloadGuideline();
        });

        // 点击遮罩层也关闭模态框
        document.getElementById('modalOverlay').addEventListener('click', function() {
            document.getElementById('guidelineModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        });



    //下载操作指导书的按钮方法
    // document.getElementById('downloadGuidelineBtn').addEventListener('click', function() {
    //     alert("注意：手机端下载此指导书需要先在钉钉创建一个钉盘的文件夹，不然您最后无法选择确认并发送，PC端则不用，此按钮原理是先把文件下载到钉盘再转发给你实现在线编辑查看的功能，此为钉钉官方应用的bug。")
    //     downloadGuideline();
    // });

    function downloadGuideline() {
        // 固定文件路径
        // const filePath = "C:\\ddwyy-lj\\templatesDirectory\\研发质量管理系统操作指导V2.0.docx";
        const filePath = "Z:\\ddwyy-lj\\templatesDirectory\\研发质量管理系统操作指导20250718.docx";
        const fileName = "研发质量管理系统操作指导20250718.docx"; // 固定文件名

        // if (!confirm('文件较大，转发可能需要较长时间。是否继续？')) {
        //     return; // 用户选择不上传
        // }

        // 选择联系人
        dd.biz.contact.choose({
            multiple: false,
            users: [],
            corpId: corp_id,
            max: 1,
            onSuccess: function(data) {
                const selectedUserId = data[0].emplId; // 获取单个用户ID

                // 选择钉盘目录
                dd.chooseDingTalkDir({
                    corpId: corp_id, // 企业ID
                    onSuccess: function(res) {
                        const selectedDirId = res.data[0].dirId; // 获取选中的目录ID
                        const selectedSpaceId = res.data[0].spaceId; // 获取选中的空间ID

                        // 获取应用免登授权码
                        dd.runtime.permission.requestAuthCode({
                            corpId: corp_id,
                            onSuccess: function(result) {
                                const authCode = result.code; // 获取到授权码
                                // 发起后端请求上传文件和发送文件
                                $.ajax({
                                    url: '/testManIndex/uploadFileToDingtalk',
                                    type: 'POST',
                                    data: {
                                        filepath: filePath, // 使用固定的文件路径
                                        dirId: selectedDirId,
                                        spaceId: selectedSpaceId,
                                        authCode: authCode,
                                        receiverId: selectedUserId,
                                        username : username
                                    },
                                    success: function(response) {
                                        alert('文件上传并发送成功');
                                        // hideLoading(); // 隐藏加载提示框
                                    },
                                    error: function(xhr, status, error) {
                                        alert('文件上传发送失败: ' + error);
                                        // hideLoading(); // 隐藏加载提示框
                                    }
                                });
                            },
                            onFail: function(err) {
                                alert('获取授权码失败：' + JSON.stringify(err));
                                // hideLoading(); // 隐藏加载提示框
                            }
                        });
                    },
                    fail: function(err) {
                        alert('选择目录失败：' + JSON.stringify(err));
                        // hideLoading(); // 隐藏加载提示框
                    },
                    onCancel: function() {
                        alert('选择目录取消');
                        // hideLoading(); // 隐藏加载提示框
                    }
                });
            },
            onFail: function(err) {
                alert("选择联系人出错" + err);
                // hideLoading(); // 隐藏加载提示框
            }
        });
    }



    // 更新用户名和职位的函数
    function updateUserInfo(newJob) {
        job = newJob;
        localStorage.setItem('job', job);  // 更新 localStorage 中的职位信息
        alert("当前职位: " + job);
    }

    // 如果用户名是 "卢健"，显示切换职位按钮
    if (username === '卢健') {
        buttonsDiv.style.display = 'block';  // 显示按钮
        usernameDiv.style.display = 'block';
    } else {
        buttonsDiv.style.display = 'none';  // 隐藏按钮
        usernameDiv.style.display = 'none';
    }

    // 为按钮添加点击事件，切换职位并更新 localStorage
    document.getElementById('dqeBtn').addEventListener('click', function() {
        updateUserInfo('DQE');
        updateProjectSummary();
    });
    document.getElementById('rdBtn').addEventListener('click', function() {
        updateUserInfo('rd');
        updateProjectSummary();
    });
    document.getElementById('projectBtn').addEventListener('click', function() {
        updateUserInfo('projectLeader');
        updateProjectSummary();
    });
    document.getElementById('managerBtn').addEventListener('click', function() {
        updateUserInfo('manager');
        updateProjectSummary();
    });

    document.getElementById('saveUsernameBtn').addEventListener('click',function (){
        const usernameInput = document.getElementById('usernameInput');
        username = usernameInput.value.trim(); // 去除多余空格
        if (username) {
            localStorage.setItem('username', username); // 更新 localStorage 中的用户名
            alert("用户名已更新为: " + username);
            // 更新项目统计
            updateProjectSummary();
        } else {
            alert("请输入有效的名字！");
        }
    });

    function redirectToPage() {
        if (!username) {
            alert("请先输入用户名！");
            return;
        }
        
        if (!job) {
            alert("请先选择角色！");
            return;
        }

        // 检查是否在钉钉环境中
        const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
        
        let url;
        if (job === 'projectLeader') {
            url = 'http://219.134.191.195:64000/ProjectLeaderMoudle?dd_orientation=landscape&username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
            // url = 'http://e888ccd6.natappfree.cc/ProjectLeaderMoudle?dd_orientation=landscape&username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
        } else {
            url = 'http://219.134.191.195:64000/problemMoudle?dd_orientation=landscape&username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
            // url = 'http://e888ccd6.natappfree.cc/problemMoudle?dd_orientation=landscape&username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
        }

        if (isDingTalk) {
            // 在钉钉环境中，先保存用户信息到localStorage，然后跳转
            localStorage.setItem('username', username);
            localStorage.setItem('job', job);
            
            dd.openLink({
                url: url,
                success: function() {
                    console.log('成功打开DQE研发审核页面');
                },
                fail: function(err) {
                    alert('打开页面失败：' + JSON.stringify(err));
                    console.error('dd.openLink fail:', err);
                }
            });
        } else {
            // 非钉钉环境使用普通跳转
            window.location.href = url;
        }


    }

    const indexTitle = document.getElementById('indexTitle');
    if (job === "DQE") {
        indexTitle.textContent = "DQE主页";
    } else if (job === "rd") {
        indexTitle.textContent = "研发主页";
    }else if (job === "projectLeader") {
        indexTitle.textContent = "项目主页";
    }else{
        indexTitle.textContent = "管理员角色的主页";
    }

    // 下方三个按钮跳转页面
    const homeBtn = document.getElementById('homeBtn');
    const cloudBtn = document.getElementById('cloudBtn');
    const profileBtn = document.getElementById('profileBtn');

    // 添加点击事件监听器
    $(homeBtn).click(function() {
        // 跳转到主页
        window.location.href = '/DQEIndex';
    });

    // $(cloudBtn).click(function() {
    //     let userRole = 'DQE'; // 示例角色，可以动态获取
    //     // 跳转到搜索资源库页面
    //     window.location.href = `/durationTable?dd_orientation=landscape&role=${userRole}`;
    // });

    $(profileBtn).click(function() {
        // 跳转到个人界面页面
        window.location.href = '/DQEprofile';
    });


    const buttonContainer = document.getElementById("buttonContainer");
    const configModal = document.getElementById("configModal");
    const configTitle = document.getElementById("modalTitle");
    const warningLabel = document.getElementById("warningLabel");
    const warningDaysInput = document.getElementById("warningDays"); // 定义 warningDaysInput


    if (username ==="李良健" || username === "卢健" || username === "黄家灿" || username ==="荣成彧") {
        buttonContainer.innerHTML = `
            <button id="configButton" data-type="DQE">DQE管理配置</button>`;

    } else if (job === "rd" && username === "钟海龙") {
    // } else if (job === "rd" && (username === "钟海龙" || username === "张波")) {
        buttonContainer.innerHTML = `
            <button id="configButton" data-type="研发">研发管理配置</button>`;

    }

    const btn = document.getElementById("configButton");
    if (btn) {
        btn.onclick = async function () {
            const configType = this.getAttribute("data-type");
            configTitle.textContent = `${configType}配置选项`;
            warningLabel.textContent = `${configType}警示天数：`;

            // 从后端获取 `warningDays` 数据
            try {
                const response = await fetch(`/DQEIndex/getWarningDays?configType=${encodeURIComponent(configType)}`);
                if (response.ok) {
                    const warningDays = await response.json();
                    // 将获取的 `warningDays` 值赋给输入框
                    warningDaysInput.value = warningDays;
                } else {
                    console.error("Failed to fetch warning days");
                }
            } catch (error) {
                console.error("Error fetching warning days:", error);
            }
            configModal.style.display = "block";
        };
    }

    const span = document.getElementsByClassName("close")[0];

    span.onclick = function() {
        configModal.style.display = "none";
    }

    document.getElementById("saveButton").onclick = function() {
        const warningDays = document.getElementById("warningDays").value;
        if (warningDays < 0) {
            alert("请输入一个非负整数！");
        } else {
            // 假设有一个变量 role 用于存储角色信息
            const role = job; // 这里假设 job 变量存储当前角色，例如 "DQE" 或 "RD"

            // 准备要发送的数据
            const data = {
                warningDays: warningDays,
                role: role
            };

            // 发送请求到后端
            fetch('/DQEIndex/saveWarningDays', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        alert("警示天数已保存为：" + warningDays);
                        configModal.style.display = "none";
                    } else {
                        alert("保存失败，请稍后再试！");
                    }
                })
                .catch(error => {
                    console.error("发生错误:", error);
                    alert("保存过程中发生错误！");
                });
        }
    }

    // 超时项目模态框
    const overdueModal = document.getElementById("overdueModal");
    const overdueButton = document.getElementById("viewOverdueButton");
    const overdueClose = document.getElementsByClassName("overdue-close")[0];
    const overdueProjectList = document.getElementById("overdueProjectList");

    // 判断用户的职位，如果是 projectLeader，则隐藏按钮
    if (job === 'projectLeader') {
        overdueButton.style.display = 'none';  // 隐藏按钮
    } else {
        overdueButton.style.display = 'block';  // 显示按钮
    }

    // 定义超时节点的值转换为描述的函数
    function getNodeDescription(nodeNumber) {
        switch (nodeNumber) {
            case "1":
                return "待DQE和研发审核";
            case "2":
                return "待DQE和研发审核";
            case "3":
                return "审核完成";
            // case "4":
            //     return "已完成";
            default:
                return ""; // 默认返回空字符串
        }
    }

        overdueButton.onclick = function () {
            fetch('/DQEIndex/getOverdueSample')
                .then(response => response.json())
                .then(data => {
                    // 清空之前的内容
                    overdueProjectList.innerHTML = '';

                    // 帮助函数：处理 null 值
                    const displayValue = (value) => {
                        if (value === null || value === undefined || value === 'undefined') {
                            return "";
                        }
                        return value;
                    };

                    // 根据用户名判断是否需要过滤，他们只能看到第二次超期的数据
                    const isSpecialUser = username === "黄家灿" || username === "肖政文"  || username === "荣成彧" ||
                        (username === "卢健" && job === "manager");

                    // 填充数据到表格
                    data.forEach(combinedTaskNode => {
                        const personInCharge = ["1", "3"].includes(String(combinedTaskNode.taskNode.node_number))
                            ? combinedTaskNode.dqe
                            : String(combinedTaskNode.taskNode.node_number) === "2"
                                ? combinedTaskNode.rd ? combinedTaskNode.rd : ""
                                : ""; // 默认值

                        // 根据 Job 过滤数据
                        let shouldDisplay = false;
                        if (job === "DQE" || job === "manager") {
                            // 如果 Job 是 DQE，则只展示 node_number 为 "1" 或 "3" 的数据
                            shouldDisplay = ["1", "3"].includes(String(combinedTaskNode.taskNode.node_number));
                        } else if (job === "rd") {
                            // 如果 Job 是 rd，则只展示 node_number 为 "2" 的数据
                            shouldDisplay = String(combinedTaskNode.taskNode.node_number) === "2";
                        }

                        // 如果是黄家灿或肖政文，则额外过滤 notify_second_time 不为空的数据
                        if (isSpecialUser) {
                            shouldDisplay = shouldDisplay && displayValue(combinedTaskNode.taskNode.notify_second_time) !== "";
                        }

                        // 只有在满足条件时才创建行
                        if (shouldDisplay) {
                            const row = document.createElement('tr');

                            const overdueReasonContent = (personInCharge === username) ?
                                `<textarea data-id="${combinedTaskNode.taskNode.id}"
                        style="width: 100px; height: 60px;">${displayValue(combinedTaskNode.taskNode.overdueReason)}</textarea>`
                                : displayValue(combinedTaskNode.taskNode.overdueReason);

                            // 比较 node_number 和 status_value，决定颜色
                            const nodeDescription = getNodeDescription(combinedTaskNode.taskNode.node_number);
                            let statusValue = displayValue(combinedTaskNode.taskNode.status_value);

                            // 去掉 status_value 中的前缀 "测试进度："（如果有）
                            statusValue = statusValue.replace("测试进度：", "").trim();

                            // 判断颜色
                            const descriptionClass = nodeDescription === statusValue ? 'red-text' : 'green-text';

                            // 使用 combinedTaskNode.taskNode 获取 TaskNode 的字段
                            row.innerHTML = `
                        <td>${displayValue(combinedTaskNode.taskNode.id)}</td>
                        <td>
                            <a href="/problemMoudle?dd_orientation=landscape&sample_id=${encodeURIComponent(combinedTaskNode.taskNode.sample_id)}&username=${encodeURIComponent(username)}&job=${encodeURIComponent(job)}">
                                ${displayValue(combinedTaskNode.taskNode.sample_id)}
                            </a>
                        </td>
                        <td class="${descriptionClass}">${nodeDescription}</td> <!-- 根据值判断颜色 -->
                        <td>${statusValue}</td>
                        <td>${displayValue(combinedTaskNode.taskNode.create_time)}</td>
                        <td>${displayValue(combinedTaskNode.taskNode.warn_time)}</td>
                        <td>${displayValue(combinedTaskNode.taskNode.notify_once_time)}</td>
                        <td>${displayValue(combinedTaskNode.taskNode.notify_second_time)}</td>
                        <td>${displayValue(combinedTaskNode.fullModel)}</td> <!-- 这里是样本的字段 -->
                        <td>${displayValue(combinedTaskNode.bigSpecial)}</td>
                        <td>${displayValue(combinedTaskNode.smallSpecial)}</td>
                        <td>${displayValue(combinedTaskNode.sampleCategory)}</td>
                        <td>${displayValue(combinedTaskNode.version)}</td>
                        <td>${displayValue(combinedTaskNode.questStats)}</td>
                        <td>${displayValue(personInCharge)}</td> <!-- 添加负责人信息 -->
                        <td>${overdueReasonContent}</td> <!-- 添加可编辑的 overdueReason -->
                    `;
                            overdueProjectList.appendChild(row);
                        }
                    });
                    overdueModal.style.display = "block"; // 显示模态框
                    
                    // 更新项目统计
                    updateProjectSummary();
                })
                .catch(error => console.error("获取超时项目列表时出错:", error));
        };



    document.getElementById('saveOverdueReasons').onclick = function () {
        // 收集所有的超期原因
        const textareas = overdueProjectList.querySelectorAll('textarea');

        textareas.forEach(textarea => {
            const id = textarea.dataset.id; // 获取任务ID
            const newReason = textarea.value;

            // 发送更新请求
            fetch('/DQEIndex/updateOverdueReason', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `id=${encodeURIComponent(id)}&overdueReason=${encodeURIComponent(newReason)}`,
            })
                .then(response => {
                    if (!response.ok) {
                        alert("部分超期原因保存失败");
                    }else{
                        alert('超期原因已保存成功！');
                    }
                })
                .catch(error => console.error("保存超期原因时出错:", error));
        });


    };

    function searchOverdueTable() {
        var input, filter, table, tr, td, i, j, txtValue;
        input = document.getElementById("overdueSearch");
        filter = input.value.toUpperCase();
        table = document.getElementById("overdueTable");
        tr = table.getElementsByTagName("tr");

        // 遍历表格的每一行，从第二行开始（跳过表头）
        for (i = 1; i < tr.length; i++) {
            tr[i].style.display = "none"; // 先隐藏所有行
            td = tr[i].getElementsByTagName("td");
            for (j = 0; j < td.length; j++) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = ""; // 如果找到匹配项，显示该行
                    break; // 找到一个匹配项后，不需要继续检查该行的其他单元格
                }
            }
        }
    }

    overdueClose.onclick = function() {
        overdueModal.style.display = "none";
    };


    // 期通知项目按钮
    const recentNotificationsModal = document.getElementById("recentNotificationsModal");
    const recentNotificationsButton = document.getElementById("viewRecentNotificationsButton");
    const recentNotificationsClose = document.getElementsByClassName("recent-notifications-close")[0];
    const recentNotificationsProjectList = document.getElementById("recentNotificationsProjectList");


    // 查看近期通知项目按钮点击事件
        recentNotificationsButton.onclick = function () {
            fetch(`/DQEIndex/getRecentNotifications?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    recentNotificationsProjectList.innerHTML = '';
                    const displayValue = (value) => {
                        if (value === null || value === undefined || value === 'undefined') {
                            return "";
                        }
                        return value;
                    };

                    data.forEach(combinedTaskNode => {
                        // 确定负责人
                        let personInCharge = "";
                        //20250301 简化审核逻辑
                        if (combinedTaskNode.taskNode.node_number === "1" ) {
                            personInCharge = combinedTaskNode.dqe;
                        } else if (combinedTaskNode.taskNode.node_number === "2") {
                            personInCharge = combinedTaskNode.rd;
                        } else if (combinedTaskNode.taskNode.node_number === "4") {
                            personInCharge = combinedTaskNode.projectLeader;
                        }


                        // 原来的审核逻辑
                        // if (combinedTaskNode.taskNode.node_number === "1" || combinedTaskNode.taskNode.node_number === "3") {
                        //     personInCharge = combinedTaskNode.dqe;
                        // } else if (combinedTaskNode.taskNode.node_number === "2") {
                        //     personInCharge = combinedTaskNode.rd;
                        // } else if (combinedTaskNode.taskNode.node_number === "4") {
                        //     personInCharge = combinedTaskNode.projectLeader;
                        // }

                        // 如果负责人匹配用户名，则添加该行，否则跳过
                        if (personInCharge === username) {
                            const row = document.createElement('tr');

                            //20250301 在查看近期项目按钮新增当前进度颜色判断
                            // 比较 node_number 和 status_value，决定颜色
                            const nodeDescription = getNodeDescription(combinedTaskNode.taskNode.node_number);
                            let statusValue = displayValue(combinedTaskNode.taskNode.status_value);
                            statusValue = statusValue.replace("测试进度：", "").trim();
                            // 判断颜色
                            const descriptionClass = nodeDescription === statusValue ? 'red-text' : 'green-text';

                            // 让 sample_id 成为可点击的链接
                            row.innerHTML = `
                        <td>${displayValue(combinedTaskNode.taskNode.id)}</td>
                        <td><a href="/problemMoudle?dd_orientation=landscape&sample_id=${encodeURIComponent(combinedTaskNode.taskNode.sample_id)}&username=${encodeURIComponent(username)}&job=${encodeURIComponent(job)}">${displayValue(combinedTaskNode.taskNode.sample_id)}</a></td>
                        <td>${getNodeDescription(combinedTaskNode.taskNode.node_number)}</td>
<!--                        <td>${displayValue(combinedTaskNode.taskNode.status_value)}</td>-->
                        <td class="${descriptionClass}">${displayValue(combinedTaskNode.taskNode.status_value)}</td>
                        <td>${displayValue(combinedTaskNode.taskNode.create_time)}</td>
                        <td>${displayValue(combinedTaskNode.taskNode.warn_time)}</td>
                        <td>${displayValue(combinedTaskNode.fullModel)}</td>
                        <td>${displayValue(combinedTaskNode.bigSpecial)}</td>
                        <td>${displayValue(combinedTaskNode.smallSpecial)}</td>
                        <td>${displayValue(combinedTaskNode.sampleCategory)}</td>
                        <td>${displayValue(combinedTaskNode.version)}</td>
                        <td>${displayValue(combinedTaskNode.questStats)}</td>
                        <td>${displayValue(personInCharge)}</td>
                    `;

                            recentNotificationsProjectList.appendChild(row);
                        }
                    });

                    recentNotificationsModal.style.display = "block";
                    
                    // 更新项目统计
                    updateProjectSummary();
                })
                .catch(error => console.error("获取近期通知项目列表时出错:", error));
        };

    recentNotificationsClose.onclick = function() {
        recentNotificationsModal.style.display = "none";
    };

    // 项目详情模态框相关逻辑
    const projectDetailModal = document.getElementById("projectDetailModal");
    const projectDetailClose = document.getElementsByClassName("project-detail-close")[0];
    const projectDetailList = document.getElementById("projectDetailList");

    // 显示项目详情模态框的函数
    function showProjectModal(statType) {
        console.log('showProjectModal called with:', statType); // 添加调试日志
        const modalTitle = document.getElementById('projectDetailTitle');
        let projectType = "";
        let title = "";
        
        switch(statType) {
            case 'ladingBillWaitTest':
                projectType = "ladingBillWaitTest";
                title = "提单待测试项目详情";
                break;
            case 'testing':
                projectType = "testing";
                title = "测试进行中项目详情";
                break;
            case 'recentCount':
                // 对于待审核项目，直接调用原有的查看近期通知项目功能
                console.log('Calling viewRecentNotificationsButton.click()');
                document.getElementById('viewRecentNotificationsButton').click();
                return;
            case 'overdueCount':
                // 对于超期项目，直接调用原有的查看超时项目功能
                console.log('Calling viewOverdueButton.click()');
                document.getElementById('viewOverdueButton').click();
                return;
            case 'closedCount':
                projectType = "closedCount";
                title = "报告闭环项目详情";
                break;
            case 'projectCount':
                projectType = "projectCount";
                title = "项目总数详情";
                break;
            default:
                console.log('Unknown statType:', statType);
                return;
        }
        
        console.log('Fetching data for projectType:', projectType);
        modalTitle.textContent = title;
        
        // 根据项目类型获取数据
        fetch(`/DQEIndex/getProjectDetail?username=${encodeURIComponent(username)}&projectType=${encodeURIComponent(projectType)}`)
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                projectDetailList.innerHTML = '';
                const displayValue = (value) => {
                    if (value === null || value === undefined || value === 'undefined') {
                        return "";
                    }
                    return value;
                };

                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        
                        // 让样品ID成为可点击的链接
                        // 对于electric_info表的数据，使用sample_id作为电气编号进行跳转
                        const sampleIdLink = `<a href="/problemMoudle?dd_orientation=landscape&sample_id=${encodeURIComponent(item.sample_id)}&username=${encodeURIComponent(username)}&job=${encodeURIComponent(job)}&isElectricId=true">${displayValue(item.sample_id)}</a>`;
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${sampleIdLink}</td>
                            <td>${displayValue(item.node_number)}</td>
                            <td>${displayValue(item.status_value)}</td>
                            <td>${displayValue(item.create_time)}</td>
                            <td>${displayValue(item.fullModel)}</td>
                            <td>${displayValue(item.bigSpecial)}</td>
                            <td>${displayValue(item.smallSpecial)}</td>
                            <td>${displayValue(item.sampleCategory)}</td>
                            <td>${displayValue(item.version)}</td>
                            <td>${displayValue(item.personInCharge)}</td>
                        `;
                        projectDetailList.appendChild(row);
                    });
                } else {
                    projectDetailList.innerHTML = '<tr><td colspan="11">暂无详细项目信息</td></tr>';
                }
                projectDetailModal.style.display = "block";
            })
            .catch(error => {
                console.error("获取项目详情时出错:", error);
                projectDetailList.innerHTML = '<tr><td colspan="12">获取数据失败，请稍后重试</td></tr>';
                projectDetailModal.style.display = "block";
            });
    }

    projectDetailClose.onclick = function() {
        projectDetailModal.style.display = "none";
    };


    // 代理人设置模态框相关逻辑
    const agentModal = document.getElementById("agentModal");
    const setupAgentBtn = document.getElementById("setupAgentBtn");
    const agentClose = document.getElementsByClassName("agent-close")[0];
    const addAgentBtn = document.getElementById("addAgentBtn");
    const saveAgentsBtn = document.getElementById("saveAgentsBtn");
    const MAX_AGENTS = 5; // 最大代理人数量

    setupAgentBtn.onclick = function() {
        agentModal.style.display = "block";
        fetchAgents(); // 点击时获取数据库中的代理人数据
    }

    agentClose.onclick = function() {
        agentModal.style.display = "none";
    }

    function fetchAgents() {
        // 显示加载状态
        saveAgentsBtn.disabled = true;
        saveAgentsBtn.textContent = '加载中...';
        
        fetch(`/DQEIndex/getAgents?username=${encodeURIComponent(username)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应错误');
            }
            return response.json();
        })
        .then(data => {
            const agentList = document.getElementById('agentList');
            agentList.innerHTML = '';
            
            if (data.agents && data.agents.length > 0) {
                data.agents.forEach(agent => {
                    addAgentInput(agent);
                });
            } else {
                addAgentInput(''); // 添加一个空的输入框
            }
            
            updateAddButtonState();
        })
        .catch(error => {
            console.error('Error fetching agents:', error);
            alert('获取代理人数据失败，请稍后重试');
            // 添加一个空的输入框作为备选
            const agentList = document.getElementById('agentList');
            agentList.innerHTML = '';
            addAgentInput('');
        })
        .finally(() => {
            saveAgentsBtn.disabled = false;
            saveAgentsBtn.textContent = '保存设置';
        });
    }

    function addAgentInput(value = '') {
        const agentList = document.getElementById('agentList');
        const agentCount = agentList.children.length;
        
        if (agentCount >= MAX_AGENTS) {
            alert(`最多只能设置${MAX_AGENTS}个代理人`);
            return;
        }
        
        const inputGroup = document.createElement('div');
        inputGroup.className = 'agent-input-group';
        inputGroup.style.cssText = 'display: flex; align-items: center; margin-bottom: 10px; gap: 8px;';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'agentInput';
        input.placeholder = '输入代理人姓名';
        input.value = value;
        input.maxLength = 20;
        input.style.cssText = 'flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;';
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-agent-btn';
        removeBtn.textContent = '×';
        removeBtn.style.cssText = 'background: #ff4757; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; line-height: 1;';
        
        // 只有当有多个输入框时才显示删除按钮
        if (agentCount > 0) {
            removeBtn.style.display = 'block';
        }
        
        removeBtn.onclick = function() {
            if (agentList.children.length > 1) {
                agentList.removeChild(inputGroup);
                updateAddButtonState();
                updateRemoveButtons();
            }
        };
        
        inputGroup.appendChild(input);
        inputGroup.appendChild(removeBtn);
        agentList.appendChild(inputGroup);
        
        updateAddButtonState();
        updateRemoveButtons();
    }

    function updateAddButtonState() {
        const agentList = document.getElementById('agentList');
        const agentCount = agentList.children.length;
        addAgentBtn.disabled = agentCount >= MAX_AGENTS;
        
        if (agentCount >= MAX_AGENTS) {
            addAgentBtn.textContent = '已达到最大数量';
            addAgentBtn.style.opacity = '0.5';
        } else {
            addAgentBtn.textContent = '+ 添加代理人';
            addAgentBtn.style.opacity = '1';
        }
    }

    function updateRemoveButtons() {
        const agentList = document.getElementById('agentList');
        const removeButtons = agentList.querySelectorAll('.remove-agent-btn');
        const agentCount = agentList.children.length;
        
        removeButtons.forEach(btn => {
            btn.style.display = agentCount > 1 ? 'block' : 'none';
        });
    }

    document.getElementById('addAgentBtn').addEventListener('click', function() {
        addAgentInput();
    });

    document.getElementById('saveAgentsBtn').addEventListener('click', function() {
        const inputs = document.querySelectorAll('.agentInput');
        const agents = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(value => value !== '');
        
        // 验证输入
        if (agents.length === 0) {
            alert("请至少输入一个代理人姓名");
            return;
        }
        
        // 检查是否有重复的代理人
        const uniqueAgents = [...new Set(agents)];
        if (uniqueAgents.length !== agents.length) {
            alert("代理人姓名不能重复");
            return;
        }
        
        // 检查代理人姓名长度
        for (let agent of agents) {
            if (agent.length < 2) {
                alert("代理人姓名至少需要2个字符");
                return;
            }
            if (agent.length > 20) {
                alert("代理人姓名不能超过20个字符");
                return;
            }
        }

        // 显示保存状态
        saveAgentsBtn.disabled = true;
        saveAgentsBtn.textContent = '保存中...';
        
        fetch('/DQEIndex/saveAgents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ agents: agents, username })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('保存失败');
            }
            return response.json();
        })
        .then(data => {
            console.log('保存响应:', data);
            if (data.success) {
                alert(data.message || "代理人设置保存成功！");
                fetchAgents(); // 刷新模态框
            } else {
                alert(data.message || "保存失败，请稍后重试！");
            }
        })
        .catch(error => {
            console.error('Error saving agents:', error);
            alert("保存失败，请稍后重试！");
        })
        .finally(() => {
            saveAgentsBtn.disabled = false;
            saveAgentsBtn.textContent = '保存设置';
        });
    });

    window.onclick = function(event) {
        if (event.target == agentModal) {
            agentModal.style.display = "none";
        }
        if (event.target == overdueModal) {
            overdueModal.style.display = "none";
        }
        if (event.target == configModal) {
            configModal.style.display = "none";
        }
        if (event.target == recentNotificationsModal) {
            recentNotificationsModal.style.display = "none";
        }
        if (event.target == projectDetailModal) {
            projectDetailModal.style.display = "none";
        }
    };


</script>




</body>
</html>
