<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>研发质量管理系统主页</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/testManIndexStyle.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>


</head>
<body>

<header>

    <!--    <meta name="wpk-bid" content="dta_1_3078576183">-->

    <div class="title-container">
        <button id="announcement-btn">查看公告(v2.2，20250706新增回传问题点功能)</button>
        <div class="title">主页</div>
        <!-- 排期项目面板按钮 -->
        <button id="schedule-panel-btn" class="schedule-panel-btn">排期项目按钮</button>
    </div>

    <!-- 排期项目面板模态框 -->
    <div id="schedule-panel-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-panel-modal">&times;</span>
            <h2>排期项目列表</h2>
            <ul id="schedule-project-list">
                <!-- 项目列表会通过接口加载 -->
            </ul>
        </div>
    </div>

    <!-- 项目详情模态框 -->
    <!-- 项目详情模态框 -->
    <div id="project-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-project-modal">&times;</span>
            <h2 id="project-detail-title">项目详情</h2>
            <div id="project-detail-info">加载中...</div>

            <!-- 新增：开始测试区域 -->
            <div id="task-attributes" style="margin-top: 20px; display: none;">
                <h3>填写以下内容</h3>
                <label>
                    任务属性：
                    <select id="questStats-detail">
                        <option value="">请选择</option>
                        <option value="无">无</option>
                        <option value="新品">新品</option>
                        <option value="新设备">新设备</option>
                        <option value="新软件版本">新软件版本</option>
                        <option value="售后问题分析">售后问题分析</option>
                        <option value="量产升级">量产升级</option>
                        <option value="竞品">竞品</option>
                    </select>
                </label>
                <br/><br/>

                <!-- 额外的三个字段容器 -->
                <div id="additional-fields" style="display: none;">
                    <label>
                        产品类别：
                        <input type="text" id="sample-category" placeholder="请输入产品类别">
                    </label>
                    <br/><br/>

                    <label>
                        样品数量：
                        <input type="number" id="sample-quantity" placeholder="请输入样品数量" min="1">
                    </label>
                    <br/><br/>

                    <label>
                        是否高频：
                        <select id="is-high-frequency">
                            <option value="">请选择</option>
                            <option value="是">是</option>
                            <option value="否">否</option>
                        </select>
                    </label>
                    <br/><br/>
                </div>

                <button id="confirm-task-btn">确认开始测试</button>
            </div>

            <!-- 开始测试按钮 -->
            <button id="start-test-btn" style="margin-top: 20px;">开始测试</button>
        </div>
    </div>



    <!-- 更新日志面板 -->
    <div id="log-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>更新日志<span style="color: red;">(！！！更新问题点汇总工作表，新增"问题类别"一列。)</span></h2>
            <p>20250111:创建报告现在需要填写的是计划表卢绮敏提供的三个排期内容：排期时间，排期天数，请写准确，不允许修改的！
                <br>
                2024.11.18<br>
                1. 打通测试报告审核签样流程：测试人员提交->DQE审核问题点->研发审核判定->DQE最终判定->返回通知测试及DQE判定结果。此过程中任何一方角色都可以同步查看修改问题点，并且有操作记录,每个流程节点都会有OA消息通知对应人。<br>
                2. 测试报告文件名加上任务属性，不然会有与其他文件冲突的风险。  --赵爽发现<br>
                3. 逾期节点更新，从 '2024-11-18 00:00:00'创建的文件开始算起。
                <br>
                2.新增《查看问题点》按钮，用于测试人员测试已上传的问题点（跟展示给DQE和研发的一致），此按钮位置在《替换报告》按钮左侧。 <br>
                <br>
                2024.10.10<br>
                1.将文件上传大小限制上调到100MB，满足交换机因为图片多导致文件太大无法替换的问题。 ----肖龙生提出<br>
                2.优化了文件解析逻辑，解决部分文件替换后导致服务器崩溃的问题。  ---李素欣发现<br>
                2024.09.27<br>
                1.将提交按钮改成灵活变动的状态：提交，撤回，完结<br>
                <br>
                2024.09.24：<br>
                1.超出宽度自动换行<br>
                2.图片在单元格展示 --黄兰姣建议<br>
                3.类别新增一个选品 --蓝明城建议<br>
                4.修改公式不展示正确值的bug --陈昱菲发现<br>
                5.新增功能按钮-黑色红色字体 --黄兰姣建议<br>
                6.新增功能按钮-冻结窗格    --程奕阳建议<br>
                <br>
                2024.9.19:<br>
                1. 主页默认改为降序，最近时间创建的报告排在最上方。 --肖龙生发现<br>
                2. 修改产品信息加上*号展示为必填项。--肖龙生建议<br>
                3. 报告内容格式在程序解析后为居中靠左--黄兰姣需求<br>
                4. 解析文件限制最大的列数100，行数则如果连续10行为空则停止往下解析。(防止文件右方和下方出现太多空格加载冗余)<br>
                5. 新增字段测试时长和预计测试时长，在UI展示。<br>
                6. 解决bug: xlsx文件中的浮点数解析到程序里会向上取整为整数，实际上文件内容还是小数点，已解决，现在对浮点数类型不进行小数点限制。--龙运发现<br>
                7. 提交报告的时候新增对缺少”测试问题点汇总“工作表的提示，方便找到提交失败的问题。<br>
                8. 设置逾期判断，从2024.9.23号0点创建的文件开始计算。<br>
                9. 可以查看各组员报告用时情况，可以导出为一份xlsx文件。<br>

                <br>
                2024.09.07：<br>
                1. 新增主页UI供应商展示；--龙运需求<br>
                2. 解决签名经过保存按钮还不能实现替换的bug。--蓝明城发现<br>
                3. 解决创建报告填单-主控芯片字数太长导致无法保存的bug,现在可以输入65,535个字符。--李智龙发现<br>
                4. 解决产品名称有部分字符导致无法保存的bug，特殊字符会强制转换为"_"。--张锐发现<br>


            </p>
        </div>
    </div>


    <!-- 数据统计区域 -->
    <div class="stats-container">
        <div class="stats" id="stats">
            <span id="testing">测试：0</span>
            <span id="pending">审核：0</span>
            <span id="completed">完成：0</span>
            <span id="total">总数：0</span>
            <span id="overdue">逾期：<span class="biaoji">0</span></span>
            <span id="danger">失责：<span class="biaoji">0</span></span>
        </div>
    </div>


    <!-- 搜索框 -->
    <div class="search-container">
        <div class="search-wrapper">
            <button class="createTestBtn">创建<br>报告</button>
            <input type="text" class="search-input" placeholder="关键字搜索">
            <button class="search-btn"><i class="fas fa-search"></i></button>

            <div class="select-wrapper">
                <select class="filter-select" id="sort-filter">
                    <option value="all">排序</option>
                    <option value="asc">升序</option>
                    <option value="desc">降序</option>
                </select>
            </div>
        </div>

    </div>

    <!-- 表格列表 -->
    <div class="table-container">
        <table class="static-header" style="display: none;">
            <thead>
            <tr>
                <th rowspan="1">没有您的文件，快去创建吧！</th>

            </tr>

            </thead>
        </table>

    </div>


    <!--    2024.10.31给测试人员页面加一个给查看问题点的按钮-->
    <!-- 模态框结构 -->
    <div id="testIssuesModal" class="problemModal">
        <div class="problemModal-content">
            <span class="close-problem">&times;</span>
            <div id="testIssuesContent"></div>
        </div>
    </div>

    <!-- 模态框 -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>选择分类</h2>
            <div id="categoryList"></div>
            <div id="fileList"></div>
        </div>
    </div>

    <!-- 信息输入模态框 -->
    <div id="infoModal" class="inputModal">
        <div class="inputModal-content">
            <span class="close">&times;</span>
            <h2>请输入产品信息</h2>
            <form id="fileInfoForm">
                <label for="model">大编码:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input type="text" id="model" name="model" required placeholder="必填项，没有则填无">
                <label for="coding">小编码:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input type="text" id="coding" name="coding" required placeholder="必填项，没有则填无">
                <label for="category">类别:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <select id="category" name="category" required>
                    <option value="" disabled selected>请选择类别</option>
                    <option value="大货样">大货样</option>
                    <option value="功能样">功能样</option>
                    <option value="竞品">竞品</option>
                    <option value="预研">预研</option>
                    <option value="选品">选品</option>
                </select>
                <!--新增任务属性字段20240709-->
                <label for="questStats">任务属性:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <select id="questStats" name="questStats" required>
                    <option value="" disabled selected>请选择任务属性，必选</option>
                    <option value="无">无</option>
                    <option value="新品">新品</option>
                    <option value="新设备">新设备</option>
                    <option value="新软件版本">新软件版本</option>
                    <option value="售后问题分析">售后问题分析</option>
                    <option value="量产升级">量产升级</option>
                    <option value="竞品">竞品</option>
                </select>

                <!-- 引入品类细分组件 -->
                <label for="big_species">大类:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <select id="big_species" name="big_species" required onchange="populateSubCategory()">
                    <option value="" disabled selected>请选择大类</option>
                    <!-- 通过json文件动态加入选项 -->
                </select>

                <label for="small_species">细分品类:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <select id="small_species" name="small_species" required>
                    <option value="" disabled selected>请选择细分品类</option>
                    <!-- 根据大类自动填充 -->
                </select>

                <label for="version">版本:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input type="text" id="version" name="version" required placeholder="必填项大写，没有填无">
                <label for="sample_name">产品名称:</label>
                <input type="text" id="sample_name" name="sample_name" required placeholder="必填项，/\:*?<>|会替换成下横线_"><br>
                <!--   20250108 删掉预计完成时间，改成3个字段：排期开始时间，排期结束时间，排期测试周期        -->
                <!--            <label for="planfinish_time">预计完成时间:</label>-->
                <!--            <input type="datetime-local" id="planfinish_time" name="planfinish_time" required><br>-->
                <label for="scheduleStartTime">排期开始时间:</label>
                <input type="datetime-local" id="scheduleStartTime" name="scheduleStartTime" required><br>
                <label for="scheduleEndTime">排期结束时间:</label>
                <input type="datetime-local" id="scheduleEndTime" name="scheduleEndTime" required><br>
                <label for="scheduleTestCycle">排期测试周期(天):</label>
                <input type="number" id="scheduleTestCycle" name="scheduleTestCycle" min="0.5" step="0.5" required placeholder="必填项，最小是0.5">


                <label for="sample_frequency">送样次数:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input type="number" id="sample_frequency" name="sample_frequency" min="1" required placeholder="必填项，请写明是第几次送样，第一次则为1">
                <label for="sample_quantity">送样数量:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input type="number" id="sample_quantity" name="sample_quantity" min="1" required placeholder="必填项">

                <label for="high_frequency">您是高频测试人员吗？&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <select id="high_frequency" name="high_frequency" required>
                    <option value="" disabled selected>请选择</option>
                    <option value="是">是</option>
                    <option value="否">否</option>
                </select>

                <!--   20250612新增电气编号为必填项-->
                <label for="electric_sample_id">电气编号:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input type="text" id="electric_sample_id" name="electric_sample_id"  placeholder="请去IT提单新系统查找对应的电气编号，例如ET2505150001">

                <button type="submit">提交</button>

            </form>
        </div>
    </div>

    <div id="existModal" class="inputModal">
        <div class="existModal-content">
            <span class="close">&times;</span>
            <h2>已存在的文件，你可以选择一份文件进行模板使用：</h2>
        </div>
    </div>


    <!-- 下方固定按钮 -->
    <div class="btn-container">
        <hr class="divider"> <!-- 按钮上方的横线 -->
        <!-- 主页按钮 -->
        <button class="btn" id="homeBtn"><i class="fas fa-home"></i></button>
        <!-- 搜索资源库按钮 -->
        <button class="btn" id="cloudBtn" ><i class="fas fa-cloud"></i></button>
        <!-- 个人界面按钮 -->
        <button class="btn" id="profileBtn"><i class="fas fa-user"></i></button>
    </div>


    <!-- 进度条容器，初始时隐藏 -->
    <div id="uploadProgress" style="display: none;">
        <div id="uploadProgressBar" style="width: 0%; height: 20px; background-color: #4CAF50;"></div>
    </div>

    <!-- 自定义模态框 -->
    <div id="loadingModal" class="inputModal">
        <div class="existModal-content">
            <span id="closeModal" class="close">&times;</span>
            <h2>正在检查文件完整性，请稍候...</h2>
            <p><span id="countdown">5</span> 秒后自动跳转</p>
            <button id="cancelButton">取消</button>
        </div>
    </div>


    <!-- 模态框的 HTML 结构 -->
    <div id="alert-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div id="alert-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
            <div id="alert-message" style="margin-bottom: 20px;">提示信息</div>
            <button id="alert-confirm" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">确认</button>
        </div>
    </div>

    <!-- 确认模态框的 HTML 结构 -->
    <div id="confirm-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div id="confirm-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
            <div id="confirm-message" style="margin-bottom: 20px;">确认信息</div>
            <button id="confirm-yes" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">确认</button>
            <button id="confirm-no" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">取消</button>
        </div>
    </div>


    <!-- 模态框 HTML -->
    <div id="restDaysModal" style="display: none; position: fixed; z-index: 3; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 30%; text-align: center;">
            <h3>请输入期间休息天数</h3>
            <p>（只能输入0.5，1.5，或者整数1）</p>
            <input type="text" id="restDaysInput" placeholder="例如：0.5, 1, 1.5" style="width: 80%; padding: 5px;">
            <br><br>
            <button onclick="submitRestDays()">确认</button>
            <button onclick="closeModal()">取消</button>
        </div>
    </div>

    <div id="choiceModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background-color:#35813f; padding:20px; border:1px solid #ccc; z-index:1000; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
        <button id="closeChoiceModal" style="position:absolute; top:5px; right:5px; background:transparent; border:none; font-size:18px; color:white; cursor:pointer;">&times;</button>
        <p style="color:white; font-size:16px;">请选择：</p>
        <div style="display:flex; justify-content:space-around; gap:10px;">
            <button id="btnRetireSample" style="padding:10px 20px; border:none; background-color:#f7d716; color:black; border-radius:5px; cursor:pointer;">测试人员退样（免审核流程）</button>
            <button id="btnCompetitive" style="padding:10px 20px; border:none; background-color:#f7d716; color:black; border-radius:5px; cursor:pointer;">测试人员竞品完成（免审核流程，会发送通知）</button>
            <button id="btnNoChoice" style="padding:10px 20px; border:none; background-color:#f7d716; color:black; border-radius:5px; cursor:pointer;">走审核流程</button>
        </div>
    </div>

    <!-- 查看资料模态框 -->
    <div id="viewDataModal" class="viewDataModal">
        <div class="modal-content">
            <span class="close" id="closeViewDataModal">&times;</span>
            <h2>资料下载</h2>

            <h3>承认书</h3>
            <ul id="admitLinksContainer"></ul>

            <h3>开发要求</h3>
            <ul id="developLinksContainer"></ul>
        </div>
    </div>



    <!-- 引入 jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>

        //排期项目的属性
        let currentProjectData = null;

        document.getElementById("choiceModal").addEventListener("click", function() {
            document.getElementById("choiceModal").style.display = "none";
        });


        // 覆盖原生 alert 方法
        window.alert = function(message) {
            // 获取模态框元素
            const overlay = document.getElementById('alert-overlay');
            const modal = document.getElementById('alert-modal');
            const messageElem = document.getElementById('alert-message');
            const confirmButton = document.getElementById('alert-confirm');

            // 设置消息文本
            messageElem.textContent = message;

            // 显示模态框
            overlay.style.display = 'block';
            modal.style.display = 'block';

            // 点击确认按钮时关闭模态框
            confirmButton.onclick = () => {
                overlay.style.display = 'none';
                modal.style.display = 'none';
                // 调用原本的alert回调
            };
        };



        // 覆盖原生 confirm 方法
        window.confirm = function(message) {
            return new Promise(function(resolve, reject) {
                const overlay = document.getElementById('confirm-overlay');
                const modal = document.getElementById('confirm-modal');
                const messageElem = document.getElementById('confirm-message');
                const yesButton = document.getElementById('confirm-yes');
                const noButton = document.getElementById('confirm-no');

                // 设置消息文本
                messageElem.textContent = message;

                // 显示模态框
                overlay.style.display = 'block';
                modal.style.display = 'block';

                // 点击“确认”按钮时，关闭模态框并返回 true
                yesButton.onclick = () => {
                    overlay.style.display = 'none';
                    modal.style.display = 'none';
                    resolve(true); // 返回 true 表示用户点击了确认
                };

                // 点击“取消”按钮时，关闭模态框并返回 false
                noButton.onclick = () => {
                    overlay.style.display = 'none';
                    modal.style.display = 'none';
                    reject(false); // 返回 false 表示用户点击了取消
                };
            });
        };




        // 此路径是指文件模板的位置BASE_DIRECTORY
        const BASE_DIRECTORY = sessionStorage.getItem('templatespath');
        const savepath = sessionStorage.getItem('savepath');
        const corp_id = sessionStorage.getItem('corp_id');

        let isEditing = false; // 新增状态标志

        const username = sessionStorage.getItem('username');
        const job =sessionStorage.getItem('job');
        //调试用
        // const username = "卢健";
        // const job = "tester";

        function initData(){
            // 从后端获取数据并更新页面内容
            $.ajax({
                url: '/data', // 向后端发起请求的接口地址
                type: 'GET', // 请求方式
                data: { 'username': username }, // 将 username 作为请求参数发送
                success: function(data) {
                    // 根据后端返回的数据更新页面内容
                    $('#testing').text('测试：' + data.testing);
                    $('#pending').text('审核：' + data.pending);
                    $('#completed').text('完成：' + data.completed);
                    $('#total').html('总数：' + data.total + '&nbsp;');
                    $('#overdue').html('逾期：<span class="biaoji">' + data.overdue + '&nbsp;'+ '</span>');
                    $('#danger').html('失责：<span class="biaoji">' + data.danger + '</span>');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to retrieve data:', status, error);
                }
            });
        }

        initData();

        // 下方三个按钮跳转页面
        const homeBtn = document.getElementById('homeBtn');
        const cloudBtn = document.getElementById('cloudBtn');
        const profileBtn = document.getElementById('profileBtn');

        // 添加点击事件监听器
        $(homeBtn).click(function() {
            // 跳转到主页
            window.location.href = '/home';
        });

        $(cloudBtn).click(function() {
            let userRole = 'testMan'; // 示例角色，可以动态获取
            // 跳转到搜索资源库页面
            // window.location.href = `/durationTable?dd_orientation=landscape&role=${userRole}`;
            window.location.href = `/labModuleTester`;
        });


        $(profileBtn).click(function() {
            // 跳转到个人界面页面
            window.location.href = '/testManProfile';
        });

        $(document).ready(function () {
            // 调用后端接口获取配置信息
            $.ajax({
                url: '/getJsapiConfig',
                type: 'GET',
                data: { url: encodeURIComponent(location.href.split('#')[0]) },
                success: function(config) {
                    // 使用获取的配置信息初始化钉钉JSAPI
                    dd.config({
                        agentId: config.agentId,
                        corpId: config.corpId,
                        timeStamp: config.timeStamp,
                        nonceStr: config.nonceStr,
                        signature: config.signature,
                        jsApiList: config.jsApiList // 必填，需要使用的jsapi列表
                    });
                    //获取设备唯一UUID
                    dd.getDeviceUUID({
                        onSuccess : function(data) {
                            const uuidKey = `uuid_`;
                            localStorage.setItem(uuidKey, JSON.stringify(data.uuid));
                            // alert(data.uuid);
                        },
                        onFail : function(err) {
                            console.log("获取UUID失败",err);
                        }
                    });

                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                }
            });


            loadData();
            // 加载数据的函数
            function loadData() {
                // 从 sessionStorage 中获取 username
                // var username = sessionStorage.getItem('username');

                // 检查 username 是否存在
                if (!username) {
                    console.error('用户名未定义，无法加载数据');
                    // 重定向到钉钉免登流程启动页面，例如：
                    alert("用户信息过期，请关闭之后重新进入钉钉微应用");
                    return;
                }

                $.ajax({
                    url: '/getTestManPanel', // 后端接口地址,这里返回的data是samples类，所有信息都有
                    type: 'GET',
                    data: { 'username': username }, // 将 username 作为请求参数发送
                    success: function(data) {

                        const type = "initialize";
                        renderTableContainer(data,type);

                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to retrieve data:', status, error);
                    }
                });
            }

            // 监听搜索按钮点击事件
            $('.search-btn').click(function() {
                performSearch();
            });

            // 给search-input添加回车键监听事件
            $('.search-input').on('keydown', function(event) {
                // 检查是否按下了回车键
                if (event.keyCode === 13) {
                    event.preventDefault(); // 阻止默认行为，如表单提交
                    performSearch(); // 触发搜索功能
                }
            });

            // 监听类别选择框变化事件
            $('#sort-filter').change(function() {
                performSearch(); // 执行搜索操作
            });


            var categoryModal = document.getElementById("categoryModal");
            var categorySpan = categoryModal.getElementsByClassName("close")[0];
            var infoModal = document.getElementById("infoModal");

            var infoSpan = infoModal.getElementsByClassName("close")[0];
            var categoryListContainer = document.getElementById("categoryList");
            var fileListContainer = document.getElementById("fileList");
            var selectedFilePath = '';


            var existModal = document.getElementById("existModal");
            var existSpan = existModal.getElementsByClassName("close")[0];
            existSpan.onclick = function () {
                existModal.style.display = "none";
            }

            $('.createTestBtn').click(function () {
                categoryModal.style.display = "block";
                loadCategories();
            });

            categorySpan.onclick = function () {
                categoryModal.style.display = "none";
            }

            infoSpan.onclick = function () {
                infoModal.style.display = "none";
            }


            window.onclick = function (event) {
                if (event.target == categoryModal) {
                    categoryModal.style.display = "none";
                } else if (event.target == infoModal) {
                    // 此处注释掉，不然点击外框就会关闭输入的模态框
                    // infoModal.style.display = "none";
                }

                const modal = document.getElementById('viewDataModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }


                const editModal = document.getElementById('editModal');
                if (event.target === editModal) {
                    editModal.style.display = 'none';
                }

            }

            function loadCategories() {
                $.ajax({
                    url: '/home/getFileCategories',
                    type: 'GET',
                    success: function (data) {
                        categoryListContainer.innerHTML = '';
                        data.forEach(function (category) {
                            var div = document.createElement('div');
                            div.className = 'category-item';
                            div.innerText = category;
                            div.onclick = function () {
                                loadFiles(category);
                            };
                            categoryListContainer.appendChild(div);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to retrieve categories:', status, error);
                    }
                });
            }

            function loadFiles(category) {
                $.ajax({
                    url: '/home/getFiles?category=' + category,
                    type: 'GET',
                    success: function (fileData) {

                        fileListContainer.innerHTML = '';
                        fileData.forEach(function (file) {
                            var div = document.createElement('div');
                            div.className = 'file-item';
                            div.innerText = file.name;
                            if (file.type === 'directory') {
                                div.classList.add('folder');
                                div.onclick = function () {
                                    loadFiles(category + '/' + file.name);
                                };
                            } else {
                                if (file.name.endsWith('.xlsx')) {
                                    div.classList.add('file', 'xlsx-file');
                                    div.onclick = function () {
                                        selectedFilePath = BASE_DIRECTORY + '/' + category + '/' + file.name;
                                        infoModal.style.display = "block";
                                    };
                                }
                            }
                            fileListContainer.appendChild(div);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to retrieve files:', status, error);
                    }
                });
            }

            //这是创建报告填写之后提交按钮触发的方法
            $('#fileInfoForm').submit(function(event) {
                event.preventDefault();
                var model = $('#model').val();
                var coding = $('#coding').val();
                var category = $('#category').val();
                var version = $('#version').val();
                var sample_name = $('#sample_name').val();
                var sample_frequency = $('#sample_frequency').val();
                var sample_quantity = $('#sample_quantity').val();
                var big_species = $('#big_species').val();
                var small_species = $('#small_species').val();
                var high_frequency = $('#high_frequency').val();
                var questStats = $('#questStats').val();
                var electric_sample_id = $('#electric_sample_id').val();


                // 清理sample_name，替换特殊字符
                // sample_name = sample_name.replace(/[\/\\]/g, "_");
                // 扩展正则表达式以替换所有非法字符
                sample_name = sample_name.replace(/[\/\\:*?"<>|\t]/g, "_");

                // var planfinish_time = $('#planfinish_time').val();
                var scheduleStartTime = $('#scheduleStartTime').val();
                var scheduleEndTime = $('#scheduleEndTime').val();
                var scheduleTestCycle = $('#scheduleTestCycle').val();

                $.ajax({
                    url: '/home/queryExist',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        filepath: selectedFilePath,
                        model: model,
                        coding: coding,
                        category: category,
                        version: version,
                        sample_name: sample_name,
                        // planfinish_time: planfinish_time,
                        sample_frequency : sample_frequency,
                        sample_quantity : sample_quantity,
                        big_species: big_species,
                        small_species: small_species,
                        high_frequency: high_frequency,
                        questStats: questStats,
                        username: username,
                        scheduleStartTime: scheduleStartTime,
                        scheduleEndTime: scheduleEndTime,
                        scheduleTestCycle: scheduleTestCycle,
                        electric_sample_id: electric_sample_id

                    }),
                    success: function (filepaths) {
                        // 判断是否有错误提示
                        if (filepaths.length === 1 && filepaths[0].includes("找不到这个电气编号")) {
                            alert(filepaths[0]); // 或使用你自己的弹窗组件显示错误
                            return; // 停止后续逻辑
                        }

                        let high_sign = "";
                        if(high_frequency === "是"){
                            high_sign = "高频_";
                        }

                        const newFileName = savepath.replace(/\//g, "\\") + "\\" + model + " " + coding + "_" + category + "_" + version + "_第" +sample_frequency +"次送样_" + high_sign + questStats + "_" +sample_name + ".xlsx";

                        if (filepaths.length > 0){
                            if(filepaths.length === 1 ){
                                if(filepaths[0] === "已经存在这个型号版本类别的测试报告了，不能再创建！") {
                                    alert(filepaths[0]);
                                }else if(filepaths[0] === newFileName){
                                    localStorage.removeItem(`DQE_`);
                                    localStorage.removeItem(`Developer_`);
                                    localStorage.removeItem(`supplier_`);

                                    localStorage.setItem(`model_` ,model);
                                    localStorage.setItem(`coding_` ,coding);
                                    localStorage.setItem(`sample_name_` ,sample_name);
                                    localStorage.setItem(`tester_` ,username);

                                    // window.location.href = '/excelShow?filePath=' + encodeURIComponent(filepaths[0]);
                                    let redirectUrl = '/excelShow?filePath=' + encodeURIComponent(filepaths[0]);
                                    if (redirectUrl.indexOf('?') !== -1) {
                                        redirectUrl += '&dd_orientation=landscape';
                                    } else {
                                        redirectUrl += '?dd_orientation=landscape';
                                    }
                                    window.location.href = redirectUrl;
                                }else{
                                    // addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,planfinish_time,sample_frequency,sample_quantity,big_species,small_species,high_frequency,questStats);
                                    addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,sample_frequency,sample_quantity,big_species,small_species,high_frequency,questStats,scheduleStartTime,scheduleEndTime,scheduleTestCycle,
                                        electric_sample_id);
                                }
                            }else{
                                addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,sample_frequency,sample_quantity,big_species,small_species,high_frequency,questStats,scheduleStartTime,scheduleEndTime,scheduleTestCycle,
                                    electric_sample_id);
                            }
                        }

                        // window.location.href = '/loginExcelShow?filePath=' + encodeURIComponent(copiedFilePath);
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to copy file:', status, error);
                    }
                });
            });

        });


        function addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,sample_frequencyStr,sample_quantityStr,big_species,small_species,high_frequency,questStats,scheduleStartTime,scheduleEndTime,scheduleTestCycle,
                               electric_sample_id){
            var existModalContent = document.querySelector('.existModal-content');
            existModalContent.innerHTML = '<span class="close">&times;</span><h2>已存在其他版本的文件，请您选择使用哪份文件作为模板使用:</h2>';
            var existModal = document.getElementById("existModal");
            var existSpan = existModal.getElementsByClassName("close")[0];
            existSpan.onclick = function () {
                existModal.style.display = "none";
            }

            // 添加selectedFilePath链接
            var originalFileLink = document.createElement('a');
            originalFileLink.href = 'javascript:void(0);';
            originalFileLink.onclick = function() {
                localStorage.removeItem(`DQE_`);
                localStorage.removeItem(`Developer_`);
                localStorage.removeItem(`supplier_`);

                localStorage.setItem(`model_` ,model);
                localStorage.setItem(`coding_` ,coding);
                localStorage.setItem(`sample_name_` ,sample_name);
                localStorage.setItem(`tester_` ,username);

                let redirectUrl = '/copyClickFile?filePath=' + encodeURIComponent(selectedFilePath)
                    + '&model=' + encodeURIComponent(model)
                    + '&coding=' + encodeURIComponent(coding)
                    + '&category=' + encodeURIComponent(category)
                    + '&version=' + encodeURIComponent(version)
                    + '&sample_name=' + encodeURIComponent(sample_name)
                    // + '&planfinish_time=' + encodeURIComponent(planfinish_time)
                    + '&username=' + encodeURIComponent(username)
                    + '&sample_frequencyStr=' + encodeURIComponent(sample_frequencyStr)
                    + '&sample_quantityStr=' + encodeURIComponent(sample_quantityStr)
                    + '&big_species=' + encodeURIComponent(big_species)
                    + '&small_species=' + encodeURIComponent(small_species)
                    + '&high_frequency=' + encodeURIComponent(high_frequency)
                    + '&questStats=' + encodeURIComponent(questStats)
                    + '&scheduleStartTime=' + encodeURIComponent(scheduleStartTime)
                    + '&scheduleEndTime=' + encodeURIComponent(scheduleEndTime)
                    + '&scheduleTestCycle=' + encodeURIComponent(scheduleTestCycle)
                    + '&electric_sample_id=' + encodeURIComponent(electric_sample_id);

                if (redirectUrl.indexOf('?') !== -1) {
                    redirectUrl += '&dd_orientation=landscape';
                } else {
                    redirectUrl += '?dd_orientation=landscape';
                }

                window.location.href = redirectUrl;
            };
            originalFileLink.textContent = selectedFilePath;
            originalFileLink.style.fontWeight = 'bold'; // 加粗
            existModalContent.appendChild(originalFileLink);
            existModalContent.appendChild(document.createElement('br'));


            filepaths.forEach(function (selectedFilePath) {
                var fileLink = document.createElement('a');
                fileLink.href = 'javascript:void(0);';
                fileLink.onclick = function() {
                    localStorage.removeItem(`DQE_`);
                    localStorage.removeItem(`Developer_`);
                    localStorage.removeItem(`supplier_`);

                    localStorage.setItem(`model_` ,model);
                    localStorage.setItem(`coding_` ,coding);
                    localStorage.setItem(`sample_name_` ,sample_name);
                    localStorage.setItem(`tester_` ,username);

                    let redirectUrl = '/copyClickFile?filePath=' + encodeURIComponent(selectedFilePath)
                        + '&model=' + encodeURIComponent(model)
                        + '&coding=' + encodeURIComponent(coding)
                        + '&category=' + encodeURIComponent(category)
                        + '&version=' + encodeURIComponent(version)
                        + '&sample_name=' + encodeURIComponent(sample_name)
                        // + '&planfinish_time=' + encodeURIComponent(planfinish_time)
                        + '&username=' + encodeURIComponent(username)
                        + '&sample_frequencyStr=' + encodeURIComponent(sample_frequencyStr)
                        + '&sample_quantityStr=' + encodeURIComponent(sample_quantityStr)
                        + '&big_species=' + encodeURIComponent(big_species)
                        + '&small_species=' + encodeURIComponent(small_species)
                        + '&high_frequency=' + encodeURIComponent(high_frequency)
                        + '&questStats=' + encodeURIComponent(questStats)
                        + '&scheduleStartTime=' + encodeURIComponent(scheduleStartTime)
                        + '&scheduleEndTime=' + encodeURIComponent(scheduleEndTime)
                        + '&scheduleTestCycle=' + encodeURIComponent(scheduleTestCycle)
                        + '&electric_sample_id=' + encodeURIComponent(electric_sample_id);

// Check if the URL already contains a query string (i.e., '?')
                    if (redirectUrl.indexOf('?') !== -1) {
                        redirectUrl += '&dd_orientation=landscape';
                    } else {
                        redirectUrl += '?dd_orientation=landscape';
                    }

// Redirect the user to the constructed URL
                    window.location.href = redirectUrl;
                };
                fileLink.textContent = selectedFilePath;
                existModalContent.appendChild(fileLink);
                existModalContent.appendChild(document.createElement('br'));
            });

            existModal.style.display = "block";
        }

        // 创建并显示模态框的函数
        function showEditModal(product) {
            // 创建模态框 HTML
            const modalHTML = `
                <div id="editModal" class="inputModal">
                    <div class="editinputModal-content">
                        <span class="close">&times;</span>
                        <div class="edith2-container">
                            <h2>请输入产品信息</h2>
                            <div class="button-group">
                                <button type="button" id="passbackProblemBtn">回传<br>问题点页面</button>
                                <button type="button" id="viewDataBtn">查看<br>资料</button>
                                <button type="button" id="viewProblemBtn">查看<br>问题点</button>
                                 <!-- 隐藏的文件输入框 -->
                                <input type="file" id="fileInput" accept=".xlsx" style="display:none;" />
                                <button type="button" id="replaceButton">替换<br>报告</button>
                                <button type="button" id="jumpButton">进入<br>报告</button>
                            </div>
                        </div>
                        <form id="fileEditForm">
                        <label for="edit_sample_id">样品id:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_sample_id" name="edit_sample_id" required readonly style="background-color: #e87676;">

                            <label for="edit_model">大编码:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_model" name="edit_model" required readonly style="background-color: #e87676;">
                            <label for="edit_coding">小编码:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_coding" name="edit_coding" required readonly style="background-color: #e87676;">
                            <label for="edit_category">类别:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_category" name="edit_category" required readonly style="background-color: #e87676;">

                            <label for="edit_questStats">任务属性:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_questStats" name="edit_questStats" required readonly style="background-color: #e87676;">

                            <label for="edit_big_species">大类:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_big_species" name="edit_big_species" required readonly style="background-color: #e87676;">
                            <label for="edit_small_species">品类细分:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_small_species" name="edit_small_species" required readonly style="background-color: #e87676;">
                            <label for="edit_high_frequency">是否高频:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_high_frequency" name="edit_high_frequency" required readonly style="background-color: #e87676;">

                            <label for="edit_version">版本:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_version" name="edit_version" required readonly style="background-color: #e87676;">
                            <label for="edit_sample_frequency">送样次数:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_sample_frequency" name="edit_sample_frequency" required readonly style="background-color: #e87676;">
                            <label for="edit_sample_quantity">送样数量:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_sample_quantity" name="edit_sample_quantity" required readonly style="background-color: #e87676;">

                            <label for="edit_scheduleStartTime">排期开始时间:</label>
                            <input type="datetime-local" id="edit_scheduleStartTime" name="edit_scheduleStartTime" required readonly style="background-color: #e87676;">
                            <label for="edit_scheduleEndTime">排期结束时间:</label>
                            <input type="datetime-local" id="edit_scheduleEndTime" name="edit_scheduleEndTime" required readonly style="background-color: #e87676;">
                            <label for="edit_scheduleTestCycle">排期测试周期:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_scheduleTestCycle" name="edit_scheduleTestCycle" required readonly style="background-color: #e87676;">

                            <label for="edit_sample_name">产品名称:</label>
                            <input type="text" id="edit_sample_name" name="edit_sample_name" required placeholder="必填项"><span style="color: red;">*</span><br>
<!--                            <label for="edit_planfinish_time">预计完成时间:</label>-->
<!--                            <input type="datetime-local" id="edit_planfinish_time" name="edit_planfinish_time" required><span style="color: red;">*</span><br>-->
                            <label for="edit_chip_control">主控芯片:</label>
                            <input type="text" id="edit_chip_control" name="edit_chip_control" ><span style="color: red;">*</span><br>
                            <label for="edit_version_software">软件版本:</label>
                            <input type="text" id="edit_version_software" name="edit_version_software" ><span style="color: red;">*</span><br>
                            <label for="edit_version_hardware">硬件版本:</label>
                            <input type="text" id="edit_version_hardware" name="edit_version_hardware" ><span style="color: red;">*</span><br>
                            <label for="edit_supplier">供应商:</label>
                            <input type="text" id="edit_supplier" name="edit_supplier" ><span style="color: red;">*</span><br>
                            <label for="edit_test_Overseas">国内外测试选项:</label>
                            <select id="edit_test_Overseas" name="edit_test_Overseas" required >
                                <option value="" selected>必填项</option>
                                <option value="国内">国内</option>
                                <option value="国外">国外</option>
                                <option value="国内+国外">国内+国外</option>
                            </select><span style="color: red;">*</span>

                            <label for="edit_priority">优先级:</label>
                            <select id="edit_priority" name="edit_priority" required >
                                <option value="" selected>必填项</option>
                                <option value="加急">加急</option>
                                <option value="优先">优先</option>
                                <option value="同步">同步</option>
                                 <option value="普通">普通</option>
                            </select><span style="color: red;">*</span>

                            <label for="edit_sample_remark">备注:</label>
                            <input type="text" id="edit_sample_remark" name="edit_sample_remark" ><br>

                            <label for="edit_sample_DQE">DQE:</label>
                            <input type="text" id="edit_sample_DQE" name="edit_sample_DQE" ><span style="color: red;">*</span><br>
                            <label for="edit_sample_Developer">电子工程师:</label>
                            <input type="text" id="edit_sample_Developer" name="edit_sample_Developer" ><span style="color: red;">*</span><br>

                            <label for="edit_sample_leader">项目负责人:</label>
                            <input type="text" id="edit_sample_leader" name="edit_sample_leader" ><span style="color: red;">*</span><br>

                            <label for="tester">当前测试者:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <select id="tester" name="tester" >
                                <option value="" disabled>如需更换测试者选择此项</option>
                                <option value="骆书英">骆书英</option>
                                <option value="梁秋宇">梁秋宇</option>
                                <option value="黄梁">黄梁</option>
                                <option value="张健榆">张健榆</option>
                                <option value="卢健">卢健</option>
                                <option value="陈培根">陈培根</option>
                                <option value="冯兴旺">冯兴旺</option>
                                <option value="郭喆">郭喆</option>
                                <option value="游宏">游宏</option>
                                <option value="殷嘉俊">殷嘉俊</option>
                                <option value="唐日顺">唐日顺</option>
                                <option value="官旺华">官旺华</option>
                                <option value="刘鹏飞">刘鹏飞</option>
                                <option value="赵梓宇">赵梓宇</option>
                                <option value="段平">段平</option>
                                <option value="魏民">魏民</option>
                                <option value="程奕阳">程奕阳</option>
<!--                                <option value="黄坚">黄坚</option>-->
                                <option value="赵爽">赵爽</option>
                                <option value="罗清虎">罗清虎</option>
                                <option value="龙运">龙运</option>
                                <option value="黄兰姣">黄兰姣</option>
                                <option value="李智龙">李智龙</option>
                                <option value="肖灶炜">肖灶炜</option>
                                <option value="肖龙生">肖龙生</option>
                                <option value="张国鹏">张国鹏</option>
<!--                                <option value="陈昱菲">陈昱菲</option>-->
                                <option value="戴杏华">戴杏华</option>
                                <option value="李素欣1">李素欣1</option>
                                <option value="张锐">张锐</option>
                                <option value="阮晓晴">阮晓晴</option>
<!--                                <option value="蓝明城">蓝明城</option>-->
                                <option value="廖建伟">廖建伟</option>
                                <option value="蔡义会">蔡义会</option>

                            </select>
                            <label for="edit_electric_id">IT提单系统测试编号:</label>
                            <input type="text" id="edit_electric_id" name="edit_electric_id"
                                   placeholder="如有，请在IT系统寻找到对应电气编号，例如ET2505260009">
                            <span style="color: #999; margin-left: 2px;">(非必填)</span><br>

                            <button type="submit">保存信息</button>
                        </form>
                    </div>
                </div>`;

            // 将模态框添加到页面主体中
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('edit_sample_id').value = product.sample_id;
            // 使用产品数据填充模态框
            document.getElementById('edit_model').value = product.sample_model;
            document.getElementById('edit_coding').value = product.sample_coding;
            document.getElementById('edit_category').value = product.sample_category;

            document.getElementById('edit_questStats').value = product.questStats;
            document.getElementById('edit_version').value = product.version;
            document.getElementById('edit_sample_frequency').value = product.sample_frequency;
            document.getElementById('edit_sample_quantity').value = product.sample_quantity;

            document.getElementById('edit_big_species').value = product.big_species;
            document.getElementById('edit_small_species').value = product.small_species;
            document.getElementById('edit_high_frequency').value = product.high_frequency;

            document.getElementById('edit_sample_name').value = product.sample_name;
            document.getElementById('edit_chip_control').value = product.chip_control;
            document.getElementById('edit_version_software').value = product.version_software;
            document.getElementById('edit_version_hardware').value = product.version_hardware;
            document.getElementById('edit_supplier').value = product.supplier;
            document.getElementById('edit_test_Overseas').value = product.test_Overseas;
            document.getElementById('edit_priority').value = product.priority;
            document.getElementById('edit_sample_remark').value = product.sample_remark;
            document.getElementById('edit_sample_DQE').value = product.sample_DQE;
            document.getElementById('edit_sample_Developer').value = product.sample_Developer;
            document.getElementById('edit_sample_leader').value = product.sample_leader;
            document.getElementById('tester').value = product.tester;
            document.getElementById('edit_electric_id').value = product.electric_sample_id;

            document.getElementById('edit_sample_name').addEventListener('input', function(e) {
                // this.value = this.value.replace(/[\\\/]/g, '_');
                // this.value = this.value.replace(/[\\\/:*?"<>|]/g, '_');
                // 清理 sample_name，替换所有 Windows 文件名中的非法字符
                this.value = this.value.replace(/[\/\\:*?"<>|\t]/g, "_");
            });

            // 因为手机端需要有“T”才可以在前端展示这个数据，不然会显示空
            // const formattedPlanFinishTime = product.planfinish_time.replace(' ', 'T');
            // document.getElementById('edit_planfinish_time').value = formattedPlanFinishTime;
            // 检查并更新 scheduleStartTime
            if (product.scheduleStartTime) {
                const formattedScheduleStartTime = product.scheduleStartTime.replace(' ', 'T');
                const startTimeElement = document.getElementById('edit_scheduleStartTime');
                if (startTimeElement) {
                    startTimeElement.value = formattedScheduleStartTime;
                }
            }

            // 检查并更新 scheduleEndTime
            if (product.scheduleEndTime) {
                const formattedScheduleEndTime = product.scheduleEndTime.replace(' ', 'T');
                const endTimeElement = document.getElementById('edit_scheduleEndTime');
                if (endTimeElement) {
                    endTimeElement.value = formattedScheduleEndTime;
                }
            }

            // 检查并更新 scheduleTestCycle
            if (product.scheduleTestCycle) {
                const testCycleElement = document.getElementById('edit_scheduleTestCycle');
                if (testCycleElement) {
                    testCycleElement.value = product.scheduleTestCycle;
                }
            }


            // 显示模态框
            document.getElementById('editModal').style.display = 'block';

            // 点击关闭按钮时关闭模态框
            document.querySelector('#editModal .close').onclick = function() {
                document.getElementById('editModal').remove();
                //保存之后会更新数据库，此时需要重新从后端获取到新的数据才准，所以需要再走一遍获取数据的方法
                // window.location.href = '/testManIndex';
                performSearch();
            };


            // 替换报告按钮
            document.querySelector('#replaceButton').onclick = function() {
                // 获取隐藏的文件输入框
                const fileInput = document.querySelector('#fileInput');

                // 触发文件选择对话框
                fileInput.click();

                // 当用户选择文件时触发
                fileInput.onchange = function() {
                    const file = fileInput.files[0];
                    if (!file) {
                        alert("请选择一个文件进行替换！");
                        return;
                    }

                    // 验证文件类型是否为 .xlsx
                    const fileType = file.name.split('.').pop().toLowerCase();
                    if (fileType !== 'xlsx') {
                        alert("请上传一个 .xlsx 格式的文件！");
                        return;
                    }

                    const fileSizeInMB = (file.size / (1024 * 1024)).toFixed(2); // 将文件大小转换为MB并保留两位小数
                    const estimatedTime = (fileSizeInMB / 6).toFixed(1); // 计算预计时间并保留一位小数
                    // alert(`您选择的文件大小为 ${fileSizeInMB} MB，正在上传中，预计需要 ${estimatedTime} min，请先点击确认关闭本提示框，然后等结果框弹出再操作本文件`);
                    alert(`您选择的文件大小为 ${fileSizeInMB} MB，正在上传中，请先点击确认关闭本提示框，然后等结果框弹出说"替换成功"后再操作本文件`);

                    var sample_id = $('#edit_sample_id').val();

                    // var model = $('#edit_model').val();
                    // var coding = $('#edit_coding').val();
                    // var category = $('#edit_category').val();
                    // var version = $('#edit_version').val();
                    // var big_species = $('#edit_big_species').val();
                    // var small_species = $('#edit_small_species').val();
                    // var high_frequency = $('#edit_high_frequency').val();
                    // var questStats = $('#edit_questStats').val();
                    // var sample_frequency = $('#edit_sample_frequency').val();

                    $.ajax({
                        url: '/testManIndex/getjumpFilepath',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            sample_id: sample_id
                        }),
                        success: function(jumpfilepath){
                            // 使用获取到的文件路径替换服务器上的文件
                            var formData = new FormData();
                            formData.append('file', file);
                            formData.append('filepath', jumpfilepath);

                            $.ajax({
                                url: '/testManIndex/replaceFilepath', // 你需要在后端创建处理这个路径替换的API
                                type: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: async function (response) {
                                    await clearStorage(response)
                                    // 这里处理后端返回的消息
                                    alert(response.message); // 弹出服务器返回的消息（例如 "文件替换成功"）
                                },
                                error: function(xhr, status, error){
                                    alert("文件替换失败，请稍后再试！");
                                }
                            });
                        },
                        error: function(xhr, status, error){
                            alert("替换文件失败,获取不到文件路径!");
                        },
                    });

                };
            };


            document.querySelector('#jumpButton').onclick = function() {
                // 显示模态框
                document.getElementById('loadingModal').style.display = 'block';

                let countdownElement = document.getElementById('countdown');
                let countdownTime = 5;
                let countdownInterval;

                // 更新倒数计时
                function updateCountdown() {
                    countdownTime--;
                    countdownElement.innerText = countdownTime;
                    if (countdownTime <= 0) {
                        clearInterval(countdownInterval);
                        proceedWithRequest();
                    }
                }

                // 启动倒数计时
                countdownInterval = setInterval(updateCountdown, 1000);

                // 取消按钮点击事件
                document.getElementById('cancelButton').onclick = function() {
                    // 清除倒数计时
                    clearInterval(countdownInterval);
                    countdownElement.innerText = 5;
                    // 隐藏模态框
                    document.getElementById('loadingModal').style.display = 'none';
                };

                // 关闭按钮点击事件
                document.getElementById('closeModal').onclick = function() {
                    // 清除倒数计时
                    clearInterval(countdownInterval);
                    countdownElement.innerText = 5;
                    // 隐藏模态框
                    document.getElementById('loadingModal').style.display = 'none';
                };

                // 执行实际的Ajax请求
                function proceedWithRequest() {
                    // 20241226改成通过id去跳转文件地址
                    var sample_id = $('#edit_sample_id').val();

                    var model = $('#edit_model').val();
                    var coding = $('#edit_coding').val();
                    // var category = $('#edit_category').val();
                    // var version = $('#edit_version').val();
                    // var big_species = $('#edit_big_species').val();
                    // var small_species = $('#edit_small_species').val();
                    // var high_frequency = $('#edit_high_frequency').val();
                    // var questStats = $('#edit_questStats').val();
                    // var sample_frequency = $('#edit_sample_frequency').val();
                    var sample_name = $('#edit_sample_name').val();
                    var supplier = $('#edit_supplier').val();

                    var sample_DQE = $('#edit_sample_DQE').val();
                    var sample_Developer = $('#edit_sample_Developer').val();
                    var tester = $('#tester').val();

                    $.ajax({
                        url: '/testManIndex/getjumpFilepath',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            sample_id: sample_id
                            // model: model,
                            // coding: coding,
                            // category: category,
                            // version: version,
                            // big_species: big_species,
                            // small_species: small_species,
                            // high_frequency: high_frequency,
                            // questStats: questStats,
                            // sample_frequency: sample_frequency
                        }),
                        success: function(jumpfilepath){
                            $.ajax({
                                url: '/loginExcelShow',
                                type: 'POST',
                                data: {
                                    filePath: jumpfilepath
                                },
                                success: function(response){
                                    if (response.status === 'success') {
                                        localStorage.setItem(`DQE_` ,sample_DQE);
                                        localStorage.setItem(`Developer_` ,sample_Developer);
                                        localStorage.setItem(`model_` ,model);
                                        localStorage.setItem(`coding_` ,coding);
                                        localStorage.setItem(`sample_name_` ,sample_name);
                                        localStorage.setItem(`supplier_` ,supplier);
                                        localStorage.setItem(`tester_` ,tester);


                                        var redirectUrl = response.redirectUrl;
                                        if (redirectUrl.indexOf('?') !== -1) {
                                            redirectUrl += '&dd_orientation=landscape';
                                        } else {
                                            redirectUrl += '?dd_orientation=landscape';
                                        }
                                        window.location.href = redirectUrl;
                                        // window.location.href = response.redirectUrl;
                                    } else {
                                        alert(response.message);
                                    }
                                },
                                error: function(xhr, status, error){
                                    console.log("文件处理失败", error);
                                    alert("文件处理失败，请稍后再试！");
                                }
                            });
                        },
                        error: function(xhr, status, error){
                            console.log("获取不到文件路径", error);
                            alert("获取不到文件路径!");
                        },
                        complete: function() {
                            // 请求完成后隐藏模态框
                            document.getElementById('loadingModal').style.display = 'none';
                        }
                    });
                }
            };

            // 为 passbackProblemBtn 添加点击事件
            document.getElementById('passbackProblemBtn').addEventListener('click', function() {

                var sample_id = $('#edit_sample_id').val();

                // 创建文件输入元素
                const fileInput = document.createElement
                ('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx';

                // 监听文件选择事件
                fileInput.addEventListener('change', async function() {
                    const file = fileInput.files[0];
                    if (!file) {
                        alert('请选择一个文件');
                        return;
                    }

                    // 验证文件类型
                    const fileName = file.name;
                    const fileExtension = fileName.slice(fileName.lastIndexOf('.') + 1).toLowerCase();
                    if (fileExtension !== 'xlsx') {
                        alert('请上传一个 .xlsx 格式的文件');
                        return;
                    }

                    // 创建表单数据对象并添加文件
                    const formData = new FormData();
                    formData.append('excelFile', file);
                    formData.append('sample_id', sample_id);
                    formData.append('job', job);

                    try {
                        // 显示上传提示
                        alert('文件正在上传，请稍候...');
                        const response = await fetch('/testManIndex/passbackProblem', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error('服务器响应异常');
                        }

                        const result = await response.json();
                        alert(result.message);
                    } catch (error) {
                        console.error('处理文件时出错:', error);
                        alert('处理文件时出错: ' + error.message);
                    }
                });

                // 触发文件选择对话框
                fileInput.click();
            });


            // 为表单添加提交事件监听器
            document.getElementById('fileEditForm').onsubmit = function(event) {
                event.preventDefault(); // 阻止表单默认提交行为
                // 先获取sample_name的值并清理它
                var edit_sample_name = $('#edit_sample_name').val();
                // edit_sample_name = edit_sample_name.replace(/[\/\\]/g, "_");
                edit_sample_name = edit_sample_name.replace(/[\/\\:*?"<>|\t]/g, "_");

                // 更新sample_name的值
                $('#edit_sample_name').val(edit_sample_name);

                var formData = $(this).serialize();

                $.ajax({
                    url: '/testManIndex/updateSamples',
                    type: 'POST',
                    data: formData,
                    success: async function(response){

                        if (response.rename === "重命名成功" || response.message === "更换当前测试人") {
                            await clearStorage(response);
                        }

                        if (response.status === "success") {
                            if (response.message === "更换当前测试人") {
                                document.getElementById('editModal').remove();
                                performSearch();
                            }
                            document.getElementById('edit_sample_DQE').value = $('#edit_sample_DQE').val();
                            document.getElementById('edit_sample_Developer').value = $('#edit_sample_Developer').val();
                            document.getElementById('edit_supplier').value = $('#edit_supplier').val();
                            document.getElementById('edit_sample_name').value = $('#edit_sample_name').val();
                            // 优先显示 warning，如果没有才显示 message
                            if (response.warning && response.warning.trim() !== "") {
                                alert(response.warning);
                            } else {
                                alert(response.message);
                            }
                        } else {
                            alert("文件保存失败: " + response.message);
                        }

                    },
                    error: function(xhr, status, error){
                        console.log("文件保存失败", error);
                        alert("文件保存失败!");
                    }
                });
            };

            document.getElementById('viewProblemBtn').onclick = function() {
                editClickBtn(product.sample_id)
            };

            document.getElementById('viewDataBtn').onclick = function() {
                viewDataClick(product.sample_id)
            };


        }

        // 执行搜索的函数
        function performSearch() {
            // 获取搜索关键词
            var keyword = $('.search-input').val().trim();
            // 获取选定的筛选条件
            var sortFilter = $('#sort-filter').val();
            // 清空当前显示的数据
            $('.table-container').empty();

            // 发送搜索请求到后端
            $.ajax({
                url: '/searchSamples', // 后端搜索接口地址
                type: 'POST',
                contentType: 'application/json', // 添加这一行
                data: JSON.stringify({
                    keyword: keyword,
                    sortFilter: sortFilter,
                    username: username
                }),
                success: function(data) {
                    const type = "search";
                    renderTableContainer(data,type);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status === 401) {
                        // 会话超时，重定向到index.html
                        window.location.href = '/index.html';
                    } else {
                        // 处理其他错误
                        console.error('Error:', textStatus, errorThrown);
                    }
                }
            });
        }




        function returnResult(result_judge) {
            switch (result_judge) {
                case 0:
                    return "签样";
                case 1:
                    return "退样";
                case 2:
                    return "限收";
                case 3:
                    return "特采";
                case 4:
                    return "会议评审接受";
                default:
                    return "未知"; // 默认返回值
            }
        }


        //搜索或者初始化加载渲染文件表格的方法
        function renderTableContainer(data,type){
            // 渲染新的搜索结果
            if (data.length > 0) {
                // 渲染每个表格
                data.forEach(function(product, index) {
                    // 创建表格和按钮的容器
                    var tableAndButtons = '<div class="table-and-buttons">';

                    var isDanger = (product.danger && product.danger.trim() !== "") ||
                        (product.finish_time && new Date(product.finish_time).getTime() > new Date(product.scheduleEndTime).getTime()) ||
                        (!product.finish_time && new Date().getTime() > new Date(product.scheduleEndTime).getTime()) ||
                        (product.finish_time && product.sample_schedule === '0' && new Date().getTime() > new Date(product.scheduleEndTime).getTime());

                    // 如果 scheduleEndTime 为 null，则 isDanger 一定为 false
                    if (product.scheduleEndTime === null) {
                        isDanger = false;
                    }

                    // 根据条件 isDanger 来决定 tableClass 的值
                    var tableClass = isDanger ? 'product-table danger' : 'product-table';

                    // 创建 table 元素的 HTML 字符串，并添加类名和数据属性
                    var table = '<table class="' + tableClass + '" data-filepath="' + product.filepath + '" data-finish_time="' + product.finish_time + '" data-planfinish_time="' + product.planfinish_time + '">';table += '<thead>';
                    table += '<tr>';
                    table += '<th rowspan="1" colspan="1" title="样品进度：' + getSampleScheduleDescription(product.sample_schedule) + '">' + '进度：'+ getSampleScheduleDescription(product.sample_schedule) + '</th>';
                    // 每个单元格的具体值作为title属性的值
                    table += '<th colspan="2" title="大型号' + product.sample_model + ', 小型号' + product.sample_coding  + '">' + '' + product.sample_model + ' ' + product.sample_coding  + '</th>';
                    table += '<th colspan="1" title="类别：' + product.sample_category + ', 版本' + product.version + ', 任务属性' + product.questStats  + '">' + product.sample_category + ' ' + product.version + ' ' + product.questStats + '</th>';
                    table += '<th colspan="1" title="第' + product.sample_frequency + '次送样' +'">' + '第' + product.sample_frequency + '次送样' + '</th>';
                    table += '</tr>';
                    table += '<tr>';
                    table += '<th colspan="1" title="大类' + product.big_species + ', 品类细分' + product.small_species + '">' + '' + product.big_species + ' ' + product.small_species +  '</th>';
                    table += '<th colspan="2" title="供应商' + product.supplier + ', 供应商' + product.supplier + '">' + '供应商：' + '' + product.supplier +  '</th>';
                    table += '<th colspan="1" title="产品名称：' + product.sample_name + '">' + product.sample_name + '</th>';
                    table += '<th colspan="1" title="预计时长：' + product.scheduleTestCycle + "天，实测时长"+ product.testDuration+'小时">' + "预计时长：" + product.scheduleTestCycle +"天" +" " + "实测时长：" + product.testDuration +"小时" + '</th>';
                    table += '</tr>';
                    table += '</thead>';
                    table += '</table>';

                    // 创建下拉菜单按钮, 根据sample_schedule动态设置按钮文本
                    var buttonLabel = '';
                    if (product.sample_schedule === "0") {
                        buttonLabel = '提交';
                    } else if (product.sample_schedule ===  "1" ) {//一旦DQE审核了则不允许撤回
                        buttonLabel = '撤回';
                    } else if(product.sample_schedule ===  "2" ){
                        buttonLabel = '审核完结';
                    }else if ( product.sample_schedule === "9") {
                        buttonLabel = '退样了';
                    }else if ( product.sample_schedule === "10") {
                        buttonLabel = '竞品完成';
                    }


                    // // 创建下拉菜单按钮,注意：data-...：右边的字段会强制转为小写，所以在获取属性的时候记得也要用小写！
                    var dropdown = '<div class="dropdown">';
                    dropdown += '<button class="dropbtn">操作</button>';
                    dropdown += '<div class="dropdown-content">';

                    dropdown += '<a href="#" class="finish-btn" ' +
                        'data-filepath="' + product.filepath + '" ' +
                        'data-sample_model="' + product.sample_model + '" ' +
                        'data-sample_coding="' + product.sample_coding + '" ' +
                        'data-sample_category="' + product.sample_category + '" ' +
                        'data-version="' + product.version + '" ' +
                        'data-sample_frequency="' + product.sample_frequency + '" ' +
                        'data-big_species="' + product.big_species + '" ' +
                        'data-small_species="' + product.small_species + '" ' +
                        'data-high_frequency="' + product.high_frequency + '" ' +
                        'data-sample_schedule="' + product.sample_schedule + '" ' +
                        'data-sample_id="' + product.sample_id + '" ' +
                        'data-sample_dqe="' + product.sample_DQE + '" ' +
                        'data-sample_rd="' + product.sample_Developer + '" ' +
                        'data-sample_leader="' + product.sample_leader + '" ' +
                        'data-result_judge="' + product.result_judge + '" ' +
                        'data-rd_result_judge="' + product.rd_result_judge + '" ' +
                        'data-queststats="' + product.questStats + '">' + buttonLabel + '</a>';



                    dropdown += '<a href="#" class="forward-btn" data-filepath="' + product.filepath + '">转发</a>';
                    dropdown += '<a href="#" class="delete-btn" data-filepath="' + product.filepath +  '" data-sample_id="' + product.sample_id + '">删除</a>';
                    dropdown += '</div>';
                    dropdown += '</div>';

                    // 结束表格和按钮的容器
                    tableAndButtons += table + dropdown + '</div>';

                    // 将表格添加到页面中
                    $('.table-container').append(tableAndButtons);

                    // 添加点击事件
                    $('.product-table').last().on('click', function() {
                        showEditModal(product);
                    });

                    $('.table-container').off('click', '.finish-btn').on('click', '.finish-btn', function() {
                        // 这部分有个很重要的地方要提示开发者，就是下边这些data()括号内的字段必须是小写才能捕获到对应的data-标签的信息，也就是说
                        // 在前端存信息在标签里必须以小写来作为参数否则无效
                        var model = $(this).data('sample_model');
                        var coding = $(this).data('sample_coding');
                        var category = $(this).data('sample_category');
                        var version = $(this).data('version');
                        var schedule = $(this).data('sample_schedule');
                        var filepath = $(this).data('filepath');
                        var result_judge = returnResult($(this).data('result_judge'));
                        var rd_result_judge = returnResult($(this).data('rd_result_judge'));
                        // 获取DQE,rd，和项目的值，为了在提交的时候检查是否填写了，不然不允许提交
                        var dqe = $(this).data('sample_dqe');
                        var rd = $(this).data('sample_rd');
                        var projectLeader = $(this).data('sample_leader');


                        var sample_frequency = $(this).data('sample_frequency');
                        var big_species = $(this).data('big_species');
                        var small_species = $(this).data('small_species');
                        var high_frequency = $(this).data('high_frequency');

                        var questStats = $(this).data('queststats');  // 确保获取questStats数据
                        var sample_id  = $(this).data('sample_id');

                        if (schedule === 0) {

                            // 由于你覆盖了 confirm，可以直接用原生 confirm
                            confirm(`你确定要提交 ${filepath} 吗？`)
                                .then((confirmation) => {
                                    if (confirmation) {
                                        finishBtn(confirmation,
                                            filepath, model, coding, category, version, schedule,
                                            big_species, small_species, high_frequency, sample_frequency,
                                            questStats, sample_id, dqe ,rd ,projectLeader
                                        );
                                    }
                                });
                        } else if (schedule === 1) {
                            confirm(`${filepath}待审核中，你确定要撤回吗?`)
                                .then((confirmation) => {
                                    if (confirmation) {
                                        finishBtn(confirmation,
                                            filepath, model, coding, category, version, schedule,
                                            big_species, small_species, high_frequency, sample_frequency,
                                            questStats, sample_id, dqe
                                        );
                                    }
                                });
                        } else if (schedule === 2 ) {
                            alert(`${filepath}本项目已审核！研发判定结果：${rd_result_judge}, DQE判定结果：${result_judge}`);
                        }

                    });

                    // 绑定点击事件到转发和删除按钮
                    $('.table-container').off('click', '.forward-btn').on('click', '.forward-btn', function() {

                        var filepath = $(this).data('filepath'); // 获取文件路径
                        // 检查文件大小（这需要你能够在前端获取到文件大小信息）
                        // if (!confirm('文件较大，转发可能需要较长时间。是否继续？')) {
                        //     return; // 用户选择不上传
                        // }


                        // 选择联系人
                        dd.biz.contact.choose({
                            multiple: false,
                            users: [],
                            corpId: corp_id,
                            max: 1,
                            onSuccess: function (data) {
                                const selectedUserId = data[0].emplId; // 获取单个用户ID

                                // 选择钉盘目录
                                dd.chooseDingTalkDir({
                                    corpId: corp_id, // 企业ID
                                    onSuccess: function (res) {
                                        const selectedDirId = res.data[0].dirId; // 获取选中的目录ID
                                        const selectedSpaceId = res.data[0].spaceId; // 获取选中的空间ID

                                        // 获取应用免登授权码
                                        dd.runtime.permission.requestAuthCode({
                                            corpId: corp_id,
                                            onSuccess: function (result) {
                                                const authCode = result.code; // 获取到授权码
                                                // 发起后端请求上传文件和发送文件
                                                $.ajax({
                                                    url: '/testManIndex/uploadFileToDingtalk',
                                                    type: 'POST',
                                                    data: {
                                                        filepath: filepath,
                                                        dirId: selectedDirId,
                                                        spaceId: selectedSpaceId,
                                                        authCode: authCode,
                                                        receiverId: selectedUserId,
                                                        username : username
                                                    },
                                                    success: function (response) {
                                                        alert('文件上传并发送成功');
                                                        // hideLoading(); // 隐藏加载提示框
                                                    },
                                                    error: function (xhr, status, error) {
                                                        alert('文件上传发送失败: ' + error);
                                                        // hideLoading(); // 隐藏加载提示框
                                                    }
                                                });
                                            },
                                            onFail: function (err) {
                                                alert('获取授权码失败：' + JSON.stringify(err));
                                                // hideLoading(); // 隐藏加载提示框
                                            }
                                        });
                                    },
                                    fail: function (err) {
                                        alert('选择目录失败：' + JSON.stringify(err));
                                        // hideLoading(); // 隐藏加载提示框
                                    },
                                    onCancel: function () {
                                        alert('选择目录取消');
                                        // hideLoading(); // 隐藏加载提示框
                                    }
                                });
                            },
                            onFail: function (err) {
                                alert("选择联系人出错" + err);
                                hideLoading();// 隐藏加载提示框
                            }
                        });
                    });


                    $('.table-container').off('click', '.delete-btn').on('click', '.delete-btn', function() {
                        var filepath = $(this).data('filepath');
                        var sample_id = $(this).data('sample_id');

                        // 弹出确认对话框
                        confirm("你确定要删除 " + filepath + " 吗？此操作会将文件和记录删除且不可逆")
                            .then((confirmation) => {
                                if (confirmation) {
                                    // 用户点击了确认
                                    $.ajax({
                                        url: '/testManIndex/deleteSampleAndIssues', // 控制器的路径
                                        type: 'POST', // 或者 'GET'，取决于你的需求
                                        contentType: 'application/json',
                                        data: JSON.stringify({ filepath: filepath, sample_id: sample_id }), // 发送到服务器的JSON数据
                                        success: async function(response) {
                                            await sendLogToServer(response.message);
                                            await clearStorage(response);
                                            if (response.status === "success") {
                                                const storageKey = `sheetData_${filepath}`;
                                                if (localStorage.getItem(storageKey) !== null) {
                                                    localStorage.removeItem(storageKey);
                                                    await sendLogToServer(`已清理 ${storageKey} 的缓存`);
                                                }
                                                const sheetNameKey = `sheetNames_${filepath}`;
                                                if (localStorage.getItem(sheetNameKey) !== null) {
                                                    localStorage.removeItem(sheetNameKey);
                                                    await sendLogToServer(`已清理 ${sheetNameKey} 的缓存`);
                                                }
                                            }
                                            alert(response.message);
                                            window.location.href = '/testManIndex';
                                        },
                                        error: async function(xhr, status, error) {
                                            // 这里处理错误的回调
                                            await sendLogToServer('删除失败: ' + error);
                                        }
                                    });
                                }
                                // 如果用户点击取消，什么也不做
                            });
                    });



                });


            } else if(type === "search") {
                // 清空当前显示的数据
                $('.table-container').empty();
                // 如果没有搜索结果，显示提示信息或者其他操作
                $('.table-container').html('<p>没有搜索对应的数据</p>');
            }else if(type === "initialize"){
                // 如果没有数据，显示静态表头
                $('.static-header').show();
            }
        }


        function finishBtn(confirmation, filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, dqe ,rd ,projectLeader ) {
            if (confirmation) {
                if (schedule === 0) {
                    // 显示休息天数模态框
                    openModal(function(restDays) {
                        // 显示退样或竞品选择模态框
                        openChoiceModal(function(choice) {
                            if (choice === '退样') {
                                const tuiOrJp = "tui";
                                alert('用户选择了退样，后续处理逻辑可以在这里完成。');
                                submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe, null, tuiOrJp);
                                // 如果需要，调用后续逻辑
                            } else if (choice === '竞品') {

                                alert('用户选择了竞品，后续处理逻辑可以在这里完成。');
                                if(!dqe && !rd){
                                    alert("竞品需要填写对应项目的DQE、RD，请起码填写一个，才能准确发送对应流程提醒他们！");
                                    return;
                                }
                                const tuiOrJp = "jp";
                                // 如果需要，调用后续逻辑
                                submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe , rd , tuiOrJp);
                            } else {
                                if (!dqe || !rd || !projectLeader) {
                                    alert("检测到您没填写对应项目的DQE、RD，和项目负责人，请填写，才能准确发送对应流程提醒他们！");
                                    return;
                                }

                                confirm(`你确定要提交 ${filepath} 吗？`)
                                    .then((confirmation)=>{
                                        if(confirmation){
                                            submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe, rd);
                                        }
                                    })
                            }
                        });
                    });
                }else if(schedule === 1){
                    if (confirmation) {
                        // 执行撤回操作
                        submitFinish(
                            filepath,
                            model,
                            coding,
                            category,
                            version,
                            schedule,
                            big_species,
                            small_species,
                            high_frequency,
                            sample_frequency,
                            questStats,
                            sample_id,
                            0, // 撤回时无休息天数
                            dqe
                        );
                    }

                }
            }
        }


        function openModal(callback) {
            const modal = document.getElementById('restDaysModal');
            modal.style.display = 'block';

            // 绑定确认按钮的点击事件
            window.submitRestDays = function() {
                const input = document.getElementById('restDaysInput').value.trim();
                const numberPattern = /^(0|[1-9]\d*)(\.\d)?$/;
                const restDays = parseFloat(input);

                if (!numberPattern.test(input) || (restDays % 0.5 !== 0) || restDays < 0) {
                    alert("请输入一个有效的休息天数！例如：0.5, 1, 1.5");
                    return;
                }

                closeModal();
                if (callback) callback(restDays);
            };

            // 绑定取消按钮的点击事件
            window.closeModal = function() {
                modal.style.display = 'none';
            };
        }

        function openChoiceModal(callback) {
            const choiceModal = document.getElementById('choiceModal');
            choiceModal.style.display = 'block';

            // 绑定选择按钮的点击事件
            document.getElementById('btnRetireSample').onclick = function() {
                closeChoiceModal();
                if (callback) callback('退样');
            };

            document.getElementById('btnCompetitive').onclick = function() {
                closeChoiceModal();
                if (callback) callback('竞品');
            };

            document.getElementById('btnNoChoice').onclick = function() {
                closeChoiceModal();
                if (callback) callback('无选择');
            };

            function closeChoiceModal() {
                choiceModal.style.display = 'none';
            }
        }

        function submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe , rd, tuiOrJp) {
            // 用户点击了确认
            $.ajax({
                url: '/testManIndex/finishTest', // 控制器的路径
                type: 'POST', // 或者 'GET'，取决于你的需求
                contentType: 'application/json',
                data: JSON.stringify({
                    filepath: filepath,
                    model: model,
                    coding: coding,
                    category: category,
                    version: version,
                    schedule: schedule,
                    big_species: big_species,
                    small_species: small_species,
                    high_frequency: high_frequency,
                    sample_frequency: sample_frequency,
                    questStats: questStats,
                    sample_id: sample_id,
                    restDays: restDays, // 添加用户输入的休息天数
                    tuiOrJp : tuiOrJp
                }), // 发送到服务器的JSON数据
                success: function(response) {
                    const statusBarBgColor = "0xFF5E97F6";
                    // 这里处理成功的回调，比如提示用户或者更新UI
                    alert(response.message);
                    if (dqe && response.message.includes("提交成功")) {
                        updateSchedule("1", sample_id, dqe, statusBarBgColor, username, "DQE");

                        setTimeout(() => {
                            updateSchedule("1", sample_id, rd, statusBarBgColor, username, "rd");
                        }, 2000); // 2000 毫秒 = 2 秒

                        // 等待 2 秒后发送给绮敏
                        // setTimeout(() => {
                        //     updateSchedule("1", sample_id, "许梦瑶", statusBarBgColor, username, "notice");
                        // }, 2000); // 2000 毫秒 = 2 秒

                    }else if(dqe && response.message.includes("退样成功")){
                        updateSchedule("9", sample_id, dqe, statusBarBgColor, username, job);
                        // 等待 2 秒后发送给绮敏
                        setTimeout(() => {
                            updateSchedule("1", sample_id, "许梦瑶", statusBarBgColor, username, "notice");
                        }, 2000); // 2000 毫秒 = 2 秒

                    }else if(response.message.includes("竞品文件完成")){

                        if (dqe) {
                            setTimeout(() => {
                                updateSchedule("10", sample_id, dqe, statusBarBgColor, username, job);
                            }, 2000); // 2000 毫秒 = 2 秒
                        }
                        if(rd){
                            setTimeout(() => {
                                updateSchedule("10", sample_id, rd, statusBarBgColor, username, job);
                            }, 2000); // 2000 毫秒 = 2 秒

                        }

                        // 等待 2 秒后发送给绮敏
                        setTimeout(() => {
                            updateSchedule("1", sample_id, "许梦瑶", statusBarBgColor, username, "notice");
                        }, 2000); // 2000 毫秒 = 2 秒
                    }
                    initData();
                    performSearch();
                },
                error: function(xhr, status, error) {
                    // 这里处理错误的回调
                    alert('提交按钮出现错误: ' + error);
                }
            });
        }


        function hideLoading() {
            // 隐藏加载动画或提示框的实现
            $('#loading').remove();
        }

        // 监听version填单的时候自动转换成大写
        document.getElementById('version').addEventListener('keyup', function(e) {
            this.value = this.value.toUpperCase();
        });


        // 为sample_name输入框添加事件监听器
        document.getElementById('sample_name').addEventListener('input', function(e) {
            // this.value = this.value.replace(/[\\\/]/g, '_');
            this.value = this.value.replace(/[\/\\:*?"<>|\t]/g, "_");
        });

        document.getElementById('model').addEventListener('input', function(e) {
            // this.value = this.value.replace(/[\\\/]/g, '_');
            this.value = this.value.replace(/[\\\/:*?"<>|]/g, '无');
        });

        document.getElementById('coding').addEventListener('input', function(e) {
            // this.value = this.value.replace(/[\\\/]/g, '_');
            this.value = this.value.replace(/[\\\/:*?"<>|]/g, '无');
        });

        document.getElementById('version').addEventListener('input', function(e) {
            // this.value = this.value.replace(/[\\\/]/g, '_');
            this.value = this.value.replace(/[\\\/:*?"<>|]/g, '无');
        });


        //选择大类之后选择小类
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/json/categories.json')
                .then(response => response.json())
                .then(data => {
                    const bigSpeciesSelect = document.getElementById('big_species');

                    // 填充大类选择器
                    for (const bigSpecies in data) {
                        const option = document.createElement('option');
                        option.value = bigSpecies;
                        option.textContent = bigSpecies;
                        bigSpeciesSelect.appendChild(option);
                    }

                    // 存储数据供后续使用
                    window.categoryData = data;
                });
        });

        function populateSubCategory() {
            const bigSpeciesSelect = document.getElementById('big_species');
            const smallSpeciesSelect = document.getElementById('small_species');
            const bigSpeciesCategory = bigSpeciesSelect.value;

            // 清空当前的细分品类选项
            smallSpeciesSelect.innerHTML = '<option value="" disabled selected>请选择细分品类</option>';

            if (window.categoryData) {
                let smallSpeciesArray = [];
                if (bigSpeciesCategory === "竞品-预研类" || bigSpeciesCategory === "高频类") {
                    for (const category in window.categoryData) {
                        if (category !== "竞品-预研类" && category !== "高频类") {
                            window.categoryData[category].forEach(subCategory => {
                                smallSpeciesArray.push(`${category}-${subCategory}`);
                            });
                        }
                    }
                } else if (window.categoryData[bigSpeciesCategory]) {
                    smallSpeciesArray = window.categoryData[bigSpeciesCategory];
                }

                smallSpeciesArray.forEach(smallSpecies => {
                    const option = document.createElement('option');
                    option.value = smallSpecies;
                    option.textContent = smallSpecies;
                    smallSpeciesSelect.appendChild(option);
                });
            }
        }

        async function sendLogToServer(logMessage) {
            try {
                await $.ajax({
                    url: '/log/debug',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: logMessage })
                });
            } catch (error) {
                console.error('发送日志失败: ', error);
            }
        }

        async function clearStorage(response) {
            const storageKey = `sheetData_${response.oldFilePath}`;
            const sheetNamesKey = `sheetNames_${response.oldFilePath}`;
            const collectDataKey = `collectData_${response.oldFilePath}`;
            if (localStorage.getItem(storageKey) !== null) {
                localStorage.removeItem(storageKey);
                await sendLogToServer(`已清理 ${storageKey} 的缓存`);
            }else{
                await sendLogToServer(`没有 ${storageKey} 的缓存`);
            }
            if (localStorage.getItem(sheetNamesKey) !== null) {
                localStorage.removeItem(sheetNamesKey);
                await sendLogToServer(`已清理 ${sheetNamesKey} 的缓存`);
            }else{
                await sendLogToServer(`没有 ${sheetNamesKey} 的缓存`);
            }
            if (localStorage.getItem(collectDataKey) !== null) {
                localStorage.removeItem(collectDataKey);
                await sendLogToServer(`已清理 ${collectDataKey} 的缓存`);
            }else{
                await sendLogToServer(`没有 ${collectDataKey} 的缓存`);
            }

            try {
                await $.ajax({
                    url: '/testManIndex/clearJson',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ oldFilePath: response.oldFilePath})
                });
            } catch (error) {
                console.error('发送日志失败: ', error);
            }




        }


        // 获取元素
        const announcementBtn = document.getElementById('announcement-btn');
        const logModal = document.getElementById('log-modal');
        const closeBtn = document.querySelector('.close-btn');

        // 点击按钮显示面板
        announcementBtn.addEventListener('click', () => {
            logModal.style.display = 'block';
        });

        // 点击关闭按钮隐藏面板
        closeBtn.addEventListener('click', () => {
            logModal.style.display = 'none';
        });

        // 点击模态框外部隐藏面板
        window.addEventListener('click', (event) => {
            if (event.target == logModal) {
                logModal.style.display = 'none';
            }
        });


        // 定义一个函数，根据sample_schedule的值返回对应的描述文字
        function getSampleScheduleDescription(value) {
            switch (value) {
                case "0":
                    return "测试中";
                case "1":
                    return "待DQE和研发审核";
                case "2":
                    return "审核完成";
                // case "3":
                //     return "待DQE判定";
                // case "4":
                //     return "已完成";
                case "9":
                    return "测试人员退样";
                case "10":
                    return "测试人员竞品完成";
                default:
                    return ""; // 可以根据需要返回默认值或空字符串
            }
        }

        //2024.10.31  新增一个查看问题点的按钮
        async function editClickBtn(sampleId) {
            // 如果正在编辑，直接返回，避免重复请求
            if (isEditing){
                alert("请不要频繁点击，正在搜索上一个点击的问题点,如果一直出现这个提示，可以关闭应用重新进来")
                return;
            }

            isEditing = true; // 设置为正在编辑状态

            // **先调用通用方法获取参数**
            const checkJudge = await checkSampleResult(sampleId);

            // 如果 checkJudge 为 true，禁用编辑功能
            const isEditDisabled = checkJudge === true;

            fetch(`/problemMoudle/editClickBtn?sampleId=${sampleId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data)
                    const modal = document.getElementById('testIssuesModal');
                    const contentDiv = document.getElementById('testIssuesContent');

                    // 清空之前的内容
                    contentDiv.innerHTML = '';

                    // 创建一个表格容器
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'problem-container';

                    // 创建表格
                    const table = document.createElement('table');
                    table.className = 'problem-table';

                    // 创建列名行
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'header-row';
                    const attributes = [
                        { label: 'ID(点击删除)', field: 'id' },
                        { label: '责任单位（必填）', field: 'responsibleDepartment' },
                        { label: 'DQE确认', field: 'dqe_confirm' },
                        { label: 'DQE意见信息', field: 'dqe_confirm_inform' },
                        { label: '研发确认', field: 'rd_confirm' },
                        { label: '研发意见信息', field: 'rd_confirm_inform' },
                        // 前移
                        { label: '缺陷等级(只写SABC)', field: 'defect_level' },
                        { label: '当前状态', field: 'current_status' },
                        { label: '问题类别', field: 'problemCategory' },
                        { label: '评审结论', field: 'review_conclusion' },
                        { label: 'SKU', field: 'sku' },

                        { label: '完整型号', field: 'full_model' },
                        { label: '样品阶段', field: 'sample_stage' },
                        { label: '版本', field: 'version' },
                        { label: '芯片方案', field: 'chip_solution' },
                        { label: '测试平台', field: 'test_platform' },
                        { label: '显示设备', field: 'test_device' },
                        { label: '其他设备', field: 'other_device' },
                        { label: '问题描述', field: 'problem' },

                        { label: '问题图片', field: 'problem_image_or_video' },
                        { label: '问题时间', field: 'problem_time' },
                        { label: '复现方法', field: 'reproduction_method' },
                        { label: '恢复方法', field: 'recovery_method' },
                        { label: '复现概率', field: 'reproduction_probability' },

                        { label: '对比上一版或竞品', field: 'comparison_with_previous' },
                        //  20250101 新增模板字段
                        { label: 'DQE&研发确认', field: 'dqe_and_development_confirm' },
                        { label: 'DQE确认回复', field: 'green_union_dqe' },
                        { label: '研发确认回复', field: 'green_union_rd' },
                        { label: '方案商', field: 'solution_provider' },
                        { label: '供应商', field: 'supplier' },


                        { label: '提出人', field: 'tester' },
                        // { label: '改善对策（研发回复）', field: 'improvement_plan' },
                        { label: '分析责任人', field: 'responsible_person' },
                        { label: '改善后风险', field: 'post_improvement_risk' },
                        { label: '下一版回归测试', field: 'next_version_regression_test' },
                        { label: '备注', field: 'remark' },
                        { label: '创建时间', field: 'created_at' },
                        { label: '历史ID', field: 'history_id' },
                        { label: '问题点创建者', field: 'created_by' },
                        { label: '最后一次改动者', field: 'modifier' },
                        { label: '改动时间', field: 'modify_at' }
                    ];

                    attributes.forEach((attr, index) => {
                        const headerCell = document.createElement('th');
                        headerCell.className = `header-cell header-cell-${index + 1}`;

                        // 创建可滚动的 div
                        const headerDiv = document.createElement('div');
                        headerDiv.textContent = attr.label; // 显示 label
                        enableDragScroll(headerDiv);
                        headerCell.appendChild(headerDiv);
                        headerRow.appendChild(headerCell);
                    });

                    // 将列名行添加到表格
                    table.appendChild(headerRow);

                    // 存储被修改的数据行
                    let modifiedData = [];

                    data.forEach(item => {
                        // 创建值行
                        const valueRow = document.createElement('tr');
                        valueRow.className = 'value-row';

                        attributes.forEach((attr, index) => {
                            const valueCell = document.createElement('td');
                            valueCell.className = `value-cell value-cell-${index + 1}`;

                            // 创建可滚动的 div
                            const valueDiv = document.createElement('div');
                            let value; // 声明 value 变量

                            if (attr.field === 'dqe_confirm_inform') {
                                value = `${item.dqe_confirm_at}, ${item.dqe}`;
                            } else if (attr.field === 'rd_confirm_inform') {
                                value = `${item.rd_confirm_at}, ${item.rd}`;
                            } else {
                                value = item[attr.field];
                            }

                            // 获取“提出人”列的值
                            const responsiblePersonValue = item['tester']; // 假设 'responsiblePerson' 为提出人列的字段名


                            if (index === 0 || index === 1 || index === 19 || index === 6 || index === 7 || index === 8 || index === 35
                                || index ===36 || index === 37 || index === 38 || index === 39) { // 序号，问题图片,当前状态,创建时间,历史ID
                                if(index === 19){
                                    if (value && (String(value).includes('/imageDirectory/') || String(value).includes('/issuespath/'))) {
                                        // 判断是否为有效图片路径
                                        const img = document.createElement('img');
                                        img.src = value.replace(/#/g, '%23') + '?t=' + new Date().getTime();  // 防止缓存，追加时间戳
                                        img.style.maxWidth = '100px';  // 设置图片最大宽度
                                        img.style.maxHeight = '80px';  // 设置图片最大高度
                                        img.style.cursor = 'pointer';  // 设置点击样式

                                        // 处理图片加载错误
                                        img.onerror = function () {
                                            console.error('图片加载失败:', img.src);
                                            img.style.display = 'none';  // 隐藏加载失败的图片
                                        };

                                        // 点击图片显示大图
                                        img.addEventListener('click', function () {
                                            showImageModal(img.src,sampleId,item.id,modifiedData, responsiblePersonValue);
                                        });

                                        valueDiv.appendChild(img);  // 添加图片到 valueDiv 中
                                    }else{
                                        const uploadText = document.createElement('div');
                                        uploadText.textContent = '上传图片';  // 显示“上传图片”
                                        uploadText.style.cursor = 'pointer';  // 设置点击样式
                                        uploadText.style.color = '#8a4e07';  // 设置文本颜色

                                        if(responsiblePersonValue === username && !isEditDisabled){
                                            // 点击时触发选择文件的方法
                                            uploadText.addEventListener('click', function () {
                                                const input = document.createElement('input');
                                                input.type = 'file';
                                                input.accept = 'image/*';  // 仅接受图片类型
                                                // 选择文件后上传
                                                input.addEventListener('change', function (event) {
                                                    const file = event.target.files[0];
                                                    if (file) {
                                                        // 在这里调用上传文件的方法，并传入 sampleId
                                                        uploadImage(file, sampleId , item.id,modifiedData);
                                                    }
                                                });

                                                input.click();  // 自动触发文件选择
                                            });
                                        }

                                        valueDiv.appendChild(uploadText);  // 添加“上传图片”到 valueDiv 中
                                    }
                                }else if(index === 7){
                                    // 定义需要转换为下拉框的选项
                                    const validOptions = ['OPEN', 'CLOSED', 'FOLLOW UP', '待确定'];

                                    // 将传递过来的值转换为统一格式，并检查是否需要转换CLOSE为CLOSED
                                    let normalizedValue = String(value).toUpperCase();

                                    if (normalizedValue === 'CLOSE') {
                                        normalizedValue = 'CLOSED';  // 自动将CLOSE转换为CLOSED
                                    }

                                    // 如果值不在有效选项内，则将值设置为“待确定”
                                    if (!validOptions.includes(normalizedValue)) {
                                        normalizedValue = '待确定';
                                    }

                                    // 创建下拉框
                                    const select = document.createElement('select');

                                    // 创建下拉选项
                                    validOptions.forEach(option => {
                                        const optionElement = document.createElement('option');
                                        optionElement.value = option;
                                        optionElement.textContent = option;

                                        // 设置默认选中的选项
                                        if (normalizedValue === option) {
                                            optionElement.selected = true;
                                        }

                                        select.appendChild(optionElement);
                                    });

                                    // 如果禁用编辑，禁用下拉框
                                    if (isEditDisabled) {
                                        select.disabled = true;
                                        select.style.opacity = '0.5';
                                        select.style.cursor = 'not-allowed';
                                    }

                                    // 监听下拉框的变化事件
                                    select.addEventListener('change', function () {
                                        // 如果禁用状态，不允许修改
                                        if (isEditDisabled) {
                                            return;
                                        }

                                        const selectedValue = select.value;
                                        console.log('状态已更新为:', selectedValue);  // 处理下拉框值的变化

                                        // 如果新值和旧值不同，标记为已修改
                                        if (selectedValue !== normalizedValue) {
                                            item[attr.field] = selectedValue;
                                            if (!modifiedData.includes(item)) {
                                                modifiedData.push(item); // 标记修改过的数据
                                            }
                                        }
                                    });

                                    valueDiv.appendChild(select);  // 添加下拉框到 valueDiv 中
                                }else if(index === 8){
                                    // 定义需要转换为下拉框的选项
                                    const validOptions = ['电气性能', '兼容性','可靠性', '工艺' ,'待确定'];

                                    // 将传递过来的值转换为统一格式，并检查是否需要转换CLOSE为CLOSED
                                    let normalizedValue = String(value);

                                    // 如果值不在有效选项内，则将值设置为“待确定”
                                    if (!validOptions.includes(normalizedValue)) {
                                        normalizedValue = '待确定';
                                    }

                                    // 创建下拉框
                                    const select = document.createElement('select');

                                    // 创建下拉选项
                                    validOptions.forEach(option => {
                                        const optionElement = document.createElement('option');
                                        optionElement.value = option;
                                        optionElement.textContent = option;

                                        // 设置默认选中的选项
                                        if (normalizedValue === option) {
                                            optionElement.selected = true;
                                        }

                                        select.appendChild(optionElement);
                                    });

                                    // 如果禁用编辑，禁用下拉框
                                    if (isEditDisabled) {
                                        select.disabled = true;
                                        select.style.opacity = '0.5';
                                        select.style.cursor = 'not-allowed';
                                    }

                                    // 监听下拉框的变化事件
                                    select.addEventListener('change', function () {
                                        // 如果禁用状态，不允许修改
                                        if (isEditDisabled) {
                                            return;
                                        }

                                        const selectedValue = select.value;
                                        console.log('状态已更新为:', selectedValue);  // 处理下拉框值的变化

                                        // 如果新值和旧值不同，标记为已修改
                                        if (selectedValue !== normalizedValue) {
                                            item[attr.field] = selectedValue;
                                            if (!modifiedData.includes(item)) {
                                                modifiedData.push(item); // 标记修改过的数据
                                            }
                                        }
                                    });

                                    valueDiv.appendChild(select);  // 添加下拉框到 valueDiv 中
                                } else if(index === 6){
                                    // 定义需要转换为下拉框的等级选项
                                    const validOptions = ['S', 'A', 'B', 'C', '待确定'];

                                    // 将传递过来的值转换为统一格式（大写）
                                    let normalizedValue = String(value).toUpperCase();

                                    // 如果输入的值在有效选项内，使用下拉框，否则将值改为“待确定”
                                    if (validOptions.includes(normalizedValue)) {
                                        // 使用输入的值创建下拉框
                                    } else {
                                        // 如果值不在有效选项范围内，将值设为“待确定”
                                        normalizedValue = '待确定';
                                    }

                                    // 创建下拉框
                                    const select = document.createElement('select');

                                    // 创建下拉选项
                                    validOptions.forEach(option => {
                                        const optionElement = document.createElement('option');
                                        optionElement.value = option;
                                        optionElement.textContent = option;

                                        // 设置默认选中的选项
                                        if (normalizedValue === option) {
                                            optionElement.selected = true;
                                        }

                                        select.appendChild(optionElement);
                                    });

                                    // 如果禁用编辑，禁用下拉框
                                    if (isEditDisabled) {
                                        select.disabled = true;
                                        select.style.opacity = '0.5';
                                        select.style.cursor = 'not-allowed';
                                    }

                                    // 监听下拉框的变化事件
                                    select.addEventListener('change', function () {
                                        // 如果禁用状态，不允许修改
                                        if (isEditDisabled) {
                                            return;
                                        }

                                        const selectedValue = select.value;
                                        console.log('等级已更新为:', selectedValue);  // 处理下拉框值的变化

                                        // 如果新值和旧值不同，标记为已修改
                                        if (selectedValue !== normalizedValue) {
                                            item[attr.field] = selectedValue;
                                            if (!modifiedData.includes(item)) {
                                                modifiedData.push(item); // 标记修改过的数据
                                            }
                                        }
                                    });

                                    valueDiv.appendChild(select);  // 添加下拉框到 valueDiv 中
                                }else if(index === 1){
                                    // 定义需要转换为下拉框的等级选项
                                    const validOptions = ['产品', '项目', '结构', 'ID', '研发' ,'DQE' ,'SQE' ,'CQE','待确定'];

                                    // 将传递过来的值转换为统一格式（大写）
                                    let normalizedValue = String(value).toUpperCase();

                                    // 如果输入的值在有效选项内，使用下拉框，否则将值改为“待确定”
                                    if (validOptions.includes(normalizedValue)) {
                                        // 使用输入的值创建下拉框
                                    } else {
                                        // 如果值不在有效选项范围内，将值设为“待确定”
                                        normalizedValue = '待确定';
                                    }

                                    // 创建下拉框
                                    const select = document.createElement('select');

                                    // 创建下拉选项
                                    validOptions.forEach(option => {
                                        const optionElement = document.createElement('option');
                                        optionElement.value = option;
                                        optionElement.textContent = option;

                                        // 设置默认选中的选项
                                        if (normalizedValue === option) {
                                            optionElement.selected = true;
                                        }

                                        select.appendChild(optionElement);
                                    });

                                    // 如果禁用编辑，禁用下拉框
                                    if (isEditDisabled) {
                                        select.disabled = true;
                                        select.style.opacity = '0.5';
                                        select.style.cursor = 'not-allowed';
                                    }

                                    // 监听下拉框的变化事件
                                    select.addEventListener('change', function () {
                                        // 如果禁用状态，不允许修改
                                        if (isEditDisabled) {
                                            return;
                                        }

                                        const selectedValue = select.value;

                                        // 如果新值和旧值不同，标记为已修改
                                        if (selectedValue !== normalizedValue) {
                                            item[attr.field] = selectedValue;
                                            if (!modifiedData.includes(item)) {
                                                modifiedData.push(item); // 标记修改过的数据
                                            }
                                        }
                                    });

                                    valueDiv.appendChild(select);  // 添加下拉框到 valueDiv 中
                                } else if(index === 35 || index === 39){
                                    if(value){
                                        const valueText = document.createElement('div');
                                        valueText.textContent = value.replace("T"," ");
                                        valueText.style.color = '#8a4e07'; // 设置不允许修改的列的字体颜色
                                        valueDiv.appendChild(valueText);
                                    }

                                }else if(index === 0){//序号列，加个删除该问题点的方法
                                    const valueText = document.createElement('div');
                                    valueText.textContent = (value !== undefined && value !== null) ? value : '无';
                                    valueText.style.color = '#2954e3'; // 设置不允许修改的列的字体颜色

                                    valueText.addEventListener('click', () => {
                                        // 如果禁用状态，不允许删除
                                        if (isEditDisabled) {
                                            alert('DQE已审核完成，不允许修改');
                                            return;
                                        }

                                        const confirmation = confirm(`确定删除ID为${value}的问题点吗？删除后不可恢复！`);
                                        if (confirmation && username && username === item.tester) {
                                            // 发送删除请求到控制层
                                            fetch(`/problemMoudle/deleteProblemById/${value}/${encodeURIComponent(username)}`)
                                                .then(response => {
                                                    if (response.ok) {
                                                        alert(`ID为${value}的问题点已成功删除`);
                                                        // 可在此处更新界面，例如移除该问题点的显示
                                                        editClickBtn(sampleId);
                                                    } else {
                                                        alert("删除失败，问题点未找到");
                                                    }
                                                })
                                                .catch(error => console.error("请求失败:", error));
                                        }else{
                                            alert("不能删除不是自己提出的问题点");
                                        }
                                    });

                                    valueDiv.appendChild(valueText);
                                } else {
                                    // 如果不是图片路径，显示默认文本
                                    const valueText = document.createElement('div');
                                    valueText.textContent = (value !== undefined && value !== null) ? value : '无';
                                    valueText.style.color = '#8a4e07'; // 设置不允许修改的列的字体颜色
                                    valueDiv.appendChild(valueText);
                                }
                            }else if (index >= 2 && index <= 5) {
                                // DQE确认到研发意见信息之间列的处理如下
                                if (attr.field === 'dqe_confirm' || attr.field === 'rd_confirm') {
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.checked = item[attr.field] === '确认'; // 根据需要设定默认值

                                    if(attr.field === 'dqe_confirm'){
                                        if (job==='DQE') {
                                            checkbox.setAttribute('data-dqe', 'true');
                                        }else if(job==="rd" || job==="tester"){
                                            checkbox.setAttribute('data-dqe', 'false');
                                        }

                                    }else{
                                        if (job==='DQE' || job==="tester") {
                                            checkbox.setAttribute('data-rd', 'false');
                                        }else if(job ==="rd" ){
                                            checkbox.setAttribute('data-rd', 'true');
                                        }
                                    }

                                    // 如果禁用编辑，禁用复选框
                                    if (isEditDisabled) {
                                        checkbox.disabled = true;
                                        checkbox.style.opacity = '0.5';
                                        checkbox.style.cursor = 'not-allowed';
                                        checkbox.style.backgroundColor = '#f0f0f0';
                                        checkbox.style.border = '1px solid #ccc';
                                    } else {
                                        // 监听复选框变化事件
                                        if ((attr.field === 'dqe_confirm' && checkbox.getAttribute('data-dqe') === 'true') ||
                                            (attr.field === 'rd_confirm' && checkbox.getAttribute('data-rd') === 'true')) {
                                            // 监听复选框变化事件
                                            checkbox.addEventListener('change', function () {
                                                const newValue = checkbox.checked ? '确认' : '未确认'; // 更新状态
                                                if (newValue !== item[attr.field]) {
                                                    item[attr.field] = newValue; // 更新数据对象

                                                    // 确保 modifiedData 中没有重复项
                                                    if (!modifiedData.some(existingItem => existingItem.id === item.id)) {
                                                        modifiedData.push(item); // 标记修改过的数据
                                                    }
                                                }
                                            });
                                        } else {
                                            checkbox.disabled = true; // 禁用复选框
                                            checkbox.style.opacity = '1'; // 设为不透明
                                            checkbox.style.cursor = 'not-allowed'; // 更改鼠标指针样式
                                            checkbox.style.backgroundColor = '#f0f0f0'; // 设置背景颜色
                                            checkbox.style.border = '1px solid #ccc'; // 设置边框
                                        }
                                    }

                                    valueDiv.appendChild(checkbox);
                                }else{
                                    if (value) {
                                        let displayText1 = ''; // 第一行显示的文本
                                        let displayText2 = ''; // 第二行显示的文本

                                        if (attr.field === 'dqe_confirm_inform') {
                                            if (item.dqe_review_at && item.dqe) {
                                                displayText1 = item.dqe_review_at; // 第一行
                                                displayText2 = item.dqe; // 第二行
                                            }
                                        } else if (attr.field === 'rd_confirm_inform') {
                                            if (item.rd_review_at && item.rd) {
                                                displayText1 = item.rd_review_at; // 第一行
                                                displayText2 = item.rd; // 第二行
                                            }
                                        } else {
                                            displayText1 = value; // 默认使用原始值为第一行
                                        }

                                        // 创建第一行和第二行的 div
                                        if (displayText1) {
                                            const valueText1 = document.createElement('div');
                                            valueText1.textContent = displayText1.replace("T", " "); // 替换 T 为空格
                                            valueText1.style.color = '#8a4e07'; // 设置字体颜色
                                            valueDiv.appendChild(valueText1);
                                        }

                                        if (displayText2) {
                                            const valueText2 = document.createElement('div');
                                            valueText2.textContent = displayText2.replace("T", " "); // 替换 T 为空格
                                            valueText2.style.color = '#8a4e07'; // 设置字体颜色
                                            valueDiv.appendChild(valueText2);
                                        }
                                    }
                                }

                            } else {
                                createEditableSpan(value, item, attr, modifiedData, valueDiv, responsiblePersonValue, isEditDisabled);
                            }

                            enableDragScroll(valueDiv);

                            valueCell.appendChild(valueDiv);
                            valueRow.appendChild(valueCell);
                        });

                        table.appendChild(valueRow);
                    });

                    // 将表格添加到表格容器中
                    tableContainer.appendChild(table);
                    contentDiv.appendChild(tableContainer);

                    // 创建保存按钮
                    const saveButton = document.createElement('button');
                    saveButton.textContent = '保存\n修改'; // 使用换行符分两行显示文本
                    saveButton.className = 'save-button'; // 添加类名

                    // 如果 checkJudge 为 true，禁用保存按钮
                    if (isEditDisabled) {
                        // saveButton.disabled = true;
                        saveButton.style.opacity = '0.5';
                        saveButton.style.cursor = 'not-allowed';
                        saveButton.title = '当前状态不允许编辑';
                    }

                    contentDiv.appendChild(saveButton);

                    saveButton.addEventListener('click', function () {
                        // 如果禁用状态，不允许保存
                        if (isEditDisabled) {
                            alert('DQE已审核完成，不允许修改');
                            return;
                        }
                        saveChanges(modifiedData,sampleId, true); // 只发送修改的数据
                    });

                    // 创建新增问题按钮
                    const addButton = document.createElement('button');
                    addButton.textContent = '新增\n问题';
                    addButton.className = 'add-button'; // 给新增问题按钮添加类名

                    // 如果 checkJudge 为 true，禁用新增问题按钮
                    if (isEditDisabled) {
                        // addButton.disabled = true;
                        addButton.style.opacity = '0.5';
                        addButton.style.cursor = 'not-allowed';
                        addButton.title = '当前状态不允许编辑';
                    }

                    contentDiv.appendChild(addButton);

                    // 新增问题按钮点击事件
                    addButton.addEventListener('click', function () {
                        // 如果禁用状态，不允许新增
                        if (isEditDisabled) {
                            alert('DQE已审核完成，不允许修改');
                            return;
                        }
                        addNewRow(sampleId,attributes,modifiedData,table);
                    });


                    // 新增一个导出问题点的按钮
                    const exportButton = document.createElement('button');
                    exportButton.textContent = '导出\n问题点'; // 按钮名称
                    exportButton.className = 'export-button'; // 给按钮添加类名
                    contentDiv.appendChild(exportButton);


                    exportButton.addEventListener('click', () => {
                        // 检查按钮是否已禁用
                        if (exportButton.disabled) {
                            return; // 如果已禁用，不执行后续代码
                        }

                        // 禁用按钮，防止重复点击
                        exportButton.disabled = true;
                        exportProblemXlsx(data,exportButton);
                    });

                    // 新增一个导出测试报告的按钮
                    const exportFileBtn = document.createElement('button');
                    exportFileBtn.textContent = '导出\n测试报告'; // 按钮名称
                    exportFileBtn.className = 'exportFile-button'; // 给按钮添加类名
                    contentDiv.appendChild(exportFileBtn);

                    exportFileBtn.addEventListener('click', () => {
                        exportFile(sampleId);
                    });


                    // ESC快捷键退出点击的模态框
                    modal.style.display = 'block';

                    // 定义处理 ESC 键的函数
                    const handleEscapeKey = (event) => {
                        if (event.key === 'Escape') {
                            closeModal();
                        }
                    };

                    // 添加 ESC 键事件监听器
                    document.addEventListener('keydown', handleEscapeKey);

                    // 关闭模态框的函数
                    const closeModal = () => {
                        modal.style.display = 'none';
                        // 只有在没有正在搜索时才执行搜索
                        // if (!isSearching) {
                        //     isSearching = true; // 设置搜索状态为真
                        //     performSearch(globalFormData);
                        //
                        //     setTimeout(() => {
                        //         isSearching = false; // 重置搜索状态
                        //     }, 2000); // 设置间隔时间，例如2000毫秒
                        // }
                        // 移除 ESC 键事件监听器
                        document.removeEventListener('keydown', handleEscapeKey);
                    };

                    const span = document.getElementsByClassName('close-problem')[0];
                    if (span) {
                        span.onclick = closeModal;
                    }

                    // 重置编辑状态
                    isEditing = false; // 在请求完成后重置状态

                })
                .catch(error => {
                    alert(error.message);

                    // 重置编辑状态
                    isEditing = false; // 在请求完成后重置状态
                });
        }


        function enableDragScroll(element) {
            let isDragging = false;
            let startX, scrollLeft;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                element.style.cursor = 'grabbing';
                startX = e.pageX - element.offsetLeft;
                scrollLeft = element.scrollLeft;
            });

            element.addEventListener('mouseleave', () => {
                isDragging = false;
                element.style.cursor = 'grab';
            });

            element.addEventListener('mouseup', () => {
                isDragging = false;
                element.style.cursor = 'grab';
            });

            element.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - element.offsetLeft;
                const walk = (x - startX) * 2; // 滚动速度
                element.scrollLeft = scrollLeft - walk;
            });
        }

        function createEditableSpan(value, item, attr, modifiedData, valueDiv, responsiblePersonValue, isEditDisabled) {
            const div = document.createElement('div');
            div.textContent = value || '无';  // 如果没有数据，展示为 '无'

            // 设置 CSS 样式，让其支持换行显示，并控制宽度
            div.style.whiteSpace = 'pre-wrap';  // 保持文本内容换行
            div.style.wordWrap = 'break-word';  // 超出时换行
            div.style.maxWidth = '200px';  // 设置最大宽度，避免内容过长时溢出
            div.style.width = '100%';  // 确保宽度占满父容器
            div.style.overflowWrap = 'break-word'; // 确保长单词或URL换行

            // 当前编辑值
            let currentEditValue = value || '';

            // 如果禁用编辑或不是当前用户，不允许编辑
            if(responsiblePersonValue === username && !isEditDisabled){
                div.addEventListener('click', function () {
                    // 创建 textarea
                    const textarea = document.createElement('textarea');

                    // 获取 div 的高度，并将其赋值给 textarea
                    const divHeight = div.offsetHeight;  // 获取 div 的高度
                    textarea.style.height = `${divHeight}px`;  // 设置 textarea 高度与 div 一致

                    // 其他样式设置
                    textarea.style.width = '100%';  // 确保文本框的宽度与父容器相同
                    textarea.style.minWidth = '120px';  // 设置最小宽度，确保输入框可见
                    textarea.style.minHeight = '50px';  // 设置最小宽度，确保输入框可见
                    textarea.style.maxWidth = '200px'; // 设置最大宽度，避免输入框过宽
                    textarea.value = currentEditValue; // 使用当前编辑值

                    // 添加一些样式，避免选择区域不明显
                    textarea.style.outline = 'none';  // 去除焦点时的外边框
                    textarea.style.backgroundColor = 'white';  // 确保背景是白色
                    textarea.style.color = 'black';  // 确保文本颜色是黑色
                    textarea.style.border = '1px solid #ccc';  // 设置边框样式
                    textarea.style.padding = '5px';  // 设置内边距，使文本有一定的空间

                    textarea.addEventListener('mousedown', function (event) {
                        // 如果用户按住鼠标拖动的是非输入相关内容，可以做限制，但这里不阻止默认行为
                        event.stopPropagation(); // 阻止事件冒泡
                    });

                    // 添加拖动限制，确保 textarea 不会移动,解决编辑框拖动的时候也会移动的bug
                    textarea.addEventListener('dragstart', function (event) {
                        event.preventDefault(); // 禁止拖动行为
                    });

                    // 监听失焦事件
                    textarea.addEventListener('blur', function () {
                        const newValue = textarea.value.trim() || '';  // 新值为空字符串则转换为空

                        // 如果新值和旧值都为空，或者它们相等，则不更新
                        if (newValue !== currentEditValue) {
                            currentEditValue = newValue;  // 更新当前编辑值
                            div.textContent = currentEditValue || '无';  // 更新 div 的内容
                            // 更新 item 的值，并标记修改过的数据
                            item[attr.field] = currentEditValue;
                            if (!modifiedData.includes(item)) {
                                modifiedData.push(item);  // 标记修改过的数据
                            }
                        }

                        // 将 textarea 替换回 div
                        valueDiv.replaceChild(div, textarea);
                    });

                    // 将 div 替换为 textarea
                    valueDiv.replaceChild(textarea, div);
                    textarea.focus(); // 聚焦到 textarea，用户可以开始编辑
                });
            }


            valueDiv.appendChild(div);
        }


        function saveChanges(modifiedData,sampleId, isEditClick) {
            // if(!username){
            //     alert("用户名不存在，麻烦重新进入本应用!"); // 可选的警告提示
            //     window.location.href = 'http://219.134.191.195:64000'; // 将'/login'替换为你的登录控制器的 URL
            //     return;
            // }

            if (modifiedData.length === 0) {
                alert('没有修改的内容需要保存。');
                return;
            }

            fetch(`/problemMoudle/saveChanges?sampleId=${sampleId}&username=${encodeURIComponent(username)}&job=${job}`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(modifiedData) // 只发送修改的 JSON 数组
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.text(); // 返回文本响应
                })
                .then(responseText => {
                    // console.log('保存成功:', responseText); // 打印成功消息
                    alert('修改成功，已同步到数据库');
                    // 刷新弹出框中的数据
                    if(isEditClick){
                        editClickBtn(sampleId);
                    }
                })
                .catch(error => {
                    console.error('提交失败:', error);
                    alert('提交失败，请检查网络连接或稍后重试。');
                });
        }

        function addNewRow(sampleId,attributes,modifiedData,table) {
            // 发送 AJAX 请求以获取数据，将 sampleId 作为查询参数
            fetch(`/problemMoudle/addNewRow?sampleId=${sampleId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    // 假设后端返回的数据是一个数组，获取第一个对象
                    const sample = data;  // 这里假设返回的数组只有一行数据，你可以根据实际情况调整

                    const newRow = document.createElement('tr');
                    newRow.className = 'value-row';

                    // 创建新的数据行
                    const newItem = {};

                    // 给每一行数据生成一个唯一 ID，用来标识并删除
                    const uniqueId = Date.now();  // 以当前时间戳作为唯一 ID（你也可以用其他方式生成唯一 ID）
                    newItem.uniqueId = uniqueId;  // 将唯一 ID 保存到 newItem 中
                    newRow.dataset.uniqueId = uniqueId; // 同时将唯一 ID 保存到行的自定义属性中

                    // 遍历 attributes 数组，将每个字段对应的数据插入到表格中
                    attributes.forEach((attr, index) => {
                        const newCell = document.createElement('td');
                        newCell.className = `value-cell value-cell-${index + 1}`;

                        const newDiv = document.createElement('div');

                        // 第一个字段是序号，不允许修改
                        if (index === 0) {
                            newDiv.textContent = '点击删除'; // 设置为自动生成的文本
                            newDiv.style.color = '#8a4e07'; // 设置字体颜色

                            // 添加删除功能
                            newDiv.addEventListener('click', function () {
                                // 从表格中删除行
                                newRow.remove();

                                // 使用 uniqueId 查找并从 modifiedData 中删除对应的项目
                                const itemIndex = modifiedData.findIndex(item => item.uniqueId === uniqueId);
                                if (itemIndex > -1) {
                                    modifiedData.splice(itemIndex, 1); // 从 modifiedData 中移除
                                }
                            });

                            newItem[attr.field] = null; // 序号不参与修改
                        } else {
                            // 处理字段映射：将 sample_category 映射到 sample_stage，将 max_histor_id 映射到 history_id
                            let value = ''; // 初始化值为一个空字符串

                            if (attr.field === 'sample_stage') {
                                value = sample.sample_category || ''; // 映射样品阶段
                            } else if (attr.field === 'history_id') {
                                value = sample.max_history_id; // 映射历史ID

                                newDiv.textContent = value;
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                                newItem[attr.field] = value; // 序号不参与修改

                            }else if (attr.field === 'full_model') {
                                value = sample.full_model || ''; // 映射历史ID
                            } else if (attr.field === 'version') {
                                value = sample.version || ''; // 映射历史ID
                            } else if (attr.field === 'created_at' )  {
                                value = sample.created_at;
                                newDiv.textContent = value;
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                                newItem[attr.field] = value; // 序号不参与修改

                            } else if (attr.field === 'created_by') {
                                if (job && job === "tester") {
                                    value = "tester";
                                } else if (job && job === "DQE") {
                                    value = "dqe";
                                } else if(job && job === "rd"){
                                    value = "rd";
                                }else{
                                    value = "未知角色";
                                }
                                newDiv.textContent = value;
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                                newItem[attr.field] = null; // 序号不参与修改

                            }  else if (attr.field === 'tester') {
                                if (username) {
                                    value = username;
                                } else {
                                    value = ''; // 其他字段保持为空字符串
                                }
                            } else if( index === 2 || index === 4 ){
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.checked = newItem[attr.field] === '确认'; // 根据需要设定默认值

                                if (index === 2) {
                                    if (job==='DQE') {
                                        checkbox.setAttribute('data-dqe', 'true');
                                    } else {
                                        checkbox.setAttribute('data-dqe', 'false');
                                        // 设置为禁用状态
                                        checkbox.disabled = true;
                                        checkbox.style.opacity = '1'; // 设为不透明
                                        checkbox.style.cursor = 'not-allowed'; // 更改鼠标指针样式
                                        checkbox.style.backgroundColor = '#f0f0f0'; // 设置背景颜色
                                        checkbox.style.border = '1px solid #ccc'; // 设置边框
                                    }
                                } else {
                                    if (job==='DQE' || job === "tester") {
                                        checkbox.setAttribute('data-rd', 'false');
                                        // 设置为禁用状态
                                        checkbox.disabled = true;
                                        checkbox.style.opacity = '1'; // 设为不透明
                                        checkbox.style.cursor = 'not-allowed'; // 更改鼠标指针样式
                                        checkbox.style.backgroundColor = '#f0f0f0'; // 设置背景颜色
                                        checkbox.style.border = '1px solid #ccc'; // 设置边框
                                    } else if(job === "rd"){
                                        checkbox.setAttribute('data-rd', 'true');
                                    }
                                }

                                // 监听复选框变化事件
                                checkbox.addEventListener('change', function () {
                                    const newValue = checkbox.checked ? '确认' : '未确认'; // 更新状态
                                    if (newValue !== newItem[attr.field]) {
                                        newItem[attr.field] = newValue; // 更新数据对象

                                        // 确保 modifiedData 中没有重复项
                                        if (!modifiedData.some(existingItem => existingItem.uniqueId === newItem.uniqueId)) {
                                            modifiedData.push(newItem); // 标记修改过的数据
                                        }
                                    }
                                });

                                newDiv.appendChild(checkbox); // 将复选框添加到新单元格
                            }else if (attr.field === 'defect_level') {
                                // 定义缺陷等级的选项
                                const validOptions = ['S', 'A', 'B', 'C', '待确定'];

                                // 创建下拉框
                                const select = document.createElement('select');

                                // 创建下拉选项
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // 设置默认选中的选项为“待确定”
                                    if (option === '待确定') {
                                        optionElement.selected = true;
                                    }

                                    select.appendChild(optionElement);
                                });

                                // 监听下拉框的变化事件
                                select.addEventListener('change', function () {
                                    const selectedValue = select.value;
                                    console.log('缺陷等级已更新为:', selectedValue);  // 处理下拉框值的变化

                                    // 如果新值和旧值不同，标记为已修改
                                    newItem[attr.field] = selectedValue;
                                    if (!modifiedData.includes(newItem)) {
                                        modifiedData.push(newItem); // 标记修改过的数据
                                    }
                                });

                                newDiv.appendChild(select);  // 添加下拉框到 newDiv 中
                                newItem[attr.field] = '待确定'; // 初始化该字段的值为“待确定”
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                                value = '待确定';

                            }else if (attr.field === 'current_status') {
                                // 定义当前状态的选项
                                const validOptions = ['OPEN', 'CLOSED', 'FOLLOW UP', '待确定'];

                                // 创建下拉框
                                const select = document.createElement('select');

                                // 创建下拉选项
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // 设置默认选中的选项为“OPEN”
                                    if (option === 'OPEN') {
                                        optionElement.selected = true; // 确保 "OPEN" 是默认选中的选项
                                    }

                                    select.appendChild(optionElement);
                                });

                                // 监听下拉框的变化事件
                                select.addEventListener('change', function () {
                                    const selectedValue = select.value;
                                    console.log('当前状态已更新为:', selectedValue);  // 处理下拉框值的变化

                                    // 确保下拉框的选中值及时更新到 newItem 中
                                    newItem[attr.field] = selectedValue;
                                    if (!modifiedData.includes(newItem)) {
                                        modifiedData.push(newItem); // 标记修改过的数据
                                    }
                                });

                                newDiv.appendChild(select);  // 添加下拉框到 newDiv 中

                                // 确保在创建时，newItem[attr.field] 被设置为“OPEN”
                                newItem[attr.field] = 'OPEN'; // 初始化该字段的值为“OPEN”
                                value = 'OPEN';

                                // 设置字体颜色
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                            }else if (attr.field === 'problemCategory') {
                                // 定义当前状态的选项
                                const validOptions = ['电气性能', '兼容性', '可靠性', '工艺' ,'待确定'];

                                // 创建下拉框
                                const select = document.createElement('select');

                                // 创建下拉选项
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // 设置默认选中的选项为“OPEN”
                                    if (option === '待确定') {
                                        optionElement.selected = true; // 确保 "OPEN" 是默认选中的选项
                                    }

                                    select.appendChild(optionElement);
                                });

                                // 监听下拉框的变化事件
                                select.addEventListener('change', function () {
                                    const selectedValue = select.value;
                                    console.log('当前状态已更新为:', selectedValue);  // 处理下拉框值的变化

                                    // 确保下拉框的选中值及时更新到 newItem 中
                                    newItem[attr.field] = selectedValue;
                                    if (!modifiedData.includes(newItem)) {
                                        modifiedData.push(newItem); // 标记修改过的数据
                                    }
                                });

                                newDiv.appendChild(select);  // 添加下拉框到 newDiv 中

                                // 确保在创建时，newItem[attr.field] 被设置为“OPEN”
                                newItem[attr.field] = '待确定'; // 初始化该字段的值为“OPEN”
                                value = '待确定';

                                // 设置字体颜色
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                            }else if (attr.field === 'responsibleDepartment') {
                                // 定义当前状态的选项
                                const validOptions = ['产品', '项目', '结构' , 'ID', '研发', 'DQE', 'SQE', 'CQE', '待确定'];

                                // 创建下拉框
                                const select = document.createElement('select');

                                // 创建下拉选项
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // 设置默认选中的选项为“OPEN”
                                    if (option === '待确定') {
                                        optionElement.selected = true; // 确保 "OPEN" 是默认选中的选项
                                    }

                                    select.appendChild(optionElement);
                                });

                                // 监听下拉框的变化事件
                                select.addEventListener('change', function () {
                                    const selectedValue = select.value;
                                    console.log('当前状态已更新为:', selectedValue);  // 处理下拉框值的变化

                                    // 确保下拉框的选中值及时更新到 newItem 中
                                    newItem[attr.field] = selectedValue;
                                    if (!modifiedData.includes(newItem)) {
                                        modifiedData.push(newItem); // 标记修改过的数据
                                    }
                                });

                                newDiv.appendChild(select);  // 添加下拉框到 newDiv 中

                                // 确保在创建时，newItem[attr.field] 被设置为“OPEN”
                                newItem[attr.field] = '待确定'; // 初始化该字段的值为“OPEN”
                                value = '待确定';

                                // 设置字体颜色
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                            }  else {
                                value = ''; // 其他字段保持为空字符串
                            }

                            // 将新值添加到 newItem 中
                            newItem[attr.field] = value;

                            //这里是让editClickBtn点击弹出来的模态框设置哪些列样式不允许人修改的
                            if(attr.field === 'history_id' || attr.field==='created_by'
                                || attr.field==='created_at' || attr.field === 'dqe_review_at' || attr.field === 'current_status'
                                || attr.field === 'rd_review_at' || index === 1 || index === 3 || index ===2 || index === 4 || index === 5
                                || index === 36 || index === 37 || index === 38 || index === 39 || index === 40 || index === 6 || index === 7 || index === 8) {

                            }else{
                                // 创建可编辑的内容
                                createEditableSpan(value, newItem, attr, modifiedData, newDiv, username); // 使用获取的值
                            }

                        }

                        newCell.appendChild(newDiv);
                        newRow.appendChild(newCell);
                    });

                    table.appendChild(newRow); // 将新行添加到表格
                    modifiedData.push(newItem); // 将新行数据推入修改数据数组
                })
                .catch(error => {
                    console.error('获取数据失败:', error.message);
                    alert(error.message); // 处理错误
                });
        }

        function exportProblemXlsx(data, exportButton) {
            // console.log(data);

            // 选择联系人
            dd.biz.contact.choose({
                multiple: false,
                users: [],
                corpId: corp_id,
                max: 1,
                onSuccess: function(contactData) {
                    const selectedUserId = contactData[0].emplId; // 获取单个用户ID

                    // 选择钉盘目录
                    dd.chooseDingTalkDir({
                        corpId: corp_id, // 企业ID
                        onSuccess: function(res) {
                            const selectedDirId = res.data[0].dirId; // 获取选中的目录ID
                            const selectedSpaceId = res.data[0].spaceId; // 获取选中的空间ID

                            // 获取应用免登授权码
                            dd.runtime.permission.requestAuthCode({
                                corpId: corp_id,
                                onSuccess: function(result) {
                                    const authCode = result.code; // 获取到授权码

                                    // 创建一个对象，将 issues 和其他参数包装在一起
                                    const requestData = {
                                        issues: data  // 包含多个问题的数组
                                    };

                                    // 发送 AJAX 请求
                                    $.ajax({
                                        url: `/problemMoudle/exportProblemXlsx?dirId=${selectedDirId}&spaceId=${selectedSpaceId}&receiverId=${selectedUserId}&authCode=${authCode}`,
                                        type: 'POST',
                                        contentType: 'application/json',
                                        data: JSON.stringify(requestData), // 将对象序列化为 JSON
                                        success: function(response) {
                                            alert("发送成功");
                                            // 成功后恢复按钮的状态
                                            exportButton.disabled = false;
                                        },
                                        error: function(xhr, status, error) {
                                            alert('导出测试报告失败: ' + error);
                                            // 失败后恢复按钮的状态
                                            exportButton.disabled = false;
                                        }
                                    });
                                },
                                onFail: function(err) {
                                    alert('获取授权码失败：' + JSON.stringify(err));
                                    // hideLoading(); // 隐藏加载提示框
                                    // 失败后恢复按钮的状态
                                    exportButton.disabled = false;
                                }
                            });
                        },
                        fail: function(err) {
                            alert('选择目录失败：' + JSON.stringify(err));
                            // hideLoading(); // 隐藏加载提示框
                            // 失败后恢复按钮的状态
                            exportButton.disabled = false;
                        },
                        onCancel: function() {
                            alert('选择目录取消');
                            // 取消选择目录时恢复按钮的状态
                            exportButton.disabled = false;
                            return; // 在这里直接返回，阻止后续代码执行
                        }
                    });
                },
                onFail: function(err) {
                    alert("选择联系人出错" + err);
                    // hideLoading(); // 隐藏加载提示框
                    // 失败后恢复按钮的状态
                    exportButton.disabled = false;
                },
                onCancel: function() {
                    alert("选择联系人取消");
                    // 取消选择联系人时恢复按钮的状态
                    exportButton.disabled = false;
                    return; // 在这里直接返回，阻止后续代码执行
                }
            });
        }

        function exportFile(sampleId) {
            // 首先通过 sampleId 获取文件路径
            $.ajax({
                url: `/problemMoudle/getFilePath?sampleId=${sampleId}`,
                type: 'GET',
                success: function(data) {
                    const filePath = data.filePath; // 后端返回的完整 URL
                    const fileName = data.fileName; // 后端返回的文件名

                    // if (!confirm('文件较大，转发可能需要较长时间。是否继续？')) {
                    //     return; // 用户选择不上传
                    // }

                    // 选择联系人
                    dd.biz.contact.choose({
                        multiple: false,
                        users: [],
                        corpId: corp_id,
                        max: 1,
                        onSuccess: function(data) {
                            const selectedUserId = data[0].emplId; // 获取单个用户ID

                            // 选择钉盘目录
                            dd.chooseDingTalkDir({
                                corpId: corp_id, // 企业ID
                                onSuccess: function(res) {
                                    const selectedDirId = res.data[0].dirId; // 获取选中的目录ID
                                    const selectedSpaceId = res.data[0].spaceId; // 获取选中的空间ID

                                    // 获取应用免登授权码
                                    dd.runtime.permission.requestAuthCode({
                                        corpId: corp_id,
                                        onSuccess: function(result) {
                                            const authCode = result.code; // 获取到授权码
                                            // 发起后端请求上传文件和发送文件
                                            $.ajax({
                                                url: '/testManIndex/uploadFileToDingtalk',
                                                type: 'POST',
                                                data: {
                                                    filepath: filePath, // 使用从后端获取的文件路径
                                                    dirId: selectedDirId,
                                                    spaceId: selectedSpaceId,
                                                    authCode: authCode,
                                                    receiverId: selectedUserId,
                                                    username : username
                                                },
                                                success: function(response) {
                                                    alert('文件上传并发送成功');
                                                    // hideLoading(); // 隐藏加载提示框
                                                },
                                                error: function(xhr, status, error) {
                                                    alert('文件上传发送失败: ' + error);
                                                    // hideLoading(); // 隐藏加载提示框
                                                }
                                            });
                                        },
                                        onFail: function(err) {
                                            alert('获取授权码失败：' + JSON.stringify(err));
                                            // hideLoading(); // 隐藏加载提示框
                                        }
                                    });
                                },
                                fail: function(err) {
                                    alert('选择目录失败：' + JSON.stringify(err));
                                    // hideLoading(); // 隐藏加载提示框
                                },
                                onCancel: function() {
                                    alert('选择目录取消');
                                    // hideLoading(); // 隐藏加载提示框
                                }
                            });
                        },
                        onFail: function(err) {
                            alert("选择联系人出错" + err);
                            // hideLoading(); // 隐藏加载提示框
                        }
                    });
                },
                error: function(xhr, status, error) {
                    alert('获取文件路径失败: ' + error);
                }
            });
        }


        function updateSchedule(sample_schedule, sample_id, receiver, statusBarBgColor, sender, job ,selectedOption,isReceiverTester) {
            fetch('/problemMoudle/updateSchedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sample_schedule: sample_schedule,
                    sample_id: sample_id,
                    receiver: receiver,
                    statusBarBgColor: statusBarBgColor,
                    sender: sender,
                    job: job,
                    selectedOption: selectedOption,
                    isReceiverTester: isReceiverTester
                })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Network response was not ok');
                        });
                    }
                    return response.text();
                })
                .then(text => {
                    const [type, ...rest] = text.split('|');
                    const message = rest.join('|');

                    if (type === 'copyable') {
                        showCustomAlertWithCopy(message);
                    } else {
                        alert(message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message); // 显示错误信息
                });
        }
        function showCustomAlertWithCopy(fullTextToShowAndCopy) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '30%';
            modal.style.left = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            modal.style.background = '#fff';
            modal.style.padding = '20px';
            modal.style.borderRadius = '8px';
            modal.style.boxShadow = '0 0 15px rgba(0, 0, 0, 0.3)';
            modal.style.zIndex = 10000;
            modal.style.minWidth = '300px';
            modal.style.textAlign = 'center';

            // 展示内容
            const textBox = document.createElement('pre');
            textBox.textContent = fullTextToShowAndCopy;
            textBox.style.whiteSpace = 'pre-wrap';
            textBox.style.wordBreak = 'break-all';
            textBox.style.marginBottom = '10px';
            modal.appendChild(textBox);

            // 复制按钮
            const copyBtn = document.createElement('button');
            copyBtn.textContent = '复制以上内容';
            copyBtn.style.marginRight = '10px';
            copyBtn.onclick = function () {
                copyTextToClipboard(fullTextToShowAndCopy); // 使用传统方式
            };

            // 关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '关闭';
            closeBtn.onclick = () => document.body.removeChild(modal);

            modal.appendChild(copyBtn);
            modal.appendChild(closeBtn);

            document.body.appendChild(modal);
        }


        function copyTextToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';  // 避免页面滚动
            textarea.style.top = '-9999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('已复制到剪贴板！');
                } else {
                    alert('复制失败，请手动复制');
                }
            } catch (err) {
                alert('复制失败: ' + err);
            }

            document.body.removeChild(textarea);
        }




        function showImageModal(imageSrc,sampleId,id,modifiedData, responsiblePersonValue) {
            // 检查是否已存在模态框
            let modal = document.querySelector('.image-modal');

            // 如果模态框不存在，则创建一个
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'image-modal';

                // 将模态框添加到文档中
                document.body.appendChild(modal);

                // 点击模态框时关闭，但不包括图片区域
                modal.addEventListener('click', function (event) {
                    if (event.target === modal) {
                        modal.classList.remove('active'); // 隐藏模态框
                    }
                });
            }

            // 清空之前的内容，防止多次点击重复添加图片
            modal.innerHTML = '';

            // 创建图片元素并设置源
            const img = document.createElement('img');
            img.src = imageSrc;

            // 缩放比例初始化为 1
            let scale = 1;

            // 监听滚轮事件进行缩放
            img.addEventListener('wheel', function (event) {
                event.preventDefault();  // 防止页面滚动

                // 判断滚轮方向，放大或缩小
                if (event.deltaY < 0) {
                    scale += 0.1;  // 放大
                } else {
                    scale -= 0.1;  // 缩小
                }

                // 限制缩放范围
                if (scale < 0.5) scale = 0.5;
                if (scale > 3) scale = 3;

                // 设置图片缩放
                img.style.transform = `scale(${scale})`;
            });

            // 点击图片时触发上传逻辑
            if(responsiblePersonValue === username){
                img.addEventListener('click', function () {
                    triggerImageUpload(imageSrc,sampleId,id,modifiedData,modal); // 触发上传方法
                });
            }


            // 将图片添加到模态框中
            modal.appendChild(img);

            // 显示模态框
            modal.classList.add('active');
        }

        function triggerImageUpload(imageSrc,sampleId,id,modifiedData,modal) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*'; // 只接受图片类型

            fileInput.addEventListener('change', function () {
                const file = fileInput.files[0];
                if (file) {

                    uploadImage(file, sampleId, id, modifiedData);
                    modal.classList.remove('active'); // 隐藏模态框
                }
            });

            // 触发文件选择对话框
            fileInput.click();
        }

        //、上传图片的方法
        function uploadImage(file, sampleId,id,modifiedData) {
            const formData = new FormData();
            formData.append('file', file);  // 添加文件
            formData.append('sampleId', sampleId);  // 添加 sampleId
            formData.append('id', id);  // 添加 sampleId

            fetch('/problemMoudle/uploadImage', {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('上传失败，状态码：' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.message && data.message.includes("上传成功")) {
                        alert(data.message); // 只在消息中包含“上传成功”时弹出]
                        // 检查 modifiedData 是否不为空数组
                        if (Array.isArray(modifiedData) && modifiedData.length > 0) {
                            saveChanges(modifiedData, sampleId,true);
                        }
                        editClickBtn(sampleId)

                    } else {
                        alert("上传失败或其他信息: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('上传出错:', error);
                    // 在这里处理错误情况，比如提示用户
                });
        }

        // 20250506 加排期项目按钮
        // 获取按钮和模态框元素
        const schedulePanelBtn = document.getElementById("schedule-panel-btn");
        const schedulePanelModal = document.getElementById("schedule-panel-modal");
        const closePanelModal = document.getElementById("close-panel-modal");
        const projectDetailModal = document.getElementById("project-detail-modal");
        const closeProjectModal = document.getElementById("close-project-modal");
        const scheduleProjectList = document.getElementById("schedule-project-list");

        // 打开排期项目面板
        schedulePanelBtn.addEventListener("click", () => {
            fetchProjects(username);
            schedulePanelModal.style.display = "block";
        });

        // 关闭排期项目面板
        closePanelModal.addEventListener("click", () => {
            schedulePanelModal.style.display = "none";
        });

        // 关闭项目详情模态框
        closeProjectModal.addEventListener("click", () => {
            projectDetailModal.style.display = "none";
        });

        // 模态框点击外部关闭
        window.addEventListener("click", (event) => {
            if (event.target === schedulePanelModal) {
                schedulePanelModal.style.display = "none";
            }
            if (event.target === projectDetailModal) {
                projectDetailModal.style.display = "none";
            }
        });

        // 调用接口获取项目数据
        function fetchProjects(username) {
            fetch(`/api/getScheduleSampleIdByName?username=${encodeURIComponent(username)}`)
                .then((response) => response.json())
                .then((data) => {
                    displayProjects(data);
                })
                .catch((error) => {
                    console.error("Error fetching projects:", error);
                });
        }


        // 显示项目列表
        function displayProjects(projects) {
            scheduleProjectList.innerHTML = ""; // 清空原来的列表
            projects.forEach((project) => {
                const li = document.createElement("li");
                li.textContent = project; // 假设每个项目有name字段
                li.addEventListener("click", () => {
                    showProjectDetails(project);
                });
                scheduleProjectList.appendChild(li);
            });
        }

        // 显示项目详情
        function showProjectDetails(projectId) {
            fetch(`/api/project-details/${projectId}`)
                .then((response) => response.json())
                .then((data) => {
                    currentProjectData = data;
                    let html = `
                <p><strong>样品编号：</strong> ${data.sample_id || ''}</p>
                <p><strong>产品类别：</strong> ${data.sample_category || ''}</p>
                <p><strong>大编码：</strong> ${data.sample_model || ''}</p>
                <p><strong>物料编码-送样次数：</strong> ${data.materialCode || ''}</p>
                <p><strong>产品名称：</strong> ${data.sample_name || ''}</p>
                <p><strong>版本号：</strong> ${data.version || ''}</p>
                <p><strong>优先级：</strong> ${data.priority || ''}</p>
                <p><strong>项目负责人：</strong> ${data.sample_leader || ''}</p>
                <p><strong>供应商：</strong> ${data.supplier || ''}</p>
                <p><strong>试验项目类别：</strong> ${data.testProjectCategory || ''}</p>
                <p><strong>测试子项目：</strong> ${data.testProjects || ''}</p>
                <p><strong>当前进度：</strong> ${data.schedule || ''}</p>
                <p><strong>创建时间：</strong> ${data.create_time || ''}</p>
                <p><strong>排期天数：</strong> ${data.scheduleDays || ''}</p>
                <p><strong>排期开始时间：</strong> ${data.schedule_start_date || ''}</p>
                <p><strong>排期结束时间：</strong> ${data.schedule_end_date || ''}</p>
                <p><strong>是否作废：</strong> ${data.isCancel === 1 ? '已作废' : '正常'}</p>
                <p><strong>作废原因：</strong> ${data.cancel_reason || ''}</p>
                <p><strong>作废人：</strong> ${data.cancel_by || ''}</p>
                <p><strong>作废时间：</strong> ${data.cancel_date || ''}</p>
                <p><strong>实际开始测试时间：</strong> ${data.actual_start_time || ''}</p>
                <p><strong>实际测试完成时间：</strong> ${data.actual_finish_time || ''}</p>
                <p><strong>测试负责人：</strong> ${data.tester || ''}</p>
                <p><strong>实际测试时长：</strong> ${data.testDuration || ''}</p>
                <p><strong>样品承认结果：</strong> ${data.sampleRecognizeResult || ''}</p>

                <p><strong>产品类别：</strong> ${data.sample_type || ''}</p>
                <p><strong>样品数量：</strong> ${data.sample_quantity || ''}</p>
                <p><strong>是否高频：</strong> ${data.high_frequency || ''}</p>
            `;
                    document.getElementById("project-detail-info").innerHTML = html;
                    document.getElementById("project-detail-modal").style.display = "block";
                })
                .catch((error) => {
                    console.error("Error fetching project details:", error);
                });
        }


        document.getElementById("start-test-btn").addEventListener("click", () => {
            // 检查后端数据中是否包含产品类别、样品数量、是否高频
            const hasCategory = currentProjectData.sample_type && currentProjectData.sample_type.trim() !== '';
            const hasQuantity = currentProjectData.sample_quantity && currentProjectData.sample_quantity > 0;
            const hasFrequency = currentProjectData.high_frequency && currentProjectData.high_frequency.trim() !== '';

            // 展示任务属性表单
            document.getElementById("task-attributes").style.display = "block";

            // 如果后端数据中没有这三个值，则显示额外的输入框
            if (!hasCategory || !hasQuantity || !hasFrequency) {
                document.getElementById("additional-fields").style.display = "block";
            } else {
                // 如果后端数据中有这三个值，则隐藏额外的输入框，并填充值
                document.getElementById("additional-fields").style.display = "none";
                document.getElementById("sample-category").value = currentProjectData.sample_type || '';
                document.getElementById("sample-quantity").value = currentProjectData.sample_quantity || '';
                document.getElementById("is-high-frequency").value = currentProjectData.high_frequency || '';
            }
        });

        document.getElementById("confirm-task-btn").addEventListener("click", async () => {
            const btn = document.getElementById("confirm-task-btn");
            if (btn.disabled) return; // 防止重复点击

            const questStats = document.getElementById("questStats-detail").value;
            let isHighFrequency = document.getElementById("is-high-frequency").value;
            let category = document.getElementById("sample-category").value;
            let quantity = document.getElementById("sample-quantity").value;

            // 验证任务属性（必填）
            if (!questStats) {
                alert("请选择任务属性！");
                return;
            }

            // 检查额外字段是否显示，如果显示则需要验证
            const additionalFieldsVisible = document.getElementById("additional-fields").style.display !== "none";

            if (additionalFieldsVisible) {
                // 如果显示了额外字段，则需要验证
                if (!category.trim()) {
                    alert("请输入产品类别！");
                    document.getElementById("sample-category").focus();
                    return;
                }

                if (!quantity || quantity <= 0) {
                    alert("请输入有效的样品数量！");
                    document.getElementById("sample-quantity").focus();
                    return;
                }

                if (!isHighFrequency) {
                    alert("请选择是否高频！");
                    document.getElementById("is-high-frequency").focus();
                    return;
                }
            } else {
                // 如果没有显示额外字段，则使用后端数据中的值
                category = currentProjectData.sample_type || '';
                quantity = currentProjectData.sample_quantity || '';
                isHighFrequency = currentProjectData.high_frequency || '';
            }

            // 禁用按钮，避免多次点击
            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerText = "提交中...";

            // 更新 currentProjectData，添加新的字段
            currentProjectData.questStats = questStats;
            currentProjectData.high_frequency = isHighFrequency;
            currentProjectData.sample_type = category;
            currentProjectData.sample_quantity = quantity;

            const payload = {
                questStats,
                isHighFrequency,
                category,
                quantity,
                projectData: currentProjectData
            };

            try {
                const res = await fetch('/api/start-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const contentType = res.headers.get('Content-Type');
                const isJson = contentType && contentType.includes('application/json');
                const data = isJson ? await res.json() : { message: await res.text() };

                if (!res.ok) {
                    throw new Error(data.message || "提交失败！");
                }

                alert(data.message);
                document.getElementById("project-detail-modal").style.display = "none";

            } catch (err) {
                console.error("提交失败", err);
                alert(err.message);
            } finally {
                // 恢复按钮状态
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        function viewDataClick(sample_id) {
            fetch(`/testManIndex/viewData?sample_id=${encodeURIComponent(sample_id)}`)
                .then(response => response.json())
                .then(data => {
                    // 承认书区域
                    const admitContainer = document.getElementById('admitLinksContainer');
                    admitContainer.innerHTML = '';
                    const admitUrls = (data.admit || '').split(',').map(u => u.trim()).filter(Boolean);
                    if (admitUrls.length === 0) {
                        admitContainer.innerHTML = '<li>无承认书资料</li>';
                    } else {
                        admitUrls.forEach((url, index) => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = url;
                            a.textContent = url.split('/').pop();
                            a.download = '';
                            a.target = '_blank';
                            li.appendChild(a);
                            admitContainer.appendChild(li);
                        });
                    }

                    // 开发要求区域
                    const developContainer = document.getElementById('developLinksContainer');
                    developContainer.innerHTML = '';
                    const developUrls = (data.develop || '').split(',').map(u => u.trim()).filter(Boolean);
                    if (developUrls.length === 0) {
                        developContainer.innerHTML = '<li>无开发要求资料</li>';
                    } else {
                        developUrls.forEach((url, index) => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = url;
                            a.textContent = url.split('/').pop();
                            a.download = '';
                            a.target = '_blank';
                            li.appendChild(a);
                            developContainer.appendChild(li);
                        });
                    }

                    // 显示模态框
                    document.getElementById('viewDataModal').style.display = 'block';
                })
                .catch(error => {
                    alert('资料加载失败: ' + error);
                });

            // 关闭按钮
            document.getElementById('closeViewDataModal').onclick = function () {
                document.getElementById('viewDataModal').style.display = 'none';
            };

        }


        // 通用方法：根据 sampleId 查询数据库信息并返回数据
        async function checkSampleResult(sampleId) {
            try {
                const response = await fetch(`/problemMoudle/queryResultJudge?sample_id=${sampleId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`查询数据库失败，状态码: ${response.status}`);
                }

                const data = await response.json();
                return data;  // 返回查询结果
            } catch (error) {
                console.error("fetchSampleInfo 出错：", error);
                return null;  // 出错时返回 null
            }
        }





    </script>
</header>
</body>
</html>
