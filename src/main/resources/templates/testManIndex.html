<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”å‘è´¨é‡ç®¡ç†ç³»ç»Ÿä¸»é¡µ</title>
    <!-- å¼•å…¥å­—ä½“å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- å¼•å…¥ jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="/css/testManIndexStyle.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>


</head>
<body>

<header>

<!--    <meta name="wpk-bid" content="dta_1_3078576183">-->

<div class="title-container">
    <button id="announcement-btn">æŸ¥çœ‹å…¬å‘Š(v2.3ï¼Œ20251018å»é™¤è¿›å…¥æŠ¥å‘Šæ“ä½œ)</button>
    <div class="title">ä¸»é¡µ</div>
    <!-- æŠ¥å‘ŠæŸ¥è¯¢é¡µé¢æŒ‰é’® -->
    <button id="report-query-btn" class="report-query-btn">é—®é¢˜å®¡æ ¸é¡µé¢(å¯ä¸‹è½½ä»–äººæŠ¥å‘Š)</button>
    <!-- é—®é¢˜åº“ç®¡ç†æŒ‰é’® -->
    <button id="problem-library-btn" class="problem-library-btn">é—®é¢˜åº“ç®¡ç†</button>
    <!-- æ•°æ®çœ‹æ¿æŒ‰é’® -->
    <button id="dashboard-btn" class="dashboard-btn">æ•°æ®çœ‹æ¿</button>
    <!-- æ’æœŸé¡¹ç›®é¢æ¿æŒ‰é’® -->
    <button id="schedule-panel-btn" class="schedule-panel-btn">æ’æœŸé¡¹ç›®æŒ‰é’®</button>
</div>

    <!-- æ’æœŸé¡¹ç›®é¢æ¿æ¨¡æ€æ¡† -->
    <div id="schedule-panel-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0; position: relative; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">ğŸ“‹ æ’æœŸé¡¹ç›®åˆ—è¡¨</h2>
                <span class="close" id="close-panel-modal" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: white; font-size: 28px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.3s;">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- æœç´¢æ¡† -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="project-search-input" placeholder="ğŸ” æœç´¢é¡¹ç›®ç¼–å·..." 
                           style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; box-sizing: border-box;">
                </div>
                <!-- é¡¹ç›®åˆ—è¡¨å®¹å™¨ -->
                <div id="schedule-project-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                    <!-- é¡¹ç›®åˆ—è¡¨ä¼šé€šè¿‡æ¥å£åŠ è½½ -->
                </div>
                <!-- ç©ºçŠ¶æ€æç¤º -->
                <div id="empty-project-list" style="display: none; text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                    <div style="font-size: 16px;">æš‚æ— æ’æœŸé¡¹ç›®</div>
                </div>
            </div>
        </div>
    </div>
    <style>
        #close-panel-modal:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #project-search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .project-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }
        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }
        .project-card:hover::before {
            transform: scaleY(1);
        }
        .project-card-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .project-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            flex-shrink: 0;
        }
        .project-info {
            flex: 1;
            min-width: 0;
        }
        .project-id {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            word-break: break-all;
        }
        .project-hint {
            font-size: 12px;
            color: #999;
        }
    </style>

    <!-- é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
    <!-- é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="project-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0; position: relative; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0;">
                <h2 id="project-detail-title" style="margin: 0; font-size: 18px;">ğŸ“‹ é¡¹ç›®è¯¦æƒ…</h2>
                <span class="close" id="close-project-modal" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: white; font-size: 28px; cursor: pointer;">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; transform: translateZ(0); -webkit-overflow-scrolling: touch;">
                <div id="project-detail-info" style="padding: 0;">åŠ è½½ä¸­...</div>

                <!-- æ–°å¢ï¼šå¼€å§‹æµ‹è¯•åŒºåŸŸ -->
                <div id="task-attributes" style="margin-top: 20px; display: none;">
                    <h3>å¡«å†™ä»¥ä¸‹å†…å®¹</h3>
                    <label>
                        ä»»åŠ¡å±æ€§ï¼š
                        <select id="questStats-detail">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="æ— ">æ— </option>
                            <option value="æ–°å“">æ–°å“</option>
                            <option value="æ–°è®¾å¤‡">æ–°è®¾å¤‡</option>
                            <option value="æ–°è½¯ä»¶ç‰ˆæœ¬">æ–°è½¯ä»¶ç‰ˆæœ¬</option>
                            <option value="å”®åé—®é¢˜åˆ†æ">å”®åé—®é¢˜åˆ†æ</option>
                            <option value="é‡äº§å‡çº§">é‡äº§å‡çº§</option>
                            <option value="ç«å“">ç«å“</option>
                        </select>
                    </label>
                    <br/><br/>
                    
                    <!-- é¢å¤–çš„ä¸‰ä¸ªå­—æ®µå®¹å™¨ -->
                    <div id="additional-fields" style="display: none;">
                        <label>
                            äº§å“ç±»åˆ«ï¼š
                            <input type="text" id="sample-category" placeholder="è¯·è¾“å…¥äº§å“ç±»åˆ«">
                        </label>
                        <br/><br/>
                        
                        <label>
                            æ ·å“æ•°é‡ï¼š
                            <input type="number" id="sample-quantity" placeholder="è¯·è¾“å…¥æ ·å“æ•°é‡" min="1">
                        </label>
                        <br/><br/>
                        
                        <label>
                            æ˜¯å¦é«˜é¢‘ï¼š
                            <select id="is-high-frequency">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="æ˜¯">æ˜¯</option>
                                <option value="å¦">å¦</option>
                            </select>
                        </label>
                        <br/><br/>
                    </div>
                </div>

                <!-- æŒ‰é’®å®¹å™¨ï¼šå°†ä¸¤ä¸ªæŒ‰é’®æ”¾åœ¨åŒä¸€è¡Œ -->
                <div class="button-container" style="display: flex; gap: 10px; margin-top: 20px; align-items: center;">
                    <button id="start-test-btn" style="flex: 1; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background-color 0.3s ease;">å¼€å§‹æµ‹è¯•</button>
                    <button id="confirm-task-btn" style="flex: 1; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; display: none; transition: background-color 0.3s ease;">ç¡®è®¤å¼€å§‹æµ‹è¯•</button>
                </div>
                <style>
                    #start-test-btn:hover {
                        background-color: #0056b3 !important;
                    }
                    #confirm-task-btn:hover {
                        background-color: #218838 !important;
                    }
                </style>
            </div>
        </div>
    </div>



    <!-- æ›´æ–°æ—¥å¿—é¢æ¿ -->
    <div id="log-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>æ›´æ–°æ—¥å¿—<span style="color: red;">(ï¼ï¼ï¼ç®€åŒ–æäº¤æ­¥éª¤ï¼Œä¸ç”¨å†è¿›å…¥æŠ¥å‘Šäº†ï¼)</span></h2>
            <p>20251204:æäº¤çš„æ—¶å€™å°½å¯èƒ½ä¸€æ¬¡æ€§å¸¦å‡ºæ‰€æœ‰æç¤ºç»™æµ‹è¯•äººå‘˜ã€‚  ----ææ™ºé¾™æè®®
                <br>
                20251204ï¼šä¼˜åŒ–æµ‹è¯•äººå‘˜é¡µé¢UIï¼Œå³ä¾§æ“ä½œæŒ‰é’®å»æ‰ï¼Œç›´æ¥æ‹†åˆ†å±•ç¤ºæäº¤ï¼Œè½¬å‘ï¼Œåˆ é™¤æŒ‰é’®ã€‚ ----åŠ³é’°é›¯æè®®
                <br>
                20251017:æäº¤æŠ¥å‘Šçš„æ—¶å€™å»é™¤è¿›å…¥æŠ¥å‘Šè¿™ä¸€æ­¥ï¼Œæ€»ç®—æŠ½ç©ºä¼˜åŒ–è¿™ä¸€æ­¥éª¤äº†ã€‚
                <br>
                20250111:åˆ›å»ºæŠ¥å‘Šç°åœ¨éœ€è¦å¡«å†™çš„æ˜¯è®¡åˆ’è¡¨å¢ç»®æ•æä¾›çš„ä¸‰ä¸ªæ’æœŸå†…å®¹ï¼šæ’æœŸæ—¶é—´ï¼Œæ’æœŸå¤©æ•°ï¼Œè¯·å†™å‡†ç¡®ï¼Œä¸å…è®¸ä¿®æ”¹çš„ï¼
                <br>
                2024.11.18<br>
                1. æ‰“é€šæµ‹è¯•æŠ¥å‘Šå®¡æ ¸ç­¾æ ·æµç¨‹ï¼šæµ‹è¯•äººå‘˜æäº¤->DQEå®¡æ ¸é—®é¢˜ç‚¹->ç ”å‘å®¡æ ¸åˆ¤å®š->DQEæœ€ç»ˆåˆ¤å®š->è¿”å›é€šçŸ¥æµ‹è¯•åŠDQEåˆ¤å®šç»“æœã€‚æ­¤è¿‡ç¨‹ä¸­ä»»ä½•ä¸€æ–¹è§’è‰²éƒ½å¯ä»¥åŒæ­¥æŸ¥çœ‹ä¿®æ”¹é—®é¢˜ç‚¹ï¼Œå¹¶ä¸”æœ‰æ“ä½œè®°å½•,æ¯ä¸ªæµç¨‹èŠ‚ç‚¹éƒ½ä¼šæœ‰OAæ¶ˆæ¯é€šçŸ¥å¯¹åº”äººã€‚<br>
                2. æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ååŠ ä¸Šä»»åŠ¡å±æ€§ï¼Œä¸ç„¶ä¼šæœ‰ä¸å…¶ä»–æ–‡ä»¶å†²çªçš„é£é™©ã€‚  --èµµçˆ½å‘ç°<br>
                3. é€¾æœŸèŠ‚ç‚¹æ›´æ–°ï¼Œä» '2024-11-18 00:00:00'åˆ›å»ºçš„æ–‡ä»¶å¼€å§‹ç®—èµ·ã€‚
                <br>
                2.æ–°å¢ã€ŠæŸ¥çœ‹é—®é¢˜ç‚¹ã€‹æŒ‰é’®ï¼Œç”¨äºæµ‹è¯•äººå‘˜æµ‹è¯•å·²ä¸Šä¼ çš„é—®é¢˜ç‚¹ï¼ˆè·Ÿå±•ç¤ºç»™DQEå’Œç ”å‘çš„ä¸€è‡´ï¼‰ï¼Œæ­¤æŒ‰é’®ä½ç½®åœ¨ã€Šæ›¿æ¢æŠ¥å‘Šã€‹æŒ‰é’®å·¦ä¾§ã€‚ <br>
                <br>
                2024.10.10<br>
                1.å°†æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ä¸Šè°ƒåˆ°100MBï¼Œæ»¡è¶³äº¤æ¢æœºå› ä¸ºå›¾ç‰‡å¤šå¯¼è‡´æ–‡ä»¶å¤ªå¤§æ— æ³•æ›¿æ¢çš„é—®é¢˜ã€‚ ----è‚–é¾™ç”Ÿæå‡º<br>
                2.ä¼˜åŒ–äº†æ–‡ä»¶è§£æé€»è¾‘ï¼Œè§£å†³éƒ¨åˆ†æ–‡ä»¶æ›¿æ¢åå¯¼è‡´æœåŠ¡å™¨å´©æºƒçš„é—®é¢˜ã€‚  ---æç´ æ¬£å‘ç°<br>
                2024.09.27<br>
                1.å°†æäº¤æŒ‰é’®æ”¹æˆçµæ´»å˜åŠ¨çš„çŠ¶æ€ï¼šæäº¤ï¼Œæ’¤å›ï¼Œå®Œç»“<br>
                <br>
                2024.09.24ï¼š<br>
                1.è¶…å‡ºå®½åº¦è‡ªåŠ¨æ¢è¡Œ<br>
                2.å›¾ç‰‡åœ¨å•å…ƒæ ¼å±•ç¤º --é»„å…°å§£å»ºè®®<br>
                3.ç±»åˆ«æ–°å¢ä¸€ä¸ªé€‰å“ --è“æ˜åŸå»ºè®®<br>
                4.ä¿®æ”¹å…¬å¼ä¸å±•ç¤ºæ­£ç¡®å€¼çš„bug --é™ˆæ˜±è²å‘ç°<br>
                5.æ–°å¢åŠŸèƒ½æŒ‰é’®-é»‘è‰²çº¢è‰²å­—ä½“ --é»„å…°å§£å»ºè®®<br>
                6.æ–°å¢åŠŸèƒ½æŒ‰é’®-å†»ç»“çª—æ ¼    --ç¨‹å¥•é˜³å»ºè®®<br>
                <br>
                2024.9.19:<br>
                1. ä¸»é¡µé»˜è®¤æ”¹ä¸ºé™åºï¼Œæœ€è¿‘æ—¶é—´åˆ›å»ºçš„æŠ¥å‘Šæ’åœ¨æœ€ä¸Šæ–¹ã€‚ --è‚–é¾™ç”Ÿå‘ç°<br>
                2. ä¿®æ”¹äº§å“ä¿¡æ¯åŠ ä¸Š*å·å±•ç¤ºä¸ºå¿…å¡«é¡¹ã€‚--è‚–é¾™ç”Ÿå»ºè®®<br>
                3. æŠ¥å‘Šå†…å®¹æ ¼å¼åœ¨ç¨‹åºè§£æåä¸ºå±…ä¸­é å·¦--é»„å…°å§£éœ€æ±‚<br>
                4. è§£ææ–‡ä»¶é™åˆ¶æœ€å¤§çš„åˆ—æ•°100ï¼Œè¡Œæ•°åˆ™å¦‚æœè¿ç»­10è¡Œä¸ºç©ºåˆ™åœæ­¢å¾€ä¸‹è§£æã€‚(é˜²æ­¢æ–‡ä»¶å³æ–¹å’Œä¸‹æ–¹å‡ºç°å¤ªå¤šç©ºæ ¼åŠ è½½å†—ä½™)<br>
                5. æ–°å¢å­—æ®µæµ‹è¯•æ—¶é•¿å’Œé¢„è®¡æµ‹è¯•æ—¶é•¿ï¼Œåœ¨UIå±•ç¤ºã€‚<br>
                6. è§£å†³bug: xlsxæ–‡ä»¶ä¸­çš„æµ®ç‚¹æ•°è§£æåˆ°ç¨‹åºé‡Œä¼šå‘ä¸Šå–æ•´ä¸ºæ•´æ•°ï¼Œå®é™…ä¸Šæ–‡ä»¶å†…å®¹è¿˜æ˜¯å°æ•°ç‚¹ï¼Œå·²è§£å†³ï¼Œç°åœ¨å¯¹æµ®ç‚¹æ•°ç±»å‹ä¸è¿›è¡Œå°æ•°ç‚¹é™åˆ¶ã€‚--é¾™è¿å‘ç°<br>
                7. æäº¤æŠ¥å‘Šçš„æ—¶å€™æ–°å¢å¯¹ç¼ºå°‘"æµ‹è¯•é—®é¢˜ç‚¹æ±‡æ€»"å·¥ä½œè¡¨çš„æç¤ºï¼Œæ–¹ä¾¿æ‰¾åˆ°æäº¤å¤±è´¥çš„é—®é¢˜ã€‚<br>
                8. è®¾ç½®é€¾æœŸåˆ¤æ–­ï¼Œä»2024.9.23å·0ç‚¹åˆ›å»ºçš„æ–‡ä»¶å¼€å§‹è®¡ç®—ã€‚<br>
                9. å¯ä»¥æŸ¥çœ‹å„ç»„å‘˜æŠ¥å‘Šç”¨æ—¶æƒ…å†µï¼Œå¯ä»¥å¯¼å‡ºä¸ºä¸€ä»½xlsxæ–‡ä»¶ã€‚<br>

                <br>
                2024.09.07ï¼š<br>
                1. æ–°å¢ä¸»é¡µUIä¾›åº”å•†å±•ç¤ºï¼›--é¾™è¿éœ€æ±‚<br>
                2. è§£å†³ç­¾åç»è¿‡ä¿å­˜æŒ‰é’®è¿˜ä¸èƒ½å®ç°æ›¿æ¢çš„bugã€‚--è“æ˜åŸå‘ç°<br>
                3. è§£å†³åˆ›å»ºæŠ¥å‘Šå¡«å•-ä¸»æ§èŠ¯ç‰‡å­—æ•°å¤ªé•¿å¯¼è‡´æ— æ³•ä¿å­˜çš„bug,ç°åœ¨å¯ä»¥è¾“å…¥65,535ä¸ªå­—ç¬¦ã€‚--ææ™ºé¾™å‘ç°<br>
                4. è§£å†³äº§å“åç§°æœ‰éƒ¨åˆ†å­—ç¬¦å¯¼è‡´æ— æ³•ä¿å­˜çš„bugï¼Œç‰¹æ®Šå­—ç¬¦ä¼šå¼ºåˆ¶è½¬æ¢ä¸º"_"ã€‚--å¼ é”å‘ç°<br>


            </p>
        </div>
    </div>


<!-- æ•°æ®ç»Ÿè®¡åŒºåŸŸ -->
<div class="stats-container">
    <div class="stats" id="stats">
        <span id="testing">æµ‹è¯•ï¼š0</span>
        <span id="pending">å®¡æ ¸ï¼š0</span>
        <span id="completed">å®Œæˆï¼š0</span>
        <span id="total">æ€»æ•°ï¼š0</span>
        <span id="overdue">é€¾æœŸï¼š<span class="biaoji">0</span></span>
        <span id="danger">å¤±è´£ï¼š<span class="biaoji">0</span></span>
    </div>
</div>


<!-- æœç´¢æ¡† -->
<div class="search-container">
    <div class="search-wrapper">
        <button class="createTestBtn">åˆ›å»º<br>æŠ¥å‘Š</button>
        <input type="text" class="search-input" placeholder="å…³é”®å­—æœç´¢">
        <button class="search-btn"><i class="fas fa-search"></i></button>
    </div>
    <div class="select-wrapper">
        <select class="filter-select" id="sort-filter">
            <option value="all">æ’åº</option>
            <option value="asc">å‡åº</option>
            <option value="desc">é™åº</option>
        </select>
    </div>
</div>

<!-- è¡¨æ ¼åˆ—è¡¨ -->
<div class="table-container">
    <table class="static-header" style="display: none;">
        <thead>
        <tr>
            <th rowspan="1">æ²¡æœ‰æ‚¨çš„æ–‡ä»¶ï¼Œå¿«å»åˆ›å»ºå§ï¼</th>

        </tr>

        </thead>
    </table>

</div>


<!--    2024.10.31ç»™æµ‹è¯•äººå‘˜é¡µé¢åŠ ä¸€ä¸ªç»™æŸ¥çœ‹é—®é¢˜ç‚¹çš„æŒ‰é’®-->
    <!-- æ¨¡æ€æ¡†ç»“æ„ -->
    <div id="testIssuesModal" class="problemModal">
        <div class="problemModal-content">
            <span class="close-problem">&times;</span>
            <div id="testIssuesContent"></div>
        </div>
    </div>

<!-- æ¨¡æ€æ¡† -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>é€‰æ‹©åˆ†ç±»</h2>
        <div id="categoryList"></div>
        <div id="fileList"></div>
    </div>
</div>

<!-- ä¿¡æ¯è¾“å…¥æ¨¡æ€æ¡† -->
<div id="infoModal" class="inputModal">
    <div class="inputModal-content">
        <span class="close">&times;</span>
        <h2>è¯·è¾“å…¥äº§å“ä¿¡æ¯</h2>
        <form id="fileInfoForm">
            <label for="model">å¤§ç¼–ç :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="text" id="model" name="model" required placeholder="å¿…å¡«é¡¹ï¼Œæ²¡æœ‰åˆ™å¡«æ— ">
            <label for="coding">å°ç¼–ç :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="text" id="coding" name="coding" required placeholder="å¿…å¡«é¡¹ï¼Œæ²¡æœ‰åˆ™å¡«æ— ">
            <label for="category">ç±»åˆ«:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <select id="category" name="category" required>
                <option value="" disabled selected>è¯·é€‰æ‹©ç±»åˆ«</option>
                <option value="å¤§è´§æ ·">å¤§è´§æ ·</option>
                <option value="åŠŸèƒ½æ ·">åŠŸèƒ½æ ·</option>
                <option value="ç«å“">ç«å“</option>
                <option value="é¢„ç ”">é¢„ç ”</option>
                <option value="é€‰å“">é€‰å“</option>
            </select>
            <!--æ–°å¢ä»»åŠ¡å±æ€§å­—æ®µ20240709-->
            <label for="questStats">ä»»åŠ¡å±æ€§:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <select id="questStats" name="questStats" required>
                <option value="" disabled selected>è¯·é€‰æ‹©ä»»åŠ¡å±æ€§ï¼Œå¿…é€‰</option>
                <option value="æ— ">æ— </option>
                <option value="æ–°å“">æ–°å“</option>
                <option value="æ–°è®¾å¤‡">æ–°è®¾å¤‡</option>
                <option value="æ–°è½¯ä»¶ç‰ˆæœ¬">æ–°è½¯ä»¶ç‰ˆæœ¬</option>
                <option value="å”®åé—®é¢˜åˆ†æ">å”®åé—®é¢˜åˆ†æ</option>
                <option value="é‡äº§å‡çº§">é‡äº§å‡çº§</option>
                <option value="ç«å“">ç«å“</option>
            </select>

            <!-- å¼•å…¥å“ç±»ç»†åˆ†ç»„ä»¶ -->
            <label for="big_species">å¤§ç±»:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <select id="big_species" name="big_species" required onchange="populateSubCategory()">
                <option value="" disabled selected>è¯·é€‰æ‹©å¤§ç±»</option>
                <!-- é€šè¿‡jsonæ–‡ä»¶åŠ¨æ€åŠ å…¥é€‰é¡¹ -->
            </select>

            <label for="small_species">ç»†åˆ†å“ç±»:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <select id="small_species" name="small_species" required>
                <option value="" disabled selected>è¯·é€‰æ‹©ç»†åˆ†å“ç±»</option>
                <!-- æ ¹æ®å¤§ç±»è‡ªåŠ¨å¡«å…… -->
            </select>

            <label for="version">ç‰ˆæœ¬:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="text" id="version" name="version" required placeholder="å¿…å¡«é¡¹å¤§å†™ï¼Œæ²¡æœ‰å¡«æ— ">
            <label for="sample_name">äº§å“åç§°:</label>
            <input type="text" id="sample_name" name="sample_name" required placeholder="å¿…å¡«é¡¹ï¼Œ/\:*?<>|ä¼šæ›¿æ¢æˆä¸‹æ¨ªçº¿_"><br>
            <!--   20250108 åˆ æ‰é¢„è®¡å®Œæˆæ—¶é—´ï¼Œæ”¹æˆ3ä¸ªå­—æ®µï¼šæ’æœŸå¼€å§‹æ—¶é—´ï¼Œæ’æœŸç»“æŸæ—¶é—´ï¼Œæ’æœŸæµ‹è¯•å‘¨æœŸ        -->
<!--            <label for="planfinish_time">é¢„è®¡å®Œæˆæ—¶é—´:</label>-->
<!--            <input type="datetime-local" id="planfinish_time" name="planfinish_time" required><br>-->
            <label for="scheduleStartTime">æ’æœŸå¼€å§‹æ—¶é—´:</label>
            <input type="datetime-local" id="scheduleStartTime" name="scheduleStartTime" required><br>
            <label for="scheduleEndTime">æ’æœŸç»“æŸæ—¶é—´:</label>
            <input type="datetime-local" id="scheduleEndTime" name="scheduleEndTime" required><br>
            <label for="scheduleTestCycle">æ’æœŸæµ‹è¯•å‘¨æœŸ(å¤©):</label>
            <input type="number" id="scheduleTestCycle" name="scheduleTestCycle" min="0.5" step="0.5" required placeholder="å¿…å¡«é¡¹ï¼Œæœ€å°æ˜¯0.5">


            <label for="sample_frequency">é€æ ·æ¬¡æ•°:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="number" id="sample_frequency" name="sample_frequency" min="1" required placeholder="å¿…å¡«é¡¹ï¼Œè¯·å†™æ˜æ˜¯ç¬¬å‡ æ¬¡é€æ ·ï¼Œç¬¬ä¸€æ¬¡åˆ™ä¸º1">
            <label for="sample_quantity">é€æ ·æ•°é‡:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="number" id="sample_quantity" name="sample_quantity" min="1" required placeholder="å¿…å¡«é¡¹">

            <label for="high_frequency">æ‚¨æ˜¯é«˜é¢‘æµ‹è¯•äººå‘˜å—ï¼Ÿ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <select id="high_frequency" name="high_frequency" required>
                <option value="" disabled selected>è¯·é€‰æ‹©</option>
                <option value="æ˜¯">æ˜¯</option>
                <option value="å¦">å¦</option>
            </select>

            <!--   20250612æ–°å¢ç”µæ°”ç¼–å·ä¸ºå¿…å¡«é¡¹-->
            <label for="electric_sample_id">ç”µæ°”ç¼–å·:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
            <input type="text" id="electric_sample_id" name="electric_sample_id"  placeholder="è¯·å»ITæå•æ–°ç³»ç»ŸæŸ¥æ‰¾å¯¹åº”çš„ç”µæ°”ç¼–å·ï¼Œä¾‹å¦‚ET2505150001">

            <button type="submit">æäº¤</button>

        </form>
    </div>
</div>

<div id="existModal" class="inputModal">
    <div class="existModal-content">
        <span class="close">&times;</span>
        <h2>å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€ä»½æ–‡ä»¶è¿›è¡Œæ¨¡æ¿ä½¿ç”¨ï¼š</h2>
    </div>
</div>


<!-- ä¸‹æ–¹å›ºå®šæŒ‰é’® -->
<div class="btn-container">
    <hr class="divider"> <!-- æŒ‰é’®ä¸Šæ–¹çš„æ¨ªçº¿ -->
    <!-- ä¸»é¡µæŒ‰é’® -->
    <button class="btn" id="homeBtn"><i class="fas fa-home"></i></button>
    <!-- æœç´¢èµ„æºåº“æŒ‰é’® -->
    <button class="btn" id="cloudBtn" ><i class="fas fa-cloud"></i></button>
    <!-- ä¸ªäººç•Œé¢æŒ‰é’® -->
    <button class="btn" id="profileBtn"><i class="fas fa-user"></i></button>
</div>


<!-- è¿›åº¦æ¡å®¹å™¨ï¼Œåˆå§‹æ—¶éšè— -->
<div id="uploadProgress" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.95); border: 2px solid #4CAF50; border-radius: 8px; padding: 20px; min-width: 400px; max-width: 600px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); z-index: 10000;">
    <div style="margin-bottom: 10px; font-weight: bold; text-align: center; color: #333;">æ–‡ä»¶ä¸Šä¼ è¿›åº¦</div>
    <div style="width: 100%; height: 25px; background-color: #f0f0f0; border-radius: 12px; overflow: hidden; position: relative;">
        <div id="uploadProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%); transition: width 0.3s ease; border-radius: 12px;"></div>
    </div>
    <div class="progress-text" style="text-align: center; padding: 10px 5px 5px; color: #666; font-size: 14px;"></div>
</div>

    <!-- è‡ªå®šä¹‰æ¨¡æ€æ¡† -->
    <div id="loadingModal" class="inputModal">
        <div class="existModal-content">
            <span id="closeModal" class="close">&times;</span>
            <h2>æ­£åœ¨æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ï¼Œè¯·ç¨å€™...</h2>
            <p><span id="countdown">5</span> ç§’åè‡ªåŠ¨è·³è½¬</p>
            <button id="cancelButton">å–æ¶ˆ</button>
        </div>
    </div>


    <!-- æ¨¡æ€æ¡†çš„ HTML ç»“æ„ -->
    <div id="alert-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10003;">
        <div id="alert-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
            <div id="alert-message" style="margin-bottom: 20px;">æç¤ºä¿¡æ¯</div>
            <button id="alert-confirm" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®è®¤</button>
        </div>
    </div>

    <!-- ç¡®è®¤æ¨¡æ€æ¡†çš„ HTML ç»“æ„ -->
    <div id="confirm-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10004;">
        <div id="confirm-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
            <div id="confirm-message" style="margin-bottom: 20px;">ç¡®è®¤ä¿¡æ¯</div>
            <button id="confirm-yes" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¡®è®¤</button>
            <button id="confirm-no" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
        </div>
    </div>


    <!-- æ¨¡æ€æ¡† HTML -->
    <div id="restDaysModal" style="display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 30%; text-align: center; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3>è¯·è¾“å…¥æœŸé—´ä¼‘æ¯å¤©æ•°</h3>
            <p>ï¼ˆåªèƒ½è¾“å…¥0.5ï¼Œ1.5ï¼Œæˆ–è€…æ•´æ•°1ï¼‰</p>
            <input type="text" id="restDaysInput" placeholder="ä¾‹å¦‚ï¼š0.5, 1, 1.5" style="width: 80%; padding: 5px;">
            <br><br>
            <button onclick="submitRestDays()">ç¡®è®¤</button>
            <button onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="choiceModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background-color:#35813f; padding:20px; border:1px solid #ccc; z-index:10002; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
        <button id="closeChoiceModal" style="position:absolute; top:5px; right:5px; background:transparent; border:none; font-size:18px; color:white; cursor:pointer;">&times;</button>
        <p style="color:white; font-size:16px;">è¯·é€‰æ‹©ï¼š</p>
        <div style="display:flex; justify-content:space-around; gap:10px;">
            <button id="btnRetireSample" style="padding:10px 20px; border:none; background-color:#f7d716; color:black; border-radius:5px; cursor:pointer;">æµ‹è¯•äººå‘˜é€€æ ·ï¼ˆå…å®¡æ ¸æµç¨‹ï¼‰</button>
            <button id="btnCompetitive" style="padding:10px 20px; border:none; background-color:#f7d716; color:black; border-radius:5px; cursor:pointer;">æµ‹è¯•äººå‘˜ç«å“å®Œæˆï¼ˆå…å®¡æ ¸æµç¨‹ï¼Œä¼šå‘é€é€šçŸ¥ï¼‰</button>
            <button id="btnNoChoice" style="padding:10px 20px; border:none; background-color:#f7d716; color:black; border-radius:5px; cursor:pointer;">èµ°å®¡æ ¸æµç¨‹</button>
        </div>
    </div>

    <!-- æŸ¥çœ‹èµ„æ–™æ¨¡æ€æ¡† -->
    <div id="viewDataModal" class="viewDataModal">
        <div class="modal-content">
            <span class="close" id="closeViewDataModal">&times;</span>
            <h2>èµ„æ–™ä¸‹è½½</h2>

            <h3>æ‰¿è®¤ä¹¦</h3>
            <ul id="admitLinksContainer"></ul>

            <h3>å¼€å‘è¦æ±‚</h3>
            <ul id="developLinksContainer"></ul>
        </div>
    </div>

    <!-- æŸ¥çœ‹æµ‹è¯•é¡¹æ¨¡æ€æ¡† -->
    <div id="viewTestItemsModal" class="viewDataModal">
        <div class="modal-content">
            <span class="close" id="closeViewTestItemsModal">&times;</span>
            <h2>æµ‹è¯•é¡¹è¯¦æƒ…</h2>
            <div id="testItemsContainer">
                <table id="testItemsTable" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">åºå·</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">è¯•éªŒé¡¹ç›®ç±»åˆ«</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æµ‹è¯•å­é¡¹ç›®</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">æµ‹è¯•å½’å±</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="testItemsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>




<script>

    //æ’æœŸé¡¹ç›®çš„å±æ€§
    let currentProjectData = null;

    document.getElementById("choiceModal").addEventListener("click", function() {
        document.getElementById("choiceModal").style.display = "none";
    });


    // è¦†ç›–åŸç”Ÿ alert æ–¹æ³•
    window.alert = function(message) {
        // è·å–æ¨¡æ€æ¡†å…ƒç´ 
        const overlay = document.getElementById('alert-overlay');
        const modal = document.getElementById('alert-modal');
        const messageElem = document.getElementById('alert-message');
        const confirmButton = document.getElementById('alert-confirm');

        // è®¾ç½®æ¶ˆæ¯æ–‡æœ¬
        messageElem.textContent = message;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        overlay.style.display = 'block';
        modal.style.display = 'block';

        // ç‚¹å‡»ç¡®è®¤æŒ‰é’®æ—¶å…³é—­æ¨¡æ€æ¡†
        confirmButton.onclick = () => {
            overlay.style.display = 'none';
            modal.style.display = 'none';
            // è°ƒç”¨åŸæœ¬çš„alertå›è°ƒ
        };
    };



    // è¦†ç›–åŸç”Ÿ confirm æ–¹æ³•
    window.confirm = function(message) {
        return new Promise(function(resolve, reject) {
            const overlay = document.getElementById('confirm-overlay');
            const modal = document.getElementById('confirm-modal');
            const messageElem = document.getElementById('confirm-message');
            const yesButton = document.getElementById('confirm-yes');
            const noButton = document.getElementById('confirm-no');

            // è®¾ç½®æ¶ˆæ¯æ–‡æœ¬
            messageElem.textContent = message;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            overlay.style.display = 'block';
            modal.style.display = 'block';

            // ç‚¹å‡»"ç¡®è®¤"æŒ‰é’®æ—¶ï¼Œå…³é—­æ¨¡æ€æ¡†å¹¶è¿”å› true
            yesButton.onclick = () => {
                overlay.style.display = 'none';
                modal.style.display = 'none';
                resolve(true); // è¿”å› true è¡¨ç¤ºç”¨æˆ·ç‚¹å‡»äº†ç¡®è®¤
            };

            // ç‚¹å‡»"å–æ¶ˆ"æŒ‰é’®æ—¶ï¼Œå…³é—­æ¨¡æ€æ¡†å¹¶è¿”å› false
            noButton.onclick = () => {
                overlay.style.display = 'none';
                modal.style.display = 'none';
                reject(false); // è¿”å› false è¡¨ç¤ºç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ
            };
        });
    };




    // æ­¤è·¯å¾„æ˜¯æŒ‡æ–‡ä»¶æ¨¡æ¿çš„ä½ç½®BASE_DIRECTORY
    const BASE_DIRECTORY = localStorage.getItem('templatespath');
    const savepath = localStorage.getItem('savepath');
    const corp_id = localStorage.getItem('corp_id');

    let isEditing = false; // æ–°å¢çŠ¶æ€æ ‡å¿—

    const username = localStorage.getItem('username');
    const job =localStorage.getItem('job');
    //è°ƒè¯•ç”¨
    // const username = "å¢å¥";
    // const job = "tester";

    function initData(){
        // ä»åç«¯è·å–æ•°æ®å¹¶æ›´æ–°é¡µé¢å†…å®¹
        $.ajax({
            url: '/data', // å‘åç«¯å‘èµ·è¯·æ±‚çš„æ¥å£åœ°å€
            type: 'GET', // è¯·æ±‚æ–¹å¼
            data: { 'username': username }, // å°† username ä½œä¸ºè¯·æ±‚å‚æ•°å‘é€
            success: function(data) {
                // æ ¹æ®åç«¯è¿”å›çš„æ•°æ®æ›´æ–°é¡µé¢å†…å®¹
                $('#testing').text('æµ‹è¯•ï¼š' + data.testing);
                $('#pending').text('å®¡æ ¸ï¼š' + data.pending);
                $('#completed').text('å®Œæˆï¼š' + data.completed);
                $('#total').html('æ€»æ•°ï¼š' + data.total + '&nbsp;');
                $('#overdue').html('é€¾æœŸï¼š<span class="biaoji">' + data.overdue + '&nbsp;'+ '</span>');
                $('#danger').html('å¤±è´£ï¼š<span class="biaoji">' + data.danger + '</span>');
            },
            error: function(xhr, status, error) {
                console.error('Failed to retrieve data:', status, error);
            }
        });
    }

    initData();

    // ä¸‹æ–¹ä¸‰ä¸ªæŒ‰é’®è·³è½¬é¡µé¢
    const homeBtn = document.getElementById('homeBtn');
    const cloudBtn = document.getElementById('cloudBtn');
    const profileBtn = document.getElementById('profileBtn');

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    $(homeBtn).click(function() {
        // è·³è½¬åˆ°ä¸»é¡µ
        window.location.href = '/home';
    });

    $(cloudBtn).click(function() {
        let userRole = 'testMan'; // ç¤ºä¾‹è§’è‰²ï¼Œå¯ä»¥åŠ¨æ€è·å–
        // è·³è½¬åˆ°æœç´¢èµ„æºåº“é¡µé¢
        // window.location.href = `/durationTable?dd_orientation=landscape&role=${userRole}`;
        window.location.href = `/labModuleTester`;
    });


    $(profileBtn).click(function() {
        // è·³è½¬åˆ°ä¸ªäººç•Œé¢é¡µé¢
        window.location.href = '/testManProfile';
    });

    $(document).ready(function () {
        // è°ƒç”¨åç«¯æ¥å£è·å–é…ç½®ä¿¡æ¯
        $.ajax({
            url: '/getJsapiConfig',
            type: 'GET',
            data: { url: encodeURIComponent(location.href.split('#')[0]) },
            success: function(config) {
                // ä½¿ç”¨è·å–çš„é…ç½®ä¿¡æ¯åˆå§‹åŒ–é’‰é’‰JSAPI
                dd.config({
                    agentId: config.agentId,
                    corpId: config.corpId,
                    timeStamp: config.timeStamp,
                    nonceStr: config.nonceStr,
                    signature: config.signature,
                    jsApiList: config.jsApiList // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„jsapiåˆ—è¡¨
                });
                //è·å–è®¾å¤‡å”¯ä¸€UUID
                dd.getDeviceUUID({
                    onSuccess : function(data) {
                        const uuidKey = `uuid_`;
                        localStorage.setItem(uuidKey, JSON.stringify(data.uuid));
                        // alert(data.uuid);
                    },
                    onFail : function(err) {
                        console.log("è·å–UUIDå¤±è´¥",err);
                    }
                });

            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });


        loadData();
        // åŠ è½½æ•°æ®çš„å‡½æ•°
        function loadData() {
            // ä» localStorage ä¸­è·å– username
            // var username = localStorage.getItem('username');

            // æ£€æŸ¥ username æ˜¯å¦å­˜åœ¨
            if (!username) {
                console.error('ç”¨æˆ·åæœªå®šä¹‰ï¼Œæ— æ³•åŠ è½½æ•°æ®');
                // é‡å®šå‘åˆ°é’‰é’‰å…ç™»æµç¨‹å¯åŠ¨é¡µé¢ï¼Œä¾‹å¦‚ï¼š
                alert("ç”¨æˆ·ä¿¡æ¯è¿‡æœŸï¼Œè¯·å…³é—­ä¹‹åé‡æ–°è¿›å…¥é’‰é’‰å¾®åº”ç”¨");
                return;
            }

            $.ajax({
                url: '/getTestManPanel', // åç«¯æ¥å£åœ°å€,è¿™é‡Œè¿”å›çš„dataæ˜¯samplesç±»ï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½æœ‰
                type: 'GET',
                data: { 'username': username }, // å°† username ä½œä¸ºè¯·æ±‚å‚æ•°å‘é€
                success: function(data) {

                    const type = "initialize";
                    renderTableContainer(data,type);

                },
                error: function(xhr, status, error) {
                    console.error('Failed to retrieve data:', status, error);
                }
            });
        }

        // ç›‘å¬æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('.search-btn').click(function() {
            performSearch();
        });

        // ç»™search-inputæ·»åŠ å›è½¦é”®ç›‘å¬äº‹ä»¶
        $('.search-input').on('keydown', function(event) {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†å›è½¦é”®
            if (event.keyCode === 13) {
                event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå¦‚è¡¨å•æäº¤
                performSearch(); // è§¦å‘æœç´¢åŠŸèƒ½
            }
        });

        // ç›‘å¬ç±»åˆ«é€‰æ‹©æ¡†å˜åŒ–äº‹ä»¶
        $('#sort-filter').change(function() {
            performSearch(); // æ‰§è¡Œæœç´¢æ“ä½œ
        });


        var categoryModal = document.getElementById("categoryModal");
        var categorySpan = categoryModal.getElementsByClassName("close")[0];
        var infoModal = document.getElementById("infoModal");

        var infoSpan = infoModal.getElementsByClassName("close")[0];
        var categoryListContainer = document.getElementById("categoryList");
        var fileListContainer = document.getElementById("fileList");
        var selectedFilePath = '';


        var existModal = document.getElementById("existModal");
        var existSpan = existModal.getElementsByClassName("close")[0];
        existSpan.onclick = function () {
            existModal.style.display = "none";
        }

        $('.createTestBtn').click(function () {
            categoryModal.style.display = "block";
            loadCategories();
        });

        categorySpan.onclick = function () {
            categoryModal.style.display = "none";
        }

        infoSpan.onclick = function () {
            infoModal.style.display = "none";
        }


        window.onclick = function (event) {
            if (event.target == categoryModal) {
                categoryModal.style.display = "none";
            } else if (event.target == infoModal) {
                // æ­¤å¤„æ³¨é‡Šæ‰ï¼Œä¸ç„¶ç‚¹å‡»å¤–æ¡†å°±ä¼šå…³é—­è¾“å…¥çš„æ¨¡æ€æ¡†
                // infoModal.style.display = "none";
            }

            const modal = document.getElementById('viewDataModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }

            const testModal = document.getElementById('viewTestItemsModal');
            if (event.target === testModal) {
                testModal.style.display = 'none';
            }

            const editModal = document.getElementById('editModal');
            if (event.target === editModal) {
                editModal.style.display = 'none';
                // å…³é—­ä¿®æ”¹äº§å“ä¿¡æ¯æ¨¡æ€æ¡†æ—¶è§¦å‘æœç´¢æ–¹æ³•åˆ·æ–°åˆ—è¡¨
                performSearch();
            }

        }

        function loadCategories() {
            $.ajax({
                url: '/home/getFileCategories',
                type: 'GET',
                success: function (data) {
                    categoryListContainer.innerHTML = '';
                    data.forEach(function (category) {
                        var div = document.createElement('div');
                        div.className = 'category-item';
                        div.innerText = category;
                        div.onclick = function () {
                            loadFiles(category);
                        };
                        categoryListContainer.appendChild(div);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Failed to retrieve categories:', status, error);
                }
            });
        }

        function loadFiles(category) {
            $.ajax({
                url: '/home/getFiles?category=' + category,
                type: 'GET',
                success: function (fileData) {

                    fileListContainer.innerHTML = '';
                    fileData.forEach(function (file) {
                        var div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerText = file.name;
                        if (file.type === 'directory') {
                            div.classList.add('folder');
                            div.onclick = function () {
                                loadFiles(category + '/' + file.name);
                            };
                        } else {
                            if (file.name.endsWith('.xlsx')) {
                                div.classList.add('file', 'xlsx-file');
                                div.onclick = function () {
                                    selectedFilePath = BASE_DIRECTORY + '/' + category + '/' + file.name;
                                    infoModal.style.display = "block";
                                };
                            }
                        }
                        fileListContainer.appendChild(div);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Failed to retrieve files:', status, error);
                }
            });
        }

        //è¿™æ˜¯åˆ›å»ºæŠ¥å‘Šå¡«å†™ä¹‹åæäº¤æŒ‰é’®è§¦å‘çš„æ–¹æ³•
        $('#fileInfoForm').submit(function(event) {
            event.preventDefault();
            var model = $('#model').val();
            var coding = $('#coding').val();
            var category = $('#category').val();
            var version = $('#version').val();
            var sample_name = $('#sample_name').val();
            var sample_frequency = $('#sample_frequency').val();
            var sample_quantity = $('#sample_quantity').val();
            var big_species = $('#big_species').val();
            var small_species = $('#small_species').val();
            var high_frequency = $('#high_frequency').val();
            var questStats = $('#questStats').val();
            var electric_sample_id = $('#electric_sample_id').val();


            // æ¸…ç†sample_nameï¼Œæ›¿æ¢ç‰¹æ®Šå­—ç¬¦
            // sample_name = sample_name.replace(/[\/\\]/g, "_");
            // æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ä»¥æ›¿æ¢æ‰€æœ‰éæ³•å­—ç¬¦
            sample_name = sample_name.replace(/[\/\\:*?"<>|\t]/g, "_");

            // var planfinish_time = $('#planfinish_time').val();
            var scheduleStartTime = $('#scheduleStartTime').val();
            var scheduleEndTime = $('#scheduleEndTime').val();
            var scheduleTestCycle = $('#scheduleTestCycle').val();

            $.ajax({
                url: '/home/queryExist',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    filepath: selectedFilePath,
                    model: model,
                    coding: coding,
                    category: category,
                    version: version,
                    sample_name: sample_name,
                    // planfinish_time: planfinish_time,
                    sample_frequency : sample_frequency,
                    sample_quantity : sample_quantity,
                    big_species: big_species,
                    small_species: small_species,
                    high_frequency: high_frequency,
                    questStats: questStats,
                    username: username,
                    scheduleStartTime: scheduleStartTime,
                    scheduleEndTime: scheduleEndTime,
                    scheduleTestCycle: scheduleTestCycle,
                    electric_sample_id: electric_sample_id

                }),
                success: function (filepaths) {
                    // åˆ¤æ–­æ˜¯å¦æœ‰é”™è¯¯æç¤º
                    if (filepaths.length === 1 && filepaths[0].includes("æ‰¾ä¸åˆ°è¿™ä¸ªç”µæ°”ç¼–å·")) {
                        alert(filepaths[0]); // æˆ–ä½¿ç”¨ä½ è‡ªå·±çš„å¼¹çª—ç»„ä»¶æ˜¾ç¤ºé”™è¯¯
                        return; // åœæ­¢åç»­é€»è¾‘
                    }

                    let high_sign = "";
                    if(high_frequency === "æ˜¯"){
                        high_sign = "é«˜é¢‘_";
                    }

                    const newFileName = savepath.replace(/\//g, "\\") + "\\" + model + " " + coding + "_" + category + "_" + version + "_ç¬¬" +sample_frequency +"æ¬¡é€æ ·_" + high_sign + questStats + "_" +sample_name + ".xlsx";

                    if (filepaths.length > 0){
                        if(filepaths.length === 1 ){
                            if(filepaths[0] === "å·²ç»å­˜åœ¨è¿™ä¸ªå‹å·ç‰ˆæœ¬ç±»åˆ«çš„æµ‹è¯•æŠ¥å‘Šäº†ï¼Œä¸èƒ½å†åˆ›å»ºï¼") {
                                alert(filepaths[0]);
                            }else if(filepaths[0] === newFileName){
                                localStorage.removeItem(`DQE_`);
                                localStorage.removeItem(`Developer_`);
                                localStorage.removeItem(`supplier_`);

                                localStorage.setItem(`model_` ,model);
                                localStorage.setItem(`coding_` ,coding);
                                localStorage.setItem(`sample_name_` ,sample_name);
                                localStorage.setItem(`tester_` ,username);

                                // æ³¨é‡Šæ‰è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢çš„ä»£ç ï¼Œæ”¹ä¸ºåˆ·æ–°å½“å‰é¡µé¢
                                // window.location.href = '/excelShow?filePath=' + encodeURIComponent(filepaths[0]);
                                // let redirectUrl = '/excelShow?filePath=' + encodeURIComponent(filepaths[0]);
                                // if (redirectUrl.indexOf('?') !== -1) {
                                //     redirectUrl += '&dd_orientation=landscape';
                                // } else {
                                //     redirectUrl += '?dd_orientation=landscape';
                                // }
                                // window.location.href = redirectUrl;
                                
                                // åˆ›å»ºæŠ¥å‘ŠæˆåŠŸååˆ·æ–°å½“å‰é¡µé¢
                                alert('æŠ¥å‘Šåˆ›å»ºæˆåŠŸï¼');
                                window.location.reload();
                            }else{
                                // addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,planfinish_time,sample_frequency,sample_quantity,big_species,small_species,high_frequency,questStats);
                                addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,sample_frequency,sample_quantity,big_species,small_species,high_frequency,questStats,scheduleStartTime,scheduleEndTime,scheduleTestCycle,
                                    electric_sample_id);
                            }
                        }else{
                            addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,sample_frequency,sample_quantity,big_species,small_species,high_frequency,questStats,scheduleStartTime,scheduleEndTime,scheduleTestCycle,
                                electric_sample_id);
                        }
                    }

                    // window.location.href = '/loginExcelShow?filePath=' + encodeURIComponent(copiedFilePath);
                },
                error: function (xhr, status, error) {
                    console.error('Failed to copy file:', status, error);
                }
            });
        });

    });


    function addexistModal(filepaths,selectedFilePath,model,coding,category,version,sample_name,sample_frequencyStr,sample_quantityStr,big_species,small_species,high_frequency,questStats,scheduleStartTime,scheduleEndTime,scheduleTestCycle,
                           electric_sample_id){
        var existModalContent = document.querySelector('.existModal-content');
        existModalContent.innerHTML = '<span class="close">&times;</span><h2>å·²å­˜åœ¨å…¶ä»–ç‰ˆæœ¬çš„æ–‡ä»¶ï¼Œè¯·æ‚¨é€‰æ‹©ä½¿ç”¨å“ªä»½æ–‡ä»¶ä½œä¸ºæ¨¡æ¿ä½¿ç”¨:</h2>';
        var existModal = document.getElementById("existModal");
        var existSpan = existModal.getElementsByClassName("close")[0];
        existSpan.onclick = function () {
            existModal.style.display = "none";
        }

        // æ·»åŠ selectedFilePathé“¾æ¥
        var originalFileLink = document.createElement('a');
        originalFileLink.href = 'javascript:void(0);';
        originalFileLink.onclick = function() {
            localStorage.removeItem(`DQE_`);
            localStorage.removeItem(`Developer_`);
            localStorage.removeItem(`supplier_`);

            localStorage.setItem(`model_` ,model);
            localStorage.setItem(`coding_` ,coding);
            localStorage.setItem(`sample_name_` ,sample_name);
            localStorage.setItem(`tester_` ,username);

            // ç›´æ¥è°ƒç”¨å¤åˆ¶æ–‡ä»¶æ¥å£ï¼Œä¸è·³è½¬åˆ°ExcelShow
            $.ajax({
                url: '/copyClickFile',
                type: 'POST',
                data: {
                    filePath: selectedFilePath,
                    model: model,
                    coding: coding,
                    category: category,
                    version: version,
                    sample_name: sample_name,
                    username: username,
                    sample_frequencyStr: sample_frequencyStr,
                    sample_quantityStr: sample_quantityStr,
                    big_species: big_species,
                    small_species: small_species,
                    high_frequency: high_frequency,
                    questStats: questStats,
                    scheduleStartTime: scheduleStartTime,
                    scheduleEndTime: scheduleEndTime,
                    scheduleTestCycle: scheduleTestCycle,
                    electric_sample_id: electric_sample_id
                },
                success: function(response) {
                    if (response.status === 'success') {
                        // å…³é—­æ¨¡æ€æ¡†
                        existModal.style.display = "none";
                        alert('æŠ¥å‘Šåˆ›å»ºæˆåŠŸï¼');
                        window.location.reload();
                    } else {
                        alert('æ–‡ä»¶å¤åˆ¶å¤±è´¥: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('å¤åˆ¶æ–‡ä»¶å¤±è´¥:', status, error);
                    alert('æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            });
        };
        originalFileLink.textContent = selectedFilePath;
        originalFileLink.style.fontWeight = 'bold'; // åŠ ç²—
        existModalContent.appendChild(originalFileLink);
        existModalContent.appendChild(document.createElement('br'));


        filepaths.forEach(function (selectedFilePath) {
            var fileLink = document.createElement('a');
            fileLink.href = 'javascript:void(0);';
            fileLink.onclick = function() {
                localStorage.removeItem(`DQE_`);
                localStorage.removeItem(`Developer_`);
                localStorage.removeItem(`supplier_`);

                localStorage.setItem(`model_` ,model);
                localStorage.setItem(`coding_` ,coding);
                localStorage.setItem(`sample_name_` ,sample_name);
                localStorage.setItem(`tester_` ,username);

                // ç›´æ¥è°ƒç”¨å¤åˆ¶æ–‡ä»¶æ¥å£ï¼Œä¸è·³è½¬åˆ°ExcelShow
                $.ajax({
                    url: '/copyClickFile',
                    type: 'POST',
                    data: {
                        filePath: selectedFilePath,
                        model: model,
                        coding: coding,
                        category: category,
                        version: version,
                        sample_name: sample_name,
                        username: username,
                        sample_frequencyStr: sample_frequencyStr,
                        sample_quantityStr: sample_quantityStr,
                        big_species: big_species,
                        small_species: small_species,
                        high_frequency: high_frequency,
                        questStats: questStats,
                        scheduleStartTime: scheduleStartTime,
                        scheduleEndTime: scheduleEndTime,
                        scheduleTestCycle: scheduleTestCycle,
                        electric_sample_id: electric_sample_id
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            // å…³é—­æ¨¡æ€æ¡†
                            existModal.style.display = "none";
                            alert('æŠ¥å‘Šåˆ›å»ºæˆåŠŸï¼');
                            window.location.reload();
                        } else {
                            alert('æ–‡ä»¶å¤åˆ¶å¤±è´¥: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('å¤åˆ¶æ–‡ä»¶å¤±è´¥:', status, error);
                        alert('æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    }
                });
            };
            fileLink.textContent = selectedFilePath;
            existModalContent.appendChild(fileLink);
            existModalContent.appendChild(document.createElement('br'));
        });

        existModal.style.display = "block";
    }

    // åˆ›å»ºå¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†çš„å‡½æ•°
    function showEditModal(product) {
        // åˆ›å»ºæ¨¡æ€æ¡† HTML
        const modalHTML = `
                <div id="editModal" class="inputModal">
                    <div class="editinputModal-content">
                        <span class="close">&times;</span>
                        <div class="edith2-container">
                            <h2>ä¿®æ”¹äº§å“ä¿¡æ¯</h2>
                            <div class="button-group">
                                <!-- é—®é¢˜ç‚¹ç¡®è®¤çŠ¶æ€å¤é€‰æ¡† -->
                                <div class="confirm-checkbox-container">
                                    <label for="passbackConfirmCheckbox" class="confirm-checkbox-label">
                                        <input type="checkbox" id="passbackConfirmCheckbox" name="passbackConfirm">
                                        å·²å›ä¼ é—®é¢˜ç‚¹
                                    </label>
                                </div>
                                <button type="button" id="passbackProblemBtn">å›ä¼ <br>é—®é¢˜ç‚¹é¡µé¢</button>
                                <button type="button" id="copyLinkBtn">å¤åˆ¶<br>é“¾æ¥</button>
                                <button type="button" id="viewTestItemsBtn">æŸ¥çœ‹<br>æµ‹è¯•é¡¹</button>
                                <button type="button" id="viewDataBtn">æŸ¥çœ‹<br>èµ„æ–™</button>
                                <button type="button" id="viewProblemBtn">æŸ¥çœ‹<br>é—®é¢˜ç‚¹</button>
                                 <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                                <input type="file" id="fileInput" accept=".xlsx" style="display:none;" />
                                <button type="button" id="replaceButton">æ›¿æ¢<br>æŠ¥å‘Š</button>
                                <!-- <button type="button" id="jumpButton">è¿›å…¥<br>æŠ¥å‘Š</button> -->
                            </div>
                        </div>
                        <form id="fileEditForm">
                        <label for="edit_sample_id">æ ·å“id:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_sample_id" name="edit_sample_id" required readonly style="background-color: #e87676;">

                            <label for="edit_model">å¤§ç¼–ç :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_model" name="edit_model" required readonly style="background-color: #e87676;">
                            <label for="edit_coding">å°ç¼–ç :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_coding" name="edit_coding" required readonly style="background-color: #e87676;">
                            <label for="edit_category">ç±»åˆ«:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_category" name="edit_category" required readonly style="background-color: #e87676;">

                            <label for="edit_questStats">ä»»åŠ¡å±æ€§:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_questStats" name="edit_questStats" required readonly style="background-color: #e87676;">

                            <label for="edit_big_species">å¤§ç±»:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_big_species" name="edit_big_species" required readonly style="background-color: #e87676;">
                            <label for="edit_small_species">å“ç±»ç»†åˆ†:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_small_species" name="edit_small_species" required readonly style="background-color: #e87676;">
                            <label for="edit_high_frequency">æ˜¯å¦é«˜é¢‘:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_high_frequency" name="edit_high_frequency" required readonly style="background-color: #e87676;">

                            <label for="edit_version">ç‰ˆæœ¬:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_version" name="edit_version" required readonly style="background-color: #e87676;">
                            <label for="edit_sample_frequency">é€æ ·æ¬¡æ•°:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_sample_frequency" name="edit_sample_frequency" required readonly style="background-color: #e87676;">
                            <label for="edit_sample_quantity">é€æ ·æ•°é‡:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_sample_quantity" name="edit_sample_quantity" required readonly style="background-color: #e87676;">

                            <label for="edit_scheduleStartTime">æ’æœŸå¼€å§‹æ—¶é—´:</label>
                            <input type="datetime-local" id="edit_scheduleStartTime" name="edit_scheduleStartTime" required readonly style="background-color: #e87676;">
                            <label for="edit_scheduleEndTime">æ’æœŸç»“æŸæ—¶é—´:</label>
                            <input type="datetime-local" id="edit_scheduleEndTime" name="edit_scheduleEndTime" required readonly style="background-color: #e87676;">
                            <label for="edit_scheduleTestCycle">æ’æœŸæµ‹è¯•å‘¨æœŸ:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_scheduleTestCycle" name="edit_scheduleTestCycle" required readonly style="background-color: #e87676;">

                            <label for="edit_sample_name">äº§å“åç§°:</label>
                            <input type="text" id="edit_sample_name" name="edit_sample_name" required placeholder="å¿…å¡«é¡¹"><span style="color: red;">*</span><br>
<!--                            <label for="edit_planfinish_time">é¢„è®¡å®Œæˆæ—¶é—´:</label>-->
<!--                            <input type="datetime-local" id="edit_planfinish_time" name="edit_planfinish_time" required><span style="color: red;">*</span><br>-->
                            <label for="edit_chip_control">ä¸»æ§èŠ¯ç‰‡:</label>
                            <input type="text" id="edit_chip_control" name="edit_chip_control" ><span style="color: red;">*</span><br>
                            <label for="edit_version_software">è½¯ä»¶ç‰ˆæœ¬:</label>
                            <input type="text" id="edit_version_software" name="edit_version_software" ><span style="color: red;">*</span><br>
                            <label for="edit_version_hardware">ç¡¬ä»¶ç‰ˆæœ¬:</label>
                            <input type="text" id="edit_version_hardware" name="edit_version_hardware" ><span style="color: red;">*</span><br>
                            <label for="edit_supplier">ä¾›åº”å•†:</label>
                            <input type="text" id="edit_supplier" name="edit_supplier" ><span style="color: red;">*</span><br>
                            <label for="edit_test_Overseas">å›½å†…å¤–æµ‹è¯•é€‰é¡¹:</label>
                            <select id="edit_test_Overseas" name="edit_test_Overseas" required >
                                <option value="" selected>å¿…å¡«é¡¹</option>
                                <option value="å›½å†…">å›½å†…</option>
                                <option value="å›½å¤–">å›½å¤–</option>
                                <option value="å›½å†…+å›½å¤–">å›½å†…+å›½å¤–</option>
                            </select><span style="color: red;">*</span>

                            <label for="edit_priority">ä¼˜å…ˆçº§:</label>
                            <select id="edit_priority" name="edit_priority" required >
                                <option value="" selected>å¿…å¡«é¡¹</option>
                                <option value="åŠ æ€¥">åŠ æ€¥</option>
                                <option value="ä¼˜å…ˆ">ä¼˜å…ˆ</option>
                                <option value="åŒæ­¥">åŒæ­¥</option>
                                 <option value="æ™®é€š">æ™®é€š</option>
                            </select><span style="color: red;">*</span>

                            <label for="edit_sample_remark">å¤‡æ³¨:</label>
                            <input type="text" id="edit_sample_remark" name="edit_sample_remark" ><br>

                            <label for="edit_sample_DQE">DQE:</label>
                            <input type="text" id="edit_sample_DQE" name="edit_sample_DQE" ><span style="color: red;">*</span><br>
                            <label for="edit_sample_Developer">ç”µå­å·¥ç¨‹å¸ˆ:</label>
                            <input type="text" id="edit_sample_Developer" name="edit_sample_Developer" ><span style="color: red;">*</span><br>

                            <label for="edit_sample_leader">é¡¹ç›®è´Ÿè´£äºº:</label>
                            <input type="text" id="edit_sample_leader" name="edit_sample_leader" ><span style="color: red;">*</span><br>

                            <label for="tester">å½“å‰æµ‹è¯•è€…:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <select id="tester" name="tester" >
                                <option value="" disabled>å¦‚éœ€æ›´æ¢æµ‹è¯•è€…é€‰æ‹©æ­¤é¡¹</option>
                                <option value="å¢ç»®æ•">å¢ç»®æ•</option>
                                <option value="æ˜“æ¹„æ´">æ˜“æ¹„æ´</option>
                                <option value="å¤ç¥">å¤ç¥</option>
                                <option value="ç¼ªå®‡æ¬¢">ç¼ªå®‡æ¬¢</option>
                                <option value="èƒ¡é“­">èƒ¡é“­</option>
                                <option value="åŠ³é’°é›¯">åŠ³é’°é›¯</option>
                                <option value="ç¿Ÿä¸–é¸¿">ç¿Ÿä¸–é¸¿</option>
                                <option value="éª†ä¹¦è‹±">éª†ä¹¦è‹±</option>
                                <option value="æ¢ç§‹å®‡">æ¢ç§‹å®‡</option>
                                <option value="é»„æ¢">é»„æ¢</option>
                                <option value="å¼ å¥æ¦†">å¼ å¥æ¦†</option>
                                <option value="å¢å¥">å¢å¥</option>
                                <option value="é™ˆåŸ¹æ ¹">é™ˆåŸ¹æ ¹</option>
                                <option value="å†¯å…´æ—º">å†¯å…´æ—º</option>
                                <option value="éƒ­å–†">éƒ­å–†</option>
                                <option value="æ¸¸å®">æ¸¸å®</option>
<!--                                <option value="æ®·å˜‰ä¿Š">æ®·å˜‰ä¿Š</option>-->
                                <option value="å”æ—¥é¡º">å”æ—¥é¡º</option>
                                <option value="å®˜æ—ºå">å®˜æ—ºå</option>
                                <option value="åˆ˜é¹é£">åˆ˜é¹é£</option>
                                <option value="èµµæ¢“å®‡">èµµæ¢“å®‡</option>
                                <option value="æ®µå¹³">æ®µå¹³</option>
                                <option value="é­æ°‘">é­æ°‘</option>
                                <option value="ç¨‹å¥•é˜³">ç¨‹å¥•é˜³</option>
<!--                                <option value="é»„åš">é»„åš</option>-->
                                <option value="èµµçˆ½">èµµçˆ½</option>
                                <option value="ç½—æ¸…è™">ç½—æ¸…è™</option>
                                <option value="é¾™è¿">é¾™è¿</option>
                                <option value="é»„å…°å§£">é»„å…°å§£</option>
                                <option value="ææ™ºé¾™">ææ™ºé¾™</option>
                                <option value="è‚–ç¶ç‚œ">è‚–ç¶ç‚œ</option>
                                <option value="è‚–é¾™ç”Ÿ">è‚–é¾™ç”Ÿ</option>
                                <option value="å¼ å›½é¹">å¼ å›½é¹</option>
<!--                                <option value="é™ˆæ˜±è²">é™ˆæ˜±è²</option>-->
                                <option value="æˆ´æå">æˆ´æå</option>
                                <option value="æç´ æ¬£1">æç´ æ¬£1</option>
                                <option value="å¼ é”">å¼ é”</option>
                                <option value="é˜®æ™“æ™´">é˜®æ™“æ™´</option>
<!--                                <option value="è“æ˜åŸ">è“æ˜åŸ</option>-->
                                <option value="å»–å»ºä¼Ÿ">å»–å»ºä¼Ÿ</option>
                                <option value="è”¡ä¹‰ä¼š">è”¡ä¹‰ä¼š</option>
                                <option value="å«äºšå¥‡">å«äºšå¥‡</option>
                                <option value="æç„•å³°">æç„•å³°</option>
                                <option value="å‘¨é‡‘æ—º">å‘¨é‡‘æ—º</option>
                                <option value="é™ˆç‚³æ¡¦">é™ˆç‚³æ¡¦</option>
                                <option value="å¤ä¸½ä¸½">å¤ä¸½ä¸½</option>
                                <option value="æ±ªç§‘ä¸š">æ±ªç§‘ä¸š</option>

                            </select>
                            <label for="edit_cc_recipients">æŠ„é€è€…:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" id="edit_cc_recipients" name="edit_cc_recipients" placeholder="è¯·è¾“å…¥æŠ„é€è€…å§“åï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå¼ ä¸‰,æå››">
                            <span style="color: #999; margin-left: 2px;">(éå¿…å¡«)</span><br>

                            <label for="edit_electric_id">ITæå•ç³»ç»Ÿæµ‹è¯•ç¼–å·:</label>
                            <input type="text" id="edit_electric_id" name="edit_electric_id"
                                   placeholder="å¦‚æœ‰ï¼Œè¯·åœ¨ITç³»ç»Ÿå¯»æ‰¾åˆ°å¯¹åº”ç”µæ°”ç¼–å·ï¼Œä¾‹å¦‚ET2505260009">
                            <span style="color: #999; margin-left: 2px;">(éå¿…å¡«)</span><br>

                            <button type="submit">ä¿å­˜ä¿¡æ¯</button>
                        </form>
                    </div>
                </div>`;

        // å°†æ¨¡æ€æ¡†æ·»åŠ åˆ°é¡µé¢ä¸»ä½“ä¸­
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        document.getElementById('edit_sample_id').value = product.sample_id;
        // ä½¿ç”¨äº§å“æ•°æ®å¡«å……æ¨¡æ€æ¡†
        document.getElementById('edit_model').value = product.sample_model;
        document.getElementById('edit_coding').value = product.sample_coding;
        document.getElementById('edit_category').value = product.sample_category;

        document.getElementById('edit_questStats').value = product.questStats;
        document.getElementById('edit_version').value = product.version;
        document.getElementById('edit_sample_frequency').value = product.sample_frequency;
        document.getElementById('edit_sample_quantity').value = product.sample_quantity;

        document.getElementById('edit_big_species').value = product.big_species;
        document.getElementById('edit_small_species').value = product.small_species;
        document.getElementById('edit_high_frequency').value = product.high_frequency;

        document.getElementById('edit_sample_name').value = product.sample_name;
        document.getElementById('edit_chip_control').value = product.chip_control;
        document.getElementById('edit_version_software').value = product.version_software;
        document.getElementById('edit_version_hardware').value = product.version_hardware;
        document.getElementById('edit_supplier').value = product.supplier;
        document.getElementById('edit_test_Overseas').value = product.test_Overseas;
        document.getElementById('edit_priority').value = product.priority;
        document.getElementById('edit_sample_remark').value = product.sample_remark;
        document.getElementById('edit_sample_DQE').value = product.sample_DQE;
        document.getElementById('edit_sample_Developer').value = product.sample_Developer;
        document.getElementById('edit_sample_leader').value = product.sample_leader;
        document.getElementById('tester').value = product.tester;
        document.getElementById('edit_electric_id').value = product.electric_sample_id;
        document.getElementById('edit_cc_recipients').value = product.cc_recipients || '';

        // è®¾ç½®é—®é¢˜ç‚¹ç¡®è®¤çŠ¶æ€å¤é€‰æ¡†çš„åˆå§‹å€¼
        console.log('productå¯¹è±¡:', product); // è°ƒè¯•ä¿¡æ¯
        console.log('passbackConfirmå€¼:', product.passbackConfirm); // è°ƒè¯•ä¿¡æ¯
        
        // å»¶è¿Ÿè®¾ç½®å¤é€‰æ¡†å€¼ï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            const checkbox = document.getElementById('passbackConfirmCheckbox');
            if (checkbox) {
                console.log('æ‰¾åˆ°å¤é€‰æ¡†å…ƒç´ ï¼ŒID:', checkbox.id); // è°ƒè¯•ä¿¡æ¯
                
                // ä¼˜å…ˆä½¿ç”¨ localStorage ä¸­ä¿å­˜çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ product.passbackConfirm
                const storageKey = `passbackConfirm_${product.sample_id}`;
                const savedStatus = localStorage.getItem(storageKey);
                let isChecked = false;
                
                if (savedStatus) {
                    // å¦‚æœæœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œä½¿ç”¨ä¿å­˜çš„çŠ¶æ€
                    isChecked = savedStatus === 'å·²å›ä¼ ';
                    console.log('ä½¿ç”¨ localStorage ä¸­ä¿å­˜çš„çŠ¶æ€:', savedStatus, 'å¤é€‰æ¡†è®¾ç½®ä¸º:', isChecked);
                } else if (product.passbackConfirm !== undefined && product.passbackConfirm !== null) {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œä½¿ç”¨ product.passbackConfirm
                    isChecked = product.passbackConfirm === 'å·²å›ä¼ ';
                    console.log('ä½¿ç”¨ product.passbackConfirm çš„å€¼:', product.passbackConfirm, 'å¤é€‰æ¡†è®¾ç½®ä¸º:', isChecked);
                } else {
                    // é»˜è®¤å€¼
                    isChecked = false;
                    console.log('ä½¿ç”¨é»˜è®¤å€¼ï¼Œå¤é€‰æ¡†è®¾ç½®ä¸º:', isChecked);
                }
                // AccessLogUtil.record("å›ä¼ é—®é¢˜ç‚¹æŒ‰é’®");
                
                // ä½¿ç”¨å¤šç§æ–¹å¼è®¾ç½®å¤é€‰æ¡†
                checkbox.checked = isChecked;
                checkbox.setAttribute('checked', isChecked);
                
                // å¼ºåˆ¶è§¦å‘changeäº‹ä»¶
                if (isChecked) {
                    checkbox.setAttribute('checked', 'checked');
                } else {
                    checkbox.removeAttribute('checked');
                }
                
                console.log('å¤é€‰æ¡†æœ€ç»ˆè®¾ç½®ä¸º:', isChecked); // è°ƒè¯•ä¿¡æ¯
                console.log('å¤é€‰æ¡†checkedå±æ€§:', checkbox.checked); // è°ƒè¯•ä¿¡æ¯
                console.log('å¤é€‰æ¡†checkedå±æ€§ï¼ˆgetAttributeï¼‰:', checkbox.getAttribute('checked')); // è°ƒè¯•ä¿¡æ¯
            } else {
                console.error('æœªæ‰¾åˆ°å¤é€‰æ¡†å…ƒç´ ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®'); // è°ƒè¯•ä¿¡æ¯
            }
        }, 200); // å¢åŠ å»¶è¿Ÿæ—¶é—´

                // ä¸ºå¤é€‰æ¡†æ·»åŠ changeäº‹ä»¶ç›‘å¬å™¨ï¼Œå½“çŠ¶æ€æ”¹å˜æ—¶è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
        document.getElementById('passbackConfirmCheckbox').addEventListener('change', function() {
            const isChecked = this.checked;
            const sample_id = $('#edit_sample_id').val();

            // ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
            updatePassbackConfirmInDatabase(sample_id, isChecked, product);
            AccessLogUtil.record("å·²å›ä¼ é—®é¢˜ç‚¹æŒ‰é’®");
         
        });

        document.getElementById('edit_sample_name').addEventListener('input', function(e) {
            // this.value = this.value.replace(/[\\\/]/g, '_');
            // this.value = this.value.replace(/[\\\/:*?"<>|]/g, '_');
            // æ¸…ç† sample_nameï¼Œæ›¿æ¢æ‰€æœ‰ Windows æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
            this.value = this.value.replace(/[\/\\:*?"<>|\t]/g, "_");
        });

        // å› ä¸ºæ‰‹æœºç«¯éœ€è¦æœ‰"T"æ‰å¯ä»¥åœ¨å‰ç«¯å±•ç¤ºè¿™ä¸ªæ•°æ®ï¼Œä¸ç„¶ä¼šæ˜¾ç¤ºç©º
        // const formattedPlanFinishTime = product.planfinish_time.replace(' ', 'T');
        // document.getElementById('edit_planfinish_time').value = formattedPlanFinishTime;
        // æ£€æŸ¥å¹¶æ›´æ–° scheduleStartTime
        if (product.scheduleStartTime) {
            const formattedScheduleStartTime = product.scheduleStartTime.replace(' ', 'T');
            const startTimeElement = document.getElementById('edit_scheduleStartTime');
            if (startTimeElement) {
                startTimeElement.value = formattedScheduleStartTime;
            }
        }

        // æ£€æŸ¥å¹¶æ›´æ–° scheduleEndTime
        if (product.scheduleEndTime) {
            const formattedScheduleEndTime = product.scheduleEndTime.replace(' ', 'T');
            const endTimeElement = document.getElementById('edit_scheduleEndTime');
            if (endTimeElement) {
                endTimeElement.value = formattedScheduleEndTime;
            }
        }

        // æ£€æŸ¥å¹¶æ›´æ–° scheduleTestCycle
        if (product.scheduleTestCycle) {
            const testCycleElement = document.getElementById('edit_scheduleTestCycle');
            if (testCycleElement) {
                testCycleElement.value = product.scheduleTestCycle;
            }
        }


        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('editModal').style.display = 'block';

        // æ·»åŠ ESCé”®äº‹ä»¶ç›‘å¬å™¨
        const handleEscapeKey = (event) => {
            if (event.key === 'Escape') {
                const editModal = document.getElementById('editModal');
                if (editModal && editModal.style.display === 'block') {
                    editModal.style.display = 'none';
                    editModal.remove();
                    // å…³é—­ä¿®æ”¹äº§å“ä¿¡æ¯æ¨¡æ€æ¡†æ—¶è§¦å‘æœç´¢æ–¹æ³•åˆ·æ–°åˆ—è¡¨
                    performSearch();
                }
            }
        };
        document.addEventListener('keydown', handleEscapeKey);

        // ç‚¹å‡»å…³é—­æŒ‰é’®æ—¶å…³é—­æ¨¡æ€æ¡†
        document.querySelector('#editModal .close').onclick = function() {
            // åœ¨å…³é—­æ¨¡æ€æ¡†å‰ï¼Œå°†æ›´æ–°åçš„çŠ¶æ€åŒæ­¥åˆ°é¡µé¢çš„æ•°æ®ä¸­
            const checkbox = document.getElementById('passbackConfirmCheckbox');
            if (checkbox) {
                const sample_id = $('#edit_sample_id').val();
                const storageKey = `passbackConfirm_${sample_id}`;
                const currentStatus = localStorage.getItem(storageKey);
                
                if (currentStatus) {
                    // æ›´æ–° product å¯¹è±¡ä¸­çš„ passbackConfirm å€¼
                    product.passbackConfirm = currentStatus;
                    console.log('æ¨¡æ€æ¡†å…³é—­æ—¶ï¼Œå·²åŒæ­¥ product.passbackConfirm ä¸º:', currentStatus);
                }
            }
            
            // ç§»é™¤ESCé”®äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('keydown', handleEscapeKey);
            
            document.getElementById('editModal').remove();
            //ä¿å­˜ä¹‹åä¼šæ›´æ–°æ•°æ®åº“ï¼Œæ­¤æ—¶éœ€è¦é‡æ–°ä»åç«¯è·å–åˆ°æ–°çš„æ•°æ®æ‰å‡†ï¼Œæ‰€ä»¥éœ€è¦å†èµ°ä¸€éè·å–æ•°æ®çš„æ–¹æ³•
            // window.location.href = '/testManIndex';
            performSearch();
        };


        // æ›¿æ¢æŠ¥å‘ŠæŒ‰é’®
        document.querySelector('#replaceButton').onclick = function() {
            // è·å–éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
            const fileInput = document.querySelector('#fileInput');

            // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            fileInput.click();

            // å½“ç”¨æˆ·é€‰æ‹©æ–‡ä»¶æ—¶è§¦å‘
            fileInput.onchange = function() {
                const file = fileInput.files[0];
                if (!file) {
                    alert("è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œæ›¿æ¢ï¼");
                    return;
                }

                // éªŒè¯æ–‡ä»¶ç±»å‹æ˜¯å¦ä¸º .xlsx
                const fileType = file.name.split('.').pop().toLowerCase();
                if (fileType !== 'xlsx') {
                    alert("è¯·ä¸Šä¼ ä¸€ä¸ª .xlsx æ ¼å¼çš„æ–‡ä»¶ï¼");
                    return;
                }

                const fileSizeInMB = (file.size / (1024 * 1024)).toFixed(2); // å°†æ–‡ä»¶å¤§å°è½¬æ¢ä¸ºMBå¹¶ä¿ç•™ä¸¤ä½å°æ•°

                var sample_id = $('#edit_sample_id').val();

                // var model = $('#edit_model').val();
                // var coding = $('#edit_coding').val();
                // var category = $('#edit_category').val();
                // var version = $('#edit_version').val();
                // var big_species = $('#edit_big_species').val();
                // var small_species = $('#edit_small_species').val();
                // var high_frequency = $('#edit_high_frequency').val();
                // var questStats = $('#edit_questStats').val();
                // var sample_frequency = $('#edit_sample_frequency').val();

                $.ajax({
                    url: '/testManIndex/getjumpFilepath',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        sample_id: sample_id
                    }),
                    success: function(jumpfilepath){
                        // ä½¿ç”¨è·å–åˆ°çš„æ–‡ä»¶è·¯å¾„æ›¿æ¢æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
                        var formData = new FormData();
                        formData.append('file', file);
                        formData.append('filepath', jumpfilepath);

                        // æ˜¾ç¤ºè¿›åº¦æ¡
                        const progressContainer = document.getElementById('uploadProgress');
                        const progressBar = document.getElementById('uploadProgressBar');
                        const progressText = progressContainer.querySelector('.progress-text');
                        
                        progressContainer.style.display = 'block';
                        progressBar.style.width = '0%';
                        if (progressText) {
                            progressText.textContent = `æ–‡ä»¶å¤§å°: ${fileSizeInMB} MB - å‡†å¤‡ä¸Šä¼ ...`;
                        }

                        // ä½¿ç”¨XMLHttpRequestæ¥ç›‘å¬ä¸Šä¼ è¿›åº¦
                        const xhr = new XMLHttpRequest();

                        // ç›‘å¬ä¸Šä¼ è¿›åº¦
                        xhr.upload.addEventListener('progress', function(e) {
                            if (e.lengthComputable) {
                                const percentComplete = (e.loaded / e.total) * 100;
                                progressBar.style.width = percentComplete + '%';
                                const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                                const totalMB = (e.total / (1024 * 1024)).toFixed(2);
                                if (progressText) {
                                    progressText.textContent = `æ–‡ä»¶å¤§å°: ${fileSizeInMB} MB - ä¸Šä¼ è¿›åº¦: ${percentComplete.toFixed(1)}% (${loadedMB} MB / ${totalMB} MB)`;
                                }
                            }
                        }, false);

                        // ç›‘å¬è¯·æ±‚å®Œæˆ
                        xhr.addEventListener('load', async function() {
                            if (xhr.status === 200) {
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    progressBar.style.width = '100%';
                                    if (progressText) {
                                        progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼Œæ­£åœ¨å¤„ç†...';
                                    }
                                    
                                    await clearStorage(response);
                                    // å»¶è¿Ÿä¸€ä¸‹å†éšè—è¿›åº¦æ¡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°100%
                                    setTimeout(() => {
                                        progressContainer.style.display = 'none';
                                        progressBar.style.width = '0%';
                                    }, 500);
                                    
                                    alert(response.message || "æ–‡ä»¶æ›¿æ¢æˆåŠŸ");
                                } catch (e) {
                                    progressContainer.style.display = 'none';
                                    alert("æ–‡ä»¶æ›¿æ¢æˆåŠŸ");
                                }
                            } else {
                                progressContainer.style.display = 'none';
                                progressBar.style.width = '0%';
                                alert("æ–‡ä»¶æ›¿æ¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
                            }
                        }, false);

                        // ç›‘å¬é”™è¯¯
                        xhr.addEventListener('error', function() {
                            progressContainer.style.display = 'none';
                            progressBar.style.width = '0%';
                            alert("æ–‡ä»¶æ›¿æ¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
                        }, false);

                        // ç›‘å¬å–æ¶ˆ
                        xhr.addEventListener('abort', function() {
                            progressContainer.style.display = 'none';
                            progressBar.style.width = '0%';
                            if (progressText) {
                                progressText.textContent = '';
                            }
                        }, false);

                        // å‘é€è¯·æ±‚
                        xhr.open('POST', '/testManIndex/replaceFilepath');
                        xhr.send(formData);
                    },
                    error: function(xhr, status, error){
                        alert("æ›¿æ¢æ–‡ä»¶å¤±è´¥,è·å–ä¸åˆ°æ–‡ä»¶è·¯å¾„!");
                    },
                });

            };
        };


        // æ³¨é‡Šæ‰"è¿›å…¥æŠ¥å‘Š"æŒ‰é’®åŠŸèƒ½ - æš‚æ—¶ä¸ä½¿ç”¨
        /*
        document.querySelector('#jumpButton').onclick = function() {
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('loadingModal').style.display = 'block';

            let countdownElement = document.getElementById('countdown');
            let countdownTime = 5;
            let countdownInterval;

            // æ›´æ–°å€’æ•°è®¡æ—¶
            function updateCountdown() {
                countdownTime--;
                countdownElement.innerText = countdownTime;
                if (countdownTime <= 0) {
                    clearInterval(countdownInterval);
                    proceedWithRequest();
                }
            }

            // å¯åŠ¨å€’æ•°è®¡æ—¶
            countdownInterval = setInterval(updateCountdown, 1000);

            // å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('cancelButton').onclick = function() {
                // æ¸…é™¤å€’æ•°è®¡æ—¶
                clearInterval(countdownInterval);
                countdownElement.innerText = 5;
                // éšè—æ¨¡æ€æ¡†
                document.getElementById('loadingModal').style.display = 'none';
            };

            // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('closeModal').onclick = function() {
                // æ¸…é™¤å€’æ•°è®¡æ—¶
                clearInterval(countdownInterval);
                countdownElement.innerText = 5;
                // éšè—æ¨¡æ€æ¡†
                document.getElementById('loadingModal').style.display = 'none';
            };

            // æ‰§è¡Œå®é™…çš„Ajaxè¯·æ±‚
            function proceedWithRequest() {
                // 20241226æ”¹æˆé€šè¿‡idå»è·³è½¬æ–‡ä»¶åœ°å€
                var sample_id = $('#edit_sample_id').val();

                var model = $('#edit_model').val();
                var coding = $('#edit_coding').val();
                // var category = $('#edit_category').val();
                // var version = $('#edit_version').val();
                // var big_species = $('#edit_big_species').val();
                // var small_species = $('#edit_small_species').val();
                // var high_frequency = $('#edit_high_frequency').val();
                // var questStats = $('#edit_questStats').val();
                // var sample_frequency = $('#edit_sample_frequency').val();
                var sample_name = $('#edit_sample_name').val();
                var supplier = $('#edit_supplier').val();

                var sample_DQE = $('#edit_sample_DQE').val();
                var sample_Developer = $('#edit_sample_Developer').val();
                var tester = $('#tester').val();

                $.ajax({
                    url: '/testManIndex/getjumpFilepath',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        sample_id: sample_id
                        // model: model,
                        // coding: coding,
                        // category: category,
                        // version: version,
                        // big_species: big_species,
                        // small_species: small_species,
                        // high_frequency: high_frequency,
                        // questStats: questStats,
                        // sample_frequency: sample_frequency
                    }),
                    success: function(jumpfilepath){
                        $.ajax({
                            url: '/loginExcelShow',
                            type: 'POST',
                            data: {
                                filePath: jumpfilepath
                            },
                            success: function(response){
                                if (response.status === 'success') {
                                    localStorage.setItem(`DQE_` ,sample_DQE);
                                    localStorage.setItem(`Developer_` ,sample_Developer);
                                    localStorage.setItem(`model_` ,model);
                                    localStorage.setItem(`coding_` ,coding);
                                    localStorage.setItem(`sample_name_` ,sample_name);
                                    localStorage.setItem(`supplier_` ,supplier);
                                    localStorage.setItem(`tester_` ,tester);


                                    var redirectUrl = response.redirectUrl;
                                    if (redirectUrl.indexOf('?') !== -1) {
                                        redirectUrl += '&dd_orientation=landscape';
                                    } else {
                                        redirectUrl += '?dd_orientation=landscape';
                                    }
                                    window.location.href = redirectUrl;
                                    // window.location.href = response.redirectUrl;
                                } else {
                                    alert(response.message);
                                }
                            },
                            error: function(xhr, status, error){
                                console.log("æ–‡ä»¶å¤„ç†å¤±è´¥", error);
                                alert("æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
                            }
                        });
                    },
                    error: function(xhr, status, error){
                        console.log("è·å–ä¸åˆ°æ–‡ä»¶è·¯å¾„", error);
                        alert("è·å–ä¸åˆ°æ–‡ä»¶è·¯å¾„!");
                    },
                    complete: function() {
                        // è¯·æ±‚å®Œæˆåéšè—æ¨¡æ€æ¡†
                        document.getElementById('loadingModal').style.display = 'none';
                    }
                });
            }
        };
        */

        // ä¸º passbackProblemBtn æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.getElementById('passbackProblemBtn').addEventListener('click', async function() {

            var sample_id = $('#edit_sample_id').val();

            // è·å–é—®é¢˜ç‚¹ç¡®è®¤çŠ¶æ€å¤é€‰æ¡†çš„å€¼
            const passbackConfirm = document.getElementById('passbackConfirmCheckbox').checked;

            // æ£€æŸ¥ checkJudge çŠ¶æ€
            const checkJudge = await checkSampleResult(sample_id);
            
            // å¦‚æœ checkJudge ä¸º trueï¼Œç¦ç”¨å›ä¼ é—®é¢˜ç‚¹åŠŸèƒ½
            if (checkJudge === true) {
                alert('DQEå·²å®¡æ ¸ï¼Œä¸å…è®¸å›ä¼ é—®é¢˜ç‚¹');
                return;
            }

            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx';

            // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
            const handleFileChange = async function(event) {
                const file = event.target.files[0];
                if (!file) {
                    // ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©
                    fileInput.remove(); // ç§»é™¤æ–‡ä»¶è¾“å…¥å…ƒç´ 
                    return;
                }

                // éªŒè¯æ–‡ä»¶ç±»å‹
                const fileName = file.name;
                const fileExtension = fileName.slice(fileName.lastIndexOf('.') + 1).toLowerCase();
                if (fileExtension !== 'xlsx') {
                    alert('è¯·ä¸Šä¼ ä¸€ä¸ª .xlsx æ ¼å¼çš„æ–‡ä»¶');
                    fileInput.remove(); // ç§»é™¤æ–‡ä»¶è¾“å…¥å…ƒç´ 
                    return;
                }

                // åˆ›å»ºè¡¨å•æ•°æ®å¯¹è±¡å¹¶æ·»åŠ æ–‡ä»¶
                const formData = new FormData();
                formData.append('excelFile', file);
                formData.append('sample_id', sample_id);
                formData.append('job', job);
                formData.append('passbackConfirm', passbackConfirm);

                try {
                    // æ˜¾ç¤ºä¸Šä¼ æç¤º
                    alert('æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ï¼Œè¯·ç¨å€™...');
                    const response = await fetch('/testManIndex/passbackProblem', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                    }

                    const result = await response.json();
                    AccessLogUtil.record("å›ä¼ é—®é¢˜ç‚¹æŒ‰é’®");
                    alert(result.message);
                } catch (error) {
                    console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
                    alert('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                } finally {
                    // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½ç§»é™¤äº‹ä»¶ç›‘å¬å™¨å’Œæ–‡ä»¶è¾“å…¥å…ƒç´ 
                    fileInput.removeEventListener('change', handleFileChange);
                    fileInput.remove();
                }
            };

            fileInput.addEventListener('change', handleFileChange);

            // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            fileInput.click();
        });

        // ä¸º copyLinkBtn æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.getElementById('copyLinkBtn').addEventListener('click', function() {
            // è·å–å½“å‰æ ·å“çš„sample_id
            const sampleId = $('#edit_sample_id').val();
            
            // æ„å»ºä¸­è½¬é¡µé¢URL
            const redirectMidPageUrl = `http://219.134.191.195:64000/authRedirect?sample_id=${encodeURIComponent(sampleId)}`;
            // const redirectMidPageUrl = `http://ua6fbe8b.natappfree.cc/authRedirect?sample_id=${encodeURIComponent(sampleId)}`;

            // æ„å»ºé’‰é’‰è·³è½¬é“¾æ¥
            const messageUrl = "æ‚¨å¥½ï¼ç”µæ°”æ€§èƒ½æµ‹è¯•æŠ¥å‘Šå·²å®Œæˆï¼Œè¯·ç‚¹å‡»ä»¥ä¸‹é“¾æ¥è·³è½¬å®¡æ ¸ï¼š\n"+`dingtalk://dingtalkclient/action/openapp?corpid=ding39a9d20442a933ec35c2f4657eb6378f&container_type=work_platform&app_id=0_3078576183&redirect_type=jump&redirect_url=${encodeURIComponent(redirectMidPageUrl)}`;
            // const messageUrl = "æ‚¨å¥½ï¼ç”µæ°”æ€§èƒ½æµ‹è¯•æŠ¥å‘Šå·²å®Œæˆï¼Œè¯·ç‚¹å‡»ä»¥ä¸‹é“¾æ¥è·³è½¬å®¡æ ¸ï¼š\n"+`dingtalk://dingtalkclient/action/openapp?corpid=ding39a9d20442a933ec35c2f4657eb6378f&container_type=work_platform&app_id=0_3152575892&redirect_type=jump&redirect_url=${encodeURIComponent(redirectMidPageUrl)}`;

            // ç›´æ¥å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
            copyTextToClipboard(messageUrl);
        });


        // ä¸ºè¡¨å•æ·»åŠ æäº¤äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('fileEditForm').onsubmit = function(event) {
            event.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º
            // å…ˆè·å–sample_nameçš„å€¼å¹¶æ¸…ç†å®ƒ
            var edit_sample_name = $('#edit_sample_name').val();
            // edit_sample_name = edit_sample_name.replace(/[\/\\]/g, "_");
            edit_sample_name = edit_sample_name.replace(/[\/\\:*?"<>|\t]/g, "_");

            // æ›´æ–°sample_nameçš„å€¼
            $('#edit_sample_name').val(edit_sample_name);

            // è·å–å¤é€‰æ¡†çš„å€¼å¹¶æ·»åŠ åˆ°è¡¨å•æ•°æ®ä¸­
            var passbackConfirm = document.getElementById('passbackConfirmCheckbox').checked;
            var formData = $(this).serialize() + '&passbackConfirm=' + passbackConfirm;

            $.ajax({
                url: '/testManIndex/updateSamples',
                type: 'POST',
                data: formData,
                success: async function(response){

                    if (response.rename === "é‡å‘½åæˆåŠŸ" || response.message === "æ›´æ¢å½“å‰æµ‹è¯•äºº") {
                        await clearStorage(response);
                    }

                    if (response.status === "success") {
                        if (response.message === "æ›´æ¢å½“å‰æµ‹è¯•äºº") {
                            document.getElementById('editModal').remove();
                            performSearch();
                        }
                        document.getElementById('edit_sample_DQE').value = $('#edit_sample_DQE').val().trim();
                        document.getElementById('edit_sample_Developer').value = $('#edit_sample_Developer').val().trim();
                        document.getElementById('edit_supplier').value = $('#edit_supplier').val().trim();
                        document.getElementById('edit_sample_name').value = $('#edit_sample_name').val().trim();
                        // ä¼˜å…ˆæ˜¾ç¤º warningï¼Œå¦‚æœæ²¡æœ‰æ‰æ˜¾ç¤º message
                        if (response.warning && response.warning.trim() !== "") {
                            alert(response.warning);
                        } else {
                            alert(response.message);
                        }
                    } else {
                        alert("æ–‡ä»¶ä¿å­˜å¤±è´¥: " + response.message);
                    }

                },
                error: function(xhr, status, error){
                    console.log("æ–‡ä»¶ä¿å­˜å¤±è´¥", error);
                    alert("æ–‡ä»¶ä¿å­˜å¤±è´¥!");
                }
            });
        };

        document.getElementById('viewProblemBtn').onclick = function() {
            editClickBtn(product.sample_id)
        };

        document.getElementById('viewDataBtn').onclick = function() {
            viewDataClick(product.sample_id)
        };

        document.getElementById('viewTestItemsBtn').onclick = function() {
            viewTestItemsClick(product.sample_id)
        };


    }

    // æ‰§è¡Œæœç´¢çš„å‡½æ•°
    function performSearch() {
        // è·å–æœç´¢å…³é”®è¯
        var keyword = $('.search-input').val().trim();
        // è·å–é€‰å®šçš„ç­›é€‰æ¡ä»¶
        var sortFilter = $('#sort-filter').val();
        // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„æ•°æ®
        $('.table-container').empty();

        // å‘é€æœç´¢è¯·æ±‚åˆ°åç«¯
        $.ajax({
            url: '/searchSamples', // åç«¯æœç´¢æ¥å£åœ°å€
            type: 'POST',
            contentType: 'application/json', // æ·»åŠ è¿™ä¸€è¡Œ
            data: JSON.stringify({
                keyword: keyword,
                sortFilter: sortFilter,
                username: username
            }),
            success: function(data) {
                const type = "search";
                renderTableContainer(data,type);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                if (jqXHR.status === 401) {
                    // ä¼šè¯è¶…æ—¶ï¼Œé‡å®šå‘åˆ°index.html
                    window.location.href = '/index.html';
                } else {
                    // å¤„ç†å…¶ä»–é”™è¯¯
                    console.error('Error:', textStatus, errorThrown);
                }
            }
        });
    }




    function returnResult(result_judge) {
        switch (result_judge) {
            case 0:
                return "ç­¾æ ·";
            case 1:
                return "é€€æ ·";
            case 2:
                return "é™æ”¶";
            case 3:
                return "ç‰¹é‡‡";
            case 4:
                return "ä¼šè®®è¯„å®¡æ¥å—";
            case 5:
                return "éªŒè¯æ ·å“åˆæ ¼";
            case 6:
                return "éªŒè¯æ ·å“ä¸åˆæ ¼";
            default:
                return "æœªçŸ¥"; // é»˜è®¤è¿”å›å€¼
        }
    }


    //æœç´¢æˆ–è€…åˆå§‹åŒ–åŠ è½½æ¸²æŸ“æ–‡ä»¶è¡¨æ ¼çš„æ–¹æ³•
    function renderTableContainer(data,type){
        // æ¸²æŸ“æ–°çš„æœç´¢ç»“æœ
        if (data.length > 0) {
            // æ¸²æŸ“æ¯ä¸ªè¡¨æ ¼
            data.forEach(function(product, index) {
                // åˆ›å»ºè¡¨æ ¼å’ŒæŒ‰é’®çš„å®¹å™¨
                var tableAndButtons = '<div class="table-and-buttons">';

                // var isDanger = (product.danger && product.danger.trim() !== "") ||
                //     (product.finish_time && new Date(product.finish_time).getTime() > new Date(product.scheduleEndTime).getTime()) ||
                //     (!product.finish_time && new Date().getTime() > new Date(product.scheduleEndTime).getTime()) ||
                //     (product.finish_time && product.sample_schedule === '0' && new Date().getTime() > new Date(product.scheduleEndTime).getTime());

                var isDanger = false;
// å®šä¹‰ä¸€ä¸ªåŸºå‡†æ—¥æœŸï¼š2025å¹´8æœˆ11æ—¥
                var thresholdDate = new Date('2025-08-05T00:00:00');
// åªæœ‰å½“ product.create å­˜åœ¨ä¸”å¤§äº 2025-08-11 æ—¶ï¼Œæ‰è¿›è¡Œå±é™©åˆ¤æ–­
                if (product.create_time && new Date(product.create_time) > thresholdDate) {
                    isDanger = (product.danger && product.danger.trim() !== "") ||
                        (product.finish_time && new Date(product.finish_time).getTime() > new Date(product.scheduleEndTime).getTime()) ||
                        (!product.finish_time && new Date().getTime() > new Date(product.scheduleEndTime).getTime()) ||
                        (product.finish_time && product.sample_schedule === '0' && new Date().getTime() > new Date(product.scheduleEndTime).getTime());
                }



                // å¦‚æœ scheduleEndTime ä¸º nullï¼Œåˆ™ isDanger ä¸€å®šä¸º false
                if (product.scheduleEndTime === null) {
                    isDanger = false;
                }

                // æ ¹æ®æ¡ä»¶ isDanger æ¥å†³å®š tableClass çš„å€¼
                var tableClass = isDanger ? 'product-table danger' : 'product-table';

                // åˆ›å»º table å…ƒç´ çš„ HTML å­—ç¬¦ä¸²ï¼Œå¹¶æ·»åŠ ç±»åå’Œæ•°æ®å±æ€§
                var table = '<table class="' + tableClass + '" data-filepath="' + product.filepath + '" data-finish_time="' + product.finish_time + '" data-planfinish_time="' + product.planfinish_time + '">';table += '<thead>';
                table += '<tr>';
                table += '<th rowspan="1" colspan="1" title="æ ·å“è¿›åº¦ï¼š' + getSampleScheduleDescription(product.sample_schedule) + '">' + 'è¿›åº¦ï¼š'+ getSampleScheduleDescription(product.sample_schedule) + '</th>';
                // æ¯ä¸ªå•å…ƒæ ¼çš„å…·ä½“å€¼ä½œä¸ºtitleå±æ€§çš„å€¼
                table += '<th colspan="2" title="å¤§å‹å·' + product.sample_model + ', å°å‹å·' + product.sample_coding  + '">' + '' + product.sample_model + ' ' + product.sample_coding  + '</th>';
                table += '<th colspan="1" title="ç±»åˆ«ï¼š' + product.sample_category + ', ç‰ˆæœ¬' + product.version + ', ä»»åŠ¡å±æ€§' + product.questStats  + '">' + product.sample_category + ' ' + product.version + ' ' + product.questStats + '</th>';
                table += '<th colspan="1" title="ç¬¬' + product.sample_frequency + 'æ¬¡é€æ ·' +'">' + 'ç¬¬' + product.sample_frequency + 'æ¬¡é€æ ·' + '</th>';
                table += '</tr>';
                table += '<tr>';
                table += '<th colspan="1" title="å¤§ç±»' + product.big_species + ', å“ç±»ç»†åˆ†' + product.small_species + '">' + '' + product.big_species + ' ' + product.small_species +  '</th>';
                table += '<th colspan="2" title="ä¾›åº”å•†' + product.supplier + ', ä¾›åº”å•†' + product.supplier + '">' + 'ä¾›åº”å•†ï¼š' + '' + product.supplier +  '</th>';
                table += '<th colspan="1" title="äº§å“åç§°ï¼š' + product.sample_name + '">' + product.sample_name + '</th>';
                table += '<th colspan="1" title="é¢„è®¡æ—¶é•¿ï¼š' + product.scheduleTestCycle + "å¤©ï¼Œå®æµ‹æ—¶é•¿"+ product.testDuration+'å°æ—¶">' + "é¢„è®¡æ—¶é•¿ï¼š" + product.scheduleTestCycle +"å¤©" +" " + "å®æµ‹æ—¶é•¿ï¼š" + product.testDuration +"å°æ—¶" + '</th>';
                table += '</tr>';
                table += '</thead>';
                table += '</table>';

                // åˆ›å»ºä¸‹æ‹‰èœå•æŒ‰é’®, æ ¹æ®sample_scheduleåŠ¨æ€è®¾ç½®æŒ‰é’®æ–‡æœ¬
                var buttonLabel = '';
                if (product.sample_schedule === "0") {
                    buttonLabel = 'æäº¤';
                } else if (product.sample_schedule ===  "1" ) {//ä¸€æ—¦DQEå®¡æ ¸äº†åˆ™ä¸å…è®¸æ’¤å›
                    buttonLabel = 'æ’¤å›';
                } else if(product.sample_schedule ===  "2" ){
                    buttonLabel = 'å®¡æ ¸å®Œç»“';
                } else if(product.sample_schedule ===  "3" || product.sample_schedule ===  "4" ){
                    buttonLabel = 'å·²å®Œæˆ';
                }else if ( product.sample_schedule === "9") {
                    buttonLabel = 'é€€æ ·äº†';
                }else if ( product.sample_schedule === "10") {
                    buttonLabel = 'ç«å“å®Œæˆ';
                }


                // åˆ›å»ºæ“ä½œæŒ‰é’®ç»„ï¼Œç›´æ¥å±•ç¤ºä¸‰ä¸ªæŒ‰é’®
                var actionButtons = '<div class="action-buttons-container">';
                
                // æäº¤/æ’¤å›/å®¡æ ¸å®Œç»“æŒ‰é’®
                actionButtons += '<button class="action-btn finish-btn" ' +
                    'data-filepath="' + product.filepath + '" ' +
                    'data-sample_model="' + product.sample_model + '" ' +
                    'data-sample_coding="' + product.sample_coding + '" ' +
                    'data-sample_category="' + product.sample_category + '" ' +
                    'data-version="' + product.version + '" ' +
                    'data-sample_frequency="' + product.sample_frequency + '" ' +
                    'data-big_species="' + product.big_species + '" ' +
                    'data-small_species="' + product.small_species + '" ' +
                    'data-high_frequency="' + product.high_frequency + '" ' +
                    'data-sample_schedule="' + product.sample_schedule + '" ' +
                    'data-sample_id="' + product.sample_id + '" ' +
                    'data-sample_dqe="' + product.sample_DQE + '" ' +
                    'data-sample_rd="' + product.sample_Developer + '" ' +
                    'data-sample_leader="' + product.sample_leader + '" ' +
                    'data-result_judge="' + product.result_judge + '" ' +
                    'data-rd_result_judge="' + product.rd_result_judge + '" ' +
                    'data-queststats="' + product.questStats + '" ' +
                    'data-cc_recipients="' + (product.cc_recipients || '') + '">' + buttonLabel + '</button>';

                // è½¬å‘æŒ‰é’®
                actionButtons += '<button class="action-btn forward-btn" data-filepath="' + product.filepath + '">è½¬å‘</button>';
                
                // åˆ é™¤æŒ‰é’®
                actionButtons += '<button class="action-btn delete-btn" data-filepath="' + product.filepath +  '" data-sample_id="' + product.sample_id + '">åˆ é™¤</button>';
                
                actionButtons += '</div>';

                // ç»“æŸè¡¨æ ¼å’ŒæŒ‰é’®çš„å®¹å™¨
                tableAndButtons += table + actionButtons + '</div>';

                // å°†è¡¨æ ¼æ·»åŠ åˆ°é¡µé¢ä¸­
                $('.table-container').append(tableAndButtons);

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                $('.product-table').last().on('click', function() {
                    showEditModal(product);
                });

                $('.table-container').off('click', '.finish-btn').on('click', '.finish-btn', function() {
                    // è¿™éƒ¨åˆ†æœ‰ä¸ªå¾ˆé‡è¦çš„åœ°æ–¹è¦æç¤ºå¼€å‘è€…ï¼Œå°±æ˜¯ä¸‹è¾¹è¿™äº›data()æ‹¬å·å†…çš„å­—æ®µå¿…é¡»æ˜¯å°å†™æ‰èƒ½æ•è·åˆ°å¯¹åº”çš„data-æ ‡ç­¾çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´
                    // åœ¨å‰ç«¯å­˜ä¿¡æ¯åœ¨æ ‡ç­¾é‡Œå¿…é¡»ä»¥å°å†™æ¥ä½œä¸ºå‚æ•°å¦åˆ™æ— æ•ˆ
                    var model = $(this).data('sample_model');
                    var coding = $(this).data('sample_coding');
                    var category = $(this).data('sample_category');
                    var version = $(this).data('version');
                    var schedule = $(this).data('sample_schedule');
                    var filepath = $(this).data('filepath');
                    var result_judge = returnResult($(this).data('result_judge'));
                    var rd_result_judge = returnResult($(this).data('rd_result_judge'));
                    // è·å–DQE,rdï¼Œå’Œé¡¹ç›®çš„å€¼ï¼Œä¸ºäº†åœ¨æäº¤çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦å¡«å†™äº†ï¼Œä¸ç„¶ä¸å…è®¸æäº¤
                    var dqe = $(this).data('sample_dqe');
                    var rd = $(this).data('sample_rd');
                    var projectLeader = $(this).data('sample_leader');


                    var sample_frequency = $(this).data('sample_frequency');
                    var big_species = $(this).data('big_species');
                    var small_species = $(this).data('small_species');
                    var high_frequency = $(this).data('high_frequency');

                    var questStats = $(this).data('queststats');  // ç¡®ä¿è·å–questStatsæ•°æ®
                    var sample_id  = $(this).data('sample_id');
                    var cc_recipients = $(this).data('cc_recipients') || '';  // è·å–æŠ„é€è€…ä¿¡æ¯

                    if (schedule === 0) {

                        // ç”±äºä½ è¦†ç›–äº† confirmï¼Œå¯ä»¥ç›´æ¥ç”¨åŸç”Ÿ confirm
                        confirm(`ä½ ç¡®å®šè¦æäº¤ ${filepath} å—ï¼Ÿ`)
                            .then((confirmation) => {
                                if (confirmation) {
                                    finishBtn(confirmation,
                                        filepath, model, coding, category, version, schedule,
                                        big_species, small_species, high_frequency, sample_frequency,
                                        questStats, sample_id, dqe ,rd ,projectLeader, cc_recipients
                                    );
                                }
                            });
                    } else if (schedule === 1) {
                        confirm(`${filepath}å¾…å®¡æ ¸ä¸­ï¼Œä½ ç¡®å®šè¦æ’¤å›å—?`)
                            .then((confirmation) => {
                                if (confirmation) {
                                    finishBtn(confirmation,
                                        filepath, model, coding, category, version, schedule,
                                        big_species, small_species, high_frequency, sample_frequency,
                                        questStats, sample_id, dqe, null, null, ''
                                    );
                                }
                            });
                    } else if (schedule === 2 || schedule === 3 || schedule === 4) {
                        alert(`${filepath}æœ¬é¡¹ç›®å·²å®¡æ ¸ï¼ç ”å‘åˆ¤å®šç»“æœï¼š${rd_result_judge}, DQEåˆ¤å®šç»“æœï¼š${result_judge}`);
                    }

                });

                // ç»‘å®šç‚¹å‡»äº‹ä»¶åˆ°è½¬å‘å’Œåˆ é™¤æŒ‰é’®
                $('.table-container').off('click', '.forward-btn').on('click', '.forward-btn', function() {

                    var filepath = $(this).data('filepath'); // è·å–æ–‡ä»¶è·¯å¾„
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆè¿™éœ€è¦ä½ èƒ½å¤Ÿåœ¨å‰ç«¯è·å–åˆ°æ–‡ä»¶å¤§å°ä¿¡æ¯ï¼‰
                    // if (!confirm('æ–‡ä»¶è¾ƒå¤§ï¼Œè½¬å‘å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    //     return; // ç”¨æˆ·é€‰æ‹©ä¸ä¸Šä¼ 
                    // }


                    // é€‰æ‹©è”ç³»äºº
                    dd.biz.contact.choose({
                        multiple: false,
                        users: [],
                        corpId: corp_id,
                        max: 1,
                        onSuccess: function (data) {
                            const selectedUserId = data[0].emplId; // è·å–å•ä¸ªç”¨æˆ·ID

                            // é€‰æ‹©é’‰ç›˜ç›®å½•
                            dd.chooseDingTalkDir({
                                corpId: corp_id, // ä¼ä¸šID
                                onSuccess: function (res) {
                                    const selectedDirId = res.data[0].dirId; // è·å–é€‰ä¸­çš„ç›®å½•ID
                                    const selectedSpaceId = res.data[0].spaceId; // è·å–é€‰ä¸­çš„ç©ºé—´ID

                                    // è·å–åº”ç”¨å…ç™»æˆæƒç 
                                    dd.runtime.permission.requestAuthCode({
                                        corpId: corp_id,
                                        onSuccess: function (result) {
                                            const authCode = result.code; // è·å–åˆ°æˆæƒç 
                                            // å‘èµ·åç«¯è¯·æ±‚ä¸Šä¼ æ–‡ä»¶å’Œå‘é€æ–‡ä»¶
                                            $.ajax({
                                                url: '/testManIndex/uploadFileToDingtalk',
                                                type: 'POST',
                                                data: {
                                                    filepath: filepath,
                                                    dirId: selectedDirId,
                                                    spaceId: selectedSpaceId,
                                                    authCode: authCode,
                                                    receiverId: selectedUserId,
                                                    username : username
                                                },
                                                success: function (response) {
                                                    alert('æ–‡ä»¶ä¸Šä¼ å¹¶å‘é€æˆåŠŸ');
                                                    // hideLoading(); // éšè—åŠ è½½æç¤ºæ¡†
                                                },
                                                error: function (xhr, status, error) {
                                                    alert('æ–‡ä»¶ä¸Šä¼ å‘é€å¤±è´¥: ' + error);
                                                    // hideLoading(); // éšè—åŠ è½½æç¤ºæ¡†
                                                }
                                            });
                                        },
                                        onFail: function (err) {
                                            alert('è·å–æˆæƒç å¤±è´¥ï¼š' + JSON.stringify(err));
                                            // hideLoading(); // éšè—åŠ è½½æç¤ºæ¡†
                                        }
                                    });
                                },
                                fail: function (err) {
                                    alert('é€‰æ‹©ç›®å½•å¤±è´¥ï¼š' + JSON.stringify(err));
                                    // hideLoading(); // éšè—åŠ è½½æç¤ºæ¡†
                                },
                                onCancel: function () {
                                    alert('é€‰æ‹©ç›®å½•å–æ¶ˆ');
                                    // hideLoading(); // éšè—åŠ è½½æç¤ºæ¡†
                                }
                            });
                        },
                        onFail: function (err) {
                            alert("é€‰æ‹©è”ç³»äººå‡ºé”™" + err);
                            hideLoading();// éšè—åŠ è½½æç¤ºæ¡†
                        }
                    });
                });


                $('.table-container').off('click', '.delete-btn').on('click', '.delete-btn', function() {
                    var filepath = $(this).data('filepath');
                    var sample_id = $(this).data('sample_id');

                    // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
                    confirm("ä½ ç¡®å®šè¦åˆ é™¤ " + filepath + " å—ï¼Ÿæ­¤æ“ä½œä¼šå°†æ–‡ä»¶å’Œè®°å½•åˆ é™¤ä¸”ä¸å¯é€†")
                        .then((confirmation) => {
                            if (confirmation) {
                                // ç”¨æˆ·ç‚¹å‡»äº†ç¡®è®¤
                                $.ajax({
                                    url: '/testManIndex/deleteSampleAndIssues', // æ§åˆ¶å™¨çš„è·¯å¾„
                                    type: 'POST', // æˆ–è€… 'GET'ï¼Œå–å†³äºä½ çš„éœ€æ±‚
                                    contentType: 'application/json',
                                    data: JSON.stringify({ filepath: filepath, sample_id: sample_id }), // å‘é€åˆ°æœåŠ¡å™¨çš„JSONæ•°æ®
                                    success: async function(response) {
                                        await sendLogToServer(response.message);
                                        await clearStorage(response);
                                        if (response.status === "success") {
                                            const storageKey = `sheetData_${filepath}`;
                                            if (localStorage.getItem(storageKey) !== null) {
                                                localStorage.removeItem(storageKey);
                                                await sendLogToServer(`å·²æ¸…ç† ${storageKey} çš„ç¼“å­˜`);
                                            }
                                            const sheetNameKey = `sheetNames_${filepath}`;
                                            if (localStorage.getItem(sheetNameKey) !== null) {
                                                localStorage.removeItem(sheetNameKey);
                                                await sendLogToServer(`å·²æ¸…ç† ${sheetNameKey} çš„ç¼“å­˜`);
                                            }
                                        }
                                        alert(response.message);
                                        window.location.href = '/testManIndex';
                                    },
                                    error: async function(xhr, status, error) {
                                        // è¿™é‡Œå¤„ç†é”™è¯¯çš„å›è°ƒ
                                        await sendLogToServer('åˆ é™¤å¤±è´¥: ' + error);
                                    }
                                });
                            }
                            // å¦‚æœç”¨æˆ·ç‚¹å‡»å–æ¶ˆï¼Œä»€ä¹ˆä¹Ÿä¸åš
                        });
                });



            });


        } else if(type === "search") {
            // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„æ•°æ®
            $('.table-container').empty();
            // å¦‚æœæ²¡æœ‰æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯æˆ–è€…å…¶ä»–æ“ä½œ
            $('.table-container').html('<p>æ²¡æœ‰æœç´¢å¯¹åº”çš„æ•°æ®</p>');
        }else if(type === "initialize"){
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºé™æ€è¡¨å¤´
            $('.static-header').show();
        }
    }


    function finishBtn(confirmation, filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, dqe ,rd ,projectLeader, cc_recipients ) {
        if (confirmation) {
            if (schedule === 0) {
                // æ˜¾ç¤ºä¼‘æ¯å¤©æ•°æ¨¡æ€æ¡†
                openModal(function(restDays) {
                    // æ˜¾ç¤ºé€€æ ·æˆ–ç«å“é€‰æ‹©æ¨¡æ€æ¡†
                    openChoiceModal(function(choice) {
                        if (choice === 'é€€æ ·') {
                            const tuiOrJp = "tui";
                            alert('ç”¨æˆ·é€‰æ‹©äº†é€€æ ·ï¼Œåç»­å¤„ç†é€»è¾‘å¯ä»¥åœ¨è¿™é‡Œå®Œæˆã€‚');
                            submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe, null, tuiOrJp, cc_recipients);
                            // å¦‚æœéœ€è¦ï¼Œè°ƒç”¨åç»­é€»è¾‘
                        } else if (choice === 'ç«å“') {

                            alert('ç”¨æˆ·é€‰æ‹©äº†ç«å“ï¼Œåç»­å¤„ç†é€»è¾‘å¯ä»¥åœ¨è¿™é‡Œå®Œæˆã€‚');
                            if(!dqe && !rd){
                                alert("ç«å“éœ€è¦å¡«å†™å¯¹åº”é¡¹ç›®çš„DQEã€RDï¼Œè¯·èµ·ç å¡«å†™ä¸€ä¸ªï¼Œæ‰èƒ½å‡†ç¡®å‘é€å¯¹åº”æµç¨‹æé†’ä»–ä»¬ï¼");
                                return;
                            }
                            const tuiOrJp = "jp";
                            // å¦‚æœéœ€è¦ï¼Œè°ƒç”¨åç»­é€»è¾‘
                            submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe , rd , tuiOrJp, cc_recipients);
                        } else {
                            if (!dqe || !rd || !projectLeader) {
                                alert("æ£€æµ‹åˆ°æ‚¨æ²¡å¡«å†™å¯¹åº”é¡¹ç›®çš„DQEã€RDï¼Œå’Œé¡¹ç›®è´Ÿè´£äººï¼Œè¯·å¡«å†™ï¼Œæ‰èƒ½å‡†ç¡®å‘é€å¯¹åº”æµç¨‹æé†’ä»–ä»¬ï¼");
                                return;
                            }

                            confirm(`ä½ ç¡®å®šè¦æäº¤ ${filepath} å—ï¼Ÿ`)
                                .then((confirmation)=>{
                                    if(confirmation){
                                        submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe, rd, null, cc_recipients);
                                    }
                                })
                        }
                    });
                });
            }else if(schedule === 1){
                if (confirmation) {
                    // æ‰§è¡Œæ’¤å›æ“ä½œ
                    submitFinish(
                        filepath,
                        model,
                        coding,
                        category,
                        version,
                        schedule,
                        big_species,
                        small_species,
                        high_frequency,
                        sample_frequency,
                        questStats,
                        sample_id,
                        0, // æ’¤å›æ—¶æ— ä¼‘æ¯å¤©æ•°
                        dqe,
                        null,
                        null,
                        ''
                    );
                }

            }
        }
    }


    function openModal(callback) {
        const modal = document.getElementById('restDaysModal');
        modal.style.display = 'block';

        // ç»‘å®šç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        window.submitRestDays = function() {
            const input = document.getElementById('restDaysInput').value.trim();
            const numberPattern = /^(0|[1-9]\d*)(\.\d)?$/;
            const restDays = parseFloat(input);

            if (!numberPattern.test(input) || (restDays % 0.5 !== 0) || restDays < 0) {
                alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ä¼‘æ¯å¤©æ•°ï¼ä¾‹å¦‚ï¼š0.5, 1, 1.5");
                return;
            }

            closeModal();
            if (callback) callback(restDays);
        };

        // ç»‘å®šå–æ¶ˆæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        window.closeModal = function() {
            modal.style.display = 'none';
        };
    }

    function openChoiceModal(callback) {
        const choiceModal = document.getElementById('choiceModal');
        choiceModal.style.display = 'block';

        // ç»‘å®šé€‰æ‹©æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.getElementById('btnRetireSample').onclick = function() {
            closeChoiceModal();
            if (callback) callback('é€€æ ·');
        };

        document.getElementById('btnCompetitive').onclick = function() {
            closeChoiceModal();
            if (callback) callback('ç«å“');
        };

        document.getElementById('btnNoChoice').onclick = function() {
            closeChoiceModal();
            if (callback) callback('æ— é€‰æ‹©');
        };

        function closeChoiceModal() {
            choiceModal.style.display = 'none';
        }
    }

    function submitFinish(filepath, model, coding, category, version, schedule, big_species, small_species, high_frequency, sample_frequency, questStats, sample_id, restDays, dqe , rd, tuiOrJp, cc_recipients) {
        // ç”¨æˆ·ç‚¹å‡»äº†ç¡®è®¤
        $.ajax({
            url: '/testManIndex/finishTest', // æ§åˆ¶å™¨çš„è·¯å¾„
            type: 'POST', // æˆ–è€… 'GET'ï¼Œå–å†³äºä½ çš„éœ€æ±‚
            contentType: 'application/json',
            data: JSON.stringify({
                filepath: filepath,
                model: model,
                coding: coding,
                category: category,
                version: version,
                schedule: schedule,
                big_species: big_species,
                small_species: small_species,
                high_frequency: high_frequency,
                sample_frequency: sample_frequency,
                questStats: questStats,
                sample_id: sample_id,
                restDays: restDays, // æ·»åŠ ç”¨æˆ·è¾“å…¥çš„ä¼‘æ¯å¤©æ•°
                tuiOrJp : tuiOrJp
            }), // å‘é€åˆ°æœåŠ¡å™¨çš„JSONæ•°æ®
            success: function(response) {
                const statusBarBgColor = "0xFF5E97F6";
                // è¿™é‡Œå¤„ç†æˆåŠŸçš„å›è°ƒï¼Œæ¯”å¦‚æç¤ºç”¨æˆ·æˆ–è€…æ›´æ–°UI
                alert(response.message);
                if (dqe && response.message.includes("æäº¤æˆåŠŸ")) {
                    updateSchedule("1", sample_id, dqe, statusBarBgColor, username, "DQE");

                    setTimeout(() => {
                        updateSchedule("1", sample_id, rd, statusBarBgColor, username, "rd");
                    }, 2000); // 2000 æ¯«ç§’ = 2 ç§’

                    // å¦‚æœæœ‰æŠ„é€è€…ï¼Œå‘é€æ–‡æœ¬é€šçŸ¥ç»™æŠ„é€è€…
                    if (cc_recipients && cc_recipients.trim() !== '') {
                        const ccList = cc_recipients.split(',').map(name => name.trim()).filter(name => name !== '');
                        ccList.forEach((ccName, index) => {
                            setTimeout(() => {
                                sendCcNotification(sample_id, ccName, username, "1");
                            }, 2000 + (index * 2000)); // æ¯ä¸ªæŠ„é€è€…é—´éš”2ç§’
                        });
                    }

                    // ç­‰å¾… 2 ç§’åå‘é€ç»™ç»®æ•
                    setTimeout(() => {
                        updateSchedule("1", sample_id, "è®¸æ¢¦ç‘¶", statusBarBgColor, username, "notice");
                    }, 2000); // 2000 æ¯«ç§’ = 2 ç§’

                    AccessLogUtil.record("æäº¤æŠ¥å‘Šèµ°å®¡æ ¸æµç¨‹æŒ‰é’®");
                }else if(dqe && response.message.includes("é€€æ ·æˆåŠŸ")){
                    updateSchedule("9", sample_id, dqe, statusBarBgColor, username, job);
                    // ç­‰å¾… 2 ç§’åå‘é€ç»™ç»®æ•
                    setTimeout(() => {
                        updateSchedule("9", sample_id, "è®¸æ¢¦ç‘¶", statusBarBgColor, username, "notice");
                    }, 2000); // 2000 æ¯«ç§’ = 2 ç§’

                    // å¦‚æœæœ‰æŠ„é€è€…ï¼Œå‘é€æ–‡æœ¬é€šçŸ¥ç»™æŠ„é€è€…
                    if (cc_recipients && cc_recipients.trim() !== '') {
                        const ccList = cc_recipients.split(',').map(name => name.trim()).filter(name => name !== '');
                        ccList.forEach((ccName, index) => {
                            setTimeout(() => {
                                sendCcNotification(sample_id, ccName, username, "9");
                            }, 4000 + (index * 2000)); // åœ¨å‘é€ç»™ç»®æ•ä¹‹åï¼Œæ¯ä¸ªæŠ„é€è€…é—´éš”2ç§’
                        });
                    }

                    AccessLogUtil.record("æäº¤æŠ¥å‘Šèµ°é€€æ ·æµç¨‹æŒ‰é’®");

                }else if(response.message.includes("ç«å“æ–‡ä»¶å®Œæˆ")){

                    if (dqe) {
                        setTimeout(() => {
                            updateSchedule("10", sample_id, dqe, statusBarBgColor, username, job);
                        }, 2000); // 2000 æ¯«ç§’ = 2 ç§’
                    }
                    if(rd){
                        setTimeout(() => {
                            updateSchedule("10", sample_id, rd, statusBarBgColor, username, job);
                        }, 2000); // 2000 æ¯«ç§’ = 2 ç§’

                    }

                    // ç­‰å¾… 2 ç§’åå‘é€ç»™ç»®æ•
                    setTimeout(() => {
                        updateSchedule("10", sample_id, "è®¸æ¢¦ç‘¶", statusBarBgColor, username, "notice");
                    }, 2000); // 2000 æ¯«ç§’ = 2 ç§’

                    // å¦‚æœæœ‰æŠ„é€è€…ï¼Œå‘é€æ–‡æœ¬é€šçŸ¥ç»™æŠ„é€è€…
                    if (cc_recipients && cc_recipients.trim() !== '') {
                        const ccList = cc_recipients.split(',').map(name => name.trim()).filter(name => name !== '');
                        ccList.forEach((ccName, index) => {
                            setTimeout(() => {
                                sendCcNotification(sample_id, ccName, username, "10");
                            }, 4000 + (index * 2000)); // åœ¨å‘é€ç»™ç»®æ•ä¹‹åï¼Œæ¯ä¸ªæŠ„é€è€…é—´éš”2ç§’
                        });
                    }

                    AccessLogUtil.record("æäº¤æŠ¥å‘Šèµ°ç«å“æµç¨‹æŒ‰é’®");
                }
                initData();
                performSearch();
            },
            error: function(xhr, status, error) {
                // è¿™é‡Œå¤„ç†é”™è¯¯çš„å›è°ƒ
                alert('æäº¤æŒ‰é’®å‡ºç°é”™è¯¯: ' + error);
            }
        });
    }


    function hideLoading() {
        // éšè—åŠ è½½åŠ¨ç”»æˆ–æç¤ºæ¡†çš„å®ç°
        $('#loading').remove();
    }

    // ç›‘å¬versionå¡«å•çš„æ—¶å€™è‡ªåŠ¨è½¬æ¢æˆå¤§å†™
    document.getElementById('version').addEventListener('keyup', function(e) {
        this.value = this.value.toUpperCase();
    });


    // ä¸ºsample_nameè¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('sample_name').addEventListener('input', function(e) {
        // this.value = this.value.replace(/[\\\/]/g, '_');
        this.value = this.value.replace(/[\/\\:*?"<>|\t]/g, "_");
    });

    document.getElementById('model').addEventListener('input', function(e) {
        // this.value = this.value.replace(/[\\\/]/g, '_');
        this.value = this.value.replace(/[\\\/:*?"<>|]/g, 'æ— ');
    });

    document.getElementById('coding').addEventListener('input', function(e) {
        // this.value = this.value.replace(/[\\\/]/g, '_');
        this.value = this.value.replace(/[\\\/:*?"<>|]/g, 'æ— ');
    });

    document.getElementById('version').addEventListener('input', function(e) {
        // this.value = this.value.replace(/[\\\/]/g, '_');
        this.value = this.value.replace(/[\\\/:*?"<>|]/g, 'æ— ');
    });


    //é€‰æ‹©å¤§ç±»ä¹‹åé€‰æ‹©å°ç±»
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/json/categories.json')
            .then(response => response.json())
            .then(data => {
                const bigSpeciesSelect = document.getElementById('big_species');

                // å¡«å……å¤§ç±»é€‰æ‹©å™¨
                for (const bigSpecies in data) {
                    const option = document.createElement('option');
                    option.value = bigSpecies;
                    option.textContent = bigSpecies;
                    bigSpeciesSelect.appendChild(option);
                }

                // å­˜å‚¨æ•°æ®ä¾›åç»­ä½¿ç”¨
                window.categoryData = data;
            });
    });

    function populateSubCategory() {
        const bigSpeciesSelect = document.getElementById('big_species');
        const smallSpeciesSelect = document.getElementById('small_species');
        const bigSpeciesCategory = bigSpeciesSelect.value;

        // æ¸…ç©ºå½“å‰çš„ç»†åˆ†å“ç±»é€‰é¡¹
        smallSpeciesSelect.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ç»†åˆ†å“ç±»</option>';

        if (window.categoryData) {
            let smallSpeciesArray = [];
            if (bigSpeciesCategory === "ç«å“-é¢„ç ”ç±»" || bigSpeciesCategory === "é«˜é¢‘ç±»") {
                for (const category in window.categoryData) {
                    if (category !== "ç«å“-é¢„ç ”ç±»" && category !== "é«˜é¢‘ç±»") {
                        window.categoryData[category].forEach(subCategory => {
                            smallSpeciesArray.push(`${category}-${subCategory}`);
                        });
                    }
                }
            } else if (window.categoryData[bigSpeciesCategory]) {
                smallSpeciesArray = window.categoryData[bigSpeciesCategory];
            }

            smallSpeciesArray.forEach(smallSpecies => {
                const option = document.createElement('option');
                option.value = smallSpecies;
                option.textContent = smallSpecies;
                smallSpeciesSelect.appendChild(option);
            });
        }
    }

    async function sendLogToServer(logMessage) {
        try {
            await $.ajax({
                url: '/log/debug',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ message: logMessage })
            });
        } catch (error) {
            console.error('å‘é€æ—¥å¿—å¤±è´¥: ', error);
        }
    }

    async function clearStorage(response) {
        const storageKey = `sheetData_${response.oldFilePath}`;
        const sheetNamesKey = `sheetNames_${response.oldFilePath}`;
        const collectDataKey = `collectData_${response.oldFilePath}`;
        if (localStorage.getItem(storageKey) !== null) {
            localStorage.removeItem(storageKey);
            await sendLogToServer(`å·²æ¸…ç† ${storageKey} çš„ç¼“å­˜`);
        }else{
            await sendLogToServer(`æ²¡æœ‰ ${storageKey} çš„ç¼“å­˜`);
        }
        if (localStorage.getItem(sheetNamesKey) !== null) {
            localStorage.removeItem(sheetNamesKey);
            await sendLogToServer(`å·²æ¸…ç† ${sheetNamesKey} çš„ç¼“å­˜`);
        }else{
            await sendLogToServer(`æ²¡æœ‰ ${sheetNamesKey} çš„ç¼“å­˜`);
        }
        if (localStorage.getItem(collectDataKey) !== null) {
            localStorage.removeItem(collectDataKey);
            await sendLogToServer(`å·²æ¸…ç† ${collectDataKey} çš„ç¼“å­˜`);
        }else{
            await sendLogToServer(`æ²¡æœ‰ ${collectDataKey} çš„ç¼“å­˜`);
        }

        try {
            await $.ajax({
                url: '/testManIndex/clearJson',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ oldFilePath: response.oldFilePath})
            });
        } catch (error) {
            console.error('å‘é€æ—¥å¿—å¤±è´¥: ', error);
        }




    }


    // è·å–å…ƒç´ 
    const announcementBtn = document.getElementById('announcement-btn');
    const logModal = document.getElementById('log-modal');
    const closeBtn = document.querySelector('.close-btn');

    // ç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºé¢æ¿
    announcementBtn.addEventListener('click', () => {
        logModal.style.display = 'block';
    });

    // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—é¢æ¿
    closeBtn.addEventListener('click', () => {
        logModal.style.display = 'none';
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨éšè—é¢æ¿
    window.addEventListener('click', (event) => {
        if (event.target == logModal) {
            logModal.style.display = 'none';
        }
    });


    // å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ ¹æ®sample_scheduleçš„å€¼è¿”å›å¯¹åº”çš„æè¿°æ–‡å­—
    function getSampleScheduleDescription(value) {
        switch (value) {
            case "0":
                return "æµ‹è¯•ä¸­";
            case "1":
                return "å¾…DQEå’Œç ”å‘å®¡æ ¸";
            case "2":
                return "å®¡æ ¸å®Œæˆ";
            case "3":
                return "å·²å®Œæˆ";
            case "4":
                return "å·²å®Œæˆ";
            case "9":
                return "æµ‹è¯•äººå‘˜é€€æ ·";
            case "10":
                return "æµ‹è¯•äººå‘˜ç«å“å®Œæˆ";
            default:
                return ""; // å¯ä»¥æ ¹æ®éœ€è¦è¿”å›é»˜è®¤å€¼æˆ–ç©ºå­—ç¬¦ä¸²
        }
    }

    //2024.10.31  æ–°å¢ä¸€ä¸ªæŸ¥çœ‹é—®é¢˜ç‚¹çš„æŒ‰é’®
    async function editClickBtn(sampleId) {
        // å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤è¯·æ±‚
        if (isEditing){
            alert("è¯·ä¸è¦é¢‘ç¹ç‚¹å‡»ï¼Œæ­£åœ¨æœç´¢ä¸Šä¸€ä¸ªç‚¹å‡»çš„é—®é¢˜ç‚¹,å¦‚æœä¸€ç›´å‡ºç°è¿™ä¸ªæç¤ºï¼Œå¯ä»¥å…³é—­åº”ç”¨é‡æ–°è¿›æ¥")
            return;
        }

        isEditing = true; // è®¾ç½®ä¸ºæ­£åœ¨ç¼–è¾‘çŠ¶æ€

        // **å…ˆè°ƒç”¨é€šç”¨æ–¹æ³•è·å–å‚æ•°**
        const checkJudge = await checkSampleResult(sampleId);
        
        // å¦‚æœ checkJudge ä¸º trueï¼Œç¦ç”¨ç¼–è¾‘åŠŸèƒ½
        const isEditDisabled = checkJudge === true;

        fetch(`/problemMoudle/editClickBtn?sampleId=${sampleId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                }
                return response.json();
            })
            .then(data => {
                console.log(data)
                const modal = document.getElementById('testIssuesModal');
                const contentDiv = document.getElementById('testIssuesContent');

                // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
                contentDiv.innerHTML = '';

                // åˆ›å»ºä¸€ä¸ªè¡¨æ ¼å®¹å™¨
                const tableContainer = document.createElement('div');
                tableContainer.className = 'problem-container';

                // åˆ›å»ºè¡¨æ ¼
                const table = document.createElement('table');
                table.className = 'problem-table';

                // åˆ›å»ºåˆ—åè¡Œ
                const headerRow = document.createElement('tr');
                headerRow.className = 'header-row';
                const attributes = [
                    { label: 'ID(ç‚¹å‡»åˆ é™¤)', field: 'id' },
                    { label: 'è´£ä»»å•ä½ï¼ˆå¿…å¡«ï¼‰', field: 'responsibleDepartment' },
                    { label: 'DQEç¡®è®¤', field: 'dqe_confirm' },
                    { label: 'DQEæ„è§ä¿¡æ¯', field: 'dqe_confirm_inform' },
                    { label: 'ç ”å‘ç¡®è®¤', field: 'rd_confirm' },
                    { label: 'ç ”å‘æ„è§ä¿¡æ¯', field: 'rd_confirm_inform' },
                    // å‰ç§»
                    { label: 'ç¼ºé™·ç­‰çº§(åªå†™SABCD)', field: 'defect_level' },
                    { label: 'å½“å‰çŠ¶æ€', field: 'current_status' },
                    { label: 'é—®é¢˜ç±»åˆ«', field: 'problemCategory' },
                    { label: 'è¯„å®¡ç»“è®º', field: 'review_conclusion' },
                    { label: 'SKU', field: 'sku' },

                    { label: 'å®Œæ•´å‹å·', field: 'full_model' },
                    { label: 'æ ·å“é˜¶æ®µ', field: 'sample_stage' },
                    { label: 'ç‰ˆæœ¬', field: 'version' },
                    { label: 'èŠ¯ç‰‡æ–¹æ¡ˆ', field: 'chip_solution' },
                    { label: 'æµ‹è¯•å¹³å°', field: 'test_platform' },
                    { label: 'æ˜¾ç¤ºè®¾å¤‡', field: 'test_device' },
                    { label: 'å…¶ä»–è®¾å¤‡', field: 'other_device' },
                    { label: 'é—®é¢˜æè¿°', field: 'problem' },

                    { label: 'é—®é¢˜å›¾ç‰‡', field: 'problem_image_or_video' },
                    { label: 'é—®é¢˜æ—¶é—´', field: 'problem_time' },
                    { label: 'å¤ç°æ–¹æ³•', field: 'reproduction_method' },
                    { label: 'æ¢å¤æ–¹æ³•', field: 'recovery_method' },
                    { label: 'å¤ç°æ¦‚ç‡', field: 'reproduction_probability' },

                    { label: 'å¯¹æ¯”ä¸Šä¸€ç‰ˆæˆ–ç«å“', field: 'comparison_with_previous' },
                    //  20250101 æ–°å¢æ¨¡æ¿å­—æ®µ
                    { label: 'DQE&ç ”å‘ç¡®è®¤', field: 'dqe_and_development_confirm' },
                    { label: 'DQEç¡®è®¤å›å¤', field: 'green_union_dqe' },
                    { label: 'ç ”å‘ç¡®è®¤å›å¤', field: 'green_union_rd' },
                    { label: 'æ–¹æ¡ˆå•†', field: 'solution_provider' },
                    { label: 'ä¾›åº”å•†', field: 'supplier' },


                    { label: 'æå‡ºäºº', field: 'tester' },
                    // { label: 'æ”¹å–„å¯¹ç­–ï¼ˆç ”å‘å›å¤ï¼‰', field: 'improvement_plan' },
                    { label: 'åˆ†æè´£ä»»äºº', field: 'responsible_person' },
                    { label: 'æ”¹å–„åé£é™©', field: 'post_improvement_risk' },
                    { label: 'ä¸‹ä¸€ç‰ˆå›å½’æµ‹è¯•', field: 'next_version_regression_test' },
                    { label: 'å¤‡æ³¨', field: 'remark' },
                    { label: 'åˆ›å»ºæ—¶é—´', field: 'created_at' },
                    { label: 'å†å²ID', field: 'history_id' },
                    { label: 'é—®é¢˜ç‚¹åˆ›å»ºè€…', field: 'created_by' },
                    { label: 'æœ€åä¸€æ¬¡æ”¹åŠ¨è€…', field: 'modifier' },
                    { label: 'æ”¹åŠ¨æ—¶é—´', field: 'modify_at' }
                ];

                attributes.forEach((attr, index) => {
                    const headerCell = document.createElement('th');
                    headerCell.className = `header-cell header-cell-${index + 1}`;

                    // åˆ›å»ºå¯æ»šåŠ¨çš„ div
                    const headerDiv = document.createElement('div');
                    headerDiv.textContent = attr.label; // æ˜¾ç¤º label
                    enableDragScroll(headerDiv);
                    headerCell.appendChild(headerDiv);
                    headerRow.appendChild(headerCell);
                });

                // å°†åˆ—åè¡Œæ·»åŠ åˆ°è¡¨æ ¼
                table.appendChild(headerRow);

                // å­˜å‚¨è¢«ä¿®æ”¹çš„æ•°æ®è¡Œ
                let modifiedData = [];

                data.forEach(item => {
                    // åˆ›å»ºå€¼è¡Œ
                    const valueRow = document.createElement('tr');
                    valueRow.className = 'value-row';

                    attributes.forEach((attr, index) => {
                        const valueCell = document.createElement('td');
                        valueCell.className = `value-cell value-cell-${index + 1}`;

                        // åˆ›å»ºå¯æ»šåŠ¨çš„ div
                        const valueDiv = document.createElement('div');
                        let value; // å£°æ˜ value å˜é‡

                        if (attr.field === 'dqe_confirm_inform') {
                            value = `${item.dqe_confirm_at}, ${item.dqe}`;
                        } else if (attr.field === 'rd_confirm_inform') {
                            value = `${item.rd_confirm_at}, ${item.rd}`;
                        } else {
                            value = item[attr.field];
                        }

                        // è·å–"æå‡ºäºº"åˆ—çš„å€¼
                        const responsiblePersonValue = item['tester']; // å‡è®¾ 'responsiblePerson' ä¸ºæå‡ºäººåˆ—çš„å­—æ®µå


                        if (index === 0 || index === 1 || index === 19 || index === 6 || index === 7 || index === 8 || index === 35
                            || index ===36 || index === 37 || index === 38 || index === 39) { // åºå·ï¼Œé—®é¢˜å›¾ç‰‡,å½“å‰çŠ¶æ€,åˆ›å»ºæ—¶é—´,å†å²ID
                            if(index === 19){
                                if (value && (String(value).includes('/imageDirectory/') || String(value).includes('/issuespath/'))) {
                                    // åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆå›¾ç‰‡è·¯å¾„
                                    const img = document.createElement('img');
                                    img.src = value.replace(/#/g, '%23') + '?t=' + new Date().getTime();  // é˜²æ­¢ç¼“å­˜ï¼Œè¿½åŠ æ—¶é—´æˆ³
                                    img.style.maxWidth = '100px';  // è®¾ç½®å›¾ç‰‡æœ€å¤§å®½åº¦
                                    img.style.maxHeight = '80px';  // è®¾ç½®å›¾ç‰‡æœ€å¤§é«˜åº¦
                                    img.style.cursor = 'pointer';  // è®¾ç½®ç‚¹å‡»æ ·å¼

                                    // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
                                    img.onerror = function () {
                                        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', img.src);
                                        img.style.display = 'none';  // éšè—åŠ è½½å¤±è´¥çš„å›¾ç‰‡
                                    };

                                    // ç‚¹å‡»å›¾ç‰‡æ˜¾ç¤ºå¤§å›¾
                                    img.addEventListener('click', function () {
                                        showImageModal(img.src,sampleId,item.id,modifiedData, responsiblePersonValue);
                                    });

                                    valueDiv.appendChild(img);  // æ·»åŠ å›¾ç‰‡åˆ° valueDiv ä¸­
                                }else{
                                    const uploadText = document.createElement('div');
                                    uploadText.textContent = 'ä¸Šä¼ å›¾ç‰‡';  // æ˜¾ç¤º"ä¸Šä¼ å›¾ç‰‡"
                                    uploadText.style.cursor = 'pointer';  // è®¾ç½®ç‚¹å‡»æ ·å¼
                                    uploadText.style.color = '#8a4e07';  // è®¾ç½®æ–‡æœ¬é¢œè‰²

                                    if(responsiblePersonValue === username && !isEditDisabled){
                                        // ç‚¹å‡»æ—¶è§¦å‘é€‰æ‹©æ–‡ä»¶çš„æ–¹æ³•
                                        uploadText.addEventListener('click', function () {
                                            const input = document.createElement('input');
                                            input.type = 'file';
                                            input.accept = 'image/*';  // ä»…æ¥å—å›¾ç‰‡ç±»å‹
                                            // é€‰æ‹©æ–‡ä»¶åä¸Šä¼ 
                                            input.addEventListener('change', function (event) {
                                                const file = event.target.files[0];
                                                if (file) {
                                                    // åœ¨è¿™é‡Œè°ƒç”¨ä¸Šä¼ æ–‡ä»¶çš„æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ sampleId
                                                    uploadImage(file, sampleId , item.id,modifiedData);
                                                }
                                            });

                                            input.click();  // è‡ªåŠ¨è§¦å‘æ–‡ä»¶é€‰æ‹©
                                        });
                                    }

                                    valueDiv.appendChild(uploadText);  // æ·»åŠ "ä¸Šä¼ å›¾ç‰‡"åˆ° valueDiv ä¸­
                                }
                            }else if(index === 7){
                                // å®šä¹‰éœ€è¦è½¬æ¢ä¸ºä¸‹æ‹‰æ¡†çš„é€‰é¡¹
                                let validOptions = ['OPEN', 'CLOSED', 'FOLLOW UP', 'å¾…ç¡®å®š'];

                                // å°†ä¼ é€’è¿‡æ¥çš„å€¼è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬æ¢CLOSEä¸ºCLOSED
                                let normalizedValue = String(value).toUpperCase();

                                if (normalizedValue === 'CLOSE') {
                                    normalizedValue = 'CLOSED';  // è‡ªåŠ¨å°†CLOSEè½¬æ¢ä¸ºCLOSED
                                }

                                // å¦‚æœå€¼ä¸åœ¨æœ‰æ•ˆé€‰é¡¹å†…ï¼Œå°†å…¶æ·»åŠ åˆ°é€‰é¡¹ä¸­
                                if (!validOptions.includes(normalizedValue) && normalizedValue.trim() !== '') {
                                    validOptions.push(normalizedValue);
                                } else if (normalizedValue.trim() === '') {
                                    normalizedValue = 'å¾…ç¡®å®š';
                                }

                                // åˆ›å»ºä¸‹æ‹‰æ¡†
                                const select = document.createElement('select');

                                // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
                                    if (normalizedValue === option) {
                                        optionElement.selected = true;
                                    }

                                    select.appendChild(optionElement);
                                });

                                // å¦‚æœç¦ç”¨ç¼–è¾‘ï¼Œç¦ç”¨ä¸‹æ‹‰æ¡†
                                if (isEditDisabled) {
                                    select.disabled = true;
                                    select.style.opacity = '0.5';
                                    select.style.cursor = 'not-allowed';
                                }

                                // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                                select.addEventListener('change', function () {
                                    // å¦‚æœç¦ç”¨çŠ¶æ€ï¼Œä¸å…è®¸ä¿®æ”¹
                                    if (isEditDisabled) {
                                        return;
                                    }
                                    
                                    const selectedValue = select.value;
                                    console.log('çŠ¶æ€å·²æ›´æ–°ä¸º:', selectedValue);  // å¤„ç†ä¸‹æ‹‰æ¡†å€¼çš„å˜åŒ–

                                    // å¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸åŒï¼Œæ ‡è®°ä¸ºå·²ä¿®æ”¹
                                    if (selectedValue !== normalizedValue) {
                                        item[attr.field] = selectedValue;
                                        if (!modifiedData.includes(item)) {
                                            modifiedData.push(item); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                        }
                                    }
                                });

                                valueDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° valueDiv ä¸­
                            }else if(index === 8){
                                // å®šä¹‰éœ€è¦è½¬æ¢ä¸ºä¸‹æ‹‰æ¡†çš„é€‰é¡¹
                                let validOptions = ['ç”µæ°”æ€§èƒ½', 'å…¼å®¹æ€§','å¯é æ€§', 'å·¥è‰º' ,'å¾…ç¡®å®š'];

                                // å°†ä¼ é€’è¿‡æ¥çš„å€¼è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬æ¢CLOSEä¸ºCLOSED
                                let normalizedValue = String(value);

                                // å¦‚æœå€¼ä¸åœ¨æœ‰æ•ˆé€‰é¡¹å†…ï¼Œå°†å…¶æ·»åŠ åˆ°é€‰é¡¹ä¸­
                                if (!validOptions.includes(normalizedValue) && normalizedValue.trim() !== '') {
                                    validOptions.push(normalizedValue);
                                } else if (normalizedValue.trim() === '') {
                                    normalizedValue = 'å¾…ç¡®å®š';
                                }

                                // åˆ›å»ºä¸‹æ‹‰æ¡†
                                const select = document.createElement('select');

                                // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
                                    if (normalizedValue === option) {
                                        optionElement.selected = true;
                                    }

                                    select.appendChild(optionElement);
                                });

                                // å¦‚æœç¦ç”¨ç¼–è¾‘ï¼Œç¦ç”¨ä¸‹æ‹‰æ¡†
                                if (isEditDisabled) {
                                    select.disabled = true;
                                    select.style.opacity = '0.5';
                                    select.style.cursor = 'not-allowed';
                                }

                                // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                                select.addEventListener('change', function () {
                                    // å¦‚æœç¦ç”¨çŠ¶æ€ï¼Œä¸å…è®¸ä¿®æ”¹
                                    if (isEditDisabled) {
                                        return;
                                    }
                                    
                                    const selectedValue = select.value;
                                    console.log('çŠ¶æ€å·²æ›´æ–°ä¸º:', selectedValue);  // å¤„ç†ä¸‹æ‹‰æ¡†å€¼çš„å˜åŒ–

                                    // å¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸åŒï¼Œæ ‡è®°ä¸ºå·²ä¿®æ”¹
                                    if (selectedValue !== normalizedValue) {
                                        item[attr.field] = selectedValue;
                                        if (!modifiedData.includes(item)) {
                                            modifiedData.push(item); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                        }
                                    }
                                });

                                valueDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° valueDiv ä¸­
                            } else if(index === 6){
                                // å®šä¹‰éœ€è¦è½¬æ¢ä¸ºä¸‹æ‹‰æ¡†çš„ç­‰çº§é€‰é¡¹
                                let validOptions = ['S', 'A', 'B', 'C', 'D', 'å¾…ç¡®å®š'];

                                // å°†ä¼ é€’è¿‡æ¥çš„å€¼è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ï¼ˆå¤§å†™ï¼‰
                                let normalizedValue = String(value).toUpperCase();

                                // å¦‚æœå€¼ä¸åœ¨æœ‰æ•ˆé€‰é¡¹å†…ï¼Œå°†å…¶æ·»åŠ åˆ°é€‰é¡¹ä¸­
                                if (!validOptions.includes(normalizedValue) && normalizedValue.trim() !== '') {
                                    validOptions.push(normalizedValue);
                                } else if (normalizedValue.trim() === '') {
                                    normalizedValue = 'å¾…ç¡®å®š';
                                }

                                // åˆ›å»ºä¸‹æ‹‰æ¡†
                                const select = document.createElement('select');

                                // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
                                    if (normalizedValue === option) {
                                        optionElement.selected = true;
                                    }

                                    select.appendChild(optionElement);
                                });

                                // å¦‚æœç¦ç”¨ç¼–è¾‘ï¼Œç¦ç”¨ä¸‹æ‹‰æ¡†
                                if (isEditDisabled) {
                                    select.disabled = true;
                                    select.style.opacity = '0.5';
                                    select.style.cursor = 'not-allowed';
                                }

                                // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                                select.addEventListener('change', function () {
                                    // å¦‚æœç¦ç”¨çŠ¶æ€ï¼Œä¸å…è®¸ä¿®æ”¹
                                    if (isEditDisabled) {
                                        return;
                                    }
                                    
                                    const selectedValue = select.value;
                                    console.log('ç­‰çº§å·²æ›´æ–°ä¸º:', selectedValue);  // å¤„ç†ä¸‹æ‹‰æ¡†å€¼çš„å˜åŒ–

                                    // å¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸åŒï¼Œæ ‡è®°ä¸ºå·²ä¿®æ”¹
                                    if (selectedValue !== normalizedValue) {
                                        item[attr.field] = selectedValue;
                                        if (!modifiedData.includes(item)) {
                                            modifiedData.push(item); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                        }
                                    }
                                });

                                valueDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° valueDiv ä¸­
                            }else if(index === 1){
                                // å®šä¹‰éœ€è¦è½¬æ¢ä¸ºä¸‹æ‹‰æ¡†çš„ç­‰çº§é€‰é¡¹
                                let validOptions = ['äº§å“', 'é¡¹ç›®', 'ç»“æ„', 'ID', 'ç ”å‘' ,'DQE' ,'SQE' ,'CQE','å¾…ç¡®å®š'];

                                // å°†ä¼ é€’è¿‡æ¥çš„å€¼è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ï¼ˆå¤§å†™ï¼‰
                                let normalizedValue = String(value).toUpperCase();

                                // å¦‚æœå€¼ä¸åœ¨æœ‰æ•ˆé€‰é¡¹å†…ï¼Œå°†å…¶æ·»åŠ åˆ°é€‰é¡¹ä¸­
                                if (!validOptions.includes(normalizedValue) && normalizedValue.trim() !== '') {
                                    validOptions.push(normalizedValue);
                                } else if (normalizedValue.trim() === '') {
                                    normalizedValue = 'å¾…ç¡®å®š';
                                }

                                // åˆ›å»ºä¸‹æ‹‰æ¡†
                                const select = document.createElement('select');

                                // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                                validOptions.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option;

                                    // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
                                    if (normalizedValue === option) {
                                        optionElement.selected = true;
                                    }

                                    select.appendChild(optionElement);
                                });

                                // å¦‚æœç¦ç”¨ç¼–è¾‘ï¼Œç¦ç”¨ä¸‹æ‹‰æ¡†
                                if (isEditDisabled) {
                                    select.disabled = true;
                                    select.style.opacity = '0.5';
                                    select.style.cursor = 'not-allowed';
                                }

                                // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                                select.addEventListener('change', function () {
                                    // å¦‚æœç¦ç”¨çŠ¶æ€ï¼Œä¸å…è®¸ä¿®æ”¹
                                    if (isEditDisabled) {
                                        return;
                                    }
                                    
                                    const selectedValue = select.value;

                                    // å¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸åŒï¼Œæ ‡è®°ä¸ºå·²ä¿®æ”¹
                                    if (selectedValue !== normalizedValue) {
                                        item[attr.field] = selectedValue;
                                        if (!modifiedData.includes(item)) {
                                            modifiedData.push(item); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                        }
                                    }
                                });

                                valueDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° valueDiv ä¸­
                            } else if(index === 35 || index === 39){
                                if(value){
                                    const valueText = document.createElement('div');
                                    valueText.textContent = value.replace("T"," ");
                                    valueText.style.color = '#8a4e07'; // è®¾ç½®ä¸å…è®¸ä¿®æ”¹çš„åˆ—çš„å­—ä½“é¢œè‰²
                                    valueDiv.appendChild(valueText);
                                }

                            }else if(index === 0){//åºå·åˆ—ï¼ŒåŠ ä¸ªåˆ é™¤è¯¥é—®é¢˜ç‚¹çš„æ–¹æ³•
                                const valueText = document.createElement('div');
                                valueText.textContent = (value !== undefined && value !== null) ? value : 'æ— ';
                                valueText.style.color = '#2954e3'; // è®¾ç½®ä¸å…è®¸ä¿®æ”¹çš„åˆ—çš„å­—ä½“é¢œè‰²

                                valueText.addEventListener('click', () => {
                                    // å¦‚æœç¦ç”¨çŠ¶æ€ï¼Œä¸å…è®¸åˆ é™¤
                                    if (isEditDisabled) {
                                        alert('DQEå·²å®¡æ ¸å®Œæˆï¼Œä¸å…è®¸ä¿®æ”¹');
                                        return;
                                    }
                                    
                                    confirm(`ç¡®å®šåˆ é™¤IDä¸º${value}çš„é—®é¢˜ç‚¹å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼`)
                                        .then((confirmation) => {
                                            if (confirmation) {
                                                alert(item.tester )
                                                // æ£€æŸ¥æµ‹è¯•äººæ˜¯å¦ä¸º"/"ï¼Œå¦‚æœæ˜¯åˆ™å…è®¸åˆ é™¤
                                                if (item.tester === "/" || item.tester === null || item.tester === "" || (username && username === item.tester)) {
                                                    // å‘é€åˆ é™¤è¯·æ±‚åˆ°æ§åˆ¶å±‚
                                                    fetch(`/problemMoudle/deleteProblemById/${value}/${encodeURIComponent(username)}`)
                                                        .then(response => {
                                                            if (response.ok) {
                                                                alert(`IDä¸º${value}çš„é—®é¢˜ç‚¹å·²æˆåŠŸåˆ é™¤`);
                                                                // å¯åœ¨æ­¤å¤„æ›´æ–°ç•Œé¢ï¼Œä¾‹å¦‚ç§»é™¤è¯¥é—®é¢˜ç‚¹çš„æ˜¾ç¤º
                                                                editClickBtn(sampleId);
                                                            } else {
                                                                alert("åˆ é™¤å¤±è´¥ï¼Œé—®é¢˜ç‚¹æœªæ‰¾åˆ°");
                                                            }
                                                        })
                                                        .catch(error => console.error("è¯·æ±‚å¤±è´¥:", error));
                                                } else {
                                                    alert("ä¸èƒ½åˆ é™¤ä¸æ˜¯è‡ªå·±æå‡ºçš„é—®é¢˜ç‚¹");
                                                }
                                            }
                                        });
                                });

                                valueDiv.appendChild(valueText);
                            } else {
                                // å¦‚æœä¸æ˜¯å›¾ç‰‡è·¯å¾„ï¼Œæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
                                const valueText = document.createElement('div');
                                valueText.textContent = (value !== undefined && value !== null) ? value : 'æ— ';
                                valueText.style.color = '#8a4e07'; // è®¾ç½®ä¸å…è®¸ä¿®æ”¹çš„åˆ—çš„å­—ä½“é¢œè‰²
                                valueDiv.appendChild(valueText);
                            }
                        }else if (index >= 2 && index <= 5) {
                            // DQEç¡®è®¤åˆ°ç ”å‘æ„è§ä¿¡æ¯ä¹‹é—´åˆ—çš„å¤„ç†å¦‚ä¸‹
                            if (attr.field === 'dqe_confirm' || attr.field === 'rd_confirm') {
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.checked = item[attr.field] === 'ç¡®è®¤'; // æ ¹æ®éœ€è¦è®¾å®šé»˜è®¤å€¼

                                if(attr.field === 'dqe_confirm'){
                                    if (job==='DQE') {
                                        checkbox.setAttribute('data-dqe', 'true');
                                    }else if(job==="rd" || job==="tester"){
                                        checkbox.setAttribute('data-dqe', 'false');
                                    }

                                }else{
                                    if (job==='DQE' || job==="tester") {
                                        checkbox.setAttribute('data-rd', 'false');
                                    }else if(job ==="rd" ){
                                        checkbox.setAttribute('data-rd', 'true');
                                    }
                                }

                                // å¦‚æœç¦ç”¨ç¼–è¾‘ï¼Œç¦ç”¨å¤é€‰æ¡†
                                if (isEditDisabled) {
                                    checkbox.disabled = true;
                                    checkbox.style.opacity = '0.5';
                                    checkbox.style.cursor = 'not-allowed';
                                    checkbox.style.backgroundColor = '#f0f0f0';
                                    checkbox.style.border = '1px solid #ccc';
                                } else {
                                    // ç›‘å¬å¤é€‰æ¡†å˜åŒ–äº‹ä»¶
                                    if ((attr.field === 'dqe_confirm' && checkbox.getAttribute('data-dqe') === 'true') ||
                                        (attr.field === 'rd_confirm' && checkbox.getAttribute('data-rd') === 'true')) {
                                        // ç›‘å¬å¤é€‰æ¡†å˜åŒ–äº‹ä»¶
                                        checkbox.addEventListener('change', function () {
                                            const newValue = checkbox.checked ? 'ç¡®è®¤' : 'æœªç¡®è®¤'; // æ›´æ–°çŠ¶æ€
                                            if (newValue !== item[attr.field]) {
                                                item[attr.field] = newValue; // æ›´æ–°æ•°æ®å¯¹è±¡

                                                // ç¡®ä¿ modifiedData ä¸­æ²¡æœ‰é‡å¤é¡¹
                                                if (!modifiedData.some(existingItem => existingItem.id === item.id)) {
                                                    modifiedData.push(item); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                                }
                                            }
                                        });
                                    } else {
                                        checkbox.disabled = true; // ç¦ç”¨å¤é€‰æ¡†
                                        checkbox.style.opacity = '1'; // è®¾ä¸ºä¸é€æ˜
                                        checkbox.style.cursor = 'not-allowed'; // æ›´æ”¹é¼ æ ‡æŒ‡é’ˆæ ·å¼
                                        checkbox.style.backgroundColor = '#f0f0f0'; // è®¾ç½®èƒŒæ™¯é¢œè‰²
                                        checkbox.style.border = '1px solid #ccc'; // è®¾ç½®è¾¹æ¡†
                                    }
                                }

                                valueDiv.appendChild(checkbox);
                            }else{
                                if (value) {
                                    let displayText1 = ''; // ç¬¬ä¸€è¡Œæ˜¾ç¤ºçš„æ–‡æœ¬
                                    let displayText2 = ''; // ç¬¬äºŒè¡Œæ˜¾ç¤ºçš„æ–‡æœ¬

                                    if (attr.field === 'dqe_confirm_inform') {
                                        if (item.dqe_review_at && item.dqe) {
                                            displayText1 = item.dqe_review_at; // ç¬¬ä¸€è¡Œ
                                            displayText2 = item.dqe; // ç¬¬äºŒè¡Œ
                                        }
                                    } else if (attr.field === 'rd_confirm_inform') {
                                        if (item.rd_review_at && item.rd) {
                                            displayText1 = item.rd_review_at; // ç¬¬ä¸€è¡Œ
                                            displayText2 = item.rd; // ç¬¬äºŒè¡Œ
                                        }
                                    } else {
                                        displayText1 = value; // é»˜è®¤ä½¿ç”¨åŸå§‹å€¼ä¸ºç¬¬ä¸€è¡Œ
                                    }

                                    // åˆ›å»ºç¬¬ä¸€è¡Œå’Œç¬¬äºŒè¡Œçš„ div
                                    if (displayText1) {
                                        const valueText1 = document.createElement('div');
                                        valueText1.textContent = displayText1.replace("T", " "); // æ›¿æ¢ T ä¸ºç©ºæ ¼
                                        valueText1.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                                        valueDiv.appendChild(valueText1);
                                    }

                                    if (displayText2) {
                                        const valueText2 = document.createElement('div');
                                        valueText2.textContent = displayText2.replace("T", " "); // æ›¿æ¢ T ä¸ºç©ºæ ¼
                                        valueText2.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                                        valueDiv.appendChild(valueText2);
                                    }
                                }
                            }

                        } else {
                            createEditableSpan(value, item, attr, modifiedData, valueDiv, responsiblePersonValue, isEditDisabled);
                        }

                        enableDragScroll(valueDiv);

                        valueCell.appendChild(valueDiv);
                        valueRow.appendChild(valueCell);
                    });

                    table.appendChild(valueRow);
                });

                // å°†è¡¨æ ¼æ·»åŠ åˆ°è¡¨æ ¼å®¹å™¨ä¸­
                tableContainer.appendChild(table);
                contentDiv.appendChild(tableContainer);

                // åˆ›å»ºä¿å­˜æŒ‰é’®
                const saveButton = document.createElement('button');
                saveButton.textContent = 'ä¿å­˜\nä¿®æ”¹'; // ä½¿ç”¨æ¢è¡Œç¬¦åˆ†ä¸¤è¡Œæ˜¾ç¤ºæ–‡æœ¬
                saveButton.className = 'save-button'; // æ·»åŠ ç±»å
                
                // å¦‚æœ checkJudge ä¸º trueï¼Œç¦ç”¨ä¿å­˜æŒ‰é’®
                if (isEditDisabled) {
                    // saveButton.disabled = true;
                    saveButton.style.opacity = '0.5';
                    saveButton.style.cursor = 'not-allowed';
                    saveButton.title = 'å½“å‰çŠ¶æ€ä¸å…è®¸ç¼–è¾‘';
                }

                contentDiv.appendChild(saveButton);

                saveButton.addEventListener('click', function () {
                    // å¦‚æœç¦ç”¨çŠ¶æ€ï¼Œä¸å…è®¸ä¿å­˜
                    if (isEditDisabled) {
                        alert('DQEå·²å®¡æ ¸å®Œæˆï¼Œä¸å…è®¸ä¿®æ”¹');
                        return;
                    }
                    saveChanges(modifiedData,sampleId, true); // åªå‘é€ä¿®æ”¹çš„æ•°æ®
                });

                // åˆ›å»ºæ–°å¢é—®é¢˜æŒ‰é’®
                const addButton = document.createElement('button');
                addButton.textContent = 'æ–°å¢\né—®é¢˜';
                addButton.className = 'add-button'; // ç»™æ–°å¢é—®é¢˜æŒ‰é’®æ·»åŠ ç±»å
                
                // å¦‚æœ checkJudge ä¸º trueï¼Œç¦ç”¨æ–°å¢é—®é¢˜æŒ‰é’®
                if (isEditDisabled) {
                    // addButton.disabled = true;
                    addButton.style.opacity = '0.5';
                    addButton.style.cursor = 'not-allowed';
                    addButton.title = 'å½“å‰çŠ¶æ€ä¸å…è®¸ç¼–è¾‘';
                }
                
                contentDiv.appendChild(addButton);

                // æ–°å¢é—®é¢˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                addButton.addEventListener('click', function () {
                    // å¦‚æœç¦ç”¨çŠ¶æ€ï¼Œä¸å…è®¸æ–°å¢
                    if (isEditDisabled) {
                        alert('DQEå·²å®¡æ ¸å®Œæˆï¼Œä¸å…è®¸ä¿®æ”¹');
                        return;
                    }
                    addNewRow(sampleId,attributes,modifiedData,table);
                });


                // æ–°å¢ä¸€ä¸ªå¯¼å‡ºé—®é¢˜ç‚¹çš„æŒ‰é’®
                const exportButton = document.createElement('button');
                exportButton.textContent = 'å¯¼å‡º\né—®é¢˜ç‚¹'; // æŒ‰é’®åç§°
                exportButton.className = 'export-button'; // ç»™æŒ‰é’®æ·»åŠ ç±»å
                contentDiv.appendChild(exportButton);


                exportButton.addEventListener('click', () => {
                    // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²ç¦ç”¨
                    if (exportButton.disabled) {
                        return; // å¦‚æœå·²ç¦ç”¨ï¼Œä¸æ‰§è¡Œåç»­ä»£ç 
                    }

                    // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                    exportButton.disabled = true;
                    exportProblemXlsx(data,exportButton);
                });

                // æ–°å¢ä¸€ä¸ªå¯¼å‡ºæµ‹è¯•æŠ¥å‘Šçš„æŒ‰é’®
                const exportFileBtn = document.createElement('button');
                exportFileBtn.textContent = 'å¯¼å‡º\næµ‹è¯•æŠ¥å‘Š'; // æŒ‰é’®åç§°
                exportFileBtn.className = 'exportFile-button'; // ç»™æŒ‰é’®æ·»åŠ ç±»å
                contentDiv.appendChild(exportFileBtn);

                exportFileBtn.addEventListener('click', () => {
                    exportFile(sampleId);
                });


                // ESCå¿«æ·é”®é€€å‡ºç‚¹å‡»çš„æ¨¡æ€æ¡†
                modal.style.display = 'block';

                // å®šä¹‰å¤„ç† ESC é”®çš„å‡½æ•°
                const handleEscapeKey = (event) => {
                    if (event.key === 'Escape') {
                        closeModal();
                    }
                };

                // æ·»åŠ  ESC é”®äº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('keydown', handleEscapeKey);

                // å…³é—­æ¨¡æ€æ¡†çš„å‡½æ•°
                const closeModal = () => {
                    modal.style.display = 'none';
                    // åªæœ‰åœ¨æ²¡æœ‰æ­£åœ¨æœç´¢æ—¶æ‰æ‰§è¡Œæœç´¢
                    // if (!isSearching) {
                    //     isSearching = true; // è®¾ç½®æœç´¢çŠ¶æ€ä¸ºçœŸ
                    //     performSearch(globalFormData);
                    //
                    //     setTimeout(() => {
                    //         isSearching = false; // é‡ç½®æœç´¢çŠ¶æ€
                    //     }, 2000); // è®¾ç½®é—´éš”æ—¶é—´ï¼Œä¾‹å¦‚2000æ¯«ç§’
                    // }
                    // ç§»é™¤ ESC é”®äº‹ä»¶ç›‘å¬å™¨
                    document.removeEventListener('keydown', handleEscapeKey);
                };

                const span = document.getElementsByClassName('close-problem')[0];
                if (span) {
                    span.onclick = closeModal;
                }

                // é‡ç½®ç¼–è¾‘çŠ¶æ€
                isEditing = false; // åœ¨è¯·æ±‚å®Œæˆåé‡ç½®çŠ¶æ€

            })
            .catch(error => {
                alert(error.message);

                // é‡ç½®ç¼–è¾‘çŠ¶æ€
                isEditing = false; // åœ¨è¯·æ±‚å®Œæˆåé‡ç½®çŠ¶æ€
            });
    }


    function enableDragScroll(element) {
        let isDragging = false;
        let startX, scrollLeft;

        element.addEventListener('mousedown', (e) => {
            isDragging = true;
            element.style.cursor = 'grabbing';
            startX = e.pageX - element.offsetLeft;
            scrollLeft = element.scrollLeft;
        });

        element.addEventListener('mouseleave', () => {
            isDragging = false;
            element.style.cursor = 'grab';
        });

        element.addEventListener('mouseup', () => {
            isDragging = false;
            element.style.cursor = 'grab';
        });

        element.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - element.offsetLeft;
            const walk = (x - startX) * 2; // æ»šåŠ¨é€Ÿåº¦
            element.scrollLeft = scrollLeft - walk;
        });
    }

    function createEditableSpan(value, item, attr, modifiedData, valueDiv, responsiblePersonValue, isEditDisabled) {
        const div = document.createElement('div');
        div.textContent = value || 'æ— ';  // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå±•ç¤ºä¸º 'æ— '

        // è®¾ç½® CSS æ ·å¼ï¼Œè®©å…¶æ”¯æŒæ¢è¡Œæ˜¾ç¤ºï¼Œå¹¶æ§åˆ¶å®½åº¦
        div.style.whiteSpace = 'pre-wrap';  // ä¿æŒæ–‡æœ¬å†…å®¹æ¢è¡Œ
        div.style.wordWrap = 'break-word';  // è¶…å‡ºæ—¶æ¢è¡Œ
        div.style.maxWidth = '200px';  // è®¾ç½®æœ€å¤§å®½åº¦ï¼Œé¿å…å†…å®¹è¿‡é•¿æ—¶æº¢å‡º
        div.style.width = '100%';  // ç¡®ä¿å®½åº¦å æ»¡çˆ¶å®¹å™¨
        div.style.overflowWrap = 'break-word'; // ç¡®ä¿é•¿å•è¯æˆ–URLæ¢è¡Œ

        // å½“å‰ç¼–è¾‘å€¼
        let currentEditValue = value || '';

        // å¦‚æœç¦ç”¨ç¼–è¾‘æˆ–ä¸æ˜¯å½“å‰ç”¨æˆ·ï¼Œä¸å…è®¸ç¼–è¾‘
        if(responsiblePersonValue === username && !isEditDisabled){
            div.addEventListener('click', function () {
                // åˆ›å»º textarea
                const textarea = document.createElement('textarea');

                // è·å– div çš„é«˜åº¦ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ textarea
                const divHeight = div.offsetHeight;  // è·å– div çš„é«˜åº¦
                textarea.style.height = `${divHeight}px`;  // è®¾ç½® textarea é«˜åº¦ä¸ div ä¸€è‡´

                // å…¶ä»–æ ·å¼è®¾ç½®
                textarea.style.width = '100%';  // ç¡®ä¿æ–‡æœ¬æ¡†çš„å®½åº¦ä¸çˆ¶å®¹å™¨ç›¸åŒ
                textarea.style.minWidth = '120px';  // è®¾ç½®æœ€å°å®½åº¦ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯è§
                textarea.style.minHeight = '50px';  // è®¾ç½®æœ€å°å®½åº¦ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯è§
                textarea.style.maxWidth = '200px'; // è®¾ç½®æœ€å¤§å®½åº¦ï¼Œé¿å…è¾“å…¥æ¡†è¿‡å®½
                textarea.value = currentEditValue; // ä½¿ç”¨å½“å‰ç¼–è¾‘å€¼

                // æ·»åŠ ä¸€äº›æ ·å¼ï¼Œé¿å…é€‰æ‹©åŒºåŸŸä¸æ˜æ˜¾
                textarea.style.outline = 'none';  // å»é™¤ç„¦ç‚¹æ—¶çš„å¤–è¾¹æ¡†
                textarea.style.backgroundColor = 'white';  // ç¡®ä¿èƒŒæ™¯æ˜¯ç™½è‰²
                textarea.style.color = 'black';  // ç¡®ä¿æ–‡æœ¬é¢œè‰²æ˜¯é»‘è‰²
                textarea.style.border = '1px solid #ccc';  // è®¾ç½®è¾¹æ¡†æ ·å¼
                textarea.style.padding = '5px';  // è®¾ç½®å†…è¾¹è·ï¼Œä½¿æ–‡æœ¬æœ‰ä¸€å®šçš„ç©ºé—´

                textarea.addEventListener('mousedown', function (event) {
                    // å¦‚æœç”¨æˆ·æŒ‰ä½é¼ æ ‡æ‹–åŠ¨çš„æ˜¯éè¾“å…¥ç›¸å…³å†…å®¹ï¼Œå¯ä»¥åšé™åˆ¶ï¼Œä½†è¿™é‡Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
                    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                });

                // æ·»åŠ æ‹–åŠ¨é™åˆ¶ï¼Œç¡®ä¿ textarea ä¸ä¼šç§»åŠ¨,è§£å†³ç¼–è¾‘æ¡†æ‹–åŠ¨çš„æ—¶å€™ä¹Ÿä¼šç§»åŠ¨çš„bug
                textarea.addEventListener('dragstart', function (event) {
                    event.preventDefault(); // ç¦æ­¢æ‹–åŠ¨è¡Œä¸º
                });

                // ç›‘å¬å¤±ç„¦äº‹ä»¶
                textarea.addEventListener('blur', function () {
                    const newValue = textarea.value.trim() || '';  // æ–°å€¼ä¸ºç©ºå­—ç¬¦ä¸²åˆ™è½¬æ¢ä¸ºç©º

                    // å¦‚æœæ–°å€¼å’Œæ—§å€¼éƒ½ä¸ºç©ºï¼Œæˆ–è€…å®ƒä»¬ç›¸ç­‰ï¼Œåˆ™ä¸æ›´æ–°
                    if (newValue !== currentEditValue) {
                        currentEditValue = newValue;  // æ›´æ–°å½“å‰ç¼–è¾‘å€¼
                        div.textContent = currentEditValue || 'æ— ';  // æ›´æ–° div çš„å†…å®¹
                        // æ›´æ–° item çš„å€¼ï¼Œå¹¶æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                        item[attr.field] = currentEditValue;
                        if (!modifiedData.includes(item)) {
                            modifiedData.push(item);  // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                        }
                    }

                    // å°† textarea æ›¿æ¢å› div
                    valueDiv.replaceChild(div, textarea);
                });

                // å°† div æ›¿æ¢ä¸º textarea
                valueDiv.replaceChild(textarea, div);
                textarea.focus(); // èšç„¦åˆ° textareaï¼Œç”¨æˆ·å¯ä»¥å¼€å§‹ç¼–è¾‘
            });
        }


        valueDiv.appendChild(div);
    }


    function saveChanges(modifiedData,sampleId, isEditClick) {
        // if(!username){
        //     alert("ç”¨æˆ·åä¸å­˜åœ¨ï¼Œéº»çƒ¦é‡æ–°è¿›å…¥æœ¬åº”ç”¨!"); // å¯é€‰çš„è­¦å‘Šæç¤º
        //     window.location.href = 'http://219.134.191.195:64000'; // å°†'/login'æ›¿æ¢ä¸ºä½ çš„ç™»å½•æ§åˆ¶å™¨çš„ URL
        //     return;
        // }

        if (modifiedData.length === 0) {
            alert('æ²¡æœ‰ä¿®æ”¹çš„å†…å®¹éœ€è¦ä¿å­˜ã€‚');
            return;
        }

        fetch(`/problemMoudle/saveChanges?sampleId=${sampleId}&username=${encodeURIComponent(username)}&job=${job}`,{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(modifiedData) // åªå‘é€ä¿®æ”¹çš„ JSON æ•°ç»„
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                }
                return response.text(); // è¿”å›æ–‡æœ¬å“åº”
            })
            .then(responseText => {
                // console.log('ä¿å­˜æˆåŠŸ:', responseText); // æ‰“å°æˆåŠŸæ¶ˆæ¯
                alert('ä¿®æ”¹æˆåŠŸï¼Œå·²åŒæ­¥åˆ°æ•°æ®åº“');
                // åˆ·æ–°å¼¹å‡ºæ¡†ä¸­çš„æ•°æ®
                if(isEditClick){
                    editClickBtn(sampleId);
                }
            })
            .catch(error => {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚');
            });
    }

    function addNewRow(sampleId,attributes,modifiedData,table) {
        // å‘é€ AJAX è¯·æ±‚ä»¥è·å–æ•°æ®ï¼Œå°† sampleId ä½œä¸ºæŸ¥è¯¢å‚æ•°
        fetch(`/problemMoudle/addNewRow?sampleId=${sampleId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                }
                return response.json();
            })
            .then(data => {
                // å‡è®¾åç«¯è¿”å›çš„æ•°æ®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè·å–ç¬¬ä¸€ä¸ªå¯¹è±¡
                const sample = data;  // è¿™é‡Œå‡è®¾è¿”å›çš„æ•°ç»„åªæœ‰ä¸€è¡Œæ•°æ®ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

                const newRow = document.createElement('tr');
                newRow.className = 'value-row';

                // åˆ›å»ºæ–°çš„æ•°æ®è¡Œ
                const newItem = {};

                // ç»™æ¯ä¸€è¡Œæ•°æ®ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ IDï¼Œç”¨æ¥æ ‡è¯†å¹¶åˆ é™¤
                const uniqueId = Date.now();  // ä»¥å½“å‰æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ IDï¼ˆä½ ä¹Ÿå¯ä»¥ç”¨å…¶ä»–æ–¹å¼ç”Ÿæˆå”¯ä¸€ IDï¼‰
                newItem.uniqueId = uniqueId;  // å°†å”¯ä¸€ ID ä¿å­˜åˆ° newItem ä¸­
                newRow.dataset.uniqueId = uniqueId; // åŒæ—¶å°†å”¯ä¸€ ID ä¿å­˜åˆ°è¡Œçš„è‡ªå®šä¹‰å±æ€§ä¸­

                // éå† attributes æ•°ç»„ï¼Œå°†æ¯ä¸ªå­—æ®µå¯¹åº”çš„æ•°æ®æ’å…¥åˆ°è¡¨æ ¼ä¸­
                attributes.forEach((attr, index) => {
                    const newCell = document.createElement('td');
                    newCell.className = `value-cell value-cell-${index + 1}`;

                    const newDiv = document.createElement('div');

                    // ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯åºå·ï¼Œä¸å…è®¸ä¿®æ”¹
                    if (index === 0) {
                        newDiv.textContent = 'ç‚¹å‡»åˆ é™¤'; // è®¾ç½®ä¸ºè‡ªåŠ¨ç”Ÿæˆçš„æ–‡æœ¬
                        newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²

                        // æ·»åŠ åˆ é™¤åŠŸèƒ½
                        newDiv.addEventListener('click', function () {
                            // ä»è¡¨æ ¼ä¸­åˆ é™¤è¡Œ
                            newRow.remove();

                            // ä½¿ç”¨ uniqueId æŸ¥æ‰¾å¹¶ä» modifiedData ä¸­åˆ é™¤å¯¹åº”çš„é¡¹ç›®
                            const itemIndex = modifiedData.findIndex(item => item.uniqueId === uniqueId);
                            if (itemIndex > -1) {
                                modifiedData.splice(itemIndex, 1); // ä» modifiedData ä¸­ç§»é™¤
                            }
                        });

                        newItem[attr.field] = null; // åºå·ä¸å‚ä¸ä¿®æ”¹
                    } else {
                        // å¤„ç†å­—æ®µæ˜ å°„ï¼šå°† sample_category æ˜ å°„åˆ° sample_stageï¼Œå°† max_histor_id æ˜ å°„åˆ° history_id
                        let value = ''; // åˆå§‹åŒ–å€¼ä¸ºä¸€ä¸ªç©ºå­—ç¬¦ä¸²

                        if (attr.field === 'sample_stage') {
                            value = sample.sample_category || ''; // æ˜ å°„æ ·å“é˜¶æ®µ
                        } else if (attr.field === 'history_id') {
                            value = sample.max_history_id; // æ˜ å°„å†å²ID

                            newDiv.textContent = value;
                            newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                            newItem[attr.field] = value; // åºå·ä¸å‚ä¸ä¿®æ”¹

                        }else if (attr.field === 'full_model') {
                            value = sample.full_model || ''; // æ˜ å°„å†å²ID
                        } else if (attr.field === 'version') {
                            value = sample.version || ''; // æ˜ å°„å†å²ID
                        } else if (attr.field === 'created_at' )  {
                            value = sample.created_at;
                            newDiv.textContent = value;
                            newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                            newItem[attr.field] = value; // åºå·ä¸å‚ä¸ä¿®æ”¹

                        } else if (attr.field === 'created_by') {
                            if (job && job === "tester") {
                                value = "tester";
                            } else if (job && job === "DQE") {
                                value = "dqe";
                            } else if(job && job === "rd"){
                                value = "rd";
                            }else{
                                value = "æœªçŸ¥è§’è‰²";
                            }
                            newDiv.textContent = value;
                            newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                            newItem[attr.field] = null; // åºå·ä¸å‚ä¸ä¿®æ”¹

                        }  else if (attr.field === 'tester') {
                            if (username) {
                                value = username;
                            } else {
                                value = ''; // å…¶ä»–å­—æ®µä¿æŒä¸ºç©ºå­—ç¬¦ä¸²
                            }
                        } else if( index === 2 || index === 4 ){
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = newItem[attr.field] === 'ç¡®è®¤'; // æ ¹æ®éœ€è¦è®¾å®šé»˜è®¤å€¼

                            if (index === 2) {
                                if (job==='DQE') {
                                    checkbox.setAttribute('data-dqe', 'true');
                                } else {
                                    checkbox.setAttribute('data-dqe', 'false');
                                    // è®¾ç½®ä¸ºç¦ç”¨çŠ¶æ€
                                    checkbox.disabled = true;
                                    checkbox.style.opacity = '1'; // è®¾ä¸ºä¸é€æ˜
                                    checkbox.style.cursor = 'not-allowed'; // æ›´æ”¹é¼ æ ‡æŒ‡é’ˆæ ·å¼
                                    checkbox.style.backgroundColor = '#f0f0f0'; // è®¾ç½®èƒŒæ™¯é¢œè‰²
                                    checkbox.style.border = '1px solid #ccc'; // è®¾ç½®è¾¹æ¡†
                                }
                            } else {
                                if (job==='DQE' || job === "tester") {
                                    checkbox.setAttribute('data-rd', 'false');
                                    // è®¾ç½®ä¸ºç¦ç”¨çŠ¶æ€
                                    checkbox.disabled = true;
                                    checkbox.style.opacity = '1'; // è®¾ä¸ºä¸é€æ˜
                                    checkbox.style.cursor = 'not-allowed'; // æ›´æ”¹é¼ æ ‡æŒ‡é’ˆæ ·å¼
                                    checkbox.style.backgroundColor = '#f0f0f0'; // è®¾ç½®èƒŒæ™¯é¢œè‰²
                                    checkbox.style.border = '1px solid #ccc'; // è®¾ç½®è¾¹æ¡†
                                } else if(job === "rd"){
                                    checkbox.setAttribute('data-rd', 'true');
                                }
                            }

                            // ç›‘å¬å¤é€‰æ¡†å˜åŒ–äº‹ä»¶
                            checkbox.addEventListener('change', function () {
                                const newValue = checkbox.checked ? 'ç¡®è®¤' : 'æœªç¡®è®¤'; // æ›´æ–°çŠ¶æ€
                                if (newValue !== newItem[attr.field]) {
                                    newItem[attr.field] = newValue; // æ›´æ–°æ•°æ®å¯¹è±¡

                                    // ç¡®ä¿ modifiedData ä¸­æ²¡æœ‰é‡å¤é¡¹
                                    if (!modifiedData.some(existingItem => existingItem.uniqueId === newItem.uniqueId)) {
                                        modifiedData.push(newItem); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                    }
                                }
                            });

                            newDiv.appendChild(checkbox); // å°†å¤é€‰æ¡†æ·»åŠ åˆ°æ–°å•å…ƒæ ¼
                        }else if (attr.field === 'defect_level') {
                            // å®šä¹‰ç¼ºé™·ç­‰çº§çš„é€‰é¡¹
                            const validOptions = ['S', 'A', 'B', 'C', 'D', 'å¾…ç¡®å®š'];

                            // åˆ›å»ºä¸‹æ‹‰æ¡†
                            const select = document.createElement('select');

                            // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                            validOptions.forEach(option => {
                                const optionElement = document.createElement('option');
                                optionElement.value = option;
                                optionElement.textContent = option;

                                // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹ä¸º"å¾…ç¡®å®š"
                                if (option === 'å¾…ç¡®å®š') {
                                    optionElement.selected = true;
                                }

                                select.appendChild(optionElement);
                            });

                            // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                            select.addEventListener('change', function () {
                                const selectedValue = select.value;
                                console.log('ç¼ºé™·ç­‰çº§å·²æ›´æ–°ä¸º:', selectedValue);  // å¤„ç†ä¸‹æ‹‰æ¡†å€¼çš„å˜åŒ–

                                // å¦‚æœæ–°å€¼å’Œæ—§å€¼ä¸åŒï¼Œæ ‡è®°ä¸ºå·²ä¿®æ”¹
                                newItem[attr.field] = selectedValue;
                                if (!modifiedData.includes(newItem)) {
                                    modifiedData.push(newItem); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                }
                            });

                            newDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° newDiv ä¸­
                            newItem[attr.field] = 'å¾…ç¡®å®š'; // åˆå§‹åŒ–è¯¥å­—æ®µçš„å€¼ä¸º"å¾…ç¡®å®š"
                            newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                            value = 'å¾…ç¡®å®š';

                        }else if (attr.field === 'current_status') {
                            // å®šä¹‰å½“å‰çŠ¶æ€çš„é€‰é¡¹
                            const validOptions = ['OPEN', 'CLOSED', 'FOLLOW UP', 'å¾…ç¡®å®š'];

                            // åˆ›å»ºä¸‹æ‹‰æ¡†
                            const select = document.createElement('select');

                            // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                            validOptions.forEach(option => {
                                const optionElement = document.createElement('option');
                                optionElement.value = option;
                                optionElement.textContent = option;

                                // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹ä¸º"OPEN"
                                if (option === 'OPEN') {
                                    optionElement.selected = true; // ç¡®ä¿ "OPEN" æ˜¯é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
                                }

                                select.appendChild(optionElement);
                            });

                            // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                            select.addEventListener('change', function () {
                                const selectedValue = select.value;
                                console.log('å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸º:', selectedValue);  // å¤„ç†ä¸‹æ‹‰æ¡†å€¼çš„å˜åŒ–

                                // ç¡®ä¿ä¸‹æ‹‰æ¡†çš„é€‰ä¸­å€¼åŠæ—¶æ›´æ–°åˆ° newItem ä¸­
                                newItem[attr.field] = selectedValue;
                                if (!modifiedData.includes(newItem)) {
                                    modifiedData.push(newItem); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                }
                            });

                            newDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° newDiv ä¸­

                            // ç¡®ä¿åœ¨åˆ›å»ºæ—¶ï¼ŒnewItem[attr.field] è¢«è®¾ç½®ä¸º"OPEN"
                            newItem[attr.field] = 'OPEN'; // åˆå§‹åŒ–è¯¥å­—æ®µçš„å€¼ä¸º"OPEN"
                            value = 'OPEN';

                            // è®¾ç½®å­—ä½“é¢œè‰²
                            newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                        }else if (attr.field === 'problemCategory') {
                            // å®šä¹‰å½“å‰çŠ¶æ€çš„é€‰é¡¹
                            const validOptions = ['ç”µæ°”æ€§èƒ½', 'å…¼å®¹æ€§', 'å¯é æ€§', 'å·¥è‰º' ,'å¾…ç¡®å®š'];

                            // åˆ›å»ºä¸‹æ‹‰æ¡†
                            const select = document.createElement('select');

                            // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                            validOptions.forEach(option => {
                                const optionElement = document.createElement('option');
                                optionElement.value = option;
                                optionElement.textContent = option;

                                // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹ä¸º"OPEN"
                                if (option === 'å¾…ç¡®å®š') {
                                    optionElement.selected = true; // ç¡®ä¿ "OPEN" æ˜¯é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
                                }

                                select.appendChild(optionElement);
                            });

                            // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                            select.addEventListener('change', function () {
                                const selectedValue = select.value;
                                console.log('å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸º:', selectedValue);  // å¤„ç†ä¸‹æ‹‰æ¡†å€¼çš„å˜åŒ–

                                // ç¡®ä¿ä¸‹æ‹‰æ¡†çš„é€‰ä¸­å€¼åŠæ—¶æ›´æ–°åˆ° newItem ä¸­
                                newItem[attr.field] = selectedValue;
                                if (!modifiedData.includes(newItem)) {
                                    modifiedData.push(newItem); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                }
                            });

                            newDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° newDiv ä¸­

                            // ç¡®ä¿åœ¨åˆ›å»ºæ—¶ï¼ŒnewItem[attr.field] è¢«è®¾ç½®ä¸º"OPEN"
                            newItem[attr.field] = 'å¾…ç¡®å®š'; // åˆå§‹åŒ–è¯¥å­—æ®µçš„å€¼ä¸º"OPEN"
                            value = 'å¾…ç¡®å®š';

                            // è®¾ç½®å­—ä½“é¢œè‰²
                            newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                        }else if (attr.field === 'responsibleDepartment') {
                            // å®šä¹‰å½“å‰çŠ¶æ€çš„é€‰é¡¹
                            const validOptions = ['äº§å“', 'é¡¹ç›®', 'ç»“æ„' , 'ID', 'ç ”å‘', 'DQE', 'SQE', 'CQE', 'å¾…ç¡®å®š'];

                            // åˆ›å»ºä¸‹æ‹‰æ¡†
                            const select = document.createElement('select');

                            // åˆ›å»ºä¸‹æ‹‰é€‰é¡¹
                            validOptions.forEach(option => {
                                const optionElement = document.createElement('option');
                                optionElement.value = option;
                                optionElement.textContent = option;

                                // è®¾ç½®é»˜è®¤é€‰ä¸­çš„é€‰é¡¹ä¸º"OPEN"
                                if (option === 'å¾…ç¡®å®š') {
                                    optionElement.selected = true; // ç¡®ä¿ "OPEN" æ˜¯é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
                                }

                                select.appendChild(optionElement);
                            });

                            // ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–äº‹ä»¶
                            select.addEventListener('change', function () {
                                const selectedValue = select.value;
                                console.log('å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸º:', selectedValue);  // å¤„ç†ä¸‹æ‹‰æ¡†å€¼çš„å˜åŒ–

                                // ç¡®ä¿ä¸‹æ‹‰æ¡†çš„é€‰ä¸­å€¼åŠæ—¶æ›´æ–°åˆ° newItem ä¸­
                                newItem[attr.field] = selectedValue;
                                if (!modifiedData.includes(newItem)) {
                                    modifiedData.push(newItem); // æ ‡è®°ä¿®æ”¹è¿‡çš„æ•°æ®
                                }
                            });

                            newDiv.appendChild(select);  // æ·»åŠ ä¸‹æ‹‰æ¡†åˆ° newDiv ä¸­

                            // ç¡®ä¿åœ¨åˆ›å»ºæ—¶ï¼ŒnewItem[attr.field] è¢«è®¾ç½®ä¸º"OPEN"
                            newItem[attr.field] = 'å¾…ç¡®å®š'; // åˆå§‹åŒ–è¯¥å­—æ®µçš„å€¼ä¸º"OPEN"
                            value = 'å¾…ç¡®å®š';

                            // è®¾ç½®å­—ä½“é¢œè‰²
                            newDiv.style.color = '#8a4e07'; // è®¾ç½®å­—ä½“é¢œè‰²
                        }  else {
                            value = ''; // å…¶ä»–å­—æ®µä¿æŒä¸ºç©ºå­—ç¬¦ä¸²
                        }

                        // å°†æ–°å€¼æ·»åŠ åˆ° newItem ä¸­
                        newItem[attr.field] = value;

                        //è¿™é‡Œæ˜¯è®©editClickBtnç‚¹å‡»å¼¹å‡ºæ¥çš„æ¨¡æ€æ¡†è®¾ç½®å“ªäº›åˆ—æ ·å¼ä¸å…è®¸äººä¿®æ”¹çš„
                        if(attr.field === 'history_id' || attr.field==='created_by'
                            || attr.field==='created_at' || attr.field === 'dqe_review_at' || attr.field === 'current_status'
                            || attr.field === 'rd_review_at' || index === 1 || index === 3 || index ===2 || index === 4 || index === 5
                            || index === 36 || index === 37 || index === 38 || index === 39 || index === 40 || index === 6 || index === 7 || index === 8) {

                        }else{
                            // åˆ›å»ºå¯ç¼–è¾‘çš„å†…å®¹
                            createEditableSpan(value, newItem, attr, modifiedData, newDiv, username); // ä½¿ç”¨è·å–çš„å€¼
                        }

                    }

                    newCell.appendChild(newDiv);
                    newRow.appendChild(newCell);
                });

                table.appendChild(newRow); // å°†æ–°è¡Œæ·»åŠ åˆ°è¡¨æ ¼
                modifiedData.push(newItem); // å°†æ–°è¡Œæ•°æ®æ¨å…¥ä¿®æ”¹æ•°æ®æ•°ç»„
            })
            .catch(error => {
                console.error('è·å–æ•°æ®å¤±è´¥:', error.message);
                alert(error.message); // å¤„ç†é”™è¯¯
            });
    }

    function exportProblemXlsx(data) {
        const requestData = { issues: data };

        $.ajax({
            url: '/problemMoudle/exportProblemXlsx',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            xhrFields: { responseType: 'blob' },
            success: function (blob, status, xhr) {
                // è§£ææ–‡ä»¶åï¼šåŒæ—¶æ”¯æŒ filename ä¸ filename*
                const cd = xhr.getResponseHeader('Content-Disposition') || '';
                let fileName = 'æµ‹è¯•é—®é¢˜ç‚¹.xlsx';

                // åŒ¹é… filename*=
                const fnStar = /filename\*\=UTF-8''([^;]+)/i.exec(cd);
                if (fnStar && fnStar[1]) {
                    fileName = decodeURIComponent(fnStar[1]);
                } else {
                    // åŒ¹é… filename=
                    const fnNormal = /filename\=\"?([^\";]+)\"?/i.exec(cd);
                    if (fnNormal && fnNormal[1]) fileName = fnNormal[1];
                }

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            },
            error: function (xhr) {
                const msg = xhr.responseText || 'å¯¼å‡ºå¤±è´¥';
                alert(msg);
            }
        });
    }

    function exportFile(sampleId) {
        // ç›´æ¥è®¿é—®åç«¯çš„ä¸‹è½½æ¥å£ï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨ä¸‹è½½
        window.location.href = `/problemMoudle/downloadFile?sampleId=${sampleId}`;
    }

    // å‘é€æ–‡æœ¬é€šçŸ¥ç»™æŠ„é€è€…
    function sendCcNotification(sample_id, ccName, sender, sample_schedule) {
        fetch('/problemMoudle/sendCcNotification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sample_id: sample_id,
                cc_name: ccName,
                sender: sender,
                sample_schedule: sample_schedule
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Network response was not ok');
                    });
                }
                return response.text();
            })
            .then(text => {
                console.log('æŠ„é€é€šçŸ¥å‘é€æˆåŠŸ:', text);
            })
            .catch((error) => {
                console.error('å‘é€æŠ„é€é€šçŸ¥å¤±è´¥:', error);
            });
    }

    function updateSchedule(sample_schedule, sample_id, receiver, statusBarBgColor, sender, job ,selectedOption,isReceiverTester) {
        fetch('/problemMoudle/updateSchedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sample_schedule: sample_schedule,
                sample_id: sample_id,
                receiver: receiver,
                statusBarBgColor: statusBarBgColor,
                sender: sender,
                job: job,
                selectedOption: selectedOption,
                isReceiverTester: isReceiverTester
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Network response was not ok');
                    });
                }
                return response.text();
            })
            .then(text => {
                const [type, ...rest] = text.split('|');
                const message = rest.join('|');

                if (type === 'copyable') {
                    showCustomAlertWithCopy(message);
                } else {
                    alert(text);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error: ' + error.message); // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            });
    }
    function showCustomAlertWithCopy(fullTextToShowAndCopy) {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '30%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.background = '#fff';
        modal.style.padding = '20px';
        modal.style.borderRadius = '8px';
        modal.style.boxShadow = '0 0 15px rgba(0, 0, 0, 0.3)';
        modal.style.zIndex = 10000;
        modal.style.minWidth = '300px';
        modal.style.textAlign = 'center';

        // å±•ç¤ºå†…å®¹
        const textBox = document.createElement('pre');
        textBox.textContent = fullTextToShowAndCopy;
        textBox.style.whiteSpace = 'pre-wrap';
        textBox.style.wordBreak = 'break-all';
        textBox.style.marginBottom = '10px';
        modal.appendChild(textBox);

        // å¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'å¤åˆ¶ä»¥ä¸Šå†…å®¹';
        copyBtn.style.marginRight = '10px';
        copyBtn.onclick = function () {
            copyTextToClipboard(fullTextToShowAndCopy); // ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼
        };

        // å…³é—­æŒ‰é’®
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'å…³é—­';
        closeBtn.onclick = () => document.body.removeChild(modal);

        modal.appendChild(copyBtn);
        modal.appendChild(closeBtn);

        document.body.appendChild(modal);
    }


    function copyTextToClipboard(text) {
        // ä¼˜å…ˆä½¿ç”¨ç°ä»£çš„ Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // å¦‚æœ Clipboard API å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyTextToClipboard(text);
            });
        } else {
            // å›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
            fallbackCopyTextToClipboard(text);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';  // é¿å…é¡µé¢æ»šåŠ¨
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } else {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        } catch (err) {
            alert('å¤åˆ¶å¤±è´¥: ' + err);
        }

        document.body.removeChild(textarea);
    }




    function showImageModal(imageSrc,sampleId,id,modifiedData, responsiblePersonValue) {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†
        let modal = document.querySelector('.image-modal');

        // å¦‚æœæ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
        if (!modal) {
            modal = document.createElement('div');
            modal.className = 'image-modal';

            // å°†æ¨¡æ€æ¡†æ·»åŠ åˆ°æ–‡æ¡£ä¸­
            document.body.appendChild(modal);

            // ç‚¹å‡»æ¨¡æ€æ¡†æ—¶å…³é—­ï¼Œä½†ä¸åŒ…æ‹¬å›¾ç‰‡åŒºåŸŸ
            modal.addEventListener('click', function (event) {
                if (event.target === modal) {
                    modal.classList.remove('active'); // éšè—æ¨¡æ€æ¡†
                }
            });
        }

        // æ¸…ç©ºä¹‹å‰çš„å†…å®¹ï¼Œé˜²æ­¢å¤šæ¬¡ç‚¹å‡»é‡å¤æ·»åŠ å›¾ç‰‡
        modal.innerHTML = '';

        // åˆ›å»ºå›¾ç‰‡å…ƒç´ å¹¶è®¾ç½®æº
        const img = document.createElement('img');
        img.src = imageSrc;

        // ç¼©æ”¾æ¯”ä¾‹åˆå§‹åŒ–ä¸º 1
        let scale = 1;

        // ç›‘å¬æ»šè½®äº‹ä»¶è¿›è¡Œç¼©æ”¾
        img.addEventListener('wheel', function (event) {
            event.preventDefault();  // é˜²æ­¢é¡µé¢æ»šåŠ¨

            // åˆ¤æ–­æ»šè½®æ–¹å‘ï¼Œæ”¾å¤§æˆ–ç¼©å°
            if (event.deltaY < 0) {
                scale += 0.1;  // æ”¾å¤§
            } else {
                scale -= 0.1;  // ç¼©å°
            }

            // é™åˆ¶ç¼©æ”¾èŒƒå›´
            if (scale < 0.5) scale = 0.5;
            if (scale > 3) scale = 3;

            // è®¾ç½®å›¾ç‰‡ç¼©æ”¾
            img.style.transform = `scale(${scale})`;
        });

        // ç‚¹å‡»å›¾ç‰‡æ—¶è§¦å‘ä¸Šä¼ é€»è¾‘
        if(responsiblePersonValue === username){
            img.addEventListener('click', function () {
                triggerImageUpload(imageSrc,sampleId,id,modifiedData,modal); // è§¦å‘ä¸Šä¼ æ–¹æ³•
            });
        }


        // å°†å›¾ç‰‡æ·»åŠ åˆ°æ¨¡æ€æ¡†ä¸­
        modal.appendChild(img);

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.classList.add('active');
    }

    function triggerImageUpload(imageSrc,sampleId,id,modifiedData,modal) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*'; // åªæ¥å—å›¾ç‰‡ç±»å‹

        fileInput.addEventListener('change', function () {
            const file = fileInput.files[0];
            if (file) {

                uploadImage(file, sampleId, id, modifiedData);
                modal.classList.remove('active'); // éšè—æ¨¡æ€æ¡†
            }
        });

        // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
        fileInput.click();
    }

    //ã€ä¸Šä¼ å›¾ç‰‡çš„æ–¹æ³•
    function uploadImage(file, sampleId,id,modifiedData) {
        const formData = new FormData();
        formData.append('file', file);  // æ·»åŠ æ–‡ä»¶
        formData.append('sampleId', sampleId);  // æ·»åŠ  sampleId
        formData.append('id', id);  // æ·»åŠ  sampleId

        fetch('/problemMoudle/uploadImage', {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.message && data.message.includes("ä¸Šä¼ æˆåŠŸ")) {
                    alert(data.message); // åªåœ¨æ¶ˆæ¯ä¸­åŒ…å«"ä¸Šä¼ æˆåŠŸ"æ—¶å¼¹å‡º]
                    // æ£€æŸ¥ modifiedData æ˜¯å¦ä¸ä¸ºç©ºæ•°ç»„
                    if (Array.isArray(modifiedData) && modifiedData.length > 0) {
                        saveChanges(modifiedData, sampleId,true);
                    }
                    editClickBtn(sampleId)

                } else {
                    alert("ä¸Šä¼ å¤±è´¥æˆ–å…¶ä»–ä¿¡æ¯: " + data.message);
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ å‡ºé”™:', error);
                // åœ¨è¿™é‡Œå¤„ç†é”™è¯¯æƒ…å†µï¼Œæ¯”å¦‚æç¤ºç”¨æˆ·
            });
    }

    // æŠ¥å‘ŠæŸ¥è¯¢é¡µé¢æŒ‰é’®åŠŸèƒ½
    const reportQueryBtn = document.getElementById("report-query-btn");
    
    // æŠ¥å‘ŠæŸ¥è¯¢é¡µé¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    reportQueryBtn.addEventListener("click", () => {
        goToReportQuery();
    });
    
    // è·³è½¬åˆ°æŠ¥å‘ŠæŸ¥è¯¢é¡µé¢
    function goToReportQuery() {
        if (!username) {
            alert("è¯·å…ˆè¾“å…¥ç”¨æˆ·åï¼");
            return;
        }
        
        if (!job) {
            alert("è¯·å…ˆé€‰æ‹©è§’è‰²ï¼");
            return;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨é’‰é’‰ç¯å¢ƒä¸­
        const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
        
        // å¦‚æœæ˜¯testerï¼Œæ·»åŠ readonlyå‚æ•°
        let url = 'http://219.134.191.195:64000/problemMoudle?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
        // let url = 'http://xf9deff9.natappfree.cc/problemMoudle?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
        if (job === 'tester') {
            url += '&readonly=true';
        }

        if (isDingTalk) {
            dd.openLink({
                url: url,
                success: function() {
                    console.log('æˆåŠŸæ‰“å¼€æŠ¥å‘ŠæŸ¥è¯¢é¡µé¢');
                },
                fail: function(err) {
                    alert('æ‰“å¼€é¡µé¢å¤±è´¥ï¼š' + JSON.stringify(err));
                    console.error('dd.openLink fail:', err);
                }
            });
        } else {
            // éé’‰é’‰ç¯å¢ƒä½¿ç”¨æ™®é€šè·³è½¬
            window.location.href = url;
        }
    }

    // é—®é¢˜åº“ç®¡ç†æŒ‰é’®åŠŸèƒ½
    const problemLibraryBtn = document.getElementById("problem-library-btn");
    
    // é—®é¢˜åº“ç®¡ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    problemLibraryBtn.addEventListener("click", () => {
        goToProblemLibrary();
    });
    
    // è·³è½¬åˆ°é—®é¢˜åº“ç®¡ç†é¡µé¢
    function goToProblemLibrary() {
        if (!username) {
            alert("è¯·å…ˆè¾“å…¥ç”¨æˆ·åï¼");
            return;
        }
        
        if (!job) {
            alert("è¯·å…ˆé€‰æ‹©è§’è‰²ï¼");
            return;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨é’‰é’‰ç¯å¢ƒä¸­
        const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
        const url = 'http://219.134.191.195:64000/problemLibraryManage?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);
        // const url = 'http://e5f3985c.natappfree.cc/problemLibraryManage?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);

        if (isDingTalk) {
            dd.openLink({
                url: url,
                success: function() {
                    console.log('æˆåŠŸæ‰“å¼€é—®é¢˜åº“ç®¡ç†');
                },
                fail: function(err) {
                    alert('æ‰“å¼€é¡µé¢å¤±è´¥ï¼š' + JSON.stringify(err));
                    console.error('dd.openLink fail:', err);
                }
            });
        } else {
            // éé’‰é’‰ç¯å¢ƒä½¿ç”¨æ™®é€šè·³è½¬
            window.location.href = url;
        }
    }

    // æ•°æ®çœ‹æ¿æŒ‰é’®åŠŸèƒ½
    const dashboardBtn = document.getElementById("dashboard-btn");
    
    // æ•°æ®çœ‹æ¿æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    dashboardBtn.addEventListener("click", () => {
        goToDashboard();
    });
    
    // æ ¹æ®è§’è‰²è·³è½¬åˆ°ä¸åŒçš„æ•°æ®çœ‹æ¿é¡µé¢
    function goToDashboard() {
        if (!username) {
            alert("è¯·å…ˆè¾“å…¥ç”¨æˆ·åï¼");
            return;
        }
        
        if (!job) {
            alert("è¯·å…ˆé€‰æ‹©è§’è‰²ï¼");
            return;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨é’‰é’‰ç¯å¢ƒä¸­
        const isDingTalk = typeof dd !== 'undefined' && dd.env.platform !== 'notInDingTalk';
        const url = 'http://219.134.191.195:64000/dqeDashboard?username=' + encodeURIComponent(username) + '&job=' + encodeURIComponent(job);

        if (isDingTalk) {
            dd.openLink({
                url: url,
                success: function() {
                    console.log('æˆåŠŸæ‰“å¼€æ•°æ®çœ‹æ¿');
                },
                fail: function(err) {
                    alert('æ‰“å¼€é¡µé¢å¤±è´¥ï¼š' + JSON.stringify(err));
                    console.error('dd.openLink fail:', err);
                }
            });
        } else {
            // éé’‰é’‰ç¯å¢ƒä½¿ç”¨æ™®é€šè·³è½¬
            window.location.href = url;
        }
    }

    // 20250506 åŠ æ’æœŸé¡¹ç›®æŒ‰é’®
    // è·å–æŒ‰é’®å’Œæ¨¡æ€æ¡†å…ƒç´ 
    const schedulePanelBtn = document.getElementById("schedule-panel-btn");
    const schedulePanelModal = document.getElementById("schedule-panel-modal");
    const closePanelModal = document.getElementById("close-panel-modal");
    const projectDetailModal = document.getElementById("project-detail-modal");
    const closeProjectModal = document.getElementById("close-project-modal");
    const scheduleProjectList = document.getElementById("schedule-project-list");

    // æ‰“å¼€æ’æœŸé¡¹ç›®é¢æ¿
    schedulePanelBtn.addEventListener("click", () => {
        fetchProjects(username);
        schedulePanelModal.style.display = "block";
    });

    // å…³é—­æ’æœŸé¡¹ç›®é¢æ¿
    closePanelModal.addEventListener("click", () => {
        schedulePanelModal.style.display = "none";
    });

    // å…³é—­é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡†
    closeProjectModal.addEventListener("click", () => {
        projectDetailModal.style.display = "none";
    });

    // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
    window.addEventListener("click", (event) => {
        if (event.target === schedulePanelModal) {
            schedulePanelModal.style.display = "none";
        }
        if (event.target === projectDetailModal) {
            projectDetailModal.style.display = "none";
        }
    });

    // è°ƒç”¨æ¥å£è·å–é¡¹ç›®æ•°æ®
    function fetchProjects(username) {
        fetch(`/api/getScheduleSampleIdByName?username=${encodeURIComponent(username)}`)
            .then((response) => response.json())
            .then((data) => {
                displayProjects(data);
            })
            .catch((error) => {
                console.error("Error fetching projects:", error);
            });
    }


    // æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
    function displayProjects(projects) {
        scheduleProjectList.innerHTML = ""; // æ¸…ç©ºåŸæ¥çš„åˆ—è¡¨
        
        if (!projects || projects.length === 0) {
            document.getElementById("empty-project-list").style.display = "block";
            scheduleProjectList.style.display = "none";
            return;
        }
        
        document.getElementById("empty-project-list").style.display = "none";
        scheduleProjectList.style.display = "grid";
        
        projects.forEach((project) => {
            const card = document.createElement("div");
            card.className = "project-card";
            card.innerHTML = `
                <div class="project-card-content">
                    <div class="project-icon">ğŸ“¦</div>
                    <div class="project-info">
                        <div class="project-id">${project}</div>
                        <div class="project-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                </div>
            `;
            card.addEventListener("click", () => {
                showProjectDetails(project);
                schedulePanelModal.style.display = "none";
            });
            scheduleProjectList.appendChild(card);
        });
    }
    
    // æœç´¢åŠŸèƒ½
    const projectSearchInput = document.getElementById("project-search-input");
    if (projectSearchInput) {
        projectSearchInput.addEventListener("input", (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const cards = scheduleProjectList.querySelectorAll(".project-card");
            let visibleCount = 0;
            
            cards.forEach((card) => {
                const projectId = card.querySelector(".project-id").textContent.toLowerCase();
                if (projectId.includes(searchTerm)) {
                    card.style.display = "block";
                    visibleCount++;
                } else {
                    card.style.display = "none";
                }
            });
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„é¡¹ç›®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (visibleCount === 0 && searchTerm !== "") {
                document.getElementById("empty-project-list").style.display = "block";
                document.getElementById("empty-project-list").innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ”</div>
                    <div style="font-size: 16px;">æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®</div>
                `;
            } else {
                document.getElementById("empty-project-list").style.display = "none";
            }
        });
    }

    // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
    function showProjectDetails(projectId) {
        fetch(`/api/project-details/${projectId}`)
            .then((response) => response.json())
            .then((data) => {
                currentProjectData = data;
                let html = `
                <style>
                    /* æ»šåŠ¨æ€§èƒ½ä¼˜åŒ– */
                    .modal-body {
                        -webkit-overflow-scrolling: touch;
                        scroll-behavior: smooth;
                        overscroll-behavior: contain;
                    }
                    #project-detail-info {
                        contain: layout style paint;
                        will-change: scroll-position;
                    }
                    #project-detail-info .detail-section {
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 12px;
                        border-left: 4px solid #007bff;
                        /* é¿å…é‡æ’ä¼˜åŒ– */
                        contain: layout style;
                        transform: translateZ(0);
                    }
                    #project-detail-info .detail-section-title {
                        font-size: 14px;
                        font-weight: 600;
                        color: #495057;
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    #project-detail-info .detail-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 10px;
                        /* ä¼˜åŒ–ç½‘æ ¼æ¸²æŸ“ */
                        contain: layout;
                    }
                    @media (max-width: 1200px) {
                        #project-detail-info .detail-grid {
                            grid-template-columns: repeat(3, 1fr);
                        }
                    }
                    @media (max-width: 900px) {
                        #project-detail-info .detail-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    #project-detail-info .detail-item {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                        /* é¿å…å†…å®¹å˜åŒ–å¯¼è‡´é‡æ’ */
                        min-height: 40px;
                    }
                    #project-detail-info .detail-label {
                        font-size: 12px;
                        color: #6c757d;
                        font-weight: 500;
                    }
                    #project-detail-info .detail-value {
                        font-size: 13px;
                        color: #212529;
                        font-weight: 400;
                        word-break: break-word;
                    }
                    #project-detail-info .status-badge {
                        display: inline-block;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: 500;
                    }
                    #project-detail-info .cancel-info {
                        background: #fff3cd;
                        border-left-color: #ffc107;
                    }
                </style>

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">æ ·å“ç¼–å·</span>
                            <span class="detail-value">${data.sample_id || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">äº§å“åç§°</span>
                            <span class="detail-value">${data.sample_name || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">å¤§ç¼–ç </span>
                            <span class="detail-value">${data.sample_model || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç‰©æ–™ç¼–ç </span>
                            <span class="detail-value">${data.materialCode || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">äº§å“ç±»åˆ«</span>
                            <span class="detail-value">${data.sample_category || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç‰ˆæœ¬å·</span>
                            <span class="detail-value">${data.version || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ä¼˜å…ˆçº§</span>
                            <span class="detail-value">${data.priority || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">å½“å‰è¿›åº¦</span>
                            <span class="detail-value"><span class="status-badge" style="background: #e7f3ff; color: #0066cc;">${data.schedule || '-'}</span></span>
                        </div>
                    </div>
                </div>

                <!-- äººå‘˜ä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ‘¥ äººå‘˜ä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">é¡¹ç›®è´Ÿè´£äºº</span>
                            <span class="detail-value">${data.sample_leader || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æµ‹è¯•è´Ÿè´£äºº</span>
                            <span class="detail-value">${data.tester || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">DQEè´Ÿè´£äºº</span>
                            <span class="detail-value">${data.sample_dqe || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç ”å‘è´Ÿè´£äºº</span>
                            <span class="detail-value">${data.sample_rd || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- æµ‹è¯•ä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ§ª æµ‹è¯•ä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">è¯•éªŒé¡¹ç›®ç±»åˆ«</span>
                            <span class="detail-value">${data.testProjectCategory || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æµ‹è¯•å­é¡¹ç›®</span>
                            <span class="detail-value">${data.testProjects || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ˜¯å¦é«˜é¢‘</span>
                            <span class="detail-value">${data.high_frequency || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">äº§å“ç±»åˆ«</span>
                            <span class="detail-value">${data.sample_type || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ ·å“æ‰¿è®¤ç»“æœ</span>
                            <span class="detail-value">${data.sampleRecognizeResult || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">å®é™…æµ‹è¯•æ—¶é•¿</span>
                            <span class="detail-value">${data.testDuration || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- æ•°é‡ä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“¦ æ•°é‡ä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">ç”µæ°”æµ‹è¯•æ•°é‡</span>
                            <span class="detail-value">${data.sample_quantity || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">å¯é æ€§æµ‹è¯•æ•°é‡</span>
                            <span class="detail-value">${data.reliability_quantity || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç¯ä¿æµ‹è¯•æ•°é‡</span>
                            <span class="detail-value">${data.envproction_quantity || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ä¾›åº”å•†</span>
                            <span class="detail-value">${data.supplier || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- æ’æœŸä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“… æ’æœŸä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">æ’æœŸå¤©æ•°</span>
                            <span class="detail-value">${data.scheduleDays || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ’æœŸå¼€å§‹æ—¶é—´</span>
                            <span class="detail-value">${data.schedule_start_date ? data.schedule_start_date.substring(0, 10) + ' 10:00:00' : '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ’æœŸç»“æŸæ—¶é—´</span>
                            <span class="detail-value">${data.schedule_end_date ? data.schedule_end_date.substring(0, 10) + ' 18:30:00' : '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">åˆ›å»ºæ—¶é—´</span>
                            <span class="detail-value">${data.create_time || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- å®é™…æµ‹è¯•æ—¶é—´ -->
                <div class="detail-section">
                    <div class="detail-section-title">â° å®é™…æµ‹è¯•æ—¶é—´</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">å®é™…å¼€å§‹æµ‹è¯•æ—¶é—´</span>
                            <span class="detail-value">${data.actual_start_time || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">å®é™…æµ‹è¯•å®Œæˆæ—¶é—´</span>
                            <span class="detail-value">${data.actual_finish_time || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- æ—¶é—´ä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“† æ—¶é—´ä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">æ ·å“æå•ç”³è¯·æ—¶é—´</span>
                            <span class="detail-value">${data.apply_createdAt || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">éœ€æ±‚å®Œæˆæ—¶é—´</span>
                            <span class="detail-value">${data.demandFinishedTime || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- ä½œåºŸä¿¡æ¯ -->
                ${data.isCancel === 1 ? `
                <div class="detail-section cancel-info">
                    <div class="detail-section-title">âš ï¸ ä½œåºŸä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">æ˜¯å¦ä½œåºŸ</span>
                            <span class="detail-value">å·²ä½œåºŸ</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ä½œåºŸåŸå› </span>
                            <span class="detail-value">${data.cancel_reason || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ä½œåºŸäºº</span>
                            <span class="detail-value">${data.cancel_by || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ä½œåºŸæ—¶é—´</span>
                            <span class="detail-value">${data.cancel_date || '-'}</span>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
                document.getElementById("project-detail-info").innerHTML = html;
                document.getElementById("project-detail-modal").style.display = "block";
            })
            .catch((error) => {
                console.error("Error fetching project details:", error);
            });
    }


    document.getElementById("start-test-btn").addEventListener("click", () => {
        // æ£€æŸ¥åç«¯æ•°æ®ä¸­æ˜¯å¦åŒ…å«äº§å“ç±»åˆ«ã€æ ·å“æ•°é‡ã€æ˜¯å¦é«˜é¢‘
        const hasCategory = currentProjectData.sample_type && currentProjectData.sample_type.trim() !== '';
        const hasQuantity = currentProjectData.sample_quantity && currentProjectData.sample_quantity > 0;
        const hasFrequency = currentProjectData.high_frequency && currentProjectData.high_frequency.trim() !== '';
        
        // å±•ç¤ºä»»åŠ¡å±æ€§è¡¨å•
        document.getElementById("task-attributes").style.display = "block";
        
        // éšè—"å¼€å§‹æµ‹è¯•"æŒ‰é’®ï¼Œæ˜¾ç¤º"ç¡®è®¤å¼€å§‹æµ‹è¯•"æŒ‰é’®
        document.getElementById("start-test-btn").style.display = "none";
        document.getElementById("confirm-task-btn").style.display = "block";
        
        // å¦‚æœåç«¯æ•°æ®ä¸­æ²¡æœ‰è¿™ä¸‰ä¸ªå€¼ï¼Œåˆ™æ˜¾ç¤ºé¢å¤–çš„è¾“å…¥æ¡†
        if (!hasCategory || !hasQuantity || !hasFrequency) {
            document.getElementById("additional-fields").style.display = "block";
        } else {
            // å¦‚æœåç«¯æ•°æ®ä¸­æœ‰è¿™ä¸‰ä¸ªå€¼ï¼Œåˆ™éšè—é¢å¤–çš„è¾“å…¥æ¡†ï¼Œå¹¶å¡«å……å€¼
            document.getElementById("additional-fields").style.display = "none";
            document.getElementById("sample-category").value = currentProjectData.sample_type || '';
            document.getElementById("sample-quantity").value = currentProjectData.sample_quantity || '';
            document.getElementById("is-high-frequency").value = currentProjectData.high_frequency || '';
        }
    });

    document.getElementById("confirm-task-btn").addEventListener("click", async () => {
        const btn = document.getElementById("confirm-task-btn");
        if (btn.disabled) return; // é˜²æ­¢é‡å¤ç‚¹å‡»

        const questStats = document.getElementById("questStats-detail").value;
        let isHighFrequency = document.getElementById("is-high-frequency").value;
        let category = document.getElementById("sample-category").value;
        let quantity = document.getElementById("sample-quantity").value;

        // éªŒè¯ä»»åŠ¡å±æ€§ï¼ˆå¿…å¡«ï¼‰
        if (!questStats) {
            alert("è¯·é€‰æ‹©ä»»åŠ¡å±æ€§ï¼");
            return;
        }
        
        // æ£€æŸ¥é¢å¤–å­—æ®µæ˜¯å¦æ˜¾ç¤ºï¼Œå¦‚æœæ˜¾ç¤ºåˆ™éœ€è¦éªŒè¯
        const additionalFieldsVisible = document.getElementById("additional-fields").style.display !== "none";
        
        if (additionalFieldsVisible) {
            // å¦‚æœæ˜¾ç¤ºäº†é¢å¤–å­—æ®µï¼Œåˆ™éœ€è¦éªŒè¯
            if (!category.trim()) {
                alert("è¯·è¾“å…¥äº§å“ç±»åˆ«ï¼");
                document.getElementById("sample-category").focus();
                return;
            }
            
            if (!quantity || quantity <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ ·å“æ•°é‡ï¼");
                document.getElementById("sample-quantity").focus();
                return;
            }
            
            if (!isHighFrequency) {
                alert("è¯·é€‰æ‹©æ˜¯å¦é«˜é¢‘ï¼");
                document.getElementById("is-high-frequency").focus();
                return;
            }
        } else {
            // å¦‚æœæ²¡æœ‰æ˜¾ç¤ºé¢å¤–å­—æ®µï¼Œåˆ™ä½¿ç”¨åç«¯æ•°æ®ä¸­çš„å€¼
            category = currentProjectData.sample_type || '';
            quantity = currentProjectData.sample_quantity || '';
            isHighFrequency = currentProjectData.high_frequency || '';
        }

        // ç¦ç”¨æŒ‰é’®ï¼Œé¿å…å¤šæ¬¡ç‚¹å‡»
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText = "æäº¤ä¸­...";

        // æ›´æ–° currentProjectDataï¼Œæ·»åŠ æ–°çš„å­—æ®µ
        currentProjectData.questStats = questStats;
        currentProjectData.high_frequency = isHighFrequency;
        currentProjectData.sample_type = category;
        currentProjectData.sample_quantity = quantity;

        const payload = {
            questStats,
            isHighFrequency,
            category,
            quantity,
            projectData: currentProjectData
        };

        try {
            const res = await fetch('/api/start-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const contentType = res.headers.get('Content-Type');
            const isJson = contentType && contentType.includes('application/json');
            const data = isJson ? await res.json() : { message: await res.text() };

            if (!res.ok) {
                throw new Error(data.message || "æäº¤å¤±è´¥ï¼");
            }

            alert(data.message);
            document.getElementById("project-detail-modal").style.display = "none";
            // è°ƒç”¨æœç´¢æ–¹æ³•åˆ·æ–°åˆ—è¡¨æ•°æ®
            performSearch();

        } catch (err) {
            console.error("æäº¤å¤±è´¥", err);
            alert(err.message);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.disabled = false;
            btn.innerText = originalText;
        }
    });

    function viewDataClick(sample_id) {
        fetch(`/testManIndex/viewData?sample_id=${encodeURIComponent(sample_id)}`)
            .then(response => response.json())
            .then(data => {
                // æ‰¿è®¤ä¹¦åŒºåŸŸ
                const admitContainer = document.getElementById('admitLinksContainer');
                admitContainer.innerHTML = '';
                const admitUrls = (data.admit || '').split(',').map(u => u.trim()).filter(Boolean);
                if (admitUrls.length === 0) {
                    admitContainer.innerHTML = '<li>æ— æ‰¿è®¤ä¹¦èµ„æ–™</li>';
                } else {
                    admitUrls.forEach((url, index) => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = url;
                        a.textContent = url.split('/').pop();
                        a.download = '';
                        a.target = '_blank';
                        li.appendChild(a);
                        admitContainer.appendChild(li);
                    });
                }

                // å¼€å‘è¦æ±‚åŒºåŸŸ
                const developContainer = document.getElementById('developLinksContainer');
                developContainer.innerHTML = '';
                const developUrls = (data.develop || '').split(',').map(u => u.trim()).filter(Boolean);
                if (developUrls.length === 0) {
                    developContainer.innerHTML = '<li>æ— å¼€å‘è¦æ±‚èµ„æ–™</li>';
                } else {
                    developUrls.forEach((url, index) => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = url;
                        a.textContent = url.split('/').pop();
                        a.download = '';
                        a.target = '_blank';
                        li.appendChild(a);
                        developContainer.appendChild(li);
                    });
                }

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('viewDataModal').style.display = 'block';
            })
            .catch(error => {
                alert('èµ„æ–™åŠ è½½å¤±è´¥: ' + error);
            });

        // å…³é—­æŒ‰é’®
        document.getElementById('closeViewDataModal').onclick = function () {
            document.getElementById('viewDataModal').style.display = 'none';
        };

    }

    function viewTestItemsClick(sample_id) {
        fetch(`/testManIndex/getTestItems?sample_id=${encodeURIComponent(sample_id)}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('testItemsTableBody');
                tableBody.innerHTML = '';
                
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">æš‚æ— æµ‹è¯•é¡¹æ•°æ®</td></tr>';
                } else {
                    data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${index + 1}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.testProjectCategory || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.testProjects || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.testOwner || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.testRemark || ''}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('viewTestItemsModal').style.display = 'block';
            })
            .catch(error => {
                alert('æµ‹è¯•é¡¹æ•°æ®åŠ è½½å¤±è´¥: ' + error);
            });

        // å…³é—­æŒ‰é’®
        document.getElementById('closeViewTestItemsModal').onclick = function () {
            document.getElementById('viewTestItemsModal').style.display = 'none';
        };
    }


    // é€šç”¨æ–¹æ³•ï¼šæ ¹æ® sampleId æŸ¥è¯¢æ•°æ®åº“ä¿¡æ¯å¹¶è¿”å›æ•°æ®
    async function checkSampleResult(sampleId) {
        try {
            const response = await fetch(`/problemMoudle/queryResultJudge?sample_id=${sampleId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`æŸ¥è¯¢æ•°æ®åº“å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }

            const data = await response.json();
            return data;  // è¿”å›æŸ¥è¯¢ç»“æœ
        } catch (error) {
            console.error("fetchSampleInfo å‡ºé”™ï¼š", error);
            return null;  // å‡ºé”™æ—¶è¿”å› null
        }
    }

    // æ›´æ–°é—®é¢˜ç‚¹ç¡®è®¤çŠ¶æ€åˆ°æ•°æ®åº“
    async function updatePassbackConfirmInDatabase(sampleId, passbackConfirm, product) {
        try {
            const response = await fetch('/testManIndex/updatePassbackConfirm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sample_id: sampleId,
                    passbackConfirm: passbackConfirm
                })
            });

            if (!response.ok) {
                throw new Error(`æ›´æ–°å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }

            const result = await response.json();
            if (result.status === 'success') {
                console.log('é—®é¢˜ç‚¹ç¡®è®¤çŠ¶æ€æ›´æ–°æˆåŠŸ');
                
                // æ›´æ–°å¤é€‰æ¡†çš„æ˜¾ç¤ºçŠ¶æ€
                const checkbox = document.getElementById('passbackConfirmCheckbox');
                if (checkbox) {
                    // æ ¹æ®æ•°æ®åº“æ›´æ–°ç»“æœï¼Œç¡®ä¿å¤é€‰æ¡†çŠ¶æ€ä¸æ•°æ®åº“ä¸€è‡´
                    if (passbackConfirm) {
                        // å¦‚æœç”¨æˆ·å‹¾é€‰äº†å¤é€‰æ¡†ï¼Œç¡®ä¿æ˜¾ç¤ºä¸ºå‹¾é€‰çŠ¶æ€
                        checkbox.checked = true;
                        checkbox.setAttribute('checked', 'checked');
                        product.passbackConfirm = "å·²å›ä¼ ";
                    } else {
                        // å¦‚æœç”¨æˆ·å–æ¶ˆäº†å‹¾é€‰ï¼Œç¡®ä¿æ˜¾ç¤ºä¸ºæœªå‹¾é€‰çŠ¶æ€
                        checkbox.checked = false;
                        checkbox.removeAttribute('checked');
                        product.passbackConfirm = "æœªå›ä¼ ";
                    }
                    
                    console.log('å¤é€‰æ¡†çŠ¶æ€å·²åŒæ­¥æ›´æ–°ï¼Œå½“å‰çŠ¶æ€:', checkbox.checked);
                    console.log('product.passbackConfirm å·²æ›´æ–°ä¸º:', product.passbackConfirm);
                }
                
                // å°†æ›´æ–°åçš„çŠ¶æ€ä¿å­˜åˆ° localStorageï¼Œè¿™æ ·ä¸‹æ¬¡æ‰“å¼€æ¨¡æ€æ¡†æ—¶å°±èƒ½ä¿æŒçŠ¶æ€
                const storageKey = `passbackConfirm_${sampleId}`;
                localStorage.setItem(storageKey, product.passbackConfirm);
                console.log('çŠ¶æ€å·²ä¿å­˜åˆ° localStorage:', storageKey, product.passbackConfirm);
                
                // å¯é€‰ï¼šæ˜¾ç¤ºæˆåŠŸæç¤º
                // alert('é—®é¢˜ç‚¹ç¡®è®¤çŠ¶æ€å·²æ›´æ–°');
            } else {
                console.error('æ›´æ–°å¤±è´¥:', result.message);
                
                // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œæ¢å¤å¤é€‰æ¡†çš„åŸå§‹çŠ¶æ€
                const checkbox = document.getElementById('passbackConfirmCheckbox');
                if (checkbox) {
                    checkbox.checked = !passbackConfirm; // æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€
                    if (checkbox.checked) {
                        checkbox.setAttribute('checked', 'checked');
                    } else {
                        checkbox.removeAttribute('checked');
                    }
                    console.log('æ›´æ–°å¤±è´¥ï¼Œå¤é€‰æ¡†çŠ¶æ€å·²æ¢å¤åˆ°:', checkbox.checked);
                }
                
                // å¯é€‰ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
                // alert('æ›´æ–°å¤±è´¥: ' + result.message);
            }
        } catch (error) {
            console.error('æ›´æ–°é—®é¢˜ç‚¹ç¡®è®¤çŠ¶æ€æ—¶å‡ºé”™:', error);
            
            // å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œæ¢å¤å¤é€‰æ¡†çš„åŸå§‹çŠ¶æ€
            const checkbox = document.getElementById('passbackConfirmCheckbox');
            if (checkbox) {
                checkbox.checked = !passbackConfirm; // æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€
                if (checkbox.checked) {
                    checkbox.setAttribute('checked', 'checked');
                } else {
                    checkbox.removeAttribute('checked');
                }
                console.log('å‘ç”Ÿå¼‚å¸¸ï¼Œå¤é€‰æ¡†çŠ¶æ€å·²æ¢å¤åˆ°:', checkbox.checked);
            }
            
            // å¯é€‰ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
            // alert('æ›´æ–°å¤±è´¥: ' + error.message);
        }
    }

    // åˆ›å»ºä¸€ä¸ªé€šç”¨çš„è®¿é—®æ—¥å¿—è®°å½•å·¥å…·
    const AccessLogUtil = {
        /**
         * è®°å½•ç”¨æˆ·æ“ä½œ
         * @param {string} actionName æ“ä½œåç§°ï¼Œä¾‹å¦‚ï¼š"å¯¼å‡ºæŒ‰é’®"ã€"æœç´¢æŒ‰é’®"ã€"æ–°å¢æŒ‰é’®"ç­‰
         */
        record: function(actionName) {
            try {
                const username = localStorage.getItem('username') || '';
                const job = localStorage.getItem('job') || '';

                if (!username || !job) {
                    console.warn('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è®°å½•è®¿é—®æ—¥å¿—');
                    return;
                }

                // ä½¿ç”¨fetchå‘é€è¯·æ±‚ï¼ˆä¸ç­‰å¾…å“åº”ï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒï¼‰
                fetch('/api/userAccessLog/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        job: job,
                        accessPage: actionName
                    })
                }).catch(error => {
                    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·æ“ä½œ
                    console.error('è®°å½•è®¿é—®æ—¥å¿—å¤±è´¥:', error);
                });
            } catch (error) {
                console.error('è®°å½•è®¿é—®æ—¥å¿—å¼‚å¸¸:', error);
            }
        }
    };




</script>
</header>
</body>
</html>
