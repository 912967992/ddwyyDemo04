<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯„å®¡ç»“æœç®¡ç†</title>
  <!-- å¼•å…¥å­—ä½“å›¾æ ‡åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- å¼•å…¥Chart.jsåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- å¼•å…¥Chart.jsæ•°æ®æ ‡ç­¾æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
  <link rel="stylesheet" href="/css/reviewResultsStyle.css">
  <!-- å¼•å…¥jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- å¼•å…¥é’‰é’‰JSAPI -->
  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>

  <!-- è‡ªå®šä¹‰æç¤ºæ¡†æ ·å¼ -->
  <style>
    .custom-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      min-width: 300px;
      max-width: 400px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }

    .custom-toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast-content {
      display: flex;
      align-items: center;
      padding: 16px;
      position: relative;
    }

    .toast-icon {
      color: #28a745;
      font-size: 20px;
      margin-right: 12px;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      color: #333;
      line-height: 1.4;
    }

    .toast-close {
      position: absolute;
      top: 8px;
      right: 8px;
      cursor: pointer;
      color: #999;
      font-size: 12px;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .toast-close:hover {
      background-color: #f5f5f5;
      color: #666;
    }

    .custom-toast.success .toast-icon {
      color: #28a745;
    }

    .custom-toast.error .toast-icon {
      color: #dc3545;
    }

    .custom-toast.warning .toast-icon {
      color: #ffc107;
    }

    .custom-toast.info .toast-icon {
      color: #17a2b8;
    }

    /* é—®é¢˜å›¾ç‰‡å®¹å™¨æ ·å¼ */
    .problem-image-container {
      max-width: 100%;
      margin-top: 8px;
    }

    .problem-image-container img {
      max-width: 100%;
      max-height: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin: 5px 0;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .problem-image-container img:hover {
      transform: scale(1.02);
    }

    .problem-image-container .no-image {
      color: #999;
      font-style: italic;
      padding: 20px;
      text-align: center;
      border: 1px dashed #ddd;
      border-radius: 4px;
    }

    .problem-image-container .image-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .problem-image-container .image-item {
      position: relative;
      display: inline-block;
    }

    .problem-image-container .image-item img {
      display: block;
      margin: 0;
    }

    /* å›¾ç‰‡ç¼–è¾‘å®¹å™¨æ ·å¼ */
    .image-edit-container {
      width: 100%;
    }

    .image-edit-container textarea {
      width: 100%;
      margin-bottom: 10px;
      font-family: monospace;
      font-size: 12px;
    }

    .image-preview {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      min-height: 60px;
    }

    .image-preview .preview-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .image-preview .preview-item {
      position: relative;
      display: inline-block;
    }

    .image-preview .preview-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .image-preview .preview-item .remove-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: none;
    }

    .image-preview .preview-item:hover .remove-btn {
      display: block;
    }

    .image-edit-tips {
      margin-top: 5px;
      color: #666;
    }

    .image-edit-tips small {
      font-size: 11px;
    }

    /* è¯„å®¡ç»“æœè¯¦æƒ…ç¼–è¾‘æ¨¡å¼æ ·å¼ */
    .detail-content {
      padding: 20px;
    }

    .detail-section {
      margin-bottom: 30px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      background-color: #f8f9fa;
    }

    .detail-section h3 {
      margin-bottom: 20px;
      color: #495057;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }

    .detail-item.full-width {
      grid-column: 1 / -1;
    }

    .detail-item label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .detail-item span,
    .detail-item .problem-desc {
      color: #333;
      padding: 8px 12px;
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      min-height: 38px;
      display: flex;
      align-items: center;
      word-break: break-word;
    }

    .detail-item .problem-desc {
      min-height: 60px;
      white-space: pre-wrap;
    }

    /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
    .detail-item input,
    .detail-item textarea,
    .detail-item select {
      padding: 8px 12px;
      border: 1px solid #007bff;
      border-radius: 4px;
      font-size: 14px;
      background-color: #fff;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .detail-item input:focus,
    .detail-item textarea:focus,
    .detail-item select:focus {
      outline: 0;
      border-color: #80bdff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .detail-item textarea {
      resize: vertical;
      min-height: 80px;
    }

    .detail-item select {
      cursor: pointer;
    }

    /* ç¼–è¾‘çŠ¶æ€ä¸‹çš„åªè¯»å­—æ®µæ ·å¼ */
    .detail-item.readonly span,
    .detail-item.readonly .problem-desc {
      background-color: #f8f9fa;
      color: #6c757d;
      border-color: #e9ecef;
      cursor: not-allowed;
    }

    /* æ”¶è—å¤¹æ¨¡æ€æ¡†æ ·å¼ä¿®å¤ */
    .cart-items-container {
      margin-top: 20px;
    }

    .cart-items-container .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .cart-items-container .data-table th,
    .cart-items-container .data-table td {
      padding: 12px 8px;
      text-align: left;
      border: 1px solid #ddd;
      background-color: #fff;
      color: #333;
    }

    .cart-items-container .data-table th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #495057;
    }

    .cart-items-container .data-table tbody tr:hover {
      background-color: #f5f5f5;
    }

    .cart-items-container .data-table tbody tr:hover td {
      background-color: #f5f5f5;
      color: #333;
    }

    .cart-items-container .filter-desc {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #333 !important;
    }







    /* åˆå¹¶æ•°æ®å±•ç¤ºåŒºåŸŸæ ·å¼ */
    .merged-data-section {
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f8f9fa;
    }

    .merged-data-section h3 {
      color: #495057;
      margin-bottom: 15px;
    }

    .merged-stats {
      margin-bottom: 15px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .merged-stats span {
      color: #495057;
      font-size: 14px;
    }

    .merged-stats strong {
      color: #007bff;
      font-weight: bold;
    }

    .merged-table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .merged-table-container .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    .merged-table-container .data-table th,
    .merged-table-container .data-table td {
      padding: 8px 6px;
      text-align: left;
      border: 1px solid #ddd;
      background-color: #fff;
      color: #333;
      font-size: 12px;
    }

    .merged-table-container .data-table th {
      background-color: #e9ecef;
      font-weight: bold;
      color: #495057;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .merged-table-container .data-table tbody tr:hover {
      background-color: #f5f5f5;
    }

    .merged-table-container .data-table tbody tr:hover td {
      background-color: #f5f5f5;
      color: #333;
    }

    .merged-table-container .problem-desc {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #333 !important;
    }

    /* å¤´éƒ¨å¸ƒå±€æ ·å¼ */
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .header-left {
      flex: 0 0 auto;
    }

    .header-center {
      flex: 1;
      text-align: center;
    }

    .header-right {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }

    /* å¤´éƒ¨æ“ä½œæŒ‰é’®æ ·å¼ */
    .header-action-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-action-buttons .btn {
      padding: 8px 16px;
      font-size: 13px;
    }

    /* å¯¼å…¥æŒ‰é’®æ ·å¼ */
    .header-left .btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      background: linear-gradient(135deg, #dc3545, #e74c3c);
      border: none;
      color: white;
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
      transition: all 0.3s ease;
    }

    .header-left .btn:hover {
      background: linear-gradient(135deg, #c82333, #d63031);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4);
    }

    .header-left .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }

    /* å¯¼å…¥æ¨¡æ€æ¡†æ ·å¼ */
    .import-container {
      display: flex;
      gap: 30px;
      padding: 20px 0;
    }

    .template-section, .upload-section {
      flex: 1;
      padding: 20px;
      border: 2px dashed #e0e0e0;
      border-radius: 10px;
      text-align: center;
      background: #fafafa;
    }

    .template-section h3, .upload-section h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .template-section p, .upload-section p {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .template-info {
      margin-top: 15px;
      color: #888;
    }

    .upload-area {
      border: 2px dashed #007bff;
      border-radius: 8px;
      padding: 40px 20px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }

    .upload-area:hover {
      border-color: #0056b3;
      background: #e3f2fd;
    }

    .upload-area.dragover {
      border-color: #28a745;
      background: #d4edda;
    }

    .upload-area i {
      font-size: 48px;
      color: #007bff;
      margin-bottom: 15px;
    }

    .file-info {
      color: #6c757d;
      font-size: 12px;
      margin-top: 10px;
    }

    .upload-progress {
      margin-top: 15px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #28a745);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 20px;
      border-top: 1px solid #e0e0e0;
    }

    /* æœç´¢å’Œé‡ç½®æŒ‰é’®æ ·å¼ */
    .search-reset-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 10;
    }

    .search-reset-buttons .btn {
      padding: 10px 20px;
      position: relative;
    }

    .shortcut-hint {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-left: 5px;
      font-weight: normal;
    }

    .btn:hover .shortcut-hint {
      color: rgba(255, 255, 255, 0.9);
    }

    /* æ”¶è—å¤¹æ§åˆ¶æŒ‰é’®æ ·å¼ */
    .cart-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .cart-controls .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    /* è¡¨æ ¼å¤é€‰æ¡†æ ·å¼ */
    .table-row-checkbox {
      transform: scale(1.2);
      cursor: pointer;
    }

    .table-row-checkbox:hover {
      transform: scale(1.3);
    }

    #selectAllTableRows {
      transform: scale(1.3);
      cursor: pointer;
    }

    #selectAllTableRows:hover {
      transform: scale(1.4);
    }

    /* è¡¨æ ¼è¡Œé€‰ä¸­çŠ¶æ€æ ·å¼ */
    tr:has(.table-row-checkbox:checked) {
      background-color: #e3f2fd !important;
    }

    tr:has(.table-row-checkbox:checked):hover {
      background-color: #bbdefb !important;
    }

    /* æ”¶è—å¤¹è¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ */
    .cart-detail-info {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .cart-detail-info .detail-row {
      display: flex;
      margin-bottom: 8px;
      align-items: flex-start;
    }

    .cart-detail-info .detail-row:last-child {
      margin-bottom: 0;
    }

    .cart-detail-info label {
      font-weight: bold;
      color: #495057;
      min-width: 100px;
      margin-right: 10px;
    }

    .cart-detail-info .detail-value {
      color: #333;
      flex: 1;
      word-break: break-all;
    }

    .cart-detail-table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .cart-detail-table-container .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    .cart-detail-table-container .data-table th,
    .cart-detail-table-container .data-table td {
      padding: 8px 6px;
      text-align: left;
      border: 1px solid #ddd;
      background-color: #fff;
      color: #333;
      font-size: 12px;
    }

    .cart-detail-table-container .data-table th {
      background-color: #e9ecef;
      font-weight: bold;
      color: #495057;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .cart-detail-table-container .data-table tbody tr:hover {
      background-color: #f5f5f5;
    }

    .cart-detail-table-container .data-table tbody tr:hover td {
      background-color: #f5f5f5;
      color: #333;
    }

    .cart-detail-table-container .problem-desc {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #333 !important;
    }

    /* ä¸»æ§åˆ¶åŒºåŸŸæ ·å¼ */
    .main-control-section {
      display: grid;
      grid-template-columns: 400px 1fr; /* å·¦ä¾§å›ºå®šå®½åº¦ï¼Œå³ä¾§å æ®å‰©ä½™ç©ºé—´ */
      gap: 20px;
      margin-bottom: 20px;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 600px; /* è®¾ç½®å›ºå®šæœ€å°é«˜åº¦ */
    }

    /* æ•°æ®è¡¨æ ¼åŒºåŸŸæ ·å¼ */
    .table-section {
      margin-top: 20px; /* æ·»åŠ é¡¶éƒ¨é—´è· */
      margin-bottom: 20px; /* æ·»åŠ åº•éƒ¨é—´è· */
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* æ•´ä½“é¡µé¢å¸ƒå±€ä¼˜åŒ– */
    .main-content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }


    .filter-container {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 100%; /* å¡«æ»¡ç½‘æ ¼å•å…ƒæ ¼ */
      overflow-y: auto; /* å¦‚æœå†…å®¹è¿‡å¤šï¼Œå…è®¸æ»šåŠ¨ */
      min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
    }

    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .chart-container {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 100%; /* å¡«æ»¡ç½‘æ ¼å•å…ƒæ ¼ */
      min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e9ecef;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .chart-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .field-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    .field-selector label {
      font-size: 14px;
      font-weight: 500;
      color: #495057;
      white-space: nowrap;
    }

    .field-selector select {
      padding: 6px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      background: white;
      min-width: 120px;
    }

    .chart-type-buttons {
      display: flex;
      gap: 5px;
    }

    .chart-type-btn {
      padding: 6px 12px;
      border: 1px solid #ced4da;
      background: white;
      color: #495057;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .chart-type-btn:hover {
      background: #f8f9fa;
      border-color: #007bff;
    }

    .chart-type-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    .chart-canvas-container {
      position: relative;
      flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
      width: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 450px; /* å¢åŠ æœ€å°é«˜åº¦ï¼Œåˆ©ç”¨æ›´å¤§ç©ºé—´ */
      max-height: 600px; /* å¢åŠ æœ€å¤§é«˜åº¦ï¼Œå……åˆ†åˆ©ç”¨ç©ºé—´ */
    }

    .chart-canvas {
      max-width: 100%;
      max-height: 100%;
      width: 100% !important;
      height: 100% !important;
    }

    /* å“åº”å¼è®¾è®¡ - ç¡®ä¿åœ¨ä¸åŒç¼©æ”¾çº§åˆ«ä¸‹å¸ƒå±€ä¸€è‡´ */
    @media (max-width: 1000px) {
      .main-control-section {
        grid-template-columns: 350px 1fr; /* ç¨å¾®ç¼©å°å·¦ä¾§å®½åº¦ */
      }
    }

    @media (max-width: 800px) {
      .main-control-section {
        grid-template-columns: 1fr; /* åœ¨å°å±å¹•ä¸Šæ”¹ä¸ºå•åˆ— */
        min-height: auto; /* åœ¨å°å±å¹•ä¸Šå…è®¸é«˜åº¦è‡ªé€‚åº” */
      }

      .filter-container,
      .chart-container {
        height: auto; /* åœ¨å°å±å¹•ä¸Šå…è®¸é«˜åº¦è‡ªé€‚åº” */
      }
    }

    /* è¶…å°å±å¹•ä¼˜åŒ– */
    @media (max-width: 768px) {
      .main-control-section {
        padding: 15px;
        gap: 15px;
      }

      .filter-container,
      .chart-container {
        padding: 15px;
      }
    }

    .no-data-message {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 40px;
    }

    .filters-main-container {
      margin-left: 0;
      margin-right: auto;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .basic-filters-container {
      width: 100%;
      overflow: visible;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
      margin-left: 0;
      margin-right: auto;
      box-sizing: border-box;
      min-height: 550px;
    }

    .filter-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
      width: 100%;
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 4px;
      width: calc(50% - 4px); /* æ¯è¡Œ2ä¸ªï¼Œæ¯ä¸ªå 50%å®½åº¦ï¼Œå‡å»é—´è· */
      flex: 0 0 auto;
      margin-bottom: 8px;
      box-sizing: border-box;
    }

    .filter-group label {
      white-space: nowrap;
      width: 60px;
      font-weight: 500;
      color: #495057;
      font-size: 14px;
      flex-shrink: 0;
    }

    .filter-group input,
    .filter-group select {
      flex: 1;
      height: 32px;
      padding: 4px 8px;
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 3px;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      outline: none;
    }

    /* æ—¥æœŸè¿‡æ»¤å™¨ç‰¹æ®Šæ ·å¼ */
    .filter-group input[type="date"] {
      width: 80px;
      font-size: 13px;
    }

    .filter-group span {
      color: #6c757d;
      font-size: 12px;
      margin: 0 2px;
      flex-shrink: 0;
    }

    /* æ—¥æœŸèŒƒå›´è¿‡æ»¤å™¨ç‰¹æ®Šå¸ƒå±€ */
    .filter-group:has(input[type="date"]) {
      width: calc(50% - 4px);
    }

    /* å“åº”å¼è®¾è®¡ - å°å±å¹•æ—¶æ¯è¡Œæ˜¾ç¤ºæ›´å°‘ */
    @media (max-width: 1200px) {
      .filter-group {
        width: calc(50% - 4px); /* æ¯è¡Œ2ä¸ª */
      }
    }

    @media (max-width: 900px) {
      .filter-group {
        width: calc(50% - 4px); /* æ¯è¡Œ2ä¸ª */
      }
    }

    @media (max-width: 600px) {
      .filter-group {
        width: calc(100% - 8px); /* æ¯è¡Œ1ä¸ª */
      }
    }
  </style>
</head>
<body>
<!-- é¡µé¢å¤´éƒ¨ -->
<div class="header">
  <div class="header-content">
    <!-- å¯¼å…¥æŒ‰é’® - æœ€å·¦ä¸Šè§’ -->
    <div class="header-left">
      <button id="importBtn" class="btn btn-primary">
        <i class="fas fa-upload"></i> å¯¼å…¥è¯„å®¡ç»“æœæ•°æ®
      </button>
    </div>

    <!-- é¡µé¢æ ‡é¢˜ - å±…ä¸­ -->
    <div class="header-center">
      <h1 class="page-title">
        <i class="fas fa-clipboard-check"></i>
        è¯„å®¡ç»“æœç®¡ç†
      </h1>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ“ä½œæŒ‰é’® - å³ä¾§ -->
    <div class="header-right">
      <div class="user-info">
        <span id="currentUser"></span>
        <span id="currentRole"></span>
        <span id="cacheStatus" class="cache-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
      </div>

      <!-- å…¶ä»–æ“ä½œæŒ‰é’®ç»„ -->
      <div class="header-action-buttons">
        <button id="exportBtn" class="btn btn-success">
          <i class="fas fa-download"></i> å¯¼å‡ºç­›é€‰ç»“æœ
        </button>
        <button id="addToCartBtn" class="btn btn-warning">
          <i class="fas fa-shopping-cart"></i> åŠ å…¥æ”¶è—å¤¹
        </button>
        <button id="showCartBtn" class="btn btn-info">
          <i class="fas fa-list"></i> æŸ¥çœ‹æ”¶è—å¤¹ (<span id="cartCount">0</span>)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- å¯¼å…¥è¯„å®¡ç»“æœæ¨¡æ€æ¡† -->
<div id="importModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>å¯¼å…¥è¯„å®¡ç»“æœæ•°æ®</h2>
      <span class="close" onclick="closeImportModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="import-container">
        <!-- å·¦ä¾§ï¼šæ¨¡æ¿æ–‡ä»¶ä¸‹è½½ -->
        <div class="template-section">
          <h3><i class="fas fa-download"></i> ä¸‹è½½æ¨¡æ¿æ–‡ä»¶</h3>
          <p>è¯·å…ˆä¸‹è½½æ¨¡æ¿æ–‡ä»¶ï¼ŒæŒ‰ç…§æ¨¡æ¿æ ¼å¼å¡«å†™æ•°æ®åä¸Šä¼ </p>
          <button id="downloadTemplateBtn" class="btn btn-info">
            <i class="fas fa-file-excel"></i> ä¸‹è½½è¯„å®¡ç»“æœæ¨¡æ¿
          </button>
          <div class="template-info">
            <small>æ¨¡æ¿æ–‡ä»¶åŒ…å«æ‰€æœ‰å¿…å¡«å­—æ®µçš„ç¤ºä¾‹æ•°æ®</small>
          </div>
        </div>

        <!-- å³ä¾§ï¼šæ–‡ä»¶ä¸Šä¼  -->
        <div class="upload-section">
          <h3><i class="fas fa-upload"></i> ä¸Šä¼ æ•°æ®æ–‡ä»¶</h3>
          <p>é€‰æ‹©å¡«å†™å¥½çš„Excelæ–‡ä»¶è¿›è¡Œå¯¼å…¥</p>
          <div class="upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
            <p class="file-info">æ”¯æŒ .xlsx æ ¼å¼ï¼Œæœ€å¤§ 100MB</p>
          </div>
          <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
          <div class="upload-progress" id="uploadProgress" style="display: none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="progress-text" id="progressText">0%</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
      <button id="confirmImportBtn" class="btn btn-primary" disabled>ç¡®è®¤å¯¼å…¥</button>
    </div>
  </div>
</div>

<!-- ç­›é€‰å’Œæ“ä½œåŒºåŸŸ -->
<div class="main-control-section">
  <div class="filter-container">
    <!-- ç­›é€‰å™¨ä¸»å®¹å™¨ï¼ˆå¹³è¡Œå¸ƒå±€ï¼‰ -->
    <div class="filters-main-container">
      <!-- åŸºç¡€ç­›é€‰å™¨ï¼ˆå·¦ä¾§ï¼‰ -->
      <div class="basic-filters-container">
        <div class="filter-row">
          <div class="filter-group">
            <label>å¤§ç¼–ç :</label>
            <input type="text" id="majorCodeFilter" placeholder="è¾“å…¥å¤§ç¼–ç ">
          </div>
          <div class="filter-group">
            <label>å°ç¼–ç :</label>
            <input type="text" id="minorCodeFilter" placeholder="è¾“å…¥å°ç¼–ç ">
          </div>
          <div class="filter-group">
            <label>é¡¹ç›®é˜¶æ®µ:</label>
            <input type="text" id="projectPhaseFilter" placeholder="è¾“å…¥é¡¹ç›®é˜¶æ®µ">
          </div>
          <div class="filter-group">
            <label>ç‰ˆæœ¬:</label>
            <input type="text" id="versionFilter" placeholder="è¾“å…¥ç‰ˆæœ¬">
          </div>
          <div class="filter-group">
            <label>ä¾›åº”å•†:</label>
            <input type="text" id="supplierFilter" placeholder="è¾“å…¥ä¾›åº”å•†">
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-group">
            <label>æµ‹è¯•æ—¥æœŸ:</label>
            <input type="date" id="testStartDateFilter">
            <span>è‡³</span>
            <input type="date" id="testEndDateFilter">
          </div>
        </div>



        <!-- æœç´¢å’Œé‡ç½®æŒ‰é’® -->
        <div class="search-reset-buttons">
          <button id="searchBtn" class="btn btn-primary" title="æœç´¢ (Enter)">
            <i class="fas fa-search"></i> æœç´¢
            <span class="shortcut-hint">(Enter)</span>
          </button>
          <button id="resetBtn" class="btn btn-secondary">
            <i class="fas fa-undo"></i> é‡ç½®
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- å›¾è¡¨å®¹å™¨ -->
  <div class="chart-container">
    <div class="chart-header">
      <h3 class="chart-title">æ•°æ®å¯è§†åŒ–</h3>
      <div class="chart-controls">
        <div class="chart-type-buttons">
          <button class="chart-type-btn active" data-type="bar" onclick="console.log('ğŸ”¥ æŸ±çŠ¶å›¾æŒ‰é’®è¢«ç‚¹å‡»!'); switchChartType('bar')">æŸ±çŠ¶å›¾</button>
          <button class="chart-type-btn" data-type="pie" onclick="console.log('ğŸ”¥ é¥¼çŠ¶å›¾æŒ‰é’®è¢«ç‚¹å‡»!'); switchChartType('pie')">é¥¼çŠ¶å›¾</button>
          <button class="chart-type-btn" data-type="line" onclick="console.log('ğŸ”¥ æŠ˜çº¿å›¾æŒ‰é’®è¢«ç‚¹å‡»!'); switchChartType('line')">æŠ˜çº¿å›¾</button>
        </div>
      </div>
    </div>

    <div class="field-selector">
      <label>åˆ†ç»„å­—æ®µ:</label>
      <select id="groupField">
        <option value="">è¯·é€‰æ‹©åˆ†ç»„å­—æ®µ</option>
        <option value="problemLevel">é—®é¢˜ç­‰çº§</option>
        <option value="majorCode">å¤§ç¼–ç </option>
        <option value="minorCode">å°ç¼–ç </option>
        <option value="projectPhase">é¡¹ç›®é˜¶æ®µ</option>
        <option value="version">ç‰ˆæœ¬</option>
        <option value="problemProcess">é—®é¢˜å·¥åº</option>
        <option value="developmentMethod">å¼€å‘æ–¹å¼</option>
        <option value="supplier">ä¾›åº”å•†</option>
        <option value="solutionProvider">æ–¹æ¡ˆå•†</option>
        <option value="problemPoint">é—®é¢˜ç‚¹</option>
        <option value="problemReason">é—®é¢˜åŸå› </option>
        <option value="improvementStrategy">æ”¹å–„å¯¹ç­–</option>
        <option value="isPreventable">æ˜¯å¦å¯é¢„é˜²</option>
        <option value="responsibleDepartment">è´£ä»»éƒ¨é—¨</option>
        <option value="problemStatus">é—®é¢˜çŠ¶æ€</option>
        <option value="problemTag1">é—®é¢˜æ‰“æ ‡1</option>
        <option value="problemTag2">é—®é¢˜æ‰“æ ‡2</option>
      </select>

      <button id="generateChartBtn" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;" onclick="console.log('ğŸ”¥ ç”Ÿæˆå›¾è¡¨æŒ‰é’®è¢«ç‚¹å‡»!'); generateChart()">ç”Ÿæˆå›¾è¡¨</button>
    </div>

    <div class="chart-canvas-container">
      <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-left: 4px solid #2196f3; font-size: 14px; color: #1976d2;">
        <i class="fas fa-info-circle"></i> å›¾è¡¨å°†æ˜¾ç¤ºæ‰€æœ‰æœç´¢ç»“æœçš„æ•°æ®ï¼Œä¸å—åˆ†é¡µé™åˆ¶ã€‚æ¯ä¸ªæŸ±çŠ¶å›¾ä¸Šæ–¹ä¼šæ˜¾ç¤ºå…·ä½“æ•°å€¼ï¼Œå…³é—­ç‡æ˜¾ç¤ºä¸ºç™¾åˆ†æ¯”ã€‚
      </div>
      <div id="chartStatus" style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-left: 4px solid #6c757d; font-size: 14px; color: #495057; display: none;">
        <i class="fas fa-chart-bar"></i> <span id="chartStatusText">å‡†å¤‡å°±ç»ª</span>
      </div>
      <canvas id="dataChart" class="chart-canvas"></canvas>
      <div id="noDataMessage" class="no-data-message" style="display: none;">
        è¯·å…ˆé€‰æ‹©è¦å±•ç¤ºçš„å­—æ®µï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®
      </div>
    </div>
  </div>
</div>

<!-- æ•°æ®è¡¨æ ¼åŒºåŸŸ -->
<div class="table-section">
  <div class="table-container">
    <table id="reviewTable" class="data-table">
      <thead>
      <tr>
        <th>
          <input type="checkbox" id="selectAllTableRows" title="å…¨é€‰/å–æ¶ˆå…¨é€‰">
        </th>
        <th>ID</th>
        <th>æµ‹è¯•æ—¥æœŸ</th>
        <th>å¤§ç¼–ç </th>
        <th>å°ç¼–ç </th>
        <th>é¡¹ç›®é˜¶æ®µ</th>
        <th>ç‰ˆæœ¬</th>
        <th>é—®é¢˜å·¥åº</th>
        <th>é—®é¢˜ç­‰çº§</th>
        <th>å¼€å‘æ–¹å¼</th>
        <th>ä¾›åº”å•†</th>
        <th>æ–¹æ¡ˆå•†</th>
        <th>é—®é¢˜ç‚¹</th>
        <th>é—®é¢˜åŸå› </th>
        <th>æ”¹å–„å¯¹ç­–</th>
        <th>æ˜¯å¦å¯é¢„é˜²</th>
        <th>è´£ä»»éƒ¨é—¨</th>
        <th>é—®é¢˜çŠ¶æ€</th>
        <th>é¢„è®¡å®Œæˆæ—¶é—´</th>
        <th>å®é™…å®Œæˆæ—¶é—´</th>
        <th>Delayå¤©æ•°</th>
        <th>é—®é¢˜æ‰“æ ‡1</th>
        <th>é—®é¢˜æ‰“æ ‡2</th>
        <th>é¢„é˜²å¤‡æ³¨</th>
        <th>åˆ›å»ºæ—¶é—´</th>
        <th>æ›´æ–°æ—¶é—´</th>
        <th>æ“ä½œ</th>
      </tr>
      </thead>
      <tbody id="reviewTableBody">
      <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </tbody>
    </table>
  </div>

  <!-- åˆ†é¡µæ§ä»¶ -->
  <div class="pagination-container">
    <div class="pagination-info">
      <span>æ˜¾ç¤ºç¬¬ <span id="startRecord">1</span> - <span id="endRecord">10</span> æ¡ï¼Œå…± <span id="totalRecords">0</span> æ¡è®°å½•</span>
      <div class="page-size-selector">
        <label>æ¯é¡µæ˜¾ç¤º:</label>
        <select id="pageSizeSelect">
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span>æ¡</span>
      </div>
    </div>
    <div class="pagination-controls">
      <button id="firstPageBtn" class="btn btn-sm" title="é¦–é¡µ">é¦–é¡µ</button>
      <button id="prevPageBtn" class="btn btn-sm">ä¸Šä¸€é¡µ</button>
      <div class="page-numbers" id="pageNumbers">
        <!-- é¡µç æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <button id="nextPageBtn" class="btn btn-sm">ä¸‹ä¸€é¡µ</button>
      <button id="lastPageBtn" class="btn btn-sm" title="æœ«é¡µ">æœ«é¡µ</button>
      <div class="page-jump">
        <span>è·³è½¬åˆ°</span>
        <input type="number" id="pageJumpInput" min="1" style="width: 60px; margin: 0 5px;">
        <span>é¡µ</span>
        <button id="pageJumpBtn" class="btn btn-sm">è·³è½¬</button>
      </div>
    </div>
  </div>
</div>

<!-- è¯„å®¡ç»“æœè¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="reviewDetailModal" class="modal">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>è¯„å®¡ç»“æœè¯¦æƒ…</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="detail-content">
        <div class="detail-section">
          <h3>åŸºæœ¬ä¿¡æ¯</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>æµ‹è¯•æ—¥æœŸ:</label>
              <span id="detailTestDate">-</span>
            </div>
            <div class="detail-item">
              <label>å¤§ç¼–ç :</label>
              <span id="detailMajorCode">-</span>
            </div>
            <div class="detail-item">
              <label>å°ç¼–ç :</label>
              <span id="detailMinorCode">-</span>
            </div>
            <div class="detail-item">
              <label>é¡¹ç›®é˜¶æ®µ:</label>
              <span id="detailProjectPhase">-</span>
            </div>
            <div class="detail-item">
              <label>ç‰ˆæœ¬:</label>
              <span id="detailVersion">-</span>
            </div>
            <div class="detail-item">
              <label>é—®é¢˜å·¥åº:</label>
              <span id="detailProblemProcess">-</span>
            </div>
            <div class="detail-item">
              <label>é—®é¢˜ç­‰çº§:</label>
              <span id="detailProblemLevel">-</span>
            </div>
            <div class="detail-item">
              <label>å¼€å‘æ–¹å¼:</label>
              <span id="detailDevelopmentMethod">-</span>
            </div>
            <div class="detail-item">
              <label>ä¾›åº”å•†:</label>
              <span id="detailSupplier">-</span>
            </div>
            <div class="detail-item">
              <label>æ–¹æ¡ˆå•†:</label>
              <span id="detailSolutionProvider">-</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>é—®é¢˜ä¿¡æ¯</h3>
          <div class="detail-grid">
            <div class="detail-item full-width">
              <label>é—®é¢˜ç‚¹:</label>
              <div class="problem-desc" id="detailProblemPoint">-</div>
            </div>
            <div class="detail-item full-width">
              <label>é—®é¢˜åŸå› :</label>
              <div class="problem-desc" id="detailProblemReason">-</div>
            </div>
            <div class="detail-item full-width">
              <label>æ”¹å–„å¯¹ç­–:</label>
              <div class="problem-desc" id="detailImprovementMeasures">-</div>
            </div>
            <div class="detail-item">
              <label>æ˜¯å¦å¯é¢„é˜²:</label>
              <span id="detailIsPreventable">-</span>
            </div>
            <div class="detail-item">
              <label>è´£ä»»éƒ¨é—¨:</label>
              <span id="detailResponsibleDepartment">-</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>æ—¶é—´ä¿¡æ¯</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>é¢„è®¡å®Œæˆæ—¶é—´:</label>
              <span id="detailPlannedCompletionTime">-</span>
            </div>
            <div class="detail-item">
              <label>å®é™…å®Œæˆæ—¶é—´:</label>
              <span id="detailActualCompletionTime">-</span>
            </div>
            <div class="detail-item">
              <label>Delayå¤©æ•°:</label>
              <span id="detailDelayDays">-</span>
            </div>
            <div class="detail-item">
              <label>é—®é¢˜çŠ¶æ€:</label>
              <span id="detailProblemStatus">-</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>å…¶ä»–ä¿¡æ¯</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>é—®é¢˜æ‰“æ ‡1:</label>
              <span id="detailProblemTag1">-</span>
            </div>
            <div class="detail-item">
              <label>é—®é¢˜æ‰“æ ‡2:</label>
              <span id="detailProblemTag2">-</span>
            </div>
            <div class="detail-item full-width">
              <label>é¢„é˜²å¤‡æ³¨:</label>
              <div class="problem-desc" id="detailPreventionNotes">-</div>
            </div>
            <div class="detail-item">
              <label>åˆ›å»ºæ—¶é—´:</label>
              <span id="detailCreatedTime">-</span>
            </div>
            <div class="detail-item">
              <label>æ›´æ–°æ—¶é—´:</label>
              <span id="detailUpdatedTime">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="editReviewBtn" class="btn btn-primary" style="display: none;">ç¼–è¾‘</button>
      <button id="saveReviewBtn" class="btn btn-success" style="display: none;">ä¿å­˜</button>
      <button id="cancelEditReviewBtn" class="btn btn-secondary" style="display: none;">å–æ¶ˆ</button>
      <button id="closeReviewDetailModal" class="btn btn-secondary">å…³é—­</button>
    </div>
  </div>
</div>

<!-- é—®é¢˜ç‚¹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="problemDetailModal" class="modal">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>é—®é¢˜ç‚¹è¯¦æƒ…</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editProblemId" value="">
      <div class="detail-grid">
        <div class="detail-section">
          <h3>åŸºæœ¬ä¿¡æ¯</h3>
          <div class="detail-row">
            <label>æ ·å“ID:</label>
            <span id="detailSampleId" class="detail-value"></span>
          </div>
          <div class="detail-row">
            <label>å®Œæ•´ç¼–ç :</label>
            <span id="detailFullModel" class="detail-value"></span>
            <input type="text" id="editDetailFullModel" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>å¤§ç±»:</label>
            <span id="detailBigSpecies" class="detail-value"></span>
            <input type="text" id="editDetailBigSpecies" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>å°ç±»:</label>
            <span id="detailSmallSpecies" class="detail-value"></span>
            <input type="text" id="editDetailSmallSpecies" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>æ ·å“é˜¶æ®µ:</label>
            <span id="detailSampleStage" class="detail-value"></span>
            <input type="text" id="editDetailSampleStage" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>ç‰ˆæœ¬:</label>
            <span id="detailVersion" class="detail-value"></span>
            <input type="text" id="editDetailVersion" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>èŠ¯ç‰‡æ–¹æ¡ˆ:</label>
            <span id="detailChipSolution" class="detail-value"></span>
            <input type="text" id="editDetailChipSolution" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>æµ‹è¯•å¹³å°:</label>
            <span id="detailTestPlatform" class="detail-value"></span>
            <input type="text" id="editDetailTestPlatform" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>æ˜¾ç¤ºè®¾å¤‡:</label>
            <span id="detailTestDevice" class="detail-value"></span>
            <input type="text" id="editDetailTestDevice" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>å…¶ä»–è®¾å¤‡:</label>
            <span id="detailOtherDevice" class="detail-value"></span>
            <input type="text" id="editDetailOtherDevice" class="detail-input" style="display: none;">
          </div>
        </div>

        <div class="detail-section">
          <h3>é—®é¢˜ä¿¡æ¯</h3>
          <div class="detail-row">
            <label>é—®é¢˜æè¿°:</label>
            <div id="detailProblem" class="detail-value"></div>
            <textarea id="editDetailProblem" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>é—®é¢˜å›¾ç‰‡:</label>
            <div id="detailProblemImage" class="detail-value problem-image-container"></div>
          </div>
          <div class="detail-row">
            <label>é—®é¢˜ç±»åˆ«:</label>
            <span id="detailProblemCategory" class="detail-value"></span>
            <select id="editDetailProblemCategory" class="detail-input" style="display: none;">
              <option value="">è¯·é€‰æ‹©é—®é¢˜ç±»åˆ«</option>
              <optgroup label="è§†é¢‘ç»„">
                <option value="è§†é¢‘æ’­æ”¾é—®é¢˜">è§†é¢‘æ’­æ”¾é—®é¢˜</option>
                <option value="è§†é¢‘å½•åˆ¶é—®é¢˜">è§†é¢‘å½•åˆ¶é—®é¢˜</option>
                <option value="è§†é¢‘ç¼–ç é—®é¢˜">è§†é¢‘ç¼–ç é—®é¢˜</option>
                <option value="è§†é¢‘è§£ç é—®é¢˜">è§†é¢‘è§£ç é—®é¢˜</option>
                <option value="è§†é¢‘ä¼ è¾“é—®é¢˜">è§†é¢‘ä¼ è¾“é—®é¢˜</option>
                <option value="è§†é¢‘æ˜¾ç¤ºé—®é¢˜">è§†é¢‘æ˜¾ç¤ºé—®é¢˜</option>
                <option value="è§†é¢‘æ ¼å¼é—®é¢˜">è§†é¢‘æ ¼å¼é—®é¢˜</option>
                <option value="è§†é¢‘ç”»è´¨é—®é¢˜">è§†é¢‘ç”»è´¨é—®é¢˜</option>
                <option value="è§†é¢‘åŒæ­¥é—®é¢˜">è§†é¢‘åŒæ­¥é—®é¢˜</option>
                <option value="è§†é¢‘å¡é¡¿é—®é¢˜">è§†é¢‘å¡é¡¿é—®é¢˜</option>
              </optgroup>
              <optgroup label="è“ç‰™ç»„">
                <option value="è“ç‰™è¿æ¥é—®é¢˜">è“ç‰™è¿æ¥é—®é¢˜</option>
                <option value="è“ç‰™é…å¯¹é—®é¢˜">è“ç‰™é…å¯¹é—®é¢˜</option>
                <option value="è“ç‰™ä¼ è¾“é—®é¢˜">è“ç‰™ä¼ è¾“é—®é¢˜</option>
                <option value="è“ç‰™éŸ³é¢‘é—®é¢˜">è“ç‰™éŸ³é¢‘é—®é¢˜</option>
                <option value="è“ç‰™ä¿¡å·é—®é¢˜">è“ç‰™ä¿¡å·é—®é¢˜</option>
                <option value="è“ç‰™å…¼å®¹æ€§é—®é¢˜">è“ç‰™å…¼å®¹æ€§é—®é¢˜</option>
                <option value="è“ç‰™åŠŸè€—é—®é¢˜">è“ç‰™åŠŸè€—é—®é¢˜</option>
                <option value="è“ç‰™åè®®é—®é¢˜">è“ç‰™åè®®é—®é¢˜</option>
                <option value="è“ç‰™è®¾å¤‡è¯†åˆ«é—®é¢˜">è“ç‰™è®¾å¤‡è¯†åˆ«é—®é¢˜</option>
                <option value="è“ç‰™æ–­è¿é—®é¢˜">è“ç‰™æ–­è¿é—®é¢˜</option>
              </optgroup>
              <optgroup label="ç¡¬ä»¶ç»„">
                <option value="ç¡¬ä»¶è®¾è®¡é—®é¢˜">ç¡¬ä»¶è®¾è®¡é—®é¢˜</option>
                <option value="ç”Ÿäº§é—®é¢˜">ç”Ÿäº§é—®é¢˜</option>
                <option value="å™¨ä»¶é—®é¢˜">å™¨ä»¶é—®é¢˜</option>
                <option value="é…ä»¶é—®é¢˜">é…ä»¶é—®é¢˜</option>
                <option value="å¤–è§‚é—®é¢˜">å¤–è§‚é—®é¢˜</option>
                <option value="PCBAé—®é¢˜">PCBAé—®é¢˜</option>
                <option value="ç”µè·¯é—®é¢˜">ç”µè·¯é—®é¢˜</option>
                <option value="æ¥å£é—®é¢˜">æ¥å£é—®é¢˜</option>
                <option value="æ•£çƒ­é—®é¢˜">æ•£çƒ­é—®é¢˜</option>
                <option value="æœºæ¢°ç»“æ„é—®é¢˜">æœºæ¢°ç»“æ„é—®é¢˜</option>
              </optgroup>
              <optgroup label="è½¯ä»¶ç»„">
                <option value="è½¯ä»¶é—®é¢˜">è½¯ä»¶é—®é¢˜</option>
                <option value="ç³»ç»Ÿé—®é¢˜">ç³»ç»Ÿé—®é¢˜</option>
                <option value="é©±åŠ¨é—®é¢˜">é©±åŠ¨é—®é¢˜</option>
                <option value="å›ºä»¶é—®é¢˜">å›ºä»¶é—®é¢˜</option>
                <option value="åº”ç”¨é—®é¢˜">åº”ç”¨é—®é¢˜</option>
                <option value="ç•Œé¢é—®é¢˜">ç•Œé¢é—®é¢˜</option>
                <option value="æ€§èƒ½é—®é¢˜">æ€§èƒ½é—®é¢˜</option>
                <option value="å…¼å®¹æ€§é—®é¢˜">å…¼å®¹æ€§é—®é¢˜</option>
                <option value="ç¨³å®šæ€§é—®é¢˜">ç¨³å®šæ€§é—®é¢˜</option>
                <option value="åŠŸèƒ½ç¼ºå¤±é—®é¢˜">åŠŸèƒ½ç¼ºå¤±é—®é¢˜</option>
              </optgroup>
            </select>
          </div>
          <div class="detail-row">
            <label>ç¼ºé™·ç­‰çº§:</label>
            <span id="detailDefectLevel" class="detail-value"></span>
            <select id="editDetailDefectLevel" class="detail-input" style="display: none;">
              <option value="S">S</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="å¾…ç¡®å®š">å¾…ç¡®å®š</option>
            </select>
          </div>
          <div class="detail-row">
            <label>å½“å‰çŠ¶æ€:</label>
            <span id="detailCurrentStatus" class="detail-value"></span>
            <select id="editDetailCurrentStatus" class="detail-input" style="display: none;">
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
              <option value="Follow up">Follow up</option>
            </select>
          </div>
          <div class="detail-row">
            <label>å¤ç°æ‰‹æ³•:</label>
            <div id="detailReproductionMethod" class="detail-value"></div>
            <textarea id="editDetailReproductionMethod" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>æ¢å¤æ–¹æ³•:</label>
            <div id="detailRecoveryMethod" class="detail-value"></div>
            <textarea id="editDetailRecoveryMethod" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>å¤ç°æ¦‚ç‡:</label>
            <span id="detailReproductionProbability" class="detail-value"></span>
            <input type="text" id="editDetailReproductionProbability" class="detail-input" style="display: none;">
          </div>
        </div>

        <div class="detail-section">
          <h3>å¤„ç†ä¿¡æ¯</h3>
          <div class="detail-row">
            <label>æµ‹è¯•äººå‘˜:</label>
            <span id="detailTester" class="detail-value"></span>
            <input type="text" id="editDetailTester" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>è´£ä»»éƒ¨é—¨:</label>
            <span id="detailResponsibleDepartment" class="detail-value"></span>
            <select id="editDetailResponsibleDepartment" class="detail-input" style="display: none;">
              <option value="SQE">SQE</option>
              <option value="ID">ID</option>
              <option value="ç»“æ„">ç»“æ„</option>
              <option value="ç ”å‘">ç ”å‘</option>
            </select>
          </div>
          <div class="detail-row">
            <label>åˆ†æè´£ä»»äºº:</label>
            <span id="detailResponsiblePerson" class="detail-value"></span>
            <input type="text" id="editDetailResponsiblePerson" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>DQEç¡®è®¤:</label>
            <span id="detailDqeConfirm" class="detail-value"></span>
            <input type="text" id="editDetailDqeConfirm" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>ç ”å‘ç¡®è®¤:</label>
            <span id="detailRdConfirm" class="detail-value"></span>
            <input type="text" id="editDetailRdConfirm" class="detail-input" style="display: none;">
          </div>
          <div class="detail-row">
            <label>æ”¹å–„å¯¹ç­–:</label>
            <div id="detailImprovementPlan" class="detail-value"></div>
            <textarea id="editDetailImprovementPlan" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>DQEå›å¤:</label>
            <div id="detailGreenUnionDqe" class="detail-value"></div>
            <textarea id="editDetailGreenUnionDqe" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>ç ”å‘å›å¤:</label>
            <div id="detailGreenUnionRd" class="detail-value"></div>
            <textarea id="editDetailGreenUnionRd" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
        </div>

        <div class="detail-section">
          <h3>å…¶ä»–ä¿¡æ¯</h3>
          <div class="detail-row">
            <label>å¯¹æ¯”ä¸Šä¸€ç‰ˆ:</label>
            <div id="detailComparisonWithPrevious" class="detail-value"></div>
            <textarea id="editDetailComparisonWithPrevious" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>æ”¹å–„åé£é™©:</label>
            <div id="detailPostImprovementRisk" class="detail-value"></div>
            <textarea id="editDetailPostImprovementRisk" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>ä¸‹ä¸€ç‰ˆå›å½’æµ‹è¯•:</label>
            <div id="detailNextVersionRegressionTest" class="detail-value"></div>
            <textarea id="editDetailNextVersionRegressionTest" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>å¤‡æ³¨:</label>
            <div id="detailRemark" class="detail-value"></div>
            <textarea id="editDetailRemark" class="detail-input" rows="3" style="display: none;"></textarea>
          </div>
          <div class="detail-row">
            <label>å†…å¤–è´¸:</label>
            <span id="detailTestOverseas" class="detail-value"></span>
            <select id="editDetailTestOverseas" class="detail-input" style="display: none;">
              <option value="å†…è´¸">å†…è´¸</option>
              <option value="å¤–è´¸">å¤–è´¸</option>
            </select>
          </div>
          <div class="detail-row">
            <label>æäº¤æ—¶é—´:</label>
            <span id="detailCreatedAt" class="detail-value"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="editProblemBtn" class="btn btn-primary" style="display: none;">ç¼–è¾‘</button>
      <button id="saveDetailBtn" class="btn btn-success" style="display: none;">ä¿å­˜</button>
      <button id="cancelEditBtn" class="btn btn-secondary" style="display: none;">å–æ¶ˆ</button>
      <button id="closeProblemDetailModal" class="btn btn-secondary">å…³é—­</button>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘é—®é¢˜ç‚¹æ¨¡æ€æ¡† -->
<div id="editProblemModal" class="modal">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>ç¼–è¾‘é—®é¢˜ç‚¹</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editProblemForm">
        <input type="hidden" id="editProblemId">
        <div class="form-grid">
          <div class="form-group">
            <label for="editFullModel">å®Œæ•´ç¼–ç :</label>
            <input type="text" id="editFullModel" name="fullModel">
          </div>
          <div class="form-group">
            <label for="editSampleStage">æ ·å“é˜¶æ®µ:</label>
            <select id="editSampleStage" name="sampleStage">
              <option value="EVT">EVT</option>
              <option value="DVT">DVT</option>
              <option value="PVT">PVT</option>
              <option value="MP">MP</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editVersion">ç‰ˆæœ¬:</label>
            <input type="text" id="editVersion" name="version">
          </div>
          <div class="form-group">
            <label for="editProblemCategory">é—®é¢˜ç±»åˆ«:</label>
            <select id="editProblemCategory" name="problemCategory">
              <option value="">è¯·é€‰æ‹©é—®é¢˜ç±»åˆ«</option>
              <optgroup label="è§†é¢‘ç»„">
                <option value="è§†é¢‘æ’­æ”¾é—®é¢˜">è§†é¢‘æ’­æ”¾é—®é¢˜</option>
                <option value="è§†é¢‘å½•åˆ¶é—®é¢˜">è§†é¢‘å½•åˆ¶é—®é¢˜</option>
                <option value="è§†é¢‘ç¼–ç é—®é¢˜">è§†é¢‘ç¼–ç é—®é¢˜</option>
                <option value="è§†é¢‘è§£ç é—®é¢˜">è§†é¢‘è§£ç é—®é¢˜</option>
                <option value="è§†é¢‘ä¼ è¾“é—®é¢˜">è§†é¢‘ä¼ è¾“é—®é¢˜</option>
                <option value="è§†é¢‘æ˜¾ç¤ºé—®é¢˜">è§†é¢‘æ˜¾ç¤ºé—®é¢˜</option>
                <option value="è§†é¢‘æ ¼å¼é—®é¢˜">è§†é¢‘æ ¼å¼é—®é¢˜</option>
                <option value="è§†é¢‘ç”»è´¨é—®é¢˜">è§†é¢‘ç”»è´¨é—®é¢˜</option>
                <option value="è§†é¢‘åŒæ­¥é—®é¢˜">è§†é¢‘åŒæ­¥é—®é¢˜</option>
                <option value="è§†é¢‘å¡é¡¿é—®é¢˜">è§†é¢‘å¡é¡¿é—®é¢˜</option>
              </optgroup>
              <optgroup label="è“ç‰™ç»„">
                <option value="è“ç‰™è¿æ¥é—®é¢˜">è“ç‰™è¿æ¥é—®é¢˜</option>
                <option value="è“ç‰™é…å¯¹é—®é¢˜">è“ç‰™é…å¯¹é—®é¢˜</option>
                <option value="è“ç‰™ä¼ è¾“é—®é¢˜">è“ç‰™ä¼ è¾“é—®é¢˜</option>
                <option value="è“ç‰™éŸ³é¢‘é—®é¢˜">è“ç‰™éŸ³é¢‘é—®é¢˜</option>
                <option value="è“ç‰™ä¿¡å·é—®é¢˜">è“ç‰™ä¿¡å·é—®é¢˜</option>
                <option value="è“ç‰™å…¼å®¹æ€§é—®é¢˜">è“ç‰™å…¼å®¹æ€§é—®é¢˜</option>
                <option value="è“ç‰™åŠŸè€—é—®é¢˜">è“ç‰™åŠŸè€—é—®é¢˜</option>
                <option value="è“ç‰™åè®®é—®é¢˜">è“ç‰™åè®®é—®é¢˜</option>
                <option value="è“ç‰™è®¾å¤‡è¯†åˆ«é—®é¢˜">è“ç‰™è®¾å¤‡è¯†åˆ«é—®é¢˜</option>
                <option value="è“ç‰™æ–­è¿é—®é¢˜">è“ç‰™æ–­è¿é—®é¢˜</option>
              </optgroup>
              <optgroup label="ç¡¬ä»¶ç»„">
                <option value="ç¡¬ä»¶è®¾è®¡é—®é¢˜">ç¡¬ä»¶è®¾è®¡é—®é¢˜</option>
                <option value="ç”Ÿäº§é—®é¢˜">ç”Ÿäº§é—®é¢˜</option>
                <option value="å™¨ä»¶é—®é¢˜">å™¨ä»¶é—®é¢˜</option>
                <option value="é…ä»¶é—®é¢˜">é…ä»¶é—®é¢˜</option>
                <option value="å¤–è§‚é—®é¢˜">å¤–è§‚é—®é¢˜</option>
                <option value="PCBAé—®é¢˜">PCBAé—®é¢˜</option>
                <option value="ç”µè·¯é—®é¢˜">ç”µè·¯é—®é¢˜</option>
                <option value="æ¥å£é—®é¢˜">æ¥å£é—®é¢˜</option>
                <option value="æ•£çƒ­é—®é¢˜">æ•£çƒ­é—®é¢˜</option>
                <option value="æœºæ¢°ç»“æ„é—®é¢˜">æœºæ¢°ç»“æ„é—®é¢˜</option>
              </optgroup>
              <optgroup label="è½¯ä»¶ç»„">
                <option value="è½¯ä»¶é—®é¢˜">è½¯ä»¶é—®é¢˜</option>
                <option value="ç³»ç»Ÿé—®é¢˜">ç³»ç»Ÿé—®é¢˜</option>
                <option value="é©±åŠ¨é—®é¢˜">é©±åŠ¨é—®é¢˜</option>
                <option value="å›ºä»¶é—®é¢˜">å›ºä»¶é—®é¢˜</option>
                <option value="åº”ç”¨é—®é¢˜">åº”ç”¨é—®é¢˜</option>
                <option value="ç•Œé¢é—®é¢˜">ç•Œé¢é—®é¢˜</option>
                <option value="æ€§èƒ½é—®é¢˜">æ€§èƒ½é—®é¢˜</option>
                <option value="å…¼å®¹æ€§é—®é¢˜">å…¼å®¹æ€§é—®é¢˜</option>
                <option value="ç¨³å®šæ€§é—®é¢˜">ç¨³å®šæ€§é—®é¢˜</option>
                <option value="åŠŸèƒ½ç¼ºå¤±é—®é¢˜">åŠŸèƒ½ç¼ºå¤±é—®é¢˜</option>
              </optgroup>
            </select>
          </div>
          <div class="form-group">
            <label for="editDefectLevel">ç¼ºé™·ç­‰çº§:</label>
            <select id="editDefectLevel" name="defectLevel">
              <option value="S">S</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="å¾…ç¡®å®š">å¾…ç¡®å®š</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editCurrentStatus">å½“å‰çŠ¶æ€:</label>
            <select id="editCurrentStatus" name="currentStatus">
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
              <option value="Follow up">Follow up</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="editProblem">é—®é¢˜æè¿°:</label>
            <textarea id="editProblem" name="problem" rows="3"></textarea>
          </div>
          <div class="form-group full-width">
            <label for="editProblemImage">é—®é¢˜å›¾ç‰‡:</label>
            <div class="image-edit-container">
              <textarea id="editProblemImage" name="problem_image_or_video" rows="2" placeholder="è¯·è¾“å…¥å›¾ç‰‡è·¯å¾„ï¼Œå¤šä¸ªå›¾ç‰‡ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼š/imageDirectory/image1.png,/imageDirectory/image2.png"></textarea>
              <div class="image-preview" id="editImagePreview"></div>
              <div class="image-edit-tips">
                <small>æ”¯æŒæ ¼å¼ï¼š/imageDirectory/å›¾ç‰‡åç§°.png æˆ– å¤šä¸ªè·¯å¾„ç”¨é€—å·åˆ†éš”</small>
              </div>
            </div>
          </div>
          <div class="form-group full-width">
            <label for="editReproductionMethod">å¤ç°æ‰‹æ³•:</label>
            <textarea id="editReproductionMethod" name="reproductionMethod" rows="3"></textarea>
          </div>
          <div class="form-group full-width">
            <label for="editRecoveryMethod">æ¢å¤æ–¹æ³•:</label>
            <textarea id="editRecoveryMethod" name="recoveryMethod" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="editReproductionProbability">å¤ç°æ¦‚ç‡:</label>
            <input type="text" id="editReproductionProbability" name="reproductionProbability">
          </div>
          <div class="form-group">
            <label for="editTester">æµ‹è¯•äººå‘˜:</label>
            <input type="text" id="editTester" name="tester">
          </div>
          <div class="form-group">
            <label for="editResponsibleDepartment">è´£ä»»éƒ¨é—¨:</label>
            <select id="editResponsibleDepartment" name="responsibleDepartment">
              <option value="SQE">SQE</option>
              <option value="ID">ID</option>
              <option value="ç»“æ„">ç»“æ„</option>
              <option value="ç ”å‘">ç ”å‘</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editResponsiblePerson">åˆ†æè´£ä»»äºº:</label>
            <input type="text" id="editResponsiblePerson" name="responsiblePerson">
          </div>
          <div class="form-group full-width">
            <label for="editImprovementPlan">æ”¹å–„å¯¹ç­–:</label>
            <textarea id="editImprovementPlan" name="improvementPlan" rows="3"></textarea>
          </div>
          <div class="form-group full-width">
            <label for="editGreenUnionDqe">DQEå›å¤:</label>
            <textarea id="editGreenUnionDqe" name="greenUnionDqe" rows="3"></textarea>
          </div>
          <div class="form-group full-width">
            <label for="editGreenUnionRd">ç ”å‘å›å¤:</label>
            <textarea id="editGreenUnionRd" name="greenUnionRd" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="editTestOverseas">å†…å¤–è´¸:</label>
            <select id="editTestOverseas" name="testOverseas">
              <option value="å†…è´¸">å†…è´¸</option>
              <option value="å¤–è´¸">å¤–è´¸</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="editRemark">å¤‡æ³¨:</label>
            <textarea id="editRemark" name="remark" rows="3"></textarea>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button id="saveProblemBtn" class="btn btn-primary">ä¿å­˜</button>
      <button id="cancelEditProblemBtn" class="btn btn-secondary">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- å†å²ç‰ˆæœ¬æ¨¡æ€æ¡† -->
<div id="historyVersionsModal" class="modal">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>å†å²ç‰ˆæœ¬</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="history-versions-container">
        <table id="historyVersionsTable" class="data-table">
          <thead>
          <tr>
            <th>ç‰ˆæœ¬å·</th>
            <th>é—®é¢˜æè¿°</th>
            <th>çŠ¶æ€</th>
            <th>ä¿®æ”¹äºº</th>
            <th>ä¿®æ”¹æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="historyVersionsTableBody">
          <!-- å†å²ç‰ˆæœ¬æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button id="closeHistoryModal" class="btn btn-secondary">å…³é—­</button>
    </div>
  </div>
</div>

<!-- æ”¶è—å¤¹æ¨¡æ€æ¡† -->
<div id="cartModal" class="modal">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>æ”¶è—å¤¹ç®¡ç†</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="cart-controls">
        <button id="clearCartBtn" class="btn btn-danger btn-sm">
          <i class="fas fa-trash"></i> æ¸…ç©ºæ”¶è—å¤¹
        </button>
        <button id="exportCartBtn" class="btn btn-success btn-sm">
          <i class="fas fa-download"></i> å¯¼å‡ºæ”¶è—å¤¹æ•°æ®
        </button>
        <button id="mergeChartBtn" class="btn btn-info btn-sm">
          <i class="fas fa-chart-bar"></i> åˆå¹¶ç”»å›¾
        </button>
      </div>

      <div class="cart-items-container">
        <table id="cartItemsTable" class="data-table">
          <thead>
          <tr>
            <th>
              <input type="checkbox" id="selectAllCartItems" title="å…¨é€‰/å–æ¶ˆå…¨é€‰">
            </th>
            <th>åºå·</th>
            <th>ç­›é€‰æ¡ä»¶</th>
            <th>æ•°æ®é‡</th>
            <th>ä¿å­˜æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="cartItemsTableBody">
          <!-- æ”¶è—å¤¹é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </tbody>
        </table>
      </div>

      <!-- åˆå¹¶æ•°æ®å±•ç¤ºåŒºåŸŸ -->
      <div id="mergedDataSection" class="merged-data-section" style="display: none;">
        <h3>åˆå¹¶æ•°æ®é¢„è§ˆ</h3>
        <div class="merged-stats">
          <span>æ€»æ•°æ®é‡: <strong id="mergedTotalCount">0</strong></span>
          <span>å»é‡å: <strong id="mergedUniqueCount">0</strong></span>
        </div>

        <!-- åˆå¹¶æ•°æ®å›¾è¡¨æ§åˆ¶åŒºåŸŸ -->
        <div class="merged-chart-controls" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            <label style="font-weight: 600; color: #495057;">å›¾è¡¨å­—æ®µ:</label>
            <select id="mergedChartField" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
              <option value="">è¯·é€‰æ‹©åˆ†ç»„å­—æ®µ</option>
              <option value="problemLevel">é—®é¢˜ç­‰çº§</option>
              <option value="majorCode">å¤§ç¼–ç </option>
              <option value="minorCode">å°ç¼–ç </option>
              <option value="projectPhase">é¡¹ç›®é˜¶æ®µ</option>
              <option value="version">ç‰ˆæœ¬</option>
              <option value="problemProcess">é—®é¢˜å·¥åº</option>
              <option value="developmentMethod">å¼€å‘æ–¹å¼</option>
              <option value="supplier">ä¾›åº”å•†</option>
              <option value="solutionProvider">æ–¹æ¡ˆå•†</option>
              <option value="problemPoint">é—®é¢˜ç‚¹</option>
              <option value="problemReason">é—®é¢˜åŸå› </option>
              <option value="improvementStrategy">æ”¹å–„å¯¹ç­–</option>
              <option value="isPreventable">æ˜¯å¦å¯é¢„é˜²</option>
              <option value="responsibleDepartment">è´£ä»»éƒ¨é—¨</option>
              <option value="problemStatus">é—®é¢˜çŠ¶æ€</option>
              <option value="problemTag1">é—®é¢˜æ‰“æ ‡1</option>
              <option value="problemTag2">é—®é¢˜æ‰“æ ‡2</option>
            </select>
          </div>

          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="chart-type-buttons">
              <button class="chart-type-btn active" data-type="bar" onclick="switchMergedChartType('bar')">æŸ±çŠ¶å›¾</button>
              <button class="chart-type-btn" data-type="pie" onclick="switchMergedChartType('pie')">é¥¼çŠ¶å›¾</button>
              <button class="chart-type-btn" data-type="line" onclick="switchMergedChartType('line')">æŠ˜çº¿å›¾</button>
            </div>
            <button id="generateMergedChartBtn" class="btn btn-primary btn-sm" onclick="generateMergedChart()">
              <i class="fas fa-chart-bar"></i> ç”Ÿæˆå›¾è¡¨
            </button>
          </div>
        </div>

        <!-- åˆå¹¶æ•°æ®å›¾è¡¨å®¹å™¨ -->
        <div id="mergedChartContainer" class="merged-chart-container" style="display: none; margin-top: 20px; padding: 20px; background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div class="chart-canvas-container" style="position: relative; height: 400px; width: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center;">
            <canvas id="mergedDataChart" class="chart-canvas" style="max-width: 100%; max-height: 100%; width: 100% !important; height: 100% !important;"></canvas>
          </div>
        </div>
        <div class="merged-table-container">
          <table id="mergedDataTable" class="data-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>æµ‹è¯•æ—¥æœŸ</th>
              <th>å¤§ç¼–ç </th>
              <th>å°ç¼–ç </th>
              <th>é¡¹ç›®é˜¶æ®µ</th>
              <th>ç‰ˆæœ¬</th>
              <th>é—®é¢˜å·¥åº</th>
              <th>é—®é¢˜ç­‰çº§</th>
              <th>å¼€å‘æ–¹å¼</th>
              <th>ä¾›åº”å•†</th>
              <th>æ–¹æ¡ˆå•†</th>
              <th>é—®é¢˜ç‚¹</th>
              <th>é—®é¢˜åŸå› </th>
              <th>æ”¹å–„å¯¹ç­–</th>
              <th>æ˜¯å¦å¯é¢„é˜²</th>
              <th>è´£ä»»éƒ¨é—¨</th>
              <th>é—®é¢˜çŠ¶æ€</th>
              <th>é¢„è®¡å®Œæˆæ—¶é—´</th>
              <th>å®é™…å®Œæˆæ—¶é—´</th>
              <th>Delayå¤©æ•°</th>
              <th>é—®é¢˜æ‰“æ ‡1</th>
              <th>é—®é¢˜æ‰“æ ‡2</th>
              <th>é¢„é˜²å¤‡æ³¨</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ›´æ–°æ—¶é—´</th>
            </tr>
            </thead>
            <tbody id="mergedDataTableBody">
            <!-- åˆå¹¶æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="closeCartModal" class="btn btn-secondary">å…³é—­</button>
    </div>
  </div>
</div>

<!-- æ”¶è—å¤¹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="cartDetailModal" class="modal">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>æ”¶è—å¤¹è¯¦æƒ…</h2>
      <span class="close" onclick="closeSpecificModal('cartDetailModal')">&times;</span>
    </div>
    <div class="modal-body">
      <div class="cart-detail-info">
        <div class="detail-row">
          <label>ç­›é€‰æ¡ä»¶:</label>
          <span id="cartDetailFilter" class="detail-value"></span>
        </div>
        <div class="detail-row">
          <label>æ•°æ®é‡:</label>
          <span id="cartDetailCount" class="detail-value"></span>
        </div>
        <div class="detail-row">
          <label>ä¿å­˜æ—¶é—´:</label>
          <span id="cartDetailTime" class="detail-value"></span>
        </div>
      </div>

      <div class="cart-detail-table-container">
        <table id="cartDetailTable" class="data-table">
          <thead>
          <tr>
            <th>ID</th>
            <th>å®Œæ•´ç¼–ç </th>
            <th>å¤§ç±»</th>
            <th>å°ç±»</th>
            <th>æ ·å“é˜¶æ®µ</th>
            <th>ç‰ˆæœ¬</th>
            <th>æµ‹è¯•å¹³å°</th>
            <th>æ˜¾ç¤ºè®¾å¤‡</th>
            <th>å…¶ä»–è®¾å¤‡</th>
            <th>é—®é¢˜æè¿°</th>
            <th>é—®é¢˜ç±»åˆ«</th>
            <th>ç¼ºé™·ç­‰çº§</th>
            <th>å½“å‰çŠ¶æ€</th>
            <th>æµ‹è¯•äººå‘˜</th>
            <th>DQEè´£ä»»äºº</th>
            <th>è´£ä»»éƒ¨é—¨</th>
            <th>DQEç¡®è®¤å›å¤</th>
            <th>ç ”å‘ç¡®è®¤å›å¤</th>
            <th>æäº¤æ—¶é—´</th>
          </tr>
          </thead>
          <tbody id="cartDetailTableBody">
          <!-- è¯¦æƒ…æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="applyCartFilters()">é‡æ–°æœç´¢</button>
      <button class="btn btn-secondary" onclick="closeSpecificModal('cartDetailModal')">å…³é—­</button>
    </div>
  </div>
</div>

<!-- åŠ è½½æç¤º -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
    <p>åŠ è½½ä¸­...</p>
  </div>
</div>

<!-- è‡ªå®šä¹‰æç¤ºæ¡† -->
<div id="customToast" class="custom-toast">
  <div class="toast-content">
    <div class="toast-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="toast-message" id="toastMessage">æ“ä½œæˆåŠŸ</div>
    <div class="toast-close" id="toastClose">
      <i class="fas fa-times"></i>
    </div>
  </div>
</div>

<!-- åº•éƒ¨å¯¼èˆª -->
<div class="bottom-nav">
  <button class="nav-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i>
    <span>è¿”å›</span>
  </button>
  <button class="nav-btn" onclick="goHome()">
    <i class="fas fa-home"></i>
    <span>ä¸»é¡µ</span>
  </button>
</div>

<script>
  // å…¨å±€å˜é‡
  let currentUser = '';
  let currentRole = '';

  // å›¾è¡¨ç›¸å…³å˜é‡
  var currentChart = null;
  var currentChartType = 'bar';
  let currentPage = 1;
  let pageSize = 20;
  let totalCount = 0;

  // åˆ‡æ¢å›¾è¡¨ç±»å‹å‡½æ•°
  function switchChartType(type) {
    console.log('ğŸ¯ switchChartTypeå‡½æ•°è¢«è°ƒç”¨ï¼Œç±»å‹:', type);

    // æ›´æ–°å½“å‰å›¾è¡¨ç±»å‹
    currentChartType = type;
    console.log('âœ… å½“å‰å›¾è¡¨ç±»å‹å·²æ›´æ–°ä¸º:', currentChartType);

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const chartTypeButtons = document.querySelectorAll('.chart-type-btn');
    chartTypeButtons.forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.type === type) {
        btn.classList.add('active');
        console.log('âœ… æŒ‰é’®çŠ¶æ€å·²æ›´æ–°:', btn.textContent, '-> active');
      }
    });

    // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰å›¾è¡¨
    if (currentChart) {
      console.log('ğŸ“Š é”€æ¯ç°æœ‰å›¾è¡¨');
      currentChart.destroy();
      currentChart = null;
    }

    // å¦‚æœå·²ç»æœ‰å›¾è¡¨æ•°æ®ï¼Œè‡ªåŠ¨é‡æ–°ç”Ÿæˆå›¾è¡¨
    const groupField = document.getElementById('groupField');
    const groupFieldValue = groupField ? groupField.value : null;
    console.log('ğŸ“‹ å½“å‰çŠ¶æ€æ£€æŸ¥:', {
      groupField: groupFieldValue,
      allDataLength: allData ? allData.length : 'undefined',
      currentChartType: currentChartType
    });

    if (groupFieldValue && allData && allData.length > 0) {
      console.log('ğŸš€ å¼€å§‹é‡æ–°ç”Ÿæˆå›¾è¡¨ï¼Œç±»å‹:', currentChartType);
      try {
        processChartData(allData, groupFieldValue, currentChartType);
        console.log('âœ… å›¾è¡¨é‡æ–°ç”Ÿæˆå®Œæˆ');
      } catch (error) {
        console.error('âŒ å›¾è¡¨é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
      }
    } else {
      console.log('â„¹ï¸ æ²¡æœ‰æ•°æ®æˆ–åˆ†ç»„å­—æ®µï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ');
    }
  }
  let totalPages = 1;
  let allData = [];
  let currentEditingReviewId = null;
  let filteredData = [];
  let isSuperAdmin = false; // æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜

  // è´­ç‰©è½¦/æ”¶è—å¤¹ç›¸å…³å˜é‡
  let cartItems = []; // æ”¶è—å¤¹é¡¹ç›®
  let mergedData = []; // åˆå¹¶åçš„æ•°æ®
  let mergedChart = null; // åˆå¹¶æ•°æ®å›¾è¡¨å®ä¾‹
  let mergedChartType = 'bar'; // åˆå¹¶æ•°æ®å›¾è¡¨ç±»å‹

  // ç¼“å­˜ç›¸å…³å˜é‡
  let speciesCache = {
    bigSpecies: null,
    smallSpecies: null,
    sampleStage: null,
    fullModel: null,
    version: null,
    problemCategory: null,
    tester: null,
    responsibleDepartment: null,
    testPlatform: null,
    testDevice: null,
    lastUpdated: null
  };

  // æ ‡å‡†åŒ–çŠ¶æ€æ˜¾ç¤º
  function normalizeStatus(status) {
    if (!status) return '';
    const normalized = status.toLowerCase().trim();
    switch (normalized) {
      case 'open':
        return 'Open';
      case 'closed':
      case 'close':
        return 'Closed';
      case 'follow up':
      case 'followup':
        return 'Follow up';
      default:
        return status; // ä¿æŒåŸå€¼
    }
  }

  // ç¼“å­˜ç®¡ç†å‡½æ•°
  function getCachedSpeciesOptions(speciesType) {
    // å…ˆä»å†…å­˜ç¼“å­˜è·å–
    if (speciesCache[speciesType]) {
      return speciesCache[speciesType];
    }

    // å¦‚æœå†…å­˜ç¼“å­˜æ²¡æœ‰ï¼Œä»localStorageè·å–
    try {
      const cached = localStorage.getItem('speciesCache');
      if (cached) {
        const parsedCache = JSON.parse(cached);
        if (parsedCache[speciesType] && isCacheValid(parsedCache.lastUpdated)) {
          // æ¢å¤åˆ°å†…å­˜ç¼“å­˜
          speciesCache = parsedCache;
          return speciesCache[speciesType];
        }
      }
    } catch (e) {
      console.error('è¯»å–ç¼“å­˜å¤±è´¥:', e);
    }

    return null;
  }

  // æ£€æŸ¥å¹¶åŠ è½½ç¼“å­˜é€‰é¡¹åˆ°ä¸‹æ‹‰æ¡†
  function checkAndLoadCachedOptions(speciesType) {
    const cachedOptions = getCachedSpeciesOptions(speciesType);
    if (cachedOptions && cachedOptions.length > 0) {
      updateSelectOptions(speciesType + 'Filter', cachedOptions);
      return true;
    }
    return false;
  }

  function setCachedSpeciesOptions(speciesType, options) {
    // æ›´æ–°å†…å­˜ç¼“å­˜
    speciesCache[speciesType] = options;
    speciesCache.lastUpdated = new Date().getTime();

    // ä¿å­˜åˆ°localStorage
    try {
      localStorage.setItem('speciesCache', JSON.stringify(speciesCache));
    } catch (e) {
      console.error('ä¿å­˜ç¼“å­˜å¤±è´¥:', e);
    }

    updateCacheStatusDisplay();
  }

  function isCacheValid(lastUpdated) {
    // ç¼“å­˜æœ‰æ•ˆæœŸä¸º1å°æ—¶ï¼ˆ3600000æ¯«ç§’ï¼‰
    const CACHE_DURATION = 60 * 60 * 1000;
    const timestamp = lastUpdated || speciesCache.lastUpdated;
    return timestamp && (new Date().getTime() - timestamp) < CACHE_DURATION;
  }

  function clearSpeciesCache() {
    // æ¸…é™¤å†…å­˜ç¼“å­˜
    speciesCache = {
      bigSpecies: null,
      smallSpecies: null,
      sampleStage: null,
      fullModel: null,
      version: null,
      problemCategory: null,
      tester: null,
      responsibleDepartment: null,
      testPlatform: null,
      testDevice: null,
      lastUpdated: null
    };

    // æ¸…é™¤localStorageç¼“å­˜
    try {
      localStorage.removeItem('speciesCache');
    } catch (e) {
      console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', e);
    }

    updateCacheStatusDisplay();
  }

  function loadCacheFromStorage() {
    try {
      const cached = localStorage.getItem('speciesCache');
      if (cached) {
        const parsedCache = JSON.parse(cached);
        if (isCacheValid(parsedCache.lastUpdated)) {
          // æ¢å¤ç¼“å­˜åˆ°å†…å­˜
          speciesCache = parsedCache;
          // console.log('ç¼“å­˜å·²ä»localStorageæ¢å¤');

          // ä»ç¼“å­˜åŠ è½½é€‰é¡¹åˆ°ä¸‹æ‹‰æ¡†
          loadOptionsFromCache();
        } else {
          // console.log('localStorageä¸­çš„ç¼“å­˜å·²è¿‡æœŸ');
        }
      }
    } catch (e) {
      console.error('ä»localStorageåŠ è½½ç¼“å­˜å¤±è´¥:', e);
    }
  }

  function loadOptionsFromCache() {
    // åŠ è½½å¤§ç±»é€‰é¡¹
    if (speciesCache.bigSpecies && speciesCache.bigSpecies.length > 0) {
      updateSelectOptions('bigSpeciesFilter', speciesCache.bigSpecies);
      // console.log('å¤§ç±»é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½å°ç±»é€‰é¡¹
    if (speciesCache.smallSpecies && speciesCache.smallSpecies.length > 0) {
      updateSelectOptions('smallSpeciesFilter', speciesCache.smallSpecies);
      // console.log('å°ç±»é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½æ ·å“é˜¶æ®µé€‰é¡¹
    if (speciesCache.sampleStage && speciesCache.sampleStage.length > 0) {
      updateSelectOptions('sampleStageFilter', speciesCache.sampleStage);
      // console.log('æ ·å“é˜¶æ®µé€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½å®Œæ•´ç¼–ç é€‰é¡¹
    if (speciesCache.fullModel && speciesCache.fullModel.length > 0) {
      updateSelectOptions('fullModelFilter', speciesCache.fullModel);
      // console.log('å®Œæ•´ç¼–ç é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½ç‰ˆæœ¬é€‰é¡¹
    if (speciesCache.version && speciesCache.version.length > 0) {
      updateSelectOptions('versionFilter', speciesCache.version);
      // console.log('ç‰ˆæœ¬é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½é—®é¢˜ç±»åˆ«é€‰é¡¹ï¼ˆä¸‰çº§ç»“æ„ï¼‰
    if (speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
      // å¯¹äºä¸‰çº§ç»“æ„ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç›´æ¥æ›´æ–°ä¸‹æ‹‰æ¡†é€‰é¡¹
      // å› ä¸ºä¸‰çº§ç»“æ„æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€ç”Ÿæˆçš„
      // console.log('é—®é¢˜ç±»åˆ«é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½ï¼ˆä¸‰çº§ç»“æ„ï¼‰');
    }

    // åŠ è½½æµ‹è¯•äººå‘˜é€‰é¡¹
    if (speciesCache.tester && speciesCache.tester.length > 0) {
      updateSelectOptions('testerFilter', speciesCache.tester);
      // console.log('æµ‹è¯•äººå‘˜é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½è´£ä»»éƒ¨é—¨é€‰é¡¹
    if (speciesCache.responsibleDepartment && speciesCache.responsibleDepartment.length > 0) {
      updateSelectOptions('responsibleDepartmentFilter', speciesCache.responsibleDepartment);
      // console.log('è´£ä»»éƒ¨é—¨é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½æµ‹è¯•å¹³å°é€‰é¡¹
    if (speciesCache.testPlatform && speciesCache.testPlatform.length > 0) {
      updateSelectOptions('testPlatformFilter', speciesCache.testPlatform);
      // console.log('æµ‹è¯•å¹³å°é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½æ˜¾ç¤ºè®¾å¤‡é€‰é¡¹
    if (speciesCache.testDevice && speciesCache.testDevice.length > 0) {
      updateSelectOptions('testDeviceFilter', speciesCache.testDevice);
      // console.log('æ˜¾ç¤ºè®¾å¤‡é€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }

    // åŠ è½½DQEè´Ÿè´£äººé€‰é¡¹
    if (speciesCache.dqe && speciesCache.dqe.length > 0) {
      updateSelectOptions('dqeFilter', speciesCache.dqe);
      // console.log('DQEè´Ÿè´£äººé€‰é¡¹å·²ä»ç¼“å­˜åŠ è½½');
    }
  }

  function updateCacheStatusDisplay() {
    const cacheStatusElement = document.getElementById('cacheStatus');
    if (!cacheStatusElement) return;

    if (speciesCache.lastUpdated && isCacheValid()) {
      const timeAgo = Math.floor((new Date().getTime() - speciesCache.lastUpdated) / 1000 / 60);
      cacheStatusElement.textContent = `ç¼“å­˜æœ‰æ•ˆ (${timeAgo}åˆ†é’Ÿå‰)`;
      cacheStatusElement.style.color = '#28a745';
    } else if (speciesCache.lastUpdated) {
      cacheStatusElement.textContent = 'ç¼“å­˜å·²è¿‡æœŸ';
      cacheStatusElement.style.color = '#ffc107';
    } else {
      cacheStatusElement.textContent = 'æ— ç¼“å­˜';
      cacheStatusElement.style.color = '#6c757d';
    }
  }

  // é¡µé¢åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    console.log('ğŸ“Š Chart.jsæ˜¯å¦åŠ è½½:', typeof Chart !== 'undefined');
    console.log('ğŸ“Š ChartDataLabelsæ˜¯å¦åŠ è½½:', typeof ChartDataLabels !== 'undefined');

    // æ£€æŸ¥ç”¨æˆ·æƒé™
    checkUserPermission();

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
    initEventListeners();

    // åˆå§‹åŒ–ç¼“å­˜çŠ¶æ€æ˜¾ç¤º
    loadCacheFromStorage();
    updateCacheStatusDisplay();

    // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

    // åˆå§‹åŒ–è´­ç‰©è½¦
    loadCartFromStorage();
    updateCartCount();

    // ç¡®ä¿åˆ†é¡µæ§ä»¶å¯è§
    const paginationContainer = document.querySelector('.pagination-container');
    if (paginationContainer) {
      paginationContainer.style.display = 'flex';
      // console.log('åˆ†é¡µæ§ä»¶å·²æ˜¾ç¤º');
    } else {
      console.error('æ‰¾ä¸åˆ°åˆ†é¡µæ§ä»¶');
    }

    // åŠ è½½æ•°æ®
    loadReviewData();
  });

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼Œéšè—æ‰€æœ‰å»ºè®®æ¡†
  document.addEventListener('click', function(e) {
    // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨å»ºè®®æ¡†æˆ–è¾“å…¥æ¡†å†…
    if (!e.target.closest('.input-with-suggestions') && !e.target.closest('.toggle-input-btn')) {
      // éšè—æ‰€æœ‰å»ºè®®æ¡†
      document.querySelectorAll('.suggestions-dropdown').forEach(suggestions => {
        hideSuggestions(suggestions);
      });
    }
  });

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤


  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤
  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // é—®é¢˜ç±»åˆ«ç›¸å…³åŠŸèƒ½å·²ç§»é™¤

  // è§£æURLå‚æ•°
  function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }
  // æ£€æŸ¥ç”¨æˆ·æƒé™
  function checkUserPermission() {
    // ä¼˜å…ˆä»URLå‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶æ¬¡ä»localStorageè·å–
    const urlUsername = getUrlParameter('username');
    const urlRole = getUrlParameter('role');

    if (urlUsername) {
      currentUser = urlUsername;
      localStorage.setItem('currentUser', currentUser);
    } else {
      currentUser = localStorage.getItem('currentUser') || '';
    }

    if (urlRole) {
      currentRole = urlRole;
      localStorage.setItem('currentRole', currentRole);
    } else {
      currentRole = localStorage.getItem('currentRole') || 'TestMan';
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
    const adminUsers = ['admin', 'root', 'administrator', 'ç®¡ç†å‘˜'];
    isSuperAdmin = adminUsers.includes(currentUser.toLowerCase()) || currentRole === 'SuperAdmin';

    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    document.getElementById('currentUser').textContent = `ç”¨æˆ·: ${currentUser}`;
    document.getElementById('currentRole').textContent = `è§’è‰²: ${currentRole}`;

    // æ ¹æ®æƒé™æ§åˆ¶ç•Œé¢å…ƒç´ 
    controlEditPermissions();
  }

  // æ§åˆ¶ç¼–è¾‘æƒé™
  function controlEditPermissions() {
    // æ–°å¢é—®é¢˜ç‚¹æŒ‰é’®å·²ç§»é™¤ï¼Œæ— éœ€æ§åˆ¶
  }

  // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
  function initEventListeners() {
    // æœç´¢æŒ‰é’®
    document.getElementById('searchBtn').addEventListener('click', searchReviews);

    // é‡ç½®æŒ‰é’®
    document.getElementById('resetBtn').addEventListener('click', resetFilters);

    // ä¸ºç­›é€‰è¾“å…¥æ¡†æ·»åŠ å›è½¦é”®æœç´¢åŠŸèƒ½
    const filterInputs = [
      'majorCodeFilter', 'minorCodeFilter', 'projectPhaseFilter', 'versionFilter', 'supplierFilter',
      'testStartDateFilter', 'testEndDateFilter'
    ];

    // ä¸ºæ‰€æœ‰è¿‡æ»¤å™¨è¾“å…¥æ¡†æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
    filterInputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      if (input) {
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchReviews();
          }
        });
      }
    });

    // å…¨å±€é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        // æ£€æŸ¥å½“å‰ç„¦ç‚¹æ˜¯å¦åœ¨è¿‡æ»¤å™¨è¾“å…¥æ¡†æˆ–æœç´¢æŒ‰é’®ä¸Š
        const activeElement = document.activeElement;
        if (activeElement && (
                filterInputs.includes(activeElement.id) ||
                activeElement.id === 'searchBtn'
        )) {
          e.preventDefault();
          searchReviews();
        }
      }
    });

    // åˆ†é¡µç›¸å…³äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
    document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));
    document.getElementById('jumpBtn').addEventListener('click', jumpToPage);
    document.getElementById('lastPageBtn').addEventListener('click', goToLastPage);

    // é¡µé¢å¤§å°é€‰æ‹©
    document.getElementById('pageSizeSelect').addEventListener('change', function() {
      pageSize = parseInt(this.value);
      currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      loadReviewData(); // é‡æ–°åŠ è½½æ•°æ®
    });

    // å¯¼å…¥ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('importBtn').addEventListener('click', function() {
      document.getElementById('importModal').style.display = 'block';
    });

    // å…³é—­å¯¼å…¥æ¨¡æ€æ¡†
    document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
    document.getElementById('importModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeImportModal();
      }
    });

    // ä¸‹è½½æ¨¡æ¿æŒ‰é’®
    document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
      fetch('/reviewResult/downloadTemplate')
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // ç›´æ¥ä¸‹è½½æ–‡ä»¶
                  window.open('/reviewResult/downloadTemplateFile', '_blank');
                  showToast('æ¨¡æ¿ä¸‹è½½å·²å¼€å§‹', 'success');
                } else {
                  alert(`æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ï¼\n\n${data.message}`);
                }
              })
              .catch(error => {
                console.error('ä¸‹è½½æ¨¡æ¿æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showToast('ä¸‹è½½æ¨¡æ¿æ—¶å‘ç”Ÿé”™è¯¯', 'error');
              });
    });

    // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      uploadArea.classList.add('dragover');
    }

    function unhighlight() {
      uploadArea.classList.remove('dragover');
    }

    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      handleFileSelection();
    }

    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', handleFileSelection);

    function handleFileSelection() {
      const file = fileInput.files[0];
      if (file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('confirmImportBtn').disabled = false;
      }
    }

    // ç¡®è®¤å¯¼å…¥æŒ‰é’®
    document.getElementById('confirmImportBtn').addEventListener('click', handleFileImport);

    // ç¼–è¾‘ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
    const editImageField = document.getElementById('editProblemImage');
    if (editImageField) {
      editImageField.addEventListener('input', updateImagePreview);
      editImageField.addEventListener('blur', updateImagePreview);
    }


    // ç”Ÿæˆå›¾è¡¨æŒ‰é’®äº‹ä»¶
    const generateChartBtn = document.getElementById('generateChartBtn');
    if (generateChartBtn) {
      generateChartBtn.addEventListener('click', generateChart);
      console.log('ç”Ÿæˆå›¾è¡¨æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
    }


    // å›¾è¡¨ç±»å‹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    console.log('=== å¼€å§‹åˆå§‹åŒ–å›¾è¡¨ç±»å‹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ ===');
    const chartTypeButtons = document.querySelectorAll('.chart-type-btn');
    console.log('æ‰¾åˆ°å›¾è¡¨ç±»å‹æŒ‰é’®æ•°é‡:', chartTypeButtons.length);
    console.log('æŒ‰é’®è¯¦æƒ…:', Array.from(chartTypeButtons).map(btn => ({
      text: btn.textContent,
      type: btn.dataset.type,
      hasOnclick: !!btn.onclick
    })));

    if (chartTypeButtons.length === 0) {
      console.error('âŒ æ²¡æœ‰æ‰¾åˆ°å›¾è¡¨ç±»å‹æŒ‰é’®ï¼');
      return;
    }

    chartTypeButtons.forEach((btn, index) => {
      console.log(`æŒ‰é’®${index}:`, {
        element: btn,
        type: btn.dataset.type,
        text: btn.textContent,
        hasClickHandler: btn.onclick !== null
      });

      btn.addEventListener('click', function(e) {
        console.log('ğŸ¯ æŒ‰é’®è¢«ç‚¹å‡»!', {
          type: this.dataset.type,
          text: this.textContent,
          event: e
        });

        // ç§»é™¤æ‰€æœ‰activeç±»
        chartTypeButtons.forEach(b => b.classList.remove('active'));
        // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
        this.classList.add('active');
        currentChartType = this.dataset.type;
        console.log('âœ… å›¾è¡¨ç±»å‹åˆ‡æ¢ä¸º:', currentChartType);

        // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰å›¾è¡¨
        if (currentChart) {
          console.log('ğŸ“Š é”€æ¯ç°æœ‰å›¾è¡¨');
          currentChart.destroy();
          currentChart = null;
        }

        // å¦‚æœå·²ç»æœ‰å›¾è¡¨æ•°æ®ï¼Œè‡ªåŠ¨é‡æ–°ç”Ÿæˆå›¾è¡¨
        const groupField = document.getElementById('groupField');
        const groupFieldValue = groupField ? groupField.value : null;
        console.log('ğŸ“‹ å½“å‰çŠ¶æ€æ£€æŸ¥:', {
          groupField: groupFieldValue,
          allDataLength: allData ? allData.length : 'undefined',
          currentChartType: currentChartType
        });

        if (groupFieldValue && allData && allData.length > 0) {
          console.log('ğŸš€ å¼€å§‹é‡æ–°ç”Ÿæˆå›¾è¡¨ï¼Œç±»å‹:', currentChartType);
          try {
            processChartData(allData, groupFieldValue, currentChartType);
            console.log('âœ… å›¾è¡¨é‡æ–°ç”Ÿæˆå®Œæˆ');
          } catch (error) {
            console.error('âŒ å›¾è¡¨é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
          }
        } else {
          console.log('âš ï¸ æ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸é‡æ–°ç”Ÿæˆå›¾è¡¨');
          console.log('éœ€è¦æ»¡è¶³: groupFieldæœ‰å€¼ && allDataæœ‰æ•°æ®');
        }
      });

      console.log(`âœ… æŒ‰é’®${index}äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ `);
    });
    console.log('=== å›¾è¡¨ç±»å‹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ ===');
  }
  function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // æ£€æŸ¥ç”¨æˆ·æƒé™
  function checkUserPermission() {
    // ä¼˜å…ˆä»URLå‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶æ¬¡ä»localStorageè·å–
    const urlUsername = getUrlParameter('username');
    const urlJob = getUrlParameter('job');

    currentUser = urlUsername || localStorage.getItem('username');
    currentRole = urlJob || localStorage.getItem('job');

    // å¦‚æœURLå‚æ•°å­˜åœ¨ï¼Œæ›´æ–°localStorage
    if (urlUsername) {
      localStorage.setItem('username', urlUsername);
    }
    if (urlJob) {
      localStorage.setItem('job', urlJob);
    }

    if (!currentUser || !currentRole) {
      alert('è¯·å…ˆç™»å½•å¹¶é€‰æ‹©è§’è‰²ï¼');
      window.location.href = '/DQEIndex';
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™è¿›å…¥é—®é¢˜ç‚¹åº“ç®¡ç†é¡µé¢
    const allowedUsers = ['é‚“å°è‹±', 'é‚“ä»¤ç« ', 'å¢å¥', 'æè‰¯å¥', 'é»„å®¶ç¿'];
    if (!allowedUsers.includes(currentUser)) {
      alert('æ‚¨æ²¡æœ‰æƒé™è¿›å…¥é—®é¢˜ç‚¹åº“ç®¡ç†é¡µé¢ï¼');
      window.location.href = '/DQEIndex';
      return;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
    isSuperAdmin = (currentUser === 'å¢å¥' && currentRole === 'manager');

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    document.getElementById('currentUser').textContent = `ç”¨æˆ·: ${currentUser}`;
    document.getElementById('currentRole').textContent = `è§’è‰²: ${currentRole}`;

    // æ ¹æ®æƒé™æ§åˆ¶ç•Œé¢å…ƒç´ 
    controlEditPermissions();
  }

  // æ§åˆ¶ç¼–è¾‘æƒé™
  function controlEditPermissions() {
    // æ–°å¢é—®é¢˜ç‚¹æŒ‰é’®å·²ç§»é™¤ï¼Œæ— éœ€æ§åˆ¶
  }

  // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
  function initEventListeners() {
    // æœç´¢æŒ‰é’®
    document.getElementById('searchBtn').addEventListener('click', searchReviews);

    // é‡ç½®æŒ‰é’®
    document.getElementById('resetBtn').addEventListener('click', resetFilters);

    // ä¸ºç­›é€‰è¾“å…¥æ¡†æ·»åŠ å›è½¦é”®æœç´¢åŠŸèƒ½
    const filterInputs = [
      'majorCodeFilter', 'minorCodeFilter', 'projectPhaseFilter', 'versionFilter', 'supplierFilter',
      'testStartDateFilter', 'testEndDateFilter'
    ];

    filterInputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      if (input) {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault(); // é˜²æ­¢è¡¨å•æäº¤
            searchReviews(); // ä¿®æ­£ä¸ºæ­£ç¡®çš„æœç´¢å‡½æ•°
          }
        });
      }
    });

    // å¯¼å…¥æŒ‰é’® - æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('importBtn').addEventListener('click', function() {
      document.getElementById('importModal').style.display = 'block';
    });

    // å…³é—­å¯¼å…¥æ¨¡æ€æ¡†
    window.closeImportModal = function() {
      document.getElementById('importModal').style.display = 'none';
      // é‡ç½®æ–‡ä»¶è¾“å…¥
      document.getElementById('fileInput').value = '';
      document.getElementById('confirmImportBtn').disabled = true;
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('uploadArea').innerHTML = `
                <i class="fas fa-cloud-upload-alt"></i>
                <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                <p class="file-info">æ”¯æŒ .xlsx æ ¼å¼ï¼Œæœ€å¤§ 100MB</p>
            `;
    };

    // ä¸‹è½½æ¨¡æ¿æ–‡ä»¶æŒ‰é’®
    document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
      const btn = this;
      const originalText = btn.innerHTML;

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ£€æŸ¥...';
      btn.disabled = true;

      // å…ˆæ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      fetch('/reviewResult/downloadTemplate')
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // æ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹ä¸‹è½½
                  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ä¸‹è½½...';

                  const link = document.createElement('a');
                  link.href = data.downloadUrl;
                  link.download = 'è¯„å®¡ç»“æœå¯¼å…¥æ¨¡æ¿.xlsx';
                  link.style.display = 'none';
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);

                  showToast('æ¨¡æ¿æ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'success');
                } else {
                  // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                  showToast(data.message, 'warning');
                  alert(`æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ï¼\n\n${data.instructions}\n\nè¯·å°†æ¨¡æ¿æ–‡ä»¶æ”¾åˆ°æŒ‡å®šè·¯å¾„åé‡è¯•ã€‚`);
                }
              })
              .catch(error => {
                console.error('æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showToast('æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯', 'error');
              })
              .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.innerHTML = originalText;
                btn.disabled = false;
              });
    });

    // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
    document.getElementById('uploadArea').addEventListener('click', function() {
      document.getElementById('fileInput').click();
    });

    // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });

    // æ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
    document.getElementById('fileInput').addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    // ç¡®è®¤å¯¼å…¥æŒ‰é’®
    document.getElementById('confirmImportBtn').addEventListener('click', function() {
      const fileInput = document.getElementById('fileInput');
      if (fileInput.files.length > 0) {
        handleFileImport();
      }
    });

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(file) {
      if (file && file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
        document.getElementById('uploadArea').innerHTML = `
                    <i class="fas fa-file-excel" style="color: #28a745;"></i>
                    <p style="color: #28a745; font-weight: 500;">å·²é€‰æ‹©æ–‡ä»¶: ${file.name}</p>
                    <p class="file-info">æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
        document.getElementById('confirmImportBtn').disabled = false;
      } else {
        showToast('è¯·é€‰æ‹©æœ‰æ•ˆçš„Excelæ–‡ä»¶(.xlsxæ ¼å¼)', 'error');
      }
    }

    // å¯¼å‡ºæŒ‰é’®
    document.getElementById('exportBtn').addEventListener('click', exportFilteredData);

    // åŠ å…¥æ”¶è—å¤¹æŒ‰é’®
    document.getElementById('addToCartBtn').addEventListener('click', addToCart);

    // æŸ¥çœ‹æ”¶è—å¤¹æŒ‰é’®
    document.getElementById('showCartBtn').addEventListener('click', showCartModal);

    // è¡¨æ ¼å…¨é€‰åŠŸèƒ½
    document.getElementById('selectAllTableRows').addEventListener('change', toggleSelectAllTableRows);

    // æ”¶è—å¤¹ç›¸å…³æŒ‰é’®
    document.getElementById('clearCartBtn').addEventListener('click', clearCart);
    document.getElementById('exportCartBtn').addEventListener('click', exportCartData);
    document.getElementById('mergeChartBtn').addEventListener('click', showMergedChart);
    document.getElementById('closeCartModal').addEventListener('click', function() {
      closeSpecificModal('cartModal');
    });

    // æ³¨æ„ï¼šè¯„å®¡ç»“æœé¡µé¢ä¸éœ€è¦è¿™äº›åˆ·æ–°æŒ‰é’®ï¼Œå› ä¸ºç­›é€‰å™¨éƒ½æ˜¯è¾“å…¥æ¡†æˆ–å›ºå®šé€‰é¡¹



    // åˆ†é¡µæŒ‰é’®
    document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
    document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
    document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));
    document.getElementById('lastPageBtn').addEventListener('click', () => goToLastPage());

    // æ¯é¡µæ˜¾ç¤ºæ•°é‡é€‰æ‹©å™¨
    document.getElementById('pageSizeSelect').addEventListener('change', function() {
      pageSize = parseInt(this.value);
      currentPage = 1;
      loadReviewData(); // é‡æ–°åŠ è½½æ•°æ®
    });

    // é¡µç è·³è½¬
    document.getElementById('pageJumpBtn').addEventListener('click', jumpToPage);
    document.getElementById('pageJumpInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        jumpToPage();
      }
    });

    // ä¿å­˜é—®é¢˜ç‚¹
    document.getElementById('saveProblemBtn').addEventListener('click', saveProblem);

    // å–æ¶ˆç¼–è¾‘ï¼ˆç¼–è¾‘æ¨¡æ€æ¡†çš„å–æ¶ˆæŒ‰é’®ï¼‰
    document.getElementById('cancelEditProblemBtn').addEventListener('click', function() {
      // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡æ€æ¡†ä¸­
      const editModal = document.getElementById('editProblemModal');
      if (editModal && editModal.style.display === 'block') {
        closeModal(); // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
      } else {
        exitEditMode(); // é€€å‡ºè¯¦æƒ…æ¨¡æ€æ¡†çš„ç¼–è¾‘æ¨¡å¼
      }
    });

    // å…³é—­å†å²ç‰ˆæœ¬æ¨¡æ€æ¡†
    document.getElementById('closeHistoryModal').addEventListener('click', closeModal);

    // å…³é—­è¯„å®¡ç»“æœè¯¦æƒ…æ¨¡æ€æ¡†
    document.getElementById('closeReviewDetailModal').addEventListener('click', function() {
      resetReviewEditMode();
      document.getElementById('reviewDetailModal').style.display = 'none';
    });

    // å…³é—­é—®é¢˜ç‚¹è¯¦æƒ…æ¨¡æ€æ¡†
    document.getElementById('closeProblemDetailModal').addEventListener('click', function() {
      closeSpecificModal('problemDetailModal');
    });

    // è¯„å®¡ç»“æœç¼–è¾‘ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('editReviewBtn').addEventListener('click', enterReviewEditMode);
    document.getElementById('saveReviewBtn').addEventListener('click', saveReviewEdit);
    document.getElementById('cancelEditReviewBtn').addEventListener('click', cancelReviewEdit);

    // è¯¦æƒ…æ¨¡æ€æ¡†ç¼–è¾‘æŒ‰é’®
    document.getElementById('editProblemBtn').addEventListener('click', function() {
      enterEditMode();
    });

    // ä¿å­˜è¯¦æƒ…æŒ‰é’®
    document.getElementById('saveDetailBtn').addEventListener('click', function() {
      saveDetailChanges();
    });



    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰å…³é—­æŒ‰é’®
    document.addEventListener('click', function(event) {
      // å¤„ç†XæŒ‰é’®å…³é—­
      if (event.target.classList.contains('close')) {
        // æ‰¾åˆ°æœ€è¿‘çš„æ¨¡æ€æ¡†å¹¶å…³é—­
        const modal = event.target.closest('.modal');
        if (modal) {
          // å¦‚æœæ˜¯è¯„å®¡ç»“æœè¯¦æƒ…æ¨¡æ€æ¡†ï¼Œéœ€è¦é‡ç½®ç¼–è¾‘çŠ¶æ€
          if (modal.id === 'reviewDetailModal') {
            resetReviewEditMode();
          }
          modal.style.display = 'none';
        }
        return;
      }

      // å¤„ç†ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      if (event.target.classList.contains('modal')) {
        // å¦‚æœæ˜¯è¯„å®¡ç»“æœè¯¦æƒ…æ¨¡æ€æ¡†ï¼Œéœ€è¦é‡ç½®ç¼–è¾‘çŠ¶æ€
        if (event.target.id === 'reviewDetailModal') {
          resetReviewEditMode();
        }
        // åªå…³é—­è¢«ç‚¹å‡»çš„æ¨¡æ€æ¡†
        event.target.style.display = 'none';
        return;
      }
    });

    // æç¤ºæ¡†äº‹ä»¶ç›‘å¬å™¨
    const toast = document.getElementById('customToast');
    const toastClose = document.getElementById('toastClose');

    // ç‚¹å‡»å…³é—­æŒ‰é’®
    toastClose.addEventListener('click', hideToast);

    // ç‚¹å‡»æç¤ºæ¡†å¤–éƒ¨å…³é—­
    toast.addEventListener('click', function(event) {
      if (event.target === toast) {
        hideToast();
      }
    });

    // å…¨é€‰æ”¶è—å¤¹é¡¹ç›®å¤é€‰æ¡†
    document.getElementById('selectAllCartItems').addEventListener('change', toggleSelectAllCartItems);

    // é—®é¢˜å›¾ç‰‡ç¼–è¾‘å­—æ®µäº‹ä»¶ç›‘å¬å™¨
    const editImageField = document.getElementById('editProblemImage');
    if (editImageField) {
      editImageField.addEventListener('input', updateImagePreview);
      editImageField.addEventListener('blur', updateImagePreview);
    }
  }

  // åŠ è½½è¯„å®¡ç»“æœæ•°æ®
  function loadReviewData() {
    showLoading();

    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const params = new URLSearchParams({
      username: currentUser,
      job: currentRole,
      page: currentPage,
      size: pageSize
    });

    // æ·»åŠ ç­›é€‰æ¡ä»¶
    const majorCode = document.getElementById('majorCodeFilter').value.trim();
    const minorCode = document.getElementById('minorCodeFilter').value.trim();
    const projectPhase = document.getElementById('projectPhaseFilter').value.trim();
    const version = document.getElementById('versionFilter').value.trim();
    const supplier = document.getElementById('supplierFilter').value.trim();
    const testStartDate = document.getElementById('testStartDateFilter').value;
    const testEndDate = document.getElementById('testEndDateFilter').value;

    if (majorCode) params.append('majorCode', majorCode);
    if (minorCode) params.append('minorCode', minorCode);
    if (projectPhase) params.append('projectPhase', projectPhase);
    if (version) params.append('version', version);
    if (supplier) params.append('supplier', supplier);
    if (testStartDate) params.append('testStartDate', testStartDate);
    if (testEndDate) params.append('testEndDate', testEndDate);

    console.log('å‘é€çš„æŸ¥è¯¢å‚æ•°:', params.toString());

    fetch('/reviewResult/getReviewResults?' + params.toString())
            .then(response => response.json())
            .then(data => {
              console.log('APIå“åº”æ•°æ®:', data);
              if (data.success) {
                allData = data.data || [];
                filteredData = [...allData];
                totalCount = data.total || 0;
                totalPages = data.totalPages || Math.ceil(totalCount / pageSize);
                console.log('åŠ è½½çš„æ•°æ®:', allData);
                console.log('æ€»è®°å½•æ•°:', totalCount);
                console.log('æ€»é¡µæ•°:', totalPages);
                console.log('å½“å‰é¡µ:', currentPage);
                console.log('æ¯é¡µå¤§å°:', pageSize);
                renderTable();
                updatePagination();
              } else {
                console.error('APIè¿”å›é”™è¯¯:', data);
                showToast('åŠ è½½æ•°æ®å¤±è´¥: ' + (data.error || data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('åŠ è½½æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯');
            })
            .finally(() => {
              hideLoading();
            });
  }


  // æœç´¢è¯„å®¡ç»“æœ
  function searchReviews() {
    console.log('å¼€å§‹æœç´¢');
    currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    loadReviewData(); // é‡æ–°åŠ è½½æ•°æ®ï¼ŒæœåŠ¡å™¨ç«¯ä¼šå¤„ç†ç­›é€‰
  }

  // é‡ç½®ç­›é€‰æ¡ä»¶
  function resetFilters() {
    document.getElementById('majorCodeFilter').value = '';
    document.getElementById('minorCodeFilter').value = '';
    document.getElementById('projectPhaseFilter').value = '';
    document.getElementById('versionFilter').value = '';
    document.getElementById('supplierFilter').value = '';
    document.getElementById('testStartDateFilter').value = '';
    document.getElementById('testEndDateFilter').value = '';

    // é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶é‡æ–°åŠ è½½æ•°æ®
    currentPage = 1;
    loadReviewData();
  }

  // è·å–å½“å‰ç”¨æˆ·å
  function getCurrentUsername() {
    return currentUser || '';
  }

  // å¤„ç†æ–‡ä»¶å¯¼å…¥
  function handleFileImport() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (!file) {
      showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'error');
      return;
    }

    // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
    if (!file.name.toLowerCase().endsWith('.xlsx')) {
      showToast('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é€‰æ‹©.xlsxæ ¼å¼çš„Excelæ–‡ä»¶', 'error');
      return;
    }

    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º100MBï¼‰
    if (file.size > 100 * 1024 * 1024) {
      showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡100MB', 'error');
      return;
    }

    // æ˜¾ç¤ºè¿›åº¦æ¡
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('confirmImportBtn').disabled = true;

    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 90) progress = 90;
      updateProgress(progress);
    }, 200);

    // åˆ›å»ºFormData
    const formData = new FormData();
    formData.append('file', file);
    formData.append('username', getCurrentUsername());

    // å‘é€è¯·æ±‚
    fetch('/reviewResult/importReviewResults', {
      method: 'POST',
      body: formData
    })
            .then(response => response.json())
            .then(data => {
              clearInterval(progressInterval);
              updateProgress(100);

              setTimeout(() => {
                if (data.success) {
                  showToast(`å¯¼å…¥æˆåŠŸï¼${data.message}`, 'success');
                  // å…³é—­æ¨¡æ€æ¡†
                  closeImportModal();
                  // åˆ·æ–°æ•°æ®
                  loadReviewData();
                } else {
                  showToast(`å¯¼å…¥å¤±è´¥ï¼š${data.message}`, 'error');
                  document.getElementById('confirmImportBtn').disabled = false;
                }
                document.getElementById('uploadProgress').style.display = 'none';
              }, 500);
            })
            .catch(error => {
              clearInterval(progressInterval);
              document.getElementById('uploadProgress').style.display = 'none';
              document.getElementById('confirmImportBtn').disabled = false;
              console.error('å¯¼å…¥é”™è¯¯:', error);
              showToast('å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'error');
            });
  }

  // æ›´æ–°è¿›åº¦æ¡
  function updateProgress(percent) {
    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressText').textContent = Math.round(percent) + '%';
  }

  // å¯¼å‡ºç­›é€‰ç»“æœ
  function exportFilteredData() {
    // è·å–é€‰ä¸­çš„è¡Œ
    const selectedRows = getSelectedTableRows();

    if (selectedRows.length === 0) {
      alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ•°æ®è¡Œï¼');
      return;
    }

    showLoading();

    // å‡†å¤‡å¯¼å‡ºæ•°æ®
    const exportData = {
      data: selectedRows,
      exportType: 'reviewResults',
      fileName: `è¯„å®¡ç»“æœæ•°æ®_${new Date().toISOString().slice(0, 10)}.xlsx`
    };

    fetch('/problemLibrary/exportCartsData', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(exportData)
    })
            .then(response => {
              if (response.ok) {
                return response.blob();
              } else {
                throw new Error('å¯¼å‡ºå¤±è´¥');
              }
            })
            .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = exportData.fileName;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
              showToast(`æˆåŠŸå¯¼å‡º ${selectedRows.length} æ¡è¯„å®¡ç»“æœæ•°æ®ï¼`, 'success');
            })
            .catch(error => {
              console.error('Error:', error);
              showToast('å¯¼å‡ºæ—¶å‘ç”Ÿé”™è¯¯', 'error');
            })
            .finally(() => {
              hideLoading();
            });
  }

  // æ˜¾ç¤ºè¯„å®¡ç»“æœè¯¦æƒ…
  function showReviewDetail(reviewId) {
    const review = filteredData.find(r => r.id === reviewId);
    if (!review) return;

    // å…ˆé‡ç½®ç¼–è¾‘çŠ¶æ€ï¼ˆé˜²æ­¢ä¹‹å‰çš„çŠ¶æ€å½±å“ï¼‰
    resetReviewEditMode();

    // å­˜å‚¨å½“å‰ç¼–è¾‘çš„è¯„å®¡ç»“æœID
    currentEditingReviewId = reviewId;

    // å¡«å……è¯¦æƒ…æ•°æ®
    document.getElementById('detailTestDate').textContent = review.testDate || '-';
    document.getElementById('detailMajorCode').textContent = review.majorCode || '-';
    document.getElementById('detailMinorCode').textContent = review.minorCode || '-';
    document.getElementById('detailProjectPhase').textContent = review.projectPhase || '-';
    document.getElementById('detailVersion').textContent = review.version || '-';
    document.getElementById('detailProblemProcess').textContent = review.problemProcess || '-';
    document.getElementById('detailProblemLevel').textContent = review.problemLevel || '-';
    document.getElementById('detailDevelopmentMethod').textContent = review.developmentMethod || '-';
    document.getElementById('detailSupplier').textContent = review.supplier || '-';
    document.getElementById('detailSolutionProvider').textContent = review.solutionProvider || '-';
    document.getElementById('detailProblemPoint').textContent = review.problemPoint || '-';
    document.getElementById('detailProblemReason').textContent = review.problemReason || '-';
    document.getElementById('detailImprovementMeasures').textContent = review.improvementMeasures || '-';
    document.getElementById('detailIsPreventable').textContent = review.isPreventable || '-';
    document.getElementById('detailResponsibleDepartment').textContent = review.responsibleDepartment || '-';
    document.getElementById('detailPlannedCompletionTime').textContent = review.plannedCompletionTime || '-';
    document.getElementById('detailActualCompletionTime').textContent = review.actualCompletionTime || '-';
    document.getElementById('detailDelayDays').textContent = review.delayDays || '-';
    document.getElementById('detailProblemStatus').textContent = review.problemStatus || '-';
    document.getElementById('detailProblemTag1').textContent = review.problemTag1 || '-';
    document.getElementById('detailProblemTag2').textContent = review.problemTag2 || '-';
    document.getElementById('detailPreventionNotes').textContent = review.preventionNotes || '-';
    document.getElementById('detailCreatedTime').textContent = review.createdTime || '-';
    document.getElementById('detailUpdatedTime').textContent = review.updatedTime || '-';

    // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼Œéšè—ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
    document.getElementById('editReviewBtn').style.display = 'inline-block';
    document.getElementById('saveReviewBtn').style.display = 'none';
    document.getElementById('cancelEditReviewBtn').style.display = 'none';

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('reviewDetailModal').style.display = 'block';
  }

  // è¿›å…¥ç¼–è¾‘æ¨¡å¼
  function enterReviewEditMode() {
    // éšè—ç¼–è¾‘æŒ‰é’®ï¼Œæ˜¾ç¤ºä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
    document.getElementById('editReviewBtn').style.display = 'none';
    document.getElementById('saveReviewBtn').style.display = 'inline-block';
    document.getElementById('cancelEditReviewBtn').style.display = 'inline-block';

    // å°†åªè¯»å­—æ®µè½¬æ¢ä¸ºå¯ç¼–è¾‘å­—æ®µ
    convertToEditMode();
  }

  // é€€å‡ºç¼–è¾‘æ¨¡å¼
  function exitReviewEditMode() {
    // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼Œéšè—ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
    document.getElementById('editReviewBtn').style.display = 'inline-block';
    document.getElementById('saveReviewBtn').style.display = 'none';
    document.getElementById('cancelEditReviewBtn').style.display = 'none';

    // å°†å¯ç¼–è¾‘å­—æ®µè½¬æ¢å›åªè¯»å­—æ®µ
    convertToReadMode();
  }

  // è½¬æ¢ä¸ºç¼–è¾‘æ¨¡å¼
  function convertToEditMode() {
    const fieldMappings = [
      { id: 'detailTestDate', type: 'date' },
      { id: 'detailMajorCode', type: 'text' },
      { id: 'detailMinorCode', type: 'text' },
      { id: 'detailProjectPhase', type: 'text' },
      { id: 'detailVersion', type: 'text' },
      { id: 'detailProblemProcess', type: 'text' },
      { id: 'detailProblemLevel', type: 'select', options: ['é«˜', 'ä¸­', 'ä½'] },
      { id: 'detailDevelopmentMethod', type: 'text' },
      { id: 'detailSupplier', type: 'text' },
      { id: 'detailSolutionProvider', type: 'text' },
      { id: 'detailProblemPoint', type: 'textarea' },
      { id: 'detailProblemReason', type: 'textarea' },
      { id: 'detailImprovementMeasures', type: 'textarea' },
      { id: 'detailIsPreventable', type: 'select', options: ['æ˜¯', 'å¦'] },
      { id: 'detailResponsibleDepartment', type: 'text' },
      { id: 'detailPlannedCompletionTime', type: 'date' },
      { id: 'detailActualCompletionTime', type: 'date' },
      { id: 'detailDelayDays', type: 'number' },
      { id: 'detailProblemStatus', type: 'select', options: ['å¾…å¤„ç†', 'å¤„ç†ä¸­', 'å·²å®Œæˆ', 'å·²å…³é—­'] },
      { id: 'detailProblemTag1', type: 'text' },
      { id: 'detailProblemTag2', type: 'text' },
      { id: 'detailPreventionNotes', type: 'textarea' }
    ];

    fieldMappings.forEach(field => {
      const element = document.getElementById(field.id);
      if (element) {
        const parent = element.parentElement;
        const currentValue = element.textContent === '-' ? '' : element.textContent;

        // åˆ›å»ºæ–°çš„è¾“å…¥å…ƒç´ 
        let inputElement;
        if (field.type === 'textarea') {
          inputElement = document.createElement('textarea');
          inputElement.rows = 3;
        } else if (field.type === 'select') {
          inputElement = document.createElement('select');
          field.options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            inputElement.appendChild(optionElement);
          });
        } else {
          inputElement = document.createElement('input');
          inputElement.type = field.type;
        }

        inputElement.id = 'edit' + field.id;
        inputElement.value = currentValue;
        inputElement.className = 'form-control';

        // æ›¿æ¢åŸå…ƒç´ 
        parent.replaceChild(inputElement, element);
      }
    });

    // è®¾ç½®åªè¯»å­—æ®µï¼ˆåˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´ï¼‰
    const readonlyFields = ['detailCreatedTime', 'detailUpdatedTime'];
    readonlyFields.forEach(fieldId => {
      const element = document.getElementById(fieldId);
      if (element) {
        element.parentElement.classList.add('readonly');
      }
    });
  }

  // è½¬æ¢ä¸ºåªè¯»æ¨¡å¼
  function convertToReadMode() {
    const fieldMappings = [
      'detailTestDate', 'detailMajorCode', 'detailMinorCode', 'detailProjectPhase',
      'detailVersion', 'detailProblemProcess', 'detailProblemLevel', 'detailDevelopmentMethod',
      'detailSupplier', 'detailSolutionProvider', 'detailProblemPoint', 'detailProblemReason',
      'detailImprovementMeasures', 'detailIsPreventable', 'detailResponsibleDepartment',
      'detailPlannedCompletionTime', 'detailActualCompletionTime', 'detailDelayDays',
      'detailProblemStatus', 'detailProblemTag1', 'detailProblemTag2', 'detailPreventionNotes'
    ];

    fieldMappings.forEach(fieldId => {
      const editElement = document.getElementById('edit' + fieldId);
      if (editElement) {
        const parent = editElement.parentElement;
        const currentValue = editElement.value || '-';

        // åˆ›å»ºæ–°çš„æ˜¾ç¤ºå…ƒç´ 
        let displayElement;
        if (fieldId.includes('ProblemPoint') || fieldId.includes('ProblemReason') ||
                fieldId.includes('ImprovementMeasures') || fieldId.includes('PreventionNotes')) {
          displayElement = document.createElement('div');
          displayElement.className = 'problem-desc';
        } else {
          displayElement = document.createElement('span');
        }

        displayElement.id = fieldId;
        displayElement.textContent = currentValue;

        // æ›¿æ¢ç¼–è¾‘å…ƒç´ 
        parent.replaceChild(displayElement, editElement);
      }
    });

    // ç§»é™¤åªè¯»å­—æ®µçš„æ ·å¼
    const readonlyFields = ['detailCreatedTime', 'detailUpdatedTime'];
    readonlyFields.forEach(fieldId => {
      const element = document.getElementById(fieldId);
      if (element) {
        element.parentElement.classList.remove('readonly');
      }
    });
  }

  // ä¿å­˜è¯„å®¡ç»“æœç¼–è¾‘
  function saveReviewEdit() {
    if (!currentEditingReviewId) {
      showToast('æ²¡æœ‰æ‰¾åˆ°è¦ç¼–è¾‘çš„è¯„å®¡ç»“æœ', 'error');
      return;
    }

    // æ”¶é›†ç¼–è¾‘åçš„æ•°æ®
    const editData = {
      id: currentEditingReviewId,
      testDate: document.getElementById('editdetailTestDate')?.value || '',
      majorCode: document.getElementById('editdetailMajorCode')?.value || '',
      minorCode: document.getElementById('editdetailMinorCode')?.value || '',
      projectPhase: document.getElementById('editdetailProjectPhase')?.value || '',
      version: document.getElementById('editdetailVersion')?.value || '',
      problemProcess: document.getElementById('editdetailProblemProcess')?.value || '',
      problemLevel: document.getElementById('editdetailProblemLevel')?.value || '',
      developmentMethod: document.getElementById('editdetailDevelopmentMethod')?.value || '',
      supplier: document.getElementById('editdetailSupplier')?.value || '',
      solutionProvider: document.getElementById('editdetailSolutionProvider')?.value || '',
      problemPoint: document.getElementById('editdetailProblemPoint')?.value || '',
      problemReason: document.getElementById('editdetailProblemReason')?.value || '',
      improvementMeasures: document.getElementById('editdetailImprovementMeasures')?.value || '',
      isPreventable: document.getElementById('editdetailIsPreventable')?.value || '',
      responsibleDepartment: document.getElementById('editdetailResponsibleDepartment')?.value || '',
      plannedCompletionTime: document.getElementById('editdetailPlannedCompletionTime')?.value || '',
      actualCompletionTime: document.getElementById('editdetailActualCompletionTime')?.value || '',
      delayDays: document.getElementById('editdetailDelayDays')?.value || '',
      problemStatus: document.getElementById('editdetailProblemStatus')?.value || '',
      problemTag1: document.getElementById('editdetailProblemTag1')?.value || '',
      problemTag2: document.getElementById('editdetailProblemTag2')?.value || '',
      preventionNotes: document.getElementById('editdetailPreventionNotes')?.value || ''
    };

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading();

    // å‘é€æ›´æ–°è¯·æ±‚
    fetch('/reviewResult/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(editData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showToast('è¯„å®¡ç»“æœæ›´æ–°æˆåŠŸ', 'success');
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const reviewIndex = filteredData.findIndex(r => r.id === currentEditingReviewId);
                if (reviewIndex !== -1) {
                  Object.assign(filteredData[reviewIndex], editData);
                }
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                exitReviewEditMode();
                // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
                renderTable();
              } else {
                showToast('æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showToast('æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            })
            .finally(() => {
              hideLoading();
            });
  }

  // å–æ¶ˆè¯„å®¡ç»“æœç¼–è¾‘
  function cancelReviewEdit() {
    // é€€å‡ºç¼–è¾‘æ¨¡å¼
    exitReviewEditMode();
    // é‡æ–°åŠ è½½åŸå§‹æ•°æ®
    showReviewDetail(currentEditingReviewId);
  }

  // é‡ç½®è¯„å®¡ç»“æœç¼–è¾‘æ¨¡å¼ï¼ˆç”¨äºæ¨¡æ€æ¡†å…³é—­æ—¶ï¼‰
  function resetReviewEditMode() {
    // å¦‚æœå½“å‰åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå…ˆé€€å‡ºç¼–è¾‘æ¨¡å¼
    const editBtn = document.getElementById('editReviewBtn');
    const saveBtn = document.getElementById('saveReviewBtn');
    const cancelBtn = document.getElementById('cancelEditReviewBtn');

    if (editBtn && saveBtn && cancelBtn) {
      // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼
      if (saveBtn.style.display !== 'none') {
        // åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œéœ€è¦é‡ç½®
        exitReviewEditMode();
      }
    }

    // æ¸…ç©ºå½“å‰ç¼–è¾‘çš„è¯„å®¡ç»“æœID
    currentEditingReviewId = null;
  }


  // æ˜¾ç¤ºé—®é¢˜ç‚¹è¯¦æƒ…
  function showProblemDetail(problemId) {
    // é¦–å…ˆå°è¯•ä»å½“å‰è¿‡æ»¤æ•°æ®ä¸­æŸ¥æ‰¾
    let problem = filteredData.find(p => p.id === problemId);

    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜æ˜¯ä»å†å²ç‰ˆæœ¬æ¨¡æ€æ¡†ä¸­ç‚¹å‡»çš„ï¼Œéœ€è¦é€šè¿‡APIè·å–è¯¦æƒ…
    if (!problem) {
      showLoading();
      fetch(`/problemLibrary/getProblemById?id=${problemId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  problem = data.data;
                  displayProblemDetail(problem);
                } else {
                  alert('è·å–é—®é¢˜ç‚¹è¯¦æƒ…å¤±è´¥: ' + data.message);
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('è·å–é—®é¢˜ç‚¹è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯');
              })
              .finally(() => {
                hideLoading();
              });
      return;
    }

    displayProblemDetail(problem);
  }

  // æ˜¾ç¤ºé—®é¢˜ç‚¹è¯¦æƒ…çš„å…·ä½“å®ç°
  function displayProblemDetail(problem) {
    // å¡«å……è¯¦æƒ…æ•°æ®
    document.getElementById('detailFullModel').textContent = problem.full_model || '';
    document.getElementById('detailSampleId').textContent = problem.sample_id || '';
    document.getElementById('detailBigSpecies').textContent = problem.big_species || '';
    document.getElementById('detailSmallSpecies').textContent = problem.small_species || '';
    document.getElementById('detailSampleStage').textContent = problem.sample_stage || '';
    document.getElementById('detailVersion').textContent = problem.version || '';
    document.getElementById('detailChipSolution').textContent = problem.chip_solution || '';
    document.getElementById('detailTestPlatform').textContent = problem.test_platform || '';
    document.getElementById('detailTestDevice').textContent = problem.test_device || '';
    document.getElementById('detailOtherDevice').textContent = problem.other_device || '';
    document.getElementById('detailProblem').textContent = problem.problem || '';

    // æ˜¾ç¤ºé—®é¢˜å›¾ç‰‡
    displayProblemImages(problem.problem_image_or_video);

    document.getElementById('detailProblemCategory').textContent = problem.problemCategory || '';
    document.getElementById('detailDefectLevel').textContent = problem.defect_level || '';
    document.getElementById('detailCurrentStatus').textContent = normalizeStatus(problem.current_status);
    document.getElementById('detailReproductionMethod').textContent = problem.reproduction_method || '';
    document.getElementById('detailRecoveryMethod').textContent = problem.recovery_method || '';
    document.getElementById('detailReproductionProbability').textContent = problem.reproduction_probability || '';
    document.getElementById('detailTester').textContent = problem.tester || '';
    document.getElementById('detailResponsibleDepartment').textContent = problem.responsibleDepartment || '';
    document.getElementById('detailResponsiblePerson').textContent = problem.responsible_person || '';
    document.getElementById('detailDqeConfirm').textContent = problem.dqe_confirm || '';
    document.getElementById('detailRdConfirm').textContent = problem.rd_confirm || '';
    document.getElementById('detailImprovementPlan').textContent = problem.improvement_plan || '';
    document.getElementById('detailGreenUnionDqe').textContent = problem.green_union_dqe || '';
    document.getElementById('detailGreenUnionRd').textContent = problem.green_union_rd || '';
    document.getElementById('detailComparisonWithPrevious').textContent = problem.comparison_with_previous || '';
    document.getElementById('detailPostImprovementRisk').textContent = problem.post_improvement_risk || '';
    document.getElementById('detailNextVersionRegressionTest').textContent = problem.next_version_regression_test || '';
    document.getElementById('detailRemark').textContent = problem.remark || '';
    document.getElementById('detailTestOverseas').textContent = problem.test_Overseas || '';
    document.getElementById('detailCreatedAt').textContent = problem.created_at || '';

    // è®¾ç½®é—®é¢˜ID
    document.getElementById('editProblemId').value = problem.id;

    // åŒæ­¥ç¼–è¾‘è¾“å…¥æ¡†çš„å€¼
    document.getElementById('editDetailFullModel').value = problem.full_model || '';
    document.getElementById('editDetailBigSpecies').value = problem.big_species || '';
    document.getElementById('editDetailSmallSpecies').value = problem.small_species || '';
    document.getElementById('editDetailSampleStage').value = problem.sample_stage || '';
    document.getElementById('editDetailVersion').value = problem.version || '';
    document.getElementById('editDetailChipSolution').value = problem.chip_solution || '';
    document.getElementById('editDetailTestPlatform').value = problem.test_platform || '';
    document.getElementById('editDetailTestDevice').value = problem.test_device || '';
    document.getElementById('editDetailOtherDevice').value = problem.other_device || '';
    document.getElementById('editDetailProblem').value = problem.problem || '';
    document.getElementById('editDetailProblemCategory').value = problem.problemCategory || '';
    document.getElementById('editDetailDefectLevel').value = problem.defect_level || '';
    document.getElementById('editDetailCurrentStatus').value = normalizeStatus(problem.current_status);
    document.getElementById('editDetailReproductionMethod').value = problem.reproduction_method || '';
    document.getElementById('editDetailRecoveryMethod').value = problem.recovery_method || '';
    document.getElementById('editDetailReproductionProbability').value = problem.reproduction_probability || '';
    document.getElementById('editDetailTester').value = problem.tester || '';
    document.getElementById('editDetailResponsibleDepartment').value = problem.responsibleDepartment || '';
    document.getElementById('editDetailResponsiblePerson').value = problem.responsible_person || '';
    document.getElementById('editDetailDqeConfirm').value = problem.dqe_confirm || '';
    document.getElementById('editDetailRdConfirm').value = problem.rd_confirm || '';
    document.getElementById('editDetailImprovementPlan').value = problem.improvement_plan || '';
    document.getElementById('editDetailGreenUnionDqe').value = problem.green_union_dqe || '';
    document.getElementById('editDetailGreenUnionRd').value = problem.green_union_rd || '';
    document.getElementById('editDetailComparisonWithPrevious').value = problem.comparison_with_previous || '';
    document.getElementById('editDetailPostImprovementRisk').value = problem.post_improvement_risk || '';
    document.getElementById('editDetailNextVersionRegressionTest').value = problem.next_version_regression_test || '';
    document.getElementById('editDetailRemark').value = problem.remark || '';
    document.getElementById('editDetailTestOverseas').value = problem.test_Overseas || '';

    // æ ¹æ®æƒé™æ§åˆ¶ç¼–è¾‘æŒ‰é’®æ˜¾ç¤º
    const editBtn = document.getElementById('editProblemBtn');
    if (editBtn) {
      if (isSuperAdmin) {
        editBtn.style.display = 'inline-flex';
      } else {
        editBtn.style.display = 'none';
      }
    }

    // ç¡®ä¿é€€å‡ºç¼–è¾‘æ¨¡å¼
    exitEditMode();

    document.getElementById('problemDetailModal').style.display = 'block';
  }

  // æ˜¾ç¤ºé—®é¢˜å›¾ç‰‡
  function displayProblemImages(imageData) {
    const container = document.getElementById('detailProblemImage');
    container.innerHTML = '';

    if (!imageData || imageData.trim() === '') {
      container.innerHTML = '<div class="no-image">æš‚æ— é—®é¢˜å›¾ç‰‡</div>';
      return;
    }

    try {
      // å¤„ç†å›¾ç‰‡è·¯å¾„æ•°æ®
      let imageUrls = [];

      // å¦‚æœæ˜¯JSONå­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
      if (imageData.startsWith('[') || imageData.startsWith('{')) {
        try {
          const parsed = JSON.parse(imageData);
          if (Array.isArray(parsed)) {
            imageUrls = parsed;
          } else if (parsed.urls && Array.isArray(parsed.urls)) {
            imageUrls = parsed.urls;
          }
        } catch (e) {
          console.warn('è§£æå›¾ç‰‡JSONæ•°æ®å¤±è´¥:', e);
        }
      }

      // å¦‚æœè§£æå¤±è´¥æˆ–ä¸æ˜¯JSONï¼Œå°è¯•æŒ‰é€—å·åˆ†å‰²
      if (imageUrls.length === 0) {
        imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
      }

      if (imageUrls.length === 0) {
        container.innerHTML = '<div class="no-image">æš‚æ— é—®é¢˜å›¾ç‰‡</div>';
        return;
      }

      // åˆ›å»ºå›¾ç‰‡ç”»å»Š
      const gallery = document.createElement('div');
      gallery.className = 'image-gallery';

      imageUrls.forEach((imagePath, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';

        const img = document.createElement('img');

        // å¤„ç†å›¾ç‰‡è·¯å¾„ï¼šå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿç›´æ¥ä½¿ç”¨
        let imageUrl = imagePath;

        // ç¡®ä¿è·¯å¾„ä»¥/å¼€å¤´ï¼ˆæœåŠ¡å™¨ç›¸å¯¹è·¯å¾„ï¼‰
        if (!imagePath.startsWith('/') && !imagePath.startsWith('http')) {
          imageUrl = '/' + imagePath;
        }

        img.src = imageUrl;
        img.alt = `é—®é¢˜å›¾ç‰‡ ${index + 1}`;
        img.title = `ç‚¹å‡»æŸ¥çœ‹å¤§å›¾ - ${imagePath}`;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œå¯ä»¥æ”¾å¤§æŸ¥çœ‹
        img.addEventListener('click', function() {
          showImageModal(imageUrl, index + 1, imageUrls.map(path => {
            if (!path.startsWith('/') && !path.startsWith('http')) {
              return '/' + path;
            }
            return path;
          }));
        });

        // æ·»åŠ é”™è¯¯å¤„ç†
        img.addEventListener('error', function() {
          this.style.display = 'none';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'no-image';
          errorDiv.textContent = `å›¾ç‰‡åŠ è½½å¤±è´¥: ${imagePath}`;
          imageItem.appendChild(errorDiv);
        });

        imageItem.appendChild(img);
        gallery.appendChild(imageItem);
      });

      container.appendChild(gallery);
    } catch (error) {
      console.error('å¤„ç†é—®é¢˜å›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯:', error);
      container.innerHTML = '<div class="no-image">å›¾ç‰‡æ•°æ®æ ¼å¼é”™è¯¯</div>';
    }
  }

  // æ˜¾ç¤ºå›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
  function showImageModal(imageUrl, currentIndex, allUrls) {
    // åˆ›å»ºå›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.zIndex = '10001';
    modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 20px;">
                    <div class="modal-header">
                        <h2>é—®é¢˜å›¾ç‰‡æŸ¥çœ‹ (${currentIndex}/${allUrls.length})</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="text-align: center; overflow: auto; position: relative;">
                        <div id="imageContainer" style="position: relative; display: inline-block;">
                            <img id="modalImage" src="${imageUrl}" style="max-width: 100%; max-height: 70vh; border-radius: 4px; transition: transform 0.3s ease; cursor: zoom-in;">
                        </div>
                        <div style="margin-top: 10px;">
                            ${allUrls.length > 1 ? `
                                <button onclick="switchImage(${currentIndex - 2}, ${allUrls.length})" ${currentIndex <= 1 ? 'disabled' : ''}>ä¸Šä¸€å¼ </button>
                                <button onclick="switchImage(${currentIndex}, ${allUrls.length})" ${currentIndex >= allUrls.length ? 'disabled' : ''}>ä¸‹ä¸€å¼ </button>
                            ` : ''}
                            <button onclick="resetImageZoom()">é‡ç½®ç¼©æ”¾</button>
                        </div>
                    </div>
                </div>
            `;

    document.body.appendChild(modal);
    modal.style.display = 'block';

    // åˆå§‹åŒ–å›¾ç‰‡ç¼©æ”¾åŠŸèƒ½
    initImageZoom(modal);

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  // åˆå§‹åŒ–å›¾ç‰‡ç¼©æ”¾åŠŸèƒ½
  function initImageZoom(modal) {
    const img = modal.querySelector('#modalImage');
    const container = modal.querySelector('#imageContainer');
    let scale = 1;
    let isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;

    // é¼ æ ‡æ»šè½®ç¼©æ”¾
    img.addEventListener('wheel', function(e) {
      e.preventDefault();

      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      const newScale = Math.max(0.1, Math.min(5, scale + delta));

      if (newScale !== scale) {
        scale = newScale;
        updateImageTransform();
      }
    });

    // é¼ æ ‡ç‚¹å‡»åˆ‡æ¢ç¼©æ”¾
    img.addEventListener('click', function(e) {
      e.stopPropagation();

      if (scale === 1) {
        scale = 2;
        img.style.cursor = 'zoom-out';
      } else {
        scale = 1;
        translateX = 0;
        translateY = 0;
        img.style.cursor = 'zoom-in';
      }

      updateImageTransform();
    });

    // é¼ æ ‡æ‹–æ‹½
    img.addEventListener('mousedown', function(e) {
      if (scale > 1) {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        img.style.cursor = 'grabbing';
      }
    });

    document.addEventListener('mousemove', function(e) {
      if (isDragging) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        updateImageTransform();
      }
    });

    document.addEventListener('mouseup', function() {
      if (isDragging) {
        isDragging = false;
        img.style.cursor = scale > 1 ? 'grab' : 'zoom-in';
      }
    });

    // æ›´æ–°å›¾ç‰‡å˜æ¢
    function updateImageTransform() {
      img.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
    }

    // é‡ç½®ç¼©æ”¾
    window.resetImageZoom = function() {
      scale = 1;
      translateX = 0;
      translateY = 0;
      img.style.cursor = 'zoom-in';
      updateImageTransform();
    };

    // å…¨å±€æœç´¢å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
      // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸­ï¼ŒæŒ‰å›è½¦é”®è§¦å‘æœç´¢
      if (e.key === 'Enter' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
        const activeElement = document.activeElement;
        const isInputField = activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.tagName === 'SELECT'
        );

        // å¦‚æœç„¦ç‚¹åœ¨ç­›é€‰è¾“å…¥æ¡†ä¸­ï¼Œè§¦å‘æœç´¢
        if (isInputField && filterInputs.includes(activeElement.id)) {
          e.preventDefault();
          searchReviews();
          return;
        }

        // å¦‚æœç„¦ç‚¹åœ¨æœç´¢æŒ‰é’®ä¸Šï¼Œè§¦å‘æœç´¢
        if (activeElement && activeElement.id === 'searchBtn') {
          e.preventDefault();
          searchReviews();
          return;
        }
      }
    });

    // å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†çš„é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
      if (modal && modal.style.display === 'block') {
        if (e.key === 'Escape') {
          modal.remove();
        } else if (e.key === '0') {
          resetImageZoom();
        } else if (e.key === '+' || e.key === '=') {
          scale = Math.min(5, scale + 0.2);
          updateImageTransform();
        } else if (e.key === '-') {
          scale = Math.max(0.1, scale - 0.2);
          updateImageTransform();
        }
      }
    });
  }

  // åˆ‡æ¢å›¾ç‰‡
  function switchImage(newIndex, totalCount) {
    if (newIndex < 0 || newIndex >= totalCount) return;

    const modal = document.querySelector('.modal[style*="z-index: 10001"]');
    if (modal) {
      const img = modal.querySelector('#modalImage');
      const allUrls = Array.from(document.querySelectorAll('.image-item img')).map(img => img.src);
      img.src = allUrls[newIndex];

      // é‡ç½®ç¼©æ”¾çŠ¶æ€
      img.style.transform = 'scale(1) translate(0px, 0px)';
      img.style.cursor = 'zoom-in';

      // æ›´æ–°æ ‡é¢˜
      const title = modal.querySelector('h2');
      title.textContent = `é—®é¢˜å›¾ç‰‡æŸ¥çœ‹ (${newIndex + 1}/${totalCount})`;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      const prevBtn = modal.querySelector('button[onclick*="ä¸Šä¸€å¼ "]');
      const nextBtn = modal.querySelector('button[onclick*="ä¸‹ä¸€å¼ "]');
      if (prevBtn) prevBtn.disabled = newIndex <= 0;
      if (nextBtn) nextBtn.disabled = newIndex >= totalCount - 1;

      // é‡æ–°åˆå§‹åŒ–ç¼©æ”¾åŠŸèƒ½
      initImageZoom(modal);
    }
  }

  // æ˜¾ç¤ºç¼–è¾‘é—®é¢˜ç‚¹æ¨¡æ€æ¡†
  function showEditProblemModal(problemId) {
    // æ£€æŸ¥æƒé™
    if (!isSuperAdmin) {
      alert('æ‚¨æ²¡æœ‰æƒé™è¿›è¡Œæ­¤æ“ä½œï¼');
      return;
    }

    const problem = filteredData.find(p => p.id === problemId);
    if (!problem) return;

    // å¡«å……ç¼–è¾‘è¡¨å•
    document.getElementById('editProblemId').value = problem.id;
    document.getElementById('editFullModel').value = problem.full_model || '';
    document.getElementById('editSampleStage').value = problem.sample_stage || '';
    document.getElementById('editVersion').value = problem.version || '';
    document.getElementById('editProblemCategory').value = problem.problemCategory || '';
    document.getElementById('editDefectLevel').value = problem.defect_level || '';
    document.getElementById('editCurrentStatus').value = normalizeStatus(problem.current_status);
    document.getElementById('editProblem').value = problem.problem || '';

    // åˆå§‹åŒ–é—®é¢˜å›¾ç‰‡å­—æ®µ
    const imageField = document.getElementById('editProblemImage');
    imageField.value = problem.problem_image_or_video || '';
    updateImagePreview();

    document.getElementById('editReproductionMethod').value = problem.reproduction_method || '';
    document.getElementById('editRecoveryMethod').value = problem.recovery_method || '';
    document.getElementById('editReproductionProbability').value = problem.reproduction_probability || '';
    document.getElementById('editTester').value = problem.tester || '';
    document.getElementById('editResponsibleDepartment').value = problem.responsibleDepartment || '';
    document.getElementById('editResponsiblePerson').value = problem.responsible_person || '';
    document.getElementById('editImprovementPlan').value = problem.improvement_plan || '';
    document.getElementById('editGreenUnionDqe').value = problem.green_union_dqe || '';
    document.getElementById('editGreenUnionRd').value = problem.green_union_rd || '';
    document.getElementById('editTestOverseas').value = problem.test_Overseas || '';
    document.getElementById('editRemark').value = problem.remark || '';

    document.getElementById('editProblemModal').style.display = 'block';
  }

  // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
  function updateImagePreview() {
    const imageField = document.getElementById('editProblemImage');
    const previewContainer = document.getElementById('editImagePreview');

    if (!imageField || !previewContainer) return;

    const imageData = imageField.value.trim();
    previewContainer.innerHTML = '';

    if (!imageData) {
      previewContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— å›¾ç‰‡é¢„è§ˆ</div>';
      return;
    }

    try {
      // è§£æå›¾ç‰‡è·¯å¾„
      let imageUrls = [];

      // å¦‚æœæ˜¯JSONå­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
      if (imageData.startsWith('[') || imageData.startsWith('{')) {
        try {
          const parsed = JSON.parse(imageData);
          if (Array.isArray(parsed)) {
            imageUrls = parsed;
          } else if (parsed.urls && Array.isArray(parsed.urls)) {
            imageUrls = parsed.urls;
          }
        } catch (e) {
          console.warn('è§£æå›¾ç‰‡JSONæ•°æ®å¤±è´¥:', e);
        }
      }

      // å¦‚æœè§£æå¤±è´¥æˆ–ä¸æ˜¯JSONï¼Œå°è¯•æŒ‰é€—å·åˆ†å‰²
      if (imageUrls.length === 0) {
        imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
      }

      if (imageUrls.length === 0) {
        previewContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— æœ‰æ•ˆå›¾ç‰‡è·¯å¾„</div>';
        return;
      }

      // åˆ›å»ºé¢„è§ˆç”»å»Š
      const gallery = document.createElement('div');
      gallery.className = 'preview-gallery';

      imageUrls.forEach((imagePath, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';

        const img = document.createElement('img');
        let imageUrl = imagePath;

        // ç¡®ä¿è·¯å¾„ä»¥/å¼€å¤´ï¼ˆæœåŠ¡å™¨ç›¸å¯¹è·¯å¾„ï¼‰
        if (!imagePath.startsWith('/') && !imagePath.startsWith('http')) {
          imageUrl = '/' + imagePath;
        }

        img.src = imageUrl;
        img.alt = `é¢„è§ˆå›¾ç‰‡ ${index + 1}`;
        img.title = imagePath;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œå¯ä»¥æ”¾å¤§æŸ¥çœ‹
        img.addEventListener('click', function() {
          showImageModal(imageUrl, index + 1, imageUrls.map(path => {
            if (!path.startsWith('/') && !path.startsWith('http')) {
              return '/' + path;
            }
            return path;
          }));
        });

        // æ·»åŠ é”™è¯¯å¤„ç†
        img.addEventListener('error', function() {
          this.style.display = 'none';
          const errorDiv = document.createElement('div');
          errorDiv.style.color = '#dc3545';
          errorDiv.style.fontSize = '10px';
          errorDiv.style.padding = '5px';
          errorDiv.textContent = 'åŠ è½½å¤±è´¥';
          previewItem.appendChild(errorDiv);
        });

        // æ·»åŠ åˆ é™¤æŒ‰é’®
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = 'Ã—';
        removeBtn.title = 'åˆ é™¤æ­¤å›¾ç‰‡';
        removeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          removeImageFromEdit(index);
        });

        previewItem.appendChild(img);
        previewItem.appendChild(removeBtn);
        gallery.appendChild(previewItem);
      });

      previewContainer.appendChild(gallery);
    } catch (error) {
      console.error('å¤„ç†å›¾ç‰‡é¢„è§ˆæ—¶å‘ç”Ÿé”™è¯¯:', error);
      previewContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">å›¾ç‰‡æ•°æ®æ ¼å¼é”™è¯¯</div>';
    }
  }

  // ä»ç¼–è¾‘ä¸­åˆ é™¤å›¾ç‰‡
  function removeImageFromEdit(index) {
    const imageField = document.getElementById('editProblemImage');
    const imageData = imageField.value.trim();

    if (!imageData) return;

    try {
      let imageUrls = [];

      // è§£æå›¾ç‰‡è·¯å¾„
      if (imageData.startsWith('[') || imageData.startsWith('{')) {
        try {
          const parsed = JSON.parse(imageData);
          if (Array.isArray(parsed)) {
            imageUrls = parsed;
          } else if (parsed.urls && Array.isArray(parsed.urls)) {
            imageUrls = parsed.urls;
          }
        } catch (e) {
          console.warn('è§£æå›¾ç‰‡JSONæ•°æ®å¤±è´¥:', e);
        }
      }

      if (imageUrls.length === 0) {
        imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
      }

      // åˆ é™¤æŒ‡å®šç´¢å¼•çš„å›¾ç‰‡
      if (index >= 0 && index < imageUrls.length) {
        imageUrls.splice(index, 1);

        // æ›´æ–°å­—æ®µå€¼
        imageField.value = imageUrls.join(',');

        // æ›´æ–°é¢„è§ˆ
        updateImagePreview();
      }
    } catch (error) {
      console.error('åˆ é™¤å›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯:', error);
    }
  }

  // ä¿å­˜é—®é¢˜ç‚¹
  function saveProblem() {
    // æ£€æŸ¥æƒé™
    if (!isSuperAdmin) {
      alert('æ‚¨æ²¡æœ‰æƒé™è¿›è¡Œæ­¤æ“ä½œï¼');
      return;
    }

    // æ£€æŸ¥é—®é¢˜ç‚¹å­—æ®µæ˜¯å¦ä¸ºç©º
    const problemValue = document.getElementById('editProblem').value;
    if (!problemValue || problemValue.trim() === '') {
      alert('é—®é¢˜ç‚¹å­—æ®µä¸èƒ½ä¸ºç©ºï¼Œè¯·å¡«å†™é—®é¢˜æè¿°ï¼');
      document.getElementById('editProblem').focus();
      return;
    }

    const formData = new FormData(document.getElementById('editProblemForm'));
    const problemData = Object.fromEntries(formData.entries());
    problemData.id = document.getElementById('editProblemId').value;
    problemData.modifier = currentUser;

    showLoading();

    fetch('/problemLibrary/updateProblem', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(problemData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('ä¿å­˜æˆåŠŸ');
                closeModal();
                loadProblemData();
              } else {
                alert('ä¿å­˜å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('ä¿å­˜æ—¶å‘ç”Ÿé”™è¯¯');
            })
            .finally(() => {
              hideLoading();
            });
  }

  // æ¸²æŸ“è¡¨æ ¼
  function renderTable() {
    const tbody = document.getElementById('reviewTableBody');
    tbody.innerHTML = '';

    // ç›´æ¥ä½¿ç”¨allDataï¼Œå› ä¸ºæœåŠ¡å™¨ç«¯å·²ç»å¤„ç†äº†åˆ†é¡µ
    const pageData = allData;

    pageData.forEach(review => {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td>
                        <input type="checkbox" class="table-row-checkbox" data-id="${review.id}" title="é€‰æ‹©æ­¤è¡Œ">
                    </td>
                    <td>${review.id || '-'}</td>
                    <td>${review.testDate || '-'}</td>
                    <td>${review.majorCode || '-'}</td>
                    <td>${review.minorCode || '-'}</td>
                    <td>${review.projectPhase || '-'}</td>
                    <td>${review.version || '-'}</td>
                    <td class="problem-desc" title="${review.problemProcess || ''}">${(review.problemProcess || '').substring(0, 20)}${(review.problemProcess || '').length > 20 ? '...' : ''}</td>
                    <td><span class="status-badge status-${review.problemLevel?.toLowerCase() || ''}">${review.problemLevel || '-'}</span></td>
                    <td class="problem-desc" title="${review.developmentMethod || ''}">${(review.developmentMethod || '').substring(0, 20)}${(review.developmentMethod || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.supplier || ''}">${(review.supplier || '').substring(0, 20)}${(review.supplier || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.solutionProvider || ''}">${(review.solutionProvider || '').substring(0, 20)}${(review.solutionProvider || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.problemPoint || ''}">${(review.problemPoint || '').substring(0, 30)}${(review.problemPoint || '').length > 30 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.problemReason || ''}">${(review.problemReason || '').substring(0, 30)}${(review.problemReason || '').length > 30 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.improvementMeasures || ''}">${(review.improvementMeasures || '').substring(0, 30)}${(review.improvementMeasures || '').length > 30 ? '...' : ''}</td>
                    <td>${review.isPreventable || '-'}</td>
                    <td>${review.responsibleDepartment || '-'}</td>
                    <td><span class="status-badge status-${review.problemStatus?.toLowerCase().replace(' ', '') || ''}">${review.problemStatus || '-'}</span></td>
                    <td>${review.plannedCompletionTime || '-'}</td>
                    <td>${review.actualCompletionTime || '-'}</td>
                    <td>${review.delayDays || '-'}</td>
                    <td class="problem-desc" title="${review.problemTag1 || ''}">${(review.problemTag1 || '').substring(0, 20)}${(review.problemTag1 || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.problemTag2 || ''}">${(review.problemTag2 || '').substring(0, 20)}${(review.problemTag2 || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.preventionNotes || ''}">${(review.preventionNotes || '').substring(0, 30)}${(review.preventionNotes || '').length > 30 ? '...' : ''}</td>
                    <td>${review.createdTime ? new Date(review.createdTime).toLocaleString('zh-CN') : '-'}</td>
                    <td>${review.updatedTime ? new Date(review.updatedTime).toLocaleString('zh-CN') : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showReviewDetail(${review.id})" title="æŸ¥çœ‹è¯¦æƒ…">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
      tbody.appendChild(row);
    });

    // ä¸ºæ¯ä¸ªå¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    const checkboxes = tbody.querySelectorAll('.table-row-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', handleTableRowCheckboxChange);
    });

    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    updateAddToCartButtonText();

    updatePagination();
  }

  // æ›´æ–°åˆ†é¡µä¿¡æ¯
  function updatePagination() {
    console.log('updatePagination - totalCount:', totalCount, 'totalPages:', totalPages, 'currentPage:', currentPage, 'pageSize:', pageSize);

    // ä½¿ç”¨æœåŠ¡å™¨ç«¯è¿”å›çš„æ€»é¡µæ•°ï¼Œä¸å†é‡æ–°è®¡ç®—
    const startRecord = totalCount > 0 ? (currentPage - 1) * pageSize + 1 : 0;
    const endRecord = Math.min(currentPage * pageSize, totalCount);

    // ç¡®ä¿å½“å‰é¡µä¸è¶…è¿‡æ€»é¡µæ•°
    if (currentPage > totalPages && totalPages > 0) {
      currentPage = totalPages;
    }

    document.getElementById('startRecord').textContent = startRecord;
    document.getElementById('endRecord').textContent = endRecord;
    document.getElementById('totalRecords').textContent = totalCount;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.getElementById('firstPageBtn').disabled = currentPage === 1 || totalPages === 0;
    document.getElementById('prevPageBtn').disabled = currentPage === 1 || totalPages === 0;
    document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
    document.getElementById('lastPageBtn').disabled = currentPage === totalPages || totalPages === 0;

    // ç”Ÿæˆé¡µç æŒ‰é’®
    generatePageNumbers(totalPages);

    // æ›´æ–°è·³è½¬è¾“å…¥æ¡†çš„æœ€å¤§å€¼
    document.getElementById('pageJumpInput').max = totalPages;

    // è°ƒè¯•ä¿¡æ¯
    // console.log(`åˆ†é¡µä¿¡æ¯: æ€»è®°å½•æ•°=${totalCount}, æ€»é¡µæ•°=${totalPages}, å½“å‰é¡µ=${currentPage}, æ¯é¡µ=${pageSize}`);
  }

  // åˆ‡æ¢é¡µé¢
  function changePage(direction) {
    const totalPages = Math.ceil(totalCount / pageSize);
    const newPage = currentPage + direction;

    if (newPage >= 1 && newPage <= totalPages) {
      currentPage = newPage;
      loadReviewData(); // é‡æ–°åŠ è½½æ•°æ®
    }
  }

  // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
  function goToPage(page) {
    const totalPages = Math.ceil(totalCount / pageSize);
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      loadReviewData(); // é‡æ–°åŠ è½½æ•°æ®
    }
  }

  // è·³è½¬åˆ°æœ€åä¸€é¡µ
  function goToLastPage() {
    const totalPages = Math.ceil(totalCount / pageSize);
    if (totalPages > 0) {
      currentPage = totalPages;
      loadReviewData(); // é‡æ–°åŠ è½½æ•°æ®
    }
  }

  // é¡µç è·³è½¬
  function jumpToPage() {
    const input = document.getElementById('pageJumpInput');
    const page = parseInt(input.value);
    const totalPages = Math.ceil(totalCount / pageSize);

    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      loadReviewData(); // é‡æ–°åŠ è½½æ•°æ®
      input.value = '';
    } else {
      alert(`è¯·è¾“å…¥1åˆ°${totalPages}ä¹‹é—´çš„é¡µç `);
      input.value = '';
    }
  }

  // ç”Ÿæˆé¡µç æŒ‰é’®
  function generatePageNumbers(totalPages) {
    console.log('generatePageNumbers - totalPages:', totalPages, 'currentPage:', currentPage);

    const pageNumbersContainer = document.getElementById('pageNumbers');
    pageNumbersContainer.innerHTML = '';

    // å³ä½¿åªæœ‰ä¸€é¡µä¹Ÿæ˜¾ç¤ºé¡µç 
    if (totalPages <= 0) {
      console.log('totalPages <= 0, ä¸ç”Ÿæˆé¡µç æŒ‰é’®');
      return;
    }

    if (totalPages === 1) {
      const pageBtn = document.createElement('button');
      pageBtn.textContent = '1';
      pageBtn.className = 'btn btn-sm page-number active';
      pageBtn.onclick = () => goToPage(1);
      pageNumbersContainer.appendChild(pageBtn);
      return;
    }

    const maxVisiblePages = 5; // æœ€å¤šæ˜¾ç¤º5ä¸ªé¡µç æŒ‰é’®
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    // è°ƒæ•´èµ·å§‹é¡µç 
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // æ·»åŠ çœç•¥å·
    if (startPage > 1) {
      const firstBtn = document.createElement('button');
      firstBtn.textContent = '1';
      firstBtn.className = 'btn btn-sm page-number';
      firstBtn.onclick = () => goToPage(1);
      pageNumbersContainer.appendChild(firstBtn);

      if (startPage > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.className = 'page-ellipsis';
        pageNumbersContainer.appendChild(ellipsis);
      }
    }

    // æ·»åŠ é¡µç æŒ‰é’®
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.textContent = i;
      pageBtn.className = `btn btn-sm page-number ${i === currentPage ? 'active' : ''}`;
      pageBtn.onclick = () => goToPage(i);
      pageNumbersContainer.appendChild(pageBtn);
    }

    // æ·»åŠ çœç•¥å·
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.className = 'page-ellipsis';
        pageNumbersContainer.appendChild(ellipsis);
      }

      const lastBtn = document.createElement('button');
      lastBtn.textContent = totalPages;
      lastBtn.className = 'btn btn-sm page-number';
      lastBtn.onclick = () => goToPage(totalPages);
      pageNumbersContainer.appendChild(lastBtn);
    }
  }


  // åº”ç”¨ç­›é€‰æ¡ä»¶
  function applyFilters() {
    // æ‰§è¡Œæœç´¢ä»¥åº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶
    searchProblems();
  }


  // åˆ·æ–°å•ä¸ªé€‰é¡¹ï¼ˆå¤§ç±»æˆ–å°ç±»ï¼‰
  function refreshSingleSpeciesOptions(speciesType) {
    // ç›´æ¥ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®ï¼Œä¸ä½¿ç”¨ç¼“å­˜
    fetchSpeciesOptionsFromServer(speciesType);
  }

  // å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
  function forceRefreshSpeciesOptions(speciesType) {
    // æ¸…é™¤ç¼“å­˜
    clearSpeciesCache();
    // ä»æœåŠ¡å™¨è·å–
    fetchSpeciesOptionsFromServer(speciesType);
  }


  // ä»æœåŠ¡å™¨è·å–é€‰é¡¹
  function fetchSpeciesOptionsFromServer(speciesType) {
    showLoading();

    fetch('/problemLibrary/getSpeciesOptions', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                console.log('æœåŠ¡å™¨è¿”å›çš„åŸå§‹æ•°æ®:', data.data);


                // æ›´æ–°ç¼“å­˜ï¼ˆåŒæ—¶æ›´æ–°æ‰€æœ‰é€‰é¡¹ï¼Œå› ä¸ºæœåŠ¡å™¨è¿”å›çš„æ˜¯å®Œæ•´æ•°æ®ï¼‰
                setCachedSpeciesOptions('bigSpecies', data.data.bigSpecies);
                setCachedSpeciesOptions('smallSpecies', data.data.smallSpecies);
                setCachedSpeciesOptions('sampleStage', data.data.sampleStage);
                setCachedSpeciesOptions('fullModel', data.data.fullModel);
                setCachedSpeciesOptions('version', data.data.version);
                setCachedSpeciesOptions('problemCategory', data.data.problemCategory);
                setCachedSpeciesOptions('tester', data.data.tester);
                setCachedSpeciesOptions('responsibleDepartment', data.data.responsibleDepartment);
                setCachedSpeciesOptions('testPlatform', data.data.testPlatform);
                setCachedSpeciesOptions('testDevice', data.data.testDevice);
                setCachedSpeciesOptions('dqe', data.data.dqe);

                // æ›´æ–°å¯¹åº”çš„ä¸‹æ‹‰æ¡†
                if (speciesType === 'bigSpecies') {
                  updateSelectOptions('bigSpeciesFilter', data.data.bigSpecies);
                  showToast('å¤§ç±»é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'smallSpecies') {
                  updateSelectOptions('smallSpeciesFilter', data.data.smallSpecies);
                  showToast('å°ç±»é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'sampleStage') {
                  updateSelectOptions('sampleStageFilter', data.data.sampleStage);
                  showToast('æ ·å“é˜¶æ®µé€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'fullModel') {
                  updateSelectOptions('fullModelFilter', data.data.fullModel);
                  showToast('å®Œæ•´ç¼–ç é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'version') {
                  updateSelectOptions('versionFilter', data.data.version);
                  showToast('ç‰ˆæœ¬é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'problemCategory') {
                  // é‡æ–°åˆå§‹åŒ–ä¸‰çº§é—®é¢˜ç±»åˆ«ç­›é€‰å™¨
                  // è®¾ç½®æ•°æ®åº“æŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€
                  showToast('é—®é¢˜ç±»åˆ«é€‰é¡¹å·²ä»æ•°æ®åº“åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'tester') {
                  updateSelectOptions('testerFilter', data.data.tester);
                  showToast('æµ‹è¯•äººå‘˜é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'responsibleDepartment') {
                  updateSelectOptions('responsibleDepartmentFilter', data.data.responsibleDepartment);
                  showToast('è´£ä»»éƒ¨é—¨é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'testPlatform') {
                  updateSelectOptions('testPlatformFilter', data.data.testPlatform);
                  showToast('æµ‹è¯•å¹³å°é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'testDevice') {
                  updateSelectOptions('testDeviceFilter', data.data.testDevice);
                  showToast('æ˜¾ç¤ºè®¾å¤‡é€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                } else if (speciesType === 'dqe') {
                  updateSelectOptions('dqeFilter', data.data.dqe);
                  showToast('DQEè´Ÿè´£äººé€‰é¡¹å·²åˆ·æ–°å¹¶ç¼“å­˜', 'success');
                }
              } else {
                showToast('åˆ·æ–°å¤±è´¥: ' + data.message, 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showToast('åˆ·æ–°æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            })
            .finally(() => {
              hideLoading();
            });
  }

  // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰é¡¹
  function updateSelectOptions(selectId, options) {
    const select = document.getElementById(selectId);
    if (!select) return;

    // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
    const currentValue = select.value;

    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨"é€‰é¡¹ï¼‰
    select.innerHTML = '<option value="">å…¨éƒ¨</option>';

    // æ·»åŠ æ–°é€‰é¡¹
    if (options && options.length > 0) {
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        // å¦‚æœé€‰é¡¹ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œæ˜¾ç¤ºä¸º"ç©ºå€¼"
        optionElement.textContent = option === '' ? 'ç©ºå€¼' : option;
        select.appendChild(optionElement);
      });
    }

    // å°è¯•æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
    if (currentValue && Array.from(select.options).some(option => option.value === currentValue)) {
      select.value = currentValue;
    }
  }



  // è¿›å…¥ç¼–è¾‘æ¨¡å¼
  function enterEditMode() {
    // æ£€æŸ¥æƒé™
    if (!isSuperAdmin) {
      alert('æ‚¨æ²¡æœ‰æƒé™è¿›è¡Œæ­¤æ“ä½œï¼');
      return;
    }

    // æ‰€æœ‰å¯ç¼–è¾‘å­—æ®µï¼ˆé™¤äº†æäº¤æ—¶é—´ï¼‰
    const editableFields = [
      'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
      'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
      'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
      'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
      'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
      'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
      'detailGreenUnionDqe', 'detailGreenUnionRd',
      'detailComparisonWithPrevious', 'detailPostImprovementRisk',
      'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
    ];

    editableFields.forEach(fieldId => {
      const displayElement = document.getElementById(fieldId);
      const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

      if (displayElement && inputElement) {
        displayElement.style.display = 'none';
        inputElement.style.display = 'block';
      }
    });

    // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
    document.getElementById('editProblemBtn').style.display = 'none';
    document.getElementById('saveDetailBtn').style.display = 'inline-flex';
    document.getElementById('cancelEditBtn').style.display = 'inline-flex';
  }

  // é€€å‡ºç¼–è¾‘æ¨¡å¼
  function exitEditMode() {
    // æ‰€æœ‰å¯ç¼–è¾‘å­—æ®µï¼ˆé™¤äº†æäº¤æ—¶é—´ï¼‰
    const editableFields = [
      'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
      'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
      'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
      'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
      'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
      'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
      'detailGreenUnionDqe', 'detailGreenUnionRd',
      'detailComparisonWithPrevious', 'detailPostImprovementRisk',
      'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
    ];

    editableFields.forEach(fieldId => {
      const displayElement = document.getElementById(fieldId);
      const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

      if (displayElement && inputElement) {
        displayElement.style.display = 'block';
        inputElement.style.display = 'none';
      }
    });

    // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
    document.getElementById('editProblemBtn').style.display = 'inline-flex';
    document.getElementById('saveDetailBtn').style.display = 'none';
    document.getElementById('cancelEditBtn').style.display = 'none';
  }

  // ä¿å­˜è¯¦æƒ…ä¿®æ”¹
  function saveDetailChanges() {
    // æ£€æŸ¥æƒé™
    if (!isSuperAdmin) {
      alert('æ‚¨æ²¡æœ‰æƒé™è¿›è¡Œæ­¤æ“ä½œï¼');
      return;
    }

    // æ£€æŸ¥é—®é¢˜ç‚¹å­—æ®µæ˜¯å¦ä¸ºç©º
    const problemValue = document.getElementById('editDetailProblem').value;
    if (!problemValue || problemValue.trim() === '') {
      alert('é—®é¢˜ç‚¹å­—æ®µä¸èƒ½ä¸ºç©ºï¼Œè¯·å¡«å†™é—®é¢˜æè¿°ï¼');
      document.getElementById('editDetailProblem').focus();
      return;
    }

    // æ”¶é›†ä¿®æ”¹çš„æ•°æ® - åªä¼ é€’å¿…è¦çš„å­—æ®µ
    const problemData = {
      id: document.getElementById('editProblemId').value,
      modifier: currentUser
    };

    // åªæ·»åŠ æœ‰å€¼çš„å­—æ®µ
    const fields = [
      { key: 'full_model', element: 'editDetailFullModel' },
      { key: 'big_species', element: 'editDetailBigSpecies' },
      { key: 'small_species', element: 'editDetailSmallSpecies' },
      { key: 'sample_stage', element: 'editDetailSampleStage' },
      { key: 'version', element: 'editDetailVersion' },
      { key: 'chip_solution', element: 'editDetailChipSolution' },
      { key: 'test_platform', element: 'editDetailTestPlatform' },
      { key: 'test_device', element: 'editDetailTestDevice' },
      { key: 'other_device', element: 'editDetailOtherDevice' },
      { key: 'problem', element: 'editDetailProblem' },
      { key: 'problemCategory', element: 'editDetailProblemCategory' },
      { key: 'defect_level', element: 'editDetailDefectLevel' },
      { key: 'current_status', element: 'editDetailCurrentStatus' },
      { key: 'reproduction_method', element: 'editDetailReproductionMethod' },
      { key: 'recovery_method', element: 'editDetailRecoveryMethod' },
      { key: 'reproduction_probability', element: 'editDetailReproductionProbability' },
      { key: 'tester', element: 'editDetailTester' },
      { key: 'responsibleDepartment', element: 'editDetailResponsibleDepartment' },
      { key: 'responsible_person', element: 'editDetailResponsiblePerson' },
      { key: 'dqe_confirm', element: 'editDetailDqeConfirm' },
      { key: 'rd_confirm', element: 'editDetailRdConfirm' },
      { key: 'improvement_plan', element: 'editDetailImprovementPlan' },
      { key: 'green_union_dqe', element: 'editDetailGreenUnionDqe' },
      { key: 'green_union_rd', element: 'editDetailGreenUnionRd' },
      { key: 'comparison_with_previous', element: 'editDetailComparisonWithPrevious' },
      { key: 'post_improvement_risk', element: 'editDetailPostImprovementRisk' },
      { key: 'next_version_regression_test', element: 'editDetailNextVersionRegressionTest' },
      { key: 'remark', element: 'editDetailRemark' },
      { key: 'test_Overseas', element: 'editDetailTestOverseas' }
    ];

    fields.forEach(field => {
      const element = document.getElementById(field.element);
      if (element && element.value !== '') {
        problemData[field.key] = element.value;
      }
    });

    showLoading();

    fetch('/problemLibrary/updateProblem', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(problemData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('ä¿å­˜æˆåŠŸ');
                exitEditMode();
                loadProblemData(); // é‡æ–°åŠ è½½è¡¨æ ¼æ•°æ®

                // é‡æ–°è·å–å¹¶æ˜¾ç¤ºæ›´æ–°åçš„é—®é¢˜ç‚¹è¯¦æƒ…
                const problemId = document.getElementById('editProblemId').value;
                fetch(`/problemLibrary/getProblemById?id=${problemId}`)
                        .then(response => response.json())
                        .then(result => {
                          if (result.success && result.data) {
                            displayProblemDetail(result.data);
                          }
                        })
                        .catch(error => {
                          console.error('è·å–æ›´æ–°åæ•°æ®å¤±è´¥:', error);
                        });
              } else {
                alert('ä¿å­˜å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('ä¿å­˜æ—¶å‘ç”Ÿé”™è¯¯');
            })
            .finally(() => {
              hideLoading();
            });
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
  }

  // éšè—åŠ è½½çŠ¶æ€
  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  // æ˜¾ç¤ºè‡ªå®šä¹‰æç¤ºæ¡†
  function showToast(message, type = 'success', duration = 3000) {
    const toast = document.getElementById('customToast');
    const messageEl = document.getElementById('toastMessage');
    const iconEl = toast.querySelector('.toast-icon i');

    // è®¾ç½®æ¶ˆæ¯å†…å®¹
    messageEl.textContent = message;

    // è®¾ç½®å›¾æ ‡å’Œæ ·å¼
    toast.className = 'custom-toast ' + type;
    switch(type) {
      case 'success':
        iconEl.className = 'fas fa-check-circle';
        break;
      case 'error':
        iconEl.className = 'fas fa-exclamation-circle';
        break;
      case 'warning':
        iconEl.className = 'fas fa-exclamation-triangle';
        break;
      case 'info':
        iconEl.className = 'fas fa-info-circle';
        break;
    }

    // æ˜¾ç¤ºæç¤ºæ¡†
    toast.classList.add('show');

    // è‡ªåŠ¨éšè—
    if (duration > 0) {
      setTimeout(() => {
        hideToast();
      }, duration);
    }
  }

  // éšè—è‡ªå®šä¹‰æç¤ºæ¡†
  function hideToast() {
    const toast = document.getElementById('customToast');
    toast.classList.remove('show');
  }

  // å…³é—­æ¨¡æ€æ¡†
  function closeModal() {
    // è·å–æ‰€æœ‰å¯è§çš„æ¨¡æ€æ¡†ï¼ŒæŒ‰z-indexæ’åº
    const visibleModals = Array.from(document.querySelectorAll('.modal'))
            .filter(modal => modal.style.display === 'block')
            .sort((a, b) => {
              const aZIndex = parseInt(window.getComputedStyle(a).zIndex) || 0;
              const bZIndex = parseInt(window.getComputedStyle(b).zIndex) || 0;
              return bZIndex - aZIndex; // é™åºæ’åˆ—ï¼Œz-indexé«˜çš„åœ¨å‰
            });

    if (visibleModals.length > 0) {
      // åªå…³é—­æœ€é¡¶å±‚çš„æ¨¡æ€æ¡†
      visibleModals[0].style.display = 'none';
    }
  }

  // å…³é—­æŒ‡å®šæ¨¡æ€æ¡†
  function closeSpecificModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  }

  // è¿”å›ä¸Šä¸€é¡µ
  function goBack() {
    window.history.back();
  }

  // è¿”å›ä¸»é¡µ
  function goHome() {
    window.location.href = '/DQEIndex';
  }

  // æ˜¾ç¤ºå†å²ç‰ˆæœ¬
  function showHistoryVersions(sampleId) {
    showLoading();

    fetch(`/problemLibrary/getHistoryVersions?sampleId=${sampleId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                renderHistoryVersions(data.data);
                document.getElementById('historyVersionsModal').style.display = 'block';
              } else {
                alert('è·å–å†å²ç‰ˆæœ¬å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('è·å–å†å²ç‰ˆæœ¬æ—¶å‘ç”Ÿé”™è¯¯');
            })
            .finally(() => {
              hideLoading();
            });
  }

  // æ¸²æŸ“å†å²ç‰ˆæœ¬è¡¨æ ¼
  function renderHistoryVersions(historyVersions) {
    const tbody = document.getElementById('historyVersionsTableBody');
    tbody.innerHTML = '';

    if (!historyVersions || historyVersions.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td colspan="6" style="text-align: center;">æš‚æ— å†å²ç‰ˆæœ¬</td>
                `;
      tbody.appendChild(row);
      return;
    }

    historyVersions.forEach(version => {
      const row = document.createElement('tr');
      const isLatest = version.history_id === Math.max(...historyVersions.map(v => v.history_id));
      const latestBadge = isLatest ? '<span class="badge badge-primary">æœ€æ–°</span>' : '';

      row.innerHTML = `
                    <td>${version.history_id} ${latestBadge}</td>
                    <td class="problem-desc">${(version.problem || '').substring(0, 50)}${(version.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${normalizeStatus(version.current_status)}</td>
                    <td>${version.modifier || version.tester || ''}</td>
                    <td>${version.modify_at ? new Date(version.modify_at).toLocaleString('zh-CN') : (version.created_at ? new Date(version.created_at).toLocaleString('zh-CN') : '')}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showProblemDetail(${version.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                    </td>
                `;
      tbody.appendChild(row);
    });
  }

  // ==================== è´­ç‰©è½¦/æ”¶è—å¤¹åŠŸèƒ½ ====================

  // å…¨é€‰/å–æ¶ˆå…¨é€‰è¡¨æ ¼è¡Œ
  function toggleSelectAllTableRows() {
    const selectAllCheckbox = document.getElementById('selectAllTableRows');
    const rowCheckboxes = document.querySelectorAll('.table-row-checkbox');

    rowCheckboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });

    // æ›´æ–°åŠ å…¥æ”¶è—å¤¹æŒ‰é’®çš„æ–‡æœ¬
    updateAddToCartButtonText();
  }

  // è·å–é€‰ä¸­çš„è¡¨æ ¼è¡Œ
  function getSelectedTableRows() {
    const selectedCheckboxes = document.querySelectorAll('.table-row-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
    return allData.filter(item => selectedIds.includes(item.id));
  }

  // æ›´æ–°åŠ å…¥æ”¶è—å¤¹æŒ‰é’®æ–‡æœ¬
  function updateAddToCartButtonText() {
    const selectedCount = document.querySelectorAll('.table-row-checkbox:checked').length;
    const addToCartBtn = document.getElementById('addToCartBtn');

    if (selectedCount > 0) {
      addToCartBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> åŠ å…¥æ”¶è—å¤¹ (${selectedCount})`;
    } else {
      addToCartBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> åŠ å…¥æ”¶è—å¤¹`;
    }
  }

  // æ¸…ç©ºè¡¨æ ¼é€‰æ‹©
  function clearTableSelection() {
    const selectAllCheckbox = document.getElementById('selectAllTableRows');
    const rowCheckboxes = document.querySelectorAll('.table-row-checkbox');

    selectAllCheckbox.checked = false;
    rowCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
    });

    updateAddToCartButtonText();
  }

  // ç›‘å¬å•ä¸ªå¤é€‰æ¡†å˜åŒ–
  function handleTableRowCheckboxChange() {
    const selectAllCheckbox = document.getElementById('selectAllTableRows');
    const rowCheckboxes = document.querySelectorAll('.table-row-checkbox');
    const checkedCount = document.querySelectorAll('.table-row-checkbox:checked').length;

    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    if (checkedCount === 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === rowCheckboxes.length) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    }

    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    updateAddToCartButtonText();
  }

  // åŠ å…¥æ”¶è—å¤¹
  function addToCart() {
    // è·å–é€‰ä¸­çš„è¡Œ
    const selectedRows = getSelectedTableRows();

    if (selectedRows.length === 0) {
      alert('è¯·å…ˆé€‰æ‹©è¦åŠ å…¥æ”¶è—å¤¹çš„æ•°æ®è¡Œï¼');
      return;
    }

    // è·å–å½“å‰ç­›é€‰æ¡ä»¶
    const filters = getCurrentFilters();
    const filterDescription = generateFilterDescription(filters);

    // åˆ›å»ºæ”¶è—å¤¹é¡¹ç›®
    const cartItem = {
      id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
      filters: filters,
      data: [...selectedRows], // åªæ·»åŠ é€‰ä¸­çš„è¡Œ
      dataCount: selectedRows.length,
      filterDescription: filterDescription,
      saveTime: new Date().toLocaleString('zh-CN'),
      user: currentUser
    };

    // æ·»åŠ åˆ°æ”¶è—å¤¹
    cartItems.push(cartItem);

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    saveCartToStorage();

    // æ›´æ–°æ”¶è—å¤¹è®¡æ•°
    updateCartCount();

    // æ¸…ç©ºé€‰æ‹©
    clearTableSelection();

    alert(`å·²æˆåŠŸå°† ${selectedRows.length} æ¡æ•°æ®åŠ å…¥æ”¶è—å¤¹ï¼`);
  }

  // è·å–å½“å‰ç­›é€‰æ¡ä»¶
  function getCurrentFilters() {
    return {
      majorCode: document.getElementById('majorCodeFilter').value,
      minorCode: document.getElementById('minorCodeFilter').value,
      projectPhase: document.getElementById('projectPhaseFilter').value,
      version: document.getElementById('versionFilter').value,
      supplier: document.getElementById('supplierFilter').value,
      testStartDate: document.getElementById('testStartDateFilter').value,
      testEndDate: document.getElementById('testEndDateFilter').value
    };
  }

  // ç”Ÿæˆç­›é€‰æ¡ä»¶æè¿°
  function generateFilterDescription(filters) {
    const descriptions = [];

    if (filters.majorCode) descriptions.push(`å¤§ç¼–ç : ${filters.majorCode}`);
    if (filters.minorCode) descriptions.push(`å°ç¼–ç : ${filters.minorCode}`);
    if (filters.projectPhase) descriptions.push(`é¡¹ç›®é˜¶æ®µ: ${filters.projectPhase}`);
    if (filters.version) descriptions.push(`ç‰ˆæœ¬: ${filters.version}`);
    if (filters.supplier) descriptions.push(`ä¾›åº”å•†: ${filters.supplier}`);
    if (filters.testStartDate) descriptions.push(`æµ‹è¯•å¼€å§‹: ${filters.testStartDate}`);
    if (filters.testEndDate) descriptions.push(`æµ‹è¯•ç»“æŸ: ${filters.testEndDate}`);

    return descriptions.length > 0 ? descriptions.join(', ') : 'æ— æ¡ä»¶ç­›é€‰';
  }

  // æ˜¾ç¤ºæ”¶è—å¤¹æ¨¡æ€æ¡†
  function showCartModal() {
    renderCartItems();
    document.getElementById('cartModal').style.display = 'block';
  }

  // æ¸²æŸ“æ”¶è—å¤¹é¡¹ç›®
  function renderCartItems() {
    const tbody = document.getElementById('cartItemsTableBody');
    tbody.innerHTML = '';

    if (cartItems.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #666;">æ”¶è—å¤¹ä¸ºç©º</td>
                `;
      tbody.appendChild(row);
      return;
    }

    cartItems.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td>
                        <input type="checkbox" class="cart-item-checkbox" data-item-id="${item.id}" onchange="updateSelectAllStatus()">
                    </td>
                    <td>${index + 1}</td>
                    <td class="filter-desc" title="${item.filterDescription}">${item.filterDescription.length > 50 ? item.filterDescription.substring(0, 50) + '...' : item.filterDescription}</td>
                    <td>${item.dataCount}</td>
                    <td>${item.saveTime}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeCartItem(${item.id})">åˆ é™¤</button>
                    </td>
                `;
      tbody.appendChild(row);
    });
  }

  // å…¨é€‰/å–æ¶ˆå…¨é€‰æ”¶è—å¤¹é¡¹ç›®
  function toggleSelectAllCartItems() {
    const selectAllCheckbox = document.getElementById('selectAllCartItems');
    const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');

    itemCheckboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
  }

  // æ›´æ–°å…¨é€‰çŠ¶æ€
  function updateSelectAllStatus() {
    const selectAllCheckbox = document.getElementById('selectAllCartItems');
    const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');
    const checkedCount = document.querySelectorAll('.cart-item-checkbox:checked').length;

    if (checkedCount === 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === itemCheckboxes.length) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    }
  }

  // è·å–é€‰ä¸­çš„æ”¶è—å¤¹é¡¹ç›®
  function getSelectedCartItems() {
    const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
    const selectedItemIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.itemId));
    return cartItems.filter(item => selectedItemIds.includes(item.id));
  }

  // æ”¶è—å¤¹ç®¡ç†æ¨¡æ€æ¡†çš„ æŸ¥çœ‹æ”¶è—å¤¹é¡¹ç›®
  function viewCartItem(itemId) {
    const item = cartItems.find(i => i.id === itemId);
    if (!item) return;

    // æ˜¾ç¤ºæ”¶è—å¤¹è¯¦æƒ…æ¨¡æ€æ¡†
    showCartDetailModal(item);
  }

  // æ˜¾ç¤ºæ”¶è—å¤¹è¯¦æƒ…æ¨¡æ€æ¡†
  function showCartDetailModal(item) {
    // è®¾ç½®åŸºæœ¬ä¿¡æ¯
    document.getElementById('cartDetailFilter').textContent = item.filterDescription;
    document.getElementById('cartDetailCount').textContent = item.dataCount;
    document.getElementById('cartDetailTime').textContent = item.saveTime;

    // æ¸²æŸ“è¯¦æƒ…è¡¨æ ¼
    renderCartDetailTable(item.data);

    // ä¿å­˜å½“å‰æŸ¥çœ‹çš„æ”¶è—å¤¹é¡¹ç›®ï¼Œç”¨äºé‡æ–°æœç´¢
    window.currentCartItem = item;

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('cartDetailModal').style.display = 'block';
  }

  // åº”ç”¨æ”¶è—å¤¹ä¸­çš„ç­›é€‰æ¡ä»¶é‡æ–°æœç´¢
  function applyCartFilters() {
    if (!window.currentCartItem) {
      alert('æ²¡æœ‰å¯åº”ç”¨çš„ç­›é€‰æ¡ä»¶ï¼');
      return;
    }

    const filters = window.currentCartItem.filters;

    // æ¸…ç©ºæ‰€æœ‰ç­›é€‰æ¡ä»¶
    resetFilters();

    // åº”ç”¨æ”¶è—å¤¹ä¸­çš„ç­›é€‰æ¡ä»¶
    if (filters.majorCode) document.getElementById('majorCodeFilter').value = filters.majorCode;
    if (filters.minorCode) document.getElementById('minorCodeFilter').value = filters.minorCode;
    if (filters.projectPhase) document.getElementById('projectPhaseFilter').value = filters.projectPhase;
    if (filters.version) document.getElementById('versionFilter').value = filters.version;
    if (filters.supplier) document.getElementById('supplierFilter').value = filters.supplier;
    if (filters.testStartDate) document.getElementById('testStartDateFilter').value = filters.testStartDate;
    if (filters.testEndDate) document.getElementById('testEndDateFilter').value = filters.testEndDate;

    // å…³é—­æ”¶è—å¤¹è¯¦æƒ…æ¨¡æ€æ¡†
    closeSpecificModal('cartDetailModal');

    // å…³é—­æ”¶è—å¤¹æ¨¡æ€æ¡†
    closeSpecificModal('cartModal');

    // æ‰§è¡Œæœç´¢
    searchReviews();

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    showToast('å·²åº”ç”¨æ”¶è—å¤¹ä¸­çš„ç­›é€‰æ¡ä»¶å¹¶é‡æ–°æœç´¢', 'success');
  }

  // æ¸²æŸ“æ”¶è—å¤¹è¯¦æƒ…è¡¨æ ¼
  function renderCartDetailTable(data) {
    const tbody = document.getElementById('cartDetailTableBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td colspan="19" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td>
                `;
      tbody.appendChild(row);
      return;
    }

    data.forEach(problem => {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td>${problem.id || ''}</td>
                    <td>${problem.full_model || ''}</td>
                    <td>${problem.big_species || ''}</td>
                    <td>${problem.small_species || ''}</td>
                    <td>${problem.sample_stage || ''}</td>
                    <td>${problem.version || ''}</td>
                    <td>${problem.test_platform || ''}</td>
                    <td>${problem.test_device || ''}</td>
                    <td>${problem.other_device || ''}</td>
                    <td class="problem-desc" title="${problem.problem || ''}">${problem.problem || ''}</td>
                    <td>${problem.problemCategory || ''}</td>
                    <td>${problem.defect_level || ''}</td>
                    <td>${problem.current_status || ''}</td>
                    <td>${problem.tester || ''}</td>
                    <td>${problem.dqe || ''}</td>
                    <td>${problem.responsibleDepartment || ''}</td>
                    <td>${problem.green_union_dqe || ''}</td>
                    <td>${problem.green_union_rd || ''}</td>
                    <td>${problem.created_at || ''}</td>
                `;
      tbody.appendChild(row);
    });
  }

  // åˆ é™¤æ”¶è—å¤¹é¡¹ç›®
  function removeCartItem(itemId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶è—å¤¹é¡¹ç›®å—ï¼Ÿ')) {
      cartItems = cartItems.filter(i => i.id !== itemId);
      saveCartToStorage();
      updateCartCount();
      renderCartItems();
    }
  }

  // æ¸…ç©ºæ”¶è—å¤¹
  function clearCart() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ•´ä¸ªæ”¶è—å¤¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
      cartItems = [];
      mergedData = [];
      saveCartToStorage();
      updateCartCount();
      renderCartItems();
      hideMergedData();
      alert('æ”¶è—å¤¹å·²æ¸…ç©º');
    }
  }

  // åˆå¹¶æ”¶è—å¤¹æ•°æ®
  function mergeCartData() {
    const selectedItems = getSelectedCartItems();

    if (selectedItems.length === 0) {
      showToast('è¯·å…ˆé€‰æ‹©è¦åˆå¹¶çš„æ”¶è—å¤¹é¡¹ç›®ï¼', 'warning');
      return;
    }

    // console.log('é€‰ä¸­çš„æ”¶è—å¤¹é¡¹ç›®:', selectedItems);

    // åˆå¹¶é€‰ä¸­çš„æ”¶è—å¤¹é¡¹ç›®çš„æ•°æ®
    mergedData = [];
    const idSet = new Set(); // ç”¨äºå»é‡

    selectedItems.forEach(item => {
      // console.log(`å¤„ç†æ”¶è—å¤¹é¡¹ç›® ${item.id}:`, item.data.length, 'æ¡æ•°æ®');
      item.data.forEach(problem => {
        if (!idSet.has(problem.id)) {
          idSet.add(problem.id);
          mergedData.push(problem);
        }
      });
    });

    // console.log('åˆå¹¶åçš„æ•°æ®:', mergedData.length, 'æ¡');

    // æ˜¾ç¤ºåˆå¹¶æ•°æ®ï¼Œä¼ é€’é€‰ä¸­çš„é¡¹ç›®æ•°é‡
    showMergedData(selectedItems.length);
    showToast(`å·²åˆå¹¶ ${selectedItems.length} ä¸ªæ”¶è—å¤¹é¡¹ç›®ï¼Œå…± ${mergedData.length} æ¡æ•°æ®`, 'success');
  }

  // æ˜¾ç¤ºåˆå¹¶æ•°æ®
  function showMergedData(selectedCount = 0) {
    const section = document.getElementById('mergedDataSection');
    const totalCount = mergedData.length;
    const uniqueCount = mergedData.length; // å·²ç»å»é‡äº†

    // console.log('æ˜¾ç¤ºåˆå¹¶æ•°æ®:', {
    //     selectedCount: selectedCount,
    //     totalCount: totalCount,
    //     mergedDataLength: mergedData.length
    // });

    // å…ˆéšè—ï¼Œç„¶åæ˜¾ç¤ºï¼Œç¡®ä¿åˆ·æ–°
    section.style.display = 'none';

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œæ˜¾ç¤ºé€‰ä¸­çš„é¡¹ç›®æ•°é‡
    const statsElement = document.querySelector('.merged-stats');
    if (statsElement) {
      statsElement.innerHTML = `
                    <span>é€‰ä¸­é¡¹ç›®: <strong>${selectedCount}</strong></span>
                    <span>æ€»æ•°æ®é‡: <strong>${totalCount}</strong></span>
                    <span>å»é‡å: <strong>${uniqueCount}</strong></span>
                `;
    }

    // æ¸²æŸ“åˆå¹¶æ•°æ®è¡¨æ ¼
    renderMergedDataTable();

    // å¼ºåˆ¶é‡æ–°æ˜¾ç¤º
    setTimeout(() => {
      section.style.display = 'block';
    }, 10);
  }

  // éšè—åˆå¹¶æ•°æ®
  function hideMergedData() {
    document.getElementById('mergedDataSection').style.display = 'none';
  }

  // æ¸²æŸ“åˆå¹¶æ•°æ®è¡¨æ ¼
  function renderMergedDataTable() {
    const tbody = document.getElementById('mergedDataTableBody');
    tbody.innerHTML = '';

    // console.log('æ¸²æŸ“åˆå¹¶æ•°æ®è¡¨æ ¼ï¼Œæ•°æ®æ¡æ•°:', mergedData.length);

    if (mergedData.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td colspan="25" style="text-align: center; color: #666;">æ²¡æœ‰æ•°æ®</td>
                `;
      tbody.appendChild(row);
      return;
    }

    mergedData.forEach((review, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
                    <td>${review.id || '-'}</td>
                    <td>${review.testDate || '-'}</td>
                    <td>${review.majorCode || '-'}</td>
                    <td>${review.minorCode || '-'}</td>
                    <td>${review.projectPhase || '-'}</td>
                    <td>${review.version || '-'}</td>
                    <td class="problem-desc" title="${review.problemProcess || ''}">${(review.problemProcess || '').substring(0, 20)}${(review.problemProcess || '').length > 20 ? '...' : ''}</td>
                    <td><span class="status-badge status-${review.problemLevel?.toLowerCase() || ''}">${review.problemLevel || '-'}</span></td>
                    <td class="problem-desc" title="${review.developmentMethod || ''}">${(review.developmentMethod || '').substring(0, 20)}${(review.developmentMethod || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.supplier || ''}">${(review.supplier || '').substring(0, 20)}${(review.supplier || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.solutionProvider || ''}">${(review.solutionProvider || '').substring(0, 20)}${(review.solutionProvider || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.problemPoint || ''}">${(review.problemPoint || '').substring(0, 30)}${(review.problemPoint || '').length > 30 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.problemReason || ''}">${(review.problemReason || '').substring(0, 30)}${(review.problemReason || '').length > 30 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.improvementMeasures || ''}">${(review.improvementMeasures || '').substring(0, 30)}${(review.improvementMeasures || '').length > 30 ? '...' : ''}</td>
                    <td>${review.isPreventable || '-'}</td>
                    <td>${review.responsibleDepartment || '-'}</td>
                    <td><span class="status-badge status-${review.problemStatus?.toLowerCase().replace(' ', '') || ''}">${review.problemStatus || '-'}</span></td>
                    <td>${review.plannedCompletionTime || '-'}</td>
                    <td>${review.actualCompletionTime || '-'}</td>
                    <td>${review.delayDays || '-'}</td>
                    <td class="problem-desc" title="${review.problemTag1 || ''}">${(review.problemTag1 || '').substring(0, 20)}${(review.problemTag1 || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.problemTag2 || ''}">${(review.problemTag2 || '').substring(0, 20)}${(review.problemTag2 || '').length > 20 ? '...' : ''}</td>
                    <td class="problem-desc" title="${review.preventionNotes || ''}">${(review.preventionNotes || '').substring(0, 30)}${(review.preventionNotes || '').length > 30 ? '...' : ''}</td>
                    <td>${review.createdTime ? new Date(review.createdTime).toLocaleString('zh-CN') : '-'}</td>
                    <td>${review.updatedTime ? new Date(review.updatedTime).toLocaleString('zh-CN') : '-'}</td>
                `;
      tbody.appendChild(row);
    });

    // console.log('åˆå¹¶æ•°æ®è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼Œå®é™…æ¸²æŸ“è¡Œæ•°:', tbody.children.length);
  }

  // ==================== åˆå¹¶æ•°æ®å›¾è¡¨åŠŸèƒ½ ====================

  // ç”Ÿæˆé¢œè‰²æ•°ç»„
  function generateColors(count) {
    const colors = [
      'rgba(54, 162, 235, 0.6)',
      'rgba(255, 99, 132, 0.6)',
      'rgba(255, 205, 86, 0.6)',
      'rgba(75, 192, 192, 0.6)',
      'rgba(153, 102, 255, 0.6)',
      'rgba(255, 159, 64, 0.6)',
      'rgba(199, 199, 199, 0.6)',
      'rgba(83, 102, 255, 0.6)',
      'rgba(255, 99, 255, 0.6)',
      'rgba(99, 255, 132, 0.6)',
      'rgba(255, 132, 99, 0.6)',
      'rgba(132, 99, 255, 0.6)',
      'rgba(99, 255, 255, 0.6)',
      'rgba(255, 255, 99, 0.6)',
      'rgba(255, 99, 99, 0.6)'
    ];

    const result = [];
    for (let i = 0; i < count; i++) {
      result.push(colors[i % colors.length]);
    }
    return result;
  }

  // æ˜¾ç¤ºåˆå¹¶æ•°æ®å›¾è¡¨
  function showMergedChart() {
    const selectedItems = getSelectedCartItems();

    if (selectedItems.length === 0) {
      showToast('è¯·å…ˆé€‰æ‹©è¦åˆå¹¶çš„æ”¶è—å¤¹é¡¹ç›®ï¼', 'warning');
      return;
    }

    // åˆå¹¶é€‰ä¸­çš„æ”¶è—å¤¹é¡¹ç›®çš„æ•°æ®
    mergedData = [];
    const idSet = new Set(); // ç”¨äºå»é‡

    selectedItems.forEach(item => {
      item.data.forEach(problem => {
        if (!idSet.has(problem.id)) {
          idSet.add(problem.id);
          mergedData.push(problem);
        }
      });
    });

    if (mergedData.length === 0) {
      showToast('æ²¡æœ‰æ•°æ®å¯ä»¥ç»˜åˆ¶å›¾è¡¨ï¼', 'warning');
      return;
    }

    // æ˜¾ç¤ºåˆå¹¶æ•°æ®åŒºåŸŸ
    showMergedData(selectedItems.length);

    // æ˜¾ç¤ºå›¾è¡¨æ§åˆ¶åŒºåŸŸ
    const chartControls = document.querySelector('.merged-chart-controls');
    if (chartControls) {
      chartControls.style.display = 'block';
    }

    showToast(`å·²å‡†å¤‡ ${mergedData.length} æ¡æ•°æ®ç”¨äºå›¾è¡¨ç»˜åˆ¶`, 'success');
  }

  // åˆ‡æ¢åˆå¹¶æ•°æ®å›¾è¡¨ç±»å‹
  function switchMergedChartType(type) {
    mergedChartType = type;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const chartTypeButtons = document.querySelectorAll('.merged-chart-controls .chart-type-btn');
    chartTypeButtons.forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.type === type) {
        btn.classList.add('active');
      }
    });

    // å¦‚æœå·²ç»æœ‰å›¾è¡¨ï¼Œé‡æ–°ç”Ÿæˆ
    if (mergedChart && mergedData.length > 0) {
      const groupField = document.getElementById('mergedChartField').value;
      if (groupField) {
        generateMergedChart();
      }
    }
  }

  // ç”Ÿæˆåˆå¹¶æ•°æ®å›¾è¡¨
  function generateMergedChart() {
    const groupField = document.getElementById('mergedChartField').value;

    if (!groupField) {
      showToast('è¯·é€‰æ‹©åˆ†ç»„å­—æ®µï¼', 'warning');
      return;
    }

    if (mergedData.length === 0) {
      showToast('æ²¡æœ‰æ•°æ®å¯ä»¥ç»˜åˆ¶å›¾è¡¨ï¼', 'warning');
      return;
    }

    try {
      // å¤„ç†å›¾è¡¨æ•°æ®
      const chartData = processMergedChartData(mergedData, groupField, mergedChartType);

      // åˆ›å»ºå›¾è¡¨
      createMergedChart(chartData, mergedChartType);

      // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
      const chartContainer = document.getElementById('mergedChartContainer');
      if (chartContainer) {
        chartContainer.style.display = 'block';
      }

      showToast('å›¾è¡¨ç”ŸæˆæˆåŠŸï¼', 'success');
    } catch (error) {
      console.error('ç”Ÿæˆåˆå¹¶æ•°æ®å›¾è¡¨å¤±è´¥:', error);
      showToast('ç”Ÿæˆå›¾è¡¨å¤±è´¥: ' + error.message, 'error');
    }
  }

  // å¤„ç†åˆå¹¶æ•°æ®å›¾è¡¨æ•°æ® - ä½¿ç”¨ä¸ä¸»å›¾è¡¨ç›¸åŒçš„é€»è¾‘
  function processMergedChartData(data, groupField, chartType) {
    console.log('å¤„ç†åˆå¹¶æ•°æ®å›¾è¡¨æ•°æ®:', {
      dataLength: data.length,
      groupField: groupField,
      chartType: chartType
    });

    // ä½¿ç”¨ä¸ä¸»å›¾è¡¨å®Œå…¨ç›¸åŒçš„æ•°æ®å¤„ç†é€»è¾‘
    return processGroupedDataForChart(data, groupField, chartType);
  }

  // åˆ›å»ºåˆå¹¶æ•°æ®å›¾è¡¨ - ä½¿ç”¨ä¸ä¸»å›¾è¡¨å®Œå…¨ç›¸åŒçš„é…ç½®
  function createMergedChart(data, type) {
    console.log('ğŸ¨ createMergedChartå‡½æ•°è¢«è°ƒç”¨:', {
      data: data,
      type: type,
      labels: data.labels,
      datasetsCount: data.datasets ? data.datasets.length : 0
    });

    const ctx = document.getElementById('mergedDataChart').getContext('2d');

    if (!ctx) {
      console.error('âŒ æ— æ³•è·å–canvasä¸Šä¸‹æ–‡');
      return;
    }

    console.log('âœ… Canvasä¸Šä¸‹æ–‡è·å–æˆåŠŸ');

    // é”€æ¯ç°æœ‰å›¾è¡¨
    if (mergedChart) {
      console.log('ğŸ—‘ï¸ é”€æ¯ç°æœ‰åˆå¹¶å›¾è¡¨');
      mergedChart.destroy();
      mergedChart = null;
    }

    // æ ¹æ®å›¾è¡¨ç±»å‹è°ƒæ•´æ•°æ®æ ¼å¼
    let chartData;
    if (type === 'pie') {
      chartData = {
        labels: data.labels,
        datasets: data.datasets
      };
    } else {
      // æŸ±çŠ¶å›¾å’ŒæŠ˜çº¿å›¾éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªYè½´
      chartData = {
        labels: data.labels,
        datasets: data.datasets.map((dataset, index) => {
          if (dataset.label === 'å…³é—­ç‡(%)') {
            return {
              ...dataset,
              yAxisID: 'y1'
            };
          } else {
            return {
              ...dataset,
              yAxisID: 'y'
            };
          }
        })
      };
    }

    const config = {
      type: type || 'bar',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1.5,
        layout: {
          padding: {
            top: 10,
            bottom: 10,
            left: 10,
            right: 10
          }
        },
        plugins: {
          legend: {
            display: true,
            position: type === 'pie' ? 'right' : 'bottom',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 12
              }
            }
          },
          title: {
            display: true,
            text: 'æ”¶è—å¤¹åˆå¹¶æ•°æ®å›¾è¡¨',
            font: {
              size: 18,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          datalabels: {
            display: true,
            color: '#333',
            font: {
              weight: 'bold',
              size: 12
            },
            formatter: function(value, context) {
              if (type === 'pie') {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return percentage + '%';
              } else if (context.dataset.label === 'å…³é—­ç‡(%)') {
                return value + '%';
              } else {
                return value;
              }
            }
          }
        },
        scales: type !== 'pie' ? {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            ticks: {
              stepSize: 1
            },
            title: {
              display: true,
              text: 'æ•°é‡'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            },
            title: {
              display: true,
              text: 'å…³é—­ç‡(%)'
            },
            grid: {
              drawOnChartArea: false,
            },
          }
        } : {}
      }
    };

    // æ³¨å†Œæ•°æ®æ ‡ç­¾æ’ä»¶
    if (typeof ChartDataLabels !== 'undefined') {
      Chart.register(ChartDataLabels);
    }

    mergedChart = new Chart(ctx, config);
    console.log('ğŸ‰ åˆå¹¶æ•°æ®å›¾è¡¨åˆ›å»ºæˆåŠŸ!', {
      chartType: mergedChart.config.type,
      dataPoints: mergedChart.data.datasets[0] ? mergedChart.data.datasets[0].data.length : 0
    });
  }

  // å¯¼å‡ºæ”¶è—å¤¹æ•°æ®
  function exportCartData() {
    const selectedItems = getSelectedCartItems();

    if (selectedItems.length === 0) {
      showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ”¶è—å¤¹é¡¹ç›®ï¼', 'warning');
      return;
    }

    showLoading();

    // åˆå¹¶é€‰ä¸­çš„æ”¶è—å¤¹é¡¹ç›®çš„æ•°æ®
    const exportMergedData = [];
    const idSet = new Set(); // ç”¨äºå»é‡

    selectedItems.forEach(item => {
      item.data.forEach(problem => {
        if (!idSet.has(problem.id)) {
          idSet.add(problem.id);
          exportMergedData.push(problem);
        }
      });
    });


    // å‡†å¤‡å¯¼å‡ºæ•°æ®
    const exportData = {
      data: exportMergedData,
      exportType: 'cart',
      fileName: `æ”¶è—å¤¹åˆå¹¶æ•°æ®_${new Date().toISOString().slice(0, 10)}.xlsx`
    };

    fetch('/problemLibrary/exportCartsData', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(exportData)
    })
            .then(response => {
              if (response.ok) {
                return response.blob();
              } else {
                throw new Error('å¯¼å‡ºå¤±è´¥');
              }
            })
            .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = exportData.fileName;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
              showToast(`æˆåŠŸå¯¼å‡º ${selectedItems.length} ä¸ªæ”¶è—å¤¹é¡¹ç›®ï¼Œå…± ${exportMergedData.length} æ¡è®°å½•ï¼`, 'success');
            })
            .catch(error => {
              console.error('Error:', error);
              showToast('å¯¼å‡ºæ—¶å‘ç”Ÿé”™è¯¯', 'error');
            })
            .finally(() => {
              hideLoading();
            });
  }

  // æ›´æ–°æ”¶è—å¤¹è®¡æ•°
  function updateCartCount() {
    const countElement = document.getElementById('cartCount');
    if (countElement) {
      countElement.textContent = cartItems.length;
    }
  }

  // ä¿å­˜æ”¶è—å¤¹åˆ°æœ¬åœ°å­˜å‚¨
  function saveCartToStorage() {
    try {
      localStorage.setItem('problemLibraryCart', JSON.stringify(cartItems));
    } catch (e) {
      console.error('ä¿å­˜æ”¶è—å¤¹å¤±è´¥:', e);
    }
  }

  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ”¶è—å¤¹
  function loadCartFromStorage() {
    try {
      const stored = localStorage.getItem('problemLibraryCart');
      if (stored) {
        cartItems = JSON.parse(stored);
      }
    } catch (e) {
      console.error('åŠ è½½æ”¶è—å¤¹å¤±è´¥:', e);
      cartItems = [];
    }
  }

  // ç”Ÿæˆå›¾è¡¨å‡½æ•°
  function generateChart() {
    console.log('generateChartå‡½æ•°è¢«è°ƒç”¨');

    // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
    if (typeof Chart === 'undefined') {
      alert('Chart.jsåº“æœªåŠ è½½ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
      return;
    }

    const groupField = document.getElementById('groupField').value;

    console.log('é€‰æ‹©çš„åˆ†ç»„å­—æ®µ:', groupField);

    if (!groupField) {
      alert('è¯·é€‰æ‹©åˆ†ç»„å­—æ®µ');
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const generateBtn = document.getElementById('generateChartBtn');
    const originalText = generateBtn.textContent;
    generateBtn.textContent = 'åŠ è½½ä¸­...';
    generateBtn.disabled = true;

    // å…ˆå°è¯•ä½¿ç”¨ç°æœ‰çš„allData
    console.log('å½“å‰allDataé•¿åº¦:', allData.length);
    console.log('å½“å‰totalCount:', totalCount);

    // å¦‚æœallDataçš„æ•°æ®é‡ç­‰äºtotalCountï¼Œè¯´æ˜å·²ç»åŒ…å«äº†æ‰€æœ‰æ•°æ®
    if (allData.length === totalCount && allData.length > 0) {
      console.log('ä½¿ç”¨ç°æœ‰çš„allDataï¼Œæ•°æ®é‡:', allData.length);
      try {
        processChartData(allData, groupField, currentChartType);
      } catch (error) {
        console.error('å¤„ç†å›¾è¡¨æ•°æ®å¤±è´¥:', error);
        alert('å¤„ç†å›¾è¡¨æ•°æ®å¤±è´¥: ' + error.message);
        showNoDataMessage();
      }
    } else {
      console.log('allDataä¸å®Œæ•´ï¼Œé‡æ–°è·å–æ‰€æœ‰æ•°æ®');
      // è·å–æ‰€æœ‰æœç´¢ç»“æœæ•°æ®
      getAllSearchData()
              .then(allSearchData => {
                console.log('è·å–åˆ°çš„æ‰€æœ‰æœç´¢ç»“æœæ•°æ®:', allSearchData);
                if (allSearchData && allSearchData.length > 0) {
                  try {
                    processChartData(allSearchData, groupField, currentChartType);
                  } catch (error) {
                    console.error('å¤„ç†å›¾è¡¨æ•°æ®å¤±è´¥:', error);
                    alert('å¤„ç†å›¾è¡¨æ•°æ®å¤±è´¥: ' + error.message);
                    showNoDataMessage();
                  }
                } else {
                  console.log('æ²¡æœ‰è·å–åˆ°æ•°æ®');
                  alert('æ²¡æœ‰è·å–åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥æœç´¢æ¡ä»¶');
                  showNoDataMessage();
                }
              })
              .catch(error => {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                alert('è·å–æ•°æ®å¤±è´¥: ' + error.message);
                showNoDataMessage();
              });
    }

    // æ¢å¤æŒ‰é’®çŠ¶æ€
    generateBtn.textContent = originalText;
    generateBtn.disabled = false;
  }

  // å¤„ç†å›¾è¡¨æ•°æ®çš„è¾…åŠ©å‡½æ•°
  function processChartData(data, groupField, chartType) {
    console.log('ğŸ”„ processChartData è¢«è°ƒç”¨:', {
      dataLength: data.length,
      groupField: groupField,
      chartType: chartType
    });

    if (!data || data.length === 0) {
      console.log('âŒ æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯');
      showNoDataMessage();
      return;
    }

    // éªŒè¯åˆ†ç»„å­—æ®µ
    if (!groupField) {
      console.error('âŒ åˆ†ç»„å­—æ®µä¸ºç©º');
      alert('è¯·é€‰æ‹©åˆ†ç»„å­—æ®µ');
      return;
    }

    // å¤„ç†æ•°æ®
    console.log('ğŸ“Š å¼€å§‹å¤„ç†åˆ†ç»„æ•°æ®...');
    try {
      const chartData = processGroupedDataForChart(data, groupField, chartType);
      console.log('âœ… å¤„ç†åçš„å›¾è¡¨æ•°æ®:', chartData);

      // éªŒè¯å¤„ç†åçš„æ•°æ®
      if (!chartData || !chartData.labels || chartData.labels.length === 0) {
        console.error('âŒ å¤„ç†åçš„å›¾è¡¨æ•°æ®æ— æ•ˆ');
        alert('æ— æ³•ç”Ÿæˆå›¾è¡¨æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼');
        showNoDataMessage();
        return;
      }

      // é”€æ¯ç°æœ‰å›¾è¡¨
      if (currentChart) {
        console.log('ğŸ—‘ï¸ é”€æ¯ç°æœ‰å›¾è¡¨');
        currentChart.destroy();
        currentChart = null;
      }

      // åˆ›å»ºæ–°å›¾è¡¨
      console.log('ğŸš€ å¼€å§‹åˆ›å»ºå›¾è¡¨ï¼Œç±»å‹:', chartType);
      createGroupedChart(chartData, chartType);
      console.log('âœ… å›¾è¡¨åˆ›å»ºå®Œæˆ');
    } catch (error) {
      console.error('âŒ å¤„ç†å›¾è¡¨æ•°æ®å¤±è´¥:', error);
      alert('å¤„ç†å›¾è¡¨æ•°æ®å¤±è´¥: ' + error.message);
      showNoDataMessage();
    }
  }

  // è·å–è¡¨æ ¼æ•°æ®
  function getTableData() {
    console.log('=== å¼€å§‹è·å–å›¾è¡¨æ•°æ® ===');
    console.log('allDataç±»å‹:', typeof allData);
    console.log('allDataé•¿åº¦:', allData ? allData.length : 'undefined');
    console.log('allDataå†…å®¹:', allData);

    // æ£€æŸ¥allDataæ˜¯å¦æœ‰æ•ˆ
    if (!allData || allData.length === 0) {
      console.log('allDataæ— æ•ˆæˆ–ä¸ºç©ºï¼Œå°è¯•ä»è¡¨æ ¼è·å–å½“å‰é¡µæ•°æ®');
      return getDataFromTable();
    }

    // æ£€æŸ¥allDataçš„æ•°æ®ç»“æ„
    if (allData.length > 0) {
      console.log('allDataç¬¬ä¸€æ¡æ•°æ®çš„ç»“æ„:', Object.keys(allData[0]));
      console.log('å‰3æ¡allDataæ•°æ®:');
      for (let i = 0; i < Math.min(3, allData.length); i++) {
        console.log(`ç¬¬${i + 1}æ¡æ•°æ®:`, allData[i]);
      }
    }

    console.log('ä½¿ç”¨allDataï¼Œæ€»æ•°æ®é‡:', allData.length);
    return allData;
  }

  // è·å–æ‰€æœ‰æœç´¢ç»“æœæ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰
  function getAllSearchData() {
    console.log('=== è·å–æ‰€æœ‰æœç´¢ç»“æœæ•°æ® ===');

    return new Promise((resolve, reject) => {
      // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼ˆè®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„sizeæ¥è·å–æ‰€æœ‰æ•°æ®ï¼‰
      const params = new URLSearchParams({
        username: currentUser,
        job: currentRole,
        page: 1,
        size: 10000  // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—æ¥è·å–æ‰€æœ‰æ•°æ®
      });

      // æ·»åŠ ç­›é€‰æ¡ä»¶
      const majorCode = document.getElementById('majorCodeFilter').value.trim();
      const minorCode = document.getElementById('minorCodeFilter').value.trim();
      const projectPhase = document.getElementById('projectPhaseFilter').value.trim();
      const version = document.getElementById('versionFilter').value.trim();
      const supplier = document.getElementById('supplierFilter').value.trim();
      const testStartDate = document.getElementById('testStartDateFilter').value;
      const testEndDate = document.getElementById('testEndDateFilter').value;

      if (majorCode) params.append('majorCode', majorCode);
      if (minorCode) params.append('minorCode', minorCode);
      if (projectPhase) params.append('projectPhase', projectPhase);
      if (version) params.append('version', version);
      if (supplier) params.append('supplier', supplier);
      if (testStartDate) params.append('testStartDate', testStartDate);
      if (testEndDate) params.append('testEndDate', testEndDate);

      console.log('å‘é€çš„æŸ¥è¯¢å‚æ•°ï¼ˆè·å–æ‰€æœ‰æ•°æ®ï¼‰:', params.toString());

      fetch('/reviewResult/getReviewResults?' + params.toString())
              .then(response => response.json())
              .then(data => {
                console.log('APIå“åº”æ•°æ®ï¼ˆæ‰€æœ‰æ•°æ®ï¼‰:', data);
                if (data.success) {
                  const allSearchData = data.data || [];
                  console.log('è·å–åˆ°çš„æ‰€æœ‰æœç´¢ç»“æœæ•°æ®é‡:', allSearchData.length);
                  resolve(allSearchData);
                } else {
                  console.error('APIè¿”å›é”™è¯¯:', data);
                  reject(new Error(data.error || data.message || 'è·å–æ•°æ®å¤±è´¥'));
                }
              })
              .catch(error => {
                console.error('è·å–æ‰€æœ‰æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                reject(error);
              });
    });
  }

  // ä»è¡¨æ ¼è·å–æ•°æ®çš„è¾…åŠ©å‡½æ•°
  function getDataFromTable() {
    const table = document.getElementById('reviewTable');
    const rows = table.querySelectorAll('tbody tr');
    const data = [];

    console.log('æ‰¾åˆ°è¡¨æ ¼è¡Œæ•°:', rows.length);

    rows.forEach((row, rowIndex) => {
      const cells = row.querySelectorAll('td');
      if (cells.length > 0) {
        const rowData = {};
        // æ ¹æ®è¡¨æ ¼åˆ—çš„å®é™…é¡ºåºè·å–æ•°æ®ï¼ˆè·³è¿‡æ“ä½œåˆ—ï¼Œå…±26åˆ—æ•°æ®åˆ—ï¼‰
        const headers = ['id', 'testDate', 'majorCode', 'minorCode', 'projectPhase', 'version',
          'problemProcess', 'problemLevel', 'developmentMethod', 'supplier',
          'solutionProvider', 'problemPoint', 'problemReason', 'improvementStrategy',
          'isPreventable', 'responsibleDepartment', 'problemStatus', 'expectedCompletionTime',
          'actualCompletionTime', 'delayDays', 'problemTag1', 'problemTag2',
          'preventionNote', 'createdAt', 'updatedAt'];

        headers.forEach((header, index) => {
          if (cells[index]) {
            rowData[header] = cells[index].textContent.trim();
          }
        });

        // åªæ·»åŠ æœ‰IDçš„è¡Œï¼ˆè¿‡æ»¤æ‰ç©ºè¡Œï¼‰
        if (rowData.id && rowData.id !== '') {
          data.push(rowData);
          if (rowIndex < 3) { // åªæ‰“å°å‰3è¡Œçš„æ•°æ®ç”¨äºè°ƒè¯•
            console.log(`ç¬¬${rowIndex + 1}è¡Œæ•°æ®:`, rowData);
          }
        }
      }
    });

    console.log('ä»è¡¨æ ¼è·å–çš„æ•°æ®è¡Œæ•°:', data.length);
    return data;
  }

  // å¤„ç†æ•°æ®ç”¨äºå›¾è¡¨æ˜¾ç¤º
  function processDataForChart(data, xField, yField) {
    console.log('å¼€å§‹å¤„ç†å›¾è¡¨æ•°æ®ï¼ŒXå­—æ®µ:', xField, 'Yå­—æ®µ:', yField);
    const groupedData = {};

    data.forEach((item, index) => {
      const xValue = item[xField] || 'æœªçŸ¥';
      const yValue = yField === 'count' ? 1 : (parseFloat(item[yField]) || 0);

      // æ‰“å°å‰å‡ æ¡æ•°æ®çš„å¤„ç†è¿‡ç¨‹
      if (index < 3) {
        console.log(`ç¬¬${index + 1}æ¡æ•°æ®:`, {
          xValue: xValue,
          yValue: yValue,
          xFieldValue: item[xField],
          yFieldValue: item[yField]
        });
      }

      if (groupedData[xValue]) {
        if (yField === 'count') {
          groupedData[xValue]++;
        } else {
          groupedData[xValue] += yValue;
        }
      } else {
        groupedData[xValue] = yField === 'count' ? 1 : yValue;
      }
    });

    const labels = Object.keys(groupedData);
    const values = Object.values(groupedData);

    console.log('åˆ†ç»„åçš„æ•°æ®:', groupedData);
    console.log('å›¾è¡¨æ ‡ç­¾:', labels);
    console.log('å›¾è¡¨æ•°å€¼:', values);

    return { labels, values };
  }

  // å¤„ç†åˆ†ç»„æ•°æ®ç”¨äºå›¾è¡¨æ˜¾ç¤º
  function processGroupedDataForChart(data, groupField, chartType) {
    console.log('å¼€å§‹å¤„ç†åˆ†ç»„å›¾è¡¨æ•°æ®ï¼Œåˆ†ç»„å­—æ®µ:', groupField, 'å›¾è¡¨ç±»å‹:', chartType);
    console.log('è¾“å…¥æ•°æ®é‡:', data.length);

    const groupedData = {};

    // æŒ‰åˆ†ç»„å­—æ®µç»Ÿè®¡
    data.forEach((item, index) => {
      // æ‰“å°å‰å‡ æ¡æ•°æ®çš„å­—æ®µå€¼ç”¨äºè°ƒè¯•
      if (index < 3) {
        console.log(`ç¬¬${index + 1}æ¡æ•°æ®:`, {
          groupField: groupField,
          groupValue: item[groupField],
          problemStatus: item.problemStatus,
          delayDays: item.delayDays
        });
      }

      const groupValue = item[groupField] || 'æœªçŸ¥';

      if (!groupedData[groupValue]) {
        groupedData[groupValue] = {
          total: 0,
          closed: 0,
          open: 0,
          followUp: 0,
          delayCount: 0,
          totalDelayDays: 0,
          preventable: 0
        };
      }

      groupedData[groupValue].total++;

      // ç»Ÿè®¡å…³é—­çŠ¶æ€
      const status = item.problemStatus || 'Open';
      if (status.toLowerCase() === 'closed' || status.toLowerCase() === 'close') {
        groupedData[groupValue].closed++;
      } else if (status === 'Open') {
        groupedData[groupValue].open++;
      } else if (status === 'Follow up') {
        groupedData[groupValue].followUp++;
      }

      // ç»Ÿè®¡å¯é¢„é˜²æ•°
      if (item.isPreventable === 'æ˜¯') {
        groupedData[groupValue].preventable++;
      }
    });

    // è®¡ç®—å…³é—­ç‡
    Object.keys(groupedData).forEach(key => {
      const group = groupedData[key];
      group.closureRate = group.total > 0 ? Math.round((group.closed / group.total) * 100) : 0;
      group.avgDelayDays = group.delayCount > 0 ? Math.round(group.totalDelayDays / group.delayCount) : 0;
    });

    console.log('åˆ†ç»„åçš„æ•°æ®:', groupedData);

    const labels = Object.keys(groupedData);
    const datasets = [];

    // æ ¹æ®å›¾è¡¨ç±»å‹å†³å®šæ˜¾ç¤ºå“ªäº›æ•°æ®ç³»åˆ—
    if (chartType === 'pie') {
      // é¥¼çŠ¶å›¾åªæ˜¾ç¤ºæ€»æ•°
      datasets.push({
        label: 'æ€»æ•°',
        data: labels.map(label => groupedData[label].total),
        backgroundColor: [
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 99, 132, 0.6)',
          'rgba(255, 193, 7, 0.6)',
          'rgba(75, 192, 192, 0.6)',
          'rgba(153, 102, 255, 0.6)',
          'rgba(255, 159, 64, 0.6)',
          'rgba(199, 199, 199, 0.6)',
          'rgba(83, 102, 255, 0.6)'
        ],
        borderColor: [
          'rgba(54, 162, 235, 1)',
          'rgba(255, 99, 132, 1)',
          'rgba(255, 193, 7, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)',
          'rgba(255, 159, 64, 1)',
          'rgba(199, 199, 199, 1)',
          'rgba(83, 102, 255, 1)'
        ],
        borderWidth: 1
      });
    } else {
      // æŸ±çŠ¶å›¾å’ŒæŠ˜çº¿å›¾æ˜¾ç¤ºå››ä¸ªæ•°æ®ç³»åˆ—ï¼šæ€»æ•°ã€å…³é—­æ•°ã€å¯é¢„é˜²æ•°ã€å…³é—­ç‡
      datasets.push({
        label: 'æ€»æ•°',
        data: labels.map(label => groupedData[label].total),
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      });
      datasets.push({
        label: 'å…³é—­æ•°',
        data: labels.map(label => groupedData[label].closed),
        backgroundColor: 'rgba(255, 99, 132, 0.6)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1
      });
      datasets.push({
        label: 'å¯é¢„é˜²æ•°',
        data: labels.map(label => groupedData[label].preventable),
        backgroundColor: 'rgba(255, 193, 7, 0.6)',
        borderColor: 'rgba(255, 193, 7, 1)',
        borderWidth: 1
      });
      datasets.push({
        label: 'å…³é—­ç‡(%)',
        data: labels.map(label => groupedData[label].closureRate),
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
        yAxisID: 'y1'
      });
    }

    return { labels, datasets, groupedData };
  }

  // åˆ›å»ºå›¾è¡¨
  function createChart(data, type) {
    console.log('createChartå‡½æ•°è¢«è°ƒç”¨ï¼Œæ•°æ®:', data, 'ç±»å‹:', type);

    const ctx = document.getElementById('dataChart').getContext('2d');
    const noDataMessage = document.getElementById('noDataMessage');

    if (!ctx) {
      console.error('æ— æ³•è·å–canvasä¸Šä¸‹æ–‡');
      return;
    }

    // éšè—æ— æ•°æ®æ¶ˆæ¯
    noDataMessage.style.display = 'none';

    // æ ¹æ®å›¾è¡¨ç±»å‹è°ƒæ•´æ•°æ®æ ¼å¼
    let chartData;
    if (type === 'pie') {
      chartData = {
        labels: data.labels,
        datasets: [{
          label: 'æ•°å€¼',
          data: data.values,
          backgroundColor: getBackgroundColors(data.labels.length),
          borderColor: getBorderColors(data.labels.length),
          borderWidth: 1
        }]
      };
    } else {
      chartData = {
        labels: data.labels,
        datasets: [{
          label: 'æ•°å€¼',
          data: data.values,
          backgroundColor: getBackgroundColors(data.labels.length),
          borderColor: getBorderColors(data.labels.length),
          borderWidth: 1
        }]
      };
    }

    const config = {
      type: type,
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1.5,
        layout: {
          padding: {
            top: 10,
            bottom: 10,
            left: 10,
            right: 10
          }
        },
        plugins: {
          legend: {
            display: type !== 'pie',
            position: type === 'pie' ? 'right' : 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 12
              }
            }
          },
          title: {
            display: true,
            text: 'æ•°æ®ç»Ÿè®¡å›¾è¡¨',
            font: {
              size: 18,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          tooltip: {
            callbacks: {
              afterLabel: function(context) {
                return [`æ•°å€¼: ${context.parsed}`];
              }
            }
          },
          datalabels: {
            display: true,
            color: '#000',
            font: {
              size: 11,
              weight: 'bold'
            },
            formatter: function(value, context) {
              return value;
            },
            anchor: 'end',
            align: 'top',
            offset: 4
          }
        },
        scales: type !== 'pie' ? {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'æ•°å€¼',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            ticks: {
              font: {
                size: 12
              }
            },
            grid: {
              color: 'rgba(0,0,0,0.1)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'ç±»åˆ«',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            ticks: {
              font: {
                size: 12
              }
            },
            grid: {
              display: false
            }
          }
        } : {},
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        },
        layout: {
          padding: {
            top: 40,
            bottom: 20
          }
        }
      }
    };

    console.log('å›¾è¡¨é…ç½®:', config);

    try {
      // æ³¨å†Œæ•°æ®æ ‡ç­¾æ’ä»¶
      if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
      }

      currentChart = new Chart(ctx, config);
      console.log('å›¾è¡¨åˆ›å»ºæˆåŠŸ');
    } catch (error) {
      console.error('å›¾è¡¨åˆ›å»ºå¤±è´¥:', error);
      alert('å›¾è¡¨åˆ›å»ºå¤±è´¥: ' + error.message);
    }
  }

  // æ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯
  function showNoDataMessage() {
    if (currentChart) {
      currentChart.destroy();
      currentChart = null;
    }
    document.getElementById('noDataMessage').style.display = 'block';
    updateChartStatus('æ— æ•°æ®å¯æ˜¾ç¤º', 'warning');
  }

  // æ›´æ–°å›¾è¡¨çŠ¶æ€
  function updateChartStatus(message, type = 'info') {
    const statusDiv = document.getElementById('chartStatus');
    const statusText = document.getElementById('chartStatusText');

    if (statusDiv && statusText) {
      statusText.textContent = message;

      // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
      switch (type) {
        case 'success':
          statusDiv.style.background = '#d4edda';
          statusDiv.style.borderLeftColor = '#28a745';
          statusDiv.style.color = '#155724';
          break;
        case 'warning':
          statusDiv.style.background = '#fff3cd';
          statusDiv.style.borderLeftColor = '#ffc107';
          statusDiv.style.color = '#856404';
          break;
        case 'error':
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.borderLeftColor = '#dc3545';
          statusDiv.style.color = '#721c24';
          break;
        default:
          statusDiv.style.background = '#f8f9fa';
          statusDiv.style.borderLeftColor = '#6c757d';
          statusDiv.style.color = '#495057';
      }

      statusDiv.style.display = 'block';
    }
  }

  // ç”ŸæˆèƒŒæ™¯é¢œè‰²æ•°ç»„
  function getBackgroundColors(count) {
    const colors = [
      'rgba(54, 162, 235, 0.6)',
      'rgba(255, 99, 132, 0.6)',
      'rgba(255, 205, 86, 0.6)',
      'rgba(75, 192, 192, 0.6)',
      'rgba(153, 102, 255, 0.6)',
      'rgba(255, 159, 64, 0.6)',
      'rgba(199, 199, 199, 0.6)',
      'rgba(83, 102, 255, 0.6)',
      'rgba(255, 99, 255, 0.6)',
      'rgba(99, 255, 132, 0.6)'
    ];

    const result = [];
    for (let i = 0; i < count; i++) {
      result.push(colors[i % colors.length]);
    }
    return result;
  }

  // ç”Ÿæˆè¾¹æ¡†é¢œè‰²æ•°ç»„
  function getBorderColors(count) {
    const colors = [
      'rgba(54, 162, 235, 1)',
      'rgba(255, 99, 132, 1)',
      'rgba(255, 205, 86, 1)',
      'rgba(75, 192, 192, 1)',
      'rgba(153, 102, 255, 1)',
      'rgba(255, 159, 64, 1)',
      'rgba(199, 199, 199, 1)',
      'rgba(83, 102, 255, 1)',
      'rgba(255, 99, 255, 1)',
      'rgba(99, 255, 132, 1)'
    ];

    const result = [];
    for (let i = 0; i < count; i++) {
      result.push(colors[i % colors.length]);
    }
    return result;
  }


  // åˆ›å»ºåˆ†ç»„å›¾è¡¨
  function createGroupedChart(data, type) {
    console.log('ğŸ¨ createGroupedChartå‡½æ•°è¢«è°ƒç”¨:', {
      data: data,
      type: type,
      labels: data.labels,
      datasetsCount: data.datasets ? data.datasets.length : 0
    });

    const ctx = document.getElementById('dataChart').getContext('2d');
    const noDataMessage = document.getElementById('noDataMessage');

    if (!ctx) {
      console.error('âŒ æ— æ³•è·å–canvasä¸Šä¸‹æ–‡');
      return;
    }

    console.log('âœ… Canvasä¸Šä¸‹æ–‡è·å–æˆåŠŸ');
    // éšè—æ— æ•°æ®æ¶ˆæ¯
    noDataMessage.style.display = 'none';

    // æ ¹æ®å›¾è¡¨ç±»å‹è°ƒæ•´æ•°æ®æ ¼å¼
    let chartData = data;
    if (type === 'pie') {
      // é¥¼çŠ¶å›¾åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªæ•°æ®é›†ï¼ˆé€šå¸¸æ˜¯æ€»æ•°ï¼‰
      chartData = {
        labels: data.labels,
        datasets: [{
          label: data.datasets[0].label,
          data: data.datasets[0].data,
          backgroundColor: data.datasets[0].backgroundColor || getBackgroundColors(data.labels.length),
          borderColor: data.datasets[0].borderColor || getBorderColors(data.labels.length),
          borderWidth: data.datasets[0].borderWidth || 1
        }]
      };
    }

    const config = {
      type: type || 'bar',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 1.5,
        layout: {
          padding: {
            top: 10,
            bottom: 10,
            left: 10,
            right: 10
          }
        },
        plugins: {
          legend: {
            display: true,
            position: type === 'pie' ? 'right' : 'bottom',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 12
              }
            }
          },
          title: {
            display: true,
            text: `${document.getElementById('groupField').selectedOptions[0].text} é—®é¢˜ç¼ºé™·ç­‰çº§å…³é—­æƒ…å†µ`,
            font: {
              size: 18,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          tooltip: {
            callbacks: {
              afterLabel: function(context) {
                const groupValue = context.label;
                const groupData = data.groupedData ? data.groupedData[groupValue] : null;

                if (groupData) {
                  return [
                    `æ€»æ•°: ${groupData.total}`,
                    `å…³é—­æ•°: ${groupData.closed}`,
                    `å¯é¢„é˜²æ•°: ${groupData.preventable}`,
                    `å…³é—­ç‡: ${groupData.closureRate}%`
                  ];
                } else {
                  return [`æ•°å€¼: ${context.parsed}`];
                }
              }
            }
          },
          // æ·»åŠ æ•°æ®æ ‡ç­¾æ’ä»¶
          datalabels: {
            display: true,
            color: '#000',
            font: {
              size: 11,
              weight: 'bold'
            },
            formatter: function(value, context) {
              const datasetLabel = context.dataset.label;
              if (datasetLabel === 'å…³é—­ç‡(%)') {
                return value + '%';
              } else {
                return value;
              }
            },
            anchor: 'end',
            align: 'top',
            offset: 4
          }
        },
        scales: type === 'pie' ? {} : {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            title: {
              display: true,
              text: 'æ•°é‡',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            ticks: {
              stepSize: 1,
              font: {
                size: 12
              }
            },
            grid: {
              color: 'rgba(0,0,0,0.1)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'ç™¾åˆ†æ¯”',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            ticks: {
              callback: function(value) {
                return value + '%';
              },
              font: {
                size: 12
              }
            },
            grid: {
              drawOnChartArea: false
            }
          },
          x: {
            title: {
              display: true,
              text: 'é—®é¢˜ç¼ºé™·ç­‰çº§',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            ticks: {
              font: {
                size: 12
              }
            },
            grid: {
              display: false
            }
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        },
        layout: {
          padding: {
            top: 40,  // å¢åŠ é¡¶éƒ¨é—´è·ä»¥å®¹çº³æ•°æ®æ ‡ç­¾
            bottom: 20
          }
        }
      }
    };

    console.log('âš™ï¸ åˆ†ç»„å›¾è¡¨é…ç½®:', {
      type: config.type,
      labelsCount: config.data.labels.length,
      datasetsCount: config.data.datasets.length,
      scales: config.options.scales ? Object.keys(config.options.scales) : 'none'
    });

    try {
      // æ³¨å†Œæ•°æ®æ ‡ç­¾æ’ä»¶
      console.log('ğŸ“ æ³¨å†Œæ•°æ®æ ‡ç­¾æ’ä»¶...');
      Chart.register(ChartDataLabels);

      console.log('ğŸ¯ å¼€å§‹åˆ›å»ºChartå®ä¾‹...');
      currentChart = new Chart(ctx, config);
      console.log('ğŸ‰ åˆ†ç»„å›¾è¡¨åˆ›å»ºæˆåŠŸ!', {
        chartType: currentChart.config.type,
        dataPoints: currentChart.data.datasets[0] ? currentChart.data.datasets[0].data.length : 0
      });

      // æ›´æ–°çŠ¶æ€
      updateChartStatus(`å›¾è¡¨åˆ›å»ºæˆåŠŸ - ${currentChartType === 'pie' ? 'é¥¼çŠ¶å›¾' : currentChartType === 'bar' ? 'æŸ±çŠ¶å›¾' : 'æŠ˜çº¿å›¾'}`, 'success');
    } catch (error) {
      console.error('ğŸ’¥ åˆ†ç»„å›¾è¡¨åˆ›å»ºå¤±è´¥:', error);
      console.error('é”™è¯¯è¯¦æƒ…:', {
        message: error.message,
        stack: error.stack,
        config: config
      });
    }
  }
</script>
</body>
</html>
