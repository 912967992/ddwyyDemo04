<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子实验室设备信息</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/labModule.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>

<div class="sidebar">
    <ul class="nav-list">
        <li><a href="/labModuleTester" class="nav-link active">设备信息</a></li>
        <li id="durationLink"><a href="#" class="nav-link">测试时长</a></li>
        <!--        <li><a href="page3.html" class="nav-link">页面 3</a></li>-->
    </ul>
</div>





<div class="header-container">
    <div class="title">电子实验室模块</div>
    <button class="BackBtn" id="BackBtn" onclick="goToReturnPage()">返回<br>主页</button>
</div>


<div class="main-content">
    <div class="search-container">
        <form class="search-form">
            <!-- 设备id-->
            <div class="input-group">
                <label for="id">设备ID:</label>
                <input type="text" id="id" name="id" placeholder="设备ID">
            </div>

            <!-- 统计负责人 -->
            <div class="input-group">
                <label for="personCharge">统计<br>人:</label>
                <input type="text" id="personCharge" name="personCharge" placeholder="">
            </div>

            <!-- 计算机名称 -->
            <div class="input-group">
                <label for="computerName">设备<br>名称:</label>
                <input type="text" id="computerName" name="computerName" placeholder="">
            </div>

            <!-- 品牌 -->
            <div class="input-group">
                <label for="brand">品牌:</label>
                <input type="text" id="brand" name="brand" placeholder="">
            </div>

            <!-- 区域 -->
            <div class="input-group">
                <label for="area">区域:</label>
                <input type="text" id="area" name="area" placeholder="">
            </div>

            <!-- 设备类型 -->
            <div class="input-group">
                <label for="deviceType">设备<br>类型:</label>
                <input type="text" id="deviceType" name="deviceType" placeholder="">
            </div>

            <!-- 操作系统版本 -->
            <div class="input-group">
                <label for="version">操作系统<br>版本:</label>
                <input type="text" id="version" name="version" placeholder="家庭中文版">
            </div>


            <!-- 操作系统详细版本号 -->
            <div class="input-group">
                <label for="osVersion">系统<br>版本号:</label>
                <input type="text" id="osVersion" name="osVersion" placeholder="22631.4460">
            </div>

            <div class="input-group">
                <label for="fullOS">版本<br>号:</label>
                <input type="text" id="fullOS" name="fullOS" placeholder="23H2">
            </div>

            <!-- 系统架构 -->
            <div class="input-group">
                <label for="architecture">系统架构:</label>
                <input type="text" id="architecture" name="architecture" placeholder="">
            </div>


            <!-- 处理器 -->
            <div class="input-group">
                <label for="cpu">处理器:</label>
                <input type="text" id="cpu" name="cpu" placeholder="">
            </div>

            <!-- 内存 -->
            <div class="input-group">
                <label for="memory">内存:</label>
                <input type="text" id="memory" name="memory" placeholder="">
            </div>

            <!-- 显卡 -->
            <div class="input-group">
                <label for="displays">显卡:</label>
                <input type="text" id="displays" name="displays" placeholder="">
            </div>



            <!-- 最大分辨率 -->
            <div class="input-group">
                <label for="maxResolution">最大分辨率:</label>
                <input type="text" id="maxResolution" name="maxResolution" placeholder="">
            </div>

            <!-- 最大刷新率 -->
            <div class="input-group">
                <label for="maxRefreshRate">最大刷新率:</label>
                <input type="text" id="maxRefreshRate" name="maxRefreshRate" placeholder="">
            </div>

            <!-- 接口信息 -->
            <div class="input-group">
                <label for="interfaceInfo">接口信息:</label>
                <input type="text" id="interfaceInfo" name="interfaceInfo" placeholder="">
            </div>


            <!--        &lt;!&ndash; 日期范围选择器 &ndash;&gt;-->
            <!--        <div class="input-group date-range">-->
            <!--            <label>提交<br>日期:</label>-->
            <!--            <input type="date" id="problemTimeStart" name="problemTimeStart" placeholder="开始日期"> &lt;!&ndash; 添加 name 属性 &ndash;&gt;-->
            <!--            <span class="date-separator">至</span> &lt;!&ndash; 添加“至”标签 &ndash;&gt;-->
            <!--            <input type="date" id="problemTimeEnd" name="problemTimeEnd" placeholder="结束日期"> &lt;!&ndash; 添加 name 属性 &ndash;&gt;-->
            <!--        </div>-->

            <div class="input-group">
                <button type="button" id="clearBtn" class="clear-btn">清空选项</button>
            </div>


            <!-- 搜索按钮 -->
            <button type="submit">搜索</button>

        </form>
    </div>
</div>


<!-- 表格容器 -->
<div class="problemtable_container">
    <!-- 这里是表格的占位符 -->
    <!-- 实际表格内容可以通过 JavaScript 动态生成 -->
</div>


<!-- 下方固定按钮 -->
<div class="btn-container">
    <hr class="divider"> <!-- 按钮上方的横线 -->
    <!-- 主页按钮 -->
    <button class="btn" id="homeBtn"><i class="fas fa-home"></i></button>
    <!-- 搜索资源库按钮 -->
    <button class="btn" id="cloudBtn"><i class="fas fa-cloud"></i></button>
    <!-- 个人界面按钮 -->
    <button class="btn" id="profileBtn"><i class="fas fa-user"></i></button>
</div>

<!-- 模态框的 HTML 结构 -->
<div id="alert-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div id="alert-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
        <div id="alert-message" style="margin-bottom: 20px;">提示信息</div>
        <button id="alert-confirm" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">确认</button>
    </div>
</div>

<!-- 模态框 -->
<!-- Modal for Interface Details -->
<div id="modal-interface" style="display: none;">
    <div class="modal-content">
        <h3>接口信息</h3>

        <!-- Display the header row (column names) -->
        <div class="modal-row">
            <div class="modal-cell">接口类型</div>
            <div class="modal-cell">接口标准</div>
            <div class="modal-cell">接口数量</div>
        </div>

        <!-- Display dynamic data rows -->
        <div id="dataRows"></div>

        <div>
            <button id="addRowBtn">新增行</button>
            <button id="saveInterface">保存数据</button>
            <button id="closeModal">关闭</button>
        </div>
    </div>
</div>

<!-- 模态框 -->
<div id="deleteModal" class="deleteModal" style="display: none;">
    <div class="deleteModal-content">
        <span class="close-button">&times;</span>
        <h2>删除数据</h2>
        <label for="idRange">请输入删除的 ID（单个、范围或多个，用逗号分隔）：</label>
        <input type="text" id="idRange" placeholder="例如: 1, 3, 5 或 1-5">
        <button id="submitDelete">提交</button>
    </div>
</div>


<script>
    // 覆盖原生 alert 方法
    window.alert = function(message) {
        // 获取模态框元素
        const overlay = document.getElementById('alert-overlay');
        const modal = document.getElementById('alert-modal');
        const messageElem = document.getElementById('alert-message');
        const confirmButton = document.getElementById('alert-confirm');

        // 设置消息文本
        messageElem.textContent = message;

        // 显示模态框
        overlay.style.display = 'block';
        modal.style.display = 'block';

        // 点击确认按钮时关闭模态框
        confirmButton.onclick = () => {
            overlay.style.display = 'none';
            modal.style.display = 'none';
            // 调用原本的alert回调
        };
    };

    let currentPage;
    let globalFormData ;
    let pageSize;
    let pages = []; // 用于存储分页数据

    let interfaceInfoData = [];
    let interfaceId;
    // const username = sessionStorage.getItem('username');
    // const job = localStorage.getItem("job");

    const username = "卢健";
    const job = "tester";


    // 获取 a 标签并修改其 href 属性
    var linkElement = document.querySelector("#durationLink a");
    linkElement.href = "/durationTable?role=" + encodeURIComponent(job);

    // 定义跳转函数
    function goToReturnPage() {
        // 拼接 URL 并跳转
        window.location.href = '/returnBtn?role=' + encodeURIComponent(job);
    }

    function readyConfig(){
        // 调用后端接口获取配置信息
        $.ajax({
            url: '/getJsapiConfig',
            type: 'GET',
            data: { url: encodeURIComponent(location.href.split('#')[0]) },
            success: function(config) {
                // 使用获取的配置信息初始化钉钉JSAPI
                dd.config({
                    agentId: config.agentId,
                    corpId: config.corpId,
                    timeStamp: config.timeStamp,
                    nonceStr: config.nonceStr,
                    signature: config.signature,
                    jsApiList: config.jsApiList // 必填，需要使用的jsapi列表
                });

            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function performSearch(formData) {
        // 发起 AJAX 请求
        $.ajax({
            url: '/labModule/performSysInfo',
            type: 'GET',
            dataType: 'json',
            data: formData, // 使用表单数据进行搜索
            success: function (data) {
                // 清空上一次的结果
                pages = []; // 重置分页数据
                const tableContainer = document.querySelector('.problemtable_container');
                tableContainer.innerHTML = ''; // 清空表格容器

                // 处理搜索结果
                pages = paginateData(data, pageSize);
                // currentPage = 1; // 重置当前页
                displayPage(currentPage,data);
            },
            error: function (xhr, status, error) {
                console.error('搜索请求失败:', error);
                console.log(xhr.responseText); // 打印响应体以获取更多信息
            }
        });
    }

    function paginateData(data, pageSize) {
        const pages = [];
        for (let i = 0; i < data.length; i += pageSize) {
            pages.push(data.slice(i, i + pageSize));
        }
        return pages;
    }

    function displayPage(pageNum, data) {
        if (pageNum < 1 || pageNum > pages.length) return;

        currentPage = pageNum;

        const tableContainer = document.querySelector('.problemtable_container');
        tableContainer.innerHTML = '';

        const pageData = pages[pageNum - 1] || [];
        const table = document.createElement('table');
        table.classList.add('result-table');

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const headers = [
            "设备ID", "统计人", "名称", "品牌", "区域", "设备类型" ,"操作系统版本",  "操作系统详细版本号", "版本号", "系统架构",
            "记录更新时间", "处理器", "内存", "显卡", "最大分辨率", "最大刷新率", "接口信息" , "设备发布日期", "设备购买日期", "设备维修记录"
        ];

        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        pageData.forEach(item => {
            const row = document.createElement('tr');

            const cells = [
                item.id,item.personCharge, item.computerName,item.brand, item.area, item.deviceType, item.version, item.osVersion, item.fullOS,
                item.architecture, item.created_at, item.cpu, item.memory,
                item.displays,  item.maxResolution, item.maxRefreshRate,
                item.interfaceInfo, item.deviceReleaseDate, item.devicePurchaseDate , item.deviceRepairHistory
            ];

            const allowedUsers = ["李智龙", "卢健", "戴杏华"]; // 允许编辑的用户名
            cells.forEach((cellData, index) => {
                const td = document.createElement('td');
                td.textContent = cellData ? cellData : '/';

                const nonEditableFields = ["设备ID", "记录更新时间"];
                const isNonEditable = nonEditableFields.includes(headers[index]);

                const isInterfaceColumn = headers[index] === "接口信息";
                const isDateTimeField = headers[index] === "操作系统安装日期";

                // 判断当前用户是否可以编辑
                const canEdit = allowedUsers.includes(username); // 判断用户名是否在允许列表中

                if (isInterfaceColumn) {
                    td.style.cursor = 'pointer';
                    td.addEventListener('click', () => {
                        interfaceId = item.id;
                        showModal(item.id);
                    });
                } else if (!isNonEditable && canEdit) {
                    td.style.cursor = 'pointer';

                    td.addEventListener('click', function () {
                        if (td.querySelector('textarea') || td.querySelector('input')) return;

                        const currentText = td.textContent.trim();
                        td.innerHTML = '';
                        row.classList.add('editing-row');

                        const fieldKeys = [
                            "id", "personCharge","computerName", "brand", "area","deviceType", "version", "osVersion", "fullOS",
                            "architecture", "created_at", "cpu", "memory",
                            "displays", "maxResolution", "maxRefreshRate", "interfaceInfo",
                            "deviceReleaseDate", "devicePurchaseDate", "deviceRepairHistory"
                        ];
                        const key = fieldKeys[index];

                        if (isDateTimeField) {
                            const input = document.createElement('input');
                            input.type = 'datetime-local';
                            input.classList.add('editable-datetime');

                            // 将 "2025-03-18 09:06:36" 转为 "2025-03-18T09:06:36"
                            let formattedValue = '';
                            if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(currentText)) {
                                formattedValue = currentText.replace(' ', 'T');
                            }
                            input.value = formattedValue;

                            td.appendChild(input);
                            input.focus();

                            input.addEventListener('blur', () => {
                                const newValue = input.value;
                                const finalValue = newValue ? newValue.replace('T', ' ') + ':00'.substring(newValue.length === 16 ? 0 : 3) : '/';
                                td.textContent = finalValue;
                                row.classList.remove('editing-row');

                                item[key] = finalValue;
                                item._edited = true;
                                console.log(key, finalValue);
                            });

                        } else {
                            // 普通字段：textarea
                            const textarea = document.createElement('textarea');
                            textarea.value = currentText === '/' ? '' : currentText;
                            textarea.classList.add('editable-textarea');

                            td.appendChild(textarea);
                            textarea.focus();
                            autoResize(textarea);

                            textarea.addEventListener('input', () => {
                                autoResize(textarea);
                            });

                            textarea.addEventListener('blur', () => {
                                const newValue = textarea.value.trim();
                                td.textContent = newValue || '/';
                                row.classList.remove('editing-row');

                                item[key] = newValue;
                                item._edited = true;
                                console.log(key, newValue);
                            });

                            textarea.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    textarea.blur();
                                }
                            });
                        }
                    });
                } else {
                    // 如果不能编辑，直接显示文本内容
                    td.style.cursor = 'default';
                }

                row.appendChild(td);
            });

            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableContainer.appendChild(table);

        updatePagination(tableContainer, data);
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto'; // 先清空高度
        textarea.style.height = textarea.scrollHeight + 'px'; // 再设为内容高度
    }


    function updatePagination(container,data) {
        const pagination = document.createElement('div');
        pagination.classList.add('pagination');

        // Function to change page without reloading data
        function changePage(newPage) {
            currentPage = newPage;
            updatePagination(container,data); // Refresh pagination buttons only
            displayPage(currentPage,data); // Update the display for the selected page
        }

        // Function to change page range and adjust current page
        function changePageRange(step) {
            let newPage = currentPage + step;
            if (newPage < 1) newPage = 1; // Ensure newPage does not go below 1
            if (newPage > pages.length) newPage = pages.length; // Ensure newPage does not exceed numPages
            changePage(newPage);
        }

        // Create the '<<' button (jump to first page)
        const firstPageButton = document.createElement('button');
        firstPageButton.textContent = '<<';
        firstPageButton.disabled = currentPage === 1; // Disable if on the first page
        firstPageButton.addEventListener('click', () => changePage(1));
        pagination.appendChild(firstPageButton);

        // Create the '<' button (move to previous page range)
        const prevRangeButton = document.createElement('button');
        prevRangeButton.textContent = '<';
        prevRangeButton.disabled = currentPage === 1; // Disable if on the first page
        prevRangeButton.addEventListener('click', () => changePageRange(-10)); // Adjust -10 based on range
        pagination.appendChild(prevRangeButton);

        // Calculate the number of pages and determine start and end for display
        const numPages = pages.length;
        let startPage, endPage;

        if (numPages <= 10) {
            // Show all pages if total pages are 10 or less
            startPage = 1;
            endPage = numPages;
        } else {
            // Show pages around the current page with a range of 10
            if (currentPage <= 5) {
                startPage = 1;
                endPage = 10;
            } else if (currentPage + 4 >= numPages) {
                startPage = numPages - 9;
                endPage = numPages;
            } else {
                startPage = currentPage - 5;
                endPage = currentPage + 4;
            }
        }

        // Add page number buttons
        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.disabled = i === currentPage; // Disable the current page button
            pageButton.addEventListener('click', () => {
                currentPage = i;
                displayPage(i,data); // Update the display for the selected page
            });
            pagination.appendChild(pageButton);
        }

        // Create the '>' button (move to next page range)
        const nextRangeButton = document.createElement('button');
        nextRangeButton.textContent = '>';
        nextRangeButton.disabled = currentPage === numPages; // Disable if on the last page
        nextRangeButton.addEventListener('click', () => changePageRange(10)); // Adjust +10 based on range
        pagination.appendChild(nextRangeButton);

        // Create the '>>' button (jump to last page)
        const lastPageButton = document.createElement('button');
        lastPageButton.textContent = '>>';
        lastPageButton.disabled = currentPage === numPages; // Disable if on the last page
        lastPageButton.addEventListener('click', () => changePage(numPages));
        pagination.appendChild(lastPageButton);

        // 在导入文件按钮左边添加删除按钮
        const deleteButton = document.createElement('button');
        deleteButton.textContent = '删除数据';
        deleteButton.classList.add('delete-button');
        deleteButton.style.marginRight = '10px';

        // 模态框事件
        deleteButton.addEventListener('click', () => {
            if (!stopClick()) return; // 如果返回 false，停止执行后续操作
            showDeleteModal(); // 点击按钮时显示模态框

        });

        pagination.appendChild(deleteButton); // 插入在导出按钮前

        const importButton = document.createElement('button');
        importButton.textContent = '导入文件';
        importButton.classList.add('import-button');
        importButton.style.marginRight = '10px';
        importButton.addEventListener('click', () => {
            if (!stopClick()) return; // 如果返回 false，停止执行后续操作
            // 创建一个隐藏的文件输入框
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx'; // 只允许选择 Excel 文件
            fileInput.style.display = 'none';
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    uploadExcelFile(file);
                }
            });
            document.body.appendChild(fileInput);
            fileInput.click();
            fileInput.remove();
        });

        pagination.appendChild(importButton); // 插入在导出按钮前


        const exportButton = document.createElement('button');
        exportButton.textContent = '导出文件';
        exportButton.classList.add('export-button');
        exportButton.style.marginRight = '10px';
        exportButton.addEventListener('click', () => {
            // if (!stopClick()) return; // 如果返回 false，停止执行后续操作
            exportToExcel(data); // 👈 你需要定义这个函数
        });
        pagination.appendChild(exportButton);

        // Create the 'Save' button
        const saveButton = document.createElement('button');
        saveButton.textContent = '保存';
        saveButton.classList.add('save-button');
        saveButton.addEventListener('click', () => {
            if (!stopClick()) return; // 如果返回 false，停止执行后续操作
            // 调用你自己的保存逻辑，例如：
            saveCurrentData(); // <-- 你要定义这个函数
        });
        pagination.appendChild(saveButton);


        // Remove the previous pagination and add the new one
        const existingPagination = container.querySelector('.pagination');
        if (existingPagination) {
            container.removeChild(existingPagination);
        }

        // Insert the new pagination at the beginning of the container
        container.insertBefore(pagination, container.firstChild);
    }

    function stopClick() {
        if (username !== "卢健" && username !== "李智龙" && username !== "戴杏华") {
            alert("只有卢健，李智龙，戴杏华可以触发此按钮");
            return false; // 阻止后续操作
        }
        return true; // 允许后续操作
    }

    function saveCurrentData() {
        const updatedItems = [];

        // 遍历所有页（而不仅是当前页），以支持跨页编辑
        pages.forEach(page => {
            page.forEach(item => {
                if (item._edited) {
                    const { _edited, ...dataToSend } = item;
                    updatedItems.push(dataToSend);
                }
            });
        });

        if (updatedItems.length === 0) {
            alert("没有检测到修改的数据");
            return;
        }

        console.log(updatedItems);


        fetch('/labModuleTester/saveChanges', {  // TODO: 替换为你的后端保存接口
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedItems)
        })
            .then(res => {
                if (res.ok) {
                    alert('保存成功');
                    // 保存成功后清除 _edited 标记
                    pages.forEach(page => {
                        page.forEach(item => delete item._edited);
                    });
                    performSearch(globalFormData);
                } else {
                    alert('保存失败，请稍后重试');
                }
            })
            .catch(err => {
                console.error('保存请求失败:', err);
                alert('请求出错，请检查网络');
            });
    }

    function showModal(id) {
        const modal = document.getElementById('modal-interface');
        const dataRows = document.getElementById('dataRows');

        // 清空旧数据
        dataRows.innerHTML = '';

        // 发送请求到后端，获取 ID 对应的数据
        fetch(`/getInterfaceData?id=${id}`)
            .then(response => response.json())
            .then(data => {
                interfaceInfoData = JSON.parse(JSON.stringify(data)); // 深拷贝，避免数据引用问题
                console.log("初始接口数据:", interfaceInfoData);

                if (interfaceInfoData.length > 0) {
                    interfaceInfoData.forEach((rowData, rowIndex) => {
                        // 创建一行
                        const row = document.createElement('div');
                        row.classList.add('modal-row');

                        rowData.forEach((item, colIndex) => {
                            // 创建 input 作为可编辑单元格
                            const cell = document.createElement('div');
                            cell.classList.add('modal-cell');

                            if (username === '戴杏华' || username === '卢健' || username === "李智龙") {
                                // 可编辑输入框
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.classList.add('modal-input');
                                input.value = item;
                                input.dataset.rowIndex = rowIndex;
                                input.dataset.colIndex = colIndex;

                                // 监听输入框变化
                                input.addEventListener('input', (event) => {
                                    let rIdx = event.target.dataset.rowIndex;
                                    let cIdx = event.target.dataset.colIndex;
                                    interfaceInfoData[rIdx][cIdx] = event.target.value.trim();
                                    console.log("更新后的数据:", interfaceInfoData);
                                });

                                cell.appendChild(input);
                            } else {
                                // 只读文本
                                cell.textContent = item;
                            }

                            row.appendChild(cell);
                        });

                        dataRows.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error("获取数据失败:", error);
                alert("无法加载数据");
            });

        // 显示模态框
        modal.style.display = 'block';

        // 关闭模态框
        const closeBtn = modal.querySelector('#closeModal');
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none'; // 隐藏模态框
        });

        // 监听 "新增一行" 按钮
        const addRowBtn = modal.querySelector('#addRowBtn');
        // 先移除旧的事件监听器，防止多次绑定
        addRowBtn.removeEventListener('click', handleAddRow);

        // 绑定新的事件监听器
        addRowBtn.addEventListener('click', handleAddRow);

    }


    // 显示模态框的函数

    function handleAddRow() {
        // 定义允许修改的用户名列表
        const allowedUsers = ["卢健", "戴杏华", "李智龙"];

        // 检查当前用户是否在允许的名单中
        if (!allowedUsers.includes(username)) {
            alert("你无权限修改数据，只有卢健、戴杏华和李智龙有权修改信息！");
            return; // 如果不在名单中，直接返回，不允许继续操作
        }

        // 如果用户在允许名单中，则执行添加行的操作
        addEditableRow();
    }

    function addEditableRow() {
        const dataRows = document.getElementById('dataRows');
        const newRow = document.createElement('div');
        newRow.classList.add('modal-row');

        // 获取当前行索引（用于存入 interfaceInfoData）
        const rowIndex = interfaceInfoData.length;

        // 创建输入框
        function createInputCell(colIndex) {
            const cell = document.createElement('div');
            cell.classList.add('modal-cell');

            const input = document.createElement('input');
            input.type = 'text';
            input.classList.add('modal-input');

            // 监听输入框的变化，实时更新 interfaceInfoData
            input.addEventListener('input', (event) => {
                interfaceInfoData[rowIndex][colIndex] = event.target.value || ""; // 清空时存入空字符串
            });

            cell.appendChild(input);
            return cell;
        }

        // 生成 3 列输入框
        newRow.appendChild(createInputCell(0));
        newRow.appendChild(createInputCell(1));
        newRow.appendChild(createInputCell(2));

        // 添加新行到数据区
        dataRows.appendChild(newRow);

        // 在 interfaceInfoData 中添加对应的空行
        interfaceInfoData.push(["", "", ""]);

        console.log(interfaceInfoData);
    }


    $(document).ready(function() {


        currentPage = 1;
        // 设置每页多少个问题点才分页
        pageSize = 15;


        $('.search-form').on('submit', function (event) {
            event.preventDefault(); // 防止表单的默认提交行为
            currentPage = 1;

            globalFormData = $(this).serialize();  // 获取表单数据

            performSearch(globalFormData);  // 执行搜索并传递表单数据
        });


        // Function to close the modal when ESC key is pressed
        function handleEscKey(event) {
            // Check if the pressed key is ESC (keyCode 27)
            if (event.key === 'Escape') {
                // Hide the modal by setting the display to 'none'
                document.getElementById('modal-interface').style.display = 'none';
            }
        }

        // Add event listener for keydown event to detect ESC key press
        document.addEventListener('keydown', handleEscKey);

        // 添加可编辑行
        document.getElementById('saveInterface').addEventListener('click', () => {
            if (!stopClick()) return; // 如果返回 false，停止执行后续操作
            // 更新 interfaceInfoData 中的内容
            const rows = document.querySelectorAll('#dataRows .modal-row');
            console.log("interfaceInfoData是",interfaceInfoData)
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 3) {
                    const interfaceType = inputs[0].value.trim();
                    const interfaceStandard = inputs[1].value.trim();
                    const interfaceQuantity = inputs[2].value.trim();

                    // 如果用户输入有效数据，更新 interfaceInfoData 中的对应项
                    if (interfaceType && interfaceStandard && interfaceQuantity) {
                        // 更新 interfaceInfoData 中的对应数组
                        interfaceInfoData[index] = [interfaceType, interfaceStandard, interfaceQuantity];
                    }
                }
            });


            // 发送数据到后端
            fetch(`/saveInterface?id=${interfaceId}`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(interfaceInfoData)  // 发送全部数据
            })
                .then(response => response.json())
                .then(data => {
                    console.log("服务器响应:", data);
                    alert(data.message);
                })
                .catch(error => {
                    console.error("错误:", error);
                    alert("提交失败");
                });
        });

    });


    function exportToExcel(data) {
        // 通过 AJAX 请求将数据导出
        $.ajax({
            url: '/labModuleTester/exportSystemInfo',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data), // 假设 data 是你的搜索结果数组
            xhrFields: {
                responseType: 'blob' // 指定响应为 blob
            },
            success: function(blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // 获取当前时间戳
                const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 14);
                a.download = `${timestamp}_实验室设备信息导出.xlsx`; // 👈 设置文件名

                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url); // 释放内存
            },
            error: function(xhr, status, error) {
                console.error('导出失败:', error);
            }
        });
    }

    function uploadExcelFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/labModuleTester/importSystemInfo',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) {
                alert('导入成功！已更新数据。');
                performSearch(globalFormData);
                // 如果你需要刷新数据，可以调用刷新方法
            },
            error: function(xhr, status, error) {
                console.error('导入失败:', error);
                alert('导入失败，请检查文件格式或联系管理员。');
            }
        });
    }


    document.getElementById('clearBtn').addEventListener('click', function() {
        // 清空所有输入字段
        document.querySelectorAll('.search-form input[type="text"], .search-form input[type="date"]').forEach(input => {
            input.value = '';
        });

        // 重置所有选择框
        document.querySelectorAll('.search-form select').forEach(select => {
            select.selectedIndex = 0; // 选择第一个选项
        });
    });

    // 打开模态框
    function showDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.style.display = 'flex';

        // 点击关闭按钮时隐藏模态框
        const closeButton = document.querySelector('.close-button');
        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // 点击模态框外部区域时关闭模态框
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // 提交删除请求
    document.getElementById('submitDelete').addEventListener('click', function () {
        const idRangeInput = document.getElementById('idRange').value;
        const idRange = parseIdRange(idRangeInput);

        if (idRange) {
            deleteDataByIdRange(idRange);
            document.getElementById('deleteModal').style.display = 'none'; // 关闭模态框
        } else {
            alert('请输入有效的ID或ID范围');
        }
    });

    // 解析用户输入的ID范围
    function parseIdRange(input) {
        const rangePattern = /^(\d+)-(\d+)$/; // 用来匹配范围格式，例如 "1-5"
        const singleIdPattern = /^\d+$/; // 用来匹配单个ID格式，例如 "1"
        const multipleIdsPattern = /^(\d+(?:,\s*\d+)*)$/; // 用来匹配多个ID，用逗号分隔，例如 "1, 3, 5"

        // 去除输入中的空格，并替换所有中文逗号为英文逗号
        input = input.replace(/\s+/g, ''); // 去除所有空格
        input = input.replace(/，/g, ','); // 替换中文逗号为英文逗号

        // 用正则分隔输入，根据逗号分隔
        const parts = input.split(',');

        let ids = [];

        parts.forEach(part => {
            // 如果是范围格式 "1-3"
            const matchRange = part.match(rangePattern);
            if (matchRange) {
                const start = parseInt(matchRange[1]);
                const end = parseInt(matchRange[2]);
                if (start <= end) {
                    for (let i = start; i <= end; i++) {
                        ids.push(i);
                    }
                }
            }
            // 如果是单个ID
            else if (singleIdPattern.test(part)) {
                ids.push(parseInt(part));
            }
        });

        // 去重操作：使用 Set 来移除重复的 ID
        ids = [...new Set(ids)];

        // 如果解析到了有效的ID
        if (ids.length > 0) {
            return { type: 'multiple', ids: ids };
        }

        return null; // 无效输入
    }


    // 向后端发送删除请求
    function deleteDataByIdRange(idRange) {
        const data = {
            idRange: idRange.ids // Ensure idRange is an object with ids as an array
        };

        $.ajax({
            url: '/labModuleTester/deleteSystemInfoByIds', // Backend delete API endpoint
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                alert('数据删除成功');
                performSearch(globalFormData);  // 执行搜索并传递表单数据
                // You can refresh data table or update other content here
            },
            error: function (error) {
                console.error('删除失败:', error);  // Log the error for debugging
                alert('删除失败');
            }
        });
    }








    // 添加点击事件监听器
    $(homeBtn).click(function() {

        // 跳转到主页
        window.location.href = '/home?role=' + encodeURIComponent(job);
    });

    $(cloudBtn).click(function() {
        let userRole = 'testMan'; // 示例角色，可以动态获取
        // 跳转到搜索资源库页面
        window.location.href = `/durationTable?dd_orientation=landscape&role=${userRole}`;
    });

    $(profileBtn).click(function() {
        // 跳转到个人界面页面
        window.location.href = '/testManProfile?role=' + encodeURIComponent(job);
    });



</script>


</body>
</html>
