<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå­å®éªŒå®¤è®¾å¤‡ä¿¡æ¯</title>
    <!-- å¼•å…¥å­—ä½“å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="/css/labModule.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>

<div class="sidebar">
    <ul class="nav-list">
        <li><a href="/labModuleTester" class="nav-link active">è®¾å¤‡ä¿¡æ¯</a></li>
        <li id="durationLink"><a href="#" class="nav-link">æµ‹è¯•æ—¶é•¿</a></li>
        <!--        <li><a href="page3.html" class="nav-link">é¡µé¢ 3</a></li>-->
    </ul>
</div>





<div class="header-container">
    <div class="title">ç”µå­å®éªŒå®¤æ¨¡å—</div>
    <button class="BackBtn" id="BackBtn" onclick="goToReturnPage()">è¿”å›<br>ä¸»é¡µ</button>
</div>


<div class="main-content">
    <div class="search-container">
        <form class="search-form">
            <!-- è®¾å¤‡id-->
            <div class="input-group">
                <label for="id">è®¾å¤‡ID:</label>
                <input type="text" id="id" name="id" placeholder="è®¾å¤‡ID">
            </div>

            <!-- ç»Ÿè®¡è´Ÿè´£äºº -->
            <div class="input-group">
                <label for="personCharge">ç»Ÿè®¡<br>äºº:</label>
                <input type="text" id="personCharge" name="personCharge" placeholder="">
            </div>

            <!-- è®¡ç®—æœºåç§° -->
            <div class="input-group">
                <label for="computerName">è®¾å¤‡<br>åç§°:</label>
                <input type="text" id="computerName" name="computerName" placeholder="">
            </div>

            <!-- å“ç‰Œ -->
            <div class="input-group">
                <label for="brand">å“ç‰Œ:</label>
                <input type="text" id="brand" name="brand" placeholder="">
            </div>

            <!-- åŒºåŸŸ -->
            <div class="input-group">
                <label for="area">åŒºåŸŸ:</label>
                <input type="text" id="area" name="area" placeholder="">
            </div>

            <!-- è®¾å¤‡ç±»å‹ -->
            <div class="input-group">
                <label for="deviceType">è®¾å¤‡<br>ç±»å‹:</label>
                <input type="text" id="deviceType" name="deviceType" placeholder="">
            </div>

            <!-- æ“ä½œç³»ç»Ÿç‰ˆæœ¬ -->
            <div class="input-group">
                <label for="version">æ“ä½œç³»ç»Ÿ<br>ç‰ˆæœ¬:</label>
                <input type="text" id="version" name="version" placeholder="å®¶åº­ä¸­æ–‡ç‰ˆ">
            </div>


            <!-- æ“ä½œç³»ç»Ÿè¯¦ç»†ç‰ˆæœ¬å· -->
            <div class="input-group">
                <label for="osVersion">ç³»ç»Ÿ<br>ç‰ˆæœ¬å·:</label>
                <input type="text" id="osVersion" name="osVersion" placeholder="22631.4460">
            </div>

            <div class="input-group">
                <label for="fullOS">ç‰ˆæœ¬<br>å·:</label>
                <input type="text" id="fullOS" name="fullOS" placeholder="23H2">
            </div>

            <!-- ç³»ç»Ÿæ¶æ„ -->
            <div class="input-group">
                <label for="architecture">ç³»ç»Ÿæ¶æ„:</label>
                <input type="text" id="architecture" name="architecture" placeholder="">
            </div>


            <!-- å¤„ç†å™¨ -->
            <div class="input-group">
                <label for="cpu">å¤„ç†å™¨:</label>
                <input type="text" id="cpu" name="cpu" placeholder="">
            </div>

            <!-- å†…å­˜ -->
            <div class="input-group">
                <label for="memory">å†…å­˜:</label>
                <input type="text" id="memory" name="memory" placeholder="">
            </div>

            <!-- æ˜¾å¡ -->
            <div class="input-group">
                <label for="displays">æ˜¾å¡:</label>
                <input type="text" id="displays" name="displays" placeholder="">
            </div>



            <!-- æœ€å¤§åˆ†è¾¨ç‡ -->
            <div class="input-group">
                <label for="maxResolution">æœ€å¤§åˆ†è¾¨ç‡:</label>
                <input type="text" id="maxResolution" name="maxResolution" placeholder="">
            </div>

            <!-- æœ€å¤§åˆ·æ–°ç‡ -->
            <div class="input-group">
                <label for="maxRefreshRate">æœ€å¤§åˆ·æ–°ç‡:</label>
                <input type="text" id="maxRefreshRate" name="maxRefreshRate" placeholder="">
            </div>

            <!-- æ¥å£ä¿¡æ¯ -->
            <div class="input-group">
                <label for="interfaceInfo">æ¥å£ä¿¡æ¯:</label>
                <input type="text" id="interfaceInfo" name="interfaceInfo" placeholder="">
            </div>


            <!--        &lt;!&ndash; æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨ &ndash;&gt;-->
            <!--        <div class="input-group date-range">-->
            <!--            <label>æäº¤<br>æ—¥æœŸ:</label>-->
            <!--            <input type="date" id="problemTimeStart" name="problemTimeStart" placeholder="å¼€å§‹æ—¥æœŸ"> &lt;!&ndash; æ·»åŠ  name å±æ€§ &ndash;&gt;-->
            <!--            <span class="date-separator">è‡³</span> &lt;!&ndash; æ·»åŠ â€œè‡³â€æ ‡ç­¾ &ndash;&gt;-->
            <!--            <input type="date" id="problemTimeEnd" name="problemTimeEnd" placeholder="ç»“æŸæ—¥æœŸ"> &lt;!&ndash; æ·»åŠ  name å±æ€§ &ndash;&gt;-->
            <!--        </div>-->

            <div class="input-group">
                <button type="button" id="clearBtn" class="clear-btn">æ¸…ç©ºé€‰é¡¹</button>
            </div>


            <!-- æœç´¢æŒ‰é’® -->
            <button type="submit">æœç´¢</button>

        </form>
    </div>
</div>


<!-- è¡¨æ ¼å®¹å™¨ -->
<div class="problemtable_container">
    <!-- è¿™é‡Œæ˜¯è¡¨æ ¼çš„å ä½ç¬¦ -->
    <!-- å®é™…è¡¨æ ¼å†…å®¹å¯ä»¥é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
</div>


<!-- ä¸‹æ–¹å›ºå®šæŒ‰é’® -->
<div class="btn-container">
    <hr class="divider"> <!-- æŒ‰é’®ä¸Šæ–¹çš„æ¨ªçº¿ -->
    <!-- ä¸»é¡µæŒ‰é’® -->
    <button class="btn" id="homeBtn"><i class="fas fa-home"></i></button>
    <!-- æœç´¢èµ„æºåº“æŒ‰é’® -->
    <button class="btn" id="cloudBtn"><i class="fas fa-cloud"></i></button>
    <!-- ä¸ªäººç•Œé¢æŒ‰é’® -->
    <button class="btn" id="profileBtn"><i class="fas fa-user"></i></button>
</div>

<!-- æ¨¡æ€æ¡†çš„ HTML ç»“æ„ -->
<div id="alert-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div id="alert-modal" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
        <div id="alert-message" style="margin-bottom: 20px;">æç¤ºä¿¡æ¯</div>
        <button id="alert-confirm" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®è®¤</button>
    </div>
</div>

<!-- æ¨¡æ€æ¡† -->
<!-- Modal for Interface Details -->
<div id="modal-interface" style="display: none;">
    <div class="modal-content">
        <h3>æ¥å£ä¿¡æ¯</h3>

        <!-- Display the header row (column names) -->
        <div class="modal-row">
            <div class="modal-cell">æ¥å£ç±»å‹</div>
            <div class="modal-cell">æ¥å£æ ‡å‡†</div>
            <div class="modal-cell">æ¥å£æ•°é‡</div>
        </div>

        <!-- Display dynamic data rows -->
        <div id="dataRows"></div>

        <div>
            <button id="addRowBtn">æ–°å¢è¡Œ</button>
            <button id="saveInterface">ä¿å­˜æ•°æ®</button>
            <button id="closeModal">å…³é—­</button>
        </div>
    </div>
</div>

<!-- æ¨¡æ€æ¡† -->
<div id="deleteModal" class="deleteModal" style="display: none;">
    <div class="deleteModal-content">
        <span class="close-button">&times;</span>
        <h2>åˆ é™¤æ•°æ®</h2>
        <label for="idRange">è¯·è¾“å…¥åˆ é™¤çš„ IDï¼ˆå•ä¸ªã€èŒƒå›´æˆ–å¤šä¸ªï¼Œç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
        <input type="text" id="idRange" placeholder="ä¾‹å¦‚: 1, 3, 5 æˆ– 1-5">
        <button id="submitDelete">æäº¤</button>
    </div>
</div>


<script>
    // è¦†ç›–åŸç”Ÿ alert æ–¹æ³•
    window.alert = function(message) {
        // è·å–æ¨¡æ€æ¡†å…ƒç´ 
        const overlay = document.getElementById('alert-overlay');
        const modal = document.getElementById('alert-modal');
        const messageElem = document.getElementById('alert-message');
        const confirmButton = document.getElementById('alert-confirm');

        // è®¾ç½®æ¶ˆæ¯æ–‡æœ¬
        messageElem.textContent = message;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        overlay.style.display = 'block';
        modal.style.display = 'block';

        // ç‚¹å‡»ç¡®è®¤æŒ‰é’®æ—¶å…³é—­æ¨¡æ€æ¡†
        confirmButton.onclick = () => {
            overlay.style.display = 'none';
            modal.style.display = 'none';
            // è°ƒç”¨åŸæœ¬çš„alertå›è°ƒ
        };
    };

    let currentPage;
    let globalFormData ;
    let pageSize;
    let pages = []; // ç”¨äºå­˜å‚¨åˆ†é¡µæ•°æ®

    let interfaceInfoData = [];
    let interfaceId;
    // const username = sessionStorage.getItem('username');
    // const job = localStorage.getItem("job");

    const username = "å¢å¥";
    const job = "tester";


    // è·å– a æ ‡ç­¾å¹¶ä¿®æ”¹å…¶ href å±æ€§
    var linkElement = document.querySelector("#durationLink a");
    linkElement.href = "/durationTable?role=" + encodeURIComponent(job);

    // å®šä¹‰è·³è½¬å‡½æ•°
    function goToReturnPage() {
        // æ‹¼æ¥ URL å¹¶è·³è½¬
        window.location.href = '/returnBtn?role=' + encodeURIComponent(job);
    }

    function readyConfig(){
        // è°ƒç”¨åç«¯æ¥å£è·å–é…ç½®ä¿¡æ¯
        $.ajax({
            url: '/getJsapiConfig',
            type: 'GET',
            data: { url: encodeURIComponent(location.href.split('#')[0]) },
            success: function(config) {
                // ä½¿ç”¨è·å–çš„é…ç½®ä¿¡æ¯åˆå§‹åŒ–é’‰é’‰JSAPI
                dd.config({
                    agentId: config.agentId,
                    corpId: config.corpId,
                    timeStamp: config.timeStamp,
                    nonceStr: config.nonceStr,
                    signature: config.signature,
                    jsApiList: config.jsApiList // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„jsapiåˆ—è¡¨
                });

            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function performSearch(formData) {
        // å‘èµ· AJAX è¯·æ±‚
        $.ajax({
            url: '/labModule/performSysInfo',
            type: 'GET',
            dataType: 'json',
            data: formData, // ä½¿ç”¨è¡¨å•æ•°æ®è¿›è¡Œæœç´¢
            success: function (data) {
                // æ¸…ç©ºä¸Šä¸€æ¬¡çš„ç»“æœ
                pages = []; // é‡ç½®åˆ†é¡µæ•°æ®
                const tableContainer = document.querySelector('.problemtable_container');
                tableContainer.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å®¹å™¨

                // å¤„ç†æœç´¢ç»“æœ
                pages = paginateData(data, pageSize);
                // currentPage = 1; // é‡ç½®å½“å‰é¡µ
                displayPage(currentPage,data);
            },
            error: function (xhr, status, error) {
                console.error('æœç´¢è¯·æ±‚å¤±è´¥:', error);
                console.log(xhr.responseText); // æ‰“å°å“åº”ä½“ä»¥è·å–æ›´å¤šä¿¡æ¯
            }
        });
    }

    function paginateData(data, pageSize) {
        const pages = [];
        for (let i = 0; i < data.length; i += pageSize) {
            pages.push(data.slice(i, i + pageSize));
        }
        return pages;
    }

    function displayPage(pageNum, data) {
        if (pageNum < 1 || pageNum > pages.length) return;

        currentPage = pageNum;

        const tableContainer = document.querySelector('.problemtable_container');
        tableContainer.innerHTML = '';

        const pageData = pages[pageNum - 1] || [];
        const table = document.createElement('table');
        table.classList.add('result-table');

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const headers = [
            "è®¾å¤‡ID", "ç»Ÿè®¡äºº", "åç§°", "å“ç‰Œ", "åŒºåŸŸ", "è®¾å¤‡ç±»å‹" ,"æ“ä½œç³»ç»Ÿç‰ˆæœ¬",  "æ“ä½œç³»ç»Ÿè¯¦ç»†ç‰ˆæœ¬å·", "ç‰ˆæœ¬å·", "ç³»ç»Ÿæ¶æ„",
            "è®°å½•æ›´æ–°æ—¶é—´", "å¤„ç†å™¨", "å†…å­˜", "æ˜¾å¡", "æœ€å¤§åˆ†è¾¨ç‡", "æœ€å¤§åˆ·æ–°ç‡", "æ¥å£ä¿¡æ¯" , "è®¾å¤‡å‘å¸ƒæ—¥æœŸ", "è®¾å¤‡è´­ä¹°æ—¥æœŸ", "è®¾å¤‡ç»´ä¿®è®°å½•"
        ];

        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        pageData.forEach(item => {
            const row = document.createElement('tr');

            const cells = [
                item.id,item.personCharge, item.computerName,item.brand, item.area, item.deviceType, item.version, item.osVersion, item.fullOS,
                item.architecture, item.created_at, item.cpu, item.memory,
                item.displays,  item.maxResolution, item.maxRefreshRate,
                item.interfaceInfo, item.deviceReleaseDate, item.devicePurchaseDate , item.deviceRepairHistory
            ];

            const allowedUsers = ["ææ™ºé¾™", "å¢å¥", "æˆ´æå"]; // å…è®¸ç¼–è¾‘çš„ç”¨æˆ·å
            cells.forEach((cellData, index) => {
                const td = document.createElement('td');
                td.textContent = cellData ? cellData : '/';

                const nonEditableFields = ["è®¾å¤‡ID", "è®°å½•æ›´æ–°æ—¶é—´"];
                const isNonEditable = nonEditableFields.includes(headers[index]);

                const isInterfaceColumn = headers[index] === "æ¥å£ä¿¡æ¯";
                const isDateTimeField = headers[index] === "æ“ä½œç³»ç»Ÿå®‰è£…æ—¥æœŸ";

                // åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å¯ä»¥ç¼–è¾‘
                const canEdit = allowedUsers.includes(username); // åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­

                if (isInterfaceColumn) {
                    td.style.cursor = 'pointer';
                    td.addEventListener('click', () => {
                        interfaceId = item.id;
                        showModal(item.id);
                    });
                } else if (!isNonEditable && canEdit) {
                    td.style.cursor = 'pointer';

                    td.addEventListener('click', function () {
                        if (td.querySelector('textarea') || td.querySelector('input')) return;

                        const currentText = td.textContent.trim();
                        td.innerHTML = '';
                        row.classList.add('editing-row');

                        const fieldKeys = [
                            "id", "personCharge","computerName", "brand", "area","deviceType", "version", "osVersion", "fullOS",
                            "architecture", "created_at", "cpu", "memory",
                            "displays", "maxResolution", "maxRefreshRate", "interfaceInfo",
                            "deviceReleaseDate", "devicePurchaseDate", "deviceRepairHistory"
                        ];
                        const key = fieldKeys[index];

                        if (isDateTimeField) {
                            const input = document.createElement('input');
                            input.type = 'datetime-local';
                            input.classList.add('editable-datetime');

                            // å°† "2025-03-18 09:06:36" è½¬ä¸º "2025-03-18T09:06:36"
                            let formattedValue = '';
                            if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(currentText)) {
                                formattedValue = currentText.replace(' ', 'T');
                            }
                            input.value = formattedValue;

                            td.appendChild(input);
                            input.focus();

                            input.addEventListener('blur', () => {
                                const newValue = input.value;
                                const finalValue = newValue ? newValue.replace('T', ' ') + ':00'.substring(newValue.length === 16 ? 0 : 3) : '/';
                                td.textContent = finalValue;
                                row.classList.remove('editing-row');

                                item[key] = finalValue;
                                item._edited = true;
                                console.log(key, finalValue);
                            });

                        } else {
                            // æ™®é€šå­—æ®µï¼štextarea
                            const textarea = document.createElement('textarea');
                            textarea.value = currentText === '/' ? '' : currentText;
                            textarea.classList.add('editable-textarea');

                            td.appendChild(textarea);
                            textarea.focus();
                            autoResize(textarea);

                            textarea.addEventListener('input', () => {
                                autoResize(textarea);
                            });

                            textarea.addEventListener('blur', () => {
                                const newValue = textarea.value.trim();
                                td.textContent = newValue || '/';
                                row.classList.remove('editing-row');

                                item[key] = newValue;
                                item._edited = true;
                                console.log(key, newValue);
                            });

                            textarea.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    textarea.blur();
                                }
                            });
                        }
                    });
                } else {
                    // å¦‚æœä¸èƒ½ç¼–è¾‘ï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬å†…å®¹
                    td.style.cursor = 'default';
                }

                row.appendChild(td);
            });

            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableContainer.appendChild(table);

        updatePagination(tableContainer, data);
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto'; // å…ˆæ¸…ç©ºé«˜åº¦
        textarea.style.height = textarea.scrollHeight + 'px'; // å†è®¾ä¸ºå†…å®¹é«˜åº¦
    }


    function updatePagination(container,data) {
        const pagination = document.createElement('div');
        pagination.classList.add('pagination');

        // Function to change page without reloading data
        function changePage(newPage) {
            currentPage = newPage;
            updatePagination(container,data); // Refresh pagination buttons only
            displayPage(currentPage,data); // Update the display for the selected page
        }

        // Function to change page range and adjust current page
        function changePageRange(step) {
            let newPage = currentPage + step;
            if (newPage < 1) newPage = 1; // Ensure newPage does not go below 1
            if (newPage > pages.length) newPage = pages.length; // Ensure newPage does not exceed numPages
            changePage(newPage);
        }

        // Create the '<<' button (jump to first page)
        const firstPageButton = document.createElement('button');
        firstPageButton.textContent = '<<';
        firstPageButton.disabled = currentPage === 1; // Disable if on the first page
        firstPageButton.addEventListener('click', () => changePage(1));
        pagination.appendChild(firstPageButton);

        // Create the '<' button (move to previous page range)
        const prevRangeButton = document.createElement('button');
        prevRangeButton.textContent = '<';
        prevRangeButton.disabled = currentPage === 1; // Disable if on the first page
        prevRangeButton.addEventListener('click', () => changePageRange(-10)); // Adjust -10 based on range
        pagination.appendChild(prevRangeButton);

        // Calculate the number of pages and determine start and end for display
        const numPages = pages.length;
        let startPage, endPage;

        if (numPages <= 10) {
            // Show all pages if total pages are 10 or less
            startPage = 1;
            endPage = numPages;
        } else {
            // Show pages around the current page with a range of 10
            if (currentPage <= 5) {
                startPage = 1;
                endPage = 10;
            } else if (currentPage + 4 >= numPages) {
                startPage = numPages - 9;
                endPage = numPages;
            } else {
                startPage = currentPage - 5;
                endPage = currentPage + 4;
            }
        }

        // Add page number buttons
        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.disabled = i === currentPage; // Disable the current page button
            pageButton.addEventListener('click', () => {
                currentPage = i;
                displayPage(i,data); // Update the display for the selected page
            });
            pagination.appendChild(pageButton);
        }

        // Create the '>' button (move to next page range)
        const nextRangeButton = document.createElement('button');
        nextRangeButton.textContent = '>';
        nextRangeButton.disabled = currentPage === numPages; // Disable if on the last page
        nextRangeButton.addEventListener('click', () => changePageRange(10)); // Adjust +10 based on range
        pagination.appendChild(nextRangeButton);

        // Create the '>>' button (jump to last page)
        const lastPageButton = document.createElement('button');
        lastPageButton.textContent = '>>';
        lastPageButton.disabled = currentPage === numPages; // Disable if on the last page
        lastPageButton.addEventListener('click', () => changePage(numPages));
        pagination.appendChild(lastPageButton);

        // åœ¨å¯¼å…¥æ–‡ä»¶æŒ‰é’®å·¦è¾¹æ·»åŠ åˆ é™¤æŒ‰é’®
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'åˆ é™¤æ•°æ®';
        deleteButton.classList.add('delete-button');
        deleteButton.style.marginRight = '10px';

        // æ¨¡æ€æ¡†äº‹ä»¶
        deleteButton.addEventListener('click', () => {
            if (!stopClick()) return; // å¦‚æœè¿”å› falseï¼Œåœæ­¢æ‰§è¡Œåç»­æ“ä½œ
            showDeleteModal(); // ç‚¹å‡»æŒ‰é’®æ—¶æ˜¾ç¤ºæ¨¡æ€æ¡†

        });

        pagination.appendChild(deleteButton); // æ’å…¥åœ¨å¯¼å‡ºæŒ‰é’®å‰

        const importButton = document.createElement('button');
        importButton.textContent = 'å¯¼å…¥æ–‡ä»¶';
        importButton.classList.add('import-button');
        importButton.style.marginRight = '10px';
        importButton.addEventListener('click', () => {
            if (!stopClick()) return; // å¦‚æœè¿”å› falseï¼Œåœæ­¢æ‰§è¡Œåç»­æ“ä½œ
            // åˆ›å»ºä¸€ä¸ªéšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx'; // åªå…è®¸é€‰æ‹© Excel æ–‡ä»¶
            fileInput.style.display = 'none';
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    uploadExcelFile(file);
                }
            });
            document.body.appendChild(fileInput);
            fileInput.click();
            fileInput.remove();
        });

        pagination.appendChild(importButton); // æ’å…¥åœ¨å¯¼å‡ºæŒ‰é’®å‰


        const exportButton = document.createElement('button');
        exportButton.textContent = 'å¯¼å‡ºæ–‡ä»¶';
        exportButton.classList.add('export-button');
        exportButton.style.marginRight = '10px';
        exportButton.addEventListener('click', () => {
            // if (!stopClick()) return; // å¦‚æœè¿”å› falseï¼Œåœæ­¢æ‰§è¡Œåç»­æ“ä½œ
            exportToExcel(data); // ğŸ‘ˆ ä½ éœ€è¦å®šä¹‰è¿™ä¸ªå‡½æ•°
        });
        pagination.appendChild(exportButton);

        // Create the 'Save' button
        const saveButton = document.createElement('button');
        saveButton.textContent = 'ä¿å­˜';
        saveButton.classList.add('save-button');
        saveButton.addEventListener('click', () => {
            if (!stopClick()) return; // å¦‚æœè¿”å› falseï¼Œåœæ­¢æ‰§è¡Œåç»­æ“ä½œ
            // è°ƒç”¨ä½ è‡ªå·±çš„ä¿å­˜é€»è¾‘ï¼Œä¾‹å¦‚ï¼š
            saveCurrentData(); // <-- ä½ è¦å®šä¹‰è¿™ä¸ªå‡½æ•°
        });
        pagination.appendChild(saveButton);


        // Remove the previous pagination and add the new one
        const existingPagination = container.querySelector('.pagination');
        if (existingPagination) {
            container.removeChild(existingPagination);
        }

        // Insert the new pagination at the beginning of the container
        container.insertBefore(pagination, container.firstChild);
    }

    function stopClick() {
        if (username !== "å¢å¥" && username !== "ææ™ºé¾™" && username !== "æˆ´æå") {
            alert("åªæœ‰å¢å¥ï¼Œææ™ºé¾™ï¼Œæˆ´æåå¯ä»¥è§¦å‘æ­¤æŒ‰é’®");
            return false; // é˜»æ­¢åç»­æ“ä½œ
        }
        return true; // å…è®¸åç»­æ“ä½œ
    }

    function saveCurrentData() {
        const updatedItems = [];

        // éå†æ‰€æœ‰é¡µï¼ˆè€Œä¸ä»…æ˜¯å½“å‰é¡µï¼‰ï¼Œä»¥æ”¯æŒè·¨é¡µç¼–è¾‘
        pages.forEach(page => {
            page.forEach(item => {
                if (item._edited) {
                    const { _edited, ...dataToSend } = item;
                    updatedItems.push(dataToSend);
                }
            });
        });

        if (updatedItems.length === 0) {
            alert("æ²¡æœ‰æ£€æµ‹åˆ°ä¿®æ”¹çš„æ•°æ®");
            return;
        }

        console.log(updatedItems);


        fetch('/labModuleTester/saveChanges', {  // TODO: æ›¿æ¢ä¸ºä½ çš„åç«¯ä¿å­˜æ¥å£
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedItems)
        })
            .then(res => {
                if (res.ok) {
                    alert('ä¿å­˜æˆåŠŸ');
                    // ä¿å­˜æˆåŠŸåæ¸…é™¤ _edited æ ‡è®°
                    pages.forEach(page => {
                        page.forEach(item => delete item._edited);
                    });
                    performSearch(globalFormData);
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            })
            .catch(err => {
                console.error('ä¿å­˜è¯·æ±‚å¤±è´¥:', err);
                alert('è¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            });
    }

    function showModal(id) {
        const modal = document.getElementById('modal-interface');
        const dataRows = document.getElementById('dataRows');

        // æ¸…ç©ºæ—§æ•°æ®
        dataRows.innerHTML = '';

        // å‘é€è¯·æ±‚åˆ°åç«¯ï¼Œè·å– ID å¯¹åº”çš„æ•°æ®
        fetch(`/getInterfaceData?id=${id}`)
            .then(response => response.json())
            .then(data => {
                interfaceInfoData = JSON.parse(JSON.stringify(data)); // æ·±æ‹·è´ï¼Œé¿å…æ•°æ®å¼•ç”¨é—®é¢˜
                console.log("åˆå§‹æ¥å£æ•°æ®:", interfaceInfoData);

                if (interfaceInfoData.length > 0) {
                    interfaceInfoData.forEach((rowData, rowIndex) => {
                        // åˆ›å»ºä¸€è¡Œ
                        const row = document.createElement('div');
                        row.classList.add('modal-row');

                        rowData.forEach((item, colIndex) => {
                            // åˆ›å»º input ä½œä¸ºå¯ç¼–è¾‘å•å…ƒæ ¼
                            const cell = document.createElement('div');
                            cell.classList.add('modal-cell');

                            if (username === 'æˆ´æå' || username === 'å¢å¥' || username === "ææ™ºé¾™") {
                                // å¯ç¼–è¾‘è¾“å…¥æ¡†
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.classList.add('modal-input');
                                input.value = item;
                                input.dataset.rowIndex = rowIndex;
                                input.dataset.colIndex = colIndex;

                                // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
                                input.addEventListener('input', (event) => {
                                    let rIdx = event.target.dataset.rowIndex;
                                    let cIdx = event.target.dataset.colIndex;
                                    interfaceInfoData[rIdx][cIdx] = event.target.value.trim();
                                    console.log("æ›´æ–°åçš„æ•°æ®:", interfaceInfoData);
                                });

                                cell.appendChild(input);
                            } else {
                                // åªè¯»æ–‡æœ¬
                                cell.textContent = item;
                            }

                            row.appendChild(cell);
                        });

                        dataRows.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error("è·å–æ•°æ®å¤±è´¥:", error);
                alert("æ— æ³•åŠ è½½æ•°æ®");
            });

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'block';

        // å…³é—­æ¨¡æ€æ¡†
        const closeBtn = modal.querySelector('#closeModal');
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none'; // éšè—æ¨¡æ€æ¡†
        });

        // ç›‘å¬ "æ–°å¢ä¸€è¡Œ" æŒ‰é’®
        const addRowBtn = modal.querySelector('#addRowBtn');
        // å…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢å¤šæ¬¡ç»‘å®š
        addRowBtn.removeEventListener('click', handleAddRow);

        // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
        addRowBtn.addEventListener('click', handleAddRow);

    }


    // æ˜¾ç¤ºæ¨¡æ€æ¡†çš„å‡½æ•°

    function handleAddRow() {
        // å®šä¹‰å…è®¸ä¿®æ”¹çš„ç”¨æˆ·ååˆ—è¡¨
        const allowedUsers = ["å¢å¥", "æˆ´æå", "ææ™ºé¾™"];

        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦åœ¨å…è®¸çš„åå•ä¸­
        if (!allowedUsers.includes(username)) {
            alert("ä½ æ— æƒé™ä¿®æ”¹æ•°æ®ï¼Œåªæœ‰å¢å¥ã€æˆ´æåå’Œææ™ºé¾™æœ‰æƒä¿®æ”¹ä¿¡æ¯ï¼");
            return; // å¦‚æœä¸åœ¨åå•ä¸­ï¼Œç›´æ¥è¿”å›ï¼Œä¸å…è®¸ç»§ç»­æ“ä½œ
        }

        // å¦‚æœç”¨æˆ·åœ¨å…è®¸åå•ä¸­ï¼Œåˆ™æ‰§è¡Œæ·»åŠ è¡Œçš„æ“ä½œ
        addEditableRow();
    }

    function addEditableRow() {
        const dataRows = document.getElementById('dataRows');
        const newRow = document.createElement('div');
        newRow.classList.add('modal-row');

        // è·å–å½“å‰è¡Œç´¢å¼•ï¼ˆç”¨äºå­˜å…¥ interfaceInfoDataï¼‰
        const rowIndex = interfaceInfoData.length;

        // åˆ›å»ºè¾“å…¥æ¡†
        function createInputCell(colIndex) {
            const cell = document.createElement('div');
            cell.classList.add('modal-cell');

            const input = document.createElement('input');
            input.type = 'text';
            input.classList.add('modal-input');

            // ç›‘å¬è¾“å…¥æ¡†çš„å˜åŒ–ï¼Œå®æ—¶æ›´æ–° interfaceInfoData
            input.addEventListener('input', (event) => {
                interfaceInfoData[rowIndex][colIndex] = event.target.value || ""; // æ¸…ç©ºæ—¶å­˜å…¥ç©ºå­—ç¬¦ä¸²
            });

            cell.appendChild(input);
            return cell;
        }

        // ç”Ÿæˆ 3 åˆ—è¾“å…¥æ¡†
        newRow.appendChild(createInputCell(0));
        newRow.appendChild(createInputCell(1));
        newRow.appendChild(createInputCell(2));

        // æ·»åŠ æ–°è¡Œåˆ°æ•°æ®åŒº
        dataRows.appendChild(newRow);

        // åœ¨ interfaceInfoData ä¸­æ·»åŠ å¯¹åº”çš„ç©ºè¡Œ
        interfaceInfoData.push(["", "", ""]);

        console.log(interfaceInfoData);
    }


    $(document).ready(function() {


        currentPage = 1;
        // è®¾ç½®æ¯é¡µå¤šå°‘ä¸ªé—®é¢˜ç‚¹æ‰åˆ†é¡µ
        pageSize = 15;


        $('.search-form').on('submit', function (event) {
            event.preventDefault(); // é˜²æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸º
            currentPage = 1;

            globalFormData = $(this).serialize();  // è·å–è¡¨å•æ•°æ®

            performSearch(globalFormData);  // æ‰§è¡Œæœç´¢å¹¶ä¼ é€’è¡¨å•æ•°æ®
        });


        // Function to close the modal when ESC key is pressed
        function handleEscKey(event) {
            // Check if the pressed key is ESC (keyCode 27)
            if (event.key === 'Escape') {
                // Hide the modal by setting the display to 'none'
                document.getElementById('modal-interface').style.display = 'none';
            }
        }

        // Add event listener for keydown event to detect ESC key press
        document.addEventListener('keydown', handleEscKey);

        // æ·»åŠ å¯ç¼–è¾‘è¡Œ
        document.getElementById('saveInterface').addEventListener('click', () => {
            if (!stopClick()) return; // å¦‚æœè¿”å› falseï¼Œåœæ­¢æ‰§è¡Œåç»­æ“ä½œ
            // æ›´æ–° interfaceInfoData ä¸­çš„å†…å®¹
            const rows = document.querySelectorAll('#dataRows .modal-row');
            console.log("interfaceInfoDataæ˜¯",interfaceInfoData)
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 3) {
                    const interfaceType = inputs[0].value.trim();
                    const interfaceStandard = inputs[1].value.trim();
                    const interfaceQuantity = inputs[2].value.trim();

                    // å¦‚æœç”¨æˆ·è¾“å…¥æœ‰æ•ˆæ•°æ®ï¼Œæ›´æ–° interfaceInfoData ä¸­çš„å¯¹åº”é¡¹
                    if (interfaceType && interfaceStandard && interfaceQuantity) {
                        // æ›´æ–° interfaceInfoData ä¸­çš„å¯¹åº”æ•°ç»„
                        interfaceInfoData[index] = [interfaceType, interfaceStandard, interfaceQuantity];
                    }
                }
            });


            // å‘é€æ•°æ®åˆ°åç«¯
            fetch(`/saveInterface?id=${interfaceId}`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(interfaceInfoData)  // å‘é€å…¨éƒ¨æ•°æ®
            })
                .then(response => response.json())
                .then(data => {
                    console.log("æœåŠ¡å™¨å“åº”:", data);
                    alert(data.message);
                })
                .catch(error => {
                    console.error("é”™è¯¯:", error);
                    alert("æäº¤å¤±è´¥");
                });
        });

    });


    function exportToExcel(data) {
        // é€šè¿‡ AJAX è¯·æ±‚å°†æ•°æ®å¯¼å‡º
        $.ajax({
            url: '/labModuleTester/exportSystemInfo',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data), // å‡è®¾ data æ˜¯ä½ çš„æœç´¢ç»“æœæ•°ç»„
            xhrFields: {
                responseType: 'blob' // æŒ‡å®šå“åº”ä¸º blob
            },
            success: function(blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // è·å–å½“å‰æ—¶é—´æˆ³
                const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 14);
                a.download = `${timestamp}_å®éªŒå®¤è®¾å¤‡ä¿¡æ¯å¯¼å‡º.xlsx`; // ğŸ‘ˆ è®¾ç½®æ–‡ä»¶å

                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url); // é‡Šæ”¾å†…å­˜
            },
            error: function(xhr, status, error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
            }
        });
    }

    function uploadExcelFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/labModuleTester/importSystemInfo',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) {
                alert('å¯¼å…¥æˆåŠŸï¼å·²æ›´æ–°æ•°æ®ã€‚');
                performSearch(globalFormData);
                // å¦‚æœä½ éœ€è¦åˆ·æ–°æ•°æ®ï¼Œå¯ä»¥è°ƒç”¨åˆ·æ–°æ–¹æ³•
            },
            error: function(xhr, status, error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
            }
        });
    }


    document.getElementById('clearBtn').addEventListener('click', function() {
        // æ¸…ç©ºæ‰€æœ‰è¾“å…¥å­—æ®µ
        document.querySelectorAll('.search-form input[type="text"], .search-form input[type="date"]').forEach(input => {
            input.value = '';
        });

        // é‡ç½®æ‰€æœ‰é€‰æ‹©æ¡†
        document.querySelectorAll('.search-form select').forEach(select => {
            select.selectedIndex = 0; // é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
        });
    });

    // æ‰“å¼€æ¨¡æ€æ¡†
    function showDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.style.display = 'flex';

        // ç‚¹å‡»å…³é—­æŒ‰é’®æ—¶éšè—æ¨¡æ€æ¡†
        const closeButton = document.querySelector('.close-button');
        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨åŒºåŸŸæ—¶å…³é—­æ¨¡æ€æ¡†
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // æäº¤åˆ é™¤è¯·æ±‚
    document.getElementById('submitDelete').addEventListener('click', function () {
        const idRangeInput = document.getElementById('idRange').value;
        const idRange = parseIdRange(idRangeInput);

        if (idRange) {
            deleteDataByIdRange(idRange);
            document.getElementById('deleteModal').style.display = 'none'; // å…³é—­æ¨¡æ€æ¡†
        } else {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„IDæˆ–IDèŒƒå›´');
        }
    });

    // è§£æç”¨æˆ·è¾“å…¥çš„IDèŒƒå›´
    function parseIdRange(input) {
        const rangePattern = /^(\d+)-(\d+)$/; // ç”¨æ¥åŒ¹é…èŒƒå›´æ ¼å¼ï¼Œä¾‹å¦‚ "1-5"
        const singleIdPattern = /^\d+$/; // ç”¨æ¥åŒ¹é…å•ä¸ªIDæ ¼å¼ï¼Œä¾‹å¦‚ "1"
        const multipleIdsPattern = /^(\d+(?:,\s*\d+)*)$/; // ç”¨æ¥åŒ¹é…å¤šä¸ªIDï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ "1, 3, 5"

        // å»é™¤è¾“å…¥ä¸­çš„ç©ºæ ¼ï¼Œå¹¶æ›¿æ¢æ‰€æœ‰ä¸­æ–‡é€—å·ä¸ºè‹±æ–‡é€—å·
        input = input.replace(/\s+/g, ''); // å»é™¤æ‰€æœ‰ç©ºæ ¼
        input = input.replace(/ï¼Œ/g, ','); // æ›¿æ¢ä¸­æ–‡é€—å·ä¸ºè‹±æ–‡é€—å·

        // ç”¨æ­£åˆ™åˆ†éš”è¾“å…¥ï¼Œæ ¹æ®é€—å·åˆ†éš”
        const parts = input.split(',');

        let ids = [];

        parts.forEach(part => {
            // å¦‚æœæ˜¯èŒƒå›´æ ¼å¼ "1-3"
            const matchRange = part.match(rangePattern);
            if (matchRange) {
                const start = parseInt(matchRange[1]);
                const end = parseInt(matchRange[2]);
                if (start <= end) {
                    for (let i = start; i <= end; i++) {
                        ids.push(i);
                    }
                }
            }
            // å¦‚æœæ˜¯å•ä¸ªID
            else if (singleIdPattern.test(part)) {
                ids.push(parseInt(part));
            }
        });

        // å»é‡æ“ä½œï¼šä½¿ç”¨ Set æ¥ç§»é™¤é‡å¤çš„ ID
        ids = [...new Set(ids)];

        // å¦‚æœè§£æåˆ°äº†æœ‰æ•ˆçš„ID
        if (ids.length > 0) {
            return { type: 'multiple', ids: ids };
        }

        return null; // æ— æ•ˆè¾“å…¥
    }


    // å‘åç«¯å‘é€åˆ é™¤è¯·æ±‚
    function deleteDataByIdRange(idRange) {
        const data = {
            idRange: idRange.ids // Ensure idRange is an object with ids as an array
        };

        $.ajax({
            url: '/labModuleTester/deleteSystemInfoByIds', // Backend delete API endpoint
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                alert('æ•°æ®åˆ é™¤æˆåŠŸ');
                performSearch(globalFormData);  // æ‰§è¡Œæœç´¢å¹¶ä¼ é€’è¡¨å•æ•°æ®
                // You can refresh data table or update other content here
            },
            error: function (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);  // Log the error for debugging
                alert('åˆ é™¤å¤±è´¥');
            }
        });
    }








    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    $(homeBtn).click(function() {

        // è·³è½¬åˆ°ä¸»é¡µ
        window.location.href = '/home?role=' + encodeURIComponent(job);
    });

    $(cloudBtn).click(function() {
        let userRole = 'testMan'; // ç¤ºä¾‹è§’è‰²ï¼Œå¯ä»¥åŠ¨æ€è·å–
        // è·³è½¬åˆ°æœç´¢èµ„æºåº“é¡µé¢
        window.location.href = `/durationTable?dd_orientation=landscape&role=${userRole}`;
    });

    $(profileBtn).click(function() {
        // è·³è½¬åˆ°ä¸ªäººç•Œé¢é¡µé¢
        window.location.href = '/testManProfile?role=' + encodeURIComponent(job);
    });



</script>


</body>
</html>
