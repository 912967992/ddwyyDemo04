<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”å‘æ•°æ®çœ‹æ¿</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 80px 20px 20px;
            background: #f5f5f5;
        }
        .BackBtn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
        }
        .BackBtn:hover { background: #0056b3; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #333; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
        }
        .card-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            color: #333;
        }
        .card-description {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin-bottom: 25px;
        }
        .chart-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        /* çŠ¶æ€é¢œè‰² */
        .status-not-started { color: #ffc107; }
        .status-in-progress { color: #17a2b8; }
        .status-completed { color: #a72828; }
        .status-overdue { color: #28a745; }
        .status-total { color: #6c757d; }

        /* æ—¶é—´è¿‡æ»¤å™¨æ ·å¼ */
        .time-filter-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-group label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .filter-group .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .filter-separator {
            color: #666;
            font-weight: bold;
        }

        .filter-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .filter-btn:hover {
            background: #0056b3;
        }

        .filter-btn:active {
            transform: translateY(1px);
        }

        /* é¡¹ç›®è¯¦æƒ…è¡¨æ ¼æ ·å¼ */
        .project-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .project-table th, .project-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .project-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .project-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .project-table tr:hover {
            background-color: #f0f0f0;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }

        /* æœç´¢å’Œç­›é€‰æ ·å¼ */
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn:hover {
            background: #0056b3;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .card {
                padding: 20px;
            }
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* æ”¾å¤§ç¼©å°æŒ‰é’®æ ·å¼ */
        .zoom-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }
        .zoom-btn:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }
    </style>
</head>
<body>
<button class="BackBtn" onclick="location.href='/DQEIndex'">è¿”å›<br>ä¸»é¡µ</button>

<div class="container">
    <div class="header">
        <h1>DQEæ•°æ®çœ‹æ¿</h1>
        <p>ç ”å‘è´¨é‡ç®¡ç†ç³»ç»Ÿ - ç”µæ°”æµ‹è¯•é¡¹ç›®æ•°æ®å±•ç¤º</p>

        <!-- åˆ›å»ºæ—¶é—´è¿‡æ»¤å™¨ -->
        <div class="time-filter-container">
            <div class="filter-group">
                <label for="createTimeStart">åˆ›å»ºæ—¶é—´å¼€å§‹ï¼š</label>
                <input type="date" id="createTimeStart" class="filter-input">
                <span class="filter-separator">è‡³</span>
                <label for="createTimeEnd">ç»“æŸï¼š</label>
                <input type="date" id="createTimeEnd" class="filter-input">
                <button class="filter-btn" onclick="applyTimeFilter()">åº”ç”¨ç­›é€‰</button>
                <button class="filter-btn" onclick="resetTimeFilter()">é‡ç½®ç­›é€‰</button>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card" onclick="showProjectDetails('total')">
            <div class="card-value status-total" id="totalCount">0</div>
            <div class="card-title">é¡¹ç›®æ€»æ•°</div>
            <div class="card-description">æ‰€æœ‰ç”µæ°”æµ‹è¯•é¡¹ç›®</div>
        </div>
        <div class="card" onclick="showProjectDetails('not-started')">
            <div class="card-value status-not-started" id="notStartedCount">0</div>
            <div class="card-title">æœªå¼€å§‹é¡¹ç›®</div>
            <div class="card-description">ç­‰å¾…å¼€å§‹æµ‹è¯•çš„é¡¹ç›®</div>
        </div>
        <div class="card" onclick="showProjectDetails('in-progress')">
            <div class="card-value status-in-progress" id="inProgressCount">0</div>
            <div class="card-title">è¿›è¡Œä¸­é¡¹ç›®</div>
            <div class="card-description">æ­£åœ¨æµ‹è¯•ä¸­çš„é¡¹ç›®</div>
        </div>
        <div class="card" onclick="showProjectDetails('completed')">
            <div class="card-value status-completed" id="completedCount">0</div>
            <div class="card-title">å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®</div>
            <div class="card-description">æµ‹è¯•å®Œæˆä½†æœªç­¾æ ·</div>
        </div>
        <div class="card" onclick="showProjectDetails('overdue')">
            <div class="card-value status-overdue" id="closedCount">0</div>
            <div class="card-title">å·²ç¡®è®¤é¡¹ç›®</div>
            <div class="card-description">æŠ¥å‘Šå®Œæˆå·²ç¡®è®¤ç»“æœçš„é¡¹ç›®</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">é¡¹ç›®è¿›åº¦æ¦‚è§ˆ</div>
        <div class="filter-section">
            <input type="text" class="filter-input" id="searchInput" placeholder="æœç´¢æ ·å“ç¼–å·æˆ–äº§å“åç§°...">
            <select class="filter-input" id="categoryFilter">
                <option value="">æ‰€æœ‰ç±»åˆ«</option>
            </select>
            <select class="filter-input" id="statusFilter">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="æœªå¼€å§‹">æœªå¼€å§‹</option>
                <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                <option value="å·²å®Œæˆæœªç¡®è®¤">å·²å®Œæˆæœªç¡®è®¤</option>
                <option value="å·²ç¡®è®¤">å·²ç¡®è®¤</option>
            </select>

            <button class="filter-btn" onclick="applyFilters()">ç­›é€‰</button>
            <button class="filter-btn" onclick="resetFilters()">é‡ç½®</button>
        </div>
        <div id="projectTableContainer">
            <!-- é¡¹ç›®è¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="projectModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeProjectModal()">&times;</span>
        <h2 id="modalTitle">é¡¹ç›®è¯¦æƒ…</h2>
        <div id="modalContent">
            <!-- æ¨¡æ€æ¡†å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<script>
    function getParams() {
        let query = window.location.search;

        return new URLSearchParams(query);
    }


    let projectData = [];
    let filteredData = [];
    let originalProjectData = []; // ä¿å­˜åŸå§‹æ•°æ®

    // é¡µé¢åŠ è½½å®Œæˆåè·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        loadProjectData();
    });

    // åŠ è½½é¡¹ç›®æ•°æ®
    function loadProjectData() {
        const urlParams = getParams();
        let username = urlParams.get('username');
        let job = urlParams.get('job');

        if (!username) {
            alert('è¯·å…ˆè¾“å…¥ç”¨æˆ·åï¼');
            return;
        }

        localStorage.setItem("username",username);
        localStorage.setItem("job",job);

        // è°ƒç”¨DQEä¸ªäººæ•°æ®æ¥å£
        fetch(`/DQEIndex/getRdElectricProjectData?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    originalProjectData = data.data; // ä¿å­˜åŸå§‹æ•°æ®
                    projectData = [...originalProjectData];
                    filteredData = [...originalProjectData];
                    updateDashboard();
                    updateProjectTable();
                    updateCategoryFilter();
                } else {
                    console.error('è·å–DQEä¸ªäººæ•°æ®å¤±è´¥:', data.error);
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    loadMockData();
                }
            })
            .catch(error => {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                loadMockData();
            });
    }

    // åŠ è½½æ¨¡æ‹Ÿæ•°æ®ï¼ˆå½“APIä¸å¯ç”¨æ—¶ï¼‰
    function loadMockData() {
        filteredData = [...projectData];
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // æ›´æ–°çœ‹æ¿æ•°æ®
    function updateDashboard() {
        // æ ¹æ®electric_infoè¡¨çš„æ•°æ®ç»“æ„æ¥åˆ¤æ–­é¡¹ç›®çŠ¶æ€
        const notStarted = projectData.filter(p =>
            !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
        ).length;

        const inProgress = projectData.filter(p =>
            p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
        ).length;

        const completed = projectData.filter(p =>
            p.actual_finish_time && !p.sampleRecognizeResult
        ).length;

        const confirmed = projectData.filter(p =>
            p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
        ).length;

        document.getElementById('totalCount').textContent = projectData.length;
        document.getElementById('notStartedCount').textContent = notStarted;
        document.getElementById('inProgressCount').textContent = inProgress;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('closedCount').textContent = confirmed;
    }

    // æ›´æ–°é¡¹ç›®è¡¨æ ¼
    function updateProjectTable() {
        const container = document.getElementById('projectTableContainer');

        if (filteredData.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';
            return;
        }

        let tableHTML = `
                <table class="project-table">
                    <thead>
                        <tr>
                            <th>æ ·å“ç¼–å·</th>
                            <th>äº§å“åç§°</th>
                            <th>äº§å“ç±»åˆ«</th>
                            <th>å¤§ç¼–ç </th>
                            <th>ç‰ˆæœ¬</th>
                            <th>é¡¹ç›®è´Ÿè´£äºº</th>
                            <th>å½“å‰è¿›åº¦</th>
                            <th>æµ‹è¯•è´Ÿè´£äºº</th>
                            <th>é€æ ·äºº</th>
                            <th>é€æ ·ç±»åˆ«</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ’æœŸå¤©æ•°</th>
                            <th>æ’æœŸå¼€å§‹</th>
                            <th>æ’æœŸç»“æŸ</th>
                            <th>å®é™…å¼€å§‹æ—¶é—´</th>
                            <th>å®é™…å®Œæˆæ—¶é—´</th>
                            <th>æ‰¿è®¤ç»“æœ</th>
                             <th>DQEæ‰¿è®¤ç»“æœ</th>
                             <th>ç ”å‘æ‰¿è®¤ç»“æœ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        filteredData.forEach(project => {
            const isOverdue = project.schedule_end_date && project.schedule !== 'å·²å®Œæˆ' &&
                new Date(project.schedule_end_date) < new Date();

            // æ ¹æ®å®é™…æ—¶é—´åˆ¤æ–­é¡¹ç›®çŠ¶æ€
            let statusText = 'æœªå¼€å§‹';
            let statusColor = '#ffc107';

            if (project.actual_start_time && !project.actual_finish_time) {
                statusText = 'è¿›è¡Œä¸­';
                statusColor = '#17a2b8';
            } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
                statusText = 'å·²å®Œæˆæœªç¡®è®¤';
                statusColor = '#a72828';
            }else if (project.actual_finish_time && project.sampleRecognizeResult){
                statusText = 'æŠ¥å‘Šç¡®è®¤é—­ç¯'
                statusColor = '#28a745';
            }

            tableHTML += `
                    <tr style="${isOverdue ? 'background-color: #ffe6e6;' : ''}">
                        <td><strong>${project.sample_id || '-'}</strong></td>
                        <td>${project.sample_name || '-'}</td>
                        <td>${project.sample_category || '-'}</td>
                        <td>${project.sample_model || '-'}</td>
                        <td>${project.version || '-'}</td>
                        <td>${project.sample_leader || '-'}</td>
                        <td>
                            <span style="color: ${statusColor}; font-weight: bold;">
                                ${statusText}
                            </span>
                        </td>
                        <td>${project.tester || '-'}</td>
                        <td>${project.sample_sender || '-'}</td>
                        <td>${project.sample_type || '-'}</td>
                        <td>${formatDateTime(project.create_time) || '-'}</td>
                        <td>${project.scheduleDays || '-'}</td>
                        <td>${formatDate(project.schedule_start_date) || '-'}</td>
                        <td style="${isOverdue ? 'color: red; font-weight: bold;' : ''}">
                            ${formatDate(project.schedule_end_date) || '-'}
                        </td>
                        <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                        <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                        <td>${project.sampleRecognizeResult || '-'}</td>
                         <td>${project.sampleRecognizeResult || '-'}</td>
                         <td>${project.rd_sampleRecognizeResult || '-'}</td>
                    </tr>
                `;
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    // æ›´æ–°ç±»åˆ«ç­›é€‰å™¨
    function updateCategoryFilter() {
        const categories = [...new Set(projectData.map(p => p.sample_category).filter(Boolean))];
        const filter = document.getElementById('categoryFilter');

        filter.innerHTML = '<option value="">æ‰€æœ‰ç±»åˆ«</option>';
        categories.forEach(category => {
            filter.innerHTML += `<option value="${category}">${category}</option>`;
        });
    }

    // åº”ç”¨ç­›é€‰
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;

        filteredData = projectData.filter(project => {
            const matchesSearch = !searchTerm ||
                (project.sample_id && project.sample_id.toLowerCase().includes(searchTerm)) ||
                (project.sample_name && project.sample_name.toLowerCase().includes(searchTerm));

            const matchesCategory = !category || project.sample_category === category;

            // æ ¹æ®å®é™…æ—¶é—´åˆ¤æ–­é¡¹ç›®çŠ¶æ€è¿›è¡Œç­›é€‰
            let projectStatus = 'æœªå¼€å§‹';
            if (project.actual_start_time && !project.actual_finish_time) {
                projectStatus = 'è¿›è¡Œä¸­';
            } else if (project.actual_finish_time) {
                if (project.sampleRecognizeResult && project.sampleRecognizeResult.trim() !== '') {
                    projectStatus = 'å·²ç¡®è®¤';
                } else {
                    projectStatus = 'å·²å®Œæˆæœªç¡®è®¤';
                }
            }

            const matchesStatus = !status || projectStatus === status;

            return matchesSearch && matchesCategory && matchesStatus;
        });

        updateProjectTable();
    }

    // é‡ç½®ç­›é€‰
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        filteredData = [...projectData];
        updateProjectTable();
    }

    // åº”ç”¨æ—¶é—´ç­›é€‰
    function applyTimeFilter() {
        const startDate = document.getElementById('createTimeStart').value;
        const endDate = document.getElementById('createTimeEnd').value;

        if (!startDate && !endDate) {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            // æ¢å¤åŸå§‹æ•°æ®
            projectData = [...originalProjectData];
            filteredData = [...originalProjectData];
        } else {
            // ç­›é€‰æ•°æ®
            const filtered = originalProjectData.filter(project => {
                if (!project.create_time) return false;

                const createDate = new Date(project.create_time);
                let matchesStart = true;
                let matchesEnd = true;

                if (startDate) {
                    const start = new Date(startDate);
                    matchesStart = createDate >= start;
                }

                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999); // ç»“æŸæ—¥æœŸè®¾ä¸ºå½“å¤©çš„æœ€åä¸€ç§’
                    matchesEnd = createDate <= end;
                }

                return matchesStart && matchesEnd;
            });

            // æ›´æ–°projectDataä¸ºç­›é€‰åçš„æ•°æ®
            projectData = [...filtered];
            filteredData = [...filtered];
        }

        // æ›´æ–°çœ‹æ¿å’Œè¡¨æ ¼
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // é‡ç½®æ—¶é—´ç­›é€‰
    function resetTimeFilter() {
        document.getElementById('createTimeStart').value = '';
        document.getElementById('createTimeEnd').value = '';
        // æ¢å¤åŸå§‹æ•°æ®
        projectData = [...originalProjectData];
        filteredData = [...originalProjectData];
        updateDashboard();
        updateProjectTable();
        updateCategoryFilter();
    }

    // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
    function showProjectDetails(status) {
        let title = '';
        let projects = [];

        switch(status) {
            case 'total':
                title = 'é¡¹ç›®æ€»æ•°';
                projects = projectData;
                break;
            case 'not-started':
                title = 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…';
                projects = projectData.filter(p =>
                    !p.actual_start_time
                );
                break;
            case 'in-progress':
                title = 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…';
                projects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'completed':
                title = 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…';
                projects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case 'overdue':
                title = 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…';
                projects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // ä¼ é€’çŠ¶æ€ä¿¡æ¯åˆ°æ¨¡æ€æ¡†ï¼Œç”¨äºåç»­çš„è¿‡æ»¤å™¨è®¾ç½®
        showProjectModal(title, projects, status);
    }

    // æ˜¾ç¤ºé¡¹ç›®æ¨¡æ€æ¡†
    function showProjectModal(title, projects, status) {
        document.getElementById('modalTitle').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${title}</span>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <button class="filter-btn" onclick="showModalCharts('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            æŸ¥çœ‹å›¾è¡¨
                        </button>
                        <button class="filter-btn" onclick="showModalDataList('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            æŸ¥çœ‹æ•°æ®åˆ—è¡¨
                        </button>
                        <button class="filter-btn" onclick="showDynamicChartModal('${title}', ${JSON.stringify(projects).replace(/"/g, '&quot;')}, '${status}')">
                            è‡ªå®šä¹‰å›¾è¡¨
                        </button>
                        <button class="filter-btn" onclick="exportModalExcel('${title}')">
                            å¯¼å‡ºExcel
                        </button>
                    </div>
                </div>
            `;

        // é»˜è®¤æ˜¾ç¤ºå›¾è¡¨ï¼Œä¼ é€’çŠ¶æ€ä¿¡æ¯
        showModalCharts(title, projects, status);

        document.getElementById('projectModal').style.display = 'block';
    }

    // æ˜¾ç¤ºæ¨¡æ€æ¡†å›¾è¡¨
    function showModalCharts(title, projects, status) {
        let contentHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ</h3>
                    <p>å…±æ‰¾åˆ° <strong>${projects.length}</strong> ä¸ªé¡¹ç›®</p>
                </div>
            `;

        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è‡ªå®šä¹‰å›¾è¡¨
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const chartKey = `${title}_${status}`;
        let savedChartsList = savedCharts[chartKey];

        // ç¡®ä¿savedChartsListæ˜¯æ•°ç»„
        if (savedChartsList && !Array.isArray(savedChartsList)) {
            // å¦‚æœæ˜¯æ—§æ ¼å¼çš„å•ä¸ªå›¾è¡¨ï¼Œè½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
            if (savedChartsList.fieldName) {
                savedChartsList = [savedChartsList];
                // æ›´æ–°localStorageä¸ºæ–°çš„æ•°ç»„æ ¼å¼
                savedCharts[chartKey] = savedChartsList;
                localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
            } else {
                savedChartsList = null;
            }
        }

        if (savedChartsList && savedChartsList.length > 0) {
            // æ˜¾ç¤ºä¿å­˜çš„è‡ªå®šä¹‰å›¾è¡¨
            contentHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #333; margin-bottom: 15px;">è‡ªå®šä¹‰å›¾è¡¨ (${savedChartsList.length}ä¸ª)</h4>
                `;

            savedChartsList.forEach((savedChart, index) => {
                contentHTML += `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h5 style="color: #333; margin: 0; font-size: 16px;">${savedChart.title}</h5>
                                    <span style="color: #666; font-size: 12px;">å­—æ®µ: ${savedChart.fieldLabel} | ç±»å‹: ${getChartTypeName(savedChart.chartType)} | æ˜¾ç¤º: å‰${savedChart.topN}ä¸ª | åˆ›å»º: ${savedChart.createTime}</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeSavedChart('${chartKey}', ${savedChart.id})" title="åˆ é™¤æ­¤å›¾è¡¨">ğŸ—‘ï¸</button>
                            </div>
                            <div id="savedChart_${chartKey}_${savedChart.id}" style="height: 350px; display: flex; align-items: center; justify-content: center;">
                                ${generateSavedChart(savedChart, projects, `savedChart_${chartKey}_${savedChart.id}`)}
                            </div>
                        </div>
                    `;
            });

            contentHTML += `</div>`;
        }

        if (projects.length > 0) {
            // äº§å“ç±»åˆ«ç»Ÿè®¡
            const categoryStats = {};
            projects.forEach(project => {
                const category = project.sample_category && project.sample_category.trim() !== '' ? project.sample_category : 'æœªåˆ†ç±»';
                categoryStats[category] = (categoryStats[category] || 0) + 1;
            });

            // é¡¹ç›®è´Ÿè´£äººç»Ÿè®¡
            const leaderStats = {};
            projects.forEach(project => {
                const leader = project.sample_leader && project.sample_leader.trim() !== '' ? project.sample_leader : 'æœªæŒ‡å®š';
                leaderStats[leader] = (leaderStats[leader] || 0) + 1;
            });

            // æµ‹è¯•è´Ÿè´£äººç»Ÿè®¡
            const testerStats = {};
            projects.forEach(project => {
                const tester = project.tester && project.tester.trim() !== '' ? project.tester : 'æœªæŒ‡å®š';
                testerStats[tester] = (testerStats[tester] || 0) + 1;
            });

            // DQEè´Ÿè´£äººç»Ÿè®¡
            const dqeLeaderStats = {};
            projects.forEach(project => {
                const dqeLeader = project.dqe_leader && project.dqe_leader.trim() !== '' ? project.dqe_leader : 'æœªæŒ‡å®š';
                dqeLeaderStats[dqeLeader] = (dqeLeaderStats[dqeLeader] || 0) + 1;
            });

            // ç ”å‘è´Ÿè´£äººç»Ÿè®¡
            const rdLeaderStats = {};
            projects.forEach(project => {
                const rdLeader = project.rd_leader && project.rd_leader.trim() !== '' ? project.rd_leader : 'æœªæŒ‡å®š';
                rdLeaderStats[rdLeader] = (rdLeaderStats[rdLeader] || 0) + 1;
            });

            // é€æ ·äººç»Ÿè®¡
            const sampleSenderStats = {};
            projects.forEach(project => {
                const sampleSender = project.sample_sender && project.sample_sender.trim() !== '' ? project.sample_sender : 'æœªæŒ‡å®š';
                sampleSenderStats[sampleSender] = (sampleSenderStats[sampleSender] || 0) + 1;
            });

            // ç¡®è®¤ç»“æœåˆ†å¸ƒç»Ÿè®¡
            const confirmResultStats = {};
            projects.forEach(project => {
                // æ£€æŸ¥ç ”å‘æ‰¿è®¤ç»“æœ
                if (project.rd_sampleRecognizeResult) {
                    const rdResult = project.rd_sampleRecognizeResult.trim();
                    if (rdResult !== '') {
                        confirmResultStats[`ç ”å‘-${rdResult}`] = (confirmResultStats[`ç ”å‘-${rdResult}`] || 0) + 1;
                    }
                }

                // æ£€æŸ¥DQEæ‰¿è®¤ç»“æœ
                if (project.sampleRecognizeResult) {
                    const dqeResult = project.sampleRecognizeResult.trim();
                    if (dqeResult !== '') {
                        confirmResultStats[`DQE-${dqeResult}`] = (confirmResultStats[`DQE-${dqeResult}`] || 0) + 1;
                    }
                }

                // ç»Ÿè®¡æœªç¡®è®¤çš„é¡¹ç›®
                if ((!project.rd_sampleRecognizeResult || project.rd_sampleRecognizeResult.trim() === '') &&
                    (!project.sampleRecognizeResult || project.sampleRecognizeResult.trim() === '')) {
                    confirmResultStats['DQE-æœªç¡®è®¤'] = (confirmResultStats['DQE-æœªç¡®è®¤'] || 0) + 1;
                }
            });

            // æ’æœŸå¤©æ•°åˆ†å¸ƒç»Ÿè®¡
            const scheduleDaysStats = {};
            projects.forEach(project => {
                const days = project.scheduleDays;
                if (days && !isNaN(days)) {
                    // ç›´æ¥ä½¿ç”¨å…·ä½“å¤©æ•°ä½œä¸ºé”®
                    scheduleDaysStats[days] = (scheduleDaysStats[days] || 0) + 1;
                } else {
                    scheduleDaysStats['æœªè®¾ç½®'] = (scheduleDaysStats['æœªè®¾ç½®'] || 0) + 1;
                }
            });

            // å¯¹å¤©æ•°è¿›è¡Œæ’åºï¼Œç¡®ä¿å›¾è¡¨æ˜¾ç¤ºæœ‰åº
            const sortedScheduleDays = Object.keys(scheduleDaysStats)
                .filter(key => key !== 'æœªè®¾ç½®')
                .sort((a, b) => parseInt(a) - parseInt(b));

            // é‡æ–°æ„å»ºæœ‰åºçš„ç»Ÿè®¡æ•°æ®
            const orderedScheduleDaysStats = {};
            sortedScheduleDays.forEach(days => {
                orderedScheduleDaysStats[days + 'å¤©'] = scheduleDaysStats[days];
            });
            // å°†"æœªè®¾ç½®"æ”¾åœ¨æœ€å
            if (scheduleDaysStats['æœªè®¾ç½®']) {
                orderedScheduleDaysStats['æœªè®¾ç½®'] = scheduleDaysStats['æœªè®¾ç½®'];
            }

            // æœªå¼€å§‹å¤©æ•°åˆ†å¸ƒç»Ÿè®¡ï¼ˆåªåœ¨æœªå¼€å§‹é¡¹ç›®ä¸­æ˜¾ç¤ºï¼‰
            let notStartedDaysStats = {};
            if (status === 'not-started') {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºä»Šå¤©çš„å¼€å§‹æ—¶é—´

                projects.forEach(project => {
                    if (project.create_time) {
                        try {
                            const createDate = new Date(project.create_time);
                            createDate.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºåˆ›å»ºæ—¥æœŸçš„å¼€å§‹æ—¶é—´

                            // è®¡ç®—å¤©æ•°å·®
                            const timeDiff = today.getTime() - createDate.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                            if (daysDiff >= 0) {
                                // ç›´æ¥ä½¿ç”¨å…·ä½“å¤©æ•°ä½œä¸ºé”®
                                const daysKey = daysDiff === 0 ? 'ä»Šå¤©' : daysDiff === 1 ? 'æ˜¨å¤©' : `${daysDiff}å¤©`;
                                notStartedDaysStats[daysKey] = (notStartedDaysStats[daysKey] || 0) + 1;
                            }
                        } catch (e) {
                            // å¦‚æœæ—¥æœŸè§£æå¤±è´¥ï¼Œå½’ç±»ä¸º"æ—¥æœŸæ— æ•ˆ"
                            notStartedDaysStats['æ—¥æœŸæ— æ•ˆ'] = (notStartedDaysStats['æ—¥æœŸæ— æ•ˆ'] || 0) + 1;
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰åˆ›å»ºæ—¶é—´ï¼Œå½’ç±»ä¸º"æœªè®¾ç½®"
                        notStartedDaysStats['æœªè®¾ç½®'] = (notStartedDaysStats['æœªè®¾ç½®'] || 0) + 1;
                    }
                });

                // å¯¹å¤©æ•°è¿›è¡Œæ’åºï¼Œç¡®ä¿å›¾è¡¨æ˜¾ç¤ºæœ‰åº
                const sortedDays = Object.keys(notStartedDaysStats)
                    .filter(key => key !== 'ä»Šå¤©' && key !== 'æ˜¨å¤©' && key !== 'æ—¥æœŸæ— æ•ˆ' && key !== 'æœªè®¾ç½®')
                    .sort((a, b) => parseInt(a) - parseInt(b));

                // é‡æ–°æ„å»ºæœ‰åºçš„ç»Ÿè®¡æ•°æ®
                const orderedNotStartedDaysStats = {};

                // å…ˆæ·»åŠ ç‰¹æ®Šå€¼
                if (notStartedDaysStats['ä»Šå¤©']) {
                    orderedNotStartedDaysStats['ä»Šå¤©'] = notStartedDaysStats['ä»Šå¤©'];
                }
                if (notStartedDaysStats['æ˜¨å¤©']) {
                    orderedNotStartedDaysStats['æ˜¨å¤©'] = notStartedDaysStats['æ˜¨å¤©'];
                }

                // å†æ·»åŠ æŒ‰å¤©æ•°æ’åºçš„æ•°æ®
                sortedDays.forEach(days => {
                    orderedNotStartedDaysStats[days] = notStartedDaysStats[days];
                });

                // æœ€åæ·»åŠ ç‰¹æ®Šå€¼
                if (notStartedDaysStats['æ—¥æœŸæ— æ•ˆ']) {
                    orderedNotStartedDaysStats['æ—¥æœŸæ— æ•ˆ'] = notStartedDaysStats['æ—¥æœŸæ— æ•ˆ'];
                }
                if (notStartedDaysStats['æœªè®¾ç½®']) {
                    orderedNotStartedDaysStats['æœªè®¾ç½®'] = notStartedDaysStats['æœªè®¾ç½®'];
                }

                // æ›´æ–°å˜é‡å¼•ç”¨
                notStartedDaysStats = orderedNotStartedDaysStats;
            }

            // åˆ›å»ºå›¾è¡¨å®¹å™¨
            contentHTML += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">äº§å“ç±»åˆ«åˆ†å¸ƒ</h4>
                                <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('categoryChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('categoryChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('categoryChart', '${JSON.stringify(categoryStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="categoryChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(categoryStats, 'categoryChart')}
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">é¡¹ç›®è´Ÿè´£äººåˆ†å¸ƒ</h4>
                                <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('leaderChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('leaderChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('leaderChart', '${JSON.stringify(leaderStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="leaderChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(leaderStats, 'leaderChart')}
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">æµ‹è¯•è´Ÿè´£äººåˆ†å¸ƒ</h4>
                                <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('testerChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('testerChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('testerChart', '${JSON.stringify(testerStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="testerChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(testerStats, 'testerChart')}
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">DQEè´Ÿè´£äººåˆ†å¸ƒ</h4>
                                <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('dqeLeaderChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('dqeLeaderChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('dqeLeaderChart', '${JSON.stringify(dqeLeaderStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="dqeLeaderChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(dqeLeaderStats, 'dqeLeaderChart')}
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">ç ”å‘è´Ÿè´£äººåˆ†å¸ƒ</h4>
                                 <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('rdLeaderChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('rdLeaderChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('rdLeaderChart', '${JSON.stringify(rdLeaderStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="rdLeaderChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(rdLeaderStats, 'rdLeaderChart')}
                            </div>
                        </div>
                         <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                 <h4 style="color: #333; margin: 0; font-size: 16px;">é€æ ·äººåˆ†å¸ƒ</h4>
                                 <div style="display: flex; gap: 5px;">
                                     <button class="zoom-btn" onclick="zoomChart('sampleSenderChart', -1)" title="ç¼©å°">âˆ’</button>
                                     <button class="zoom-btn" onclick="zoomChart('sampleSenderChart', 1)" title="æ”¾å¤§">+</button>
                                     <button class="zoom-btn" onclick="toggleChartType('sampleSenderChart', '${JSON.stringify(sampleSenderStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                 </div>
                             </div>
                             <div id="sampleSenderChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                 ${createBarChart(sampleSenderStats, 'sampleSenderChart')}
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">æ’æœŸå¤©æ•°åˆ†å¸ƒ</h4>
                                <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('scheduleChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('scheduleChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('scheduleChart', '${JSON.stringify(orderedScheduleDaysStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="scheduleChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(orderedScheduleDaysStats, 'scheduleChart')}
                            </div>
                        </div>
                        ${status === 'not-started' ? `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">æœªå¼€å§‹å¤©æ•°åˆ†å¸ƒ</h4>
                                <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('notStartedDaysChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('notStartedDaysChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('notStartedDaysChart', '${JSON.stringify(notStartedDaysStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="notStartedDaysChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(notStartedDaysStats, 'notStartedDaysChart')}
                            </div>
                        </div>
                        ` : ''}
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #333; margin: 0; font-size: 16px;">ç¡®è®¤ç»“æœåˆ†å¸ƒ</h4>
                                <div style="display: flex; gap: 5px;">
                                    <button class="zoom-btn" onclick="zoomChart('confirmResultChart', -1)" title="ç¼©å°">âˆ’</button>
                                    <button class="zoom-btn" onclick="zoomChart('confirmResultChart', 1)" title="æ”¾å¤§">+</button>
                                    <button class="zoom-btn" onclick="toggleChartType('confirmResultChart', '${JSON.stringify(confirmResultStats).replace(/"/g, '&quot;')}')" title="åˆ‡æ¢å›¾è¡¨ç±»å‹">ğŸ“Š</button>
                                </div>
                            </div>
                            <div id="confirmResultChart" style="height: 350px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                ${createBarChart(confirmResultStats, 'confirmResultChart')}
                            </div>
                        </div>
                    </div>
                `;
        } else {
            contentHTML += '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';
        }

        document.getElementById('modalContent').innerHTML = contentHTML;

        // ç»‘å®šå›¾è¡¨ç‚¹å‡»äº‹ä»¶å’Œtooltipäº‹ä»¶
        if (projects.length > 0) {
            bindChartClickEvents('categoryChart');
            bindChartClickEvents('leaderChart');
            bindChartClickEvents('testerChart');
            bindChartClickEvents('dqeLeaderChart');
            bindChartClickEvents('rdLeaderChart');
            bindChartClickEvents('sampleSenderChart');
            bindChartClickEvents('scheduleChart');
            bindChartClickEvents('confirmResultChart');

            // å¦‚æœæ˜¯æœªå¼€å§‹é¡¹ç›®ï¼Œç»‘å®šæœªå¼€å§‹å¤©æ•°åˆ†å¸ƒå›¾çš„äº‹ä»¶
            if (status === 'not-started') {
                bindChartClickEvents('notStartedDaysChart');
                bindTooltipEvents('notStartedDaysChart');
                updateZoomButtons('notStartedDaysChart', 350);
            }

            bindTooltipEvents('categoryChart');
            bindTooltipEvents('leaderChart');
            bindTooltipEvents('testerChart');
            bindTooltipEvents('dqeLeaderChart');
            bindTooltipEvents('rdLeaderChart');
            bindTooltipEvents('sampleSenderChart');
            bindTooltipEvents('scheduleChart');
            bindTooltipEvents('confirmResultChart');

            // æ›´æ–°æ”¾å¤§ç¼©å°æŒ‰é’®çŠ¶æ€
            updateZoomButtons('categoryChart', 350);
            updateZoomButtons('leaderChart', 350);
            updateZoomButtons('testerChart', 350);
            updateZoomButtons('dqeLeaderChart', 350);
            updateZoomButtons('rdLeaderChart', 350);
            updateZoomButtons('sampleSenderChart', 350);
            updateZoomButtons('scheduleChart', 350);
            updateZoomButtons('confirmResultChart', 350);
        }
    }

    // æ˜¾ç¤ºæ¨¡æ€æ¡†æ•°æ®åˆ—è¡¨
    function showModalDataList(title, projects, status, preserveValues = false) {
        // ä¿å­˜å½“å‰è¿‡æ»¤å™¨çš„å€¼
        let currentFilters = {};
        if (preserveValues) {
            const categoryFilter = document.getElementById('modalCategoryFilter');
            const testerFilter = document.getElementById('modalTesterFilter');
            const leaderFilter = document.getElementById('modalLeaderFilter');
            const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
            const startDateInput = document.getElementById('modalStartDate');
            const endDateInput = document.getElementById('modalEndDate');

            if (categoryFilter) currentFilters.category = categoryFilter.value;
            if (testerFilter) currentFilters.tester = testerFilter.value;
            if (leaderFilter) currentFilters.leader = leaderFilter.value;
            if (scheduleDaysFilter) currentFilters.scheduleDays = scheduleDaysFilter.value;
            if (startDateInput) currentFilters.startDate = startDateInput.value;
            if (endDateInput) currentFilters.endDate = endDateInput.value;
        }

        let contentHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">è¯¦ç»†æ•°æ®åˆ—è¡¨</h3>
                    <p>å…±æ‰¾åˆ° <strong>${projects.length}</strong> ä¸ªé¡¹ç›®</p>
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">ç±»åˆ«:</label>
                            <select class="filter-input" id="modalCategoryFilter">
                                <option value="">æ‰€æœ‰ç±»åˆ«</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">æµ‹è¯•è´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalTesterFilter">
                                <option value="">æ‰€æœ‰æµ‹è¯•è´Ÿè´£äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">é¡¹ç›®è´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalLeaderFilter">
                                <option value="">æ‰€æœ‰é¡¹ç›®è´Ÿè´£äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">DQEè´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalDqeLeaderFilter">
                                <option value="">æ‰€æœ‰DQEè´Ÿè´£äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">ç ”å‘è´Ÿè´£äºº:</label>
                            <select class="filter-input" id="modalRdLeaderFilter">
                                <option value="">æ‰€æœ‰ç ”å‘è´Ÿè´£äºº</option>
                            </select>
                        </div>
                         <div style="display: flex; gap: 10px; align-items: center;">
                             <label style="font-size: 14px; color: #333;">é€æ ·äºº:</label>
                             <select class="filter-input" id="modalSampleSenderFilter">
                                 <option value="">æ‰€æœ‰é€æ ·äºº</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">æ’æœŸå¤©æ•°:</label>
                            <select class="filter-input" id="modalScheduleDaysFilter">
                                <option value="">æ‰€æœ‰æ’æœŸå¤©æ•°</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #333;">åˆ›å»ºæ—¶é—´:</label>
                            <input type="date" class="filter-input" id="modalStartDate" placeholder="å¼€å§‹æ—¥æœŸ">
                            <span style="color: #666;">è‡³</span>
                            <input type="date" class="filter-input" id="modalEndDate" placeholder="ç»“æŸæ—¥æœŸ">
                        </div>
                        <button class="filter-btn" onclick="applyModalFilters()">ç­›é€‰</button>
                        <button class="filter-btn" onclick="resetModalFilters()">é‡ç½®</button>
                    </div>
                </div>
            `;

        if (projects.length > 0) {
            contentHTML += `
                    <table class="project-table">
                        <thead>
                            <tr>
                                <th>æ ·å“ç¼–å·</th>
                                <th>äº§å“åç§°</th>
                                <th>äº§å“ç±»åˆ«</th>
                                <th>é¡¹ç›®è´Ÿè´£äºº</th>
                                <th>æµ‹è¯•è´Ÿè´£äºº</th>
                                <th>DQEè´Ÿè´£äºº</th>
                                <th>ç ”å‘è´Ÿè´£äºº</th>
                                <th>é€æ ·äºº</th>
                                <th>æ’æœŸå¤©æ•°</th>
                                <th>æ’æœŸå¼€å§‹</th>
                                <th>æ’æœŸç»“æŸ</th>
                                <th>å®é™…å¼€å§‹æ—¶é—´</th>
                                <th>å®é™…ç»“æŸæ—¶é—´</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                 <th>DQEæ‰¿è®¤ç»“æœ</th>
                                 <th>ç ”å‘æ‰¿è®¤ç»“æœ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

            projects.forEach(project => {
                const isOverdue = project.schedule_end_date && project.schedule !== 'å·²å®Œæˆ' &&
                    new Date(project.schedule_end_date) < new Date();

                contentHTML += `
                        <tr style="${(isOverdue && !project.sampleRecognizeResult) ? 'background-color: #ffe6e6;' : ''}">
                            <td><strong>${project.sample_id || '-'}</strong></td>
                            <td>${project.sample_name || '-'}</td>
                            <td>${project.sample_category || '-'}</td>
                            <td>${project.sample_leader || '-'}</td>
                            <td>${project.tester || '-'}</td>
                            <td>${project.dqe_leader || '-'}</td>
                            <td>${project.rd_leader || '-'}</td>
                            <td>${project.sample_sender || '-'}</td>
                            <td>${project.scheduleDays || '-'}</td>
                            <td>${formatDate(project.schedule_start_date) || '-'}</td>
                            <td style="${(isOverdue && !project.sampleRecognizeResult) ? 'color: red; font-weight: bold;' : ''}">
                                ${formatDate(project.schedule_end_date) || '-'}
                            </td>
                            <td>${formatDateTime(project.actual_start_time) || '-'}</td>
                            <td>${formatDateTime(project.actual_finish_time) || '-'}</td>
                            <td>${formatDateTime(project.create_time) || '-'}</td>
                             <td>${project.sampleRecognizeResult || '-'}</td>
                             <td>${project.rd_sampleRecognizeResult || '-'}</td>
                        </tr>
                    `;
            });

            contentHTML += '</tbody></table>';
        }

        document.getElementById('modalContent').innerHTML = contentHTML;

        // å¡«å……è¿‡æ»¤å™¨é€‰é¡¹
        populateModalFilters(projects);

        // æ¢å¤è¿‡æ»¤å™¨çš„å€¼
        if (preserveValues && Object.keys(currentFilters).length > 0) {
            setTimeout(() => {
                const categoryFilter = document.getElementById('modalCategoryFilter');
                const testerFilter = document.getElementById('modalTesterFilter');
                const leaderFilter = document.getElementById('modalLeaderFilter');
                const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
                const startDateInput = document.getElementById('modalStartDate');
                const endDateInput = document.getElementById('modalEndDate');

                if (categoryFilter && currentFilters.category) categoryFilter.value = currentFilters.category;
                if (testerFilter && currentFilters.tester) testerFilter.value = currentFilters.tester;
                if (leaderFilter && currentFilters.leader) leaderFilter.value = currentFilters.leader;
                if (scheduleDaysFilter && currentFilters.scheduleDays) scheduleDaysFilter.value = currentFilters.scheduleDays;
                if (startDateInput && currentFilters.startDate) startDateInput.value = currentFilters.startDate;
                if (endDateInput && currentFilters.endDate) endDateInput.value = currentFilters.endDate;
            }, 100);
        }
    }

    // å¡«å……æ¨¡æ€æ¡†è¿‡æ»¤å™¨é€‰é¡¹
    function populateModalFilters(projects) {
        // å¡«å……ç±»åˆ«è¿‡æ»¤å™¨
        const categories = [...new Set(projects.map(p => p.sample_category).filter(cat => cat && cat.trim() !== ''))];
        const categoryFilter = document.getElementById('modalCategoryFilter');
        if (categoryFilter) {
            categoryFilter.innerHTML = '<option value="">æ‰€æœ‰ç±»åˆ«</option>';
            categories.forEach(category => {
                categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
            });
            // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªåˆ†ç±»"é€‰é¡¹
            if (projects.some(p => !p.sample_category || p.sample_category.trim() === '')) {
                categoryFilter.innerHTML += '<option value="">æœªåˆ†ç±»</option>';
            }
        }

        // å¡«å……æµ‹è¯•è´Ÿè´£äººè¿‡æ»¤å™¨
        const testers = [...new Set(projects.map(p => p.tester).filter(tester => tester && tester.trim() !== ''))];
        const testerFilter = document.getElementById('modalTesterFilter');
        if (testerFilter) {
            testerFilter.innerHTML = '<option value="">æ‰€æœ‰æµ‹è¯•è´Ÿè´£äºº</option>';
            testers.forEach(tester => {
                testerFilter.innerHTML += `<option value="${tester}">${tester}</option>`;
            });
            // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
            if (projects.some(p => !p.tester || p.tester.trim() === '')) {
                testerFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
            }
        }

        // å¡«å……é¡¹ç›®è´Ÿè´£äººè¿‡æ»¤å™¨
        const leaders = [...new Set(projects.map(p => p.sample_leader).filter(leader => leader && leader.trim() !== ''))];
        const leaderFilter = document.getElementById('modalLeaderFilter');
        if (leaderFilter) {
            leaderFilter.innerHTML = '<option value="">æ‰€æœ‰é¡¹ç›®è´Ÿè´£äºº</option>';
            leaders.forEach(leader => {
                leaderFilter.innerHTML += `<option value="${leader}">${leader}</option>`;
            });
            // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
            if (projects.some(p => !p.sample_leader || p.sample_leader.trim() === '')) {
                leaderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
            }
        }

        // å¡«å……DQEè´Ÿè´£äººè¿‡æ»¤å™¨
        const dqeLeaders = [...new Set(projects.map(p => p.dqe_leader).filter(dqeLeader => dqeLeader && dqeLeader.trim() !== ''))];
        const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
        if (dqeLeaderFilter) {
            dqeLeaderFilter.innerHTML = '<option value="">æ‰€æœ‰DQEè´Ÿè´£äºº</option>';
            dqeLeaders.forEach(dqeLeader => {
                dqeLeaderFilter.innerHTML += `<option value="${dqeLeader}">${dqeLeader}</option>`;
            });
            // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
            if (projects.some(p => !p.dqe_leader || p.dqe_leader.trim() === '')) {
                dqeLeaderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
            }
        }

        // å¡«å……ç ”å‘è´Ÿè´£äººè¿‡æ»¤å™¨
        const rdLeaders = [...new Set(projects.map(p => p.rd_leader).filter(rdLeader => rdLeader && rdLeader.trim() !== ''))];
        const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
        if (rdLeaderFilter) {
            rdLeaderFilter.innerHTML = '<option value="">æ‰€æœ‰ç ”å‘è´Ÿè´£äºº</option>';
            rdLeaders.forEach(rdLeader => {
                rdLeaderFilter.innerHTML += `<option value="${rdLeader}">${rdLeader}</option>`;
            });
            // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
            if (projects.some(p => !p.rd_leader || p.rd_leader.trim() === '')) {
                rdLeaderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
            }
        }

        // å¡«å……é€æ ·äººè¿‡æ»¤å™¨
        const sampleSenders = [...new Set(projects.map(p => p.sample_sender).filter(sender => sender && sender.trim() !== ''))];
        const sampleSenderFilter = document.getElementById('modalSampleSenderFilter');
        if (sampleSenderFilter) {
            sampleSenderFilter.innerHTML = '<option value="">æ‰€æœ‰é€æ ·äºº</option>';
            sampleSenders.forEach(sender => {
                sampleSenderFilter.innerHTML += `<option value="${sender}">${sender}</option>`;
            });
            // å¦‚æœæœ‰ç©ºå€¼çš„æ•°æ®ï¼Œæ·»åŠ "æœªæŒ‡å®š"é€‰é¡¹
            if (projects.some(p => !p.sample_sender || p.sample_sender.trim() === '')) {
                sampleSenderFilter.innerHTML += '<option value="">æœªæŒ‡å®š</option>';
            }
        }

        // å¡«å……æ’æœŸå¤©æ•°è¿‡æ»¤å™¨
        const scheduleDays = [...new Set(projects.map(p => p.scheduleDays).filter(days => days && !isNaN(days)))];
        const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
        if (scheduleDaysFilter) {
            scheduleDaysFilter.innerHTML = '<option value="">æ‰€æœ‰æ’æœŸå¤©æ•°</option>';
            scheduleDays.sort((a, b) => parseInt(a) - parseInt(b));
            scheduleDays.forEach(days => {
                scheduleDaysFilter.innerHTML += `<option value="${days}">${days}å¤©</option>`;
            });
            // æ·»åŠ "æœªè®¾ç½®"é€‰é¡¹
            if (projects.some(p => !p.scheduleDays || isNaN(p.scheduleDays))) {
                scheduleDaysFilter.innerHTML += '<option value="æœªè®¾ç½®">æœªè®¾ç½®</option>';
            }
        }
    }

    // åˆ›å»ºé¥¼å›¾
    function createPieChart(data, containerId) {
        const labels = Object.keys(data);
        const values = Object.values(data);
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

        if (labels.length === 0) return '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';

        const total = values.reduce((a, b) => a + b, 0);
        if (total === 0) return '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';

        // åˆ›å»ºSVGé¥¼å›¾
        const radius = 100;
        const centerX = 125;
        const centerY = 125;

        let chartHTML = `
                    <div style="position: relative; width: 250px; height: 250px; margin: 0 auto;">
                        <svg width="250" height="250" viewBox="0 0 250 250">
                `;

        let currentAngle = 0;
        labels.forEach((label, index) => {
            const value = values[index];
            const percentage = (value / total) * 100;
            const angle = (value / total) * 360;

            if (angle > 0) {
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;

                // è®¡ç®—å¼§çº¿è·¯å¾„
                const startX = centerX + radius * Math.cos(startAngle * Math.PI / 180);
                const startY = centerY + radius * Math.sin(startAngle * Math.PI / 180);
                const endX = centerX + radius * Math.cos(endAngle * Math.PI / 180);
                const endY = centerY + radius * Math.sin(endAngle * Math.PI / 180);

                // åˆ¤æ–­æ˜¯å¦éœ€è¦ç»˜åˆ¶å¤§å¼§çº¿
                const largeArcFlag = angle > 180 ? 1 : 0;

                const pathData = `M ${centerX} ${centerY} L ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;

                // ä¸ºæ¯ä¸ªæ‰‡å½¢æ·»åŠ é¼ æ ‡äº‹ä»¶å’Œtooltip
                const segmentId = `segment_${containerId}_${index}`;

                // æ£€æŸ¥æ˜¯å¦ä¸ºä¿å­˜çš„å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const isSavedChart = containerId.startsWith('savedChart_');
                const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

                chartHTML += `
                        <path id="${segmentId}" d="${pathData}" fill="${colors[index % colors.length]}" stroke="white" stroke-width="2"
                              style="cursor: pointer;"
                              data-label="${label}"
                              data-value="${value}"
                              onmouseover="showSegmentTooltip(event, '${label}', ${value}, ${percentage.toFixed(1)})"
                              onmouseout="hideSegmentTooltip()"
                              ${clickEvent}/>
                    `;

                // åªæœ‰å½“æ‰‡å½¢è¶³å¤Ÿå¤§æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼ˆè§’åº¦å¤§äº15åº¦ï¼‰
                if (angle > 15) {
                    // åœ¨æ‰‡å½¢ä¸­å¿ƒä½ç½®æ·»åŠ æ ‡ç­¾
                    const midAngle = startAngle + angle / 2;
                    const labelRadius = radius * 0.5; // æ ‡ç­¾ä½ç½®åœ¨æ‰‡å½¢ä¸­å¿ƒæ›´å†…ï¼Œé¿å…è¢«è¾¹ç¼˜é®æŒ¡
                    const labelX = centerX + labelRadius * Math.cos(midAngle * Math.PI / 180);
                    const labelY = centerY + labelRadius * Math.sin(midAngle * Math.PI / 180);

                    // è®¡ç®—æ–‡æœ¬é”šç‚¹ï¼Œç¡®ä¿æ–‡æœ¬åœ¨æ‰‡å½¢ä¸­å¿ƒ
                    let textAnchor = 'middle';
                    let dominantBaseline = 'middle';

                    // æ ¹æ®è§’åº¦è°ƒæ•´æ–‡æœ¬ä½ç½®ï¼Œé¿å…é‡å 
                    if (midAngle > 45 && midAngle < 135) {
                        dominantBaseline = 'hanging'; // ä¸ŠåŠéƒ¨åˆ†
                    } else if (midAngle > 225 && midAngle < 315) {
                        dominantBaseline = 'auto'; // ä¸‹åŠéƒ¨åˆ†
                    }

                    if (midAngle > 90 && midAngle < 270) {
                        textAnchor = 'end'; // å·¦åŠéƒ¨åˆ†
                    } else {
                        textAnchor = 'start'; // å³åŠéƒ¨åˆ†
                    }

                    // æ·»åŠ æ ‡ç­¾æ–‡æœ¬ï¼Œè¿™é‡Œæ˜¯é¥¼çŠ¶å›¾ä¸Šçš„å­—ä½“
                    chartHTML += `
                        <text x="${labelX}" y="${labelY}"
                              text-anchor="${textAnchor}"
                              dominant-baseline="${dominantBaseline}"
                              fill="white"
                              font-size="16"
                              font-weight="bold"
                              stroke="gray"
                              style="pointer-events: none; font-family: 'Microsoft YaHei', Arial, sans-serif;">
                            ${label}
                        </text>
                    `;

                    // æ·»åŠ æ•°å€¼
                    const valueRadius = radius * 0.3; // æ•°å€¼ä½ç½®åœ¨æ‰‡å½¢ä¸­å¿ƒæ›´å†…ï¼Œé¿å…è¢«è¾¹ç¼˜é®æŒ¡
                    const valueX = centerX + valueRadius * Math.cos(midAngle * Math.PI / 180);
                    const valueY = centerY + valueRadius * Math.sin(midAngle * Math.PI / 180);

                    chartHTML += `
                        <text x="${valueX}" y="${valueY}"
                              text-anchor="middle"
                              dominant-baseline="middle"
                              fill="white"
                              font-size="16"
                              font-weight="bold"
                              stroke="black"
                              stroke-width="1"
                              style="pointer-events: none; font-family: 'Microsoft YaHei', Arial, sans-serif;">
                            ${value}
                        </text>
                    `;
                }

                currentAngle = endAngle;
            }
        });

        chartHTML += '</svg>';

        // æ·»åŠ tooltipå®¹å™¨
        chartHTML += `
                <div id="tooltip_${containerId}" style="
                    position: fixed;
                    display: none;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    pointer-events: none;
                    z-index: 1000;
                    white-space: nowrap;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                "></div>
            `;

        chartHTML += '</div>';

        return chartHTML;
    }

    // åˆ›å»ºæŸ±çŠ¶å›¾
    function createBarChart(data, containerId) {
        const labels = Object.keys(data);
        const values = Object.values(data);
        const maxValue = Math.max(...values);
        const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];

        if (labels.length === 0) return '<p style="text-align: center; color: #666;">æš‚æ— æ•°æ®</p>';

        // åˆ›å»ºæ ‡ç­¾å’Œå€¼çš„é…å¯¹æ•°ç»„ï¼Œå¹¶æŒ‰å€¼ä»é«˜åˆ°ä½æ’åº
        const sortedData = labels.map((label, index) => ({
            label: label,
            value: values[index],
            color: colors[index % colors.length]
        })).sort((a, b) => b.value - a.value);

        // æ ¹æ®æŸ±å­æ•°é‡è°ƒæ•´å¸ƒå±€
        const isManyBars = labels.length > 8;
        const barWidth = isManyBars ? 35 : 50;
        //  ä¸‹è¾¹è¿™ä¸ªæ˜¯ä¿®æ”¹æŸ±çŠ¶å›¾æ ‡ç­¾ä¹‹é—´çš„é—´è·çš„
        const barSpacing = isManyBars ? 15 : 25;

        // è®¡ç®—æ€»å®½åº¦ï¼Œç¡®ä¿æŸ±å­èƒ½å¤Ÿå±…ä¸­æ˜¾ç¤º
        const totalWidth = sortedData.length * (barWidth + barSpacing) - barSpacing;

        let chartHTML = `<div style="display: flex; align-items: end; justify-content: center; height: 280px; padding: 20px; overflow-x: auto;">
                <div style="display: flex; align-items: end; gap: ${barSpacing}px; width: ${totalWidth}px;">`;

        sortedData.forEach((item, index) => {
            const height = maxValue > 0 ? (item.value / maxValue) * 180 : 0;

            // æ£€æŸ¥æ˜¯å¦ä¸ºä¿å­˜çš„å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const isSavedChart = containerId.startsWith('savedChart_');
            const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${containerId}', event)"` : '';

            chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center; width: ${barWidth}px;">
                        <div style="width: ${barWidth}px; height: ${height}px; background: ${item.color}; border-radius: 6px 6px 0 0; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: ${isManyBars ? '14px' : '16px'}; cursor: pointer; transition: all 0.2s ease;"
                             data-label="${item.label}"
                             data-value="${item.value}"
                             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
                             ${clickEvent}>
                            ${item.value}
                        </div>
                        <div style="font-size: ${isManyBars ? '12px' : '14px'}; color: #666; max-width: ${barWidth + 10}px; word-wrap: break-word; text-align: center; height: 40px; display: flex; align-items: center; justify-content: center; line-height: 1.2;">
                            ${item.label}
                        </div>
                    </div>
                `;
        });

        chartHTML += '</div></div>';
        return chartHTML;
    }

    // å…³é—­é¡¹ç›®æ¨¡æ€æ¡†
    function closeProjectModal() {
        document.getElementById('projectModal').style.display = 'none';
    }

    // è·å–çŠ¶æ€é¢œè‰²
    function getStatusColor(status) {
        switch(status) {
            case 'æœªå¼€å§‹': return '#ffc107';
            case 'è¿›è¡Œä¸­': return '#17a2b8';
            case 'å·²å®Œæˆ': return '#28a745';
            default: return '#6c757d';
        }
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        } catch (e) {
            return dateStr;
        }
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '-';
        try {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN');
        } catch (e) {
            return dateStr;
        }
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('projectModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }

    // å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    setInterval(loadProjectData, 5 * 60 * 1000);

    // æ˜¾ç¤ºæ‰‡å½¢tooltip
    function showSegmentTooltip(event, label, value, percentage) {
        const tooltip = document.querySelector('[id^="tooltip_"]');
        if (tooltip) {
            tooltip.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">${label}</div>
                    <div>æ•°é‡: ${value}</div>
                    <div>å æ¯”: ${percentage}%</div>
                `;
            tooltip.style.display = 'block';

            // è·å–é¼ æ ‡ä½ç½®
            const mouseX = event.clientX;
            const mouseY = event.clientY;

            // è·å–tooltipå°ºå¯¸
            const tooltipRect = tooltip.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width;
            const tooltipHeight = tooltipRect.height;

            // è·å–è§†å£å°ºå¯¸
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // è®¡ç®—tooltipä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†å£è¾¹ç•Œ
            let left = mouseX + 15; // é¼ æ ‡å³ä¾§15px
            let top = mouseY - tooltipHeight - 10; // é¼ æ ‡ä¸Šæ–¹10px

            // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œåˆ™æ˜¾ç¤ºåœ¨é¼ æ ‡å·¦ä¾§
            if (left + tooltipWidth > viewportWidth) {
                left = mouseX - tooltipWidth - 15;
            }

            // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œåˆ™æ˜¾ç¤ºåœ¨é¼ æ ‡ä¸‹æ–¹
            if (top < 0) {
                top = mouseY + 15;
            }

            // ç¡®ä¿ä¸è¶…å‡ºå·¦è¾¹ç•Œ
            if (left < 0) {
                left = 10;
            }

            // ç¡®ä¿ä¸è¶…å‡ºä¸‹è¾¹ç•Œ
            if (top + tooltipHeight > viewportHeight) {
                top = viewportHeight - tooltipHeight - 10;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
    }

    // éšè—æ‰‡å½¢tooltip
    function hideSegmentTooltip() {
        const tooltip = document.querySelector('[id^="tooltip_"]');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    // ç‚¹å‡»å›¾è¡¨å…ƒç´ è·³è½¬åˆ°å¯¹åº”æ•°æ®åˆ—è¡¨
    function filterByChartSegment(chartId, label, value) {
        // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let originalProjects = [];

        // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
        switch(modalTitle) {
            case 'é¡¹ç›®æ€»æ•°':
                originalProjects = projectData;
                break;
            case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // æ ¹æ®å›¾è¡¨ç±»å‹å’Œæ ‡ç­¾è¿›è¡Œç­›é€‰
        let filteredProjects = [];

        if (chartId === 'categoryChart') {
            // äº§å“ç±»åˆ«ç­›é€‰
            if (label === 'æœªåˆ†ç±»') {
                filteredProjects = originalProjects.filter(project =>
                    !project.sample_category || project.sample_category.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.sample_category === label
                );
            }
        } else if (chartId === 'leaderChart') {
            // é¡¹ç›®è´Ÿè´£äººç­›é€‰
            if (label === 'æœªæŒ‡å®š') {
                filteredProjects = originalProjects.filter(project =>
                    !project.sample_leader || project.sample_leader.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.sample_leader === label
                );
            }
        } else if (chartId === 'testerChart') {
            // æµ‹è¯•è´Ÿè´£äººç­›é€‰
            if (label === 'æœªæŒ‡å®š') {
                filteredProjects = originalProjects.filter(project =>
                    !project.tester || project.tester.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.tester === label
                );
            }
        } else if (chartId === 'dqeLeaderChart') {
            // DQEè´Ÿè´£äººç­›é€‰
            if (label === 'æœªæŒ‡å®š') {
                filteredProjects = originalProjects.filter(project =>
                    !project.dqe_leader || project.dqe_leader.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.dqe_leader === label
                );
            }
        } else if (chartId === 'rdLeaderChart') {
            // ç ”å‘è´Ÿè´£äººç­›é€‰
            if (label === 'æœªæŒ‡å®š') {
                filteredProjects = originalProjects.filter(project =>
                    !project.rd_leader || project.rd_leader.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.rd_leader === label
                );
            }
        } else if (chartId === 'sampleSenderChart') {
            // é€æ ·äººç­›é€‰
            if (label === 'æœªæŒ‡å®š') {
                filteredProjects = originalProjects.filter(project =>
                    !project.sample_sender || project.sample_sender.trim() === ''
                );
            } else {
                filteredProjects = originalProjects.filter(project =>
                    project.sample_sender === label
                );
            }
        } else if (chartId === 'scheduleChart') {
            // æ’æœŸå¤©æ•°ç­›é€‰
            if (label === 'æœªè®¾ç½®') {
                filteredProjects = originalProjects.filter(project =>
                    !project.scheduleDays || isNaN(project.scheduleDays)
                );
            } else {
                const days = parseInt(label.replace('å¤©', ''));
                filteredProjects = originalProjects.filter(project =>
                    project.scheduleDays === days
                );
            }
        } else if (chartId === 'confirmResultChart') {
            // ç¡®è®¤ç»“æœç­›é€‰
            if (label === 'DQE-æœªç¡®è®¤') {
                filteredProjects = originalProjects.filter(project =>
                    (!project.rd_sampleRecognizeResult || project.rd_sampleRecognizeResult.trim() === '') &&
                    (!project.sampleRecognizeResult || project.sampleRecognizeResult.trim() === '')
                );
            } else if (label.startsWith('ç ”å‘-')) {
                const rdResult = label.replace('ç ”å‘-', '');
                filteredProjects = originalProjects.filter(project =>
                    project.rd_sampleRecognizeResult && project.rd_sampleRecognizeResult.trim() === rdResult
                );
            } else if (label.startsWith('DQE-')) {
                const dqeResult = label.replace('DQE-', '');
                filteredProjects = originalProjects.filter(project =>
                    project.sampleRecognizeResult && project.sampleRecognizeResult.trim() === dqeResult
                );
            }
        } else if (chartId === 'notStartedDaysChart') {
            // æœªå¼€å§‹å¤©æ•°åˆ†å¸ƒç­›é€‰
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (label === 'ä»Šå¤©') {
                filteredProjects = originalProjects.filter(project => {
                    if (!project.create_time) return false;
                    try {
                        const createDate = new Date(project.create_time);
                        createDate.setHours(0, 0, 0, 0);
                        const timeDiff = today.getTime() - createDate.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        return daysDiff === 0;
                    } catch (e) {
                        return false;
                    }
                });
            } else if (label === 'æ˜¨å¤©') {
                filteredProjects = originalProjects.filter(project => {
                    if (!project.create_time) return false;
                    try {
                        const createDate = new Date(project.create_time);
                        createDate.setHours(0, 0, 0, 0);
                        const timeDiff = today.getTime() - createDate.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        return daysDiff === 1;
                    } catch (e) {
                        return false;
                    }
                });
            } else if (label.endsWith('å¤©')) {
                // å¤„ç†å…·ä½“å¤©æ•°ï¼Œå¦‚"2å¤©"ã€"3å¤©"ç­‰
                const days = parseInt(label.replace('å¤©', ''));
                if (!isNaN(days)) {
                    filteredProjects = originalProjects.filter(project => {
                        if (!project.create_time) return false;
                        try {
                            const createDate = new Date(project.create_time);
                            createDate.setHours(0, 0, 0, 0);
                            const timeDiff = today.getTime() - createDate.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            return daysDiff === days;
                        } catch (e) {
                            return false;
                        }
                    });
                }
            } else if (label === 'æ—¥æœŸæ— æ•ˆ') {
                filteredProjects = originalProjects.filter(project => {
                    if (!project.create_time) return false;
                    try {
                        new Date(project.create_time);
                        return false; // å¦‚æœæ—¥æœŸæœ‰æ•ˆï¼Œä¸åŒ…å«åœ¨æ­¤ç»„
                    } catch (e) {
                        return true; // å¦‚æœæ—¥æœŸæ— æ•ˆï¼ŒåŒ…å«åœ¨æ­¤ç»„
                    }
                });
            } else if (label === 'æœªè®¾ç½®') {
                filteredProjects = originalProjects.filter(project => !project.create_time);
            }
        }

        // æ˜¾ç¤ºç­›é€‰åçš„æ•°æ®åˆ—è¡¨ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„è¿‡æ»¤å™¨
        showModalDataList(`${modalTitle} - ${label}`, filteredProjects, null, true);

        // è®¾ç½®å¯¹åº”çš„è¿‡æ»¤å™¨å€¼
        setFilterValues(chartId, label);

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        showFilterNotification(`${label}: å…±æ‰¾åˆ° ${filteredProjects.length} ä¸ªé¡¹ç›®`);
    }

    // è®¾ç½®è¿‡æ»¤å™¨å€¼
    function setFilterValues(chartId, label) {
        // ç­‰å¾…DOMæ›´æ–°å®Œæˆåè®¾ç½®è¿‡æ»¤å™¨å€¼
        setTimeout(() => {
            if (chartId === 'categoryChart') {
                const categoryFilter = document.getElementById('modalCategoryFilter');
                if (categoryFilter) {
                    if (label === 'æœªåˆ†ç±»') {
                        categoryFilter.value = ''; // æœªåˆ†ç±»å¯¹åº”ç©ºå€¼
                    } else {
                        categoryFilter.value = label;
                    }
                }
            } else if (chartId === 'leaderChart') {
                const leaderFilter = document.getElementById('modalLeaderFilter');
                if (leaderFilter) {
                    if (label === 'æœªæŒ‡å®š') {
                        leaderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                    } else {
                        leaderFilter.value = label;
                    }
                }
            } else if (chartId === 'testerChart') {
                const testerFilter = document.getElementById('modalTesterFilter');
                if (testerFilter) {
                    if (label === 'æœªæŒ‡å®š') {
                        testerFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                    } else {
                        testerFilter.value = label;
                    }
                }
            } else if (chartId === 'dqeLeaderChart') {
                // DQEè´Ÿè´£äººç­›é€‰å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
                if (dqeLeaderFilter) {
                    if (label === 'æœªæŒ‡å®š') {
                        dqeLeaderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                    } else {
                        dqeLeaderFilter.value = label;
                    }
                }
            } else if (chartId === 'rdLeaderChart') {
                // ç ”å‘è´Ÿè´£äººç­›é€‰å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
                if (rdLeaderFilter) {
                    if (label === 'æœªæŒ‡å®š') {
                        rdLeaderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                    } else {
                        rdLeaderFilter.value = label;
                    }
                }
            } else if (chartId === 'sampleSenderChart') {
                // é€æ ·äººç­›é€‰å™¨
                const sampleSenderFilter = document.getElementById('modalSampleSenderFilter');
                if (sampleSenderFilter) {
                    if (label === 'æœªæŒ‡å®š') {
                        sampleSenderFilter.value = ''; // æœªæŒ‡å®šå¯¹åº”ç©ºå€¼
                    } else {
                        sampleSenderFilter.value = label;
                    }
                }
            } else if (chartId === 'scheduleChart') {
                const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
                if (scheduleDaysFilter) {
                    if (label === 'æœªè®¾ç½®') {
                        scheduleDaysFilter.value = 'æœªè®¾ç½®';
                    } else {
                        const days = parseInt(label.replace('å¤©', ''));
                        scheduleDaysFilter.value = days;
                    }
                }
            }
        }, 100);
    }

    // æ˜¾ç¤ºç­›é€‰é€šçŸ¥
    function showFilterNotification(message) {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
        notification.textContent = message;

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
        document.head.appendChild(style);

        document.body.appendChild(notification);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);

        // æ·»åŠ æ»‘å‡ºåŠ¨ç”»
        const slideOutStyle = document.createElement('style');
        slideOutStyle.textContent = `
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
        document.head.appendChild(slideOutStyle);
    }

    // å›¾è¡¨æ”¾å¤§ç¼©å°åŠŸèƒ½
    function zoomChart(chartId, direction) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        // æ£€æŸ¥å½“å‰å›¾è¡¨ç±»å‹
        const svg = chartContainer.querySelector('svg');
        const flexContainer = chartContainer.querySelector('div[style*="display: flex"]');

        // å¦‚æœæ˜¯æŸ±çŠ¶å›¾ï¼ˆflexå®¹å™¨ï¼‰ï¼Œåˆ™ä¸æ‰§è¡Œç¼©æ”¾
        if (flexContainer && !svg) {
            console.log('æŸ±çŠ¶å›¾ä¸æ”¯æŒç¼©æ”¾åŠŸèƒ½');
            return;
        }

        // è·å–å½“å‰å°ºå¯¸
        const currentHeight = parseInt(chartContainer.style.height) || 350;
        const currentWidth = chartContainer.offsetWidth;

        // è®¡ç®—æ–°çš„å°ºå¯¸ï¼ˆæ¯æ¬¡è°ƒæ•´20pxï¼‰
        const newHeight = Math.max(250, Math.min(600, currentHeight + (direction * 20)));

        // åº”ç”¨æ–°å°ºå¯¸
        chartContainer.style.height = newHeight + 'px';

        // å¦‚æœé«˜åº¦å˜åŒ–è¾ƒå¤§ï¼Œè°ƒæ•´SVGå°ºå¯¸
        if (svg) {
            const scale = newHeight / 350; // åŸºäºåŸå§‹é«˜åº¦350pxè®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const newSvgSize = 250 * scale;
            svg.style.width = newSvgSize + 'px';
            svg.style.height = newSvgSize + 'px';
            svg.style.transform = `scale(${scale})`;
            svg.style.transformOrigin = 'center center';
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateZoomButtons(chartId, newHeight);
    }

    // æ›´æ–°æ”¾å¤§ç¼©å°æŒ‰é’®çŠ¶æ€
    function updateZoomButtons(chartId, currentHeight) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        const container = chartContainer.closest('.chart-container, div[style*="background: #f8f9fa"]');
        if (!container) return;

        const zoomOutBtn = container.querySelector('button[onclick*="-1"]');
        const zoomInBtn = container.querySelector('button[onclick*="1"]');

        // æ£€æŸ¥å½“å‰å›¾è¡¨ç±»å‹
        const svg = chartContainer.querySelector('svg');
        const flexContainer = chartContainer.querySelector('div[style*="display: flex"]');

        // å¦‚æœæ˜¯æŸ±çŠ¶å›¾ï¼Œç¦ç”¨æ”¾å¤§ç¼©å°æŒ‰é’®
        if (flexContainer && !svg) {
            if (zoomOutBtn) {
                zoomOutBtn.disabled = true;
                zoomOutBtn.style.opacity = '0.3';
                zoomOutBtn.style.cursor = 'not-allowed';
                zoomOutBtn.title = 'æŸ±çŠ¶å›¾ä¸æ”¯æŒç¼©æ”¾';
            }
            if (zoomInBtn) {
                zoomInBtn.disabled = true;
                zoomInBtn.style.opacity = '0.3';
                zoomInBtn.style.cursor = 'not-allowed';
                zoomInBtn.title = 'æŸ±çŠ¶å›¾ä¸æ”¯æŒç¼©æ”¾';
            }
            return;
        }

        // é¥¼å›¾çš„æ­£å¸¸æŒ‰é’®çŠ¶æ€æ›´æ–°
        if (zoomOutBtn) {
            zoomOutBtn.disabled = currentHeight <= 250;
            zoomOutBtn.style.opacity = currentHeight <= 250 ? '0.5' : '1';
            zoomOutBtn.style.cursor = currentHeight <= 250 ? 'not-allowed' : 'pointer';
            zoomOutBtn.title = 'ç¼©å°';
        }

        if (zoomInBtn) {
            zoomInBtn.disabled = currentHeight >= 600;
            zoomInBtn.style.opacity = currentHeight >= 600 ? '0.5' : '1';
            zoomInBtn.style.cursor = currentHeight >= 600 ? 'not-allowed' : 'pointer';
            zoomInBtn.title = 'æ”¾å¤§';
        }
    }

    // å¯¼å‡ºå½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„æ•°æ®
    function exportCurrentModalData(title) {
        // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let projectsToExport = [];

        // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
        switch(modalTitle) {
            case 'é¡¹ç›®æ€»æ•°':
                projectsToExport = projectData;
                break;
            case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                projectsToExport = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                projectsToExport = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                projectsToExport = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                projectsToExport = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
            default:
                // å¦‚æœæ ‡é¢˜åŒ…å«ç­›é€‰ä¿¡æ¯ï¼ˆå¦‚"é¡¹ç›®æ€»æ•° - äº§å“ç±»åˆ«"ï¼‰
                if (modalTitle.includes(' - ')) {
                    const [baseTitle, filterValue] = modalTitle.split(' - ');

                    // æ ¹æ®åŸºç¡€æ ‡é¢˜è·å–åŸå§‹æ•°æ®
                    let baseProjects = [];
                    switch(baseTitle) {
                        case 'é¡¹ç›®æ€»æ•°':
                            baseProjects = projectData;
                            break;
                        case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                            baseProjects = projectData.filter(p =>
                                !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                            );
                            break;
                        case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                            baseProjects = projectData.filter(p =>
                                p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                            );
                            break;
                        case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                            baseProjects = projectData.filter(p =>
                                p.actual_finish_time && !p.sampleRecognizeResult
                            );
                            break;
                        case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                            baseProjects = projectData.filter(p =>
                                p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                            );
                            break;
                    }

                    // æ ¹æ®ç­›é€‰å€¼è¿›ä¸€æ­¥ç­›é€‰
                    if (filterValue && baseProjects.length > 0) {
                        if (filterValue.includes('å¤©')) {
                            // æ’æœŸå¤©æ•°ç­›é€‰
                            if (filterValue === 'æœªè®¾ç½®') {
                                projectsToExport = baseProjects.filter(project =>
                                    !project.scheduleDays || isNaN(project.scheduleDays)
                                );
                            } else {
                                const days = parseInt(filterValue.replace('å¤©', ''));
                                projectsToExport = baseProjects.filter(project =>
                                    project.scheduleDays === days
                                );
                            }
                        } else {
                            // å…¶ä»–ç­›é€‰ï¼ˆäº§å“ç±»åˆ«ã€è´Ÿè´£äººç­‰ï¼‰
                            projectsToExport = baseProjects.filter(project => {
                                return project.sample_category === filterValue ||
                                    project.sample_leader === filterValue ||
                                    project.tester === filterValue;
                            });
                        }
                    } else {
                        projectsToExport = baseProjects;
                    }
                } else {
                    projectsToExport = projectData;
                }
                break;
        }

        // åº”ç”¨æ‰€æœ‰ç­›é€‰æ¡ä»¶ï¼ˆå¦‚æœè®¾ç½®äº†ç­›é€‰ï¼‰
        const startDate = document.getElementById('modalStartDate')?.value;
        const endDate = document.getElementById('modalEndDate')?.value;
        const category = document.getElementById('modalCategoryFilter')?.value;
        const tester = document.getElementById('modalTesterFilter')?.value;
        const leader = document.getElementById('modalLeaderFilter')?.value;
        const dqeLeader = document.getElementById('modalDqeLeaderFilter')?.value;
        const rdLeader = document.getElementById('modalRdLeaderFilter')?.value;
        const scheduleDays = document.getElementById('modalScheduleDaysFilter')?.value;

        if (startDate || endDate || category || tester || leader || dqeLeader || rdLeader || scheduleDays) {
            projectsToExport = projectsToExport.filter(project => {
                // ç±»åˆ«ç­›é€‰
                if (category && project.sample_category !== category) {
                    return false;
                }

                // æµ‹è¯•è´Ÿè´£äººç­›é€‰
                if (tester && project.tester !== tester) {
                    return false;
                }

                // é¡¹ç›®è´Ÿè´£äººç­›é€‰
                if (leader && project.sample_leader !== leader) {
                    return false;
                }

                // DQEè´Ÿè´£äººç­›é€‰
                if (dqeLeader && project.dqe_leader !== dqeLeader) {
                    return false;
                }

                // ç ”å‘è´Ÿè´£äººç­›é€‰
                if (rdLeader && project.rd_leader !== rdLeader) {
                    return false;
                }

                // æ’æœŸå¤©æ•°ç­›é€‰
                if (scheduleDays) {
                    if (scheduleDays === 'æœªè®¾ç½®') {
                        if (project.scheduleDays && !isNaN(project.scheduleDays)) {
                            return false;
                        }
                    } else {
                        if (project.scheduleDays !== parseInt(scheduleDays)) {
                            return false;
                        }
                    }
                }

                // æ—¶é—´ç­›é€‰
                if (startDate || endDate) {
                    if (!project.create_time) return false;

                    const createDate = new Date(project.create_time);
                    let matchesDate = true;

                    if (startDate) {
                        const start = new Date(startDate);
                        matchesDate = matchesDate && createDate >= start;
                    }

                    if (endDate) {
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        matchesDate = matchesDate && createDate <= end;
                    }

                    if (!matchesDate) return false;
                }

                return true;
            });
        }

        if (projectsToExport.length === 0) {
            alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
            return;
        }

        console.log('å¯¼å‡ºç­›é€‰åçš„æ•°æ®ï¼Œæ•°é‡:', projectsToExport.length);
        console.log('ç­›é€‰åçš„æ•°æ®:', projectsToExport);

        // è°ƒç”¨åŸæœ‰çš„å¯¼å‡ºå‡½æ•°ï¼Œä¼ å…¥ç­›é€‰åçš„æ•°æ®
        exportToExcel(title, projectsToExport);
    }

    // å¯¼å‡ºExcelåŠŸèƒ½
    function exportToExcel(title, projectsToExport) {
        console.log('å¼€å§‹å¯¼å‡ºExcelï¼Œæ ‡é¢˜:', title);
        console.log('SheetJSåº“æ˜¯å¦å¯ç”¨:', typeof XLSX !== 'undefined');
        console.log('è¦å¯¼å‡ºçš„æ•°æ®é•¿åº¦:', projectsToExport.length);

        // ä½¿ç”¨ä¼ å…¥çš„projectsToExportï¼Œè€Œä¸æ˜¯é‡æ–°ç­›é€‰
        const projects = projectsToExport;

        if (projects.length === 0) {
            alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
            return;
        }

        try {
            // å‡†å¤‡è¡¨å¤´
            const headers = [
                'æ ·å“ç¼–å·', 'äº§å“åç§°', 'äº§å“ç±»åˆ«', 'å¤§ç¼–ç ', 'ç‰ˆæœ¬', 'é¡¹ç›®è´Ÿè´£äºº',
                'å½“å‰è¿›åº¦', 'æµ‹è¯•è´Ÿè´£äºº', 'DQEè´Ÿè´£äºº', 'ç ”å‘è´Ÿè´£äºº', 'é€æ ·äºº', 'é€æ ·ç±»åˆ«', 'åˆ›å»ºæ—¶é—´', 'æ’æœŸå¤©æ•°',
                'æ’æœŸå¼€å§‹', 'æ’æœŸç»“æŸ', 'å®é™…å¼€å§‹æ—¶é—´', 'å®é™…å®Œæˆæ—¶é—´', 'æ‰¿è®¤ç»“æœ', 'DQEæ‰¿è®¤ç»“æœ', 'ç ”å‘æ‰¿è®¤ç»“æœ'
            ];

            // å‡†å¤‡æ•°æ®
            const data = projects.map(project => [
                project.sample_id || '',
                project.sample_name || '',
                project.sample_category || '',
                project.sample_model || '',
                project.version || '',
                project.sample_leader || '',
                getProjectStatus(project),
                project.tester || '',
                project.dqe_leader || '',
                project.rd_leader || '',
                project.sample_sender || '',
                project.sample_type || '',
                formatDateTime(project.create_time) || '',
                project.scheduleDays || '',
                formatDate(project.schedule_start_date) || '',
                formatDate(project.schedule_end_date) || '',
                formatDateTime(project.actual_start_time) || '',
                formatDateTime(project.actual_finish_time) || '',
                project.sampleRecognizeResult || '',
                project.sampleRecognizeResult || '',
                project.rd_sampleRecognizeResult || ''
            ]);

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

            // è®¾ç½®åˆ—å®½
            const colWidths = headers.map(() => ({ wch: 15 }));
            ws['!cols'] = colWidths;

            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'é¡¹ç›®æ•°æ®');

            // ç”Ÿæˆæ–‡ä»¶å
            const fileName = `${title}_${new Date().toISOString().slice(0, 10)}.xlsx`;

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, fileName);

            alert('å¯¼å‡ºæˆåŠŸï¼');
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ï¼');
        }
    }

    // è·å–é¡¹ç›®çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
    function getProjectStatus(project) {
        if (!project.actual_start_time) {
            return 'æœªå¼€å§‹';
        } else if (project.actual_start_time && !project.actual_finish_time) {
            return 'è¿›è¡Œä¸­';
        } else if (project.actual_finish_time && !project.sampleRecognizeResult) {
            return 'å·²å®Œæˆæœªç¡®è®¤';
        } else if (project.actual_finish_time && project.sampleRecognizeResult) {
            return 'å·²ç¡®è®¤';
        }
        return 'æœªçŸ¥çŠ¶æ€';
    }

    // æ¨¡æ€æ¡†ç­›é€‰åŠŸèƒ½
    function applyModalFilters() {
        const startDate = document.getElementById('modalStartDate').value;
        const endDate = document.getElementById('modalEndDate').value;
        const category = document.getElementById('modalCategoryFilter')?.value;
        const tester = document.getElementById('modalTesterFilter')?.value;
        const leader = document.getElementById('modalLeaderFilter')?.value;
        const dqeLeader = document.getElementById('modalDqeLeaderFilter')?.value;
        const rdLeader = document.getElementById('modalRdLeaderFilter')?.value;
        const scheduleDays = document.getElementById('modalScheduleDaysFilter')?.value;

        // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let originalProjects = [];

        // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
        switch(modalTitle) {
            case 'é¡¹ç›®æ€»æ•°':
                originalProjects = projectData;
                break;
            case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // åº”ç”¨æ‰€æœ‰ç­›é€‰æ¡ä»¶
        let filteredProjects = originalProjects.filter(project => {
            // ç±»åˆ«ç­›é€‰
            if (category && project.sample_category !== category) {
                return false;
            }

            // æµ‹è¯•è´Ÿè´£äººç­›é€‰
            if (tester && project.tester !== tester) {
                return false;
            }

            // é¡¹ç›®è´Ÿè´£äººç­›é€‰
            if (leader && project.sample_leader !== leader) {
                return false;
            }

            // DQEè´Ÿè´£äººç­›é€‰
            if (dqeLeader && project.dqe_leader !== dqeLeader) {
                return false;
            }

            // ç ”å‘è´Ÿè´£äººç­›é€‰
            if (rdLeader && project.rd_leader !== rdLeader) {
                return false;
            }

            // æ’æœŸå¤©æ•°ç­›é€‰
            if (scheduleDays) {
                if (scheduleDays === 'æœªè®¾ç½®') {
                    if (project.scheduleDays && !isNaN(project.scheduleDays)) {
                        return false;
                    }
                } else {
                    if (project.scheduleDays !== parseInt(scheduleDays)) {
                        return false;
                    }
                }
            }

            // æ—¶é—´ç­›é€‰
            if (startDate || endDate) {
                if (!project.create_time) return false;

                const createDate = new Date(project.create_time);
                let matchesDate = true;

                if (startDate) {
                    const start = new Date(startDate);
                    matchesDate = matchesDate && createDate >= start;
                }

                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    matchesDate = matchesDate && createDate <= end;
                }

                if (!matchesDate) return false;
            }

            return true;
        });

        // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹ - ä¿æŒå½“å‰æ˜¾ç¤ºæ¨¡å¼
        const currentContent = document.getElementById('modalContent').innerHTML;
        if (currentContent.includes('æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ')) {
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯å›¾è¡¨ï¼Œåˆ™æ›´æ–°å›¾è¡¨
            showModalCharts(modalTitle, filteredProjects);
        } else {
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨ï¼Œåˆ™æ›´æ–°æ•°æ®åˆ—è¡¨ï¼Œä¿æŒè¿‡æ»¤å™¨å€¼
            showModalDataList(modalTitle, filteredProjects, null, true);
        }
    }

    // é‡ç½®æ¨¡æ€æ¡†ç­›é€‰
    function resetModalFilters() {
        // é‡ç½®æ‰€æœ‰è¿‡æ»¤å™¨
        document.getElementById('modalStartDate').value = '';
        document.getElementById('modalEndDate').value = '';

        const categoryFilter = document.getElementById('modalCategoryFilter');
        if (categoryFilter) categoryFilter.value = '';

        const testerFilter = document.getElementById('modalTesterFilter');
        if (testerFilter) testerFilter.value = '';

        const leaderFilter = document.getElementById('modalLeaderFilter');
        if (leaderFilter) leaderFilter.value = '';

        const dqeLeaderFilter = document.getElementById('modalDqeLeaderFilter');
        if (dqeLeaderFilter) dqeLeaderFilter.value = '';

        const rdLeaderFilter = document.getElementById('modalRdLeaderFilter');
        if (rdLeaderFilter) rdLeaderFilter.value = '';

        const scheduleDaysFilter = document.getElementById('modalScheduleDaysFilter');
        if (scheduleDaysFilter) scheduleDaysFilter.value = '';

        // é‡æ–°æ˜¾ç¤ºåŸå§‹æ•°æ®
        const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
        let originalProjects = [];

        switch(modalTitle) {
            case 'é¡¹ç›®æ€»æ•°':
                originalProjects = projectData;
                break;
            case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                );
                break;
            case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.actual_finish_time && !p.sampleRecognizeResult
                );
                break;
            case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                originalProjects = projectData.filter(p =>
                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                );
                break;
        }

        // ä¿æŒå½“å‰æ˜¾ç¤ºæ¨¡å¼
        const currentContent = document.getElementById('modalContent').innerHTML;
        if (currentContent.includes('æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ')) {
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯å›¾è¡¨ï¼Œåˆ™æ›´æ–°å›¾è¡¨
            showModalCharts(modalTitle, originalProjects);
        } else {
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨ï¼Œåˆ™æ›´æ–°æ•°æ®åˆ—è¡¨ï¼Œä¿æŒè¿‡æ»¤å™¨å€¼
            showModalDataList(modalTitle, originalProjects, null, true);
        }
    }

    // åˆ‡æ¢å›¾è¡¨ç±»å‹ï¼ˆæŸ±çŠ¶å›¾/é¥¼çŠ¶å›¾ï¼‰
    function toggleChartType(chartId, dataJson) {
        try {
            const data = JSON.parse(dataJson);
            const chartContainer = document.getElementById(chartId);
            const toggleBtn = chartContainer.parentElement.querySelector('button[onclick*="toggleChartType"]');

            if (!chartContainer || !toggleBtn) return;

            // æ£€æŸ¥å½“å‰å›¾è¡¨ç±»å‹
            const currentChart = chartContainer.querySelector('svg, div[style*="display: flex"]');
            const isCurrentlyBar = currentChart && currentChart.style.display === 'flex';

            if (isCurrentlyBar) {
                // å½“å‰æ˜¯æŸ±çŠ¶å›¾ï¼Œåˆ‡æ¢åˆ°é¥¼çŠ¶å›¾
                chartContainer.innerHTML = createPieChart(data, chartId);
                toggleBtn.innerHTML = 'ğŸ•';
                toggleBtn.title = 'åˆ‡æ¢åˆ°æŸ±çŠ¶å›¾';
            } else {
                // å½“å‰æ˜¯é¥¼çŠ¶å›¾ï¼Œåˆ‡æ¢åˆ°æŸ±çŠ¶å›¾
                chartContainer.innerHTML = createBarChart(data, chartId);
                toggleBtn.innerHTML = 'ğŸ“Š';
                toggleBtn.title = 'åˆ‡æ¢åˆ°é¥¼çŠ¶å›¾';
            }

            // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå› ä¸ºé‡æ–°ç”Ÿæˆäº†HTMLï¼‰
            bindChartClickEvents(chartId);

            // é‡æ–°ç»‘å®štooltipäº‹ä»¶
            bindTooltipEvents(chartId);

        } catch (error) {
            console.error('åˆ‡æ¢å›¾è¡¨ç±»å‹å¤±è´¥:', error);
        }
    }

    // ç»‘å®šå›¾è¡¨ç‚¹å‡»äº‹ä»¶
    function bindChartClickEvents(chartId) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        // ä¸ºé¥¼å›¾çš„æ‰‡å½¢æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
        segments.forEach(segment => {
            const label = segment.getAttribute('data-label');
            const value = segment.getAttribute('data-value');
            if (label && value) {
                segment.onclick = () => filterByChartSegment(chartId, label, parseInt(value));
            }
        });

        // ä¸ºæŸ±çŠ¶å›¾çš„æŸ±å­æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const bars = chartContainer.querySelectorAll('div[data-label][data-value]');
        bars.forEach(bar => {
            const label = bar.getAttribute('data-label');
            const value = bar.getAttribute('data-value');
            if (label && value) {
                // ç¡®ä¿è¿™æ˜¯çœŸæ­£çš„æŸ±å­ï¼ˆæœ‰èƒŒæ™¯è‰²çš„divï¼‰
                if (bar.style.background || bar.style.backgroundColor) {
                    bar.onclick = () => filterByChartSegment(chartId, label, parseInt(value));
                }
            }
        });
    }

    // ç»‘å®štooltipäº‹ä»¶
    function bindTooltipEvents(chartId) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;

        // ä¸ºé¥¼å›¾çš„æ‰‡å½¢æ·»åŠ tooltipäº‹ä»¶
        const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
        segments.forEach(segment => {
            const label = segment.getAttribute('data-label');
            const value = segment.getAttribute('data-value');
            if (label && value) {
                segment.onmouseover = (event) => showSegmentTooltip(event, label, parseInt(value), ((parseInt(value) / getTotalValue(chartId)) * 100).toFixed(1));
                segment.onmouseout = hideSegmentTooltip;
            }
        });
    }

    // è·å–å›¾è¡¨æ•°æ®æ€»å’Œ
    function getTotalValue(chartId) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return 0;

        // å°è¯•ä»dataå±æ€§è·å–å€¼
        const elements = chartContainer.querySelectorAll('[data-value]');
        let total = 0;
        elements.forEach(element => {
            const value = parseInt(element.getAttribute('data-value'));
            if (!isNaN(value)) {
                total += value;
            }
        });

        return total;
    }

    // æ¨¡æ€æ¡†å¯¼å‡ºExcelåŠŸèƒ½ï¼ˆå¯¼å‡ºç­›é€‰åçš„æ•°æ®ï¼‰
    function exportModalExcel(title) {
        // è·å–å½“å‰æ¨¡æ€æ¡†ä¸­å®é™…æ˜¾ç¤ºçš„æ•°æ®
        let projectsToExport = [];

        // æ£€æŸ¥å½“å‰æ¨¡æ€æ¡†æ˜¯å¦æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨
        const modalContent = document.getElementById('modalContent');
        if (modalContent && modalContent.innerHTML.includes('è¯¦ç»†æ•°æ®åˆ—è¡¨')) {
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ•°æ®åˆ—è¡¨ï¼Œè·å–è¡¨æ ¼ä¸­çš„å®é™…æ•°æ®
            const tableRows = modalContent.querySelectorAll('table tbody tr');
            if (tableRows.length > 0) {
                // ä»è¡¨æ ¼è¡Œä¸­æå–æ•°æ®
                projectsToExport = Array.from(tableRows).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 15) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                        return {
                            sample_id: cells[0].textContent.trim(),
                            sample_name: cells[1].textContent.trim(),
                            sample_category: cells[2].textContent.trim(),
                            sample_leader: cells[3].textContent.trim(),
                            tester: cells[4].textContent.trim(),
                            dqe_leader: cells[5].textContent.trim(),
                            rd_leader: cells[6].textContent.trim(),
                            sample_sender: cells[7].textContent.trim(),
                            scheduleDays: cells[8].textContent.trim(),
                            schedule_start_date: cells[9].textContent.trim(),
                            schedule_end_date: cells[10].textContent.trim(),
                            actual_start_time: cells[11].textContent.trim(),
                            actual_finish_time: cells[12].textContent.trim(),
                            create_time: cells[13].textContent.trim(),
                            sampleRecognizeResult: cells[14].textContent.trim(),
                            rd_sampleRecognizeResult: cells[15] ? cells[15].textContent.trim() : ''
                        };
                    }
                    return null;
                }).filter(Boolean);
            }
        }

        // å¦‚æœæ— æ³•ä»è¡¨æ ¼è·å–æ•°æ®ï¼Œåˆ™æ ¹æ®æ ‡é¢˜è·å–åŸºç¡€æ•°æ®
        if (projectsToExport.length === 0) {
            switch(title) {
                case 'é¡¹ç›®æ€»æ•°':
                    projectsToExport = projectData;
                    break;
                case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    projectsToExport = projectData.filter(p =>
                        p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                    );
                    break;
                default:
                    // å¦‚æœæ ‡é¢˜åŒ…å«ç­›é€‰ä¿¡æ¯ï¼ˆå¦‚"é¡¹ç›®æ€»æ•° - äº§å“ç±»åˆ«"ï¼‰
                    if (title.includes(' - ')) {
                        const [baseTitle, filterValue] = title.split(' - ');

                        // æ ¹æ®åŸºç¡€æ ‡é¢˜è·å–åŸå§‹é¡¹ç›®æ•°æ®
                        let baseProjects = [];
                        switch(baseTitle) {
                            case 'é¡¹ç›®æ€»æ•°':
                                baseProjects = projectData;
                                break;
                            case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p =>
                                    !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                                );
                                break;
                            case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p =>
                                    p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                                );
                                break;
                            case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p =>
                                    p.actual_finish_time && !p.sampleRecognizeResult
                                );
                                break;
                            case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                                baseProjects = projectData.filter(p =>
                                    p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                                );
                                break;
                        }

                        // æ ¹æ®ç­›é€‰å€¼è¿›ä¸€æ­¥ç­›é€‰
                        if (filterValue && baseProjects.length > 0) {
                            if (filterValue.includes('å¤©')) {
                                // æ’æœŸå¤©æ•°ç­›é€‰
                                if (filterValue === 'æœªè®¾ç½®') {
                                    projectsToExport = baseProjects.filter(project =>
                                        !project.scheduleDays || isNaN(project.scheduleDays)
                                    );
                                } else {
                                    const days = parseInt(filterValue.replace('å¤©', ''));
                                    projectsToExport = baseProjects.filter(project =>
                                        project.scheduleDays === days
                                    );
                                }
                            } else {
                                // å…¶ä»–ç­›é€‰ï¼ˆäº§å“ç±»åˆ«ã€è´Ÿè´£äººç­‰ï¼‰
                                projectsToExport = baseProjects.filter(project => {
                                    return project.sample_category === filterValue ||
                                        project.sample_leader === filterValue ||
                                        project.tester === filterValue ||
                                        project.dqe_leader === filterValue ||
                                        project.rd_leader === filterValue ||
                                        project.sample_sender === filterValue;
                                });
                            }
                        } else {
                            projectsToExport = baseProjects;
                        }
                    } else {
                        projectsToExport = projectData;
                    }
                    break;
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯ä»¥å¯¼å‡º
        if (projectsToExport.length === 0) {
            alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
            return;
        }

        console.log('å¯¼å‡ºæ•°æ®ï¼Œæ ‡é¢˜:', title, 'æ•°é‡:', projectsToExport.length);
        console.log('å¯¼å‡ºçš„æ•°æ®:', projectsToExport);

        // è°ƒç”¨åŸæœ‰çš„å¯¼å‡ºå‡½æ•°ï¼Œä¼ å…¥ç­›é€‰åçš„æ•°æ®
        exportToExcel(title, projectsToExport);
    }

    // æ˜¾ç¤ºè‡ªå®šä¹‰å›¾è¡¨æ¨¡æ€æ¡†
    function showDynamicChartModal(title, projects, status) {
        // å¡«å……å­—æ®µé€‰æ‹©å™¨
        populateFieldSelector();

        // å­˜å‚¨å½“å‰é¡¹ç›®æ•°æ®ä¾›å›¾è¡¨ç”Ÿæˆä½¿ç”¨
        window.currentProjectsForChart = projects;
        window.currentChartTitle = title;
        window.currentChartStatus = status;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('dynamicChartModal').style.display = 'block';

        // å¡«å……å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨
        populateSavedChartsList();
    }

    // å…³é—­è‡ªå®šä¹‰å›¾è¡¨æ¨¡æ€æ¡†
    function closeDynamicChartModal() {
        document.getElementById('dynamicChartModal').style.display = 'none';
    }

    // å¡«å……å­—æ®µé€‰æ‹©å™¨
    function populateFieldSelector() {
        const fieldSelector = document.getElementById('fieldSelector');
        const fields = [
            { value: 'sample_actual_id', label: 'æ ·å“ç¼–å·' },
            { value: 'sample_model', label: 'å¤§ç¼–ç ' },
            { value: 'sample_frequency', label: 'é€æ ·æ¬¡æ•°' },
            { value: 'sample_name', label: 'äº§å“åç§°' },
            { value: 'version', label: 'ç‰ˆæœ¬å·' },
            { value: 'priority', label: 'ä¼˜å…ˆçº§' },
            { value: 'supplier', label: 'ä¾›åº”å•†' },
            { value: 'schedule', label: 'å½“å‰è¿›åº¦' },
            { value: 'create_time', label: 'åˆ›å»ºæ—¶é—´' },
            { value: 'schedule_start_date', label: 'æ’æœŸå¼€å§‹æ—¶é—´' },
            { value: 'schedule_end_date', label: 'æ’æœŸç»“æŸæ—¶é—´' },
            { value: 'actual_start_time', label: 'å®é™…å¼€å§‹æµ‹è¯•æ—¶é—´' },
            { value: 'actual_finish_time', label: 'å®é™…æµ‹è¯•æ—¶é—´' },
            { value: 'schedule_color', label: 'æ’æœŸé¢œè‰²' },
            { value: 'reportReviewTime', label: 'æŠ¥å‘Šå®¡æ ¸æ—¶é—´' },
            { value: 'testDuration', label: 'å®é™…æµ‹è¯•æ—¶é•¿' },
            { value: 'sample_type', label: 'é€æ ·ç±»åˆ«' },
            { value: 'sample_quantity', label: 'é€æ ·æ•°é‡' },
            { value: 'high_frequency', label: 'æ˜¯å¦é«˜é¢‘' }
        ];

        fieldSelector.innerHTML = '<option value="">è¯·é€‰æ‹©è¦åˆ†æçš„å­—æ®µ</option>';
        fields.forEach(field => {
            fieldSelector.innerHTML += `<option value="${field.value}">${field.label}</option>`;
        });
    }

    // ç”Ÿæˆè‡ªå®šä¹‰å›¾è¡¨
    function generateDynamicChart() {
        const fieldName = document.getElementById('fieldSelector').value;
        const chartType = document.getElementById('chartTypeSelector').value;
        const topN = parseInt(document.getElementById('topNSelector').value) || 10;

        if (!fieldName) {
            alert('è¯·é€‰æ‹©è¦åˆ†æçš„å­—æ®µï¼');
            return;
        }

        if (!window.currentProjectsForChart || window.currentProjectsForChart.length === 0) {
            alert('æ²¡æœ‰æ•°æ®å¯ä»¥åˆ†æï¼');
            return;
        }

        // ç»Ÿè®¡æ•°æ®
        const stats = {};
        window.currentProjectsForChart.forEach(project => {
            let value = project[fieldName];

            // å¤„ç†ä¸åŒç±»å‹çš„å€¼
            if (value === null || value === undefined || value === '') {
                value = 'æœªè®¾ç½®';
            } else if (fieldName === 'scheduleDays') {
                value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å¤©';
            } else if (fieldName === 'testDuration') {
                value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å°æ—¶';
            } else if (fieldName === 'sample_frequency') {
                value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'æ¬¡';
            } else if (fieldName === 'isUsed') {
                value = value === 1 ? 'å·²ç”¨' : value === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
            } else if (fieldName === 'isCancel') {
                value = value === 1 ? 'å·²ä½œåºŸ' : value === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
            } else if (fieldName === 'high_frequency') {
                value = value === '1' || value === 1 ? 'æ˜¯' : value === '0' || value === 0 ? 'å¦' : value || 'æœªè®¾ç½®';
            } else if (fieldName.includes('date') || fieldName.includes('time') || fieldName === 'reportReviewTime') {
                // å¯¹äºæ—¥æœŸæ—¶é—´å­—æ®µï¼Œæå–å¹´æœˆæ—¥
                if (value && value !== 'æœªè®¾ç½®') {
                    try {
                        const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                            value = date.toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        value = 'æ— æ•ˆæ—¥æœŸ';
                    }
                }
            } else if (fieldName === 'priority') {
                // ä¼˜å…ˆçº§å­—æ®µç‰¹æ®Šå¤„ç†
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = 'æœªè®¾ç½®';
                }
            } else if (fieldName === 'schedule') {
                // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                if (value !== null && value !== undefined && value !== '') {
                    // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                    const progressMap = {
                        '0': 'æœªå¼€å§‹',
                        '1': 'è¿›è¡Œä¸­',
                        '2': 'å·²å®Œæˆæœªç¡®è®¤',
                        '3': 'æŠ¥å‘Šç¡®è®¤é—­ç¯'
                    };
                    value = progressMap[value.toString()] || `è¿›åº¦${value}`;
                } else {
                    value = 'æœªè®¾ç½®';
                }
            } else if (fieldName === 'sample_type') {
                // é€æ ·ç±»åˆ«å­—æ®µç‰¹æ®Šå¤„ç†
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = 'æœªè®¾ç½®';
                }
            }

            stats[value] = (stats[value] || 0) + 1;
        });

        // æ’åºå¹¶å–å‰Nä¸ª
        const sortedStats = Object.entries(stats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, topN);

        // é‡æ–°æ„å»ºç»Ÿè®¡æ•°æ®
        const finalStats = {};
        sortedStats.forEach(([key, value]) => {
            finalStats[key] = value;
        });

        // ç”Ÿæˆå›¾è¡¨
        const chartContainer = document.getElementById('dynamicChartContainer');
        if (chartType === 'pie') {
            chartContainer.innerHTML = createPieChart(finalStats, 'dynamicChart');
        } else if (chartType === 'line') {
            chartContainer.innerHTML = createLineChart(finalStats, 'dynamicChart');
        } else {
            chartContainer.innerHTML = createBarChart(finalStats, 'dynamicChart');
        }

        // ç»‘å®šå›¾è¡¨äº‹ä»¶
        bindDynamicChartEvents();
    }

    // æ¸…é™¤è‡ªå®šä¹‰å›¾è¡¨
    function clearDynamicChart() {
        document.getElementById('dynamicChartContainer').innerHTML = `
                <div style="text-align: center; color: #666;">
                    <p>è¯·é€‰æ‹©å­—æ®µå¹¶ç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®</p>
                </div>
            `;
    }

    // ä¿å­˜å›¾è¡¨åˆ°é¡¹ç›®è¯¦æƒ…
    function saveChartToProjectDetails() {
        const fieldName = document.getElementById('fieldSelector').value;
        const chartType = document.getElementById('chartTypeSelector').value;
        const topN = parseInt(document.getElementById('topNSelector').value) || 10;

        if (!fieldName) {
            alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨ï¼');
            return;
        }

        // è·å–å­—æ®µæ ‡ç­¾
        const fieldSelector = document.getElementById('fieldSelector');
        const selectedOption = fieldSelector.options[fieldSelector.selectedIndex];
        const fieldLabel = selectedOption ? selectedOption.text : fieldName;

        // åˆ›å»ºå›¾è¡¨é…ç½®å¯¹è±¡
        const chartConfig = {
            id: Date.now(), // å”¯ä¸€ID
            fieldName: fieldName,
            fieldLabel: fieldLabel,
            chartType: chartType,
            topN: topN,
            title: `${fieldLabel}åˆ†å¸ƒ`,
            projects: window.currentProjectsForChart,
            status: window.currentChartStatus,
            createTime: new Date().toLocaleString('zh-CN')
        };

        // ä¿å­˜åˆ°localStorageï¼Œæ”¯æŒå¤šä¸ªå›¾è¡¨
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const key = `${window.currentChartTitle}_${window.currentChartStatus}`;

        if (!savedCharts[key]) {
            savedCharts[key] = [];
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå­—æ®µçš„å›¾è¡¨
        const existingIndex = savedCharts[key].findIndex(chart => chart.fieldName === fieldName);
        if (existingIndex !== -1) {
            if (confirm(`å·²å­˜åœ¨"${fieldLabel}"çš„å›¾è¡¨ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ`)) {
                savedCharts[key][existingIndex] = chartConfig;
            } else {
                return; // ç”¨æˆ·å–æ¶ˆæ›¿æ¢
            }
        } else {
            savedCharts[key].push(chartConfig);
        }

        localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));

        alert(`å›¾è¡¨å·²ä¿å­˜ï¼ä¸‹æ¬¡è¿›å…¥"${window.currentChartTitle}"æ—¶å°†è‡ªåŠ¨æ˜¾ç¤ºæ­¤å›¾è¡¨ã€‚`);

        // åˆ·æ–°å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨
        populateSavedChartsList();
    }

    // ç»‘å®šè‡ªå®šä¹‰å›¾è¡¨äº‹ä»¶
    function bindDynamicChartEvents() {
        const chartContainer = document.getElementById('dynamicChartContainer');

        // ä¸ºé¥¼å›¾çš„æ‰‡å½¢æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const segments = chartContainer.querySelectorAll('path[id^="segment_"]');
        segments.forEach(segment => {
            const label = segment.getAttribute('data-label');
            const value = segment.getAttribute('data-value');
            if (label && value) {
                segment.onclick = () => {
                    alert(`ç‚¹å‡»äº†: ${label}, æ•°é‡: ${value}`);
                };
            }
        });

        // ä¸ºæŸ±çŠ¶å›¾çš„æŸ±å­æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const bars = chartContainer.querySelectorAll('div[data-label][data-value]');
        bars.forEach(bar => {
            const label = bar.getAttribute('data-label');
            const value = bar.getAttribute('data-value');
            if (label && value) {
                if (bar.style.background || bar.style.backgroundColor) {
                    bar.onclick = () => {
                        alert(`ç‚¹å‡»äº†: ${label}, æ•°é‡: ${value}`);
                    };
                }
            }
        });
    }

    // åˆ›å»ºæŠ˜çº¿å›¾
    function createLineChart(data, chartId) {
        const labels = Object.keys(data);
        const values = Object.values(data);
        const maxValue = Math.max(...values);

        let svg = `<svg width="100%" height="100%" viewBox="0 0 800 400">`;

        // ç»˜åˆ¶åæ ‡è½´
        svg += `<line x1="50" y1="350" x2="750" y2="350" stroke="#333" stroke-width="2"/>`;
        svg += `<line x1="50" y1="50" x2="50" y2="350" stroke="#333" stroke-width="2"/>`;

        // ç»˜åˆ¶æŠ˜çº¿
        if (labels.length > 1) {
            let pathData = '';
            labels.forEach((label, index) => {
                const x = 50 + (index * 700) / (labels.length - 1);
                const y = 350 - (values[index] * 300) / maxValue;

                if (index === 0) {
                    pathData = `M ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                }
            });

            svg += `<path d="${pathData}" stroke="#007bff" stroke-width="3" fill="none"/>`;

            // ç»˜åˆ¶æ•°æ®ç‚¹
            labels.forEach((label, index) => {
                const x = 50 + (index * 700) / (labels.length - 1);
                const y = 350 - (values[index] * 300) / maxValue;

                // æ£€æŸ¥æ˜¯å¦ä¸ºä¿å­˜çš„å›¾è¡¨ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const isSavedChart = chartId.startsWith('savedChart_');
                const clickEvent = isSavedChart ? `onclick="handleSavedChartClick('${chartId}', event)"` : '';

                svg += `<circle cx="${x}" cy="${y}" r="5" fill="#007bff" style="cursor: pointer;" data-label="${label}" data-value="${values[index]}" ${clickEvent}/>`;
                svg += `<text x="${x}" y="${y + 20}" text-anchor="middle" font-size="12" fill="#333">${values[index]}</text>`;
            });
        }

        // ç»˜åˆ¶æ ‡ç­¾
        labels.forEach((label, index) => {
            const x = 50 + (index * 700) / (labels.length - 1);
            svg += `<text x="${x}" y="380" text-anchor="middle" font-size="10" fill="#666">${label}</text>`;
        });

        svg += `</svg>`;
        return svg;
    }

    // è·å–å›¾è¡¨ç±»å‹åç§°
    function getChartTypeName(chartType) {
        const typeNames = {
            'bar': 'æŸ±çŠ¶å›¾',
            'pie': 'é¥¼å›¾',
            'line': 'æŠ˜çº¿å›¾'
        };
        return typeNames[chartType] || chartType;
    }

    // ç”Ÿæˆä¿å­˜çš„å›¾è¡¨
    function generateSavedChart(chartConfig, projects, containerId) {
        // ç»Ÿè®¡æ•°æ®
        const stats = {};
        const valueToProjects = {}; // å­˜å‚¨æ¯ä¸ªå€¼å¯¹åº”çš„é¡¹ç›®åˆ—è¡¨

        projects.forEach(project => {
            let value = project[chartConfig.fieldName];

            // å¤„ç†ä¸åŒç±»å‹çš„å€¼ï¼ˆä¸generateDynamicChartä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
            if (value === null || value === undefined || value === '') {
                value = 'æœªè®¾ç½®';
            } else if (chartConfig.fieldName === 'scheduleDays') {
                value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å¤©';
            } else if (chartConfig.fieldName === 'testDuration') {
                value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'å°æ—¶';
            } else if (chartConfig.fieldName === 'sample_frequency') {
                value = isNaN(value) ? 'æœªè®¾ç½®' : value + 'æ¬¡';
            } else if (chartConfig.fieldName === 'isUsed') {
                value = value === 1 ? 'å·²ç”¨' : value === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
            } else if (chartConfig.fieldName === 'isCancel') {
                value = value === 1 ? 'å·²ä½œåºŸ' : value === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
            } else if (chartConfig.fieldName === 'high_frequency') {
                value = value === '1' || value === 1 ? 'æ˜¯' : value === '0' || value === 0 ? 'å¦' : value || 'æœªè®¾ç½®';
            } else if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
                if (value && value !== 'æœªè®¾ç½®') {
                    try {
                        const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                            value = date.toLocaleDateString('zh-CN');
                        }
                    } catch (e) {
                        value = 'æ— æ•ˆæ—¥æœŸ';
                    }
                }
            } else if (['priority', 'sample_type'].includes(chartConfig.fieldName)) {
                if (value && value.trim() !== '') {
                    value = value.trim();
                } else {
                    value = value || 'æœªè®¾ç½®';
                }
            } else if (chartConfig.fieldName === 'schedule') {
                // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                if (value !== null && value !== undefined && value !== '') {
                    // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                    const progressMap = {
                        '0': 'æœªå¼€å§‹',
                        '1': 'è¿›è¡Œä¸­',
                        '2': 'å·²å®Œæˆ',
                        '3': 'å·²æš‚åœ',
                        '4': 'å·²å–æ¶ˆ'
                    };
                    value = progressMap[value.toString()] || `è¿›åº¦${value}`;
                } else {
                    value = 'æœªè®¾ç½®';
                }
            }

            stats[value] = (stats[value] || 0) + 1;

            // å­˜å‚¨æ¯ä¸ªå€¼å¯¹åº”çš„é¡¹ç›®åˆ—è¡¨
            if (!valueToProjects[value]) {
                valueToProjects[value] = [];
            }
            valueToProjects[value].push(project);
        });

        // æ’åºå¹¶å–å‰Nä¸ª
        const sortedStats = Object.entries(stats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, chartConfig.topN);

        // é‡æ–°æ„å»ºç»Ÿè®¡æ•°æ®
        const finalStats = {};
        sortedStats.forEach(([key, value]) => {
            finalStats[key] = value;
        });

        // ä¸ºå›¾è¡¨æ·»åŠ ç‚¹å‡»äº‹ä»¶æ•°æ®
        const chartId = containerId || `savedChart_${chartConfig.id || Date.now()}`;
        const clickData = {
            chartConfig: chartConfig,
            valueToProjects: valueToProjects,
            projects: projects
        };

        // å­˜å‚¨ç‚¹å‡»æ•°æ®åˆ°å…¨å±€å˜é‡
        window.savedChartClickData = window.savedChartClickData || {};
        window.savedChartClickData[chartId] = clickData;

        // ç”Ÿæˆå›¾è¡¨å¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶æ ‡è¯†
        let chartHTML = '';
        if (chartConfig.chartType === 'pie') {
            chartHTML = createPieChart(finalStats, chartId);
        } else if (chartConfig.chartType === 'line') {
            chartHTML = createLineChart(finalStats, chartId);
        } else {
            chartHTML = createBarChart(finalStats, chartId);
        }

        return chartHTML;
    }

    // åˆ é™¤ä¿å­˜çš„å›¾è¡¨
    function removeSavedChart(chartKey, chartId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰å›¾è¡¨å—ï¼Ÿ')) {
            const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');

            if (savedCharts[chartKey]) {
                // ä»æ•°ç»„ä¸­åˆ é™¤æŒ‡å®šIDçš„å›¾è¡¨
                savedCharts[chartKey] = savedCharts[chartKey].filter(chart => chart.id !== chartId);

                // å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ é™¤æ•´ä¸ªkey
                if (savedCharts[chartKey].length === 0) {
                    delete savedCharts[chartKey];
                }

                localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
            }

            // åˆ·æ–°é¡µé¢æ˜¾ç¤º
            const currentStatus = window.currentChartStatus || 'total';
            showProjectDetails(currentStatus);
        }
    }

    // å¡«å……å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨
    function populateSavedChartsList() {
        const savedChartsList = document.getElementById('savedChartsList');
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const chartKey = `${window.currentChartTitle}_${window.currentChartStatus}`;
        let charts = savedCharts[chartKey] || [];

        // ç¡®ä¿chartsæ˜¯æ•°ç»„
        if (!Array.isArray(charts)) {
            // å¦‚æœæ˜¯æ—§æ ¼å¼çš„å•ä¸ªå›¾è¡¨ï¼Œè½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
            if (charts && typeof charts === 'object' && charts.fieldName) {
                charts = [charts];
                // æ›´æ–°localStorageä¸ºæ–°çš„æ•°ç»„æ ¼å¼
                savedCharts[chartKey] = charts;
                localStorage.setItem('savedProjectCharts', JSON.stringify(savedCharts));
            } else {
                charts = [];
            }
        }

        if (charts.length === 0) {
            savedChartsList.innerHTML = '<p style="color: #666; text-align: center;">æš‚æ— ä¿å­˜çš„å›¾è¡¨</p>';
            return;
        }

        let html = '';
        charts.forEach((chart, index) => {
            html += `
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #333;">${chart.title}</strong>
                                <span style="color: #666; font-size: 12px; margin-left: 10px;">å­—æ®µ: ${chart.fieldLabel}</span>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-outline-primary" onclick="loadSavedChart('${chartKey}', ${chart.id})" title="åŠ è½½æ­¤å›¾è¡¨">ğŸ“Š</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeSavedChart('${chartKey}', ${chart.id})" title="åˆ é™¤æ­¤å›¾è¡¨">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ç±»å‹: ${getChartTypeName(chart.chartType)} | æ˜¾ç¤º: å‰${chart.topN}ä¸ª | åˆ›å»º: ${chart.createTime}
                        </div>
                    </div>
                `;
        });

        savedChartsList.innerHTML = html;
    }

    // åŠ è½½ä¿å­˜çš„å›¾è¡¨åˆ°å›¾è¡¨å®¹å™¨
    function loadSavedChart(chartKey, chartId) {
        const savedCharts = JSON.parse(localStorage.getItem('savedProjectCharts') || '{}');
        const charts = savedCharts[chartKey] || [];
        const chart = charts.find(c => c.id === chartId);

        if (chart) {
            // è®¾ç½®å­—æ®µé€‰æ‹©å™¨
            document.getElementById('fieldSelector').value = chart.fieldName;
            document.getElementById('chartTypeSelector').value = chart.chartType;
            document.getElementById('topNSelector').value = chart.topN;

            // ç”Ÿæˆå›¾è¡¨
            generateDynamicChart();

            alert(`å·²åŠ è½½"${chart.title}"å›¾è¡¨é…ç½®`);
        }
    }

    // å¤„ç†ä¿å­˜å›¾è¡¨çš„ç‚¹å‡»äº‹ä»¶
    function handleSavedChartClick(chartId, event) {
        console.log('ä¿å­˜å›¾è¡¨ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼ŒchartId:', chartId);

        const clickData = window.savedChartClickData[chartId];
        if (!clickData) {
            console.error('æœªæ‰¾åˆ°å›¾è¡¨ç‚¹å‡»æ•°æ®ï¼ŒchartId:', chartId);
            return;
        }

        // è·å–ç‚¹å‡»çš„å…ƒç´ 
        const target = event.target;
        let label = '';
        let value = 0;

        // æ ¹æ®å›¾è¡¨ç±»å‹è·å–ç‚¹å‡»çš„æ ‡ç­¾å’Œå€¼
        if (clickData.chartConfig.chartType === 'pie') {
            // é¥¼å›¾ï¼šä»pathå…ƒç´ è·å–æ•°æ®
            if (target.tagName === 'path' && target.getAttribute('data-label')) {
                label = target.getAttribute('data-label');
                value = parseInt(target.getAttribute('data-value')) || 0;
            }
        } else if (clickData.chartConfig.chartType === 'bar') {
            // æŸ±çŠ¶å›¾ï¼šä»divå…ƒç´ è·å–æ•°æ®
            if (target.getAttribute('data-label')) {
                label = target.getAttribute('data-label');
                value = parseInt(target.getAttribute('data-value')) || 0;
            }
        } else if (clickData.chartConfig.chartType === 'line') {
            // æŠ˜çº¿å›¾ï¼šä»circleå…ƒç´ è·å–æ•°æ®
            if (target.tagName === 'circle') {
                label = target.getAttribute('data-label');
                value = parseInt(target.getAttribute('data-value')) || 0;
            }
        }

        if (label && value > 0) {
            // è·å–å½“å‰æ¨¡æ€æ¡†æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®
            const modalTitle = document.getElementById('modalTitle').querySelector('span').textContent;
            let originalProjects = [];

            // æ ¹æ®æ ‡é¢˜é‡æ–°è·å–åŸå§‹é¡¹ç›®æ•°æ®
            switch(modalTitle) {
                case 'é¡¹ç›®æ€»æ•°':
                    originalProjects = projectData;
                    break;
                case 'æœªå¼€å§‹é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        !p.actual_start_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'è¿›è¡Œä¸­é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_start_time && !p.actual_finish_time && p.schedule !== 'å·²å®Œæˆ'
                    );
                    break;
                case 'å·²å®Œæˆæœªç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.actual_finish_time && !p.sampleRecognizeResult
                    );
                    break;
                case 'å·²ç¡®è®¤é¡¹ç›®è¯¦æƒ…':
                    originalProjects = projectData.filter(p =>
                        p.sampleRecognizeResult && p.sampleRecognizeResult.trim() !== ''
                    );
                    break;
            }

            // æ ¹æ®è‡ªå®šä¹‰å›¾è¡¨çš„å­—æ®µå’Œæ ‡ç­¾ç­›é€‰é¡¹ç›®
            let filteredProjects = originalProjects.filter(project => {
                let projectValue = project[clickData.chartConfig.fieldName];

                // å¤„ç†ä¸åŒç±»å‹çš„å€¼ï¼Œä¸ç”Ÿæˆå›¾è¡¨æ—¶çš„é€»è¾‘ä¿æŒä¸€è‡´
                if (projectValue === null || projectValue === undefined || projectValue === '') {
                    projectValue = 'æœªè®¾ç½®';
                } else if (clickData.chartConfig.fieldName === 'scheduleDays') {
                    projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å¤©';
                } else if (clickData.chartConfig.fieldName === 'testDuration') {
                    projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å°æ—¶';
                } else if (clickData.chartConfig.fieldName === 'sample_frequency') {
                    projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'æ¬¡';
                } else if (clickData.chartConfig.fieldName === 'isUsed') {
                    projectValue = projectValue === 1 ? 'å·²ç”¨' : projectValue === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
                } else if (clickData.chartConfig.fieldName === 'isCancel') {
                    projectValue = projectValue === 1 ? 'å·²ä½œåºŸ' : projectValue === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
                } else if (clickData.chartConfig.fieldName === 'high_frequency') {
                    projectValue = projectValue === '1' || projectValue === 1 ? 'æ˜¯' : projectValue === '0' || projectValue === 0 ? 'å¦' : projectValue || 'æœªè®¾ç½®';
                } else if (clickData.chartConfig.fieldName.includes('date') || clickData.chartConfig.fieldName.includes('time') || clickData.chartConfig.fieldName === 'reportReviewTime') {
                    if (projectValue && projectValue !== 'æœªè®¾ç½®') {
                        try {
                            const date = new Date(projectValue);
                            if (!isNaN(date.getTime())) {
                                projectValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            projectValue = 'æ— æ•ˆæ—¥æœŸ';
                        }
                    }
                } else if (['priority', 'sample_type'].includes(clickData.chartConfig.fieldName)) {
                    if (projectValue && projectValue.trim() !== '') {
                        projectValue = projectValue.trim();
                    } else {
                        projectValue = projectValue || 'æœªè®¾ç½®';
                    }
                } else if (clickData.chartConfig.fieldName === 'schedule') {
                    // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                    if (projectValue !== null && projectValue !== undefined && projectValue !== '') {
                        // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                        const progressMap = {
                            '0': 'æœªå¼€å§‹',
                            '1': 'è¿›è¡Œä¸­',
                            '2': 'å·²å®Œæˆ',
                            '3': 'å·²æš‚åœ',
                            '4': 'å·²å–æ¶ˆ'
                        };
                        projectValue = progressMap[projectValue.toString()] || `è¿›åº¦${projectValue}`;
                    } else {
                        projectValue = 'æœªè®¾ç½®';
                    }
                }

                return projectValue === label;
            });

            // æ˜¾ç¤ºç­›é€‰åçš„æ•°æ®åˆ—è¡¨ï¼Œå°±åƒé»˜è®¤å›¾è¡¨ä¸€æ ·
            showModalDataList(`${modalTitle} - ${label}`, filteredProjects, null, true);

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showFilterNotification(`${label}: å…±æ‰¾åˆ° ${filteredProjects.length} ä¸ªé¡¹ç›®`);
        }
    }

    // æ˜¾ç¤ºä¿å­˜å›¾è¡¨çš„æ•°æ®è¯¦æƒ…æ¨¡æ€æ¡†
    function showSavedChartDataModal(clickData, label, value) {
        const { chartConfig, valueToProjects, projects } = clickData;

        // è·å–å¯¹åº”æ ‡ç­¾çš„é¡¹ç›®åˆ—è¡¨
        let filteredProjects = [];
        if (valueToProjects[label]) {
            filteredProjects = valueToProjects[label];
        } else {
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»åŸå§‹æ•°æ®ä¸­ç­›é€‰
            filteredProjects = projects.filter(project => {
                let projectValue = project[chartConfig.fieldName];

                // å¤„ç†ä¸åŒç±»å‹çš„å€¼
                if (projectValue === null || projectValue === undefined || projectValue === '') {
                    projectValue = 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName === 'scheduleDays') {
                    projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å¤©';
                } else if (chartConfig.fieldName === 'testDuration') {
                    projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'å°æ—¶';
                } else if (chartConfig.fieldName === 'sample_frequency') {
                    projectValue = isNaN(projectValue) ? 'æœªè®¾ç½®' : projectValue + 'æ¬¡';
                } else if (chartConfig.fieldName === 'isUsed') {
                    projectValue = projectValue === 1 ? 'å·²ç”¨' : value === 0 ? 'æœªç”¨' : 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName === 'isCancel') {
                    projectValue = projectValue === 1 ? 'å·²ä½œåºŸ' : projectValue === 0 ? 'æœªä½œåºŸ' : 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName === 'high_frequency') {
                    projectValue = projectValue === '1' || projectValue === 1 ? 'æ˜¯' : projectValue === '0' || projectValue === 0 ? 'å¦' : projectValue || 'æœªè®¾ç½®';
                } else if (chartConfig.fieldName.includes('date') || chartConfig.fieldName.includes('time') || chartConfig.fieldName === 'reportReviewTime') {
                    if (projectValue && projectValue !== 'æœªè®¾ç½®') {
                        try {
                            const date = new Date(projectValue);
                            if (!isNaN(date.getTime())) {
                                projectValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            projectValue = 'æ— æ•ˆæ—¥æœŸ';
                        }
                    }
                } else if (['priority', 'sample_type'].includes(chartConfig.fieldName)) {
                    if (projectValue && projectValue.trim() !== '') {
                        projectValue = projectValue.trim();
                    } else {
                        projectValue = 'æœªè®¾ç½®';
                    }
                } else if (chartConfig.fieldName === 'schedule') {
                    // è¿›åº¦å­—æ®µç‰¹æ®Šå¤„ç† - æ•°æ®åº“å€¼ä¸º0,1,2,3,4
                    if (projectValue !== null && projectValue !== undefined && projectValue !== '') {
                        // å°†æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„è¿›åº¦æè¿°
                        const progressMap = {
                            '0': 'æœªå¼€å§‹',
                            '1': 'è¿›è¡Œä¸­',
                            '2': 'å·²å®Œæˆ',
                            '3': 'å·²æš‚åœ',
                            '4': 'å·²å–æ¶ˆ'
                        };
                        projectValue = progressMap[projectValue.toString()] || `è¿›åº¦${projectValue}`;
                    } else {
                        projectValue = 'æœªè®¾ç½®';
                    }
                }

                return projectValue === label;
            });
        }

        // åˆ›å»ºæ•°æ®è¯¦æƒ…æ¨¡æ€æ¡†
        const modalHTML = `
                <div id="savedChartDataModal" class="modal">
                    <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90%; max-height: 800px;">
                        <div class="modal-header">
                            <h3>${chartConfig.title} - ${label} (${filteredProjects.length}ä¸ªé¡¹ç›®)</h3>
                            <span class="close" onclick="closeSavedChartDataModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span style="color: #666;">å­—æ®µ: ${chartConfig.fieldLabel}</span>
                                    <span style="color: #666;">|</span>
                                    <span style="color: #666;">å›¾è¡¨ç±»å‹: ${getChartTypeName(chartConfig.chartType)}</span>
                                    <span style="color: #666;">|</span>
                                    <span style="color: #666;">æ˜¾ç¤ºæ•°é‡: å‰${chartConfig.topN}ä¸ª</span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th>æµ‹è¯•ç¼–å·</th>
                                            <th>æ ·å“ç¼–å·</th>
                                            <th>äº§å“ç±»åˆ«</th>
                                            <th>äº§å“åç§°</th>
                                            <th>é¡¹ç›®è´Ÿè´£äºº</th>
                                            <th>æµ‹è¯•è´Ÿè´£äºº</th>
                                            <th>é€æ ·äºº</th>
                                            <th>æ’æœŸå¤©æ•°</th>
                                            <th>è®¡åˆ’å¼€å§‹æ—¶é—´</th>
                                            <th>è®¡åˆ’ç»“æŸæ—¶é—´</th>
                                            <th>å®é™…å¼€å§‹æ—¶é—´</th>
                                            <th>å®é™…å®Œæˆæ—¶é—´</th>
                                            <th>åˆ›å»ºæ—¶é—´</th>
                                            <th>DQEæ‰¿è®¤ç»“æœ</th>
                                            <th>ç ”å‘æ‰¿è®¤ç»“æœ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredProjects.map(project => `
                                            <tr>
                                                <td>${project.sample_id || '-'}</td>
                                                <td>${project.sample_actual_id || '-'}</td>
                                                <td>${project.sample_category || '-'}</td>
                                                <td>${project.sample_name || '-'}</td>
                                                <td>${project.sample_leader || '-'}</td>
                                                <td>${project.tester || '-'}</td>
                                                <td>${project.sample_sender || '-'}</td>
                                                <td>${project.scheduleDays || '-'}</td>
                                                <td>${project.schedule_start_date || '-'}</td>
                                                <td>${project.schedule_end_date || '-'}</td>
                                                <td>${project.actual_start_time || '-'}</td>
                                                <td>${project.actual_finish_time || '-'}</td>
                                                <td>${project.create_time || '-'}</td>
                                                <td>${project.sampleRecognizeResult || '-'}</td>
                                                <td>${project.rd_sampleRecognizeResult || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('savedChartDataModal').style.display = 'block';
    }

    // å…³é—­ä¿å­˜å›¾è¡¨çš„æ•°æ®è¯¦æƒ…æ¨¡æ€æ¡†
    function closeSavedChartDataModal() {
        const modal = document.getElementById('savedChartDataModal');
        if (modal) {
            modal.remove();
        }
    }
</script>

<!-- è‡ªå®šä¹‰å›¾è¡¨æ¨¡æ€æ¡† -->
<div id="dynamicChartModal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 1200px; height: 85%; max-height: 700px;">
        <div class="modal-header">
            <h3>è‡ªå®šä¹‰å›¾è¡¨ç”Ÿæˆå™¨</h3>
            <span class="close" onclick="closeDynamicChartModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <label style="font-weight: bold;">é€‰æ‹©å­—æ®µ:</label>
                    <select id="fieldSelector" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                        <option value="">è¯·é€‰æ‹©è¦åˆ†æçš„å­—æ®µ</option>
                    </select>
                    <button class="btn btn-primary" onclick="generateDynamicChart()">ç”Ÿæˆå›¾è¡¨</button>
                    <button class="btn btn-success" onclick="saveChartToProjectDetails()">ä¿å­˜åˆ°é¡¹ç›®è¯¦æƒ…</button>
                    <button class="btn btn-secondary" onclick="clearDynamicChart()">æ¸…é™¤å›¾è¡¨</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: bold;">å›¾è¡¨ç±»å‹:</label>
                    <select id="chartTypeSelector" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="bar">æŸ±çŠ¶å›¾</option>
                        <option value="pie">é¥¼å›¾</option>
                        <option value="line">æŠ˜çº¿å›¾</option>
                    </select>
                    <label style="font-weight: bold; margin-left: 15px;">æ˜¾ç¤ºæ•°é‡:</label>
                    <input type="number" id="topNSelector" value="10" min="1" max="50" style="width: 80px;">
                    <span style="color: #666; font-size: 12px;">(æ˜¾ç¤ºå‰Nä¸ªæœ€å¤šçš„å€¼)</span>
                </div>
            </div>
            <div id="dynamicChartContainer" style="height: 500px; border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #f9f9f9; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center; color: #666;">
                    <p>è¯·é€‰æ‹©å­—æ®µå¹¶ç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®</p>
                </div>
            </div>

            <!-- å·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨ -->
            <div style="margin-top: 20px;">
                <h4 style="color: #333; margin-bottom: 15px;">å·²ä¿å­˜çš„å›¾è¡¨</h4>
                <div id="savedChartsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- åŠ¨æ€å¡«å……å·²ä¿å­˜çš„å›¾è¡¨ -->
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>