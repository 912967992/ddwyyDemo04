<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é¡¹ç›®è¯†åˆ«ä¸ç»Ÿè®¡åˆ†æç³»ç»Ÿ</title>
    <!-- Chart.js å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.9em;
            }
        }
        
        .main-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .main-panel {
                padding: 20px;
                border-radius: 10px;
                margin: 10px 0;
            }
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
                gap: 15px;
            }
        }
        
        .input-group input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .input-group input {
                min-width: 100%;
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
            }
        }
        
        .input-group button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .analysis-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        
        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        
        @media (max-width: 768px) {
            .result-table {
                font-size: 14px;
            }
            
            .result-table th,
            .result-table td {
                padding: 8px 4px;
                min-width: 80px;
            }
        }
        
        .result-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .result-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: top;
        }
        
        .result-table tr:hover {
            background: #f8f9fa;
        }
        
        /* è®¾ç½®å„åˆ—å®½åº¦ */
        .result-table th:nth-child(1), .result-table td:nth-child(1) { width: 8%; }   /* åºå· */
        .result-table th:nth-child(2), .result-table td:nth-child(2) { width: 12%; }  /* æ”¶æ ·æ—¶é—´ */
        .result-table th:nth-child(3), .result-table td:nth-child(3) { width: 12%; }  /* æ ·å“å‹å· */
        .result-table th:nth-child(4), .result-table td:nth-child(4) { width: 12%; }  /* å°ç¼–ç  */
        .result-table th:nth-child(5), .result-table td:nth-child(5) { width: 15%; }  /* ä¾›åº”å•† */
        .result-table th:nth-child(6), .result-table td:nth-child(6) { width: 12%; }  /* æ ·å“åˆ†ç±» */
        .result-table th:nth-child(7), .result-table td:nth-child(7) { width: 12%; }  /* æ ·å“æ€§è´¨ */
        .result-table th:nth-child(8), .result-table td:nth-child(8) { width: 8%; }   /* é€æ ·æ¬¡æ•° */
        .result-table th:nth-child(9), .result-table td:nth-child(9) { width: 8%; }   /* ç‰ˆæœ¬å· */
        .result-table th:nth-child(10), .result-table td:nth-child(10) { width: 8%; } /* åŒ¹é…åº¦ */
        
        /* è¡¨æ ¼å®¹å™¨æ ·å¼ */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                padding: 15px;
                margin-top: 20px;
            }
        }
        
        #timeline {
            height: 300px;
        }
        
        .algorithm-info {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .algorithm-info h4 {
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        /* æ·±åº¦ç»Ÿè®¡åˆ†ææ ·å¼ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-wrap: nowrap;
                overflow-x: scroll;
                padding-bottom: 10px;
            }
        }
        
        .tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .tab {
                padding: 10px 16px;
                font-size: 14px;
                margin-right: 3px;
            }
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .analysis-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .analysis-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .metric-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .metric-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            height: 400px;
            position: relative;
            border: 1px solid #e0e0e0;
        }
        
        .chart-container canvas {
            width: 100% !important;
            height: 350px !important;
            max-height: 350px;
        }
        
        .chart-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .pattern-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .pattern-tag {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        /* æ·»åŠ æ•°æ®å¯¼å…¥åŒºåŸŸæ ·å¼ */
        .data-import {
            background: #f0f4f8;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .data-import input[type="file"] {
            display: none;
        }
        
        .data-import label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .data-import label:hover {
            background: #5a67d8;
        }
        
        .upload-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .upload-status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .upload-status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .upload-status.loading {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ff9800;
        }
        
        .data-info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .data-info div {
            margin: 2px 0;
        }
        
        /* ä¸‹æ‹‰å®¹å™¨æ ·å¼ */
        .dropdown-container {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .dropdown-container input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .dropdown-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .dropdown-container datalist {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .dropdown-container option {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .dropdown-container option:hover {
            background: #f8f9fa;
        }
        
        /* æ¸…é™¤æŒ‰é’®æ ·å¼ */
        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .clear-btn:hover {
            background: #ff5252;
            transform: translateY(-50%) scale(1.1);
        }
        
        .clear-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        /* æ—¶é—´ç»´åº¦é€‰æ‹©å™¨æ ·å¼ */
        .time-dimension-selector {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .dimension-buttons {
            display: flex;
            gap: 8px;
        }
        
        .dimension-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 50px;
        }
        
        .dimension-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f0f4ff;
        }
        
        .dimension-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .dimension-btn.active:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
        }
        
        /* åˆ†é¡µæ§åˆ¶æ ·å¼ */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        @media (max-width: 768px) {
            .pagination-controls {
                flex-direction: column;
                gap: 15px;
                padding: 10px;
            }
        }
        
        .pagination-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .page-size-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }
        
        .page-size-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        @media (max-width: 768px) {
            .page-btn {
                padding: 12px 16px;
                min-width: 60px;
                font-size: 16px;
                min-height: 44px; /* è§¦æ‘¸å‹å¥½çš„æœ€å°é«˜åº¦ */
            }
        }
        
        .page-btn.icon-btn {
            padding: 8px 12px;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-btn .icon {
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
        }
        
        .page-btn:hover:not(:disabled) {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .page-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
            border-color: #e0e0e0;
        }
        
        .page-info {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            margin: 0 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // é˜²æ­¢å¤–éƒ¨è„šæœ¬é”™è¯¯å½±å“ç³»ç»Ÿ
        window.addEventListener('error', function(e) {
            if (e.filename && (e.filename.includes('share-modal.js') || e.filename.includes('cdn'))) {
                console.warn('å¤–éƒ¨è„šæœ¬é”™è¯¯å·²å¿½ç•¥:', e.message);
                e.preventDefault();
                return false;
            }
        });
        
        // å±è”½ç‰¹å®šçš„å¤–éƒ¨è„šæœ¬é”™è¯¯
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.toString().includes('share-modal')) {
                console.warn('å¤–éƒ¨è„šæœ¬Promiseé”™è¯¯å·²å¿½ç•¥');
                e.preventDefault();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æ™ºèƒ½é¡¹ç›®è¯†åˆ«ä¸ç»Ÿè®¡åˆ†æç³»ç»Ÿ</h1>
            <p>å¤„ç†å¤æ‚å¤šæ ·çš„å‹å·å’Œç¼–ç ç»„åˆï¼Œç²¾å‡†è¯†åˆ«é¡¹ç›®å”¯ä¸€æ€§</p>
        </div>
        
        <div class="main-panel">
            <!-- æ•°æ®å¯¼å…¥åŒº -->
            <div class="section">
                <h2 class="section-title">æ•°æ®æº</h2>
                <div class="data-import">
                    <label for="fileInput">
                        ğŸ“ å¯¼å…¥Excelæ•°æ®
                    </label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                    <div id="uploadStatus" class="upload-status">
                        å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¼”ç¤º | æ”¯æŒ Excel(.xlsx, .xls)ã€CSV(.csv) æ ¼å¼ | å¯ç›´æ¥ä½¿ç”¨æµ‹è¯•æœç´¢åŠŸèƒ½
                    </div>
                    <div id="dataInfo" class="data-info">
                        <!-- æ•°æ®ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
            
            <!-- æœç´¢åˆ†æåŒº -->
            <div class="section">
                <h2 class="section-title">é¡¹ç›®æ™ºèƒ½æœç´¢</h2>
                <div class="input-group">
                    <div class="dropdown-container">
                        <input type="text" id="modelSearch" placeholder="è¾“å…¥æ ·å“å‹å·ï¼ˆå¦‚ï¼šAK500ï¼‰">
                        <button type="button" class="clear-btn" id="clearModel" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="codeSearch" placeholder="è¾“å…¥å°ç¼–ç ï¼ˆå¦‚ï¼š55455ï¼‰">
                        <button type="button" class="clear-btn" id="clearCode" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="categorySearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ ·å“åˆ†ç±»" list="categoryList" autocomplete="off">
                        <datalist id="categoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearCategory" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="propertySearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ ·å“æ€§è´¨" list="propertyList" autocomplete="off">
                        <datalist id="propertyList"></datalist>
                        <button type="button" class="clear-btn" id="clearProperty" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="subCategorySearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥å“ç±»ç»†åˆ†" list="subCategoryList" autocomplete="off">
                        <datalist id="subCategoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearSubCategory" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="testerSearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥æµ‹è¯•äºº" list="testerList" autocomplete="off">
                        <datalist id="testerList"></datalist>
                        <button type="button" class="clear-btn" id="clearTester" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="electronicEngineerSearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥ç”µå­å·¥ç¨‹å¸ˆ" list="electronicEngineerList" autocomplete="off">
                        <datalist id="electronicEngineerList"></datalist>
                        <button type="button" class="clear-btn" id="clearElectronicEngineer" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="projectEngineerSearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥é¡¹ç›®å·¥ç¨‹å¸ˆ" list="projectEngineerList" autocomplete="off">
                        <datalist id="projectEngineerList"></datalist>
                        <button type="button" class="clear-btn" id="clearProjectEngineer" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="dqeSearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥DQE" list="dqeList" autocomplete="off">
                        <datalist id="dqeList"></datalist>
                        <button type="button" class="clear-btn" id="clearDqe" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="dqeCategorySearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥DQEå“ç±»ç»†åˆ†" list="dqeCategoryList" autocomplete="off">
                        <datalist id="dqeCategoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearDqeCategory" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="newCategorySearch" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ–°åˆ†ç±»" list="newCategoryList" autocomplete="off">
                        <datalist id="newCategoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearNewCategory" style="display: none;" title="æ¸…é™¤">Ã—</button>
                    </div>
                    <div class="dropdown-container">
                        <!-- é¢„ç•™ä½ç½®ï¼Œå¯ä»¥æ·»åŠ æ›´å¤šç­›é€‰é¡¹ -->
                    </div>
                </div>
                
                <!-- æ—¥æœŸèŒƒå›´ç­›é€‰ -->
                <div class="input-group" style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <div class="date-range-container">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">ğŸ“… æ—¥æœŸèŒƒå›´ç­›é€‰</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 0.9em; color: #666;">ä»</label>
                                <input type="date" id="startDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 0.9em; color: #666;">è‡³</label>
                                <input type="date" id="endDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <button onclick="setDateRange('all')" style="padding: 6px 12px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; cursor: pointer;">å…¨éƒ¨</button>
                            <button onclick="setDateRange('thisMonth')" style="padding: 6px 12px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; font-size: 12px; cursor: pointer;">æœ¬æœˆ</button>
                            <button onclick="setDateRange('lastMonth')" style="padding: 6px 12px; background: #f3e5f5; border: 1px solid #9c27b0; border-radius: 4px; font-size: 12px; cursor: pointer;">ä¸Šæœˆ</button>
                        </div>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <button onclick="searchProject()" id="searchButton">æ™ºèƒ½è¯†åˆ«</button>
                    <button onclick="clearSearch()" style="background: #6c757d;">æ¸…ç©º</button>
                    <button onclick="testSearch()" style="background: #28a745;">æµ‹è¯•æœç´¢</button>
                    <button onclick="openSmartFilterConfig()" style="background: #ff9800;">ğŸ”§ æ™ºèƒ½ç­›é€‰é…ç½®</button>
                    <button onclick="openDedupConfig()" style="background: #9c27b0;">ğŸ”„ å»é‡é…ç½®</button>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: #666;">
                        <input type="checkbox" id="removeDuplicates" checked>
                        è‡ªåŠ¨å»é‡ï¼ˆç§»é™¤å®Œå…¨ç›¸åŒçš„è®°å½•ï¼‰
                    </label>
                </div>
                
                <div class="algorithm-info">
                    <h4>ğŸ¤– æ™ºèƒ½è¯†åˆ«ç®—æ³•</h4>
                    <p>ç³»ç»Ÿèƒ½è¯†åˆ«ä»¥ä¸‹å¤æ‚æ¨¡å¼ï¼š</p>
                    <div class="pattern-examples">
                        <span class="pattern-tag">AAA/BBB/CCC</span>
                        <span class="pattern-tag">AAA+BBB+CCC</span>
                        <span class="pattern-tag">AAA,BBB,CCC</span>
                        <span class="pattern-tag">AAA BBB CCC</span>
                        <span class="pattern-tag">AAA&BBB&CCC</span>
                        <span class="pattern-tag">AAAã€BBBã€CCC</span>
                        <span class="pattern-tag">AAA(BBB)</span>
                        <span class="pattern-tag">ç»„åˆæ¨¡å¼</span>
                    </div>
                </div>
                
                <div class="algorithm-info" style="background: #f0f8ff; border-left-color: #4CAF50;">
                    <h4>ğŸ”„ çº§è”ç­›é€‰ç³»ç»Ÿ</h4>
                    <p>é€‰æ‹©ä»»æ„å­—æ®µåï¼Œå…¶ä»–å­—æ®µçš„é€‰é¡¹ä¼šè‡ªåŠ¨è¿‡æ»¤ï¼Œå®ç°å¤šçº§è”åŠ¨ç­›é€‰ï¼š</p>
                    <div id="filterStatus" style="font-size: 0.9em; color: #666; margin-top: 8px;">
                        <span id="activeFilters">å½“å‰æ— ç­›é€‰æ¡ä»¶</span>
                        <span id="availableOptions" style="margin-left: 20px;"></span>
                    </div>
                </div>
                
                <div class="algorithm-info" style="background: #fff3e0; border-left-color: #ff9800;">
                    <h4>ğŸ“Š ç»Ÿè®¡æŒ‡æ ‡è¯´æ˜</h4>
                    <div style="font-size: 0.9em; line-height: 1.6;">
                        <div><strong>åŒ¹é…è®°å½•æ•°ï¼š</strong>ç¬¦åˆç­›é€‰æ¡ä»¶çš„è®°å½•æ€»æ•°ï¼ˆåŒ…å«é‡å¤è®°å½•ï¼‰</div>
                        <div><strong>é€æ ·æ¬¡æ•°ï¼š</strong>å»é‡åçš„å®é™…é€æ ·æ‰¹æ¬¡æ•°é‡ï¼ˆæ’é™¤é‡å¤è®°å½•ï¼‰</div>
                        <div><strong>å¹³å‡å‘¨æœŸï¼š</strong>åŒä¸€é¡¹ç›®ç›¸é‚»é€æ ·çš„å¹³å‡æ—¶é—´é—´éš”ï¼ˆå¤©ï¼‰</div>
                        <div><strong>é€æ ·è¶‹åŠ¿ï¼š</strong>åŸºäºæœ€è¿‘3ä¸ªæœˆæ•°æ®çš„å˜åŒ–è¶‹åŠ¿ï¼ˆä¸Šå‡/ç¨³å®š/ä¸‹é™ï¼‰</div>
                    </div>
                </div>
            </div>
            
            <!-- æ·±åº¦ç»Ÿè®¡åˆ†ææ ‡ç­¾é¡µ -->
            <div class="section">
                <h2 class="section-title">æ·±åº¦ç»Ÿè®¡åˆ†æ</h2>
                <div class="tabs" style="margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button class="tab active" onclick="switchAnalysisTab('overview')">ğŸ“Š æ¦‚è§ˆ</button>
                    <button class="tab" onclick="switchAnalysisTab('resource')">ğŸ“ˆ èµ„æºæŠ•å…¥åˆ†æ</button>
                    <button class="tab" onclick="switchAnalysisTab('cycle')">â±ï¸ å‘¨æœŸåˆ†æ</button>
                    <button class="tab" onclick="switchAnalysisTab('sample')">ğŸ§ª æ ·å“åˆ†æ</button>
                    <button class="tab" onclick="switchAnalysisTab('personnel')">ğŸ‘¥ äººå‘˜æŠ€èƒ½åˆ†æ</button>
                    <button class="tab" onclick="switchAnalysisTab('waterlevel')">ğŸ“Š æ°´ä½çº¿åˆ†æ</button>
                    <button class="tab" onclick="switchAnalysisTab('inventory')">ğŸ“¦ åº“å­˜ç®¡ç†</button>
                    <button class="tab" onclick="switchAnalysisTab('advanced')">ğŸ”¬ é«˜çº§ç»Ÿè®¡</button>
                </div>
                
                <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
                <div id="overview" class="tab-content active">
                    <div class="analysis-grid">
                        <div class="stat-card">
                            <h3>ğŸ“Š åŒ¹é…è®°å½•æ•°</h3>
                            <div class="stat-value" id="matchCount">0</div>
                            <small>åŒ…å«é‡å¤çš„åŸå§‹è®°å½•</small>
                        </div>
                        <div class="stat-card">
                            <h3>ğŸ“… é€æ ·æ¬¡æ•°</h3>
                            <div class="stat-value" id="sampleCount">0</div>
                            <small>å»é‡åçš„å®é™…æ‰¹æ¬¡</small>
                        </div>
                        <div class="stat-card">
                            <h3>â±ï¸ å¹³å‡å‘¨æœŸ</h3>
                            <div class="stat-value" id="avgCycle">0å¤©</div>
                            <small>å¹³å‡é€æ ·é—´éš”</small>
                        </div>
                        <div class="stat-card">
                            <h3>ğŸ“ˆ é€æ ·è¶‹åŠ¿</h3>
                            <div class="stat-value" id="trend">--</div>
                            <small>è¿‘æœŸé€æ ·é¢‘ç‡</small>
                        </div>
                    </div>
                </div>
                
                <!-- èµ„æºæŠ•å…¥åˆ†ææ ‡ç­¾é¡µ -->
                <div id="resource" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">ğŸ“ˆ èµ„æºæŠ•å…¥åˆ†æ</h3>
                        <div class="metric-grid" id="resourceMetrics">
                            <!-- èµ„æºæŠ•å…¥æŒ‡æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="chart-container">
                            <canvas id="resourceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- å‘¨æœŸåˆ†ææ ‡ç­¾é¡µ -->
                <div id="cycle" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">â±ï¸ å‘¨æœŸåˆ†æ</h3>
                        <div class="metric-grid" id="cycleMetrics">
                            <!-- å‘¨æœŸåˆ†ææŒ‡æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="chart-container">
                            <canvas id="cycleChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- æ ·å“åˆ†ææ ‡ç­¾é¡µ -->
                <div id="sample" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">ğŸ§ª æ ·å“åˆ†æ</h3>
                        <div class="metric-grid" id="sampleMetrics">
                            <!-- æ ·å“åˆ†ææŒ‡æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="chart-container">
                            <canvas id="sampleChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- äººå‘˜æŠ€èƒ½åˆ†ææ ‡ç­¾é¡µ -->
                <div id="personnel" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">ğŸ‘¥ äººå‘˜æŠ€èƒ½åˆ†æ</h3>
                        <div class="metric-grid" id="personnelMetrics">
                            <!-- äººå‘˜æŠ€èƒ½æŒ‡æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="chart-container">
                            <canvas id="personnelChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- æ°´ä½çº¿åˆ†ææ ‡ç­¾é¡µ -->
                <div id="waterlevel" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">ğŸ“Š æ°´ä½çº¿åˆ†æ</h3>
                        <div class="metric-grid" id="waterlevelMetrics">
                            <!-- æ°´ä½çº¿æŒ‡æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="chart-container">
                            <canvas id="waterlevelChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- åº“å­˜ç®¡ç†æ ‡ç­¾é¡µ -->
                <div id="inventory" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">ğŸ“¦ åº“å­˜ç®¡ç†åˆ†æ</h3>
                        <div class="metric-grid" id="inventoryMetrics">
                            <!-- åº“å­˜ç®¡ç†æŒ‡æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="chart-container">
                            <canvas id="inventoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- é«˜çº§ç»Ÿè®¡æ ‡ç­¾é¡µ -->
                <div id="advanced" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">ğŸ”¬ é«˜çº§ç»Ÿè®¡æ–¹æ³•</h3>
                        <div class="metric-grid" id="advancedMetrics">
                            <!-- é«˜çº§ç»Ÿè®¡æŒ‡æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="chart-container">
                            <canvas id="advancedChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¯¦ç»†è®°å½•è¡¨ -->
            <div class="section">
                <h2 class="section-title">åŒ¹é…è®°å½•è¯¦æƒ…</h2>
                
                <!-- åˆ†é¡µæ§åˆ¶åŒº -->
                <div class="pagination-controls">
                    <div class="pagination-info">
                        <span>æ¯é¡µæ˜¾ç¤ºï¼š</span>
                        <select id="pageSizeSelect" class="page-size-select">
                            <option value="10" selected>10æ¡</option>
                            <option value="20">20æ¡</option>
                            <option value="50">50æ¡</option>
                            <option value="100">100æ¡</option>
                        </select>
                    </div>
                    <div class="pagination-buttons">
                        <button type="button" id="firstPageBtn" class="page-btn icon-btn" disabled title="ç¬¬ä¸€é¡µ">
                            <span class="icon">â®</span>
                        </button>
                        <button type="button" id="prevPageBtn" class="page-btn icon-btn" disabled title="ä¸Šä¸€é¡µ">
                            <span class="icon">â—€</span>
                        </button>
                        <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                        <button type="button" id="nextPageBtn" class="page-btn icon-btn" disabled title="ä¸‹ä¸€é¡µ">
                            <span class="icon">â–¶</span>
                        </button>
                        <button type="button" id="lastPageBtn" class="page-btn icon-btn" disabled title="æœ€åä¸€é¡µ">
                            <span class="icon">â­</span>
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                <table class="result-table" id="resultTable">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>æ”¶æ ·æ—¶é—´</th>
                            <th>æ ·å“å‹å·</th>
                            <th>å°ç¼–ç </th>
                            <th>ä¾›åº”å•†</th>
                            <th>æ ·å“åˆ†ç±»</th>
                            <th>æ ·å“æ€§è´¨</th>
                            <th>é€æ ·æ¬¡æ•°</th>
                            <th>ç‰ˆæœ¬å·</th>
                            <th>åŒ¹é…åº¦</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #999;">
                                è¯·è¾“å…¥æœç´¢æ¡ä»¶
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div>
            </div>
            
            <!-- æ—¶é—´åˆ†å¸ƒå›¾è¡¨ -->
            <div class="section">
                <h2 class="section-title">é€æ ·æ—¶é—´åˆ†å¸ƒ</h2>
                
                <!-- æ—¶é—´ç»´åº¦é€‰æ‹©å™¨ -->
                <div class="time-dimension-selector">
                    <label style="margin-right: 15px; color: #666; font-weight: 500;">æ—¶é—´ç»´åº¦ï¼š</label>
                    <div class="dimension-buttons">
                        <button type="button" class="dimension-btn active" data-dimension="month">æœˆ</button>
                        <button type="button" class="dimension-btn" data-dimension="week">å‘¨</button>
                        <button type="button" class="dimension-btn" data-dimension="day">æ—¥</button>
                        <button type="button" class="dimension-btn" data-dimension="year">å¹´</button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="timeline"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // =====================================================
        // æ ¸å¿ƒç®—æ³•ï¼šæ™ºèƒ½åŒ¹é…å¼•æ“
        // =====================================================
        class SmartMatcher {
            constructor() {
                // å®šä¹‰æ‰€æœ‰å¯èƒ½çš„åˆ†éš”ç¬¦
                this.separators = ['+', '/', '&', ',', 'ã€', ' ', '-', '|', ';', '_'];
                // åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼ç”¨äºåˆ†å‰² - ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•
                this.separatorRegex = new RegExp(`[${this.separators.map(s => '\\' + s).join('')}]+`);
                
                // åˆå§‹åŒ–é¡¹ç›®å…³è”æ˜ å°„ï¼ˆç”¨äºå­¦ä¹ å‹å·å’Œç¼–ç çš„å…³è”å…³ç³»ï¼‰
                this.projectMapping = new Map();
            }
            
            // è§£æå¤æ‚å­—ç¬¦ä¸²ï¼Œæå–æ‰€æœ‰å¯èƒ½çš„é¡¹ç›®æ ‡è¯†
            parseComplexString(str) {
                if (!str || str === 'æœªçŸ¥' || str === 'undefined' || str === 'null') {
                    return [];
                }
                
                // ç§»é™¤æ‹¬å·åŠå…¶å†…å®¹ï¼ˆå¦‚ï¼šAAA(å‡çº§ç‰ˆ) â†’ AAAï¼‰
                str = str.replace(/[ï¼ˆ(][^ï¼‰)]*[ï¼‰)]/g, '').trim();
                
                // å¦‚æœæ²¡æœ‰åˆ†éš”ç¬¦ï¼Œç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
                if (!this.separatorRegex.test(str)) {
                    return [str.toUpperCase()];
                }
                
                // æŒ‰åˆ†éš”ç¬¦åˆ†å‰²
                const parts = str.split(this.separatorRegex)
                    .filter(part => part && part.trim())
                    .map(part => part.trim().toUpperCase());
                
                // å»é‡
                return [...new Set(parts)];
            }
            
            // æ™ºèƒ½åŒ¹é…ç®—æ³• - ç®€åŒ–ç‰ˆæœ¬
            match(searchModel, searchCode, recordModel, recordCode) {
                let confidence = 0;
                let matched = false;
                
                const modelParts = this.parseComplexString(recordModel);
                const codeParts = this.parseComplexString(recordCode);
                
                if (searchModel) {
                    const searchModelClean = searchModel.trim().toUpperCase();
                    if (modelParts.some(part => 
                        part.includes(searchModelClean) || searchModelClean.includes(part))) {
                        matched = true;
                        confidence += 50;
                    }
                }
                
                if (searchCode) {
                    const searchCodeClean = searchCode.trim().toUpperCase();
                    if (codeParts.some(part => 
                        part.includes(searchCodeClean) || searchCodeClean.includes(part))) {
                        matched = matched || true;
                        confidence += 50;
                    }
                }
                
                if (searchModel && searchCode && matched) {
                    this.learnAssociation(searchModel, searchCode);
                }
                
                return { matched, confidence };
            }
            
            // æ‰¹é‡åŒ¹é…æ–¹æ³•
            batchMatch(records, searchModel, searchCode) {
                return records.filter(record => {
                    const result = this.match(
                        searchModel, 
                        searchCode,
                        record.æ ·å“å‹å· || record.model,
                        record.å°ç¼–ç  || record.code
                    );
                    if (result.matched) {
                        record.confidence = result.confidence;
                        return true;
                    }
                    return false;
                }).sort((a, b) => b.confidence - a.confidence);
            }
            
            // å­¦ä¹ å‹å·å’Œç¼–ç çš„å…³è”å…³ç³»
            learnAssociation(model, code) {
                const modelKey = model.toUpperCase();
                const codeKey = code.toUpperCase();
                
                // å­˜å‚¨å‹å·åˆ°ç¼–ç çš„æ˜ å°„
                if (!this.projectMapping.has(modelKey)) {
                    this.projectMapping.set(modelKey, new Set());
                }
                this.projectMapping.get(modelKey).add(codeKey);
                
                // å­˜å‚¨ç¼–ç åˆ°å‹å·çš„åå‘æ˜ å°„
                const reverseKey = `CODE_${codeKey}`;
                if (!this.projectMapping.has(reverseKey)) {
                    this.projectMapping.set(reverseKey, new Set());
                }
                this.projectMapping.get(reverseKey).add(modelKey);
            }
            
            // è·å–ä¸å‹å·å…³è”çš„ç¼–ç 
            getAssociatedCodes(model) {
                const modelKey = model.toUpperCase();
                return this.projectMapping.has(modelKey) 
                    ? Array.from(this.projectMapping.get(modelKey))
                    : [];
            }
            
            // è·å–ä¸ç¼–ç å…³è”çš„å‹å·
            getAssociatedModels(code) {
                const reverseKey = `CODE_${code.toUpperCase()}`;
                return this.projectMapping.has(reverseKey) 
                    ? Array.from(this.projectMapping.get(reverseKey))
                    : [];
            }
        }
        
        // =====================================================
        // æ•°æ®ç”Ÿæˆå’Œå¤„ç†
        // =====================================================
        
        
        // =====================================================
        // ç»Ÿè®¡åˆ†æåŠŸèƒ½
        // =====================================================
        
        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        function calculateStatistics(records) {
            const stats = {
                totalRecords: records.length,  // åŒ¹é…è®°å½•æ•° = åŸå§‹åŒ¹é…çš„è®°å½•æ€»æ•°ï¼ˆä¸å»é‡ï¼‰
                sampleCount: 0,                // é€æ ·æ¬¡æ•° = å»é‡åçš„å®é™…é€æ ·æ‰¹æ¬¡æ•°é‡
                avgCycle: 0,
                trend: '',
                suppliers: {},
                versions: {},
                sampleTypes: {}
            };
            
            if (records.length === 0) {
                return stats;
            }
            
            // 1. è®¡ç®—é€æ ·æ¬¡æ•°ï¼ˆå»é‡åçš„æ‰¹æ¬¡æ•°é‡ï¼‰
            stats.sampleCount = calculateSampleCount(records);
            
            // 2. è®¡ç®—å¹³å‡é€æ ·å‘¨æœŸ
            stats.avgCycle = calculateAverageCycle(records);
            
            // 3. åˆ†æé€æ ·è¶‹åŠ¿
            stats.trend = analyzeSampleTrend(records);
            
            // 4. ç»Ÿè®¡ä¾›åº”å•†åˆ†å¸ƒ
            records.forEach(r => {
                stats.suppliers[r.ä¾›åº”å•†] = (stats.suppliers[r.ä¾›åº”å•†] || 0) + 1;
                stats.versions[r.ç‰ˆæœ¬å·] = (stats.versions[r.ç‰ˆæœ¬å·] || 0) + 1;
                stats.sampleTypes[r.æ ·å“æ€§è´¨] = (stats.sampleTypes[r.æ ·å“æ€§è´¨] || 0) + 1;
            });
            
            return stats;
        }
        
        // è®¡ç®—é€æ ·æ¬¡æ•°
        function calculateSampleCount(records) {
            // é€æ ·æ¬¡æ•° = å»é‡åçš„å®é™…é€æ ·æ‰¹æ¬¡æ•°é‡
            console.log('calculateSampleCount è¾“å…¥è®°å½•æ•°:', records.length);
            const uniqueRecords = removeDuplicateRecords(records);
            console.log('calculateSampleCount å»é‡åè®°å½•æ•°:', uniqueRecords.length);
            return uniqueRecords.length;
        }
        
        // æŒ‰é¡¹ç›®åˆ†ç»„è®°å½•
        function groupRecordsByProject(records) {
            const groups = {};
            records.forEach(record => {
                const projectKey = `${record.æ ·å“å‹å· || 'æœªçŸ¥'}_${record.å°ç¼–ç  || 'æœªçŸ¥'}`;
                if (!groups[projectKey]) {
                    groups[projectKey] = [];
                }
                groups[projectKey].push(record);
            });
            return groups;
        }
        
        // è®¡ç®—å¹³å‡é€æ ·å‘¨æœŸ
        function calculateAverageCycle(records) {
            // ç›´æ¥åŸºäºç­›é€‰å‡ºæ¥çš„è®°å½•è®¡ç®—å¹³å‡å‘¨æœŸ
            if (records.length < 2) return 0;
            
            // æŒ‰æ”¶æ ·æ—¶é—´æ’åº
            const sortedRecords = records.sort((a, b) => new Date(a.æ”¶æ ·æ—¶é—´) - new Date(b.æ”¶æ ·æ—¶é—´));
            
            const cycles = [];
            
            // è®¡ç®—ç›¸é‚»é€æ ·çš„é—´éš”æ—¶é—´
            for (let i = 1; i < sortedRecords.length; i++) {
                const date1 = new Date(sortedRecords[i-1].æ”¶æ ·æ—¶é—´);
                const date2 = new Date(sortedRecords[i].æ”¶æ ·æ—¶é—´);
                const daysDiff = (date2 - date1) / (1000 * 60 * 60 * 24);
                if (daysDiff > 0) {
                    cycles.push(daysDiff);
                }
            }
            
            if (cycles.length === 0) return 0;
            return Math.round(cycles.reduce((sum, cycle) => sum + cycle, 0) / cycles.length);
        }
        
        // åˆ†æé€æ ·è¶‹åŠ¿
        function analyzeSampleTrend(records) {
            if (records.length < 3) return 'æ•°æ®ä¸è¶³';
            
            // æŒ‰æœˆä»½ç»Ÿè®¡é€æ ·æ•°é‡
            const monthlyData = {};
            records.forEach(record => {
                const date = new Date(record.æ”¶æ ·æ—¶é—´);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
            });
            
            const months = Object.keys(monthlyData).sort();
            if (months.length < 2) return 'æ•°æ®ä¸è¶³';
            
            // è®¡ç®—æœ€è¿‘3ä¸ªæœˆçš„è¶‹åŠ¿
            const recentMonths = months.slice(-3);
            const recentCounts = recentMonths.map(month => monthlyData[month]);
            
            if (recentCounts.length < 2) return 'æ•°æ®ä¸è¶³';
            
            // ç®€å•è¶‹åŠ¿åˆ†æ
            const firstHalf = recentCounts.slice(0, Math.ceil(recentCounts.length / 2));
            const secondHalf = recentCounts.slice(Math.floor(recentCounts.length / 2));
            
            const firstAvg = firstHalf.reduce((sum, count) => sum + count, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((sum, count) => sum + count, 0) / secondHalf.length;
            
            const changeRate = (secondAvg - firstAvg) / firstAvg;
            
            if (changeRate > 0.2) {
                return 'â†‘ ä¸Šå‡';
            } else if (changeRate < -0.2) {
                return 'â†“ ä¸‹é™';
            } else {
                return 'â†’ ç¨³å®š';
            }
        }
        
        // =====================================================
        // UI æ›´æ–°åŠŸèƒ½
        // =====================================================
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStatistics(records) {
            console.log('updateStatistics æ¥æ”¶åˆ°çš„è®°å½•æ•°:', records.length);
            const stats = calculateStatistics(records);
            console.log('è®¡ç®—å‡ºçš„ç»Ÿè®¡ç»“æœ:', stats);
            
            document.getElementById('matchCount').textContent = stats.totalRecords;
            document.getElementById('sampleCount').textContent = stats.sampleCount;
            document.getElementById('avgCycle').textContent = stats.avgCycle ? `${stats.avgCycle}å¤©` : '--';
            
            const trendElement = document.getElementById('trend');
            trendElement.textContent = stats.trend || '--';
            
            // æ ¹æ®è¶‹åŠ¿è®¾ç½®é¢œè‰²
            if (stats.trend.includes('ä¸Šå‡')) {
                trendElement.style.color = '#4CAF50';
            } else if (stats.trend.includes('ç¨³å®š')) {
                trendElement.style.color = '#2196F3';
            } else if (stats.trend.includes('ä¸‹é™')) {
                trendElement.style.color = '#FF9800';
            } else {
                trendElement.style.color = '#666';
            }
        }
        
        // æ›´æ–°è¡¨æ ¼
        function updateTable(records) {
            const tbody = document.getElementById('tableBody');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">æœªæ‰¾åˆ°åŒ¹é…è®°å½•</td></tr>';
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åº
            records.sort((a, b) => new Date(b.æ”¶æ ·æ—¶é—´) - new Date(a.æ”¶æ ·æ—¶é—´));
            
            // åªæ˜¾ç¤ºå½“å‰é¡µçš„æ•°æ®ï¼Œä¸æ˜¾ç¤ºæ‰€æœ‰è®°å½•
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${record.åºå· || ''}</td>
                    <td>${record.æ”¶æ ·æ—¶é—´ || ''}</td>
                    <td>${record.æ ·å“å‹å· || ''}</td>
                    <td>${record.å°ç¼–ç  || ''}</td>
                    <td>${record.ä¾›åº”å•† || ''}</td>
                    <td>${record.æ ·å“åˆ†ç±» || ''}</td>
                    <td>${record.æ ·å“æ€§è´¨ || ''}</td>
                    <td>${record.é€æ ·æ¬¡æ•° || ''}</td>
                    <td>${record.ç‰ˆæœ¬å· || ''}</td>
                    <td><span class="pattern-tag">${record.confidence ? record.confidence + '%' : 'åŒ¹é…'}</span></td>
                </tr>
            `).join('');
        }
        
        // æ›´æ–°è¡¨æ ¼ï¼ˆå¸¦åˆ†é¡µï¼‰
        function updateTableWithPagination(records) {
            // è®¾ç½®åˆ†é¡µæ•°æ®
            setPaginationData(records);
            
            // æ¸²æŸ“å½“å‰é¡µ
            renderCurrentPage();
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(records) {
            // ä¿å­˜å½“å‰è®°å½•ï¼Œç”¨äºæ—¶é—´ç»´åº¦åˆ‡æ¢æ—¶é‡æ–°ç»˜åˆ¶
            window.currentRecords = records;
            
            // è·å–å½“å‰é€‰æ‹©çš„æ—¶é—´ç»´åº¦
            const activeDimension = document.querySelector('.dimension-btn.active');
            const dimension = activeDimension ? activeDimension.dataset.dimension : 'month';
            
            // æ ¹æ®æ—¶é—´ç»´åº¦ç»Ÿè®¡æ•°æ®
            const timeData = {};
            const dimensionConfig = getDimensionConfig(dimension);
            
            records.forEach(record => {
                const date = new Date(record.æ”¶æ ·æ—¶é—´);
                const timeKey = formatTimeKey(date, dimension);
                timeData[timeKey] = (timeData[timeKey] || 0) + 1;
            });
            
            // æ’åºæ—¶é—´é”®
            const sortedTimeKeys = Object.keys(timeData).sort();
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const chartData = {
                labels: sortedTimeKeys.map(key => formatTimeLabel(key, dimension)),
                datasets: [{
                    label: 'é€æ ·æ•°é‡',
                    data: sortedTimeKeys.map(key => timeData[key]),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };
            
            // é”€æ¯æ—§å›¾è¡¨
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            const ctx = document.getElementById('timeline').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœˆåº¦é€æ ·è¶‹åŠ¿'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // =====================================================
        // ä¸»è¦åŠŸèƒ½å‡½æ•°
        // =====================================================
        
        // å…¨å±€å˜é‡
        let mockData = generateMockData();
        let matcher = new SmartMatcher();
        let chartInstance = null;
        let currentData = mockData; // å½“å‰ä½¿ç”¨çš„æ•°æ®ï¼Œåˆå§‹ä¸ºæ¨¡æ‹Ÿæ•°æ®ï¼Œç­‰å¾…Excelä¸Šä¼ 
        
        // æœç´¢é¡¹ç›®
        function searchProject() {
            console.log('ğŸ” å¼€å§‹æœç´¢é¡¹ç›®...');
            const modelSearch = document.getElementById('modelSearch').value;
            const codeSearch = document.getElementById('codeSearch').value;
            const categorySearch = document.getElementById('categorySearch').value;
            const propertySearch = document.getElementById('propertySearch').value;
            const subCategorySearch = document.getElementById('subCategorySearch').value;
            const testerSearch = document.getElementById('testerSearch').value;
            const electronicEngineerSearch = document.getElementById('electronicEngineerSearch').value;
            const projectEngineerSearch = document.getElementById('projectEngineerSearch').value;
            const dqeSearch = document.getElementById('dqeSearch').value;
            const dqeCategorySearch = document.getElementById('dqeCategorySearch').value;
            const newCategorySearch = document.getElementById('newCategorySearch').value;
            
            const searchConditions = {
                modelSearch, codeSearch, categorySearch, propertySearch,
                subCategorySearch, testerSearch, electronicEngineerSearch,
                projectEngineerSearch, dqeSearch, dqeCategorySearch, newCategorySearch
            };
            
            console.log('æœç´¢æ¡ä»¶:', searchConditions);
            console.log('å½“å‰æ•°æ®é‡:', currentData.length);
            console.log('æ•°æ®æ¥æº:', currentData === mockData ? 'æ¨¡æ‹Ÿæ•°æ®' : 'çœŸå®æ•°æ®');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æœç´¢æ¡ä»¶ï¼ˆåŒ…æ‹¬æ—¥æœŸèŒƒå›´ï¼‰
            const hasSearchCondition = Object.values(searchConditions).some(value => value && value.trim() !== '');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const hasDateRange = startDate || endDate;
            
            if (!hasSearchCondition && !hasDateRange) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœç´¢æ¡ä»¶');
                return;
            }
            
            if (currentData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ Excelæ•°æ®æˆ–ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•');
                return;
            }
            
            let matchedRecords = [];
            
            // å¦‚æœæŒ‡å®šäº†å‹å·æˆ–ç¼–ç ï¼Œå…ˆè¿›è¡Œå‹å·å’Œç¼–ç åŒ¹é…
            if (modelSearch || codeSearch) {
                matchedRecords = matcher.batchMatch(currentData, modelSearch, codeSearch);
            } else {
                // å¦‚æœæ²¡æœ‰å‹å·å’Œç¼–ç æœç´¢ï¼Œä»æ‰€æœ‰æ•°æ®å¼€å§‹
                matchedRecords = [...currentData];
            }
            
            // å¦‚æœæŒ‡å®šäº†æ ·å“åˆ†ç±»ï¼Œè¿›è¡Œç­›é€‰
            if (categorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.æ ·å“åˆ†ç±» && record.æ ·å“åˆ†ç±».includes(categorySearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†æ ·å“æ€§è´¨ï¼Œè¿›è¡Œç­›é€‰
            if (propertySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.æ ·å“æ€§è´¨ && record.æ ·å“æ€§è´¨.includes(propertySearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†å“ç±»ç»†åˆ†ï¼Œè¿›è¡Œç­›é€‰
            if (subCategorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.å“ç±»ç»†åˆ† && record.å“ç±»ç»†åˆ†.includes(subCategorySearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†æµ‹è¯•äººï¼Œè¿›è¡Œç­›é€‰
            if (testerSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.æµ‹è¯•äºº && record.æµ‹è¯•äºº.includes(testerSearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†ç”µå­å·¥ç¨‹å¸ˆï¼Œè¿›è¡Œç­›é€‰
            if (electronicEngineerSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.ç”µå­å·¥ç¨‹å¸ˆ && record.ç”µå­å·¥ç¨‹å¸ˆ.includes(electronicEngineerSearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†é¡¹ç›®å·¥ç¨‹å¸ˆï¼Œè¿›è¡Œç­›é€‰
            if (projectEngineerSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.é¡¹ç›®å·¥ç¨‹å¸ˆ && record.é¡¹ç›®å·¥ç¨‹å¸ˆ.includes(projectEngineerSearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†DQEï¼Œè¿›è¡Œç­›é€‰
            if (dqeSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.DQE && record.DQE.includes(dqeSearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†DQEå“ç±»ç»†åˆ†ï¼Œè¿›è¡Œç­›é€‰
            if (dqeCategorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.DQEå“ç±»ç»†åˆ† && record.DQEå“ç±»ç»†åˆ†.includes(dqeCategorySearch)
                );
            }
            
            // å¦‚æœæŒ‡å®šäº†æ–°åˆ†ç±»ï¼Œè¿›è¡Œç­›é€‰
            if (newCategorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.æ–°åˆ†ç±» && record.æ–°åˆ†ç±».includes(newCategorySearch)
                );
            }
            
            // åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰
            console.log('åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰å‰è®°å½•æ•°:', matchedRecords.length);
            matchedRecords = applyDateRangeFilter(matchedRecords);
            console.log('åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰åè®°å½•æ•°:', matchedRecords.length);
            
            // ä¿å­˜åŸå§‹åŒ¹é…ç»“æœï¼ˆç”¨äºç»Ÿè®¡ï¼‰
            const originalMatchedRecords = [...matchedRecords];
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦å»é‡
            const removeDuplicates = document.getElementById('removeDuplicates').checked;
            if (removeDuplicates) {
                matchedRecords = removeDuplicateRecords(matchedRecords);
            }
            
            console.log('åŸå§‹åŒ¹é…ç»“æœæ•°é‡:', originalMatchedRecords.length);
            console.log('å»é‡ååŒ¹é…ç»“æœæ•°é‡:', matchedRecords.length);
            console.log('å»é‡é€‰æ¡†çŠ¶æ€:', document.getElementById('removeDuplicates').checked);
            if (matchedRecords.length > 0) {
                console.log('å‰3ä¸ªåŒ¹é…ç»“æœ:', matchedRecords.slice(0, 3));
            }
            
            // æ›´æ–°UI - ç»Ÿè®¡ä½¿ç”¨åŸå§‹æ•°æ®ï¼Œè¡¨æ ¼å’Œå›¾è¡¨ä½¿ç”¨å»é‡åæ•°æ®
            updateStatistics(originalMatchedRecords);
            updateTableWithPagination(matchedRecords);
            updateChart(matchedRecords);
            
            // ä¿å­˜å½“å‰è®°å½•ä¾›æ·±åº¦åˆ†æä½¿ç”¨
            window.currentRecords = matchedRecords;
            
            // è§¦å‘é»˜è®¤çš„æ·±åº¦åˆ†æï¼ˆæ¦‚è§ˆæ ‡ç­¾é¡µï¼‰
            loadAnalysisData('overview');
        }
        
        // æ¸…ç©ºæœç´¢
        function clearSearch() {
            // æ¸…ç©ºæ‰€æœ‰æœç´¢è¾“å…¥æ¡†
            const searchFields = [
                'modelSearch', 'codeSearch', 'categorySearch', 'propertySearch',
                'subCategorySearch', 'testerSearch', 'electronicEngineerSearch',
                'projectEngineerSearch', 'dqeSearch', 'dqeCategorySearch', 'newCategorySearch'
            ];
            
            searchFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                const clearBtn = document.getElementById('clear' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
                
                if (element) {
                    element.value = '';
                }
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
            });
            
            // æ¸…ç©ºæ—¥æœŸèŒƒå›´
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
            
            // é‡ç½®çº§è”ç­›é€‰ç³»ç»Ÿ
            if (cascadingFilter) {
                cascadingFilter.resetAllOptions();
            }
            
            // æ¸…ç©ºè¡¨æ ¼å’Œç»Ÿè®¡
            document.getElementById('tableBody').innerHTML = 
                '<tr><td colspan="10" style="text-align: center; color: #999;">è¯·è¾“å…¥æœç´¢æ¡ä»¶</td></tr>';
            document.getElementById('matchCount').textContent = '0';
            document.getElementById('sampleCount').textContent = '0';
            
            // é‡ç½®åˆ†é¡µçŠ¶æ€
            paginationState = {
                currentPage: 1,
                pageSize: 10,
                totalRecords: 0,
                totalPages: 0,
                allRecords: []
            };
            updatePagination();
            document.getElementById('avgCycle').textContent = '0å¤©';
            document.getElementById('trend').textContent = '--';
            
            if (chartInstance) {
                chartInstance.destroy();
            }
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥XLSXåº“æ˜¯å¦å·²åŠ è½½
            if (typeof XLSX === 'undefined') {
                alert('âŒ Excelå¤„ç†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                console.error('XLSXåº“æœªåŠ è½½');
                return;
            }
            
            // æ›´æ–°ä¸Šä¼ çŠ¶æ€
            const uploadStatus = document.getElementById('uploadStatus');
            const dataInfo = document.getElementById('dataInfo');
            
            uploadStatus.innerHTML = 'â³ æ­£åœ¨å¤„ç†æ–‡ä»¶...';
            uploadStatus.className = 'upload-status loading';
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                uploadStatus.innerHTML = 'âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹© Excel æˆ– CSV æ–‡ä»¶';
                uploadStatus.className = 'upload-status error';
                return;
            }
            
            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (fileExtension === 'csv') {
                        // å¤„ç†CSVæ–‡ä»¶
                        data = parseCSV(e.target.result);
                    } else {
                        // å¤„ç†Excelæ–‡ä»¶
                        console.log('ğŸ”„ å¼€å§‹è§£æExcelæ–‡ä»¶...');
                        console.log('æ–‡ä»¶å¤§å°:', file.size, 'bytes');
                        
                        const workbook = XLSX.read(e.target.result, { 
                            type: 'binary',
                            cellDates: true,
                            cellNF: false,
                            cellText: false
                        });
                        
                        console.log('å·¥ä½œç°¿ä¿¡æ¯:', {
                            SheetNames: workbook.SheetNames,
                            Props: workbook.Props
                        });
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å·¥ä½œè¡¨');
                        }
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        if (!worksheet) {
                            throw new Error(`æ— æ³•è®¿é—®å·¥ä½œè¡¨: ${firstSheetName}`);
                        }
                        
                        data = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: '',
                            blankrows: false
                        });
                        
                        // è½¬æ¢headerä¸ºå¯¹è±¡æ ¼å¼
                        if (data.length > 0) {
                            const headers = data[0];
                            data = data.slice(1).map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index] || '';
                                });
                                return obj;
                            });
                        }
                        
                        console.log('âœ… Excelè§£æå®Œæˆï¼Œå…±', data.length, 'è¡Œæ•°æ®');
                        if (data.length > 0) {
                            console.log('è¡¨å¤´å­—æ®µ:', Object.keys(data[0]));
                            console.log('é¦–è¡Œæ•°æ®ç¤ºä¾‹:', data[0]);
                        }
                    }
                    
                    // æ ‡å‡†åŒ–æ•°æ®
                    const normalizedData = normalizeExcelData(data);
                    
                    if (normalizedData.length === 0) {
                        uploadStatus.innerHTML = 'âŒ æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®';
                        uploadStatus.className = 'upload-status error';
                        return;
                    }
                    
                    // æ›´æ–°å…¨å±€æ•°æ®
                    currentData = normalizedData;
                    mockData = normalizedData;
                    window.currentData = normalizedData; // ç¡®ä¿windowå¯¹è±¡ä¸Šä¹Ÿæœ‰æ•°æ®
                    
                    console.log('âœ… æ•°æ®å·²æ›´æ–°åˆ°currentData:', currentData.length, 'æ¡è®°å½•');
                    console.log('å‰3æ¡æ›´æ–°åçš„æ•°æ®:', currentData.slice(0, 3));
                    
                    // æ•°æ®åŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–æ·±åº¦åˆ†æ
                    loadAnalysisData('overview');
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    uploadStatus.innerHTML = `âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å·²åŠ è½½ ${normalizedData.length} æ¡è®°å½•`;
                    uploadStatus.className = 'upload-status success';
                    
                    // æ˜¾ç¤ºæ•°æ®ä¿¡æ¯
                    dataInfo.innerHTML = `
                        <div>ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š</div>
                        <div>â€¢ åŸå§‹è®°å½•æ•°ï¼š${data.length}</div>
                        <div>â€¢ æœ‰æ•ˆè®°å½•æ•°ï¼š${normalizedData.length}</div>
                        <div>â€¢ æ—¥æœŸèŒƒå›´ï¼š${getDateRange(normalizedData)}</div>
                        <div>â€¢ ä¾›åº”å•†æ•°ï¼š${getUniqueSuppliers(normalizedData)}</div>
                        <div>â€¢ å‹å·æ•°ï¼š${getUniqueModels(normalizedData)}</div>
                        <div>â€¢ æ–‡ä»¶ç±»å‹ï¼š${fileExtension.toUpperCase()}</div>
                        <div>â€¢ æ–‡ä»¶å¤§å°ï¼š${(file.size / 1024).toFixed(1)} KB</div>
                    `;
                    
                    // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹
                    updateDropdownOptions(normalizedData);
                    
                    // æ¸…ç©ºæœç´¢å¹¶æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                    clearSearch();
                    updateStatistics(normalizedData);
                    updateTableWithPagination(normalizedData);
                    updateChart(normalizedData);
                    
                    console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ•°æ®å·²åŠ è½½:', normalizedData.length, 'æ¡è®°å½•');
                    
                } catch (error) {
                    console.error('æ–‡ä»¶å¤„ç†é”™è¯¯:', error);
                    
                    let errorMessage = 'æ–‡ä»¶å¤„ç†å¤±è´¥';
                    if (error.message.includes('XLSX')) {
                        errorMessage = 'Excelæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿æ–‡ä»¶å®Œæ•´ä¸”æœªæŸå';
                    } else if (error.message.includes('parse')) {
                        errorMessage = 'æ•°æ®è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼';
                    } else {
                        errorMessage = `æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š${error.message}`;
                    }
                    
                    uploadStatus.innerHTML = `âŒ ${errorMessage}`;
                    uploadStatus.className = 'upload-status error';
                    
                    // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    dataInfo.innerHTML = `
                        <div style="color: #dc3545;">
                            <div><strong>é”™è¯¯è¯¦æƒ…ï¼š</strong></div>
                            <div>â€¢ ${error.message}</div>
                            <div>â€¢ è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼ˆExcel .xlsx/.xls æˆ– CSV .csvï¼‰</div>
                            <div>â€¢ æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„è¡¨å¤´å’Œæ•°æ®è¡Œ</div>
                            <div>â€¢ å¦‚é—®é¢˜æŒç»­ï¼Œè¯·å°è¯•å°†Excelæ–‡ä»¶å¦å­˜ä¸ºCSVæ ¼å¼</div>
                        </div>
                    `;
                }
            };
            
            if (fileExtension === 'csv') {
                // æ£€æµ‹CSVç¼–ç å¹¶è¯»å–
                const encodingReader = new FileReader();
                encodingReader.onload = function(e) {
                    const text = e.target.result;
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦æ¥åˆ¤æ–­ç¼–ç 
                    if (text.includes('ï¿½ï¿½') || text.includes('?')) {
                        // å¯èƒ½æ˜¯ç¼–ç é—®é¢˜ï¼Œå°è¯•GBK
                        reader.readAsText(file, 'GBK');
                    } else {
                        // UTF-8æ­£å¸¸
                        reader.onload(e);
                    }
                };
                encodingReader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }
        
        // è§£æCSVæ–‡ä»¶ - æ”¹è¿›ç‰ˆæœ¬ï¼Œå¤„ç†å¤æ‚CSVæ ¼å¼
        function parseCSV(csvText) {
            console.log('ğŸ”„ å¼€å§‹è§£æCSVæ–‡ä»¶...');
            const lines = csvText.split('\n').filter(line => line.trim());
            
            if (lines.length === 0) {
                console.warn('CSVæ–‡ä»¶ä¸ºç©º');
                return [];
            }
            
            // ç®€å•CSVè§£æï¼Œæ”¯æŒå¼•å·åŒ…å›´çš„å­—æ®µ
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }
            
            const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, ''));
            const data = [];
            
            console.log('CSVè¡¨å¤´:', headers);
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]).map(v => v.replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            console.log('âœ… CSVè§£æå®Œæˆï¼Œå…±', data.length, 'è¡Œæ•°æ®');
            return data;
        }
        
        // æ ‡å‡†åŒ–Excelæ•°æ®
        function normalizeExcelData(data) {
            console.log('ğŸ”„ å¼€å§‹æ ‡å‡†åŒ–Excelæ•°æ®ï¼ŒåŸå§‹æ•°æ®é‡:', data.length);
            if (data.length > 0) {
                console.log('åŸå§‹æ•°æ®é¦–è¡Œå­—æ®µ:', Object.keys(data[0]));
            }
            
            const fieldMapping = {
                'æ ·å“å‹å·': ['æ ·å“å‹å·', 'å‹å·', 'Model', 'Product Model', 'äº§å“å‹å·'],
                'å°ç¼–ç ': ['å°ç¼–ç ', 'ç¼–ç ', 'ç¼–å·', 'Code', 'Product Code', 'äº§å“ç¼–ç '],
                'æ”¶æ ·æ—¶é—´': ['æ”¶æ ·æ—¶é—´', 'é€æ ·æ—¶é—´', 'æ—¥æœŸ', 'Date', 'Sample Date', 'æ”¶æ ·æ—¥æœŸ'],
                'ä¾›åº”å•†': ['ä¾›åº”å•†', 'å‚å•†', 'Supplier', 'Vendor', 'ä¾›è´§å•†'],
                'é€æ ·æ¬¡æ•°': ['é€æ ·æ¬¡æ•°', 'æ¬¡æ•°', 'Times', 'Sample Times', 'æ‰¹æ¬¡'],
                'ç‰ˆæœ¬å·': ['ç‰ˆæœ¬å·', 'ç‰ˆæœ¬', 'Version', 'Ver'],
                'æ ·å“æ€§è´¨': ['æ ·å“æ€§è´¨', 'æ€§è´¨', 'Type', 'Sample Type', 'æ ·å“ç±»å‹'],
                'æ ·å“åˆ†ç±»': ['æ ·å“åˆ†ç±»', 'åˆ†ç±»', 'Category', 'Class'],
                'å“ç±»ç»†åˆ†': ['å“ç±»ç»†åˆ†', 'SubCategory', 'Sub Category', 'ç»†åˆ†'],
                'æµ‹è¯•äºº': ['æµ‹è¯•äºº', 'Tester', 'Test Person', 'æµ‹è¯•äººå‘˜'],
                'ç”µå­å·¥ç¨‹å¸ˆ': ['ç”µå­å·¥ç¨‹å¸ˆ', 'Electronic Engineer', 'EE'],
                'é¡¹ç›®å·¥ç¨‹å¸ˆ': ['é¡¹ç›®å·¥ç¨‹å¸ˆ', 'Project Engineer', 'PE'],
                'DQE': ['DQE', 'Design Quality Engineer', 'è®¾è®¡è´¨é‡å·¥ç¨‹å¸ˆ'],
                'DQEå“ç±»ç»†åˆ†': ['DQEå“ç±»ç»†åˆ†', 'DQE SubCategory', 'DQE Sub Category'],
                'æ–°åˆ†ç±»': ['æ–°åˆ†ç±»', 'New Category', 'New Class', 'æ–°å“ç±»'],
                'æµ‹è¯•ç¼–å·': ['æµ‹è¯•ç¼–å·', 'Test Number', 'ç¼–å·', 'Number'],
                'åˆ¤å®šç»“æœ': ['åˆ¤å®šç»“æœ', 'ç»“æœ', 'Result', 'Test Result'],
                'æµ‹è¯•æ—¶é•¿': ['æµ‹è¯•æ—¶é•¿', 'æ—¶é•¿', 'Duration', 'Test Duration'],
                'é—®é¢˜æ€»æ•°': ['é—®é¢˜æ€»æ•°', 'é—®é¢˜æ•°', 'Issues', 'Issue Count'],
                'é€æ ·å‘¨æœŸ': ['é€æ ·å‘¨æœŸ', 'å‘¨æœŸ', 'Cycle', 'Sample Cycle'],
                'é€æ ·å‘¨åˆ«': ['é€æ ·å‘¨åˆ«', 'å‘¨åˆ«', 'Week', 'Sample Week'],
                'åŠ æ€¥/åŒæ­¥': ['åŠ æ€¥/åŒæ­¥', 'ä¼˜å…ˆçº§', 'Priority', 'Urgent'],
                'æ€»æ•°': ['æ€»æ•°', 'Total', 'Count', 'Total Count']
            };
            
            
            const normalizedData = data.map((row, index) => {
                const normalized = {
                    åºå·: index + 1
                };
                
                // å­—æ®µæ˜ å°„
                for (const [standardField, possibleFields] of Object.entries(fieldMapping)) {
                    for (const field of possibleFields) {
                        if (row.hasOwnProperty(field) && row[field] !== undefined && row[field] !== null && row[field] !== '') {
                            normalized[standardField] = String(row[field]).trim();
                            break;
                        }
                    }
                }
                
                // å¤„ç†æ—¥æœŸæ ¼å¼ - æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼
                if (normalized.æ”¶æ ·æ—¶é—´) {
                    let dateValue = normalized.æ”¶æ ·æ—¶é—´;
                    let date;
                    
                    // å¤„ç†Excelæ—¥æœŸåºåˆ—å·
                    if (!isNaN(dateValue) && Number(dateValue) > 40000) {
                        // Excelæ—¥æœŸåºåˆ—å·è½¬æ¢
                        date = new Date((Number(dateValue) - 25569) * 86400 * 1000);
                    } else {
                        // æ™®é€šæ—¥æœŸå­—ç¬¦ä¸²
                        date = new Date(dateValue);
                    }
                    
                    if (!isNaN(date.getTime())) {
                        normalized.æ”¶æ ·æ—¶é—´ = date.toLocaleDateString('zh-CN');
                    } else {
                        // å¦‚æœæ—¥æœŸè§£æå¤±è´¥ï¼Œä¿ç•™åŸå€¼
                        console.warn('æ—¥æœŸè§£æå¤±è´¥:', dateValue);
                    }
                }
                
                // å¤„ç†æ•°å€¼å­—æ®µ
                const numericFields = ['é€æ ·æ¬¡æ•°', 'æµ‹è¯•æ—¶é•¿', 'é—®é¢˜æ€»æ•°', 'é€æ ·å‘¨æœŸ', 'æ€»æ•°'];
                numericFields.forEach(field => {
                    if (normalized[field] && !isNaN(normalized[field])) {
                        normalized[field] = parseFloat(normalized[field]);
                    }
                });
                
                // ä¿ç•™å…¶ä»–å­—æ®µ
                Object.keys(row).forEach(key => {
                    if (!Object.values(fieldMapping).some(fields => fields.includes(key))) {
                        normalized[key] = row[key];
                    }
                });
                
                return normalized;
            }).filter(row => {
                // è¿‡æ»¤æ‰ç©ºè¡Œæˆ–å…³é”®å­—æ®µéƒ½ä¸ºç©ºçš„è¡Œ
                const hasKeyField = row.æ ·å“å‹å· || row.å°ç¼–ç  || row.æ”¶æ ·æ—¶é—´;
                if (!hasKeyField) {
                    console.log('è¿‡æ»¤æ‰ç©ºè¡Œ:', row);
                }
                return hasKeyField;
            });
            
            console.log('âœ… æ•°æ®æ ‡å‡†åŒ–å®Œæˆ:', {
                'åŸå§‹è®°å½•æ•°': data.length,
                'æœ‰æ•ˆè®°å½•æ•°': normalizedData.length,
                'å­—æ®µæ˜ å°„': Object.keys(fieldMapping),
                'æ ‡å‡†åŒ–åå­—æ®µ': normalizedData.length > 0 ? Object.keys(normalizedData[0]) : []
            });
            
            if (normalizedData.length > 0) {
                console.log('æ ‡å‡†åŒ–åé¦–è¡Œæ•°æ®ç¤ºä¾‹:', normalizedData[0]);
            }
            
            return normalizedData;
        }
        
        // è·å–æ—¥æœŸèŒƒå›´
        function getDateRange(data) {
            const dates = data
                .map(r => new Date(r.æ”¶æ ·æ—¶é—´))
                .filter(d => !isNaN(d.getTime()))
                .sort((a, b) => a - b);
            
            if (dates.length === 0) return 'æ— æ—¥æœŸæ•°æ®';
            
            const start = dates[0].toLocaleDateString('zh-CN');
            const end = dates[dates.length - 1].toLocaleDateString('zh-CN');
            return `${start} è‡³ ${end}`;
        }
        
        // è·å–å”¯ä¸€ä¾›åº”å•†æ•°
        function getUniqueSuppliers(data) {
            const suppliers = new Set(data.map(r => r.ä¾›åº”å•†).filter(s => s && s !== 'æœªçŸ¥'));
            return suppliers.size;
        }
        
        // è·å–å”¯ä¸€å‹å·æ•°
        function getUniqueModels(data) {
            const models = new Set(data.map(r => r.æ ·å“å‹å·).filter(m => m && m !== 'æœªçŸ¥'));
            return models.size;
        }
        
        // çº§è”ç­›é€‰ç³»ç»Ÿ
        class CascadingFilterSystem {
            constructor(data) {
                this.data = data;
                this.fieldConfigs = [
                    { field: 'æ ·å“åˆ†ç±»', listId: 'categoryList', inputId: 'categorySearch', name: 'æ ·å“åˆ†ç±»' },
                    { field: 'æ ·å“æ€§è´¨', listId: 'propertyList', inputId: 'propertySearch', name: 'æ ·å“æ€§è´¨' },
                    { field: 'å“ç±»ç»†åˆ†', listId: 'subCategoryList', inputId: 'subCategorySearch', name: 'å“ç±»ç»†åˆ†' },
                    { field: 'æµ‹è¯•äºº', listId: 'testerList', inputId: 'testerSearch', name: 'æµ‹è¯•äºº' },
                    { field: 'ç”µå­å·¥ç¨‹å¸ˆ', listId: 'electronicEngineerList', inputId: 'electronicEngineerSearch', name: 'ç”µå­å·¥ç¨‹å¸ˆ' },
                    { field: 'é¡¹ç›®å·¥ç¨‹å¸ˆ', listId: 'projectEngineerList', inputId: 'projectEngineerSearch', name: 'é¡¹ç›®å·¥ç¨‹å¸ˆ' },
                    { field: 'DQE', listId: 'dqeList', inputId: 'dqeSearch', name: 'DQE' },
                    { field: 'DQEå“ç±»ç»†åˆ†', listId: 'dqeCategoryList', inputId: 'dqeCategorySearch', name: 'DQEå“ç±»ç»†åˆ†' },
                    { field: 'æ–°åˆ†ç±»', listId: 'newCategoryList', inputId: 'newCategorySearch', name: 'æ–°åˆ†ç±»' }
                ];
                this.setupEventListeners();
                this.updateAllOptions();
            }
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                this.fieldConfigs.forEach(config => {
                    const input = document.getElementById(config.inputId);
                    if (input) {
                        input.addEventListener('input', () => this.onFieldChange(config.field));
                        input.addEventListener('change', () => this.onFieldChange(config.field));
                    }
                });
                
                // æ·»åŠ æ—¥æœŸèŒƒå›´ç›‘å¬å™¨
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                if (startDateInput) {
                    startDateInput.addEventListener('change', () => this.onFieldChange('dateRange'));
                }
                if (endDateInput) {
                    endDateInput.addEventListener('change', () => this.onFieldChange('dateRange'));
                }
            }
            
            // å­—æ®µå˜åŒ–æ—¶çš„å¤„ç†
            onFieldChange(changedField) {
                console.log(`ğŸ”„ å­—æ®µ ${changedField} å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°çº§è”ç­›é€‰...`);
                this.updateAllOptions();
            }
            
            // è·å–å½“å‰å·²é€‰æ‹©çš„å€¼
            getCurrentSelections() {
                const selections = {};
                this.fieldConfigs.forEach(config => {
                    const input = document.getElementById(config.inputId);
                    if (input && input.value.trim()) {
                        selections[config.field] = input.value.trim();
                    }
                });
                return selections;
            }
            
            // æ ¹æ®å½“å‰é€‰æ‹©è¿‡æ»¤æ•°æ®
            getFilteredData() {
                const selections = this.getCurrentSelections();
                let filteredData = [...this.data];
                
                // åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰
                filteredData = this.applyDateRangeFilter(filteredData);
                
                // åº”ç”¨æ‰€æœ‰å·²é€‰æ‹©çš„ç­›é€‰æ¡ä»¶
                Object.entries(selections).forEach(([field, value]) => {
                    filteredData = filteredData.filter(record => 
                        record[field] && record[field].includes(value)
                    );
                });
                
                return filteredData;
            }
            
            // åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰
            applyDateRangeFilter(data) {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                if (!startDateInput || !endDateInput) return data;
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                // å¦‚æœæ²¡æœ‰è®¾ç½®æ—¥æœŸèŒƒå›´ï¼Œè¿”å›æ‰€æœ‰æ•°æ®
                if (!startDate && !endDate) return data;
                
                return data.filter(record => {
                    if (!record.æ”¶æ ·æ—¶é—´) return false;
                    
                    try {
                        const recordDate = new Date(record.æ”¶æ ·æ—¶é—´);
                        if (isNaN(recordDate.getTime())) return false;
                        
                        // åªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é—´
                        const recordDateOnly = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());
                        
                        if (startDate) {
                            const start = new Date(startDate);
                            if (recordDateOnly < start) return false;
                        }
                        
                        if (endDate) {
                            const end = new Date(endDate);
                            if (recordDateOnly > end) return false;
                        }
                        
                        return true;
                    } catch (error) {
                        console.warn('æ—¥æœŸè§£æé”™è¯¯:', record.æ”¶æ ·æ—¶é—´, error);
                        return false;
                    }
                });
            }
            
            // æ›´æ–°æ‰€æœ‰å­—æ®µçš„é€‰é¡¹
            updateAllOptions() {
                const filteredData = this.getFilteredData();
                const selections = this.getCurrentSelections();
                
                this.fieldConfigs.forEach(config => {
                    // å¦‚æœå½“å‰å­—æ®µå·²æœ‰é€‰æ‹©ï¼Œè·³è¿‡æ›´æ–°
                    if (selections[config.field]) {
                        return;
                    }
                    
                    // è·å–è¯¥å­—æ®µåœ¨å½“å‰è¿‡æ»¤æ•°æ®ä¸­çš„å”¯ä¸€å€¼
                    const values = [...new Set(
                        filteredData.map(r => r[config.field])
                            .filter(v => v && v !== 'æœªçŸ¥' && v !== '')
                    )].sort();
                    
                    // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨
                    const listElement = document.getElementById(config.listId);
                    if (listElement) {
                        listElement.innerHTML = '';
                        values.forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            listElement.appendChild(option);
                        });
                    }
                    
                    console.log(`${config.name} å¯ç”¨é€‰é¡¹æ•°é‡: ${values.length}`);
                });
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                this.updateFilterStatus(selections, filteredData.length);
            }
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
            updateFilterStatus(selections, filteredCount) {
                const activeFiltersElement = document.getElementById('activeFilters');
                const availableOptionsElement = document.getElementById('availableOptions');
                
                const filters = [];
                
                // æ·»åŠ æ—¥æœŸèŒƒå›´ç­›é€‰ä¿¡æ¯
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                if (startDateInput && endDateInput) {
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    if (startDate || endDate) {
                        const dateRange = `${startDate || 'å¼€å§‹'} è‡³ ${endDate || 'ç»“æŸ'}`;
                        filters.push(`æ—¥æœŸèŒƒå›´: ${dateRange}`);
                    }
                }
                
                // æ·»åŠ å…¶ä»–ç­›é€‰æ¡ä»¶
                Object.entries(selections).forEach(([field, value]) => {
                    filters.push(`${field}: ${value}`);
                });
                
                if (filters.length === 0) {
                    activeFiltersElement.textContent = 'å½“å‰æ— ç­›é€‰æ¡ä»¶';
                    availableOptionsElement.textContent = '';
                } else {
                    activeFiltersElement.textContent = `å·²ç­›é€‰: ${filters.join(', ')}`;
                    availableOptionsElement.textContent = `å‰©ä½™è®°å½•: ${filteredCount} æ¡`;
                }
            }
            
            // é‡ç½®æ‰€æœ‰é€‰é¡¹
            resetAllOptions() {
                this.fieldConfigs.forEach(config => {
                    const input = document.getElementById(config.inputId);
                    if (input) input.value = '';
                });
                this.updateAllOptions();
            }
        }
        
        // å…¨å±€çº§è”ç­›é€‰ç³»ç»Ÿå®ä¾‹
        let cascadingFilter = null;
        
        // æ—¥æœŸèŒƒå›´è®¾ç½®å‡½æ•°
        function setDateRange(type) {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const today = new Date();
            
            switch(type) {
                case 'all':
                    startDateInput.value = '';
                    endDateInput.value = '';
                    break;
                case 'thisMonth':
                    const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    startDateInput.value = thisMonthStart.toISOString().split('T')[0];
                    endDateInput.value = thisMonthEnd.toISOString().split('T')[0];
                    break;
                case 'lastMonth':
                    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    startDateInput.value = lastMonthStart.toISOString().split('T')[0];
                    endDateInput.value = lastMonthEnd.toISOString().split('T')[0];
                    break;
            }
            
            // è§¦å‘çº§è”ç­›é€‰æ›´æ–°
            if (cascadingFilter) {
                cascadingFilter.onFieldChange('dateRange');
            }
        }
        
        // æå–å”¯ä¸€å€¼å¹¶æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
        function updateDropdownOptions(data) {
            // åˆ›å»ºçº§è”ç­›é€‰ç³»ç»Ÿ
            cascadingFilter = new CascadingFilterSystem(data);
            console.log('âœ… çº§è”ç­›é€‰ç³»ç»Ÿå·²åˆå§‹åŒ–');
            
            // è®¾ç½®æ—¥æœŸèŒƒå›´é»˜è®¤å€¼ï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼‰
            setDateRange('all');
        }
        
        // å»é‡åŠŸèƒ½ - ç§»é™¤å®Œå…¨ç›¸åŒçš„è®°å½•
        function removeDuplicateRecords(records) {
            const seen = new Set();
            const uniqueRecords = [];
            
            for (const record of records) {
                // åˆ›å»ºè®°å½•çš„å”¯ä¸€æ ‡è¯†ï¼ŒåŸºäºå®Œæ•´çš„é‡å¤åˆ¤æ–­å­—æ®µ
                const key = JSON.stringify({
                    æ”¶æ ·æ—¶é—´: record.æ”¶æ ·æ—¶é—´,
                    æ ·å“å‹å·: record.æ ·å“å‹å·,
                    å°ç¼–ç : record.å°ç¼–ç ,
                    ç‰ˆæœ¬å·: record.ç‰ˆæœ¬å·,
                    æµ‹è¯•ç¼–å·: record.æµ‹è¯•ç¼–å· || '',  // å¯èƒ½ä¸ºç©ºï¼Œç”¨ç©ºå­—ç¬¦ä¸²ä»£æ›¿
                    æ ·å“åˆ†ç±»: record.æ ·å“åˆ†ç±»,
                    æ ·å“æ€§è´¨: record.æ ·å“æ€§è´¨,
                    æ–°åˆ†ç±»: record.æ–°åˆ†ç±»
                });
                
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueRecords.push(record);
                }
            }
            
            console.log(`å»é‡å‰: ${records.length} æ¡è®°å½•ï¼Œå»é‡å: ${uniqueRecords.length} æ¡è®°å½•`);
            return uniqueRecords;
        }
        
        // =====================================================
        // åˆ†é¡µåŠŸèƒ½
        // =====================================================
        
        // åˆ†é¡µçŠ¶æ€
        let paginationState = {
            currentPage: 1,
            pageSize: 10,
            totalRecords: 0,
            totalPages: 0,
            allRecords: []
        };
        
        // åˆå§‹åŒ–åˆ†é¡µåŠŸèƒ½
        function initPagination() {
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            
            // æ¯é¡µæ¡æ•°å˜åŒ–äº‹ä»¶
            pageSizeSelect.addEventListener('change', function() {
                paginationState.pageSize = parseInt(this.value);
                paginationState.currentPage = 1;
                updatePagination();
                renderCurrentPage();
            });
            
            // åˆ†é¡µæŒ‰é’®äº‹ä»¶
            firstPageBtn.addEventListener('click', () => goToPage(1));
            prevPageBtn.addEventListener('click', () => goToPage(paginationState.currentPage - 1));
            nextPageBtn.addEventListener('click', () => goToPage(paginationState.currentPage + 1));
            lastPageBtn.addEventListener('click', () => goToPage(paginationState.totalPages));
        }
        
        // è®¾ç½®åˆ†é¡µæ•°æ®
        function setPaginationData(records) {
            paginationState.allRecords = records;
            paginationState.totalRecords = records.length;
            paginationState.totalPages = Math.ceil(records.length / paginationState.pageSize);
            paginationState.currentPage = 1;
            updatePagination();
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function goToPage(page) {
            if (page < 1 || page > paginationState.totalPages) return;
            
            paginationState.currentPage = page;
            updatePagination();
            renderCurrentPage();
        }
        
        // æ›´æ–°åˆ†é¡µUIçŠ¶æ€
        function updatePagination() {
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            firstPageBtn.disabled = paginationState.currentPage <= 1;
            prevPageBtn.disabled = paginationState.currentPage <= 1;
            nextPageBtn.disabled = paginationState.currentPage >= paginationState.totalPages;
            lastPageBtn.disabled = paginationState.currentPage >= paginationState.totalPages;
            
            // æ›´æ–°é¡µé¢ä¿¡æ¯
            pageInfo.textContent = `ç¬¬ ${paginationState.currentPage} é¡µï¼Œå…± ${paginationState.totalPages} é¡µ`;
        }
        
        // æ¸²æŸ“å½“å‰é¡µæ•°æ®
        function renderCurrentPage() {
            const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
            const endIndex = startIndex + paginationState.pageSize;
            const currentPageRecords = paginationState.allRecords.slice(startIndex, endIndex);
            
            updateTable(currentPageRecords);
        }
        
        // =====================================================
        // æ—¶é—´ç»´åº¦å¤„ç†åŠŸèƒ½
        // =====================================================
        
        // è·å–æ—¶é—´ç»´åº¦é…ç½®
        function getDimensionConfig(dimension) {
            const configs = {
                'day': { label: 'æ—¥', format: 'YYYY-MM-DD' },
                'week': { label: 'å‘¨', format: 'YYYY-WW' },
                'month': { label: 'æœˆ', format: 'YYYY-MM' },
                'year': { label: 'å¹´', format: 'YYYY' }
            };
            return configs[dimension] || configs['month'];
        }
        
        // æ ¼å¼åŒ–æ—¶é—´é”®
        function formatTimeKey(date, dimension) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            switch (dimension) {
                case 'day':
                    return `${year}-${month}-${day}`;
                case 'week':
                    const weekNumber = getWeekNumber(date);
                    return `${year}-W${String(weekNumber).padStart(2, '0')}`;
                case 'month':
                    return `${year}-${month}`;
                case 'year':
                    return `${year}`;
                default:
                    return `${year}-${month}`;
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´æ ‡ç­¾
        function formatTimeLabel(timeKey, dimension) {
            switch (dimension) {
                case 'day':
                    return timeKey; // ç›´æ¥æ˜¾ç¤ºæ—¥æœŸ
                case 'week':
                    return timeKey.replace('W', 'ç¬¬') + 'å‘¨';
                case 'month':
                    return timeKey.replace('-', 'å¹´') + 'æœˆ';
                case 'year':
                    return timeKey + 'å¹´';
                default:
                    return timeKey;
            }
        }
        
        // è·å–å‘¨æ•°
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        // =====================================================
        // æ—¥æœŸèŒƒå›´ç­›é€‰åŠŸèƒ½
        // =====================================================
        
        // åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰
        function applyDateRangeFilter(data) {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (!startDateInput || !endDateInput) {
                console.log('æ—¥æœŸè¾“å…¥æ¡†æœªæ‰¾åˆ°');
                return data;
            }
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            console.log('æ—¥æœŸèŒƒå›´ç­›é€‰:', { startDate, endDate });
            
            // å¦‚æœæ²¡æœ‰è®¾ç½®æ—¥æœŸèŒƒå›´ï¼Œè¿”å›æ‰€æœ‰æ•°æ®
            if (!startDate && !endDate) {
                console.log('æœªè®¾ç½®æ—¥æœŸèŒƒå›´ï¼Œè¿”å›æ‰€æœ‰æ•°æ®');
                return data;
            }
            
            return data.filter(record => {
                if (!record.æ”¶æ ·æ—¶é—´) return false;
                
                try {
                    const recordDate = new Date(record.æ”¶æ ·æ—¶é—´);
                    if (isNaN(recordDate.getTime())) return false;
                    
                    // åªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é—´
                    const recordDateOnly = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());
                    
                    if (startDate) {
                        const start = new Date(startDate);
                        if (recordDateOnly < start) return false;
                    }
                    
                    if (endDate) {
                        const end = new Date(endDate);
                        if (recordDateOnly > end) return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.warn('æ—¥æœŸè§£æé”™è¯¯:', record.æ”¶æ ·æ—¶é—´, error);
                    return false;
                }
            });
        }
        
        // =====================================================
        // æ—¶é—´ç»´åº¦é€‰æ‹©å™¨åŠŸèƒ½
        // =====================================================
        
        // åˆå§‹åŒ–æ—¶é—´ç»´åº¦é€‰æ‹©å™¨
        function initTimeDimensionSelector() {
            const dimensionButtons = document.querySelectorAll('.dimension-btn');
            
            dimensionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    dimensionButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // ä¸ºå½“å‰æŒ‰é’®æ·»åŠ activeç±»
                    this.classList.add('active');
                    
                    // é‡æ–°ç»˜åˆ¶å›¾è¡¨ï¼ˆå¦‚æœæœ‰æ•°æ®çš„è¯ï¼‰
                    if (window.currentRecords && window.currentRecords.length > 0) {
                        updateChart(window.currentRecords);
                    }
                });
            });
        }
        
        // =====================================================
        // æ¸…é™¤æŒ‰é’®åŠŸèƒ½
        // =====================================================
        
        // åˆå§‹åŒ–æ¸…é™¤æŒ‰é’®åŠŸèƒ½
        function initClearButtons() {
            const clearButtonMappings = [
                { inputId: 'modelSearch', clearId: 'clearModel' },
                { inputId: 'codeSearch', clearId: 'clearCode' },
                { inputId: 'categorySearch', clearId: 'clearCategory' },
                { inputId: 'propertySearch', clearId: 'clearProperty' },
                { inputId: 'subCategorySearch', clearId: 'clearSubCategory' },
                { inputId: 'testerSearch', clearId: 'clearTester' },
                { inputId: 'electronicEngineerSearch', clearId: 'clearElectronicEngineer' },
                { inputId: 'projectEngineerSearch', clearId: 'clearProjectEngineer' },
                { inputId: 'dqeSearch', clearId: 'clearDqe' },
                { inputId: 'dqeCategorySearch', clearId: 'clearDqeCategory' },
                { inputId: 'newCategorySearch', clearId: 'clearNewCategory' }
            ];
            
            clearButtonMappings.forEach(({ inputId, clearId }) => {
                const input = document.getElementById(inputId);
                const clearBtn = document.getElementById(clearId);
                
                if (input && clearBtn) {
                    // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œæ§åˆ¶æ¸…é™¤æŒ‰é’®æ˜¾ç¤º/éšè—
                    input.addEventListener('input', function() {
                        if (this.value.trim() !== '') {
                            clearBtn.style.display = 'flex';
                        } else {
                            clearBtn.style.display = 'none';
                        }
                    });
                    
                    // ç›‘å¬æ¸…é™¤æŒ‰é’®ç‚¹å‡»
                    clearBtn.addEventListener('click', function() {
                        input.value = '';
                        input.focus();
                        clearBtn.style.display = 'none';
                        
                        // è§¦å‘çº§è”ç­›é€‰æ›´æ–°
                        if (cascadingFilter) {
                            cascadingFilter.onFieldChange(inputId.replace('Search', ''));
                        }
                    });
                }
            });
        }
        
        // =====================================================
        // æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ
        // =====================================================
        
        function generateMockData() {
            const mockData = [];
            const models = ['D703', 'CM850', 'HD175', 'AK700', 'CM800', 'CM336', 'CM662', 'AK500', 'Model-001', 'Model-002'];
            const codes = ['65727', '45368', '55733', '55851', '75126', '80115', '15705', '12345', '67890', '11111'];
            const suppliers = ['æµ·ç›ˆ', 'è²ç‚«', 'UGREEN', 'ç»¿è”', 'å±±æ³½', 'å“èƒœ', 'å…¬ç‰›', 'å°ç±³', 'åä¸º', 'è‹¹æœ'];
            const dqeCategories = ['æ‰‹æœº', 'å¹³æ¿', 'ç¬”è®°æœ¬', 'è€³æœº', 'å……ç”µå™¨'];
            const testers = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'å­™ä¸ƒ'];
            const sampleTypes = ['åŠŸèƒ½æ ·', 'è®¤è¯æ ·', 'è¯•äº§æ ·', 'é‡äº§æ ·'];
            const properties = ['æ–°é¡¹ç›®', 'å˜æ›´é¡¹ç›®', 'ä¾‹è¡Œæµ‹è¯•'];
            const results = ['PASS', 'FAIL', 'PENDING'];
            const engineers = ['å·¥ç¨‹å¸ˆA', 'å·¥ç¨‹å¸ˆB', 'å·¥ç¨‹å¸ˆC', 'å·¥ç¨‹å¸ˆD'];
            const dqePersonnel = ['DQEå¼ ', 'DQEæ', 'DQEç‹', 'DQEèµµ'];
            
            // ç”Ÿæˆä¸€äº›å¤æ‚æ ¼å¼çš„æ ·å“å‹å·å’Œç¼–ç ç»„åˆ
            const complexPatterns = [
                { model: 'D703', code: '65727' },
                { model: 'D703/CM850', code: '65727/45368' },
                { model: 'D703+CM850+HD175', code: '65727+45368+55733' },
                { model: 'D703,CM850', code: '65727,45368' },
                { model: 'D703&CM850', code: '65727&45368' },
                { model: 'D703 CM850', code: '65727 45368' },
                { model: 'D703(å‡çº§ç‰ˆ)', code: '65727' },
                { model: 'AK500', code: '12345' },
                { model: 'AK500/AK700', code: '12345/55851' }
            ];
            
            for (let i = 0; i < 100; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 180)); // æœ€è¿‘6ä¸ªæœˆ
                
                // 70%ä½¿ç”¨å¤æ‚æ¨¡å¼ï¼Œ30%ä½¿ç”¨ç®€å•æ¨¡å¼
                let modelData, codeData;
                if (Math.random() < 0.7 && complexPatterns.length > 0) {
                    const pattern = complexPatterns[Math.floor(Math.random() * complexPatterns.length)];
                    modelData = pattern.model;
                    codeData = pattern.code;
                } else {
                    modelData = models[Math.floor(Math.random() * models.length)];
                    codeData = codes[Math.floor(Math.random() * codes.length)];
                }
                
                mockData.push({
                    'åºå·': i + 1,
                    'æ”¶æ ·æ—¶é—´': date.toLocaleDateString('zh-CN'),
                    'æ ·å“å‹å·': modelData,
                    'å°ç¼–ç ': codeData,
                    'ä¾›åº”å•†': suppliers[Math.floor(Math.random() * suppliers.length)],
                    'æ ·å“åˆ†ç±»': sampleTypes[Math.floor(Math.random() * sampleTypes.length)],
                    'æ ·å“æ€§è´¨': properties[Math.floor(Math.random() * properties.length)],
                    'é€æ ·æ¬¡æ•°': Math.floor(Math.random() * 5) + 1,
                    'ç‰ˆæœ¬å·': `V${Math.floor(Math.random() * 3) + 1}.${Math.floor(Math.random() * 9)}`,
                    'DQEå“ç±»ç»†åˆ†': dqeCategories[Math.floor(Math.random() * dqeCategories.length)],
                    'å“ç±»ç»†åˆ†': dqeCategories[Math.floor(Math.random() * dqeCategories.length)],
                    'æµ‹è¯•äºº': testers[Math.floor(Math.random() * testers.length)],
                    'ç”µå­å·¥ç¨‹å¸ˆ': engineers[Math.floor(Math.random() * engineers.length)],
                    'é¡¹ç›®å·¥ç¨‹å¸ˆ': engineers[Math.floor(Math.random() * engineers.length)],
                    'DQE': dqePersonnel[Math.floor(Math.random() * dqePersonnel.length)],
                    'æ–°åˆ†ç±»': sampleTypes[Math.floor(Math.random() * sampleTypes.length)],
                    'æµ‹è¯•ç¼–å·': `ET2025${String(Math.floor(Math.random() * 1000000)).padStart(6, '0')}`,
                    'åˆ¤å®šç»“æœ': results[Math.floor(Math.random() * results.length)],
                    'æµ‹è¯•æ—¶é•¿': parseFloat((Math.random() * 20 + 1).toFixed(1)),
                    'é—®é¢˜æ€»æ•°': Math.floor(Math.random() * 5),
                    'é€æ ·å‘¨æœŸ': parseFloat((Math.random() * 30 + 1).toFixed(1)),
                    'é€æ ·å‘¨åˆ«': `2025-W${String(Math.floor(Math.random() * 52) + 1).padStart(2, '0')}`,
                    'åŠ æ€¥/åŒæ­¥': Math.random() > 0.7 ? 'åŠ æ€¥' : 'æ­£å¸¸',
                    'æ€»æ•°': Math.floor(Math.random() * 100) + 1
                });
            }
            
            console.log('âœ… æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå®Œæˆï¼ŒåŒ…å«', mockData.length, 'æ¡è®°å½•');
            return mockData;
        }
        
        // =====================================================
        // ä¸“ä¸šç»Ÿè®¡å­¦å‡½æ•°
        // =====================================================
        
        // è®¡ç®—å››åˆ†ä½æ•° - ä¸“ä¸šç»Ÿè®¡å­¦æ–¹æ³•
        function calculateQuartiles(data) {
            if (!data || data.length === 0) return { q1: 0, q2: 0, q3: 0 };
            
            const sorted = [...data].sort((a, b) => a - b);
            const n = sorted.length;
            
            const q1Index = Math.floor(n * 0.25);
            const q2Index = Math.floor(n * 0.5);
            const q3Index = Math.floor(n * 0.75);
            
            return {
                q1: sorted[q1Index] || 0,
                q2: sorted[q2Index] || 0, // ä¸­ä½æ•°
                q3: sorted[q3Index] || 0
            };
        }
        
        // è®¡ç®—æ ‡å‡†å·®
        function calculateStandardDeviation(data) {
            if (!data || data.length === 0) return 0;
            
            const mean = data.reduce((sum, val) => sum + val, 0) / data.length;
            const squaredDiffs = data.map(val => Math.pow(val - mean, 2));
            const avgSquaredDiff = squaredDiffs.reduce((sum, val) => sum + val, 0) / data.length;
            
            return Math.sqrt(avgSquaredDiff);
        }
        
        // è®¡ç®—å˜å¼‚ç³»æ•° (CV)
        function calculateCoefficientOfVariation(data) {
            if (!data || data.length === 0) return 0;
            
            const mean = data.reduce((sum, val) => sum + val, 0) / data.length;
            const std = calculateStandardDeviation(data);
            
            return mean === 0 ? 0 : (std / mean) * 100;
        }
        
        // è®¡ç®—ç›¸å…³ç³»æ•°
        function calculateCorrelation(x, y) {
            if (!x || !y || x.length !== y.length || x.length === 0) return 0;
            
            const n = x.length;
            const sumX = x.reduce((sum, val) => sum + val, 0);
            const sumY = y.reduce((sum, val) => sum + val, 0);
            const sumXY = x.reduce((sum, val, i) => sum + val * y[i], 0);
            const sumX2 = x.reduce((sum, val) => sum + val * val, 0);
            const sumY2 = y.reduce((sum, val) => sum + val * val, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }
        
        // =====================================================
        // æ·±åº¦ç»Ÿè®¡åˆ†æåŠŸèƒ½
        // =====================================================
        
        // æ˜¾ç¤ºæ— æ•°æ®æç¤º
        function showNoDataMessage(tabName) {
            const tabElement = document.getElementById(tabName);
            if (!tabElement) return;
            
            // æ‰¾åˆ°æŒ‡æ ‡å’Œå›¾è¡¨å®¹å™¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±ä¸å¤„ç†
            const metricsContainer = tabElement.querySelector('.metric-grid');
            const chartContainer = tabElement.querySelector('.chart-container');
            
            if (metricsContainer) {
                metricsContainer.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                        <h3 style="margin-bottom: 10px; color: #495057;">æš‚æ— æ•°æ®</h3>
                        <p>è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶æˆ–è¿›è¡Œæœç´¢ä»¥æŸ¥çœ‹ç»Ÿè®¡åˆ†æç»“æœ</p>
                    </div>
                `;
            }
            
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“ˆ</div>
                            <p>å›¾è¡¨å°†åœ¨æœ‰æ•°æ®åæ˜¾ç¤º</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // åˆ‡æ¢åˆ†ææ ‡ç­¾é¡µ
        function switchAnalysisTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // ä¸ºé€‰ä¸­çš„æ ‡ç­¾æ·»åŠ activeç±»
            event.target.classList.add('active');
            
            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
            loadAnalysisData(tabName);
        }
        
        // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½åˆ†ææ•°æ®
        function loadAnalysisData(tabName) {
            // ä¼˜å…ˆä½¿ç”¨æœç´¢ç»“æœï¼Œå…¶æ¬¡ä½¿ç”¨æ‰€æœ‰æ•°æ®
            const currentData = window.currentRecords || window.currentData;
            
            // å¦‚æœæ²¡æœ‰çœŸå®æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºå¹¶è¿”å›
            if (!currentData || currentData.length === 0) {
                showNoDataMessage(tabName);
                return;
            }
            
            switch(tabName) {
                case 'overview':
                    loadOverviewAnalysis(currentData);
                    break;
                case 'resource':
                    loadResourceAnalysis(currentData);
                    break;
                case 'cycle':
                    loadCycleAnalysis(currentData);
                    break;
                case 'sample':
                    loadSampleAnalysis(currentData);
                    break;
                case 'personnel':
                    loadPersonnelAnalysis(currentData);
                    break;
                case 'waterlevel':
                    loadWaterlevelAnalysis(currentData);
                    break;
                case 'inventory':
                    loadInventoryAnalysis(currentData);
                    break;
                case 'advanced':
                    loadAdvancedAnalysis(currentData);
                    break;
            }
        }
        
        // åŠ è½½æ¦‚è§ˆåˆ†æ
        function loadOverviewAnalysis(data) {
            // æ¦‚è§ˆæ•°æ®å·²ç»åœ¨åŸæœ‰çš„ç»Ÿè®¡å¡ç‰‡ä¸­æ˜¾ç¤º
            console.log('æ¦‚è§ˆåˆ†æå·²åŠ è½½ï¼Œæ•°æ®é‡:', data.length);
            
            // å¦‚æœæ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
            if (data === generateMockData() || (!window.currentData && !window.currentRecords)) {
                const overviewDiv = document.getElementById('overview');
                if (overviewDiv) {
                    const existingAlert = overviewDiv.querySelector('.data-alert');
                    if (!existingAlert) {
                        const alert = document.createElement('div');
                        alert.className = 'data-alert';
                        alert.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center;';
                        alert.innerHTML = 'âš ï¸ å½“å‰æ˜¾ç¤ºçš„æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œè¯·ä¸Šä¼ Excelæ–‡ä»¶æŸ¥çœ‹çœŸå®æ•°æ®åˆ†æ';
                        overviewDiv.insertBefore(alert, overviewDiv.firstChild);
                    }
                }
            }
        }
        
        // åŠ è½½èµ„æºæŠ•å…¥åˆ†æ
        function loadResourceAnalysis(data) {
            const resourceMetrics = document.getElementById('resourceMetrics');
            
            // è®¡ç®—DQEå“ç±»ç»†åˆ†ç»Ÿè®¡
            const dqeStats = {};
            data.forEach(record => {
                const dqe = record.DQEå“ç±»ç»†åˆ† || 'æœªçŸ¥';
                if (!dqeStats[dqe]) {
                    dqeStats[dqe] = { count: 0, totalTime: 0, passCount: 0 };
                }
                dqeStats[dqe].count++;
                dqeStats[dqe].totalTime += parseFloat(record.æµ‹è¯•æ—¶é•¿) || 0;
                if (record.åˆ¤å®šç»“æœ === 'PASS') dqeStats[dqe].passCount++;
            });
            
            const topDqe = Object.entries(dqeStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
            
            resourceMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">æœ€æ´»è·ƒDQEå“ç±»</div>
                    <div class="metric-value">${topDqe[0]?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">é€æ ·æ€»æ•°</div>
                    <div class="metric-value">${topDqe[0]?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å¹³å‡æµ‹è¯•æ—¶é•¿</div>
                    <div class="metric-value">${(topDqe[0]?.[1].totalTime / topDqe[0]?.[1].count || 0).toFixed(1)}h</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">é€šè¿‡ç‡</div>
                    <div class="metric-value">${(topDqe[0]?.[1].passCount / topDqe[0]?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
            `;
            
            // åˆ›å»ºèµ„æºæŠ•å…¥å›¾è¡¨
            const ctx = document.getElementById('resourceChart').getContext('2d');
            if (window.resourceChart && typeof window.resourceChart.destroy === 'function') {
                window.resourceChart.destroy();
            }
            window.resourceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topDqe.map(d => d[0]),
                    datasets: [{
                        label: 'é€æ ·æ¬¡æ•°',
                        data: topDqe.map(d => d[1].count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // åŠ è½½å‘¨æœŸåˆ†æ
        function loadCycleAnalysis(data) {
            const cycleMetrics = document.getElementById('cycleMetrics');
            
            // è®¡ç®—é€æ ·å‘¨æœŸç»Ÿè®¡ - ä¸“ä¸šç»Ÿè®¡å­¦æŒ‡æ ‡
            const cycles = data.map(d => parseFloat(d.é€æ ·å‘¨æœŸ) || 0).filter(c => c > 0);
            const avgCycle = cycles.length > 0 ? cycles.reduce((a, b) => a + b, 0) / cycles.length : 0;
            const minCycle = cycles.length > 0 ? Math.min(...cycles) : 0;
            const maxCycle = cycles.length > 0 ? Math.max(...cycles) : 0;
            const quartiles = calculateQuartiles(cycles);
            const stdDev = calculateStandardDeviation(cycles);
            const cv = calculateCoefficientOfVariation(cycles);
            
            cycleMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">å¹³å‡å€¼ (Î¼)</div>
                    <div class="metric-value">${avgCycle.toFixed(1)}å¤©</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ä¸­ä½æ•° (Q2)</div>
                    <div class="metric-value">${quartiles.q2.toFixed(1)}å¤©</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ ‡å‡†å·® (Ïƒ)</div>
                    <div class="metric-value">${stdDev.toFixed(2)}å¤©</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å˜å¼‚ç³»æ•° (CV)</div>
                    <div class="metric-value">${cv.toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å››åˆ†ä½è· (IQR)</div>
                    <div class="metric-value">${(quartiles.q3 - quartiles.q1).toFixed(1)}å¤©</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ ·æœ¬æ•° (n)</div>
                    <div class="metric-value">${cycles.length}</div>
                </div>
            `;
            
            // åˆ›å»ºä¸“ä¸šçš„ç®±å›¾åˆ†æå’Œè¶‹åŠ¿å›¾è¡¨
            const ctx = document.getElementById('cycleChart').getContext('2d');
            if (window.cycleChart && typeof window.cycleChart.destroy === 'function') {
                window.cycleChart.destroy();
            }
            
            // å‡†å¤‡æ—¶é—´åºåˆ—æ•°æ® - æŒ‰æ—¥æœŸæ’åº
            const timeSeriesData = data
                .filter(d => d.æ”¶æ ·æ—¶é—´ && d.é€æ ·å‘¨æœŸ)
                .map(d => ({
                    date: new Date(d.æ”¶æ ·æ—¶é—´),
                    cycle: parseFloat(d.é€æ ·å‘¨æœŸ) || 0
                }))
                .sort((a, b) => a.date - b.date);
            
            // è®¡ç®—ç»Ÿè®¡åˆ†å¸ƒ - ä¸“ä¸šç»Ÿè®¡å­¦æ–¹æ³•
            const quartiles2 = calculateQuartiles(cycles);
            
            window.cycleChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.map(d => d.date.toLocaleDateString('zh-CN')),
                    datasets: [{
                        label: 'é€æ ·å‘¨æœŸè¶‹åŠ¿',
                        data: timeSeriesData.map(d => d.cycle),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'å¹³å‡å€¼',
                        data: new Array(timeSeriesData.length).fill(avgCycle),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0
                    }, {
                        label: 'Q3 (75åˆ†ä½æ•°)',
                        data: new Array(timeSeriesData.length).fill(quartiles2.q3),
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderDash: [3, 3],
                        pointRadius: 0,
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'é€æ ·å‘¨æœŸæ—¶é—´åºåˆ—åˆ†æ (å«ç»Ÿè®¡æ§åˆ¶çº¿)',
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å‘¨æœŸ(å¤©)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ”¶æ ·æ—¶é—´'
                            }
                        }
                    }
                }
            });
        }
        
        // åŠ è½½æ ·å“åˆ†æ
        function loadSampleAnalysis(data) {
            const sampleMetrics = document.getElementById('sampleMetrics');
            
            // è®¡ç®—æ ·å“åˆ†ç±»ç»Ÿè®¡
            const categoryStats = {};
            data.forEach(record => {
                const category = record.æ ·å“åˆ†ç±» || 'æœªçŸ¥';
                if (!categoryStats[category]) {
                    categoryStats[category] = { count: 0, passCount: 0 };
                }
                categoryStats[category].count++;
                if (record.åˆ¤å®šç»“æœ === 'PASS') categoryStats[category].passCount++;
            });
            
            const topCategory = Object.entries(categoryStats)
                .sort((a, b) => b[1].count - a[1].count)[0];
            
            sampleMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">æœ€æ´»è·ƒæ ·å“åˆ†ç±»</div>
                    <div class="metric-value">${topCategory?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">é€æ ·æ¬¡æ•°</div>
                    <div class="metric-value">${topCategory?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">é€šè¿‡ç‡</div>
                    <div class="metric-value">${(topCategory?.[1].passCount / topCategory?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ ·å“åˆ†ç±»æ•°</div>
                    <div class="metric-value">${Object.keys(categoryStats).length}</div>
                </div>
            `;
            
            // åˆ›å»ºæ ·å“åˆ†æå›¾è¡¨
            const ctx = document.getElementById('sampleChart').getContext('2d');
            if (window.sampleChart && typeof window.sampleChart.destroy === 'function') {
                window.sampleChart.destroy();
            }
            const topCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
            
            window.sampleChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: topCategories.map(d => d[0]),
                    datasets: [{
                        data: topCategories.map(d => d[1].count),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // åŠ è½½äººå‘˜æŠ€èƒ½åˆ†æ
        function loadPersonnelAnalysis(data) {
            const personnelMetrics = document.getElementById('personnelMetrics');
            
            // è®¡ç®—æµ‹è¯•äººå‘˜ç»Ÿè®¡
            const testerStats = {};
            data.forEach(record => {
                const tester = record.æµ‹è¯•äºº || 'æœªçŸ¥';
                if (!testerStats[tester]) {
                    testerStats[tester] = { count: 0, passCount: 0, categories: new Set() };
                }
                testerStats[tester].count++;
                if (record.åˆ¤å®šç»“æœ === 'PASS') testerStats[tester].passCount++;
                testerStats[tester].categories.add(record.å“ç±»ç»†åˆ† || 'æœªçŸ¥');
            });
            
            const topTester = Object.entries(testerStats)
                .sort((a, b) => b[1].count - a[1].count)[0];
            
            personnelMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">æœ€æ´»è·ƒæµ‹è¯•äºº</div>
                    <div class="metric-value">${topTester?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æµ‹è¯•æ¬¡æ•°</div>
                    <div class="metric-value">${topTester?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">é€šè¿‡ç‡</div>
                    <div class="metric-value">${(topTester?.[1].passCount / topTester?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ¶‰åŠå“ç±»æ•°</div>
                    <div class="metric-value">${topTester?.[1].categories.size || 0}</div>
                </div>
            `;
            
            // åˆ›å»ºäººå‘˜æŠ€èƒ½å›¾è¡¨
            const ctx = document.getElementById('personnelChart').getContext('2d');
            if (window.personnelChart && typeof window.personnelChart.destroy === 'function') {
                window.personnelChart.destroy();
            }
            const topTesters = Object.entries(testerStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
            
            window.personnelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topTesters.map(d => d[0]),
                    datasets: [{
                        label: 'æµ‹è¯•æ¬¡æ•°',
                        data: topTesters.map(d => d[1].count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // åŠ è½½æ°´ä½çº¿åˆ†æ
        function loadWaterlevelAnalysis(data) {
            const waterlevelMetrics = document.getElementById('waterlevelMetrics');
            
            // è®¡ç®—æ”¶æ ·æ°´ä½ç»Ÿè®¡
            const weeklyStats = {};
            data.forEach(record => {
                const week = record.é€æ ·å‘¨åˆ« || 'æœªçŸ¥';
                if (!weeklyStats[week]) {
                    weeklyStats[week] = { count: 0, urgentCount: 0 };
                }
                weeklyStats[week].count++;
                if (record['åŠ æ€¥/åŒæ­¥'] === 'åŠ æ€¥') weeklyStats[week].urgentCount++;
            });
            
            const recentWeek = Object.entries(weeklyStats)
                .sort((a, b) => b[0].localeCompare(a[0]))[0];
            
            waterlevelMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">æœ€è¿‘ä¸€å‘¨æ”¶æ ·æ•°</div>
                    <div class="metric-value">${recentWeek?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">åŠ æ€¥æ¯”ä¾‹</div>
                    <div class="metric-value">${(recentWeek?.[1].urgentCount / recentWeek?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å‘¨åˆ«</div>
                    <div class="metric-value">${recentWeek?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ€»å‘¨æ•°</div>
                    <div class="metric-value">${Object.keys(weeklyStats).length}</div>
                </div>
            `;
            
            // åˆ›å»ºæ°´ä½çº¿å›¾è¡¨
            const ctx = document.getElementById('waterlevelChart').getContext('2d');
            if (window.waterlevelChart && typeof window.waterlevelChart.destroy === 'function') {
                window.waterlevelChart.destroy();
            }
            const weeklyData = Object.entries(weeklyStats)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .slice(-10);
            
            window.waterlevelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeklyData.map(d => d[0]),
                    datasets: [{
                        label: 'æ”¶æ ·æ•°',
                        data: weeklyData.map(d => d[1].count),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // åŠ è½½åº“å­˜ç®¡ç†åˆ†æ
        function loadInventoryAnalysis(data) {
            const inventoryMetrics = document.getElementById('inventoryMetrics');
            
            // è®¡ç®—åº“å­˜ç»Ÿè®¡
            const totalSamples = data.reduce((sum, record) => sum + (parseInt(record.æ€»æ•°) || 0), 0);
            const completedSamples = data.filter(record => record.åˆ¤å®šç»“æœ === 'PASS').length;
            const pendingSamples = data.length - completedSamples;
            
            inventoryMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">æ€»æ ·å“æ•°</div>
                    <div class="metric-value">${totalSamples}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å·²å®Œæˆ</div>
                    <div class="metric-value">${completedSamples}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å¾…å¤„ç†</div>
                    <div class="metric-value">${pendingSamples}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å®Œæˆç‡</div>
                    <div class="metric-value">${(completedSamples / data.length * 100).toFixed(1)}%</div>
                </div>
            `;
            
            // åˆ›å»ºåº“å­˜ç®¡ç†å›¾è¡¨
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            if (window.inventoryChart && typeof window.inventoryChart.destroy === 'function') {
                window.inventoryChart.destroy();
            }
            window.inventoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²å®Œæˆ', 'å¾…å¤„ç†'],
                    datasets: [{
                        data: [completedSamples, pendingSamples],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // åŠ è½½é«˜çº§ç»Ÿè®¡åˆ†æ
        function loadAdvancedAnalysis(data) {
            const advancedMetrics = document.getElementById('advancedMetrics');
            
            // è®¡ç®—é«˜çº§ç»Ÿè®¡æŒ‡æ ‡
            const passRate = data.filter(d => d.åˆ¤å®šç»“æœ === 'PASS').length / data.length * 100;
            const avgTestTime = data.reduce((sum, d) => sum + (parseFloat(d.æµ‹è¯•æ—¶é•¿) || 0), 0) / data.length;
            const problemCount = data.reduce((sum, d) => sum + (parseInt(d.é—®é¢˜æ€»æ•°) || 0), 0);
            
            // è®¡ç®—å®é™…çš„ç»¼åˆè¯„åˆ†æŒ‡æ ‡
            const efficiency = Math.max(0, 100 - avgTestTime); // æ•ˆç‡ï¼šæµ‹è¯•æ—¶é•¿è¶ŠçŸ­æ•ˆç‡è¶Šé«˜
            const quality = Math.max(0, 100 - (problemCount / data.length * 10)); // è´¨é‡ï¼šé—®é¢˜è¶Šå°‘è´¨é‡è¶Šé«˜
            const coverage = Math.min(100, (new Set(data.map(d => d.æ ·å“åˆ†ç±»)).size / 10) * 100); // è¦†ç›–åº¦ï¼šæ ·å“åˆ†ç±»æ•°
            const timeliness = Math.max(0, 100 - (data.reduce((sum, d) => sum + (parseFloat(d.é€æ ·å‘¨æœŸ) || 0), 0) / data.length / 30 * 100)); // åŠæ—¶æ€§ï¼šå‘¨æœŸè¶ŠçŸ­è¶ŠåŠæ—¶
            
            advancedMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">æ•´ä½“é€šè¿‡ç‡</div>
                    <div class="metric-value">${passRate.toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ•ˆç‡è¯„åˆ†</div>
                    <div class="metric-value">${efficiency.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">è´¨é‡è¯„åˆ†</div>
                    <div class="metric-value">${quality.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">è¦†ç›–åº¦è¯„åˆ†</div>
                    <div class="metric-value">${coverage.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">åŠæ—¶æ€§è¯„åˆ†</div>
                    <div class="metric-value">${timeliness.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">é—®é¢˜æ€»æ•°</div>
                    <div class="metric-value">${problemCount}</div>
                </div>
            `;
            
            // åˆ›å»ºé«˜çº§ç»Ÿè®¡å›¾è¡¨
            const ctx = document.getElementById('advancedChart').getContext('2d');
            if (window.advancedChart && typeof window.advancedChart.destroy === 'function') {
                window.advancedChart.destroy();
            }
            window.advancedChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['é€šè¿‡ç‡', 'æ•ˆç‡', 'è´¨é‡', 'è¦†ç›–åº¦', 'åŠæ—¶æ€§'],
                    datasets: [{
                        label: 'ç»¼åˆè¯„åˆ†',
                        data: [passRate, efficiency, quality, coverage, timeliness],
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // =====================================================
        // åˆå§‹åŒ–
        // =====================================================
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            // è¾“å‡ºç³»ç»Ÿä¿¡æ¯
            console.log('æ™ºèƒ½é¡¹ç›®è¯†åˆ«ç³»ç»Ÿå·²å¯åŠ¨');
            
            // åˆå§‹åŒ–æ¸…é™¤æŒ‰é’®åŠŸèƒ½
            initClearButtons();
            
            // åˆå§‹åŒ–æ—¶é—´ç»´åº¦é€‰æ‹©å™¨
            initTimeDimensionSelector();
            
            // åˆå§‹åŒ–åˆ†é¡µåŠŸèƒ½
            initPagination();
            console.log('æ”¯æŒçš„åˆ†éš”ç¬¦:', matcher.separators);
            console.log('æ¨¡æ‹Ÿæ•°æ®é‡:', mockData.length);
            
            // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®å’Œä¸‹æ‹‰é€‰é¡¹
            updateDropdownOptions(currentData);
            
            // åˆå§‹åŒ–æ·±åº¦åˆ†æ
            loadAnalysisData('overview');
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            const searchButton = document.getElementById('searchButton');
            if (searchButton) {
                searchButton.addEventListener('click', function(e) {
                    console.log('ğŸ”˜ æœç´¢æŒ‰é’®è¢«ç‚¹å‡»');
                    e.preventDefault();
                    searchProject();
                });
            }
            
            // æ·»åŠ æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload);
                console.log('âœ… æ–‡ä»¶ä¸Šä¼ ç›‘å¬å™¨å·²ç»‘å®š');
            }
            
            // æµ‹è¯•æœç´¢åŠŸèƒ½
            console.log('æµ‹è¯•æœç´¢åŠŸèƒ½...');
            testSearchFunction();
        };
        
        // æµ‹è¯•æœç´¢åŠŸèƒ½
        function testSearchFunction() {
            console.log('=== æœç´¢åŠŸèƒ½æµ‹è¯• ===');
            console.log('å½“å‰æ•°æ®é‡:', currentData.length);
            
            if (currentData.length > 0) {
                console.log('å‰3æ¡æ•°æ®æ ·æœ¬:');
                currentData.slice(0, 3).forEach((record, index) => {
                    console.log(`æ ·æœ¬${index + 1}:`, {
                        æ ·å“å‹å·: record.æ ·å“å‹å·,
                        å°ç¼–ç : record.å°ç¼–ç ,
                        ä¾›åº”å•†: record.ä¾›åº”å•†
                    });
                });
                
                // æµ‹è¯•AK500æœç´¢
                console.log('æµ‹è¯•AK500æœç´¢...');
                const testResult = matcher.match('AK500', '', 'AK500', '12345');
                console.log('AK500æµ‹è¯•ç»“æœ:', testResult);
                
                // æµ‹è¯•å®é™…æ•°æ®ä¸­çš„åŒ¹é…
                let foundMatches = 0;
                currentData.slice(0, 10).forEach((record, index) => {
                    const matchResult = matcher.match('AK500', '', record.æ ·å“å‹å·, record.å°ç¼–ç );
                    if (matchResult.matched) {
                        foundMatches++;
                        console.log(`æ‰¾åˆ°åŒ¹é…è®°å½•${index + 1}:`, record);
                    }
                });
                console.log(`å‰10æ¡è®°å½•ä¸­AK500åŒ¹é…æ•°: ${foundMatches}`);
            }
        }
        
        // æµ‹è¯•æœç´¢æŒ‰é’®
        function testSearch() {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•æœç´¢...');
            console.log('å½“å‰æ•°æ®é‡:', currentData.length);
            
            // è®¾ç½®æµ‹è¯•æœç´¢æ¡ä»¶
            document.getElementById('modelSearch').value = 'AK500';
            document.getElementById('codeSearch').value = '';
            
            // æ‰§è¡Œæœç´¢
            searchProject();
        }
        
        // å¯¼å‡ºåŠŸèƒ½ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
        window.ProjectAnalyzer = {
            matcher: matcher,
            data: currentData,
            search: searchProject,
            stats: calculateStatistics,
            exportData: function() {
                return currentData;
            },
            importData: function(data) {
                currentData = data;
                mockData = data;
                console.log('æ•°æ®å·²å¯¼å…¥ï¼Œå…±', data.length, 'æ¡è®°å½•');
            }
        };
        
        // ==================== æ™ºèƒ½ç­›é€‰é…ç½®åŠŸèƒ½ ====================
        
        // æ™ºèƒ½ç­›é€‰é…ç½®æ•°æ®
        let smartFilterConfig = {
            searchRules: [],
            dedupRules: [],
            templates: {},
            currentTemplate: null,
            filterHistory: []
        };
        
        // å­—æ®µé…ç½® - åŸºäºExcelè¡¨å¤´çš„å®Œæ•´å­—æ®µåˆ—è¡¨
        const FIELD_CONFIG = {
            // åŸºç¡€ä¿¡æ¯
            'æ”¶æ ·æ—¶é—´': { name: 'æ”¶æ ·æ—¶é—´', type: 'date', group: 'åŸºç¡€ä¿¡æ¯' },
            'æ ·å“å‹å·': { name: 'æ ·å“å‹å·', type: 'text', group: 'åŸºç¡€ä¿¡æ¯' },
            'å°ç¼–ç ': { name: 'å°ç¼–ç ', type: 'text', group: 'åŸºç¡€ä¿¡æ¯' },
            'æ ·å“åç§°': { name: 'æ ·å“åç§°', type: 'text', group: 'åŸºç¡€ä¿¡æ¯' },
            'ä¾›åº”å•†': { name: 'ä¾›åº”å•†', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'é€æ ·æ¬¡æ•°': { name: 'é€æ ·æ¬¡æ•°', type: 'number', group: 'åŸºç¡€ä¿¡æ¯' },
            'å“ç±»ç»†åˆ†': { name: 'å“ç±»ç»†åˆ†', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'ç‰ˆæœ¬å·': { name: 'ç‰ˆæœ¬å·', type: 'text', group: 'åŸºç¡€ä¿¡æ¯' },
            'æµ‹è¯•ç¼–å·': { name: 'æµ‹è¯•ç¼–å·', type: 'text', group: 'åŸºç¡€ä¿¡æ¯' },
            'æ ·å“åˆ†ç±»': { name: 'æ ·å“åˆ†ç±»', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'æ ·å“æ€§è´¨': { name: 'æ ·å“æ€§è´¨', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'é¡¹ç›®å±æ€§': { name: 'é¡¹ç›®å±æ€§', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'å†…å¤–è´¸åŒºåˆ†': { name: 'å†…å¤–è´¸åŒºåˆ†', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'éœ€æ±‚è€—æ—¶': { name: 'éœ€æ±‚è€—æ—¶', type: 'number', group: 'åŸºç¡€ä¿¡æ¯' },
            'ä¾›åº”å•†å‰ç½®': { name: 'ä¾›åº”å•†å‰ç½®', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'DQEå“ç±»ç»†åˆ†': { name: 'DQEå“ç±»ç»†åˆ†', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'æ–°åˆ†ç±»': { name: 'æ–°åˆ†ç±»', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'åŠ æ€¥/åŒæ­¥': { name: 'åŠ æ€¥/åŒæ­¥', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'æ˜¯å¦åœ¨è®¡åˆ’å†…': { name: 'æ˜¯å¦åœ¨è®¡åˆ’å†…', type: 'select', group: 'åŸºç¡€ä¿¡æ¯' },
            'é€æ ·å¤‡æ³¨': { name: 'é€æ ·å¤‡æ³¨', type: 'text', group: 'åŸºç¡€ä¿¡æ¯' },
            
            // æ—¶é—´ç®¡ç†
            'æµ‹è¯•æ—¶é•¿': { name: 'æµ‹è¯•æ—¶é•¿', type: 'number', group: 'æ—¶é—´ç®¡ç†' },
            'ç”µæ°”æ€§èƒ½æµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´': { name: 'ç”µæ°”æ€§èƒ½æµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´', type: 'date', group: 'æ—¶é—´ç®¡ç†' },
            'ç”µæ°”æ€§èƒ½æµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´': { name: 'ç”µæ°”æ€§èƒ½æµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´', type: 'date', group: 'æ—¶é—´ç®¡ç†' },
            'ç”µæ°”æ€§èƒ½æµ‹è¯•_å®é™…å¼€å§‹æ—¶é—´': { name: 'ç”µæ°”æ€§èƒ½æµ‹è¯•_å®é™…å¼€å§‹æ—¶é—´', type: 'date', group: 'æ—¶é—´ç®¡ç†' },
            'ç”µæ°”æ€§èƒ½æµ‹è¯•_å®é™…å®Œæˆæ—¶é—´': { name: 'ç”µæ°”æ€§èƒ½æµ‹è¯•_å®é™…å®Œæˆæ—¶é—´', type: 'date', group: 'æ—¶é—´ç®¡ç†' },
            'ç”µå­å·¥ç¨‹å¸ˆ&DQEç¡®è®¤_å¼€å§‹æ—¶é—´': { name: 'ç”µå­å·¥ç¨‹å¸ˆ&DQEç¡®è®¤_å¼€å§‹æ—¶é—´', type: 'date', group: 'æ—¶é—´ç®¡ç†' },
            'ç”µå­å·¥ç¨‹å¸ˆ&DQEç¡®è®¤_å®Œæˆæ—¶é—´': { name: 'ç”µå­å·¥ç¨‹å¸ˆ&DQEç¡®è®¤_å®Œæˆæ—¶é—´', type: 'date', group: 'æ—¶é—´ç®¡ç†' },
            
            // äººå‘˜ä¿¡æ¯
            'æµ‹è¯•äºº': { name: 'æµ‹è¯•äºº', type: 'select', group: 'äººå‘˜ä¿¡æ¯' },
            'ç”µå­å·¥ç¨‹å¸ˆ': { name: 'ç”µå­å·¥ç¨‹å¸ˆ', type: 'select', group: 'äººå‘˜ä¿¡æ¯' },
            'é¡¹ç›®å·¥ç¨‹å¸ˆ': { name: 'é¡¹ç›®å·¥ç¨‹å¸ˆ', type: 'select', group: 'äººå‘˜ä¿¡æ¯' },
            'DQE': { name: 'DQE', type: 'select', group: 'äººå‘˜ä¿¡æ¯' },
            
            // çŠ¶æ€ä¿¡æ¯
            'çŠ¶æ€': { name: 'çŠ¶æ€', type: 'select', group: 'çŠ¶æ€ä¿¡æ¯' },
            'è¿›åº¦': { name: 'è¿›åº¦', type: 'number', group: 'çŠ¶æ€ä¿¡æ¯' }
        };
        
        // æ”¯æŒçš„æ“ä½œç¬¦ - æ ¹æ®å­—æ®µç±»å‹åŠ¨æ€æ˜¾ç¤º
        const operators = {
            text: [
                { value: 'contains', label: 'åŒ…å«' },
                { value: 'not_contains', label: 'ä¸åŒ…å«' },
                { value: 'equals', label: 'ç­‰äº' },
                { value: 'not_equals', label: 'ä¸ç­‰äº' },
                { value: 'starts_with', label: 'å¼€å§‹äº' },
                { value: 'ends_with', label: 'ç»“æŸäº' }
            ],
            number: [
                { value: 'equals', label: 'ç­‰äº' },
                { value: 'not_equals', label: 'ä¸ç­‰äº' },
                { value: 'greater_than', label: 'å¤§äº' },
                { value: 'less_than', label: 'å°äº' },
                { value: 'greater_equal', label: 'å¤§äºç­‰äº' },
                { value: 'less_equal', label: 'å°äºç­‰äº' },
                { value: 'between', label: 'ä»‹äº' }
            ],
            date: [
                { value: 'equals', label: 'ç­‰äº' },
                { value: 'not_equals', label: 'ä¸ç­‰äº' },
                { value: 'before', label: 'æ—©äº' },
                { value: 'after', label: 'æ™šäº' },
                { value: 'between', label: 'ä»‹äº' },
                { value: 'today', label: 'ä»Šå¤©' },
                { value: 'this_week', label: 'æœ¬å‘¨' },
                { value: 'this_month', label: 'æœ¬æœˆ' }
            ],
            select: [
                { value: 'equals', label: 'ç­‰äº' },
                { value: 'not_equals', label: 'ä¸ç­‰äº' },
                { value: 'contains_any', label: 'åŒ…å«ä»»ä¸€' },
                { value: 'not_contains_any', label: 'ä¸åŒ…å«ä»»ä¸€' }
            ]
        };
        
        // é€»è¾‘è¿æ¥ç¬¦
        const logicConnectors = ['ä¸”', 'æˆ–'];
        
        // å­—æ®µåˆ†ç»„é…ç½®
        const fieldGroups = {
            'åŸºç¡€ä¿¡æ¯': [
                'æ”¶æ ·æ—¶é—´', 'æ ·å“å‹å·', 'å°ç¼–ç ', 'æ ·å“åç§°', 'ä¾›åº”å•†', 'é€æ ·æ¬¡æ•°',
                'å“ç±»ç»†åˆ†', 'ç‰ˆæœ¬å·', 'æµ‹è¯•ç¼–å·', 'æ ·å“åˆ†ç±»', 'æ ·å“æ€§è´¨', 'é¡¹ç›®å±æ€§',
                'å†…å¤–è´¸åŒºåˆ†', 'éœ€æ±‚è€—æ—¶', 'ä¾›åº”å•†å‰ç½®', 'DQEå“ç±»ç»†åˆ†', 'æ–°åˆ†ç±»',
                'åŠ æ€¥/åŒæ­¥', 'æ˜¯å¦åœ¨è®¡åˆ’å†…', 'é€æ ·å¤‡æ³¨'
            ],
            'æ—¶é—´ç®¡ç†': [
                'æµ‹è¯•æ—¶é•¿', 'ç”µæ°”æ€§èƒ½æµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´', 'ç”µæ°”æ€§èƒ½æµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´',
                'ç”µæ°”æ€§èƒ½æµ‹è¯•_å®é™…å¼€å§‹æ—¶é—´', 'ç”µæ°”æ€§èƒ½æµ‹è¯•_å®é™…å®Œæˆæ—¶é—´',
                'æœºæ¢°æ€§èƒ½æµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´', 'æœºæ¢°æ€§èƒ½æµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´',
                'ç¯å¢ƒæµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´', 'ç¯å¢ƒæµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´',
                'å®‰å…¨æµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´', 'å®‰å…¨æµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´',
                'EMCæµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´', 'EMCæµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´',
                'å¯é æ€§æµ‹è¯•_è®¡åˆ’å¼€å§‹æ—¶é—´', 'å¯é æ€§æµ‹è¯•_è®¡åˆ’å®Œæˆæ—¶é—´'
            ],
            'äººå‘˜ä¿¡æ¯': [
                'æµ‹è¯•äºº', 'ç”µå­å·¥ç¨‹å¸ˆ', 'é¡¹ç›®å·¥ç¨‹å¸ˆ', 'DQE', 'è´£ä»»äºº'
            ],
            'çŠ¶æ€ä¿¡æ¯': [
                'é¡¹ç›®çŠ¶æ€', 'è¿›åº¦', 'æµ‹è¯•ç»“æœ', 'åˆ¤å®šç»“æœ', 'é—®é¢˜çŠ¶æ€'
            ]
        };
        
        // å­—æ®µç±»å‹æ£€æµ‹
        function getFieldType(fieldName, sampleValue) {
            if (sampleValue === null || sampleValue === undefined) {
                return 'text';
            }
            
            const value = String(sampleValue);
            
            // æ—¥æœŸç±»å‹æ£€æµ‹
            if (value.match(/^\d{4}-\d{2}-\d{2}/) || value.match(/^\d{4}\/\d{2}\/\d{2}/)) {
                return 'date';
            }
            
            // æ•°å­—ç±»å‹æ£€æµ‹
            if (!isNaN(value) && !isNaN(parseFloat(value))) {
                return 'number';
            }
            
            // é€‰æ‹©ç±»å‹æ£€æµ‹ï¼ˆåŸºäºå­—æ®µåç§°å’Œå€¼ï¼‰
            const selectFields = ['æ ·å“åˆ†ç±»', 'æ ·å“æ€§è´¨', 'DQEå“ç±»ç»†åˆ†', 'æ–°åˆ†ç±»', 'é¡¹ç›®çŠ¶æ€'];
            if (selectFields.includes(fieldName)) {
                return 'select';
            }
            
            return 'text';
        }
        
        // æ‰“å¼€æ™ºèƒ½ç­›é€‰é…ç½®
        function openSmartFilterConfig() {
            showSmartFilterModal('search');
        }
        
        // æ‰“å¼€å»é‡é…ç½®
        function openDedupConfig() {
            showSmartFilterModal('dedup');
        }
        
        // æ˜¾ç¤ºæ™ºèƒ½ç­›é€‰æ¨¡æ€æ¡†
        function showSmartFilterModal(type) {
            const modal = document.getElementById('smartFilterModal');
            if (!modal) {
                createSmartFilterModal();
            }
            
            // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜å’Œç±»å‹
            const title = document.getElementById('smartFilterTitle');
            const configType = document.getElementById('configType');
            
            if (type === 'search') {
                title.textContent = 'é¡¹ç›®æ™ºèƒ½æœç´¢é…ç½®';
                configType.value = 'search';
            } else {
                title.textContent = 'å»é‡æ™ºèƒ½ç­›é€‰é…ç½®';
                configType.value = 'dedup';
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';
            
            // åŠ è½½å½“å‰é…ç½®
            loadCurrentConfig(type);
            
            // åˆå§‹åŒ–çŠ¶æ€
            updateFilterStatus();
        }
        
        // åˆ›å»ºæ™ºèƒ½ç­›é€‰æ¨¡æ€æ¡†
        function createSmartFilterModal() {
            const modalHTML = `
                <div id="smartFilterModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 id="smartFilterTitle">æ™ºèƒ½ç­›é€‰é…ç½®</h2>
                            <div class="header-actions">
                                <button class="btn btn-secondary" onclick="resetFilter()" title="é‡ç½®ç­›é€‰">
                                    ğŸ”„ é‡ç½®
                                </button>
                                <span class="close" onclick="closeSmartFilterModal()">&times;</span>
                            </div>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="configType" value="search">
                            
                            <div class="filter-description">
                                é…ç½®ç­›é€‰æ¡ä»¶ï¼Œæ”¯æŒå¤šæ¡ä»¶ç»„åˆå’Œå¤æ‚é€»è¾‘å…³ç³»
                            </div>
                            
                            <!-- ç­›é€‰æ¡ä»¶é…ç½® -->
                            <div class="filter-conditions-container">
                                <div id="filterConditions" class="filter-conditions">
                                    <!-- æ¡ä»¶è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                                
                                <div id="emptyState" class="empty-state" style="display: none;">
                                    <div class="empty-icon">ğŸ”</div>
                                    <p>æš‚æ— ç­›é€‰æ¡ä»¶</p>
                                    <p class="empty-hint">ç‚¹å‡»"æ·»åŠ æ¡ä»¶"å¼€å§‹é…ç½®ç­›é€‰</p>
                                </div>
                                
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="addFilterCondition()">
                                        â• æ·»åŠ æ¡ä»¶
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ç­›é€‰æ¨¡æ¿ -->
                            <div class="template-section">
                                <div class="template-header">
                                    <h3>ç­›é€‰æ¨¡æ¿</h3>
                                    <div class="template-controls">
                                        <input type="text" id="templateName" placeholder="è¾“å…¥æ¨¡æ¿åç§°" class="template-input">
                                        <button class="btn btn-success" onclick="saveTemplate()">ä¿å­˜æ¨¡æ¿</button>
                                    </div>
                                </div>
                                
                                <div class="template-list" id="templateList">
                                    <!-- æ¨¡æ¿å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="footer-status">
                                <span id="filterStatus" class="status-indicator">æ— ç­›é€‰æ¡ä»¶</span>
                            </div>
                            <div class="footer-actions">
                                <button class="btn btn-secondary" onclick="closeSmartFilterModal()">å–æ¶ˆ</button>
                                <button class="btn btn-danger" onclick="clearFilter()">æ¸…ç©ºç­›é€‰</button>
                                <button class="btn btn-primary" onclick="applyFilter()">åº”ç”¨ç­›é€‰</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // æ·»åŠ æ¨¡æ€æ¡†æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .modal {
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                
                .modal-content {
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    position: relative;
                    width: 90%;
                    max-width: 1000px;
                    max-height: 90vh;
                    overflow-y: auto;
                }
                
                .modal-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px 15px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .modal-header h2 {
                    margin: 0;
                    font-size: 1.5em;
                }
                
                .close {
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                    color: white;
                }
                
                .close:hover {
                    opacity: 0.7;
                }
                
                .modal-body {
                    padding: 30px;
                }
                
                .modal-footer {
                    background: #f8f9fa;
                    padding: 20px 30px;
                    border-radius: 0 0 15px 15px;
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                }
                
                .filter-conditions {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                }
                
                .condition-row {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    margin-bottom: 15px;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                
                .condition-row:last-child {
                    margin-bottom: 0;
                }
                
                .logic-connector {
                    min-width: 80px;
                }
                
                .field-select, .operator-select, .value-input {
                    flex: 1;
                    padding: 10px;
                    border: 2px solid #e1e5e9;
                    border-radius: 6px;
                    font-size: 14px;
                    transition: border-color 0.3s;
                }
                
                .field-select:focus, .operator-select:focus, .value-input:focus {
                    outline: none;
                    border-color: #667eea;
                }
                
                .searchable-dropdown {
                    position: relative;
                    width: 100%;
                }
                
                .search-input {
                    width: 100%;
                    padding: 10px 40px 10px 10px;
                    border: 2px solid #e1e5e9;
                    border-radius: 6px;
                    font-size: 14px;
                }
                
                .search-icon {
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: #666;
                }
                
                .dropdown-list {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 2px solid #e1e5e9;
                    border-top: none;
                    border-radius: 0 0 6px 6px;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                }
                
                .dropdown-item {
                    padding: 10px;
                    cursor: pointer;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .dropdown-item:hover {
                    background: #f8f9fa;
                }
                
                .dropdown-item:last-child {
                    border-bottom: none;
                }
                
                .action-buttons {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                }
                
                .template-section {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                }
                
                .template-controls {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                
                .template-list {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                    gap: 15px;
                }
                
                .template-card {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    border: 2px solid transparent;
                    transition: all 0.3s;
                    cursor: pointer;
                }
                
                .template-card:hover {
                    border-color: #667eea;
                }
                
                .template-card.selected {
                    border-color: #667eea;
                    background: #f8f9ff;
                }
                
                .template-card.preset-template {
                    border-left: 4px solid #28a745;
                }
                
                .template-card.user-template {
                    border-left: 4px solid #667eea;
                }
                
                .preset-badge {
                    background: #28a745;
                    color: white;
                    font-size: 10px;
                    padding: 2px 6px;
                    border-radius: 10px;
                    margin-left: 8px;
                }
                
                .template-actions {
                    margin-top: 10px;
                    text-align: right;
                }
                
                .header-actions {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .filter-description {
                    padding: 15px 20px;
                    background: #f8f9fa;
                    border-bottom: 1px solid #e5e7eb;
                    color: #6b7280;
                    font-size: 14px;
                }
                
                .filter-conditions-container {
                    padding: 20px;
                }
                
                .empty-state {
                    text-align: center;
                    padding: 40px 20px;
                    color: #6b7280;
                }
                
                .empty-icon {
                    font-size: 48px;
                    margin-bottom: 16px;
                    opacity: 0.5;
                }
                
                .empty-hint {
                    font-size: 12px;
                    margin-top: 8px;
                    opacity: 0.8;
                }
                
                .template-section {
                    border-top: 1px solid #e5e7eb;
                    padding: 20px;
                    background: #f8f9fa;
                }
                
                .template-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                }
                
                .template-header h3 {
                    margin: 0;
                    color: #374151;
                }
                
                .template-controls {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                }
                
                .template-input {
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                    width: 200px;
                }
                
                .modal-footer {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-top: 1px solid #e5e7eb;
                    background: #f9fafb;
                }
                
                .footer-status {
                    flex: 1;
                }
                
                .status-indicator {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 500;
                }
                
                .footer-actions {
                    display: flex;
                    gap: 10px;
                }
                
                .condition-card {
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                
                .condition-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 20px;
                    border-bottom: 1px solid #f3f4f6;
                    background: #f8f9fa;
                }
                
                .condition-title {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .condition-label {
                    font-weight: 600;
                    color: #374151;
                }
                
                .condition-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .btn-icon {
                    background: none;
                    border: none;
                    padding: 6px;
                    border-radius: 4px;
                    cursor: pointer;
                    color: #6b7280;
                    transition: all 0.2s;
                }
                
                .btn-icon:hover {
                    background: #f3f4f6;
                    color: #374151;
                }
                
                .btn-icon.danger:hover {
                    background: #fef2f2;
                    color: #dc2626;
                }
                
                .condition-content {
                    padding: 20px;
                }
                
                .condition-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr 2fr;
                    gap: 20px;
                    align-items: end;
                }
                
                .condition-field, .condition-operator, .condition-value {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .condition-field label, .condition-operator label, .condition-value label {
                    font-size: 12px;
                    font-weight: 600;
                    color: #6b7280;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .smart-field-selector, .smart-value-selector {
                    position: relative;
                }
                
                .smart-field-selector select, .smart-value-selector input {
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                    transition: border-color 0.2s;
                }
                
                .smart-field-selector select:focus, .smart-value-selector input:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                }
                
                .empty-templates {
                    text-align: center;
                    padding: 40px 20px;
                    color: #6b7280;
                }
                
                .template-card {
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .template-card:hover {
                    border-color: #3b82f6;
                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
                }
                
                .template-card.selected {
                    border-color: #3b82f6;
                    background: #f0f9ff;
                }
                
                .template-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 20px;
                    border-bottom: 1px solid #f3f4f6;
                }
                
                .template-name {
                    font-weight: 600;
                    color: #374151;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .template-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .template-content {
                    padding: 15px 20px;
                }
                
                .template-description {
                    color: #6b7280;
                    font-size: 14px;
                    margin-bottom: 10px;
                }
                
                .template-meta {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 12px;
                    color: #9ca3af;
                }
                
                .template-rules {
                    background: #f3f4f6;
                    padding: 2px 6px;
                    border-radius: 4px;
                }
                
                .template-date {
                    color: #9ca3af;
                }
                
                .template-name {
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                
                .template-description {
                    color: #666;
                    font-size: 12px;
                    margin-bottom: 10px;
                }
                
                .template-rules {
                    font-size: 12px;
                    color: #888;
                }
                
                .btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.3s;
                }
                
                .btn-primary {
                    background: #667eea;
                    color: white;
                }
                
                .btn-primary:hover {
                    background: #5a6fd8;
                }
                
                .btn-secondary {
                    background: #6c757d;
                    color: white;
                }
                
                .btn-secondary:hover {
                    background: #5a6268;
                }
                
                .btn-danger {
                    background: #dc3545;
                    color: white;
                }
                
                .btn-danger:hover {
                    background: #c82333;
                }
                
                .btn-success {
                    background: #28a745;
                    color: white;
                }
                
                .btn-success:hover {
                    background: #218838;
                }
                
                .btn-sm {
                    padding: 5px 10px;
                    font-size: 12px;
                }
            `;
            document.head.appendChild(style);
        }
        
        // å…³é—­æ™ºèƒ½ç­›é€‰æ¨¡æ€æ¡†
        function closeSmartFilterModal() {
            const modal = document.getElementById('smartFilterModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ·»åŠ ç­›é€‰æ¡ä»¶
        function addFilterCondition() {
            const conditionsContainer = document.getElementById('filterConditions');
            const conditionId = Date.now();
            
            const conditionRow = document.createElement('div');
            conditionRow.className = 'condition-card';
            conditionRow.id = `condition-${conditionId}`;
            
            conditionRow.innerHTML = `
                <div class="condition-header">
                    <div class="condition-title">
                        ${conditionsContainer.children.length > 0 ? createLogicConnectorSelect(conditionId) : ''}
                        <span class="condition-label">æ¡ä»¶ ${conditionsContainer.children.length + 1}</span>
                    </div>
                    <div class="condition-actions">
                        <button class="btn-icon" onclick="toggleCondition(${conditionId})" title="å±•å¼€/æ”¶èµ·">
                            <span class="toggle-icon">â–¼</span>
                        </button>
                        <button class="btn-icon danger" onclick="removeCondition(${conditionId})" title="åˆ é™¤æ¡ä»¶">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
                <div class="condition-content">
                    <div class="condition-grid">
                        <div class="condition-field">
                            <label>å­—æ®µ</label>
                            <div class="smart-field-selector">
                                <select class="field-select" onchange="onFieldChange(${conditionId})">
                                    ${createGroupedFieldSelector(conditionId)}
                                </select>
                            </div>
                        </div>
                        
                        <div class="condition-operator">
                            <label>æ“ä½œç¬¦</label>
                            <select class="operator-select" onchange="onOperatorChange(${conditionId})">
                                <option value="">é€‰æ‹©æ“ä½œç¬¦</option>
                            </select>
                        </div>
                        
                        <div class="condition-value">
                            <label>å€¼</label>
                            <div class="smart-value-selector">
                                <input type="text" class="value-input" placeholder="è¾“å…¥å€¼" 
                                       onkeyup="onValueInput(${conditionId}, this.value)"
                                       onfocus="showDropdown(${conditionId})"
                                       onblur="hideDropdown(${conditionId})">
                                <div class="dropdown-list" id="dropdown-${conditionId}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            conditionsContainer.appendChild(conditionRow);
            updateFilterStatus();
        }
        
        // åˆ›å»ºé€»è¾‘è¿æ¥ç¬¦é€‰æ‹©å™¨
        function createLogicConnectorSelect(conditionId) {
            return `
                <select class="operator-select" onchange="updateLogicConnector(${conditionId}, this.value)">
                    ${logicConnectors.map(conn => `<option value="${conn}">${conn}</option>`).join('')}
                </select>
            `;
        }
        
        // è·å–å¯ç”¨å­—æ®µï¼ˆæŒ‰åˆ†ç»„ï¼‰
        function getAvailableFields() {
            if (currentData.length === 0) return [];
            const allFields = Object.keys(currentData[0]);
            const groupedFields = {};
            
            // æŒ‰åˆ†ç»„ç»„ç»‡å­—æ®µ
            Object.entries(fieldGroups).forEach(([groupName, groupFields]) => {
                const availableFields = groupFields.filter(field => allFields.includes(field));
                if (availableFields.length > 0) {
                    groupedFields[groupName] = availableFields;
                }
            });
            
            // æ·»åŠ æœªåˆ†ç»„çš„å­—æ®µ
            const ungroupedFields = allFields.filter(field => 
                !Object.values(fieldGroups).flat().includes(field)
            );
            if (ungroupedFields.length > 0) {
                groupedFields['å…¶ä»–å­—æ®µ'] = ungroupedFields;
            }
            
            return groupedFields;
        }
        
        // åˆ›å»ºåˆ†ç»„å­—æ®µé€‰æ‹©å™¨
        function createGroupedFieldSelector(conditionId) {
            const groupedFields = getAvailableFields();
            let html = '<option value="">é€‰æ‹©å­—æ®µ</option>';
            
            Object.entries(groupedFields).forEach(([groupName, fields]) => {
                html += `<optgroup label="${groupName}">`;
                fields.forEach(field => {
                    html += `<option value="${field}">${field}</option>`;
                });
                html += '</optgroup>';
            });
            
            return html;
        }
        
        // å­—æ®µå˜åŒ–å¤„ç†
        function onFieldChange(conditionId) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const fieldSelect = conditionRow.querySelector('.field-select');
            const operatorSelect = conditionRow.querySelector('.operator-select');
            const selectedField = fieldSelect.value;
            
            if (selectedField) {
                // æ£€æµ‹å­—æ®µç±»å‹å¹¶æ›´æ–°æ“ä½œç¬¦
                const sampleValue = currentData.length > 0 ? currentData[0][selectedField] : null;
                const fieldType = getFieldType(selectedField, sampleValue);
                updateOperatorOptions(operatorSelect, fieldType);
                
                // åŠ è½½å­—æ®µå€¼
                loadFieldValues(selectedField, conditionId);
            }
        }
        
        // æ›´æ–°æ“ä½œç¬¦é€‰é¡¹
        function updateOperatorOptions(operatorSelect, fieldType) {
            const typeOperators = operators[fieldType] || operators.text;
            operatorSelect.innerHTML = '<option value="">é€‰æ‹©æ“ä½œç¬¦</option>' +
                typeOperators.map(op => `<option value="${op.value}">${op.label}</option>`).join('');
        }
        
        // åˆ‡æ¢æ¡ä»¶å±•å¼€/æ”¶èµ·
        function toggleCondition(conditionId) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const content = conditionRow.querySelector('.condition-content');
            const toggleIcon = conditionRow.querySelector('.toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleIcon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggleIcon.textContent = 'â–¶';
            }
        }
        
        // æ›´æ–°ç­›é€‰çŠ¶æ€
        function updateFilterStatus() {
            const conditionsContainer = document.getElementById('filterConditions');
            const statusElement = document.getElementById('filterStatus');
            const emptyState = document.getElementById('emptyState');
            const conditionCount = conditionsContainer.children.length;
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            if (conditionCount === 0) {
                statusElement.textContent = 'æ— ç­›é€‰æ¡ä»¶';
                statusElement.className = 'status-indicator';
                if (emptyState) emptyState.style.display = 'block';
            } else {
                statusElement.textContent = `${conditionCount} ä¸ªç­›é€‰æ¡ä»¶`;
                statusElement.className = 'status-indicator';
                if (emptyState) emptyState.style.display = 'none';
            }
        }
        
        // é‡ç½®ç­›é€‰
        function resetFilter() {
            const conditionsContainer = document.getElementById('filterConditions');
            conditionsContainer.innerHTML = '';
            updateFilterStatus();
        }
        
        // åŠ è½½å­—æ®µå€¼
        function loadFieldValues(field, conditionId) {
            const values = getFieldValues(field);
            const dropdown = document.getElementById(`dropdown-${conditionId}`);
            
            dropdown.innerHTML = values.map(value => 
                `<div class="dropdown-item" onclick="selectValue(${conditionId}, '${value}')">${value}</div>`
            ).join('');
        }
        
        // è·å–å­—æ®µå€¼
        function getFieldValues(field, searchTerm = '') {
            if (currentData.length === 0) return [];
            
            const values = [...new Set(currentData.map(record => record[field]).filter(v => v !== null && v !== undefined && v !== ''))];
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                return values.filter(v => String(v).toLowerCase().includes(term));
            }
            
            return values.sort();
        }
        
        // å€¼è¾“å…¥å¤„ç†
        function onValueInput(conditionId, value) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const fieldSelect = conditionRow.querySelector('.field-select');
            const selectedField = fieldSelect.value;
            
            if (selectedField && value) {
                loadFieldValues(selectedField, conditionId);
                showDropdown(conditionId);
            }
        }
        
        // æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
        function showDropdown(conditionId) {
            const dropdown = document.getElementById(`dropdown-${conditionId}`);
            dropdown.style.display = 'block';
        }
        
        // éšè—ä¸‹æ‹‰åˆ—è¡¨
        function hideDropdown(conditionId) {
            setTimeout(() => {
                const dropdown = document.getElementById(`dropdown-${conditionId}`);
                dropdown.style.display = 'none';
            }, 200);
        }
        
        // é€‰æ‹©å€¼
        function selectValue(conditionId, value) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const valueInput = conditionRow.querySelector('.search-input');
            valueInput.value = value;
            hideDropdown(conditionId);
        }
        
        // åˆ é™¤æ¡ä»¶
        function removeCondition(conditionId) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            conditionRow.remove();
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ¡ä»¶
        function clearAllConditions() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¡ä»¶å—ï¼Ÿ')) {
                document.getElementById('filterConditions').innerHTML = '';
            }
        }
        
        // åŠ è½½å½“å‰é…ç½®
        function loadCurrentConfig(type) {
            // åŠ è½½é¢„è®¾æ¨¡æ¿
            loadPresetTemplates();
            // åŠ è½½ç”¨æˆ·æ¨¡æ¿
            loadTemplates();
            console.log('åŠ è½½é…ç½®ç±»å‹:', type);
        }
        
        // åŠ è½½é¢„è®¾æ¨¡æ¿
        function loadPresetTemplates() {
            const presetTemplates = {
                'è¿‘æœŸé¡¹ç›®': {
                    name: 'è¿‘æœŸé¡¹ç›®',
                    description: 'ç­›é€‰æœ€è¿‘30å¤©çš„é¡¹ç›®',
                    rules: [
                        {
                            field: 'æ”¶æ ·æ—¶é—´',
                            operator: 'after',
                            value: '30å¤©å‰',
                            logic_connector: 'ä¸”'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                'ç´§æ€¥é¡¹ç›®': {
                    name: 'ç´§æ€¥é¡¹ç›®',
                    description: 'ç­›é€‰åŠ æ€¥æˆ–åŒæ­¥é¡¹ç›®',
                    rules: [
                        {
                            field: 'åŠ æ€¥/åŒæ­¥',
                            operator: 'contains',
                            value: 'åŠ æ€¥',
                            logic_connector: 'æˆ–'
                        },
                        {
                            field: 'åŠ æ€¥/åŒæ­¥',
                            operator: 'contains',
                            value: 'åŒæ­¥',
                            logic_connector: 'æˆ–'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                'ç‰¹å®šä¾›åº”å•†é¡¹ç›®': {
                    name: 'ç‰¹å®šä¾›åº”å•†é¡¹ç›®',
                    description: 'ç­›é€‰ç‰¹å®šä¾›åº”å•†çš„é¡¹ç›®',
                    rules: [
                        {
                            field: 'ä¾›åº”å•†',
                            operator: 'contains',
                            value: 'ä¾›åº”å•†A',
                            logic_connector: 'ä¸”'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                'ç”µæ°”æµ‹è¯•é¡¹ç›®': {
                    name: 'ç”µæ°”æµ‹è¯•é¡¹ç›®',
                    description: 'ç­›é€‰ç”µæ°”æµ‹è¯•ç›¸å…³é¡¹ç›®',
                    rules: [
                        {
                            field: 'æ ·å“åˆ†ç±»',
                            operator: 'contains',
                            value: 'ç”µæ°”',
                            logic_connector: 'ä¸”'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                'NWç³»åˆ—é¡¹ç›®': {
                    name: 'NWç³»åˆ—é¡¹ç›®',
                    description: 'ç­›é€‰NWç³»åˆ—æ ·å“é¡¹ç›®',
                    rules: [
                        {
                            field: 'æ ·å“å‹å·',
                            operator: 'starts_with',
                            value: 'NW',
                            logic_connector: 'ä¸”'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                }
            };
            
            // å°†é¢„è®¾æ¨¡æ¿æ·»åŠ åˆ°é…ç½®ä¸­
            Object.entries(presetTemplates).forEach(([name, template]) => {
                if (!smartFilterConfig.templates[name]) {
                    smartFilterConfig.templates[name] = template;
                }
            });
        }
        
        // ä¿å­˜æ¨¡æ¿
        function saveTemplate() {
            const templateName = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:');
            if (!templateName) return;
            
            const templateDescription = prompt('è¯·è¾“å…¥æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰:') || '';
            const conditions = collectConditions();
            
            const template = {
                name: templateName,
                description: templateDescription,
                rules: conditions,
                created_at: new Date().toISOString()
            };
            
            smartFilterConfig.templates[templateName] = template;
            loadTemplates();
            alert('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
        }
        
        // åŠ è½½æ¨¡æ¿
        function loadTemplate() {
            const templateSelect = document.getElementById('templateSelect');
            const selectedTemplate = templateSelect.value;
            
            if (!selectedTemplate) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿');
                return;
            }
            
            const template = smartFilterConfig.templates[selectedTemplate];
            if (template) {
                loadTemplateConditions(template);
            }
        }
        
        // åˆ é™¤æ¨¡æ¿
        function deleteTemplate(templateName) {
            const template = smartFilterConfig.templates[templateName];
            
            if (!template) {
                alert('æ¨¡æ¿ä¸å­˜åœ¨');
                return;
            }
            
            if (template.isPreset) {
                alert('é¢„è®¾æ¨¡æ¿ä¸èƒ½åˆ é™¤');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${templateName}" å—ï¼Ÿ`)) {
                delete smartFilterConfig.templates[templateName];
                loadTemplates();
                alert('æ¨¡æ¿åˆ é™¤æˆåŠŸï¼');
            }
        }
        
        // åŠ è½½æ¨¡æ¿åˆ—è¡¨
        function loadTemplates() {
            const templateList = document.getElementById('templateList');
            
            if (!templateList) return;
            
            // æ›´æ–°æ¨¡æ¿åˆ—è¡¨
            const templates = Object.entries(smartFilterConfig.templates);
            
            if (templates.length === 0) {
                templateList.innerHTML = `
                    <div class="empty-templates">
                        <div class="empty-icon">ğŸ“‹</div>
                        <p>æš‚æ— ç­›é€‰æ¨¡æ¿</p>
                        <p class="empty-hint">é…ç½®ç­›é€‰æ¡ä»¶åå¯ä»¥ä¿å­˜ä¸ºæ¨¡æ¿</p>
                    </div>
                `;
                return;
            }
            
            templateList.innerHTML = templates.map(([name, template]) => `
                <div class="template-card ${template.isPreset ? 'preset-template' : 'user-template'}" onclick="selectTemplate('${name}')">
                    <div class="template-header">
                        <div class="template-name">
                            ${name}
                            ${template.isPreset ? '<span class="preset-badge">é¢„è®¾</span>' : ''}
                        </div>
                        <div class="template-actions">
                            <button class="btn-icon" onclick="applyTemplate('${name}')" title="åº”ç”¨æ¨¡æ¿">
                                âœ…
                            </button>
                            ${!template.isPreset ? `
                                <button class="btn-icon danger" onclick="deleteTemplate('${name}')" title="åˆ é™¤æ¨¡æ¿">
                                    ğŸ—‘ï¸
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="template-content">
                        <div class="template-description">${template.description || 'æ— æè¿°'}</div>
                        <div class="template-meta">
                            <span class="template-rules">${template.rules ? template.rules.length : 0} æ¡è§„åˆ™</span>
                            <span class="template-date">${template.created_at ? new Date(template.created_at).toLocaleDateString() : ''}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // é€‰æ‹©æ¨¡æ¿
        function selectTemplate(templateName) {
            const template = smartFilterConfig.templates[templateName];
            if (template) {
                loadTemplateConditions(template);
            }
        }
        
        // åº”ç”¨æ¨¡æ¿
        function applyTemplate(templateName) {
            const template = smartFilterConfig.templates[templateName];
            if (template) {
                loadTemplateConditions(template);
                alert(`å·²åº”ç”¨æ¨¡æ¿: ${templateName}`);
            }
        }
        
        // æ”¶é›†æ¡ä»¶
        function collectConditions() {
            const conditions = [];
            const conditionRows = document.querySelectorAll('.condition-row');
            
            conditionRows.forEach((row, index) => {
                const fieldSelect = row.querySelector('.field-select');
                const operatorSelect = row.querySelector('.operator-select');
                const valueInput = row.querySelector('.search-input');
                const logicSelect = row.querySelector('.logic-connector select');
                
                if (fieldSelect.value && operatorSelect.value && valueInput.value) {
                    conditions.push({
                        field: fieldSelect.value,
                        operator: operatorSelect.value,
                        value: valueInput.value,
                        logic_connector: logicSelect ? logicSelect.value : 'ä¸”'
                    });
                }
            });
            
            return conditions;
        }
        
        // åŠ è½½æ¨¡æ¿æ¡ä»¶
        function loadTemplateConditions(template) {
            // æ¸…ç©ºç°æœ‰æ¡ä»¶
            clearAllConditions();
            
            // æ·»åŠ æ¡ä»¶
            template.rules.forEach((rule, index) => {
                if (index > 0) addFilterCondition();
                
                const conditionRow = document.querySelector('.condition-row:last-child');
                if (conditionRow) {
                    const fieldSelect = conditionRow.querySelector('.field-select');
                    const operatorSelect = conditionRow.querySelector('.operator-select');
                    const valueInput = conditionRow.querySelector('.search-input');
                    const logicSelect = conditionRow.querySelector('.logic-connector select');
                    
                    fieldSelect.value = rule.field;
                    operatorSelect.value = rule.operator;
                    valueInput.value = rule.value;
                    if (logicSelect) logicSelect.value = rule.logic_connector;
                }
            });
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            const conditions = collectConditions();
            const configType = document.getElementById('configType').value;
            
            if (conditions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªç­›é€‰æ¡ä»¶');
                return;
            }
            
            console.log('åº”ç”¨ç­›é€‰:', { type: configType, conditions });
            
            // æ ¹æ®é…ç½®ç±»å‹åº”ç”¨ä¸åŒçš„ç­›é€‰é€»è¾‘
            if (configType === 'search') {
                applySearchFilter(conditions);
            } else {
                applyDedupFilter(conditions);
            }
            
            closeSmartFilterModal();
        }
        
        // åº”ç”¨æœç´¢ç­›é€‰
        function applySearchFilter(conditions) {
            let filteredData = [...currentData];
            
            conditions.forEach(condition => {
                filteredData = filteredData.filter(record => {
                    const fieldValue = record[condition.field];
                    const conditionValue = condition.value;
                    
                    return evaluateCondition(fieldValue, condition.operator, conditionValue);
                });
            });
            
            // æ›´æ–°æœç´¢ç»“æœ
            updateSearchResults(filteredData);
            alert(`æœç´¢å®Œæˆï¼æ‰¾åˆ° ${filteredData.length} æ¡åŒ¹é…è®°å½•`);
        }
        
        // æ¡ä»¶è¯„ä¼°å‡½æ•°
        function evaluateCondition(fieldValue, operator, conditionValue) {
            if (fieldValue === null || fieldValue === undefined) {
                return false;
            }
            
            const fieldStr = String(fieldValue);
            const conditionStr = String(conditionValue);
            
            switch (operator) {
                // æ–‡æœ¬æ“ä½œç¬¦
                case 'contains':
                    return fieldStr.includes(conditionStr);
                case 'not_contains':
                    return !fieldStr.includes(conditionStr);
                case 'equals':
                    return fieldStr === conditionStr;
                case 'not_equals':
                    return fieldStr !== conditionStr;
                case 'starts_with':
                    return fieldStr.startsWith(conditionStr);
                case 'ends_with':
                    return fieldStr.endsWith(conditionStr);
                
                // æ•°å­—æ“ä½œç¬¦
                case 'greater_than':
                    return parseFloat(fieldStr) > parseFloat(conditionStr);
                case 'less_than':
                    return parseFloat(fieldStr) < parseFloat(conditionStr);
                case 'greater_equal':
                    return parseFloat(fieldStr) >= parseFloat(conditionStr);
                case 'less_equal':
                    return parseFloat(fieldStr) <= parseFloat(conditionStr);
                
                // æ—¥æœŸæ“ä½œç¬¦
                case 'before':
                    return new Date(fieldStr) < new Date(conditionStr);
                case 'after':
                    return new Date(fieldStr) > new Date(conditionStr);
                case 'today':
                    const today = new Date().toDateString();
                    return new Date(fieldStr).toDateString() === today;
                case 'this_week':
                    const now = new Date();
                    const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                    return new Date(fieldStr) >= weekStart;
                case 'this_month':
                    const thisMonth = new Date().getMonth();
                    return new Date(fieldStr).getMonth() === thisMonth;
                
                // é€‰æ‹©æ“ä½œç¬¦
                case 'contains_any':
                    const values = conditionStr.split(',').map(v => v.trim());
                    return values.some(v => fieldStr.includes(v));
                case 'not_contains_any':
                    const values2 = conditionStr.split(',').map(v => v.trim());
                    return !values2.some(v => fieldStr.includes(v));
                
                default:
                    return true;
            }
        }
        
        // åº”ç”¨å»é‡ç­›é€‰
        function applyDedupFilter(conditions) {
            // åˆ›å»ºå»é‡é”®
            const dedupKeys = new Map();
            const uniqueData = [];
            
            currentData.forEach(record => {
                const key = conditions.map(condition => 
                    `${condition.field}:${record[condition.field] || ''}`
                ).join('|');
                
                if (!dedupKeys.has(key)) {
                    dedupKeys.set(key, true);
                    uniqueData.push(record);
                }
            });
            
            // æ›´æ–°æœç´¢ç»“æœ
            updateSearchResults(uniqueData);
            alert(`å»é‡å®Œæˆï¼åŸå§‹è®°å½• ${currentData.length} æ¡ï¼Œå»é‡å ${uniqueData.length} æ¡ï¼Œç§»é™¤ ${currentData.length - uniqueData.length} æ¡é‡å¤è®°å½•`);
        }
        
        // æ›´æ–°æœç´¢ç»“æœ
        function updateSearchResults(data) {
            // è¿™é‡Œå¯ä»¥æ›´æ–°ç•Œé¢æ˜¾ç¤ºæœç´¢ç»“æœ
            console.log('æ›´æ–°æœç´¢ç»“æœ:', data.length, 'æ¡è®°å½•');
            // å¯ä»¥è°ƒç”¨ç°æœ‰çš„æœç´¢ç»“æœæ˜¾ç¤ºå‡½æ•°
        }
        
        // æ¸…ç©ºç­›é€‰
        function clearFilter() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç­›é€‰æ¡ä»¶å—ï¼Ÿ')) {
                clearAllConditions();
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('smartFilterModal');
            if (event.target === modal) {
                closeSmartFilterModal();
            }
        };
    </script>
</body>
</html>
</html>