<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能项目识别与统计分析系统</title>
    <!-- Chart.js 图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.9em;
            }
        }
        
        .main-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .main-panel {
                padding: 20px;
                border-radius: 10px;
                margin: 10px 0;
            }
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
                gap: 15px;
            }
        }
        
        .input-group input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .input-group input {
                min-width: 100%;
                font-size: 16px; /* 防止iOS自动缩放 */
            }
        }
        
        .input-group button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .analysis-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        
        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        
        @media (max-width: 768px) {
            .result-table {
                font-size: 14px;
            }
            
            .result-table th,
            .result-table td {
                padding: 8px 4px;
                min-width: 80px;
            }
        }
        
        .result-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .result-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: top;
        }
        
        .result-table tr:hover {
            background: #f8f9fa;
        }
        
        /* 设置各列宽度 */
        .result-table th:nth-child(1), .result-table td:nth-child(1) { width: 8%; }   /* 序号 */
        .result-table th:nth-child(2), .result-table td:nth-child(2) { width: 12%; }  /* 收样时间 */
        .result-table th:nth-child(3), .result-table td:nth-child(3) { width: 12%; }  /* 样品型号 */
        .result-table th:nth-child(4), .result-table td:nth-child(4) { width: 12%; }  /* 小编码 */
        .result-table th:nth-child(5), .result-table td:nth-child(5) { width: 15%; }  /* 供应商 */
        .result-table th:nth-child(6), .result-table td:nth-child(6) { width: 12%; }  /* 样品分类 */
        .result-table th:nth-child(7), .result-table td:nth-child(7) { width: 12%; }  /* 样品性质 */
        .result-table th:nth-child(8), .result-table td:nth-child(8) { width: 8%; }   /* 送样次数 */
        .result-table th:nth-child(9), .result-table td:nth-child(9) { width: 8%; }   /* 版本号 */
        .result-table th:nth-child(10), .result-table td:nth-child(10) { width: 8%; } /* 匹配度 */
        
        /* 表格容器样式 */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                padding: 15px;
                margin-top: 20px;
            }
        }
        
        #timeline {
            height: 300px;
        }
        
        .algorithm-info {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .algorithm-info h4 {
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        /* 深度统计分析样式 */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-wrap: nowrap;
                overflow-x: scroll;
                padding-bottom: 10px;
            }
        }
        
        .tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .tab {
                padding: 10px 16px;
                font-size: 14px;
                margin-right: 3px;
            }
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .analysis-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .analysis-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .metric-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .metric-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            height: 400px;
            position: relative;
            border: 1px solid #e0e0e0;
        }
        
        .chart-container canvas {
            width: 100% !important;
            height: 350px !important;
            max-height: 350px;
        }
        
        .chart-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .pattern-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .pattern-tag {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        /* 添加数据导入区域样式 */
        .data-import {
            background: #f0f4f8;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .data-import input[type="file"] {
            display: none;
        }
        
        .data-import label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .data-import label:hover {
            background: #5a67d8;
        }
        
        .upload-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .upload-status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .upload-status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .upload-status.loading {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ff9800;
        }
        
        .data-info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .data-info div {
            margin: 2px 0;
        }
        
        /* 下拉容器样式 */
        .dropdown-container {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .dropdown-container input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .dropdown-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .dropdown-container datalist {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .dropdown-container option {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .dropdown-container option:hover {
            background: #f8f9fa;
        }
        
        /* 清除按钮样式 */
        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .clear-btn:hover {
            background: #ff5252;
            transform: translateY(-50%) scale(1.1);
        }
        
        .clear-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        /* 时间维度选择器样式 */
        .time-dimension-selector {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .dimension-buttons {
            display: flex;
            gap: 8px;
        }
        
        .dimension-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 50px;
        }
        
        .dimension-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f0f4ff;
        }
        
        .dimension-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .dimension-btn.active:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
        }
        
        /* 分页控制样式 */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        @media (max-width: 768px) {
            .pagination-controls {
                flex-direction: column;
                gap: 15px;
                padding: 10px;
            }
        }
        
        .pagination-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .page-size-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }
        
        .page-size-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        @media (max-width: 768px) {
            .page-btn {
                padding: 12px 16px;
                min-width: 60px;
                font-size: 16px;
                min-height: 44px; /* 触摸友好的最小高度 */
            }
        }
        
        .page-btn.icon-btn {
            padding: 8px 12px;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-btn .icon {
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
        }
        
        .page-btn:hover:not(:disabled) {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .page-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
            border-color: #e0e0e0;
        }
        
        .page-info {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            margin: 0 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // 防止外部脚本错误影响系统
        window.addEventListener('error', function(e) {
            if (e.filename && (e.filename.includes('share-modal.js') || e.filename.includes('cdn'))) {
                console.warn('外部脚本错误已忽略:', e.message);
                e.preventDefault();
                return false;
            }
        });
        
        // 屏蔽特定的外部脚本错误
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.toString().includes('share-modal')) {
                console.warn('外部脚本Promise错误已忽略');
                e.preventDefault();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 智能项目识别与统计分析系统</h1>
            <p>处理复杂多样的型号和编码组合，精准识别项目唯一性</p>
        </div>
        
        <div class="main-panel">
            <!-- 数据导入区 -->
            <div class="section">
                <h2 class="section-title">数据源</h2>
                <div class="data-import">
                    <label for="fileInput">
                        📁 导入Excel数据
                    </label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                    <div id="uploadStatus" class="upload-status">
                        当前使用模拟数据演示 | 支持 Excel(.xlsx, .xls)、CSV(.csv) 格式 | 可直接使用测试搜索功能
                    </div>
                    <div id="dataInfo" class="data-info">
                        <!-- 数据信息将在这里显示 -->
                    </div>
                </div>
            </div>
            
            <!-- 搜索分析区 -->
            <div class="section">
                <h2 class="section-title">项目智能搜索</h2>
                <div class="input-group">
                    <div class="dropdown-container">
                        <input type="text" id="modelSearch" placeholder="输入样品型号（如：AK500）">
                        <button type="button" class="clear-btn" id="clearModel" style="display: none;" title="清除">×</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="codeSearch" placeholder="输入小编码（如：55455）">
                        <button type="button" class="clear-btn" id="clearCode" style="display: none;" title="清除">×</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="categorySearch" placeholder="选择或输入样品分类" list="categoryList" autocomplete="off">
                        <datalist id="categoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearCategory" style="display: none;" title="清除">×</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="propertySearch" placeholder="选择或输入样品性质" list="propertyList" autocomplete="off">
                        <datalist id="propertyList"></datalist>
                        <button type="button" class="clear-btn" id="clearProperty" style="display: none;" title="清除">×</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="subCategorySearch" placeholder="选择或输入品类细分" list="subCategoryList" autocomplete="off">
                        <datalist id="subCategoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearSubCategory" style="display: none;" title="清除">×</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="testerSearch" placeholder="选择或输入测试人" list="testerList" autocomplete="off">
                        <datalist id="testerList"></datalist>
                        <button type="button" class="clear-btn" id="clearTester" style="display: none;" title="清除">×</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="electronicEngineerSearch" placeholder="选择或输入电子工程师" list="electronicEngineerList" autocomplete="off">
                        <datalist id="electronicEngineerList"></datalist>
                        <button type="button" class="clear-btn" id="clearElectronicEngineer" style="display: none;" title="清除">×</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="projectEngineerSearch" placeholder="选择或输入项目工程师" list="projectEngineerList" autocomplete="off">
                        <datalist id="projectEngineerList"></datalist>
                        <button type="button" class="clear-btn" id="clearProjectEngineer" style="display: none;" title="清除">×</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="dqeSearch" placeholder="选择或输入DQE" list="dqeList" autocomplete="off">
                        <datalist id="dqeList"></datalist>
                        <button type="button" class="clear-btn" id="clearDqe" style="display: none;" title="清除">×</button>
                    </div>
                    <div class="dropdown-container">
                        <input type="text" id="dqeCategorySearch" placeholder="选择或输入DQE品类细分" list="dqeCategoryList" autocomplete="off">
                        <datalist id="dqeCategoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearDqeCategory" style="display: none;" title="清除">×</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <div class="dropdown-container">
                        <input type="text" id="newCategorySearch" placeholder="选择或输入新分类" list="newCategoryList" autocomplete="off">
                        <datalist id="newCategoryList"></datalist>
                        <button type="button" class="clear-btn" id="clearNewCategory" style="display: none;" title="清除">×</button>
                    </div>
                    <div class="dropdown-container">
                        <!-- 预留位置，可以添加更多筛选项 -->
                    </div>
                </div>
                
                <!-- 日期范围筛选 -->
                <div class="input-group" style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <div class="date-range-container">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">📅 日期范围筛选</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 0.9em; color: #666;">从</label>
                                <input type="date" id="startDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 0.9em; color: #666;">至</label>
                                <input type="date" id="endDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <button onclick="setDateRange('all')" style="padding: 6px 12px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; cursor: pointer;">全部</button>
                            <button onclick="setDateRange('thisMonth')" style="padding: 6px 12px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; font-size: 12px; cursor: pointer;">本月</button>
                            <button onclick="setDateRange('lastMonth')" style="padding: 6px 12px; background: #f3e5f5; border: 1px solid #9c27b0; border-radius: 4px; font-size: 12px; cursor: pointer;">上月</button>
                        </div>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <button onclick="searchProject()" id="searchButton">智能识别</button>
                    <button onclick="clearSearch()" style="background: #6c757d;">清空</button>
                    <button onclick="testSearch()" style="background: #28a745;">测试搜索</button>
                    <button onclick="openSmartFilterConfig()" style="background: #ff9800;">🔧 智能筛选配置</button>
                    <button onclick="openDedupConfig()" style="background: #9c27b0;">🔄 去重配置</button>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: #666;">
                        <input type="checkbox" id="removeDuplicates" checked>
                        自动去重（移除完全相同的记录）
                    </label>
                </div>
                
                <div class="algorithm-info">
                    <h4>🤖 智能识别算法</h4>
                    <p>系统能识别以下复杂模式：</p>
                    <div class="pattern-examples">
                        <span class="pattern-tag">AAA/BBB/CCC</span>
                        <span class="pattern-tag">AAA+BBB+CCC</span>
                        <span class="pattern-tag">AAA,BBB,CCC</span>
                        <span class="pattern-tag">AAA BBB CCC</span>
                        <span class="pattern-tag">AAA&BBB&CCC</span>
                        <span class="pattern-tag">AAA、BBB、CCC</span>
                        <span class="pattern-tag">AAA(BBB)</span>
                        <span class="pattern-tag">组合模式</span>
                    </div>
                </div>
                
                <div class="algorithm-info" style="background: #f0f8ff; border-left-color: #4CAF50;">
                    <h4>🔄 级联筛选系统</h4>
                    <p>选择任意字段后，其他字段的选项会自动过滤，实现多级联动筛选：</p>
                    <div id="filterStatus" style="font-size: 0.9em; color: #666; margin-top: 8px;">
                        <span id="activeFilters">当前无筛选条件</span>
                        <span id="availableOptions" style="margin-left: 20px;"></span>
                    </div>
                </div>
                
                <div class="algorithm-info" style="background: #fff3e0; border-left-color: #ff9800;">
                    <h4>📊 统计指标说明</h4>
                    <div style="font-size: 0.9em; line-height: 1.6;">
                        <div><strong>匹配记录数：</strong>符合筛选条件的记录总数（包含重复记录）</div>
                        <div><strong>送样次数：</strong>去重后的实际送样批次数量（排除重复记录）</div>
                        <div><strong>平均周期：</strong>同一项目相邻送样的平均时间间隔（天）</div>
                        <div><strong>送样趋势：</strong>基于最近3个月数据的变化趋势（上升/稳定/下降）</div>
                    </div>
                </div>
            </div>
            
            <!-- 深度统计分析标签页 -->
            <div class="section">
                <h2 class="section-title">深度统计分析</h2>
                <div class="tabs" style="margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button class="tab active" onclick="switchAnalysisTab('overview')">📊 概览</button>
                    <button class="tab" onclick="switchAnalysisTab('resource')">📈 资源投入分析</button>
                    <button class="tab" onclick="switchAnalysisTab('cycle')">⏱️ 周期分析</button>
                    <button class="tab" onclick="switchAnalysisTab('sample')">🧪 样品分析</button>
                    <button class="tab" onclick="switchAnalysisTab('personnel')">👥 人员技能分析</button>
                    <button class="tab" onclick="switchAnalysisTab('waterlevel')">📊 水位线分析</button>
                    <button class="tab" onclick="switchAnalysisTab('inventory')">📦 库存管理</button>
                    <button class="tab" onclick="switchAnalysisTab('advanced')">🔬 高级统计</button>
                </div>
                
                <!-- 概览标签页 -->
                <div id="overview" class="tab-content active">
                    <div class="analysis-grid">
                        <div class="stat-card">
                            <h3>📊 匹配记录数</h3>
                            <div class="stat-value" id="matchCount">0</div>
                            <small>包含重复的原始记录</small>
                        </div>
                        <div class="stat-card">
                            <h3>📅 送样次数</h3>
                            <div class="stat-value" id="sampleCount">0</div>
                            <small>去重后的实际批次</small>
                        </div>
                        <div class="stat-card">
                            <h3>⏱️ 平均周期</h3>
                            <div class="stat-value" id="avgCycle">0天</div>
                            <small>平均送样间隔</small>
                        </div>
                        <div class="stat-card">
                            <h3>📈 送样趋势</h3>
                            <div class="stat-value" id="trend">--</div>
                            <small>近期送样频率</small>
                        </div>
                    </div>
                </div>
                
                <!-- 资源投入分析标签页 -->
                <div id="resource" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">📈 资源投入分析</h3>
                        <div class="metric-grid" id="resourceMetrics">
                            <!-- 资源投入指标将在这里显示 -->
                        </div>
                        <div class="chart-container">
                            <canvas id="resourceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 周期分析标签页 -->
                <div id="cycle" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">⏱️ 周期分析</h3>
                        <div class="metric-grid" id="cycleMetrics">
                            <!-- 周期分析指标将在这里显示 -->
                        </div>
                        <div class="chart-container">
                            <canvas id="cycleChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 样品分析标签页 -->
                <div id="sample" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">🧪 样品分析</h3>
                        <div class="metric-grid" id="sampleMetrics">
                            <!-- 样品分析指标将在这里显示 -->
                        </div>
                        <div class="chart-container">
                            <canvas id="sampleChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 人员技能分析标签页 -->
                <div id="personnel" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">👥 人员技能分析</h3>
                        <div class="metric-grid" id="personnelMetrics">
                            <!-- 人员技能指标将在这里显示 -->
                        </div>
                        <div class="chart-container">
                            <canvas id="personnelChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 水位线分析标签页 -->
                <div id="waterlevel" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">📊 水位线分析</h3>
                        <div class="metric-grid" id="waterlevelMetrics">
                            <!-- 水位线指标将在这里显示 -->
                        </div>
                        <div class="chart-container">
                            <canvas id="waterlevelChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 库存管理标签页 -->
                <div id="inventory" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">📦 库存管理分析</h3>
                        <div class="metric-grid" id="inventoryMetrics">
                            <!-- 库存管理指标将在这里显示 -->
                        </div>
                        <div class="chart-container">
                            <canvas id="inventoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 高级统计标签页 -->
                <div id="advanced" class="tab-content">
                    <div class="analysis-section">
                        <h3 class="analysis-title">🔬 高级统计方法</h3>
                        <div class="metric-grid" id="advancedMetrics">
                            <!-- 高级统计指标将在这里显示 -->
                        </div>
                        <div class="chart-container">
                            <canvas id="advancedChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 详细记录表 -->
            <div class="section">
                <h2 class="section-title">匹配记录详情</h2>
                
                <!-- 分页控制区 -->
                <div class="pagination-controls">
                    <div class="pagination-info">
                        <span>每页显示：</span>
                        <select id="pageSizeSelect" class="page-size-select">
                            <option value="10" selected>10条</option>
                            <option value="20">20条</option>
                            <option value="50">50条</option>
                            <option value="100">100条</option>
                        </select>
                    </div>
                    <div class="pagination-buttons">
                        <button type="button" id="firstPageBtn" class="page-btn icon-btn" disabled title="第一页">
                            <span class="icon">⏮</span>
                        </button>
                        <button type="button" id="prevPageBtn" class="page-btn icon-btn" disabled title="上一页">
                            <span class="icon">◀</span>
                        </button>
                        <span class="page-info" id="pageInfo">第 1 页，共 1 页</span>
                        <button type="button" id="nextPageBtn" class="page-btn icon-btn" disabled title="下一页">
                            <span class="icon">▶</span>
                        </button>
                        <button type="button" id="lastPageBtn" class="page-btn icon-btn" disabled title="最后一页">
                            <span class="icon">⏭</span>
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                <table class="result-table" id="resultTable">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>收样时间</th>
                            <th>样品型号</th>
                            <th>小编码</th>
                            <th>供应商</th>
                            <th>样品分类</th>
                            <th>样品性质</th>
                            <th>送样次数</th>
                            <th>版本号</th>
                            <th>匹配度</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #999;">
                                请输入搜索条件
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div>
            </div>
            
            <!-- 时间分布图表 -->
            <div class="section">
                <h2 class="section-title">送样时间分布</h2>
                
                <!-- 时间维度选择器 -->
                <div class="time-dimension-selector">
                    <label style="margin-right: 15px; color: #666; font-weight: 500;">时间维度：</label>
                    <div class="dimension-buttons">
                        <button type="button" class="dimension-btn active" data-dimension="month">月</button>
                        <button type="button" class="dimension-btn" data-dimension="week">周</button>
                        <button type="button" class="dimension-btn" data-dimension="day">日</button>
                        <button type="button" class="dimension-btn" data-dimension="year">年</button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="timeline"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // =====================================================
        // 核心算法：智能匹配引擎
        // =====================================================
        class SmartMatcher {
            constructor() {
                // 定义所有可能的分隔符
                this.separators = ['+', '/', '&', ',', '、', ' ', '-', '|', ';', '_'];
                // 创建正则表达式用于分割 - 使用更简单的方法
                this.separatorRegex = new RegExp(`[${this.separators.map(s => '\\' + s).join('')}]+`);
                
                // 初始化项目关联映射（用于学习型号和编码的关联关系）
                this.projectMapping = new Map();
            }
            
            // 解析复杂字符串，提取所有可能的项目标识
            parseComplexString(str) {
                if (!str || str === '未知' || str === 'undefined' || str === 'null') {
                    return [];
                }
                
                // 移除括号及其内容（如：AAA(升级版) → AAA）
                str = str.replace(/[（(][^）)]*[）)]/g, '').trim();
                
                // 如果没有分隔符，直接返回原字符串
                if (!this.separatorRegex.test(str)) {
                    return [str.toUpperCase()];
                }
                
                // 按分隔符分割
                const parts = str.split(this.separatorRegex)
                    .filter(part => part && part.trim())
                    .map(part => part.trim().toUpperCase());
                
                // 去重
                return [...new Set(parts)];
            }
            
            // 智能匹配算法 - 简化版本
            match(searchModel, searchCode, recordModel, recordCode) {
                let confidence = 0;
                let matched = false;
                
                const modelParts = this.parseComplexString(recordModel);
                const codeParts = this.parseComplexString(recordCode);
                
                if (searchModel) {
                    const searchModelClean = searchModel.trim().toUpperCase();
                    if (modelParts.some(part => 
                        part.includes(searchModelClean) || searchModelClean.includes(part))) {
                        matched = true;
                        confidence += 50;
                    }
                }
                
                if (searchCode) {
                    const searchCodeClean = searchCode.trim().toUpperCase();
                    if (codeParts.some(part => 
                        part.includes(searchCodeClean) || searchCodeClean.includes(part))) {
                        matched = matched || true;
                        confidence += 50;
                    }
                }
                
                if (searchModel && searchCode && matched) {
                    this.learnAssociation(searchModel, searchCode);
                }
                
                return { matched, confidence };
            }
            
            // 批量匹配方法
            batchMatch(records, searchModel, searchCode) {
                return records.filter(record => {
                    const result = this.match(
                        searchModel, 
                        searchCode,
                        record.样品型号 || record.model,
                        record.小编码 || record.code
                    );
                    if (result.matched) {
                        record.confidence = result.confidence;
                        return true;
                    }
                    return false;
                }).sort((a, b) => b.confidence - a.confidence);
            }
            
            // 学习型号和编码的关联关系
            learnAssociation(model, code) {
                const modelKey = model.toUpperCase();
                const codeKey = code.toUpperCase();
                
                // 存储型号到编码的映射
                if (!this.projectMapping.has(modelKey)) {
                    this.projectMapping.set(modelKey, new Set());
                }
                this.projectMapping.get(modelKey).add(codeKey);
                
                // 存储编码到型号的反向映射
                const reverseKey = `CODE_${codeKey}`;
                if (!this.projectMapping.has(reverseKey)) {
                    this.projectMapping.set(reverseKey, new Set());
                }
                this.projectMapping.get(reverseKey).add(modelKey);
            }
            
            // 获取与型号关联的编码
            getAssociatedCodes(model) {
                const modelKey = model.toUpperCase();
                return this.projectMapping.has(modelKey) 
                    ? Array.from(this.projectMapping.get(modelKey))
                    : [];
            }
            
            // 获取与编码关联的型号
            getAssociatedModels(code) {
                const reverseKey = `CODE_${code.toUpperCase()}`;
                return this.projectMapping.has(reverseKey) 
                    ? Array.from(this.projectMapping.get(reverseKey))
                    : [];
            }
        }
        
        // =====================================================
        // 数据生成和处理
        // =====================================================
        
        
        // =====================================================
        // 统计分析功能
        // =====================================================
        
        // 计算统计信息
        function calculateStatistics(records) {
            const stats = {
                totalRecords: records.length,  // 匹配记录数 = 原始匹配的记录总数（不去重）
                sampleCount: 0,                // 送样次数 = 去重后的实际送样批次数量
                avgCycle: 0,
                trend: '',
                suppliers: {},
                versions: {},
                sampleTypes: {}
            };
            
            if (records.length === 0) {
                return stats;
            }
            
            // 1. 计算送样次数（去重后的批次数量）
            stats.sampleCount = calculateSampleCount(records);
            
            // 2. 计算平均送样周期
            stats.avgCycle = calculateAverageCycle(records);
            
            // 3. 分析送样趋势
            stats.trend = analyzeSampleTrend(records);
            
            // 4. 统计供应商分布
            records.forEach(r => {
                stats.suppliers[r.供应商] = (stats.suppliers[r.供应商] || 0) + 1;
                stats.versions[r.版本号] = (stats.versions[r.版本号] || 0) + 1;
                stats.sampleTypes[r.样品性质] = (stats.sampleTypes[r.样品性质] || 0) + 1;
            });
            
            return stats;
        }
        
        // 计算送样次数
        function calculateSampleCount(records) {
            // 送样次数 = 去重后的实际送样批次数量
            console.log('calculateSampleCount 输入记录数:', records.length);
            const uniqueRecords = removeDuplicateRecords(records);
            console.log('calculateSampleCount 去重后记录数:', uniqueRecords.length);
            return uniqueRecords.length;
        }
        
        // 按项目分组记录
        function groupRecordsByProject(records) {
            const groups = {};
            records.forEach(record => {
                const projectKey = `${record.样品型号 || '未知'}_${record.小编码 || '未知'}`;
                if (!groups[projectKey]) {
                    groups[projectKey] = [];
                }
                groups[projectKey].push(record);
            });
            return groups;
        }
        
        // 计算平均送样周期
        function calculateAverageCycle(records) {
            // 直接基于筛选出来的记录计算平均周期
            if (records.length < 2) return 0;
            
            // 按收样时间排序
            const sortedRecords = records.sort((a, b) => new Date(a.收样时间) - new Date(b.收样时间));
            
            const cycles = [];
            
            // 计算相邻送样的间隔时间
            for (let i = 1; i < sortedRecords.length; i++) {
                const date1 = new Date(sortedRecords[i-1].收样时间);
                const date2 = new Date(sortedRecords[i].收样时间);
                const daysDiff = (date2 - date1) / (1000 * 60 * 60 * 24);
                if (daysDiff > 0) {
                    cycles.push(daysDiff);
                }
            }
            
            if (cycles.length === 0) return 0;
            return Math.round(cycles.reduce((sum, cycle) => sum + cycle, 0) / cycles.length);
        }
        
        // 分析送样趋势
        function analyzeSampleTrend(records) {
            if (records.length < 3) return '数据不足';
            
            // 按月份统计送样数量
            const monthlyData = {};
            records.forEach(record => {
                const date = new Date(record.收样时间);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
            });
            
            const months = Object.keys(monthlyData).sort();
            if (months.length < 2) return '数据不足';
            
            // 计算最近3个月的趋势
            const recentMonths = months.slice(-3);
            const recentCounts = recentMonths.map(month => monthlyData[month]);
            
            if (recentCounts.length < 2) return '数据不足';
            
            // 简单趋势分析
            const firstHalf = recentCounts.slice(0, Math.ceil(recentCounts.length / 2));
            const secondHalf = recentCounts.slice(Math.floor(recentCounts.length / 2));
            
            const firstAvg = firstHalf.reduce((sum, count) => sum + count, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((sum, count) => sum + count, 0) / secondHalf.length;
            
            const changeRate = (secondAvg - firstAvg) / firstAvg;
            
            if (changeRate > 0.2) {
                return '↑ 上升';
            } else if (changeRate < -0.2) {
                return '↓ 下降';
            } else {
                return '→ 稳定';
            }
        }
        
        // =====================================================
        // UI 更新功能
        // =====================================================
        
        // 更新统计卡片
        function updateStatistics(records) {
            console.log('updateStatistics 接收到的记录数:', records.length);
            const stats = calculateStatistics(records);
            console.log('计算出的统计结果:', stats);
            
            document.getElementById('matchCount').textContent = stats.totalRecords;
            document.getElementById('sampleCount').textContent = stats.sampleCount;
            document.getElementById('avgCycle').textContent = stats.avgCycle ? `${stats.avgCycle}天` : '--';
            
            const trendElement = document.getElementById('trend');
            trendElement.textContent = stats.trend || '--';
            
            // 根据趋势设置颜色
            if (stats.trend.includes('上升')) {
                trendElement.style.color = '#4CAF50';
            } else if (stats.trend.includes('稳定')) {
                trendElement.style.color = '#2196F3';
            } else if (stats.trend.includes('下降')) {
                trendElement.style.color = '#FF9800';
            } else {
                trendElement.style.color = '#666';
            }
        }
        
        // 更新表格
        function updateTable(records) {
            const tbody = document.getElementById('tableBody');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">未找到匹配记录</td></tr>';
                return;
            }
            
            // 按日期排序
            records.sort((a, b) => new Date(b.收样时间) - new Date(a.收样时间));
            
            // 只显示当前页的数据，不显示所有记录
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${record.序号 || ''}</td>
                    <td>${record.收样时间 || ''}</td>
                    <td>${record.样品型号 || ''}</td>
                    <td>${record.小编码 || ''}</td>
                    <td>${record.供应商 || ''}</td>
                    <td>${record.样品分类 || ''}</td>
                    <td>${record.样品性质 || ''}</td>
                    <td>${record.送样次数 || ''}</td>
                    <td>${record.版本号 || ''}</td>
                    <td><span class="pattern-tag">${record.confidence ? record.confidence + '%' : '匹配'}</span></td>
                </tr>
            `).join('');
        }
        
        // 更新表格（带分页）
        function updateTableWithPagination(records) {
            // 设置分页数据
            setPaginationData(records);
            
            // 渲染当前页
            renderCurrentPage();
        }
        
        // 更新图表
        function updateChart(records) {
            // 保存当前记录，用于时间维度切换时重新绘制
            window.currentRecords = records;
            
            // 获取当前选择的时间维度
            const activeDimension = document.querySelector('.dimension-btn.active');
            const dimension = activeDimension ? activeDimension.dataset.dimension : 'month';
            
            // 根据时间维度统计数据
            const timeData = {};
            const dimensionConfig = getDimensionConfig(dimension);
            
            records.forEach(record => {
                const date = new Date(record.收样时间);
                const timeKey = formatTimeKey(date, dimension);
                timeData[timeKey] = (timeData[timeKey] || 0) + 1;
            });
            
            // 排序时间键
            const sortedTimeKeys = Object.keys(timeData).sort();
            
            // 准备图表数据
            const chartData = {
                labels: sortedTimeKeys.map(key => formatTimeLabel(key, dimension)),
                datasets: [{
                    label: '送样数量',
                    data: sortedTimeKeys.map(key => timeData[key]),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };
            
            // 销毁旧图表
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('timeline').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '月度送样趋势'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // =====================================================
        // 主要功能函数
        // =====================================================
        
        // 全局变量
        let mockData = generateMockData();
        let matcher = new SmartMatcher();
        let chartInstance = null;
        let currentData = mockData; // 当前使用的数据，初始为模拟数据，等待Excel上传
        
        // 搜索项目
        function searchProject() {
            console.log('🔍 开始搜索项目...');
            const modelSearch = document.getElementById('modelSearch').value;
            const codeSearch = document.getElementById('codeSearch').value;
            const categorySearch = document.getElementById('categorySearch').value;
            const propertySearch = document.getElementById('propertySearch').value;
            const subCategorySearch = document.getElementById('subCategorySearch').value;
            const testerSearch = document.getElementById('testerSearch').value;
            const electronicEngineerSearch = document.getElementById('electronicEngineerSearch').value;
            const projectEngineerSearch = document.getElementById('projectEngineerSearch').value;
            const dqeSearch = document.getElementById('dqeSearch').value;
            const dqeCategorySearch = document.getElementById('dqeCategorySearch').value;
            const newCategorySearch = document.getElementById('newCategorySearch').value;
            
            const searchConditions = {
                modelSearch, codeSearch, categorySearch, propertySearch,
                subCategorySearch, testerSearch, electronicEngineerSearch,
                projectEngineerSearch, dqeSearch, dqeCategorySearch, newCategorySearch
            };
            
            console.log('搜索条件:', searchConditions);
            console.log('当前数据量:', currentData.length);
            console.log('数据来源:', currentData === mockData ? '模拟数据' : '真实数据');
            
            // 检查是否有任何搜索条件（包括日期范围）
            const hasSearchCondition = Object.values(searchConditions).some(value => value && value.trim() !== '');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const hasDateRange = startDate || endDate;
            
            if (!hasSearchCondition && !hasDateRange) {
                alert('请输入至少一个搜索条件');
                return;
            }
            
            if (currentData.length === 0) {
                alert('请先上传Excel数据或使用模拟数据进行测试');
                return;
            }
            
            let matchedRecords = [];
            
            // 如果指定了型号或编码，先进行型号和编码匹配
            if (modelSearch || codeSearch) {
                matchedRecords = matcher.batchMatch(currentData, modelSearch, codeSearch);
            } else {
                // 如果没有型号和编码搜索，从所有数据开始
                matchedRecords = [...currentData];
            }
            
            // 如果指定了样品分类，进行筛选
            if (categorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.样品分类 && record.样品分类.includes(categorySearch)
                );
            }
            
            // 如果指定了样品性质，进行筛选
            if (propertySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.样品性质 && record.样品性质.includes(propertySearch)
                );
            }
            
            // 如果指定了品类细分，进行筛选
            if (subCategorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.品类细分 && record.品类细分.includes(subCategorySearch)
                );
            }
            
            // 如果指定了测试人，进行筛选
            if (testerSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.测试人 && record.测试人.includes(testerSearch)
                );
            }
            
            // 如果指定了电子工程师，进行筛选
            if (electronicEngineerSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.电子工程师 && record.电子工程师.includes(electronicEngineerSearch)
                );
            }
            
            // 如果指定了项目工程师，进行筛选
            if (projectEngineerSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.项目工程师 && record.项目工程师.includes(projectEngineerSearch)
                );
            }
            
            // 如果指定了DQE，进行筛选
            if (dqeSearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.DQE && record.DQE.includes(dqeSearch)
                );
            }
            
            // 如果指定了DQE品类细分，进行筛选
            if (dqeCategorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.DQE品类细分 && record.DQE品类细分.includes(dqeCategorySearch)
                );
            }
            
            // 如果指定了新分类，进行筛选
            if (newCategorySearch) {
                matchedRecords = matchedRecords.filter(record => 
                    record.新分类 && record.新分类.includes(newCategorySearch)
                );
            }
            
            // 应用日期范围筛选
            console.log('应用日期范围筛选前记录数:', matchedRecords.length);
            matchedRecords = applyDateRangeFilter(matchedRecords);
            console.log('应用日期范围筛选后记录数:', matchedRecords.length);
            
            // 保存原始匹配结果（用于统计）
            const originalMatchedRecords = [...matchedRecords];
            
            // 检查是否需要去重
            const removeDuplicates = document.getElementById('removeDuplicates').checked;
            if (removeDuplicates) {
                matchedRecords = removeDuplicateRecords(matchedRecords);
            }
            
            console.log('原始匹配结果数量:', originalMatchedRecords.length);
            console.log('去重后匹配结果数量:', matchedRecords.length);
            console.log('去重选框状态:', document.getElementById('removeDuplicates').checked);
            if (matchedRecords.length > 0) {
                console.log('前3个匹配结果:', matchedRecords.slice(0, 3));
            }
            
            // 更新UI - 统计使用原始数据，表格和图表使用去重后数据
            updateStatistics(originalMatchedRecords);
            updateTableWithPagination(matchedRecords);
            updateChart(matchedRecords);
            
            // 保存当前记录供深度分析使用
            window.currentRecords = matchedRecords;
            
            // 触发默认的深度分析（概览标签页）
            loadAnalysisData('overview');
        }
        
        // 清空搜索
        function clearSearch() {
            // 清空所有搜索输入框
            const searchFields = [
                'modelSearch', 'codeSearch', 'categorySearch', 'propertySearch',
                'subCategorySearch', 'testerSearch', 'electronicEngineerSearch',
                'projectEngineerSearch', 'dqeSearch', 'dqeCategorySearch', 'newCategorySearch'
            ];
            
            searchFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                const clearBtn = document.getElementById('clear' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
                
                if (element) {
                    element.value = '';
                }
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
            });
            
            // 清空日期范围
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
            
            // 重置级联筛选系统
            if (cascadingFilter) {
                cascadingFilter.resetAllOptions();
            }
            
            // 清空表格和统计
            document.getElementById('tableBody').innerHTML = 
                '<tr><td colspan="10" style="text-align: center; color: #999;">请输入搜索条件</td></tr>';
            document.getElementById('matchCount').textContent = '0';
            document.getElementById('sampleCount').textContent = '0';
            
            // 重置分页状态
            paginationState = {
                currentPage: 1,
                pageSize: 10,
                totalRecords: 0,
                totalPages: 0,
                allRecords: []
            };
            updatePagination();
            document.getElementById('avgCycle').textContent = '0天';
            document.getElementById('trend').textContent = '--';
            
            if (chartInstance) {
                chartInstance.destroy();
            }
        }
        
        // 处理文件上传
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查XLSX库是否已加载
            if (typeof XLSX === 'undefined') {
                alert('❌ Excel处理库未加载，请刷新页面重试');
                console.error('XLSX库未加载');
                return;
            }
            
            // 更新上传状态
            const uploadStatus = document.getElementById('uploadStatus');
            const dataInfo = document.getElementById('dataInfo');
            
            uploadStatus.innerHTML = '⏳ 正在处理文件...';
            uploadStatus.className = 'upload-status loading';
            
            // 检查文件类型
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                uploadStatus.innerHTML = '❌ 不支持的文件格式，请选择 Excel 或 CSV 文件';
                uploadStatus.className = 'upload-status error';
                return;
            }
            
            // 读取文件
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (fileExtension === 'csv') {
                        // 处理CSV文件
                        data = parseCSV(e.target.result);
                    } else {
                        // 处理Excel文件
                        console.log('🔄 开始解析Excel文件...');
                        console.log('文件大小:', file.size, 'bytes');
                        
                        const workbook = XLSX.read(e.target.result, { 
                            type: 'binary',
                            cellDates: true,
                            cellNF: false,
                            cellText: false
                        });
                        
                        console.log('工作簿信息:', {
                            SheetNames: workbook.SheetNames,
                            Props: workbook.Props
                        });
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('Excel文件中没有找到工作表');
                        }
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        if (!worksheet) {
                            throw new Error(`无法访问工作表: ${firstSheetName}`);
                        }
                        
                        data = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: '',
                            blankrows: false
                        });
                        
                        // 转换header为对象格式
                        if (data.length > 0) {
                            const headers = data[0];
                            data = data.slice(1).map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index] || '';
                                });
                                return obj;
                            });
                        }
                        
                        console.log('✅ Excel解析完成，共', data.length, '行数据');
                        if (data.length > 0) {
                            console.log('表头字段:', Object.keys(data[0]));
                            console.log('首行数据示例:', data[0]);
                        }
                    }
                    
                    // 标准化数据
                    const normalizedData = normalizeExcelData(data);
                    
                    if (normalizedData.length === 0) {
                        uploadStatus.innerHTML = '❌ 文件中没有有效数据';
                        uploadStatus.className = 'upload-status error';
                        return;
                    }
                    
                    // 更新全局数据
                    currentData = normalizedData;
                    mockData = normalizedData;
                    window.currentData = normalizedData; // 确保window对象上也有数据
                    
                    console.log('✅ 数据已更新到currentData:', currentData.length, '条记录');
                    console.log('前3条更新后的数据:', currentData.slice(0, 3));
                    
                    // 数据加载完成后，初始化深度分析
                    loadAnalysisData('overview');
                    
                    // 更新状态显示
                    uploadStatus.innerHTML = `✅ 文件上传成功！已加载 ${normalizedData.length} 条记录`;
                    uploadStatus.className = 'upload-status success';
                    
                    // 显示数据信息
                    dataInfo.innerHTML = `
                        <div>📊 数据统计：</div>
                        <div>• 原始记录数：${data.length}</div>
                        <div>• 有效记录数：${normalizedData.length}</div>
                        <div>• 日期范围：${getDateRange(normalizedData)}</div>
                        <div>• 供应商数：${getUniqueSuppliers(normalizedData)}</div>
                        <div>• 型号数：${getUniqueModels(normalizedData)}</div>
                        <div>• 文件类型：${fileExtension.toUpperCase()}</div>
                        <div>• 文件大小：${(file.size / 1024).toFixed(1)} KB</div>
                    `;
                    
                    // 更新下拉选项
                    updateDropdownOptions(normalizedData);
                    
                    // 清空搜索并显示所有数据
                    clearSearch();
                    updateStatistics(normalizedData);
                    updateTableWithPagination(normalizedData);
                    updateChart(normalizedData);
                    
                    console.log('文件上传成功，数据已加载:', normalizedData.length, '条记录');
                    
                } catch (error) {
                    console.error('文件处理错误:', error);
                    
                    let errorMessage = '文件处理失败';
                    if (error.message.includes('XLSX')) {
                        errorMessage = 'Excel文件格式错误，请确保文件完整且未损坏';
                    } else if (error.message.includes('parse')) {
                        errorMessage = '数据解析失败，请检查文件格式';
                    } else {
                        errorMessage = `文件处理失败：${error.message}`;
                    }
                    
                    uploadStatus.innerHTML = `❌ ${errorMessage}`;
                    uploadStatus.className = 'upload-status error';
                    
                    // 提供详细的错误信息
                    dataInfo.innerHTML = `
                        <div style="color: #dc3545;">
                            <div><strong>错误详情：</strong></div>
                            <div>• ${error.message}</div>
                            <div>• 请确保文件格式正确（Excel .xlsx/.xls 或 CSV .csv）</div>
                            <div>• 检查文件是否包含有效的表头和数据行</div>
                            <div>• 如问题持续，请尝试将Excel文件另存为CSV格式</div>
                        </div>
                    `;
                }
            };
            
            if (fileExtension === 'csv') {
                // 检测CSV编码并读取
                const encodingReader = new FileReader();
                encodingReader.onload = function(e) {
                    const text = e.target.result;
                    // 检查是否包含中文字符来判断编码
                    if (text.includes('��') || text.includes('?')) {
                        // 可能是编码问题，尝试GBK
                        reader.readAsText(file, 'GBK');
                    } else {
                        // UTF-8正常
                        reader.onload(e);
                    }
                };
                encodingReader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }
        
        // 解析CSV文件 - 改进版本，处理复杂CSV格式
        function parseCSV(csvText) {
            console.log('🔄 开始解析CSV文件...');
            const lines = csvText.split('\n').filter(line => line.trim());
            
            if (lines.length === 0) {
                console.warn('CSV文件为空');
                return [];
            }
            
            // 简单CSV解析，支持引号包围的字段
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }
            
            const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, ''));
            const data = [];
            
            console.log('CSV表头:', headers);
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]).map(v => v.replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            console.log('✅ CSV解析完成，共', data.length, '行数据');
            return data;
        }
        
        // 标准化Excel数据
        function normalizeExcelData(data) {
            console.log('🔄 开始标准化Excel数据，原始数据量:', data.length);
            if (data.length > 0) {
                console.log('原始数据首行字段:', Object.keys(data[0]));
            }
            
            const fieldMapping = {
                '样品型号': ['样品型号', '型号', 'Model', 'Product Model', '产品型号'],
                '小编码': ['小编码', '编码', '编号', 'Code', 'Product Code', '产品编码'],
                '收样时间': ['收样时间', '送样时间', '日期', 'Date', 'Sample Date', '收样日期'],
                '供应商': ['供应商', '厂商', 'Supplier', 'Vendor', '供货商'],
                '送样次数': ['送样次数', '次数', 'Times', 'Sample Times', '批次'],
                '版本号': ['版本号', '版本', 'Version', 'Ver'],
                '样品性质': ['样品性质', '性质', 'Type', 'Sample Type', '样品类型'],
                '样品分类': ['样品分类', '分类', 'Category', 'Class'],
                '品类细分': ['品类细分', 'SubCategory', 'Sub Category', '细分'],
                '测试人': ['测试人', 'Tester', 'Test Person', '测试人员'],
                '电子工程师': ['电子工程师', 'Electronic Engineer', 'EE'],
                '项目工程师': ['项目工程师', 'Project Engineer', 'PE'],
                'DQE': ['DQE', 'Design Quality Engineer', '设计质量工程师'],
                'DQE品类细分': ['DQE品类细分', 'DQE SubCategory', 'DQE Sub Category'],
                '新分类': ['新分类', 'New Category', 'New Class', '新品类'],
                '测试编号': ['测试编号', 'Test Number', '编号', 'Number'],
                '判定结果': ['判定结果', '结果', 'Result', 'Test Result'],
                '测试时长': ['测试时长', '时长', 'Duration', 'Test Duration'],
                '问题总数': ['问题总数', '问题数', 'Issues', 'Issue Count'],
                '送样周期': ['送样周期', '周期', 'Cycle', 'Sample Cycle'],
                '送样周别': ['送样周别', '周别', 'Week', 'Sample Week'],
                '加急/同步': ['加急/同步', '优先级', 'Priority', 'Urgent'],
                '总数': ['总数', 'Total', 'Count', 'Total Count']
            };
            
            
            const normalizedData = data.map((row, index) => {
                const normalized = {
                    序号: index + 1
                };
                
                // 字段映射
                for (const [standardField, possibleFields] of Object.entries(fieldMapping)) {
                    for (const field of possibleFields) {
                        if (row.hasOwnProperty(field) && row[field] !== undefined && row[field] !== null && row[field] !== '') {
                            normalized[standardField] = String(row[field]).trim();
                            break;
                        }
                    }
                }
                
                // 处理日期格式 - 支持多种日期格式
                if (normalized.收样时间) {
                    let dateValue = normalized.收样时间;
                    let date;
                    
                    // 处理Excel日期序列号
                    if (!isNaN(dateValue) && Number(dateValue) > 40000) {
                        // Excel日期序列号转换
                        date = new Date((Number(dateValue) - 25569) * 86400 * 1000);
                    } else {
                        // 普通日期字符串
                        date = new Date(dateValue);
                    }
                    
                    if (!isNaN(date.getTime())) {
                        normalized.收样时间 = date.toLocaleDateString('zh-CN');
                    } else {
                        // 如果日期解析失败，保留原值
                        console.warn('日期解析失败:', dateValue);
                    }
                }
                
                // 处理数值字段
                const numericFields = ['送样次数', '测试时长', '问题总数', '送样周期', '总数'];
                numericFields.forEach(field => {
                    if (normalized[field] && !isNaN(normalized[field])) {
                        normalized[field] = parseFloat(normalized[field]);
                    }
                });
                
                // 保留其他字段
                Object.keys(row).forEach(key => {
                    if (!Object.values(fieldMapping).some(fields => fields.includes(key))) {
                        normalized[key] = row[key];
                    }
                });
                
                return normalized;
            }).filter(row => {
                // 过滤掉空行或关键字段都为空的行
                const hasKeyField = row.样品型号 || row.小编码 || row.收样时间;
                if (!hasKeyField) {
                    console.log('过滤掉空行:', row);
                }
                return hasKeyField;
            });
            
            console.log('✅ 数据标准化完成:', {
                '原始记录数': data.length,
                '有效记录数': normalizedData.length,
                '字段映射': Object.keys(fieldMapping),
                '标准化后字段': normalizedData.length > 0 ? Object.keys(normalizedData[0]) : []
            });
            
            if (normalizedData.length > 0) {
                console.log('标准化后首行数据示例:', normalizedData[0]);
            }
            
            return normalizedData;
        }
        
        // 获取日期范围
        function getDateRange(data) {
            const dates = data
                .map(r => new Date(r.收样时间))
                .filter(d => !isNaN(d.getTime()))
                .sort((a, b) => a - b);
            
            if (dates.length === 0) return '无日期数据';
            
            const start = dates[0].toLocaleDateString('zh-CN');
            const end = dates[dates.length - 1].toLocaleDateString('zh-CN');
            return `${start} 至 ${end}`;
        }
        
        // 获取唯一供应商数
        function getUniqueSuppliers(data) {
            const suppliers = new Set(data.map(r => r.供应商).filter(s => s && s !== '未知'));
            return suppliers.size;
        }
        
        // 获取唯一型号数
        function getUniqueModels(data) {
            const models = new Set(data.map(r => r.样品型号).filter(m => m && m !== '未知'));
            return models.size;
        }
        
        // 级联筛选系统
        class CascadingFilterSystem {
            constructor(data) {
                this.data = data;
                this.fieldConfigs = [
                    { field: '样品分类', listId: 'categoryList', inputId: 'categorySearch', name: '样品分类' },
                    { field: '样品性质', listId: 'propertyList', inputId: 'propertySearch', name: '样品性质' },
                    { field: '品类细分', listId: 'subCategoryList', inputId: 'subCategorySearch', name: '品类细分' },
                    { field: '测试人', listId: 'testerList', inputId: 'testerSearch', name: '测试人' },
                    { field: '电子工程师', listId: 'electronicEngineerList', inputId: 'electronicEngineerSearch', name: '电子工程师' },
                    { field: '项目工程师', listId: 'projectEngineerList', inputId: 'projectEngineerSearch', name: '项目工程师' },
                    { field: 'DQE', listId: 'dqeList', inputId: 'dqeSearch', name: 'DQE' },
                    { field: 'DQE品类细分', listId: 'dqeCategoryList', inputId: 'dqeCategorySearch', name: 'DQE品类细分' },
                    { field: '新分类', listId: 'newCategoryList', inputId: 'newCategorySearch', name: '新分类' }
                ];
                this.setupEventListeners();
                this.updateAllOptions();
            }
            
            // 设置事件监听器
            setupEventListeners() {
                this.fieldConfigs.forEach(config => {
                    const input = document.getElementById(config.inputId);
                    if (input) {
                        input.addEventListener('input', () => this.onFieldChange(config.field));
                        input.addEventListener('change', () => this.onFieldChange(config.field));
                    }
                });
                
                // 添加日期范围监听器
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                if (startDateInput) {
                    startDateInput.addEventListener('change', () => this.onFieldChange('dateRange'));
                }
                if (endDateInput) {
                    endDateInput.addEventListener('change', () => this.onFieldChange('dateRange'));
                }
            }
            
            // 字段变化时的处理
            onFieldChange(changedField) {
                console.log(`🔄 字段 ${changedField} 发生变化，更新级联筛选...`);
                this.updateAllOptions();
            }
            
            // 获取当前已选择的值
            getCurrentSelections() {
                const selections = {};
                this.fieldConfigs.forEach(config => {
                    const input = document.getElementById(config.inputId);
                    if (input && input.value.trim()) {
                        selections[config.field] = input.value.trim();
                    }
                });
                return selections;
            }
            
            // 根据当前选择过滤数据
            getFilteredData() {
                const selections = this.getCurrentSelections();
                let filteredData = [...this.data];
                
                // 应用日期范围筛选
                filteredData = this.applyDateRangeFilter(filteredData);
                
                // 应用所有已选择的筛选条件
                Object.entries(selections).forEach(([field, value]) => {
                    filteredData = filteredData.filter(record => 
                        record[field] && record[field].includes(value)
                    );
                });
                
                return filteredData;
            }
            
            // 应用日期范围筛选
            applyDateRangeFilter(data) {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                if (!startDateInput || !endDateInput) return data;
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                // 如果没有设置日期范围，返回所有数据
                if (!startDate && !endDate) return data;
                
                return data.filter(record => {
                    if (!record.收样时间) return false;
                    
                    try {
                        const recordDate = new Date(record.收样时间);
                        if (isNaN(recordDate.getTime())) return false;
                        
                        // 只比较日期部分，忽略时间
                        const recordDateOnly = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());
                        
                        if (startDate) {
                            const start = new Date(startDate);
                            if (recordDateOnly < start) return false;
                        }
                        
                        if (endDate) {
                            const end = new Date(endDate);
                            if (recordDateOnly > end) return false;
                        }
                        
                        return true;
                    } catch (error) {
                        console.warn('日期解析错误:', record.收样时间, error);
                        return false;
                    }
                });
            }
            
            // 更新所有字段的选项
            updateAllOptions() {
                const filteredData = this.getFilteredData();
                const selections = this.getCurrentSelections();
                
                this.fieldConfigs.forEach(config => {
                    // 如果当前字段已有选择，跳过更新
                    if (selections[config.field]) {
                        return;
                    }
                    
                    // 获取该字段在当前过滤数据中的唯一值
                    const values = [...new Set(
                        filteredData.map(r => r[config.field])
                            .filter(v => v && v !== '未知' && v !== '')
                    )].sort();
                    
                    // 更新下拉列表
                    const listElement = document.getElementById(config.listId);
                    if (listElement) {
                        listElement.innerHTML = '';
                        values.forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            listElement.appendChild(option);
                        });
                    }
                    
                    console.log(`${config.name} 可用选项数量: ${values.length}`);
                });
                
                // 更新状态显示
                this.updateFilterStatus(selections, filteredData.length);
            }
            
            // 更新筛选状态显示
            updateFilterStatus(selections, filteredCount) {
                const activeFiltersElement = document.getElementById('activeFilters');
                const availableOptionsElement = document.getElementById('availableOptions');
                
                const filters = [];
                
                // 添加日期范围筛选信息
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                if (startDateInput && endDateInput) {
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    if (startDate || endDate) {
                        const dateRange = `${startDate || '开始'} 至 ${endDate || '结束'}`;
                        filters.push(`日期范围: ${dateRange}`);
                    }
                }
                
                // 添加其他筛选条件
                Object.entries(selections).forEach(([field, value]) => {
                    filters.push(`${field}: ${value}`);
                });
                
                if (filters.length === 0) {
                    activeFiltersElement.textContent = '当前无筛选条件';
                    availableOptionsElement.textContent = '';
                } else {
                    activeFiltersElement.textContent = `已筛选: ${filters.join(', ')}`;
                    availableOptionsElement.textContent = `剩余记录: ${filteredCount} 条`;
                }
            }
            
            // 重置所有选项
            resetAllOptions() {
                this.fieldConfigs.forEach(config => {
                    const input = document.getElementById(config.inputId);
                    if (input) input.value = '';
                });
                this.updateAllOptions();
            }
        }
        
        // 全局级联筛选系统实例
        let cascadingFilter = null;
        
        // 日期范围设置函数
        function setDateRange(type) {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const today = new Date();
            
            switch(type) {
                case 'all':
                    startDateInput.value = '';
                    endDateInput.value = '';
                    break;
                case 'thisMonth':
                    const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    startDateInput.value = thisMonthStart.toISOString().split('T')[0];
                    endDateInput.value = thisMonthEnd.toISOString().split('T')[0];
                    break;
                case 'lastMonth':
                    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    startDateInput.value = lastMonthStart.toISOString().split('T')[0];
                    endDateInput.value = lastMonthEnd.toISOString().split('T')[0];
                    break;
            }
            
            // 触发级联筛选更新
            if (cascadingFilter) {
                cascadingFilter.onFieldChange('dateRange');
            }
        }
        
        // 提取唯一值并更新下拉列表（保持向后兼容）
        function updateDropdownOptions(data) {
            // 创建级联筛选系统
            cascadingFilter = new CascadingFilterSystem(data);
            console.log('✅ 级联筛选系统已初始化');
            
            // 设置日期范围默认值（显示所有数据）
            setDateRange('all');
        }
        
        // 去重功能 - 移除完全相同的记录
        function removeDuplicateRecords(records) {
            const seen = new Set();
            const uniqueRecords = [];
            
            for (const record of records) {
                // 创建记录的唯一标识，基于完整的重复判断字段
                const key = JSON.stringify({
                    收样时间: record.收样时间,
                    样品型号: record.样品型号,
                    小编码: record.小编码,
                    版本号: record.版本号,
                    测试编号: record.测试编号 || '',  // 可能为空，用空字符串代替
                    样品分类: record.样品分类,
                    样品性质: record.样品性质,
                    新分类: record.新分类
                });
                
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueRecords.push(record);
                }
            }
            
            console.log(`去重前: ${records.length} 条记录，去重后: ${uniqueRecords.length} 条记录`);
            return uniqueRecords;
        }
        
        // =====================================================
        // 分页功能
        // =====================================================
        
        // 分页状态
        let paginationState = {
            currentPage: 1,
            pageSize: 10,
            totalRecords: 0,
            totalPages: 0,
            allRecords: []
        };
        
        // 初始化分页功能
        function initPagination() {
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            
            // 每页条数变化事件
            pageSizeSelect.addEventListener('change', function() {
                paginationState.pageSize = parseInt(this.value);
                paginationState.currentPage = 1;
                updatePagination();
                renderCurrentPage();
            });
            
            // 分页按钮事件
            firstPageBtn.addEventListener('click', () => goToPage(1));
            prevPageBtn.addEventListener('click', () => goToPage(paginationState.currentPage - 1));
            nextPageBtn.addEventListener('click', () => goToPage(paginationState.currentPage + 1));
            lastPageBtn.addEventListener('click', () => goToPage(paginationState.totalPages));
        }
        
        // 设置分页数据
        function setPaginationData(records) {
            paginationState.allRecords = records;
            paginationState.totalRecords = records.length;
            paginationState.totalPages = Math.ceil(records.length / paginationState.pageSize);
            paginationState.currentPage = 1;
            updatePagination();
        }
        
        // 跳转到指定页面
        function goToPage(page) {
            if (page < 1 || page > paginationState.totalPages) return;
            
            paginationState.currentPage = page;
            updatePagination();
            renderCurrentPage();
        }
        
        // 更新分页UI状态
        function updatePagination() {
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            // 更新按钮状态
            firstPageBtn.disabled = paginationState.currentPage <= 1;
            prevPageBtn.disabled = paginationState.currentPage <= 1;
            nextPageBtn.disabled = paginationState.currentPage >= paginationState.totalPages;
            lastPageBtn.disabled = paginationState.currentPage >= paginationState.totalPages;
            
            // 更新页面信息
            pageInfo.textContent = `第 ${paginationState.currentPage} 页，共 ${paginationState.totalPages} 页`;
        }
        
        // 渲染当前页数据
        function renderCurrentPage() {
            const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
            const endIndex = startIndex + paginationState.pageSize;
            const currentPageRecords = paginationState.allRecords.slice(startIndex, endIndex);
            
            updateTable(currentPageRecords);
        }
        
        // =====================================================
        // 时间维度处理功能
        // =====================================================
        
        // 获取时间维度配置
        function getDimensionConfig(dimension) {
            const configs = {
                'day': { label: '日', format: 'YYYY-MM-DD' },
                'week': { label: '周', format: 'YYYY-WW' },
                'month': { label: '月', format: 'YYYY-MM' },
                'year': { label: '年', format: 'YYYY' }
            };
            return configs[dimension] || configs['month'];
        }
        
        // 格式化时间键
        function formatTimeKey(date, dimension) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            switch (dimension) {
                case 'day':
                    return `${year}-${month}-${day}`;
                case 'week':
                    const weekNumber = getWeekNumber(date);
                    return `${year}-W${String(weekNumber).padStart(2, '0')}`;
                case 'month':
                    return `${year}-${month}`;
                case 'year':
                    return `${year}`;
                default:
                    return `${year}-${month}`;
            }
        }
        
        // 格式化时间标签
        function formatTimeLabel(timeKey, dimension) {
            switch (dimension) {
                case 'day':
                    return timeKey; // 直接显示日期
                case 'week':
                    return timeKey.replace('W', '第') + '周';
                case 'month':
                    return timeKey.replace('-', '年') + '月';
                case 'year':
                    return timeKey + '年';
                default:
                    return timeKey;
            }
        }
        
        // 获取周数
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        // =====================================================
        // 日期范围筛选功能
        // =====================================================
        
        // 应用日期范围筛选
        function applyDateRangeFilter(data) {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (!startDateInput || !endDateInput) {
                console.log('日期输入框未找到');
                return data;
            }
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            console.log('日期范围筛选:', { startDate, endDate });
            
            // 如果没有设置日期范围，返回所有数据
            if (!startDate && !endDate) {
                console.log('未设置日期范围，返回所有数据');
                return data;
            }
            
            return data.filter(record => {
                if (!record.收样时间) return false;
                
                try {
                    const recordDate = new Date(record.收样时间);
                    if (isNaN(recordDate.getTime())) return false;
                    
                    // 只比较日期部分，忽略时间
                    const recordDateOnly = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());
                    
                    if (startDate) {
                        const start = new Date(startDate);
                        if (recordDateOnly < start) return false;
                    }
                    
                    if (endDate) {
                        const end = new Date(endDate);
                        if (recordDateOnly > end) return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.warn('日期解析错误:', record.收样时间, error);
                    return false;
                }
            });
        }
        
        // =====================================================
        // 时间维度选择器功能
        // =====================================================
        
        // 初始化时间维度选择器
        function initTimeDimensionSelector() {
            const dimensionButtons = document.querySelectorAll('.dimension-btn');
            
            dimensionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的active类
                    dimensionButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // 为当前按钮添加active类
                    this.classList.add('active');
                    
                    // 重新绘制图表（如果有数据的话）
                    if (window.currentRecords && window.currentRecords.length > 0) {
                        updateChart(window.currentRecords);
                    }
                });
            });
        }
        
        // =====================================================
        // 清除按钮功能
        // =====================================================
        
        // 初始化清除按钮功能
        function initClearButtons() {
            const clearButtonMappings = [
                { inputId: 'modelSearch', clearId: 'clearModel' },
                { inputId: 'codeSearch', clearId: 'clearCode' },
                { inputId: 'categorySearch', clearId: 'clearCategory' },
                { inputId: 'propertySearch', clearId: 'clearProperty' },
                { inputId: 'subCategorySearch', clearId: 'clearSubCategory' },
                { inputId: 'testerSearch', clearId: 'clearTester' },
                { inputId: 'electronicEngineerSearch', clearId: 'clearElectronicEngineer' },
                { inputId: 'projectEngineerSearch', clearId: 'clearProjectEngineer' },
                { inputId: 'dqeSearch', clearId: 'clearDqe' },
                { inputId: 'dqeCategorySearch', clearId: 'clearDqeCategory' },
                { inputId: 'newCategorySearch', clearId: 'clearNewCategory' }
            ];
            
            clearButtonMappings.forEach(({ inputId, clearId }) => {
                const input = document.getElementById(inputId);
                const clearBtn = document.getElementById(clearId);
                
                if (input && clearBtn) {
                    // 监听输入变化，控制清除按钮显示/隐藏
                    input.addEventListener('input', function() {
                        if (this.value.trim() !== '') {
                            clearBtn.style.display = 'flex';
                        } else {
                            clearBtn.style.display = 'none';
                        }
                    });
                    
                    // 监听清除按钮点击
                    clearBtn.addEventListener('click', function() {
                        input.value = '';
                        input.focus();
                        clearBtn.style.display = 'none';
                        
                        // 触发级联筛选更新
                        if (cascadingFilter) {
                            cascadingFilter.onFieldChange(inputId.replace('Search', ''));
                        }
                    });
                }
            });
        }
        
        // =====================================================
        // 模拟数据生成
        // =====================================================
        
        function generateMockData() {
            const mockData = [];
            const models = ['D703', 'CM850', 'HD175', 'AK700', 'CM800', 'CM336', 'CM662', 'AK500', 'Model-001', 'Model-002'];
            const codes = ['65727', '45368', '55733', '55851', '75126', '80115', '15705', '12345', '67890', '11111'];
            const suppliers = ['海盈', '菲炫', 'UGREEN', '绿联', '山泽', '品胜', '公牛', '小米', '华为', '苹果'];
            const dqeCategories = ['手机', '平板', '笔记本', '耳机', '充电器'];
            const testers = ['张三', '李四', '王五', '赵六', '孙七'];
            const sampleTypes = ['功能样', '认证样', '试产样', '量产样'];
            const properties = ['新项目', '变更项目', '例行测试'];
            const results = ['PASS', 'FAIL', 'PENDING'];
            const engineers = ['工程师A', '工程师B', '工程师C', '工程师D'];
            const dqePersonnel = ['DQE张', 'DQE李', 'DQE王', 'DQE赵'];
            
            // 生成一些复杂格式的样品型号和编码组合
            const complexPatterns = [
                { model: 'D703', code: '65727' },
                { model: 'D703/CM850', code: '65727/45368' },
                { model: 'D703+CM850+HD175', code: '65727+45368+55733' },
                { model: 'D703,CM850', code: '65727,45368' },
                { model: 'D703&CM850', code: '65727&45368' },
                { model: 'D703 CM850', code: '65727 45368' },
                { model: 'D703(升级版)', code: '65727' },
                { model: 'AK500', code: '12345' },
                { model: 'AK500/AK700', code: '12345/55851' }
            ];
            
            for (let i = 0; i < 100; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 180)); // 最近6个月
                
                // 70%使用复杂模式，30%使用简单模式
                let modelData, codeData;
                if (Math.random() < 0.7 && complexPatterns.length > 0) {
                    const pattern = complexPatterns[Math.floor(Math.random() * complexPatterns.length)];
                    modelData = pattern.model;
                    codeData = pattern.code;
                } else {
                    modelData = models[Math.floor(Math.random() * models.length)];
                    codeData = codes[Math.floor(Math.random() * codes.length)];
                }
                
                mockData.push({
                    '序号': i + 1,
                    '收样时间': date.toLocaleDateString('zh-CN'),
                    '样品型号': modelData,
                    '小编码': codeData,
                    '供应商': suppliers[Math.floor(Math.random() * suppliers.length)],
                    '样品分类': sampleTypes[Math.floor(Math.random() * sampleTypes.length)],
                    '样品性质': properties[Math.floor(Math.random() * properties.length)],
                    '送样次数': Math.floor(Math.random() * 5) + 1,
                    '版本号': `V${Math.floor(Math.random() * 3) + 1}.${Math.floor(Math.random() * 9)}`,
                    'DQE品类细分': dqeCategories[Math.floor(Math.random() * dqeCategories.length)],
                    '品类细分': dqeCategories[Math.floor(Math.random() * dqeCategories.length)],
                    '测试人': testers[Math.floor(Math.random() * testers.length)],
                    '电子工程师': engineers[Math.floor(Math.random() * engineers.length)],
                    '项目工程师': engineers[Math.floor(Math.random() * engineers.length)],
                    'DQE': dqePersonnel[Math.floor(Math.random() * dqePersonnel.length)],
                    '新分类': sampleTypes[Math.floor(Math.random() * sampleTypes.length)],
                    '测试编号': `ET2025${String(Math.floor(Math.random() * 1000000)).padStart(6, '0')}`,
                    '判定结果': results[Math.floor(Math.random() * results.length)],
                    '测试时长': parseFloat((Math.random() * 20 + 1).toFixed(1)),
                    '问题总数': Math.floor(Math.random() * 5),
                    '送样周期': parseFloat((Math.random() * 30 + 1).toFixed(1)),
                    '送样周别': `2025-W${String(Math.floor(Math.random() * 52) + 1).padStart(2, '0')}`,
                    '加急/同步': Math.random() > 0.7 ? '加急' : '正常',
                    '总数': Math.floor(Math.random() * 100) + 1
                });
            }
            
            console.log('✅ 模拟数据生成完成，包含', mockData.length, '条记录');
            return mockData;
        }
        
        // =====================================================
        // 专业统计学函数
        // =====================================================
        
        // 计算四分位数 - 专业统计学方法
        function calculateQuartiles(data) {
            if (!data || data.length === 0) return { q1: 0, q2: 0, q3: 0 };
            
            const sorted = [...data].sort((a, b) => a - b);
            const n = sorted.length;
            
            const q1Index = Math.floor(n * 0.25);
            const q2Index = Math.floor(n * 0.5);
            const q3Index = Math.floor(n * 0.75);
            
            return {
                q1: sorted[q1Index] || 0,
                q2: sorted[q2Index] || 0, // 中位数
                q3: sorted[q3Index] || 0
            };
        }
        
        // 计算标准差
        function calculateStandardDeviation(data) {
            if (!data || data.length === 0) return 0;
            
            const mean = data.reduce((sum, val) => sum + val, 0) / data.length;
            const squaredDiffs = data.map(val => Math.pow(val - mean, 2));
            const avgSquaredDiff = squaredDiffs.reduce((sum, val) => sum + val, 0) / data.length;
            
            return Math.sqrt(avgSquaredDiff);
        }
        
        // 计算变异系数 (CV)
        function calculateCoefficientOfVariation(data) {
            if (!data || data.length === 0) return 0;
            
            const mean = data.reduce((sum, val) => sum + val, 0) / data.length;
            const std = calculateStandardDeviation(data);
            
            return mean === 0 ? 0 : (std / mean) * 100;
        }
        
        // 计算相关系数
        function calculateCorrelation(x, y) {
            if (!x || !y || x.length !== y.length || x.length === 0) return 0;
            
            const n = x.length;
            const sumX = x.reduce((sum, val) => sum + val, 0);
            const sumY = y.reduce((sum, val) => sum + val, 0);
            const sumXY = x.reduce((sum, val, i) => sum + val * y[i], 0);
            const sumX2 = x.reduce((sum, val) => sum + val * val, 0);
            const sumY2 = y.reduce((sum, val) => sum + val * val, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }
        
        // =====================================================
        // 深度统计分析功能
        // =====================================================
        
        // 显示无数据提示
        function showNoDataMessage(tabName) {
            const tabElement = document.getElementById(tabName);
            if (!tabElement) return;
            
            // 找到指标和图表容器，如果不存在就不处理
            const metricsContainer = tabElement.querySelector('.metric-grid');
            const chartContainer = tabElement.querySelector('.chart-container');
            
            if (metricsContainer) {
                metricsContainer.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📊</div>
                        <h3 style="margin-bottom: 10px; color: #495057;">暂无数据</h3>
                        <p>请先上传Excel文件或进行搜索以查看统计分析结果</p>
                    </div>
                `;
            }
            
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; margin-bottom: 10px;">📈</div>
                            <p>图表将在有数据后显示</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // 切换分析标签页
        function switchAnalysisTab(tabName) {
            // 隐藏所有标签页内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的active类
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName).classList.add('active');
            
            // 为选中的标签添加active类
            event.target.classList.add('active');
            
            // 根据标签页加载相应数据
            loadAnalysisData(tabName);
        }
        
        // 根据标签页加载分析数据
        function loadAnalysisData(tabName) {
            // 优先使用搜索结果，其次使用所有数据
            const currentData = window.currentRecords || window.currentData;
            
            // 如果没有真实数据，显示提示并返回
            if (!currentData || currentData.length === 0) {
                showNoDataMessage(tabName);
                return;
            }
            
            switch(tabName) {
                case 'overview':
                    loadOverviewAnalysis(currentData);
                    break;
                case 'resource':
                    loadResourceAnalysis(currentData);
                    break;
                case 'cycle':
                    loadCycleAnalysis(currentData);
                    break;
                case 'sample':
                    loadSampleAnalysis(currentData);
                    break;
                case 'personnel':
                    loadPersonnelAnalysis(currentData);
                    break;
                case 'waterlevel':
                    loadWaterlevelAnalysis(currentData);
                    break;
                case 'inventory':
                    loadInventoryAnalysis(currentData);
                    break;
                case 'advanced':
                    loadAdvancedAnalysis(currentData);
                    break;
            }
        }
        
        // 加载概览分析
        function loadOverviewAnalysis(data) {
            // 概览数据已经在原有的统计卡片中显示
            console.log('概览分析已加载，数据量:', data.length);
            
            // 如果是模拟数据，显示提示
            if (data === generateMockData() || (!window.currentData && !window.currentRecords)) {
                const overviewDiv = document.getElementById('overview');
                if (overviewDiv) {
                    const existingAlert = overviewDiv.querySelector('.data-alert');
                    if (!existingAlert) {
                        const alert = document.createElement('div');
                        alert.className = 'data-alert';
                        alert.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center;';
                        alert.innerHTML = '⚠️ 当前显示的是模拟数据，请上传Excel文件查看真实数据分析';
                        overviewDiv.insertBefore(alert, overviewDiv.firstChild);
                    }
                }
            }
        }
        
        // 加载资源投入分析
        function loadResourceAnalysis(data) {
            const resourceMetrics = document.getElementById('resourceMetrics');
            
            // 计算DQE品类细分统计
            const dqeStats = {};
            data.forEach(record => {
                const dqe = record.DQE品类细分 || '未知';
                if (!dqeStats[dqe]) {
                    dqeStats[dqe] = { count: 0, totalTime: 0, passCount: 0 };
                }
                dqeStats[dqe].count++;
                dqeStats[dqe].totalTime += parseFloat(record.测试时长) || 0;
                if (record.判定结果 === 'PASS') dqeStats[dqe].passCount++;
            });
            
            const topDqe = Object.entries(dqeStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
            
            resourceMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">最活跃DQE品类</div>
                    <div class="metric-value">${topDqe[0]?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">送样总数</div>
                    <div class="metric-value">${topDqe[0]?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">平均测试时长</div>
                    <div class="metric-value">${(topDqe[0]?.[1].totalTime / topDqe[0]?.[1].count || 0).toFixed(1)}h</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">通过率</div>
                    <div class="metric-value">${(topDqe[0]?.[1].passCount / topDqe[0]?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
            `;
            
            // 创建资源投入图表
            const ctx = document.getElementById('resourceChart').getContext('2d');
            if (window.resourceChart && typeof window.resourceChart.destroy === 'function') {
                window.resourceChart.destroy();
            }
            window.resourceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topDqe.map(d => d[0]),
                    datasets: [{
                        label: '送样次数',
                        data: topDqe.map(d => d[1].count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 加载周期分析
        function loadCycleAnalysis(data) {
            const cycleMetrics = document.getElementById('cycleMetrics');
            
            // 计算送样周期统计 - 专业统计学指标
            const cycles = data.map(d => parseFloat(d.送样周期) || 0).filter(c => c > 0);
            const avgCycle = cycles.length > 0 ? cycles.reduce((a, b) => a + b, 0) / cycles.length : 0;
            const minCycle = cycles.length > 0 ? Math.min(...cycles) : 0;
            const maxCycle = cycles.length > 0 ? Math.max(...cycles) : 0;
            const quartiles = calculateQuartiles(cycles);
            const stdDev = calculateStandardDeviation(cycles);
            const cv = calculateCoefficientOfVariation(cycles);
            
            cycleMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">平均值 (μ)</div>
                    <div class="metric-value">${avgCycle.toFixed(1)}天</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">中位数 (Q2)</div>
                    <div class="metric-value">${quartiles.q2.toFixed(1)}天</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">标准差 (σ)</div>
                    <div class="metric-value">${stdDev.toFixed(2)}天</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">变异系数 (CV)</div>
                    <div class="metric-value">${cv.toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">四分位距 (IQR)</div>
                    <div class="metric-value">${(quartiles.q3 - quartiles.q1).toFixed(1)}天</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">样本数 (n)</div>
                    <div class="metric-value">${cycles.length}</div>
                </div>
            `;
            
            // 创建专业的箱图分析和趋势图表
            const ctx = document.getElementById('cycleChart').getContext('2d');
            if (window.cycleChart && typeof window.cycleChart.destroy === 'function') {
                window.cycleChart.destroy();
            }
            
            // 准备时间序列数据 - 按日期排序
            const timeSeriesData = data
                .filter(d => d.收样时间 && d.送样周期)
                .map(d => ({
                    date: new Date(d.收样时间),
                    cycle: parseFloat(d.送样周期) || 0
                }))
                .sort((a, b) => a.date - b.date);
            
            // 计算统计分布 - 专业统计学方法
            const quartiles2 = calculateQuartiles(cycles);
            
            window.cycleChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.map(d => d.date.toLocaleDateString('zh-CN')),
                    datasets: [{
                        label: '送样周期趋势',
                        data: timeSeriesData.map(d => d.cycle),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: '平均值',
                        data: new Array(timeSeriesData.length).fill(avgCycle),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0
                    }, {
                        label: 'Q3 (75分位数)',
                        data: new Array(timeSeriesData.length).fill(quartiles2.q3),
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderDash: [3, 3],
                        pointRadius: 0,
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '送样周期时间序列分析 (含统计控制线)',
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '周期(天)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '收样时间'
                            }
                        }
                    }
                }
            });
        }
        
        // 加载样品分析
        function loadSampleAnalysis(data) {
            const sampleMetrics = document.getElementById('sampleMetrics');
            
            // 计算样品分类统计
            const categoryStats = {};
            data.forEach(record => {
                const category = record.样品分类 || '未知';
                if (!categoryStats[category]) {
                    categoryStats[category] = { count: 0, passCount: 0 };
                }
                categoryStats[category].count++;
                if (record.判定结果 === 'PASS') categoryStats[category].passCount++;
            });
            
            const topCategory = Object.entries(categoryStats)
                .sort((a, b) => b[1].count - a[1].count)[0];
            
            sampleMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">最活跃样品分类</div>
                    <div class="metric-value">${topCategory?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">送样次数</div>
                    <div class="metric-value">${topCategory?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">通过率</div>
                    <div class="metric-value">${(topCategory?.[1].passCount / topCategory?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">样品分类数</div>
                    <div class="metric-value">${Object.keys(categoryStats).length}</div>
                </div>
            `;
            
            // 创建样品分析图表
            const ctx = document.getElementById('sampleChart').getContext('2d');
            if (window.sampleChart && typeof window.sampleChart.destroy === 'function') {
                window.sampleChart.destroy();
            }
            const topCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
            
            window.sampleChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: topCategories.map(d => d[0]),
                    datasets: [{
                        data: topCategories.map(d => d[1].count),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // 加载人员技能分析
        function loadPersonnelAnalysis(data) {
            const personnelMetrics = document.getElementById('personnelMetrics');
            
            // 计算测试人员统计
            const testerStats = {};
            data.forEach(record => {
                const tester = record.测试人 || '未知';
                if (!testerStats[tester]) {
                    testerStats[tester] = { count: 0, passCount: 0, categories: new Set() };
                }
                testerStats[tester].count++;
                if (record.判定结果 === 'PASS') testerStats[tester].passCount++;
                testerStats[tester].categories.add(record.品类细分 || '未知');
            });
            
            const topTester = Object.entries(testerStats)
                .sort((a, b) => b[1].count - a[1].count)[0];
            
            personnelMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">最活跃测试人</div>
                    <div class="metric-value">${topTester?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">测试次数</div>
                    <div class="metric-value">${topTester?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">通过率</div>
                    <div class="metric-value">${(topTester?.[1].passCount / topTester?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">涉及品类数</div>
                    <div class="metric-value">${topTester?.[1].categories.size || 0}</div>
                </div>
            `;
            
            // 创建人员技能图表
            const ctx = document.getElementById('personnelChart').getContext('2d');
            if (window.personnelChart && typeof window.personnelChart.destroy === 'function') {
                window.personnelChart.destroy();
            }
            const topTesters = Object.entries(testerStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
            
            window.personnelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topTesters.map(d => d[0]),
                    datasets: [{
                        label: '测试次数',
                        data: topTesters.map(d => d[1].count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 加载水位线分析
        function loadWaterlevelAnalysis(data) {
            const waterlevelMetrics = document.getElementById('waterlevelMetrics');
            
            // 计算收样水位统计
            const weeklyStats = {};
            data.forEach(record => {
                const week = record.送样周别 || '未知';
                if (!weeklyStats[week]) {
                    weeklyStats[week] = { count: 0, urgentCount: 0 };
                }
                weeklyStats[week].count++;
                if (record['加急/同步'] === '加急') weeklyStats[week].urgentCount++;
            });
            
            const recentWeek = Object.entries(weeklyStats)
                .sort((a, b) => b[0].localeCompare(a[0]))[0];
            
            waterlevelMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">最近一周收样数</div>
                    <div class="metric-value">${recentWeek?.[1].count || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">加急比例</div>
                    <div class="metric-value">${(recentWeek?.[1].urgentCount / recentWeek?.[1].count * 100 || 0).toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">周别</div>
                    <div class="metric-value">${recentWeek?.[0] || 'N/A'}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">总周数</div>
                    <div class="metric-value">${Object.keys(weeklyStats).length}</div>
                </div>
            `;
            
            // 创建水位线图表
            const ctx = document.getElementById('waterlevelChart').getContext('2d');
            if (window.waterlevelChart && typeof window.waterlevelChart.destroy === 'function') {
                window.waterlevelChart.destroy();
            }
            const weeklyData = Object.entries(weeklyStats)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .slice(-10);
            
            window.waterlevelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeklyData.map(d => d[0]),
                    datasets: [{
                        label: '收样数',
                        data: weeklyData.map(d => d[1].count),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 加载库存管理分析
        function loadInventoryAnalysis(data) {
            const inventoryMetrics = document.getElementById('inventoryMetrics');
            
            // 计算库存统计
            const totalSamples = data.reduce((sum, record) => sum + (parseInt(record.总数) || 0), 0);
            const completedSamples = data.filter(record => record.判定结果 === 'PASS').length;
            const pendingSamples = data.length - completedSamples;
            
            inventoryMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">总样品数</div>
                    <div class="metric-value">${totalSamples}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">已完成</div>
                    <div class="metric-value">${completedSamples}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">待处理</div>
                    <div class="metric-value">${pendingSamples}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">完成率</div>
                    <div class="metric-value">${(completedSamples / data.length * 100).toFixed(1)}%</div>
                </div>
            `;
            
            // 创建库存管理图表
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            if (window.inventoryChart && typeof window.inventoryChart.destroy === 'function') {
                window.inventoryChart.destroy();
            }
            window.inventoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['已完成', '待处理'],
                    datasets: [{
                        data: [completedSamples, pendingSamples],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // 加载高级统计分析
        function loadAdvancedAnalysis(data) {
            const advancedMetrics = document.getElementById('advancedMetrics');
            
            // 计算高级统计指标
            const passRate = data.filter(d => d.判定结果 === 'PASS').length / data.length * 100;
            const avgTestTime = data.reduce((sum, d) => sum + (parseFloat(d.测试时长) || 0), 0) / data.length;
            const problemCount = data.reduce((sum, d) => sum + (parseInt(d.问题总数) || 0), 0);
            
            // 计算实际的综合评分指标
            const efficiency = Math.max(0, 100 - avgTestTime); // 效率：测试时长越短效率越高
            const quality = Math.max(0, 100 - (problemCount / data.length * 10)); // 质量：问题越少质量越高
            const coverage = Math.min(100, (new Set(data.map(d => d.样品分类)).size / 10) * 100); // 覆盖度：样品分类数
            const timeliness = Math.max(0, 100 - (data.reduce((sum, d) => sum + (parseFloat(d.送样周期) || 0), 0) / data.length / 30 * 100)); // 及时性：周期越短越及时
            
            advancedMetrics.innerHTML = `
                <div class="metric-item">
                    <div class="metric-label">整体通过率</div>
                    <div class="metric-value">${passRate.toFixed(1)}%</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">效率评分</div>
                    <div class="metric-value">${efficiency.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">质量评分</div>
                    <div class="metric-value">${quality.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">覆盖度评分</div>
                    <div class="metric-value">${coverage.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">及时性评分</div>
                    <div class="metric-value">${timeliness.toFixed(1)}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">问题总数</div>
                    <div class="metric-value">${problemCount}</div>
                </div>
            `;
            
            // 创建高级统计图表
            const ctx = document.getElementById('advancedChart').getContext('2d');
            if (window.advancedChart && typeof window.advancedChart.destroy === 'function') {
                window.advancedChart.destroy();
            }
            window.advancedChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['通过率', '效率', '质量', '覆盖度', '及时性'],
                    datasets: [{
                        label: '综合评分',
                        data: [passRate, efficiency, quality, coverage, timeliness],
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // =====================================================
        // 初始化
        // =====================================================
        
        // 页面加载时执行
        window.onload = function() {
            // 输出系统信息
            console.log('智能项目识别系统已启动');
            
            // 初始化清除按钮功能
            initClearButtons();
            
            // 初始化时间维度选择器
            initTimeDimensionSelector();
            
            // 初始化分页功能
            initPagination();
            console.log('支持的分隔符:', matcher.separators);
            console.log('模拟数据量:', mockData.length);
            
            // 初始化模拟数据和下拉选项
            updateDropdownOptions(currentData);
            
            // 初始化深度分析
            loadAnalysisData('overview');
            
            // 添加按钮事件监听器
            const searchButton = document.getElementById('searchButton');
            if (searchButton) {
                searchButton.addEventListener('click', function(e) {
                    console.log('🔘 搜索按钮被点击');
                    e.preventDefault();
                    searchProject();
                });
            }
            
            // 添加文件上传事件监听器
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload);
                console.log('✅ 文件上传监听器已绑定');
            }
            
            // 测试搜索功能
            console.log('测试搜索功能...');
            testSearchFunction();
        };
        
        // 测试搜索功能
        function testSearchFunction() {
            console.log('=== 搜索功能测试 ===');
            console.log('当前数据量:', currentData.length);
            
            if (currentData.length > 0) {
                console.log('前3条数据样本:');
                currentData.slice(0, 3).forEach((record, index) => {
                    console.log(`样本${index + 1}:`, {
                        样品型号: record.样品型号,
                        小编码: record.小编码,
                        供应商: record.供应商
                    });
                });
                
                // 测试AK500搜索
                console.log('测试AK500搜索...');
                const testResult = matcher.match('AK500', '', 'AK500', '12345');
                console.log('AK500测试结果:', testResult);
                
                // 测试实际数据中的匹配
                let foundMatches = 0;
                currentData.slice(0, 10).forEach((record, index) => {
                    const matchResult = matcher.match('AK500', '', record.样品型号, record.小编码);
                    if (matchResult.matched) {
                        foundMatches++;
                        console.log(`找到匹配记录${index + 1}:`, record);
                    }
                });
                console.log(`前10条记录中AK500匹配数: ${foundMatches}`);
            }
        }
        
        // 测试搜索按钮
        function testSearch() {
            console.log('🧪 开始测试搜索...');
            console.log('当前数据量:', currentData.length);
            
            // 设置测试搜索条件
            document.getElementById('modelSearch').value = 'AK500';
            document.getElementById('codeSearch').value = '';
            
            // 执行搜索
            searchProject();
        }
        
        // 导出功能（供外部调用）
        window.ProjectAnalyzer = {
            matcher: matcher,
            data: currentData,
            search: searchProject,
            stats: calculateStatistics,
            exportData: function() {
                return currentData;
            },
            importData: function(data) {
                currentData = data;
                mockData = data;
                console.log('数据已导入，共', data.length, '条记录');
            }
        };
        
        // ==================== 智能筛选配置功能 ====================
        
        // 智能筛选配置数据
        let smartFilterConfig = {
            searchRules: [],
            dedupRules: [],
            templates: {},
            currentTemplate: null,
            filterHistory: []
        };
        
        // 字段配置 - 基于Excel表头的完整字段列表
        const FIELD_CONFIG = {
            // 基础信息
            '收样时间': { name: '收样时间', type: 'date', group: '基础信息' },
            '样品型号': { name: '样品型号', type: 'text', group: '基础信息' },
            '小编码': { name: '小编码', type: 'text', group: '基础信息' },
            '样品名称': { name: '样品名称', type: 'text', group: '基础信息' },
            '供应商': { name: '供应商', type: 'select', group: '基础信息' },
            '送样次数': { name: '送样次数', type: 'number', group: '基础信息' },
            '品类细分': { name: '品类细分', type: 'select', group: '基础信息' },
            '版本号': { name: '版本号', type: 'text', group: '基础信息' },
            '测试编号': { name: '测试编号', type: 'text', group: '基础信息' },
            '样品分类': { name: '样品分类', type: 'select', group: '基础信息' },
            '样品性质': { name: '样品性质', type: 'select', group: '基础信息' },
            '项目属性': { name: '项目属性', type: 'select', group: '基础信息' },
            '内外贸区分': { name: '内外贸区分', type: 'select', group: '基础信息' },
            '需求耗时': { name: '需求耗时', type: 'number', group: '基础信息' },
            '供应商前置': { name: '供应商前置', type: 'select', group: '基础信息' },
            'DQE品类细分': { name: 'DQE品类细分', type: 'select', group: '基础信息' },
            '新分类': { name: '新分类', type: 'select', group: '基础信息' },
            '加急/同步': { name: '加急/同步', type: 'select', group: '基础信息' },
            '是否在计划内': { name: '是否在计划内', type: 'select', group: '基础信息' },
            '送样备注': { name: '送样备注', type: 'text', group: '基础信息' },
            
            // 时间管理
            '测试时长': { name: '测试时长', type: 'number', group: '时间管理' },
            '电气性能测试_计划开始时间': { name: '电气性能测试_计划开始时间', type: 'date', group: '时间管理' },
            '电气性能测试_计划完成时间': { name: '电气性能测试_计划完成时间', type: 'date', group: '时间管理' },
            '电气性能测试_实际开始时间': { name: '电气性能测试_实际开始时间', type: 'date', group: '时间管理' },
            '电气性能测试_实际完成时间': { name: '电气性能测试_实际完成时间', type: 'date', group: '时间管理' },
            '电子工程师&DQE确认_开始时间': { name: '电子工程师&DQE确认_开始时间', type: 'date', group: '时间管理' },
            '电子工程师&DQE确认_完成时间': { name: '电子工程师&DQE确认_完成时间', type: 'date', group: '时间管理' },
            
            // 人员信息
            '测试人': { name: '测试人', type: 'select', group: '人员信息' },
            '电子工程师': { name: '电子工程师', type: 'select', group: '人员信息' },
            '项目工程师': { name: '项目工程师', type: 'select', group: '人员信息' },
            'DQE': { name: 'DQE', type: 'select', group: '人员信息' },
            
            // 状态信息
            '状态': { name: '状态', type: 'select', group: '状态信息' },
            '进度': { name: '进度', type: 'number', group: '状态信息' }
        };
        
        // 支持的操作符 - 根据字段类型动态显示
        const operators = {
            text: [
                { value: 'contains', label: '包含' },
                { value: 'not_contains', label: '不包含' },
                { value: 'equals', label: '等于' },
                { value: 'not_equals', label: '不等于' },
                { value: 'starts_with', label: '开始于' },
                { value: 'ends_with', label: '结束于' }
            ],
            number: [
                { value: 'equals', label: '等于' },
                { value: 'not_equals', label: '不等于' },
                { value: 'greater_than', label: '大于' },
                { value: 'less_than', label: '小于' },
                { value: 'greater_equal', label: '大于等于' },
                { value: 'less_equal', label: '小于等于' },
                { value: 'between', label: '介于' }
            ],
            date: [
                { value: 'equals', label: '等于' },
                { value: 'not_equals', label: '不等于' },
                { value: 'before', label: '早于' },
                { value: 'after', label: '晚于' },
                { value: 'between', label: '介于' },
                { value: 'today', label: '今天' },
                { value: 'this_week', label: '本周' },
                { value: 'this_month', label: '本月' }
            ],
            select: [
                { value: 'equals', label: '等于' },
                { value: 'not_equals', label: '不等于' },
                { value: 'contains_any', label: '包含任一' },
                { value: 'not_contains_any', label: '不包含任一' }
            ]
        };
        
        // 逻辑连接符
        const logicConnectors = ['且', '或'];
        
        // 字段分组配置
        const fieldGroups = {
            '基础信息': [
                '收样时间', '样品型号', '小编码', '样品名称', '供应商', '送样次数',
                '品类细分', '版本号', '测试编号', '样品分类', '样品性质', '项目属性',
                '内外贸区分', '需求耗时', '供应商前置', 'DQE品类细分', '新分类',
                '加急/同步', '是否在计划内', '送样备注'
            ],
            '时间管理': [
                '测试时长', '电气性能测试_计划开始时间', '电气性能测试_计划完成时间',
                '电气性能测试_实际开始时间', '电气性能测试_实际完成时间',
                '机械性能测试_计划开始时间', '机械性能测试_计划完成时间',
                '环境测试_计划开始时间', '环境测试_计划完成时间',
                '安全测试_计划开始时间', '安全测试_计划完成时间',
                'EMC测试_计划开始时间', 'EMC测试_计划完成时间',
                '可靠性测试_计划开始时间', '可靠性测试_计划完成时间'
            ],
            '人员信息': [
                '测试人', '电子工程师', '项目工程师', 'DQE', '责任人'
            ],
            '状态信息': [
                '项目状态', '进度', '测试结果', '判定结果', '问题状态'
            ]
        };
        
        // 字段类型检测
        function getFieldType(fieldName, sampleValue) {
            if (sampleValue === null || sampleValue === undefined) {
                return 'text';
            }
            
            const value = String(sampleValue);
            
            // 日期类型检测
            if (value.match(/^\d{4}-\d{2}-\d{2}/) || value.match(/^\d{4}\/\d{2}\/\d{2}/)) {
                return 'date';
            }
            
            // 数字类型检测
            if (!isNaN(value) && !isNaN(parseFloat(value))) {
                return 'number';
            }
            
            // 选择类型检测（基于字段名称和值）
            const selectFields = ['样品分类', '样品性质', 'DQE品类细分', '新分类', '项目状态'];
            if (selectFields.includes(fieldName)) {
                return 'select';
            }
            
            return 'text';
        }
        
        // 打开智能筛选配置
        function openSmartFilterConfig() {
            showSmartFilterModal('search');
        }
        
        // 打开去重配置
        function openDedupConfig() {
            showSmartFilterModal('dedup');
        }
        
        // 显示智能筛选模态框
        function showSmartFilterModal(type) {
            const modal = document.getElementById('smartFilterModal');
            if (!modal) {
                createSmartFilterModal();
            }
            
            // 设置模态框标题和类型
            const title = document.getElementById('smartFilterTitle');
            const configType = document.getElementById('configType');
            
            if (type === 'search') {
                title.textContent = '项目智能搜索配置';
                configType.value = 'search';
            } else {
                title.textContent = '去重智能筛选配置';
                configType.value = 'dedup';
            }
            
            // 显示模态框
            modal.style.display = 'block';
            
            // 加载当前配置
            loadCurrentConfig(type);
            
            // 初始化状态
            updateFilterStatus();
        }
        
        // 创建智能筛选模态框
        function createSmartFilterModal() {
            const modalHTML = `
                <div id="smartFilterModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 id="smartFilterTitle">智能筛选配置</h2>
                            <div class="header-actions">
                                <button class="btn btn-secondary" onclick="resetFilter()" title="重置筛选">
                                    🔄 重置
                                </button>
                                <span class="close" onclick="closeSmartFilterModal()">&times;</span>
                            </div>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="configType" value="search">
                            
                            <div class="filter-description">
                                配置筛选条件，支持多条件组合和复杂逻辑关系
                            </div>
                            
                            <!-- 筛选条件配置 -->
                            <div class="filter-conditions-container">
                                <div id="filterConditions" class="filter-conditions">
                                    <!-- 条件行将通过JavaScript动态生成 -->
                                </div>
                                
                                <div id="emptyState" class="empty-state" style="display: none;">
                                    <div class="empty-icon">🔍</div>
                                    <p>暂无筛选条件</p>
                                    <p class="empty-hint">点击"添加条件"开始配置筛选</p>
                                </div>
                                
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="addFilterCondition()">
                                        ➕ 添加条件
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 筛选模板 -->
                            <div class="template-section">
                                <div class="template-header">
                                    <h3>筛选模板</h3>
                                    <div class="template-controls">
                                        <input type="text" id="templateName" placeholder="输入模板名称" class="template-input">
                                        <button class="btn btn-success" onclick="saveTemplate()">保存模板</button>
                                    </div>
                                </div>
                                
                                <div class="template-list" id="templateList">
                                    <!-- 模板卡片将通过JavaScript动态生成 -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="footer-status">
                                <span id="filterStatus" class="status-indicator">无筛选条件</span>
                            </div>
                            <div class="footer-actions">
                                <button class="btn btn-secondary" onclick="closeSmartFilterModal()">取消</button>
                                <button class="btn btn-danger" onclick="clearFilter()">清空筛选</button>
                                <button class="btn btn-primary" onclick="applyFilter()">应用筛选</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 添加模态框样式
            const style = document.createElement('style');
            style.textContent = `
                .modal {
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                
                .modal-content {
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    position: relative;
                    width: 90%;
                    max-width: 1000px;
                    max-height: 90vh;
                    overflow-y: auto;
                }
                
                .modal-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px 15px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .modal-header h2 {
                    margin: 0;
                    font-size: 1.5em;
                }
                
                .close {
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                    color: white;
                }
                
                .close:hover {
                    opacity: 0.7;
                }
                
                .modal-body {
                    padding: 30px;
                }
                
                .modal-footer {
                    background: #f8f9fa;
                    padding: 20px 30px;
                    border-radius: 0 0 15px 15px;
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                }
                
                .filter-conditions {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                }
                
                .condition-row {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    margin-bottom: 15px;
                    padding: 15px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                
                .condition-row:last-child {
                    margin-bottom: 0;
                }
                
                .logic-connector {
                    min-width: 80px;
                }
                
                .field-select, .operator-select, .value-input {
                    flex: 1;
                    padding: 10px;
                    border: 2px solid #e1e5e9;
                    border-radius: 6px;
                    font-size: 14px;
                    transition: border-color 0.3s;
                }
                
                .field-select:focus, .operator-select:focus, .value-input:focus {
                    outline: none;
                    border-color: #667eea;
                }
                
                .searchable-dropdown {
                    position: relative;
                    width: 100%;
                }
                
                .search-input {
                    width: 100%;
                    padding: 10px 40px 10px 10px;
                    border: 2px solid #e1e5e9;
                    border-radius: 6px;
                    font-size: 14px;
                }
                
                .search-icon {
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: #666;
                }
                
                .dropdown-list {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 2px solid #e1e5e9;
                    border-top: none;
                    border-radius: 0 0 6px 6px;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                }
                
                .dropdown-item {
                    padding: 10px;
                    cursor: pointer;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .dropdown-item:hover {
                    background: #f8f9fa;
                }
                
                .dropdown-item:last-child {
                    border-bottom: none;
                }
                
                .action-buttons {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                }
                
                .template-section {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                }
                
                .template-controls {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                
                .template-list {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                    gap: 15px;
                }
                
                .template-card {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    border: 2px solid transparent;
                    transition: all 0.3s;
                    cursor: pointer;
                }
                
                .template-card:hover {
                    border-color: #667eea;
                }
                
                .template-card.selected {
                    border-color: #667eea;
                    background: #f8f9ff;
                }
                
                .template-card.preset-template {
                    border-left: 4px solid #28a745;
                }
                
                .template-card.user-template {
                    border-left: 4px solid #667eea;
                }
                
                .preset-badge {
                    background: #28a745;
                    color: white;
                    font-size: 10px;
                    padding: 2px 6px;
                    border-radius: 10px;
                    margin-left: 8px;
                }
                
                .template-actions {
                    margin-top: 10px;
                    text-align: right;
                }
                
                .header-actions {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .filter-description {
                    padding: 15px 20px;
                    background: #f8f9fa;
                    border-bottom: 1px solid #e5e7eb;
                    color: #6b7280;
                    font-size: 14px;
                }
                
                .filter-conditions-container {
                    padding: 20px;
                }
                
                .empty-state {
                    text-align: center;
                    padding: 40px 20px;
                    color: #6b7280;
                }
                
                .empty-icon {
                    font-size: 48px;
                    margin-bottom: 16px;
                    opacity: 0.5;
                }
                
                .empty-hint {
                    font-size: 12px;
                    margin-top: 8px;
                    opacity: 0.8;
                }
                
                .template-section {
                    border-top: 1px solid #e5e7eb;
                    padding: 20px;
                    background: #f8f9fa;
                }
                
                .template-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                }
                
                .template-header h3 {
                    margin: 0;
                    color: #374151;
                }
                
                .template-controls {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                }
                
                .template-input {
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                    width: 200px;
                }
                
                .modal-footer {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-top: 1px solid #e5e7eb;
                    background: #f9fafb;
                }
                
                .footer-status {
                    flex: 1;
                }
                
                .status-indicator {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 500;
                }
                
                .footer-actions {
                    display: flex;
                    gap: 10px;
                }
                
                .condition-card {
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                
                .condition-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 20px;
                    border-bottom: 1px solid #f3f4f6;
                    background: #f8f9fa;
                }
                
                .condition-title {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .condition-label {
                    font-weight: 600;
                    color: #374151;
                }
                
                .condition-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .btn-icon {
                    background: none;
                    border: none;
                    padding: 6px;
                    border-radius: 4px;
                    cursor: pointer;
                    color: #6b7280;
                    transition: all 0.2s;
                }
                
                .btn-icon:hover {
                    background: #f3f4f6;
                    color: #374151;
                }
                
                .btn-icon.danger:hover {
                    background: #fef2f2;
                    color: #dc2626;
                }
                
                .condition-content {
                    padding: 20px;
                }
                
                .condition-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr 2fr;
                    gap: 20px;
                    align-items: end;
                }
                
                .condition-field, .condition-operator, .condition-value {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .condition-field label, .condition-operator label, .condition-value label {
                    font-size: 12px;
                    font-weight: 600;
                    color: #6b7280;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .smart-field-selector, .smart-value-selector {
                    position: relative;
                }
                
                .smart-field-selector select, .smart-value-selector input {
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                    transition: border-color 0.2s;
                }
                
                .smart-field-selector select:focus, .smart-value-selector input:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                }
                
                .empty-templates {
                    text-align: center;
                    padding: 40px 20px;
                    color: #6b7280;
                }
                
                .template-card {
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .template-card:hover {
                    border-color: #3b82f6;
                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
                }
                
                .template-card.selected {
                    border-color: #3b82f6;
                    background: #f0f9ff;
                }
                
                .template-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 20px;
                    border-bottom: 1px solid #f3f4f6;
                }
                
                .template-name {
                    font-weight: 600;
                    color: #374151;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .template-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .template-content {
                    padding: 15px 20px;
                }
                
                .template-description {
                    color: #6b7280;
                    font-size: 14px;
                    margin-bottom: 10px;
                }
                
                .template-meta {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 12px;
                    color: #9ca3af;
                }
                
                .template-rules {
                    background: #f3f4f6;
                    padding: 2px 6px;
                    border-radius: 4px;
                }
                
                .template-date {
                    color: #9ca3af;
                }
                
                .template-name {
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                
                .template-description {
                    color: #666;
                    font-size: 12px;
                    margin-bottom: 10px;
                }
                
                .template-rules {
                    font-size: 12px;
                    color: #888;
                }
                
                .btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.3s;
                }
                
                .btn-primary {
                    background: #667eea;
                    color: white;
                }
                
                .btn-primary:hover {
                    background: #5a6fd8;
                }
                
                .btn-secondary {
                    background: #6c757d;
                    color: white;
                }
                
                .btn-secondary:hover {
                    background: #5a6268;
                }
                
                .btn-danger {
                    background: #dc3545;
                    color: white;
                }
                
                .btn-danger:hover {
                    background: #c82333;
                }
                
                .btn-success {
                    background: #28a745;
                    color: white;
                }
                
                .btn-success:hover {
                    background: #218838;
                }
                
                .btn-sm {
                    padding: 5px 10px;
                    font-size: 12px;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 关闭智能筛选模态框
        function closeSmartFilterModal() {
            const modal = document.getElementById('smartFilterModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 添加筛选条件
        function addFilterCondition() {
            const conditionsContainer = document.getElementById('filterConditions');
            const conditionId = Date.now();
            
            const conditionRow = document.createElement('div');
            conditionRow.className = 'condition-card';
            conditionRow.id = `condition-${conditionId}`;
            
            conditionRow.innerHTML = `
                <div class="condition-header">
                    <div class="condition-title">
                        ${conditionsContainer.children.length > 0 ? createLogicConnectorSelect(conditionId) : ''}
                        <span class="condition-label">条件 ${conditionsContainer.children.length + 1}</span>
                    </div>
                    <div class="condition-actions">
                        <button class="btn-icon" onclick="toggleCondition(${conditionId})" title="展开/收起">
                            <span class="toggle-icon">▼</span>
                        </button>
                        <button class="btn-icon danger" onclick="removeCondition(${conditionId})" title="删除条件">
                            🗑️
                        </button>
                    </div>
                </div>
                <div class="condition-content">
                    <div class="condition-grid">
                        <div class="condition-field">
                            <label>字段</label>
                            <div class="smart-field-selector">
                                <select class="field-select" onchange="onFieldChange(${conditionId})">
                                    ${createGroupedFieldSelector(conditionId)}
                                </select>
                            </div>
                        </div>
                        
                        <div class="condition-operator">
                            <label>操作符</label>
                            <select class="operator-select" onchange="onOperatorChange(${conditionId})">
                                <option value="">选择操作符</option>
                            </select>
                        </div>
                        
                        <div class="condition-value">
                            <label>值</label>
                            <div class="smart-value-selector">
                                <input type="text" class="value-input" placeholder="输入值" 
                                       onkeyup="onValueInput(${conditionId}, this.value)"
                                       onfocus="showDropdown(${conditionId})"
                                       onblur="hideDropdown(${conditionId})">
                                <div class="dropdown-list" id="dropdown-${conditionId}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            conditionsContainer.appendChild(conditionRow);
            updateFilterStatus();
        }
        
        // 创建逻辑连接符选择器
        function createLogicConnectorSelect(conditionId) {
            return `
                <select class="operator-select" onchange="updateLogicConnector(${conditionId}, this.value)">
                    ${logicConnectors.map(conn => `<option value="${conn}">${conn}</option>`).join('')}
                </select>
            `;
        }
        
        // 获取可用字段（按分组）
        function getAvailableFields() {
            if (currentData.length === 0) return [];
            const allFields = Object.keys(currentData[0]);
            const groupedFields = {};
            
            // 按分组组织字段
            Object.entries(fieldGroups).forEach(([groupName, groupFields]) => {
                const availableFields = groupFields.filter(field => allFields.includes(field));
                if (availableFields.length > 0) {
                    groupedFields[groupName] = availableFields;
                }
            });
            
            // 添加未分组的字段
            const ungroupedFields = allFields.filter(field => 
                !Object.values(fieldGroups).flat().includes(field)
            );
            if (ungroupedFields.length > 0) {
                groupedFields['其他字段'] = ungroupedFields;
            }
            
            return groupedFields;
        }
        
        // 创建分组字段选择器
        function createGroupedFieldSelector(conditionId) {
            const groupedFields = getAvailableFields();
            let html = '<option value="">选择字段</option>';
            
            Object.entries(groupedFields).forEach(([groupName, fields]) => {
                html += `<optgroup label="${groupName}">`;
                fields.forEach(field => {
                    html += `<option value="${field}">${field}</option>`;
                });
                html += '</optgroup>';
            });
            
            return html;
        }
        
        // 字段变化处理
        function onFieldChange(conditionId) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const fieldSelect = conditionRow.querySelector('.field-select');
            const operatorSelect = conditionRow.querySelector('.operator-select');
            const selectedField = fieldSelect.value;
            
            if (selectedField) {
                // 检测字段类型并更新操作符
                const sampleValue = currentData.length > 0 ? currentData[0][selectedField] : null;
                const fieldType = getFieldType(selectedField, sampleValue);
                updateOperatorOptions(operatorSelect, fieldType);
                
                // 加载字段值
                loadFieldValues(selectedField, conditionId);
            }
        }
        
        // 更新操作符选项
        function updateOperatorOptions(operatorSelect, fieldType) {
            const typeOperators = operators[fieldType] || operators.text;
            operatorSelect.innerHTML = '<option value="">选择操作符</option>' +
                typeOperators.map(op => `<option value="${op.value}">${op.label}</option>`).join('');
        }
        
        // 切换条件展开/收起
        function toggleCondition(conditionId) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const content = conditionRow.querySelector('.condition-content');
            const toggleIcon = conditionRow.querySelector('.toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleIcon.textContent = '▼';
            } else {
                content.style.display = 'none';
                toggleIcon.textContent = '▶';
            }
        }
        
        // 更新筛选状态
        function updateFilterStatus() {
            const conditionsContainer = document.getElementById('filterConditions');
            const statusElement = document.getElementById('filterStatus');
            const emptyState = document.getElementById('emptyState');
            const conditionCount = conditionsContainer.children.length;
            
            // 更新状态指示器
            if (conditionCount === 0) {
                statusElement.textContent = '无筛选条件';
                statusElement.className = 'status-indicator';
                if (emptyState) emptyState.style.display = 'block';
            } else {
                statusElement.textContent = `${conditionCount} 个筛选条件`;
                statusElement.className = 'status-indicator';
                if (emptyState) emptyState.style.display = 'none';
            }
        }
        
        // 重置筛选
        function resetFilter() {
            const conditionsContainer = document.getElementById('filterConditions');
            conditionsContainer.innerHTML = '';
            updateFilterStatus();
        }
        
        // 加载字段值
        function loadFieldValues(field, conditionId) {
            const values = getFieldValues(field);
            const dropdown = document.getElementById(`dropdown-${conditionId}`);
            
            dropdown.innerHTML = values.map(value => 
                `<div class="dropdown-item" onclick="selectValue(${conditionId}, '${value}')">${value}</div>`
            ).join('');
        }
        
        // 获取字段值
        function getFieldValues(field, searchTerm = '') {
            if (currentData.length === 0) return [];
            
            const values = [...new Set(currentData.map(record => record[field]).filter(v => v !== null && v !== undefined && v !== ''))];
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                return values.filter(v => String(v).toLowerCase().includes(term));
            }
            
            return values.sort();
        }
        
        // 值输入处理
        function onValueInput(conditionId, value) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const fieldSelect = conditionRow.querySelector('.field-select');
            const selectedField = fieldSelect.value;
            
            if (selectedField && value) {
                loadFieldValues(selectedField, conditionId);
                showDropdown(conditionId);
            }
        }
        
        // 显示下拉列表
        function showDropdown(conditionId) {
            const dropdown = document.getElementById(`dropdown-${conditionId}`);
            dropdown.style.display = 'block';
        }
        
        // 隐藏下拉列表
        function hideDropdown(conditionId) {
            setTimeout(() => {
                const dropdown = document.getElementById(`dropdown-${conditionId}`);
                dropdown.style.display = 'none';
            }, 200);
        }
        
        // 选择值
        function selectValue(conditionId, value) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            const valueInput = conditionRow.querySelector('.search-input');
            valueInput.value = value;
            hideDropdown(conditionId);
        }
        
        // 删除条件
        function removeCondition(conditionId) {
            const conditionRow = document.getElementById(`condition-${conditionId}`);
            conditionRow.remove();
        }
        
        // 清空所有条件
        function clearAllConditions() {
            if (confirm('确定要清空所有条件吗？')) {
                document.getElementById('filterConditions').innerHTML = '';
            }
        }
        
        // 加载当前配置
        function loadCurrentConfig(type) {
            // 加载预设模板
            loadPresetTemplates();
            // 加载用户模板
            loadTemplates();
            console.log('加载配置类型:', type);
        }
        
        // 加载预设模板
        function loadPresetTemplates() {
            const presetTemplates = {
                '近期项目': {
                    name: '近期项目',
                    description: '筛选最近30天的项目',
                    rules: [
                        {
                            field: '收样时间',
                            operator: 'after',
                            value: '30天前',
                            logic_connector: '且'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                '紧急项目': {
                    name: '紧急项目',
                    description: '筛选加急或同步项目',
                    rules: [
                        {
                            field: '加急/同步',
                            operator: 'contains',
                            value: '加急',
                            logic_connector: '或'
                        },
                        {
                            field: '加急/同步',
                            operator: 'contains',
                            value: '同步',
                            logic_connector: '或'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                '特定供应商项目': {
                    name: '特定供应商项目',
                    description: '筛选特定供应商的项目',
                    rules: [
                        {
                            field: '供应商',
                            operator: 'contains',
                            value: '供应商A',
                            logic_connector: '且'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                '电气测试项目': {
                    name: '电气测试项目',
                    description: '筛选电气测试相关项目',
                    rules: [
                        {
                            field: '样品分类',
                            operator: 'contains',
                            value: '电气',
                            logic_connector: '且'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                },
                'NW系列项目': {
                    name: 'NW系列项目',
                    description: '筛选NW系列样品项目',
                    rules: [
                        {
                            field: '样品型号',
                            operator: 'starts_with',
                            value: 'NW',
                            logic_connector: '且'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    isPreset: true
                }
            };
            
            // 将预设模板添加到配置中
            Object.entries(presetTemplates).forEach(([name, template]) => {
                if (!smartFilterConfig.templates[name]) {
                    smartFilterConfig.templates[name] = template;
                }
            });
        }
        
        // 保存模板
        function saveTemplate() {
            const templateName = prompt('请输入模板名称:');
            if (!templateName) return;
            
            const templateDescription = prompt('请输入模板描述（可选）:') || '';
            const conditions = collectConditions();
            
            const template = {
                name: templateName,
                description: templateDescription,
                rules: conditions,
                created_at: new Date().toISOString()
            };
            
            smartFilterConfig.templates[templateName] = template;
            loadTemplates();
            alert('模板保存成功！');
        }
        
        // 加载模板
        function loadTemplate() {
            const templateSelect = document.getElementById('templateSelect');
            const selectedTemplate = templateSelect.value;
            
            if (!selectedTemplate) {
                alert('请先选择一个模板');
                return;
            }
            
            const template = smartFilterConfig.templates[selectedTemplate];
            if (template) {
                loadTemplateConditions(template);
            }
        }
        
        // 删除模板
        function deleteTemplate(templateName) {
            const template = smartFilterConfig.templates[templateName];
            
            if (!template) {
                alert('模板不存在');
                return;
            }
            
            if (template.isPreset) {
                alert('预设模板不能删除');
                return;
            }
            
            if (confirm(`确定要删除模板 "${templateName}" 吗？`)) {
                delete smartFilterConfig.templates[templateName];
                loadTemplates();
                alert('模板删除成功！');
            }
        }
        
        // 加载模板列表
        function loadTemplates() {
            const templateList = document.getElementById('templateList');
            
            if (!templateList) return;
            
            // 更新模板列表
            const templates = Object.entries(smartFilterConfig.templates);
            
            if (templates.length === 0) {
                templateList.innerHTML = `
                    <div class="empty-templates">
                        <div class="empty-icon">📋</div>
                        <p>暂无筛选模板</p>
                        <p class="empty-hint">配置筛选条件后可以保存为模板</p>
                    </div>
                `;
                return;
            }
            
            templateList.innerHTML = templates.map(([name, template]) => `
                <div class="template-card ${template.isPreset ? 'preset-template' : 'user-template'}" onclick="selectTemplate('${name}')">
                    <div class="template-header">
                        <div class="template-name">
                            ${name}
                            ${template.isPreset ? '<span class="preset-badge">预设</span>' : ''}
                        </div>
                        <div class="template-actions">
                            <button class="btn-icon" onclick="applyTemplate('${name}')" title="应用模板">
                                ✅
                            </button>
                            ${!template.isPreset ? `
                                <button class="btn-icon danger" onclick="deleteTemplate('${name}')" title="删除模板">
                                    🗑️
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="template-content">
                        <div class="template-description">${template.description || '无描述'}</div>
                        <div class="template-meta">
                            <span class="template-rules">${template.rules ? template.rules.length : 0} 条规则</span>
                            <span class="template-date">${template.created_at ? new Date(template.created_at).toLocaleDateString() : ''}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 选择模板
        function selectTemplate(templateName) {
            const template = smartFilterConfig.templates[templateName];
            if (template) {
                loadTemplateConditions(template);
            }
        }
        
        // 应用模板
        function applyTemplate(templateName) {
            const template = smartFilterConfig.templates[templateName];
            if (template) {
                loadTemplateConditions(template);
                alert(`已应用模板: ${templateName}`);
            }
        }
        
        // 收集条件
        function collectConditions() {
            const conditions = [];
            const conditionRows = document.querySelectorAll('.condition-row');
            
            conditionRows.forEach((row, index) => {
                const fieldSelect = row.querySelector('.field-select');
                const operatorSelect = row.querySelector('.operator-select');
                const valueInput = row.querySelector('.search-input');
                const logicSelect = row.querySelector('.logic-connector select');
                
                if (fieldSelect.value && operatorSelect.value && valueInput.value) {
                    conditions.push({
                        field: fieldSelect.value,
                        operator: operatorSelect.value,
                        value: valueInput.value,
                        logic_connector: logicSelect ? logicSelect.value : '且'
                    });
                }
            });
            
            return conditions;
        }
        
        // 加载模板条件
        function loadTemplateConditions(template) {
            // 清空现有条件
            clearAllConditions();
            
            // 添加条件
            template.rules.forEach((rule, index) => {
                if (index > 0) addFilterCondition();
                
                const conditionRow = document.querySelector('.condition-row:last-child');
                if (conditionRow) {
                    const fieldSelect = conditionRow.querySelector('.field-select');
                    const operatorSelect = conditionRow.querySelector('.operator-select');
                    const valueInput = conditionRow.querySelector('.search-input');
                    const logicSelect = conditionRow.querySelector('.logic-connector select');
                    
                    fieldSelect.value = rule.field;
                    operatorSelect.value = rule.operator;
                    valueInput.value = rule.value;
                    if (logicSelect) logicSelect.value = rule.logic_connector;
                }
            });
        }
        
        // 应用筛选
        function applyFilter() {
            const conditions = collectConditions();
            const configType = document.getElementById('configType').value;
            
            if (conditions.length === 0) {
                alert('请至少添加一个筛选条件');
                return;
            }
            
            console.log('应用筛选:', { type: configType, conditions });
            
            // 根据配置类型应用不同的筛选逻辑
            if (configType === 'search') {
                applySearchFilter(conditions);
            } else {
                applyDedupFilter(conditions);
            }
            
            closeSmartFilterModal();
        }
        
        // 应用搜索筛选
        function applySearchFilter(conditions) {
            let filteredData = [...currentData];
            
            conditions.forEach(condition => {
                filteredData = filteredData.filter(record => {
                    const fieldValue = record[condition.field];
                    const conditionValue = condition.value;
                    
                    return evaluateCondition(fieldValue, condition.operator, conditionValue);
                });
            });
            
            // 更新搜索结果
            updateSearchResults(filteredData);
            alert(`搜索完成！找到 ${filteredData.length} 条匹配记录`);
        }
        
        // 条件评估函数
        function evaluateCondition(fieldValue, operator, conditionValue) {
            if (fieldValue === null || fieldValue === undefined) {
                return false;
            }
            
            const fieldStr = String(fieldValue);
            const conditionStr = String(conditionValue);
            
            switch (operator) {
                // 文本操作符
                case 'contains':
                    return fieldStr.includes(conditionStr);
                case 'not_contains':
                    return !fieldStr.includes(conditionStr);
                case 'equals':
                    return fieldStr === conditionStr;
                case 'not_equals':
                    return fieldStr !== conditionStr;
                case 'starts_with':
                    return fieldStr.startsWith(conditionStr);
                case 'ends_with':
                    return fieldStr.endsWith(conditionStr);
                
                // 数字操作符
                case 'greater_than':
                    return parseFloat(fieldStr) > parseFloat(conditionStr);
                case 'less_than':
                    return parseFloat(fieldStr) < parseFloat(conditionStr);
                case 'greater_equal':
                    return parseFloat(fieldStr) >= parseFloat(conditionStr);
                case 'less_equal':
                    return parseFloat(fieldStr) <= parseFloat(conditionStr);
                
                // 日期操作符
                case 'before':
                    return new Date(fieldStr) < new Date(conditionStr);
                case 'after':
                    return new Date(fieldStr) > new Date(conditionStr);
                case 'today':
                    const today = new Date().toDateString();
                    return new Date(fieldStr).toDateString() === today;
                case 'this_week':
                    const now = new Date();
                    const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                    return new Date(fieldStr) >= weekStart;
                case 'this_month':
                    const thisMonth = new Date().getMonth();
                    return new Date(fieldStr).getMonth() === thisMonth;
                
                // 选择操作符
                case 'contains_any':
                    const values = conditionStr.split(',').map(v => v.trim());
                    return values.some(v => fieldStr.includes(v));
                case 'not_contains_any':
                    const values2 = conditionStr.split(',').map(v => v.trim());
                    return !values2.some(v => fieldStr.includes(v));
                
                default:
                    return true;
            }
        }
        
        // 应用去重筛选
        function applyDedupFilter(conditions) {
            // 创建去重键
            const dedupKeys = new Map();
            const uniqueData = [];
            
            currentData.forEach(record => {
                const key = conditions.map(condition => 
                    `${condition.field}:${record[condition.field] || ''}`
                ).join('|');
                
                if (!dedupKeys.has(key)) {
                    dedupKeys.set(key, true);
                    uniqueData.push(record);
                }
            });
            
            // 更新搜索结果
            updateSearchResults(uniqueData);
            alert(`去重完成！原始记录 ${currentData.length} 条，去重后 ${uniqueData.length} 条，移除 ${currentData.length - uniqueData.length} 条重复记录`);
        }
        
        // 更新搜索结果
        function updateSearchResults(data) {
            // 这里可以更新界面显示搜索结果
            console.log('更新搜索结果:', data.length, '条记录');
            // 可以调用现有的搜索结果显示函数
        }
        
        // 清空筛选
        function clearFilter() {
            if (confirm('确定要清空所有筛选条件吗？')) {
                clearAllConditions();
            }
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('smartFilterModal');
            if (event.target === modal) {
                closeSmartFilterModal();
            }
        };
    </script>
</body>
</html>
</html>