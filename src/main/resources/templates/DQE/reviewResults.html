<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新品质量问题管理</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Chart.js数据标签插件 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/reviewResultsStyle.css">
    <!-- 引入jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 引入钉钉JSAPI -->
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>

    <!-- 自定义提示框样式 -->
    <style>
        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .custom-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-content {
            display: flex;
            align-items: center;
            padding: 16px;
            position: relative;
        }

        .toast-icon {
            color: #28a745;
            font-size: 20px;
            margin-right: 12px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            color: #999;
            font-size: 12px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .toast-close:hover {
            background-color: #f5f5f5;
            color: #666;
        }

        .custom-toast.success .toast-icon {
            color: #28a745;
        }

        .custom-toast.error .toast-icon {
            color: #dc3545;
        }

        .custom-toast.warning .toast-icon {
            color: #ffc107;
        }

        .custom-toast.info .toast-icon {
            color: #17a2b8;
        }

        .copyable-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .copyable-modal-content {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            width: 520px;
            max-width: calc(100% - 40px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .copyable-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copyable-modal-header h4 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .copyable-modal-close {
            cursor: pointer;
            color: #999;
            font-size: 18px;
            transition: color 0.2s ease;
        }

        .copyable-modal-close:hover {
            color: #333;
        }

        .copyable-modal-textarea {
            width: 100%;
            min-height: 160px;
            resize: vertical;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background: #fafafa;
        }

        .copyable-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 问题图片容器样式 */
        .problem-image-container {
            max-width: 100%;
            margin-top: 8px;
        }

        .problem-image-container img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 5px 0;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .problem-image-container img:hover {
            transform: scale(1.02);
        }

        .problem-image-container .no-image {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
            border: 1px dashed #ddd;
            border-radius: 4px;
        }

        .problem-image-container .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .problem-image-container .image-item {
            position: relative;
            display: inline-block;
        }

        .problem-image-container .image-item img {
            display: block;
            margin: 0;
        }

        /* 图片编辑容器样式 */
        .image-edit-container {
            width: 100%;
        }

        .image-edit-container textarea {
            width: 100%;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        .image-preview {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-height: 60px;
        }

        .image-preview .preview-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .image-preview .preview-item {
            position: relative;
            display: inline-block;
        }

        .image-preview .preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .image-preview .preview-item .remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .image-preview .preview-item:hover .remove-btn {
            display: block;
        }

        .image-edit-tips {
            margin-top: 5px;
            color: #666;
        }

        .image-edit-tips small {
            font-size: 11px;
        }

        /* 新品质量详情编辑模式样式 */
        .detail-content {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .detail-section h3 {
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .detail-item label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .detail-item span,
        .detail-item .problem-desc {
            color: #333;
            padding: 8px 12px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-height: 38px;
            display: flex;
            align-items: center;
            word-break: break-word;
        }

        .detail-item .problem-desc {
            min-height: 60px;
            white-space: pre-wrap;
        }

        /* 编辑模式样式 */
        .detail-item input,
        .detail-item textarea,
        .detail-item select {
            padding: 8px 12px;
            border: 1px solid #007bff;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .detail-item input:focus,
        .detail-item textarea:focus,
        .detail-item select:focus {
            outline: 0;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .detail-item textarea {
            resize: vertical;
            min-height: 80px;
        }

        .detail-item select {
            cursor: pointer;
        }

        /* 编辑状态下的只读字段样式 */
        .detail-item.readonly span,
        .detail-item.readonly .problem-desc {
            background-color: #f8f9fa;
            color: #6c757d;
            border-color: #e9ecef;
            cursor: not-allowed;
        }

        /* 收藏夹模态框样式修复 */
        .cart-items-container {
            margin-top: 20px;
        }

        .cart-items-container .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .cart-items-container .data-table th,
        .cart-items-container .data-table td {
            padding: 12px 8px;
            text-align: left;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
        }

        .cart-items-container .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cart-items-container .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .cart-items-container .data-table tbody tr:hover td {
            background-color: #f5f5f5;
            color: #333;
        }

        .cart-items-container .filter-desc {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333 !important;
        }







        /* 合并数据展示区域样式 */
        .merged-data-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .merged-data-section h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .merged-stats {
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .merged-stats span {
            color: #495057;
            font-size: 14px;
        }

        .merged-stats strong {
            color: #007bff;
            font-weight: bold;
        }

        .merged-table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .merged-table-container .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            min-width: 100%;
        }

        .merged-table-container .data-table th,
        .merged-table-container .data-table td {
            padding: 8px 6px;
            text-align: left;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            font-size: 12px;
            white-space: nowrap;
        }

        .merged-table-container .data-table th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 固定前4列：ID、发生日期、大编码、小编码 */
        .merged-table-container .data-table th:nth-child(1),
        .merged-table-container .data-table td:nth-child(1) {
            position: sticky;
            left: 0;
            background-color: #e9ecef;
            z-index: 50;
            min-width: 60px;
            max-width: 60px;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
        }

        .merged-table-container .data-table th:nth-child(1) {
            z-index: 101;
            background-color: #e9ecef !important;
        }

        .merged-table-container .data-table th:nth-child(2),
        .merged-table-container .data-table td:nth-child(2) {
            position: sticky;
            left: 60px; /* ID列宽度 */
            background-color: #e9ecef;
            z-index: 50;
            min-width: 120px;
            max-width: 120px;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
        }

        .merged-table-container .data-table th:nth-child(2) {
            z-index: 101;
            background-color: #e9ecef !important;
        }

        .merged-table-container .data-table th:nth-child(3),
        .merged-table-container .data-table td:nth-child(3) {
            position: sticky;
            left: 180px; /* ID + 发生日期列宽度 */
            background-color: #e9ecef;
            z-index: 50;
            min-width: 100px;
            max-width: 100px;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
        }

        .merged-table-container .data-table th:nth-child(3) {
            z-index: 101;
            background-color: #e9ecef !important;
        }

        .merged-table-container .data-table th:nth-child(4),
        .merged-table-container .data-table td:nth-child(4) {
            position: sticky;
            left: 280px; /* ID + 发生日期 + 大编码列宽度 */
            background-color: #e9ecef;
            z-index: 50;
            min-width: 100px;
            max-width: 100px;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
        }

        .merged-table-container .data-table th:nth-child(4) {
            z-index: 101;
            background-color: #e9ecef !important;
        }

        /* 悬停时固定列的背景色 */
        .merged-table-container .data-table tbody tr:hover td:nth-child(1),
        .merged-table-container .data-table tbody tr:hover td:nth-child(2),
        .merged-table-container .data-table tbody tr:hover td:nth-child(3),
        .merged-table-container .data-table tbody tr:hover td:nth-child(4) {
            background-color: #f5f5f5 !important;
        }

        .merged-table-container .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .merged-table-container .data-table tbody tr:hover td {
            background-color: #f5f5f5;
            color: #333;
        }

        .merged-table-container .problem-desc {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333 !important;
        }

        /* 头部布局样式 */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-left {
            flex: 0 0 auto;
        }

        .header-center {
            flex: 1;
            text-align: center;
            margin-right: 100px;
        }

        .header-right {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        /* 头部操作按钮样式 */
        .header-action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-action-buttons .btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* 新增数据按钮自定义样式 */
        #addNewBtn {
            background: linear-gradient(135deg, #052efa, #20c997);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
        }

        #addNewBtn:hover {
            background: linear-gradient(135deg, #052efa, #1ea085);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
        }

        #addNewBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        /* 删除选中数据按钮自定义样式 */
        #deleteSelectedBtn {
            background: linear-gradient(135deg, #dc3545, #d03ce7);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
        }

        #deleteSelectedBtn:hover {
            background: linear-gradient(135deg, #c82333, #d03ce7);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
        }

        #deleteSelectedBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }

        /* 删除全部搜索结果按钮自定义样式 - 已注释，操作过于危险 */
        /*
        #deleteAllResultsBtn {
            background: linear-gradient(135deg, #dc3545, #721c24);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
        }

        #deleteAllResultsBtn:hover {
            background: linear-gradient(135deg, #c82333, #5a1a1a);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
        }

        #deleteAllResultsBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        */

        /* 导出全部筛选结果按钮自定义样式 */
        #exportAllResultsBtn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
            transition: all 0.3s ease;
        }

        #exportAllResultsBtn:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.4);
        }

        #exportAllResultsBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
        }

        /* 查看收藏夹按钮自定义样式 */
        #showCartBtn {
            background: linear-gradient(135deg, #f5c800, #495057);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
            transition: all 0.3s ease;
        }

        #showCartBtn:hover {
            background: linear-gradient(135deg, #f5c800, #3d4043);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.4);
        }

        #showCartBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }

        /* 导入按钮样式 */
        .header-left .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
        }

        .header-left .btn:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }

        .header-left .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        /* 导入模态框样式 */
        .import-container {
            display: flex;
            gap: 30px;
            padding: 20px 0;
        }

        .template-section, .upload-section {
            flex: 1;
            padding: 20px;
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            text-align: center;
            background: #fafafa;
        }

        .template-section h3, .upload-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .template-section p, .upload-section p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .template-info {
            margin-top: 15px;
            color: #888;
        }

        /* 导入规则说明样式 */
        .import-rules {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
        }

        .import-rules h4 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-rules-content {
            color: #856404;
            font-size: 13px;
            line-height: 1.8;
        }

        .import-rules-content .rule-item {
            margin: 8px 0;
            padding-left: 8px;
        }

        .import-rules-content .rule-item strong {
            color: #664d03;
        }

        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px 20px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .upload-area i {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 15px;
        }

        .file-info {
            color: #6c757d;
            font-size: 12px;
            margin-top: 10px;
        }

        .upload-progress {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* 搜索和重置按钮样式 */
        .search-reset-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .search-reset-buttons .btn {
            padding: 10px 20px;
            position: relative;
        }

        .shortcut-hint {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-left: 5px;
            font-weight: normal;
        }

        .btn:hover .shortcut-hint {
            color: rgba(255, 255, 255, 0.9);
        }

        /* 收藏夹控制按钮样式 */
        .cart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .cart-controls .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* 表格复选框样式 */
        .table-row-checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }

        .table-row-checkbox:hover {
            transform: scale(1.3);
        }

        #selectAllTableRows {
            transform: scale(1.3);
            cursor: pointer;
        }

        #selectAllTableRows:hover {
            transform: scale(1.4);
        }

        /* 表格行选中状态样式 */
        tr:has(.table-row-checkbox:checked) {
            background-color: #e3f2fd !important;
        }

        tr:has(.table-row-checkbox:checked):hover {
            background-color: #bbdefb !important;
        }

        /* 兼容性更好的选中行样式 */
        .table-row-selected {
            background-color: #e3f2fd !important;
        }

        .table-row-selected:hover {
            background-color: #bbdefb !important;
        }

        .table-row-selected td {
            background-color: #e3f2fd !important;
        }

        .table-row-selected:hover td {
            background-color: #bbdefb !important;
        }

        /* 收藏夹详情模态框样式 */
        .cart-detail-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .cart-detail-info .detail-row {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .cart-detail-info .detail-row:last-child {
            margin-bottom: 0;
        }

        .cart-detail-info label {
            font-weight: bold;
            color: #495057;
            min-width: 100px;
            margin-right: 10px;
        }

        .cart-detail-info .detail-value {
            color: #333;
            flex: 1;
            word-break: break-all;
        }

        .cart-detail-table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .cart-detail-table-container .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .cart-detail-table-container .data-table th,
        .cart-detail-table-container .data-table td {
            padding: 8px 6px;
            text-align: left;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            font-size: 12px;
        }

        .cart-detail-table-container .data-table th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cart-detail-table-container .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .cart-detail-table-container .data-table tbody tr:hover td {
            background-color: #f5f5f5;
            color: #333;
        }

        .cart-detail-table-container .problem-desc {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333 !important;
        }

        /* 主控制区域样式 */
        .main-control-section {
            display: grid;
            grid-template-columns: 400px 1fr; /* 左侧固定宽度，右侧占据剩余空间 */
            gap: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px; /* 削减最小高度从600px到400px */
        }

        /* 筛选区域铺满页面宽度 */
        .filter-section {
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            max-width: 100% !important;
            display: flex;
            gap: 20px;
            align-items: stretch; /* 确保两个容器高度一致 */
        }

        /* 组别统计展示区域 */
        .group-stats-container {
            flex: 0 0 50%;
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 100%; /* 确保最小高度填满 */
        }

        .group-stats-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-selector-wrapper {
            flex: 0 0 auto;
            margin-left: 15px;
        }

        .group-selector {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .group-selector:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .group-stats-display {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .group-stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            transition: all 0.3s ease;
            border-left: 3px solid #007bff;
        }

        .group-stat-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .group-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .group-stat-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .group-stat-total {
            font-size: 13px;
            color: #6c757d;
        }

        .group-stat-details {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .group-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 6px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .group-stat-item-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .group-stat-item-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            line-height: 1.2;
        }

        .group-stat-item.s-level .group-stat-item-value {
            color: #dc3545;
        }

        .group-stat-item.a-level .group-stat-item-value {
            color: #ffc107;
        }

        .group-stat-item.b-level .group-stat-item-value {
            color: #17a2b8;
        }

        .group-stat-item.c-level .group-stat-item-value {
            color: #28a745;
        }

        .group-stat-item.unclosed .group-stat-item-value {
            color: #6f42c1;
        }

        .group-stat-item-rate {
            font-size: 10px;
            color: #6c757d;
            margin-top: 3px;
        }

        .no-group-data {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
            font-size: 14px;
        }

        /* 数据表格区域样式 */
        .table-section {
            margin-top: 20px; /* 添加顶部间距 */
            margin-bottom: 20px; /* 添加底部间距 */
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 整体页面布局优化 */
        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }


        .filter-container {
            flex: 0 0 50%;
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 100%; /* 确保最小高度填满 */
            overflow-y: auto;
            min-width: 0;
        }

        /* 响应式设计 - 小屏幕时垂直排列 */
        @media (max-width: 1200px) {
            .filter-section {
                flex-direction: column;
            }
            
            .group-stats-container,
            .filter-container {
                flex: 1 1 100%;
            }
        }

        /* 双图表容器样式 */
        .dual-chart-container {
            display: flex;
            gap: 20px;
            width: 100%;
            margin-bottom: 20px;
        }

        /* 图表容器样式 */
        .chart-container {
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%; /* 填满网格单元格 */
            min-width: 0; /* 防止内容溢出 */
            flex: 1; /* 每个图表容器占据相等的空间 */
        }

        /* 左侧图表样式 */
        .chart-left {
            border-left: 4px solid #007bff;
        }

        /* 右侧图表样式 */
        .chart-right {
            border-left: 4px solid #28a745;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .field-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .field-selector label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
        }

        .field-selector select {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            min-width: 120px;
        }

        .chart-type-buttons {
            display: flex;
            gap: 5px;
        }

        .chart-type-btn {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            background: white;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .chart-type-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .chart-type-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .chart-canvas-container {
            position: relative;
            flex: 1; /* 占据剩余空间 */
            width: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* 削减最小高度从450px到300px */
            max-height: 400px; /* 削减最大高度从600px到400px */
        }

        .chart-canvas {
            max-width: 100%;
            max-height: 100%;
            width: 100% !important;
            height: 100% !important;
        }

        /* 图表注释功能样式 */
        .chart-annotation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 覆盖层本身不拦截事件，允许图表点击事件穿透 */
            z-index: 10;
        }

        /* 注意：覆盖层始终保持穿透，只有注释元素本身（.chart-annotation）会拦截事件 */

        .add-annotation-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 11;
            pointer-events: all;
        }

        .add-annotation-btn:hover {
            background: #0056b3;
        }

        .chart-annotation {
            position: absolute;
            border: 1px dashed #999;
            background: transparent;
            cursor: move;
            min-width: 20px;
            min-height: 40px;
            pointer-events: all;
        }

        .chart-annotation-content {
            width: 100%;
            height: 100%;
            padding: 4px;
            outline: none;
            border: none;
            background: transparent;
            resize: none;
            font-size: 12px;
            font-family: inherit;
            color: #333;
            overflow: auto;
        }

        .chart-annotation-resize {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: transparent;
            cursor: nwse-resize;
            border-right: 1px dashed #999;
            border-bottom: 1px dashed #999;
        }

        .chart-annotation-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            line-height: 14px;
            text-align: center;
            display: none;
        }

        .chart-annotation:hover .chart-annotation-delete {
            display: block;
        }

        .chart-annotation-drag {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: move;
            font-size: 10px;
            line-height: 14px;
            text-align: center;
            display: none; /* 默认隐藏 */
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .chart-annotation:hover .chart-annotation-drag {
            display: flex; /* 鼠标悬停时显示 */
        }

        .chart-annotation-drag:hover {
            background: #0056b3;
        }

        .chart-annotation-drag::before {
            content: '⋮⋮';
            font-size: 8px;
            line-height: 1;
            letter-spacing: -1px;
        }

        /* 响应式设计 - 确保在不同缩放级别下布局一致 */
        @media (max-width: 1000px) {
            .main-control-section {
                grid-template-columns: 350px 1fr; /* 稍微缩小左侧宽度 */
            }
        }

        @media (max-width: 800px) {
            .main-control-section {
                grid-template-columns: 1fr; /* 在小屏幕上改为单列 */
                min-height: auto; /* 在小屏幕上允许高度自适应 */
            }
            
            .filter-container,
            .chart-container {
                height: auto; /* 在小屏幕上允许高度自适应 */
            }

            /* 双图表在小屏幕上垂直排列 */
            .dual-chart-container {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 768px) {
            .main-control-section {
                padding: 15px;
                gap: 15px;
            }
            
            .filter-container,
            .chart-container {
                padding: 15px;
            }
        }

        .no-data-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        .filters-main-container {
            margin-left: 0;
            margin-right: auto;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box;
        }

        .basic-filters-container {
            width: 100%;
            overflow: visible;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            margin-left: 0;
            margin-right: auto;
            box-sizing: border-box;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            width: 100%;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1; /* 横向排版，每个占据相等空间 */
            margin-bottom: 8px;
            box-sizing: border-box;
            min-width: 120px; /* 最小宽度 */
        }

        .filter-group label {
            white-space: nowrap;
            width: 60px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
            flex-shrink: 0;
        }

        .filter-group input,
        .filter-group select {
            flex: 1;
            height: 32px;
            padding: 4px 8px;
            font-size: 14px;
            border: 1px solid #ced4da;
            border-radius: 3px;
        }

        /* 过滤器建议下拉框样式 */
        .input-with-suggestions {
            position: relative;
            flex: 1;
        }

        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 3px 3px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background-color: #f8f9fa;
            color: #007bff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* 自定义滚动条样式 */
        .suggestions-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .suggestions-dropdown::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .suggestions-dropdown::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .suggestions-dropdown::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .suggestions-dropdown.show {
            display: block;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* 日期范围过滤器特殊样式 */
        .date-range-group {
            flex: 1.5; /* 日期过滤器占据更多空间 */
            min-width: 280px; /* 确保日期过滤器有足够空间 */
            margin-left: 20px; /* 增加与问题状态的间距 */
        }

        .date-range-inputs {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .date-range-inputs input[type="date"] {
            flex: 1;
            max-width: 130px;
            font-size: 13px;
            height: 32px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 3px;
        }

        .date-range-inputs span {
            color: #6c757d;
            font-size: 12px;
            flex-shrink: 0;
            white-space: nowrap;
            margin: 0 2px;
        }

        /* 响应式设计 - 小屏幕时每行显示更少 */
        @media (max-width: 1400px) {
            .date-range-group {
                min-width: 250px; /* 缩小日期过滤器最小宽度 */
            }
        }

        @media (max-width: 1200px) {
            .filter-group {
                flex: 0 0 calc(50% - 4px); /* 每行2个 */
            }
            .date-range-group {
                flex: 0 0 calc(100% - 8px); /* 日期过滤器单独一行 */
                min-width: auto;
            }
        }

        @media (max-width: 900px) {
            .filter-group {
                flex: 0 0 calc(50% - 4px); /* 每行2个 */
            }
            .date-range-group {
                flex: 0 0 calc(100% - 8px); /* 日期过滤器单独一行 */
            }
        }

        @media (max-width: 600px) {
            .filter-group {
                flex: 0 0 calc(100% - 8px); /* 每行1个 */
            }
            .date-range-inputs {
                flex-direction: column; /* 在极小屏幕上垂直排列 */
                gap: 8px;
            }
            .date-range-inputs span {
                display: none; /* 隐藏"至"字 */
            }
        }

        /* 排序按钮样式 */
        .chart-sort-buttons {
            display: inline-flex;
            margin-left: 10px;
        }

        .chart-sort-buttons .btn {
            border-radius: 4px;
            font-size: 12px;
            padding: 4px 8px;
            transition: all 0.2s ease;
        }

        .chart-sort-buttons .btn:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .chart-sort-buttons .btn:last-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: 0;
        }

        .chart-sort-buttons .btn.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }

        .chart-sort-buttons .btn:hover:not(.active) {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        /* 图表模态框样式 */
        #chartsModal .modal-content {
            max-width: 1400px;
            width: 95%;
            position: relative;
            transition: transform 0.1s ease-out;
        }

        #chartsModal .modal-header {
            cursor: move;
            user-select: none;
        }

        #chartsModal .modal-header .close {
            cursor: pointer;
        }

        #chartsModal .modal-header h2 {
            cursor: move;
        }

        #chartsModal .modal-body {
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #chartsModal .dual-chart-container {
            display: flex;
            gap: 20px;
            width: 100%;
        }

        #chartsModal .chart-container {
            flex: 1;
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 1200px) {
            #chartsModal .dual-chart-container {
                flex-direction: column;
            }
        }

        /* 电气测试问题点模态框样式 */
        #testIssuesModal .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 8px 8px 0 0;
        }

        #testIssuesModal .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        #testIssuesModal .modal-header .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        #testIssuesModal .modal-header .close:hover {
            opacity: 1;
        }

        #testIssuesModal .modal-body {
            padding: 25px;
            background: #f8f9fa;
        }

        /* 电气测试问题点搜索区域样式 */
        .test-issues-search-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .test-issues-filter-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .test-issues-filter-row-3col {
            grid-template-columns: repeat(3, 1fr);
        }

        .test-issues-filter-item {
            display: flex;
            flex-direction: column;
        }

        .test-issues-filter-item label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .test-issues-filter-item label i {
            color: #667eea;
        }

        .test-issues-filter-item input,
        .test-issues-filter-item select {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .test-issues-filter-item select {
            cursor: pointer;
        }

        .test-issues-filter-item input:focus,
        .test-issues-filter-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 电气测试问题点checkbox样式 */
        #selectAllTestIssuesRows {
            transform: scale(1.3);
            cursor: pointer;
        }

        #selectAllTestIssuesRows:hover {
            transform: scale(1.4);
        }

        .test-issues-row-checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }

        .test-issues-search-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .test-issues-search-item {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .test-issues-search-item label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .test-issues-search-item label i {
            color: #667eea;
        }

        .test-issues-search-item input {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .test-issues-search-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .test-issues-button-group {
            display: flex;
            gap: 10px;
        }

        .test-issues-button-group .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .test-issues-button-group .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .test-issues-button-group .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .test-issues-button-group .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .test-issues-button-group .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        .test-issues-button-group .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .test-issues-button-group .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        @media (max-width: 1200px) {
            .test-issues-filter-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .test-issues-filter-row {
                grid-template-columns: 1fr;
            }
            
            .test-issues-search-row {
                flex-direction: column;
            }
            
            .test-issues-button-group {
                width: 100%;
            }
            
            .test-issues-button-group .btn {
                flex: 1;
            }
        }

        /* 列管理样式 */
        .column-manager-container {
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .edit-permission-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 400px;
            max-width: 500px;
            display: none;
            overflow: hidden;
        }

        .edit-permission-dropdown.show {
            display: block;
        }

        .edit-permission-dropdown .dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            background: #e7f3ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-permission-dropdown .dropdown-header i {
            color: #0066cc;
            font-size: 16px;
        }

        .edit-permission-dropdown .dropdown-header span {
            font-weight: 600;
            color: #004085;
            font-size: 14px;
        }

        .edit-permission-dropdown .dropdown-content {
            padding: 15px;
            font-size: 12px;
            color: #333;
            line-height: 1.8;
        }

        .edit-permission-dropdown .info-item {
            margin: 6px 0;
            padding-left: 10px;
        }

        .column-manager-btn-wrapper {
            position: relative;
        }

        .column-manager-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            max-height: 500px;
            display: none;
            overflow: hidden;
        }

        .column-manager-dropdown.show {
            display: block;
        }

        .column-manager-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .column-manager-header span {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .column-manager-actions {
            display: flex;
            gap: 10px;
        }

        .column-manager-actions .btn-link {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 13px;
            padding: 4px 8px;
            transition: color 0.2s;
        }

        .column-manager-actions .btn-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .column-manager-tip {
            padding: 10px 15px;
            background: #e7f3ff;
            border-bottom: 1px solid #d0e7ff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #0066cc;
        }

        .column-manager-tip i {
            color: #0066cc;
        }

        .column-manager-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .column-manager-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .column-manager-item:hover {
            background-color: #f8f9fa;
        }

        .column-manager-item:last-child {
            border-bottom: none;
        }

        .column-manager-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .column-manager-item label {
            cursor: pointer;
            flex: 1;
            user-select: none;
            font-size: 14px;
            color: #333;
        }

        /* 隐藏的列 */
        .data-table th[data-key].hidden,
        .data-table td[data-key].hidden {
            display: none;
        }

        /* 全局编辑模态框样式 */
        #globalEditTable {
            font-size: 13px;
        }

        #globalEditTable th {
            background-color: #f8f9fa;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #globalEditTable td {
            padding: 8px;
            text-align: center;
        }

        .global-edit-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .global-edit-input:hover {
            border-color: #007bff;
        }

        .global-edit-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* 表格内联编辑样式 */
        .table-cell-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #007bff;
            border-radius: 3px;
            font-size: 12px;
            background-color: #fff;
            min-width: 80px;
        }

        .table-cell-input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .table-cell-date-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #007bff;
            border-radius: 3px;
            font-size: 12px;
            background-color: #fff;
        }

        .global-edit-mode .data-table td[data-key]:not([data-key="checkbox"]):not([data-key="id"]):not([data-key="action"]):not([data-key="createdTime"]):not([data-key="updatedTime"]) {
            padding: 4px;
        }

        .global-edit-mode .data-table tr:hover {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
<!-- 页面头部 -->
<div class="header">
    <div class="header-content">
        <!-- 左侧标题 -->
        <div class="header-left">
            <h1 class="page-title">
                <i class="fas fa-clipboard-check"></i>
                新品质量问题管理
            </h1>
        </div>

        <!-- 中间区域 -->
        <div class="header-center">
        </div>

        <!-- 用户信息和操作按钮 - 右侧 -->
        <div class="header-right">
            <div class="user-info">
                <span id="currentUser"></span>
                <span id="currentRole"></span>
                <span id="cacheStatus" class="cache-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
            </div>

            <!-- 其他操作按钮组 -->
            <div class="header-action-buttons">
                <button id="addNewBtn" class="btn btn-success">
                    <i class="fas fa-plus"></i> 新增数据
                </button>
                <button id="importBtn" class="btn btn-primary">
                    <i class="fas fa-upload"></i> 导入新品质量数据
                </button>
                <button id="exportBtn" class="btn btn-success">
                    <i class="fas fa-download"></i> 导出筛选结果
                </button>
                <button id="exportAllResultsBtn" class="btn btn-info">
                    <i class="fas fa-file-export"></i> 导出全部筛选结果
                </button>
                <button id="deleteSelectedBtn" class="btn btn-warning">
                    <i class="fas fa-trash"></i> 删除选中数据
                </button>
                <!-- 删除全部搜索结果按钮 - 已注释，操作过于危险 -->
                <!--
                <button id="deleteAllResultsBtn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> 删除全部搜索结果
                </button>
                -->
                <button id="addToCartBtn" class="btn btn-warning">
                    <i class="fas fa-shopping-cart"></i> 加入收藏夹
                </button>
                <button id="showCartBtn" class="btn btn-secondary">
                    <i class="fas fa-list"></i> 查看收藏夹 (<span id="cartCount">0</span>)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 导入新品质量模态框 -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>导入新品质量数据</h2>
            <span class="close" onclick="closeImportModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="import-container">
                <!-- 左侧：模板文件下载 -->
                <div class="template-section">
                    <h3><i class="fas fa-download"></i> 下载模板文件</h3>
                    <p>请先下载模板文件，按照模板格式填写数据后上传</p>
                    <button id="downloadTemplateBtn" class="btn btn-info">
                        <i class="fas fa-file-excel"></i> 下载新品质量问题模板
                    </button>
                    <div class="template-info">
                        <small>模板文件包含所有必填字段的示例数据</small>
                    </div>
                </div>

                <!-- 右侧：文件上传 -->
                <div class="upload-section">
                    <h3><i class="fas fa-upload"></i> 上传数据文件</h3>
                    <p>选择填写好的Excel文件进行导入</p>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>点击选择文件或拖拽文件到此处</p>
                        <p class="file-info">支持 .xlsx 格式，最大 100MB</p>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
                    <div class="upload-progress" id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
            </div>
            
            <!-- 导入规则说明 -->
            <div class="import-rules">
                <h4>
                    <i class="fas fa-info-circle"></i>
                    导入数据判断规则
                </h4>
                <div class="import-rules-content">
                    <div class="rule-item">
                        <strong>系统会根据以下字段判断是插入新数据还是更新现有数据：</strong>
                    </div>
                    <div class="rule-item">
                        <strong>判断字段（以下 6 个字段需完全匹配）：</strong>
                        <br>&nbsp;&nbsp;&nbsp;&nbsp;• 大编码
                        <br>&nbsp;&nbsp;&nbsp;&nbsp;• 小编码
                        <br>&nbsp;&nbsp;&nbsp;&nbsp;• 项目阶段
                        <br>&nbsp;&nbsp;&nbsp;&nbsp;• 供应商
                        <br>&nbsp;&nbsp;&nbsp;&nbsp;• 问题点
                        <br>&nbsp;&nbsp;&nbsp;&nbsp;• 版本（可为空，有值则必须匹配）
                    </div>
                    <div class="rule-item">
                        <strong>说明：</strong> 如果数据库中已存在匹配的记录，则更新该记录；否则插入新记录。
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImportModal()">取消</button>
            <button id="confirmImportBtn" class="btn btn-primary" disabled>确认导入</button>
        </div>
    </div>
</div>

<!-- 筛选和操作区域 -->
<div class="filter-section">
    <!-- 左侧：组别统计展示 -->
    <div class="group-stats-container">
        <div class="group-stats-title">
            <span><i class="fas fa-chart-pie"></i> 组别统计</span>
            <div class="group-selector-wrapper">
                <select id="groupSelector" class="group-selector">
                    <option value="">请选择组别</option>
                </select>
            </div>
        </div>
        <div class="group-stats-display" id="groupStatsDisplay">
            <div class="no-group-data">请选择组别查看统计</div>
        </div>
    </div>
    
    <!-- 右侧：过滤器 -->
    <div class="filter-container">
        <!-- 筛选器主容器（横向布局） -->
        <div class="filters-main-container">
            <!-- 基础筛选器 -->
            <div class="basic-filters-container">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>大编码:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="majorCodeFilter" placeholder="输入大编码" autocomplete="off" />
                            <div id="majorCodeFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>小编码:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="minorCodeFilter" placeholder="输入小编码" autocomplete="off" />
                            <div id="minorCodeFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>项目阶段:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="projectPhaseFilter" placeholder="输入项目阶段" autocomplete="off" />
                            <div id="projectPhaseFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>版本:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="versionFilter" placeholder="输入版本" autocomplete="off" />
                            <div id="versionFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>供应商:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="supplierFilter" placeholder="输入供应商" autocomplete="off" />
                            <div id="supplierFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>问题状态:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="problemStatusFilter" placeholder="输入问题状态" autocomplete="off" />
                            <div id="problemStatusFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>组别:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="groupFilter" placeholder="输入组别" autocomplete="off" />
                            <div id="groupFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>品类:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="categoryFilter" placeholder="输入品类" autocomplete="off" />
                            <div id="categoryFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>DQE责任人:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="dqeResponsibleFilter" placeholder="输入DQE责任人" autocomplete="off" />
                            <div id="dqeResponsibleFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>数据来源:</label>
                        <div class="input-with-suggestions">
                            <input type="text" id="dataSourceFilter" placeholder="输入数据来源" autocomplete="off" />
                            <div id="dataSourceFilterSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group date-range-group">
                        <label>发生日期:</label>
                        <div class="date-range-inputs">
                            <input type="date" id="testStartDateFilter">
                            <span>至</span>
                            <input type="date" id="testEndDateFilter">
                        </div>
                    </div>
                </div>

                <!-- 搜索和重置按钮 -->
                <div class="search-reset-buttons">
                    <button id="searchBtn" class="btn btn-primary" title="搜索 (Enter)">
                        <i class="fas fa-search"></i> 搜索
                        <span class="shortcut-hint">(Enter)</span>
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-undo"></i> 重置
                    </button>
                    <button id="showChartsBtn" class="btn btn-info">
                        <i class="fas fa-chart-bar"></i> 数据可视化
                    </button>
                    <button id="showTestIssuesBtn" class="btn btn-success" >
                        <i class="fas fa-bolt"></i> 电气测试问题点导入
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表模态框 -->
<div id="chartsModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>数据可视化分析</h2>
            <span class="close" onclick="closeChartsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- 双图表容器 -->
            <div class="dual-chart-container">
        <!-- 左侧图表 -->
        <div class="chart-container chart-left">
            <div class="chart-header">
                <h3 class="chart-title">数据可视化 - 图表1</h3>
                <div class="chart-controls">
                    <div class="chart-type-buttons">
                        <button class="chart-type-btn active" data-type="bar" onclick="switchChartType('bar', 1)">柱状图</button>
                        <button class="chart-type-btn" data-type="pie" onclick="switchChartType('pie', 1)">饼状图</button>
                        <button class="chart-type-btn" data-type="line" onclick="switchChartType('line', 1)">折线图</button>
                    </div>
                </div>
            </div>

            <div class="field-selector">
                <label>分组字段:</label>
                <select id="groupField1">
                    <option value="">请选择分组字段</option>
                    <option value="problemLevel">问题等级</option>
                    <option value="majorCode">大编码</option>
                    <option value="minorCode">小编码</option>
                    <option value="projectPhase">项目阶段</option>
                    <option value="version">版本</option>
                    <option value="problemProcess">问题工序</option>
                    <option value="developmentMethod">开发方式</option>
                    <option value="supplier">供应商</option>
                    <option value="solutionProvider">方案商</option>
                    <option value="problemPoint">问题点</option>
                    <option value="problemReason">问题原因</option>
                    <option value="improvementStrategy">改善对策</option>
                    <option value="isPreventable">是否可预防</option>
                    <option value="responsibleDepartment">责任部门</option>
                    <option value="problemStatus">问题状态</option>
                    <option value="problemTag1">问题打标1</option>
                    <option value="problemTag2">问题打标2</option>
                </select>

                <button id="generateChartBtn1" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;" onclick="generateChart(1)">生成图表</button>
                
                <!-- 排序按钮组 -->
                <div class="chart-sort-buttons" role="group">
                    <button id="sortAscBtn1" class="btn btn-outline-secondary" onclick="setChartSort('asc', 1)" title="按数值升序排列">
                        <i class="fas fa-sort-amount-up"></i> 升序
                    </button>
                    <button id="sortDescBtn1" class="btn btn-outline-secondary" onclick="setChartSort('desc', 1)" title="按数值降序排列">
                        <i class="fas fa-sort-amount-down"></i> 降序
                    </button>
                </div>
            </div>

            <div class="chart-canvas-container">
                <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-left: 4px solid #2196f3; font-size: 14px; color: #1976d2;">
                    <i class="fas fa-info-circle"></i> 图表将显示所有搜索结果的数据，不受分页限制。每次生成图表都会重新获取完整的搜索结果数据，确保统计的准确性。
                </div>
                <div id="chartStatus1" style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-left: 4px solid #6c757d; font-size: 14px; color: #495057; display: none;">
                    <i class="fas fa-chart-bar"></i> <span id="chartStatusText1">准备就绪</span>
                </div>
                <canvas id="dataChart1" class="chart-canvas"></canvas>
                <div id="noDataMessage1" class="no-data-message" style="display: none;">
                    请先选择要展示的字段，然后点击"生成图表"按钮
                </div>
                <div id="annotationOverlay1" class="chart-annotation-overlay"></div>
                <button class="add-annotation-btn" onclick="addAnnotation(1)" title="添加注释">
                    <i class="fas fa-comment"></i> 添加注释
                </button>
            </div>
        </div>

        <!-- 右侧图表 -->
        <div class="chart-container chart-right">
            <div class="chart-header">
                <h3 class="chart-title">数据可视化 - 图表2</h3>
                <div class="chart-controls">
                    <div class="chart-type-buttons">
                        <button class="chart-type-btn active" data-type="bar" onclick="switchChartType('bar', 2)">柱状图</button>
                        <button class="chart-type-btn" data-type="pie" onclick="switchChartType('pie', 2)">饼状图</button>
                        <button class="chart-type-btn" data-type="line" onclick="switchChartType('line', 2)">折线图</button>
                    </div>
                </div>
            </div>

            <div class="field-selector">
                <label>分组字段:</label>
                <select id="groupField2">
                    <option value="">请选择分组字段</option>
                    <option value="problemLevel">问题等级</option>
                    <option value="majorCode">大编码</option>
                    <option value="minorCode">小编码</option>
                    <option value="projectPhase">项目阶段</option>
                    <option value="version">版本</option>
                    <option value="problemProcess">问题工序</option>
                    <option value="developmentMethod">开发方式</option>
                    <option value="supplier">供应商</option>
                    <option value="solutionProvider">方案商</option>
                    <option value="problemPoint">问题点</option>
                    <option value="problemReason">问题原因</option>
                    <option value="improvementStrategy">改善对策</option>
                    <option value="isPreventable">是否可预防</option>
                    <option value="responsibleDepartment">责任部门</option>
                    <option value="problemStatus">问题状态</option>
                    <option value="problemTag1">问题打标1</option>
                    <option value="problemTag2">问题打标2</option>
                </select>

                <button id="generateChartBtn2" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;" onclick="generateChart(2)">生成图表</button>
                
                <!-- 排序按钮组 -->
                <div class="chart-sort-buttons" role="group">
                    <button id="sortAscBtn2" class="btn btn-outline-secondary" onclick="setChartSort('asc', 2)" title="按数值升序排列">
                        <i class="fas fa-sort-amount-up"></i> 升序
                    </button>
                    <button id="sortDescBtn2" class="btn btn-outline-secondary" onclick="setChartSort('desc', 2)" title="按数值降序排列">
                        <i class="fas fa-sort-amount-down"></i> 降序
                    </button>
                </div>
            </div>

            <div class="chart-canvas-container">
                <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-left: 4px solid #2196f3; font-size: 14px; color: #1976d2;">
                    <i class="fas fa-info-circle"></i> 图表将显示所有搜索结果的数据，不受分页限制。每次生成图表都会重新获取完整的搜索结果数据，确保统计的准确性。
                </div>
                <div id="chartStatus2" style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-left: 4px solid #6c757d; font-size: 14px; color: #495057; display: none;">
                    <i class="fas fa-chart-bar"></i> <span id="chartStatusText2">准备就绪</span>
                </div>
                <canvas id="dataChart2" class="chart-canvas"></canvas>
                <div id="noDataMessage2" class="no-data-message" style="display: none;">
                    请先选择要展示的字段，然后点击"生成图表"按钮
                </div>
                <div id="annotationOverlay2" class="chart-annotation-overlay"></div>
                <button class="add-annotation-btn" onclick="addAnnotation(2)" title="添加注释">
                    <i class="fas fa-comment"></i> 添加注释
                </button>
            </div>
        </div>
            </div>
        </div>
    </div>
</div>

<!-- 电气测试问题点模态框 -->
<div id="testIssuesModal" class="modal">
    <div class="modal-content extra-large-modal">
        <div class="modal-header">
            <h2>电气测试问题点</h2>
            <span class="close" onclick="closeTestIssuesModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- 搜索区域 -->
            <div class="test-issues-search-section">
                <div class="test-issues-filter-row">
                    <div class="test-issues-filter-item">
                        <label><i class="fas fa-tag"></i> 大编码</label>
                        <input type="text" id="testIssuesMajorCode" placeholder="输入大编码...">
                    </div>
                    <div class="test-issues-filter-item">
                        <label><i class="fas fa-tags"></i> 小编码</label>
                        <input type="text" id="testIssuesMinorCode" placeholder="输入小编码...">
                    </div>
                    <div class="test-issues-filter-item">
                        <label><i class="fas fa-code-branch"></i> 版本</label>
                        <input type="text" id="testIssuesVersion" placeholder="输入版本...">
                    </div>
                    <div class="test-issues-filter-item">
                        <label><i class="fas fa-info-circle"></i> 问题状态</label>
                        <select id="testIssuesProblemStatus">
                            <option value="">全部</option>
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                            <option value="follow">Follow</option>
                        </select>
                    </div>
                </div>
                <div class="test-issues-filter-row test-issues-filter-row-3col">
                    <div class="test-issues-filter-item">
                        <label><i class="fas fa-users"></i> 组别</label>
                        <input type="text" id="testIssuesGroup" placeholder="输入组别...">
                    </div>
                    <div class="test-issues-filter-item">
                        <label><i class="fas fa-box"></i> 品类</label>
                        <input type="text" id="testIssuesCategory" placeholder="输入品类...">
                    </div>
                    <div class="test-issues-filter-item">
                        <label><i class="fas fa-user-tie"></i> DQE负责人</label>
                        <input type="text" id="testIssuesDqeResponsible" placeholder="输入DQE负责人...">
                    </div>
                </div>
                <div class="test-issues-search-row">
                    <div class="test-issues-search-item">
                        <label><i class="fas fa-search"></i> 搜索关键词</label>
                        <input type="text" id="testIssuesSearchKeyword" placeholder="输入关键词搜索...">
                    </div>
                    <div class="test-issues-button-group">
                        <button id="testIssuesSearchBtn" class="btn btn-primary">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button id="testIssuesResetBtn" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                        <button id="testIssuesAddToReviewBtn" class="btn btn-success">
                            <i class="fas fa-plus-circle"></i> 导入到新品质量问题
                        </button>
                    </div>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="table-container">
                <table id="testIssuesTable" class="data-table">
                    <thead>
                    <tr>
                        <th data-key="checkbox">
                            <input type="checkbox" id="selectAllTestIssuesRows" title="全选/取消全选">
                        </th>
                        <th data-key="id">ID</th>
                        <th data-key="group">组别</th>
                        <th data-key="category">品类</th>
                        <th data-key="testDate">发生日期</th>
                        <th data-key="majorCode">大编码</th>
                        <th data-key="minorCode">小编码</th>
                        <th data-key="projectPhase">项目阶段</th>
                        <th data-key="version">版本</th>
                        <th data-key="problemProcess">问题工序</th>
                        <th data-key="problemLevel">问题等级</th>
                        <th data-key="developmentMethod">开发方式</th>
                        <th data-key="supplier">供应商</th>
                        <th data-key="solutionProvider">方案商</th>
                        <th data-key="problemPoint">问题点</th>
                        <th data-key="problemReason">问题原因</th>
                        <th data-key="improvementMeasures">改善对策</th>
                        <th data-key="isPreventable">是否可预防</th>
                        <th data-key="responsibleDepartment">责任部门</th>
                        <th data-key="dqeResponsible">DQE负责人</th>
                        <th data-key="problemStatus">问题状态</th>
                        <th data-key="plannedCompletionTime">预计完成时间</th>
                        <th data-key="actualCompletionTime">实际完成时间</th>
                        <th data-key="delayDays">Delay天数</th>
                        <th data-key="problemTag1">问题打标1</th>
                        <th data-key="problemTag2">问题打标2</th>
                        <th data-key="preventionNotes">预防备注</th>
                        <th data-key="createdTime">创建时间</th>
                        <th data-key="updatedTime">更新时间</th>
                    </tr>
                    </thead>
                    <tbody id="testIssuesTableBody">
                    <!-- 数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>

            <!-- 分页信息 -->
            <div class="pagination-info" style="margin-top: 20px;">
                <span>共 <strong id="testIssuesTotalRecords">0</strong> 条记录</span>
            </div>
        </div>
    </div>
</div>

<!-- 数据表格区域 -->
    <div class="table-section">
    <!-- 全局编辑和列管理按钮 -->
    <div class="column-manager-container">
        <div class="pagination-info">
            <span>显示第 <span id="startRecord">1</span> - <span id="endRecord">10</span> 条，共 <span id="totalRecords">0</span> 条记录</span>
            <div class="page-size-selector">
                <label>每页显示:</label>
                <select id="pageSizeSelect">
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>条</span>
            </div>
        </div>
        <div class="column-manager-btn-wrapper">
            <button id="editPermissionBtn" class="btn btn-info" title="编辑权限说明">
                <i class="fas fa-question-circle"></i>
            </button>
            <div id="editPermissionDropdown" class="edit-permission-dropdown">
                <div class="dropdown-header">
                    <i class="fas fa-info-circle"></i>
                    <span></span>
                </div>
                <div class="dropdown-content">
                    <div class="info-item">• 组别最好是跟实际钉钉组织架构上一级一致</div>
                    <div class="info-item">• 当您的用户名与"DQE负责人"字段一致时，可以编辑该条数据</div>
                    <div class="info-item">• 蓝牙家居组 ↔ 工控线材组可以互相编辑</div>
                    <div class="info-item">• 壳膜创意组 ↔ 创意家居组可以互相编辑</div>
                    <div class="info-item">• 数据存储组 ↔ 数据储存组可以互相编辑</div>
                    <div class="info-item">• 组别匹配时可以编辑（组别为空时允许任何人编辑）</div>
                    <div class="info-item">• 如组别有问题导致不能编辑，请咨询卢健</div>
                </div>
            </div>
        </div>
        <div class="column-manager-btn-wrapper">
            <button id="globalEditBtn" class="btn btn-primary" title="全局编辑">
                <i class="fas fa-edit"></i> <span id="globalEditBtnText">全局编辑</span>
            </button>
            <button id="saveGlobalEditBtn" class="btn btn-success" style="display: none;" title="保存所有修改">
                <i class="fas fa-save"></i> 保存修改
            </button>
        </div>
        <div class="column-manager-btn-wrapper">
            <button id="columnManagerBtn" class="btn btn-secondary" title="列管理">
                <i class="fas fa-columns"></i> 列管理
            </button>
            <div id="columnManagerDropdown" class="column-manager-dropdown">
                <div class="column-manager-header">
                    <span>选择要显示的列</span>
                    <div class="column-manager-actions">
                        <button class="btn-link" onclick="toggleAllColumns(true)" title="全选">全选</button>
                        <button class="btn-link" onclick="toggleAllColumns(false)" title="全不选">全不选</button>
                    </div>
                </div>
                <div class="column-manager-tip">
                    <i class="fas fa-info-circle"></i> 隐藏的列不会显示在导出文件中
                </div>
                <div class="column-manager-content">
                    <!-- 列选项将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
    <div class="table-container">
        <table id="reviewTable" class="data-table">
            <thead>
            <tr>
                <th data-key="checkbox">
                    <input type="checkbox" id="selectAllTableRows" title="全选/取消全选">
                </th>
                <th data-key="id">ID</th>
                <th data-key="group">组别</th>
                <th data-key="category">品类</th>
                <th data-key="testDate">发生日期</th>
                <th data-key="majorCode">大编码</th>
                <th data-key="minorCode">小编码</th>
                <th data-key="projectPhase">项目阶段</th>
                <th data-key="version">版本</th>
                <th data-key="problemProcess">问题工序</th>
                <th data-key="problemLevel">问题等级</th>
                <th data-key="developmentMethod">开发方式</th>
                <th data-key="supplier">供应商</th>
                <th data-key="solutionProvider">方案商</th>
                <th data-key="problemPoint">问题点</th>
                <th data-key="problemReason">问题原因</th>
                <th data-key="improvementMeasures">改善对策</th>
                <th data-key="isPreventable">是否可预防</th>
                <th data-key="responsibleDepartment">责任部门</th>
                <th data-key="dqeResponsible">DQE负责人</th>
                <th data-key="problemStatus">问题状态</th>
                <th data-key="plannedCompletionTime">预计完成时间</th>
                <th data-key="actualCompletionTime">实际完成时间</th>
                <th data-key="delayDays">Delay天数</th>
                <th data-key="problemTag1">问题打标1</th>
                <th data-key="problemTag2">问题打标2</th>
                <th data-key="preventionNotes">预防备注</th>
                <th data-key="dataSource">数据来源</th>
                <th data-key="createdTime">创建时间</th>
                <th data-key="updatedTime">更新时间</th>
                <th data-key="action">操作</th>
            </tr>
            </thead>
            <tbody id="reviewTableBody">
            <!-- 数据将通过JavaScript动态加载 -->
            </tbody>
        </table>
    </div>

    <!-- 分页控件 -->
    <div class="pagination-container">
        <div class="pagination-controls">
            <button id="firstPageBtn" class="btn btn-sm" title="首页">首页</button>
            <button id="prevPageBtn" class="btn btn-sm">上一页</button>
            <div class="page-numbers" id="pageNumbers">
                <!-- 页码按钮将通过JavaScript动态生成 -->
            </div>
            <button id="nextPageBtn" class="btn btn-sm">下一页</button>
            <button id="lastPageBtn" class="btn btn-sm" title="末页">末页</button>
            <div class="page-jump">
                <span>跳转到</span>
                <input type="number" id="pageJumpInput" min="1" style="width: 60px; margin: 0 5px;">
                <span>页</span>
                <button id="pageJumpBtn" class="btn btn-sm">跳转</button>
            </div>
        </div>
    </div>
</div>

<!-- 新品质量详情模态框 -->
<div id="reviewDetailModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2 id="reviewModalTitle">新品质量详情</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="detail-content">
                <div class="detail-section">
                    <h3>基本信息</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>组别:</label>
                            <span id="detailGroup">-</span>
                        </div>
                        <div class="detail-item">
                            <label>品类:</label>
                            <span id="detailCategory">-</span>
                        </div>
                        <div class="detail-item">
                            <label>DQE负责人:</label>
                            <span id="detailDqeResponsible">-</span>
                        </div>
                        <div class="detail-item">
                            <label>发生日期:</label>
                            <span id="detailTestDate">-</span>
                        </div>
                        <div class="detail-item">
                            <label>大编码:</label>
                            <span id="detailMajorCode">-</span>
                        </div>
                        <div class="detail-item">
                            <label>小编码:</label>
                            <span id="detailMinorCode">-</span>
                        </div>
                        <div class="detail-item">
                            <label>项目阶段:</label>
                            <span id="detailProjectPhase">-</span>
                        </div>
                        <div class="detail-item">
                            <label>版本:</label>
                            <span id="detailVersion">-</span>
                        </div>
                        <div class="detail-item">
                            <label>问题工序:</label>
                            <span id="detailProblemProcess">-</span>
                        </div>
                        <div class="detail-item">
                            <label>问题等级:</label>
                            <span id="detailProblemLevel">-</span>
                        </div>
                        <div class="detail-item">
                            <label>开发方式:</label>
                            <span id="detailDevelopmentMethod">-</span>
                        </div>
                        <div class="detail-item">
                            <label>供应商:</label>
                            <span id="detailSupplier">-</span>
                        </div>
                        <div class="detail-item">
                            <label>方案商:</label>
                            <span id="detailSolutionProvider">-</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>问题信息</h3>
                    <div class="detail-grid">
                        <div class="detail-item full-width">
                            <label>问题点:</label>
                            <div class="problem-desc" id="detailProblemPoint">-</div>
                        </div>
                        <div class="detail-item full-width">
                            <label>问题原因:</label>
                            <div class="problem-desc" id="detailProblemReason">-</div>
                        </div>
                        <div class="detail-item full-width">
                            <label>改善对策:</label>
                            <div class="problem-desc" id="detailImprovementMeasures">-</div>
                        </div>
                        <div class="detail-item">
                            <label>是否可预防:</label>
                            <span id="detailIsPreventable">-</span>
                        </div>
                        <div class="detail-item">
                            <label>责任部门:</label>
                            <span id="detailResponsibleDepartment">-</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>时间信息</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>预计完成时间:</label>
                            <span id="detailPlannedCompletionTime">-</span>
                        </div>
                        <div class="detail-item">
                            <label>实际完成时间:</label>
                            <span id="detailActualCompletionTime">-</span>
                        </div>
                        <div class="detail-item">
                            <label>Delay天数:</label>
                            <span id="detailDelayDays">-</span>
                        </div>
                        <div class="detail-item">
                            <label>问题状态:</label>
                            <span id="detailProblemStatus">-</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>其他信息</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>问题打标1:</label>
                            <span id="detailProblemTag1">-</span>
                        </div>
                        <div class="detail-item">
                            <label>问题打标2:</label>
                            <span id="detailProblemTag2">-</span>
                        </div>
                        <div class="detail-item full-width">
                            <label>预防备注:</label>
                            <div class="problem-desc" id="detailPreventionNotes">-</div>
                        </div>
                        <div class="detail-item">
                            <label>创建时间:</label>
                            <span id="detailCreatedTime">-</span>
                        </div>
                        <div class="detail-item">
                            <label>更新时间:</label>
                            <span id="detailUpdatedTime">-</span>
                        </div>
                        <div class="detail-item">
                            <label>数据来源:</label>
                            <span id="detailDataSource">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="editReviewBtn" class="btn btn-primary" style="display: none;">编辑</button>
            <button id="saveReviewBtn" class="btn btn-success" style="display: none;">保存</button>
            <button id="cancelEditReviewBtn" class="btn btn-secondary" style="display: none;">取消</button>
            <button id="closeReviewDetailModal" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>

<!-- 问题点详情模态框 -->
<div id="problemDetailModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>问题点详情</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editProblemId" value="">
            <div class="detail-grid">
                <div class="detail-section">
                    <h3>基本信息</h3>
                    <div class="detail-row">
                        <label>样品ID:</label>
                        <span id="detailSampleId" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <label>完整编码:</label>
                        <span id="detailFullModel" class="detail-value"></span>
                        <input type="text" id="editDetailFullModel" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>大类:</label>
                        <span id="detailBigSpecies" class="detail-value"></span>
                        <input type="text" id="editDetailBigSpecies" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>小类:</label>
                        <span id="detailSmallSpecies" class="detail-value"></span>
                        <input type="text" id="editDetailSmallSpecies" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>样品阶段:</label>
                        <span id="detailSampleStage" class="detail-value"></span>
                        <input type="text" id="editDetailSampleStage" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>版本:</label>
                        <span id="detailVersion" class="detail-value"></span>
                        <input type="text" id="editDetailVersion" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>芯片方案:</label>
                        <span id="detailChipSolution" class="detail-value"></span>
                        <input type="text" id="editDetailChipSolution" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>测试平台:</label>
                        <span id="detailTestPlatform" class="detail-value"></span>
                        <input type="text" id="editDetailTestPlatform" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>显示设备:</label>
                        <span id="detailTestDevice" class="detail-value"></span>
                        <input type="text" id="editDetailTestDevice" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>其他设备:</label>
                        <span id="detailOtherDevice" class="detail-value"></span>
                        <input type="text" id="editDetailOtherDevice" class="detail-input" style="display: none;">
                    </div>
                </div>

                <div class="detail-section">
                    <h3>问题信息</h3>
                    <div class="detail-row">
                        <label>问题描述:</label>
                        <div id="detailProblem" class="detail-value"></div>
                        <textarea id="editDetailProblem" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>问题图片:</label>
                        <div id="detailProblemImage" class="detail-value problem-image-container"></div>
                    </div>
                    <div class="detail-row">
                        <label>问题类别:</label>
                        <span id="detailProblemCategory" class="detail-value"></span>
                        <select id="editDetailProblemCategory" class="detail-input" style="display: none;">
                            <option value="">请选择问题类别</option>
                            <optgroup label="视频组">
                                <option value="视频播放问题">视频播放问题</option>
                                <option value="视频录制问题">视频录制问题</option>
                                <option value="视频编码问题">视频编码问题</option>
                                <option value="视频解码问题">视频解码问题</option>
                                <option value="视频传输问题">视频传输问题</option>
                                <option value="视频显示问题">视频显示问题</option>
                                <option value="视频格式问题">视频格式问题</option>
                                <option value="视频画质问题">视频画质问题</option>
                                <option value="视频同步问题">视频同步问题</option>
                                <option value="视频卡顿问题">视频卡顿问题</option>
                            </optgroup>
                            <optgroup label="蓝牙组">
                                <option value="蓝牙连接问题">蓝牙连接问题</option>
                                <option value="蓝牙配对问题">蓝牙配对问题</option>
                                <option value="蓝牙传输问题">蓝牙传输问题</option>
                                <option value="蓝牙音频问题">蓝牙音频问题</option>
                                <option value="蓝牙信号问题">蓝牙信号问题</option>
                                <option value="蓝牙兼容性问题">蓝牙兼容性问题</option>
                                <option value="蓝牙功耗问题">蓝牙功耗问题</option>
                                <option value="蓝牙协议问题">蓝牙协议问题</option>
                                <option value="蓝牙设备识别问题">蓝牙设备识别问题</option>
                                <option value="蓝牙断连问题">蓝牙断连问题</option>
                            </optgroup>
                            <optgroup label="硬件组">
                                <option value="硬件设计问题">硬件设计问题</option>
                                <option value="生产问题">生产问题</option>
                                <option value="器件问题">器件问题</option>
                                <option value="配件问题">配件问题</option>
                                <option value="外观问题">外观问题</option>
                                <option value="PCBA问题">PCBA问题</option>
                                <option value="电路问题">电路问题</option>
                                <option value="接口问题">接口问题</option>
                                <option value="散热问题">散热问题</option>
                                <option value="机械结构问题">机械结构问题</option>
                            </optgroup>
                            <optgroup label="软件组">
                                <option value="软件问题">软件问题</option>
                                <option value="系统问题">系统问题</option>
                                <option value="驱动问题">驱动问题</option>
                                <option value="固件问题">固件问题</option>
                                <option value="应用问题">应用问题</option>
                                <option value="界面问题">界面问题</option>
                                <option value="性能问题">性能问题</option>
                                <option value="兼容性问题">兼容性问题</option>
                                <option value="稳定性问题">稳定性问题</option>
                                <option value="功能缺失问题">功能缺失问题</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="detail-row">
                        <label>缺陷等级:</label>
                        <span id="detailDefectLevel" class="detail-value"></span>
                        <select id="editDetailDefectLevel" class="detail-input" style="display: none;">
                            <option value="S">S</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="待确定">待确定</option>
                        </select>
                    </div>
                    <div class="detail-row">
                        <label>当前状态:</label>
                        <span id="detailCurrentStatus" class="detail-value"></span>
                        <select id="editDetailCurrentStatus" class="detail-input" style="display: none;">
                            <option value="Open">Open</option>
                            <option value="Closed">Closed</option>
                            <option value="Follow up">Follow up</option>
                        </select>
                    </div>
                    <div class="detail-row">
                        <label>复现手法:</label>
                        <div id="detailReproductionMethod" class="detail-value"></div>
                        <textarea id="editDetailReproductionMethod" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>恢复方法:</label>
                        <div id="detailRecoveryMethod" class="detail-value"></div>
                        <textarea id="editDetailRecoveryMethod" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>复现概率:</label>
                        <span id="detailReproductionProbability" class="detail-value"></span>
                        <input type="text" id="editDetailReproductionProbability" class="detail-input" style="display: none;">
                    </div>
                </div>

                <div class="detail-section">
                    <h3>处理信息</h3>
                    <div class="detail-row">
                        <label>测试人员:</label>
                        <span id="detailTester" class="detail-value"></span>
                        <input type="text" id="editDetailTester" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>责任部门:</label>
                        <span id="detailResponsibleDepartment" class="detail-value"></span>
                        <select id="editDetailResponsibleDepartment" class="detail-input" style="display: none;">
                            <option value="SQE">SQE</option>
                            <option value="ID">ID</option>
                            <option value="结构">结构</option>
                            <option value="研发">研发</option>
                        </select>
                    </div>
                    <div class="detail-row">
                        <label>分析责任人:</label>
                        <span id="detailResponsiblePerson" class="detail-value"></span>
                        <input type="text" id="editDetailResponsiblePerson" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>DQE确认:</label>
                        <span id="detailDqeConfirm" class="detail-value"></span>
                        <input type="text" id="editDetailDqeConfirm" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>研发确认:</label>
                        <span id="detailRdConfirm" class="detail-value"></span>
                        <input type="text" id="editDetailRdConfirm" class="detail-input" style="display: none;">
                    </div>
                    <div class="detail-row">
                        <label>改善对策:</label>
                        <div id="detailImprovementPlan" class="detail-value"></div>
                        <textarea id="editDetailImprovementPlan" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>DQE回复:</label>
                        <div id="detailGreenUnionDqe" class="detail-value"></div>
                        <textarea id="editDetailGreenUnionDqe" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>研发回复:</label>
                        <div id="detailGreenUnionRd" class="detail-value"></div>
                        <textarea id="editDetailGreenUnionRd" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>其他信息</h3>
                    <div class="detail-row">
                        <label>对比上一版:</label>
                        <div id="detailComparisonWithPrevious" class="detail-value"></div>
                        <textarea id="editDetailComparisonWithPrevious" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>改善后风险:</label>
                        <div id="detailPostImprovementRisk" class="detail-value"></div>
                        <textarea id="editDetailPostImprovementRisk" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>下一版回归测试:</label>
                        <div id="detailNextVersionRegressionTest" class="detail-value"></div>
                        <textarea id="editDetailNextVersionRegressionTest" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>备注:</label>
                        <div id="detailRemark" class="detail-value"></div>
                        <textarea id="editDetailRemark" class="detail-input" rows="3" style="display: none;"></textarea>
                    </div>
                    <div class="detail-row">
                        <label>内外贸:</label>
                        <span id="detailTestOverseas" class="detail-value"></span>
                        <select id="editDetailTestOverseas" class="detail-input" style="display: none;">
                            <option value="内贸">内贸</option>
                            <option value="外贸">外贸</option>
                        </select>
                    </div>
                    <div class="detail-row">
                        <label>提交时间:</label>
                        <span id="detailCreatedAt" class="detail-value"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="editProblemBtn" class="btn btn-primary" style="display: none;">编辑</button>
            <button id="saveDetailBtn" class="btn btn-success" style="display: none;">保存</button>
            <button id="cancelEditBtn" class="btn btn-secondary" style="display: none;">取消</button>
            <button id="closeProblemDetailModal" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>

<!-- 全局编辑模态框 -->
<div id="globalEditModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>全局编辑 - 批量编辑搜索结果数据</h2>
            <span class="close" onclick="closeGlobalEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                <i class="fas fa-info-circle"></i> 
                <span id="globalEditDataCount">正在加载数据...</span>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="globalEditTable" class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 50px;">序号</th>
                            <th>大编码</th>
                            <th>小编码</th>
                            <th>项目阶段</th>
                            <th>版本</th>
                            <th>供应商</th>
                            <th>问题状态</th>
                            <th>组别</th>
                            <th>品类</th>
                            <th>DQE责任人</th>
                            <th>数据来源</th>
                            <th>发生日期</th>
                        </tr>
                    </thead>
                    <tbody id="globalEditTableBody">
                        <!-- 数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button id="saveGlobalEditBtn" class="btn btn-success">
                <i class="fas fa-save"></i> 保存
            </button>
            <button id="cancelGlobalEditBtn" class="btn btn-secondary" onclick="closeGlobalEditModal()">
                <i class="fas fa-times"></i> 取消
            </button>
        </div>
    </div>
</div>

<!-- 编辑问题点模态框 -->
<div id="editProblemModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>编辑问题点</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editProblemForm">
                <input type="hidden" id="editProblemId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editFullModel">完整编码:</label>
                        <input type="text" id="editFullModel" name="fullModel">
                    </div>
                    <div class="form-group">
                        <label for="editSampleStage">样品阶段:</label>
                        <select id="editSampleStage" name="sampleStage">
                            <option value="EVT">EVT</option>
                            <option value="DVT">DVT</option>
                            <option value="PVT">PVT</option>
                            <option value="MP">MP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editVersion">版本:</label>
                        <input type="text" id="editVersion" name="version">
                    </div>
                    <div class="form-group">
                        <label for="editProblemCategory">问题类别:</label>
                        <select id="editProblemCategory" name="problemCategory">
                            <option value="">请选择问题类别</option>
                            <optgroup label="视频组">
                                <option value="视频播放问题">视频播放问题</option>
                                <option value="视频录制问题">视频录制问题</option>
                                <option value="视频编码问题">视频编码问题</option>
                                <option value="视频解码问题">视频解码问题</option>
                                <option value="视频传输问题">视频传输问题</option>
                                <option value="视频显示问题">视频显示问题</option>
                                <option value="视频格式问题">视频格式问题</option>
                                <option value="视频画质问题">视频画质问题</option>
                                <option value="视频同步问题">视频同步问题</option>
                                <option value="视频卡顿问题">视频卡顿问题</option>
                            </optgroup>
                            <optgroup label="蓝牙组">
                                <option value="蓝牙连接问题">蓝牙连接问题</option>
                                <option value="蓝牙配对问题">蓝牙配对问题</option>
                                <option value="蓝牙传输问题">蓝牙传输问题</option>
                                <option value="蓝牙音频问题">蓝牙音频问题</option>
                                <option value="蓝牙信号问题">蓝牙信号问题</option>
                                <option value="蓝牙兼容性问题">蓝牙兼容性问题</option>
                                <option value="蓝牙功耗问题">蓝牙功耗问题</option>
                                <option value="蓝牙协议问题">蓝牙协议问题</option>
                                <option value="蓝牙设备识别问题">蓝牙设备识别问题</option>
                                <option value="蓝牙断连问题">蓝牙断连问题</option>
                            </optgroup>
                            <optgroup label="硬件组">
                                <option value="硬件设计问题">硬件设计问题</option>
                                <option value="生产问题">生产问题</option>
                                <option value="器件问题">器件问题</option>
                                <option value="配件问题">配件问题</option>
                                <option value="外观问题">外观问题</option>
                                <option value="PCBA问题">PCBA问题</option>
                                <option value="电路问题">电路问题</option>
                                <option value="接口问题">接口问题</option>
                                <option value="散热问题">散热问题</option>
                                <option value="机械结构问题">机械结构问题</option>
                            </optgroup>
                            <optgroup label="软件组">
                                <option value="软件问题">软件问题</option>
                                <option value="系统问题">系统问题</option>
                                <option value="驱动问题">驱动问题</option>
                                <option value="固件问题">固件问题</option>
                                <option value="应用问题">应用问题</option>
                                <option value="界面问题">界面问题</option>
                                <option value="性能问题">性能问题</option>
                                <option value="兼容性问题">兼容性问题</option>
                                <option value="稳定性问题">稳定性问题</option>
                                <option value="功能缺失问题">功能缺失问题</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDefectLevel">缺陷等级:</label>
                        <select id="editDefectLevel" name="defectLevel">
                            <option value="S">S</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="待确定">待确定</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCurrentStatus">当前状态:</label>
                        <select id="editCurrentStatus" name="currentStatus">
                            <option value="open">open</option>
                            <option value="close">close</option>
                            <option value="follow up">follow up</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editProblem">问题描述:</label>
                        <textarea id="editProblem" name="problem" rows="3"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editProblemImage">问题图片:</label>
                        <div class="image-edit-container">
                            <textarea id="editProblemImage" name="problem_image_or_video" rows="2" placeholder="请输入图片路径，多个图片用逗号分隔，如：/imageDirectory/image1.png,/imageDirectory/image2.png"></textarea>
                            <div class="image-preview" id="editImagePreview"></div>
                            <div class="image-edit-tips">
                                <small>支持格式：/imageDirectory/图片名称.png 或 多个路径用逗号分隔</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="editReproductionMethod">复现手法:</label>
                        <textarea id="editReproductionMethod" name="reproductionMethod" rows="3"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editRecoveryMethod">恢复方法:</label>
                        <textarea id="editRecoveryMethod" name="recoveryMethod" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editReproductionProbability">复现概率:</label>
                        <input type="text" id="editReproductionProbability" name="reproductionProbability">
                    </div>
                    <div class="form-group">
                        <label for="editTester">测试人员:</label>
                        <input type="text" id="editTester" name="tester">
                    </div>
                    <div class="form-group">
                        <label for="editResponsibleDepartment">责任部门:</label>
                        <select id="editResponsibleDepartment" name="responsibleDepartment">
                            <option value="SQE">SQE</option>
                            <option value="ID">ID</option>
                            <option value="结构">结构</option>
                            <option value="研发">研发</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editResponsiblePerson">分析责任人:</label>
                        <input type="text" id="editResponsiblePerson" name="responsiblePerson">
                    </div>
                    <div class="form-group full-width">
                        <label for="editImprovementPlan">改善对策:</label>
                        <textarea id="editImprovementPlan" name="improvementPlan" rows="3"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editGreenUnionDqe">DQE回复:</label>
                        <textarea id="editGreenUnionDqe" name="greenUnionDqe" rows="3"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="editGreenUnionRd">研发回复:</label>
                        <textarea id="editGreenUnionRd" name="greenUnionRd" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTestOverseas">内外贸:</label>
                        <select id="editTestOverseas" name="testOverseas">
                            <option value="内贸">内贸</option>
                            <option value="外贸">外贸</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editRemark">备注:</label>
                        <textarea id="editRemark" name="remark" rows="3"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="saveProblemBtn" class="btn btn-primary">保存</button>
            <button id="cancelEditProblemBtn" class="btn btn-secondary">取消</button>
        </div>
    </div>
</div>

<!-- 历史版本模态框 -->
<div id="historyVersionsModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>历史版本</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="history-versions-container">
                <table id="historyVersionsTable" class="data-table">
                    <thead>
                    <tr>
                        <th>版本号</th>
                        <th>问题描述</th>
                        <th>状态</th>
                        <th>修改人</th>
                        <th>修改时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="historyVersionsTableBody">
                    <!-- 历史版本数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button id="closeHistoryModal" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>

<!-- 收藏夹模态框 -->
<div id="cartModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>收藏夹管理</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="cart-controls">
                <button id="clearCartBtn" class="btn btn-danger btn-sm">
                    <i class="fas fa-trash"></i> 清空收藏夹
                </button>
                <button id="exportCartBtn" class="btn btn-success btn-sm">
                    <i class="fas fa-download"></i> 导出收藏夹数据
                </button>
                <button id="mergeChartBtn" class="btn btn-info btn-sm">
                    <i class="fas fa-chart-bar"></i> 合并画图
                </button>
            </div>

            <div class="cart-items-container">
                <table id="cartItemsTable" class="data-table">
                    <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllCartItems" title="全选/取消全选">
                        </th>
                        <th>序号</th>
                        <th>筛选条件</th>
                        <th>数据量</th>
                        <th>保存时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="cartItemsTableBody">
                    <!-- 收藏夹项目将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>

            <!-- 合并数据展示区域 -->
            <div id="mergedDataSection" class="merged-data-section" style="display: none;">
                <h3>合并数据预览</h3>
                <div class="merged-stats">
                    <span>总数据量: <strong id="mergedTotalCount">0</strong></span>
                    <span>去重后: <strong id="mergedUniqueCount">0</strong></span>
                </div>
                
                <!-- 合并数据图表控制区域 -->
                <div class="merged-chart-controls" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #495057;">图表字段:</label>
                        <select id="mergedChartField" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="">请选择分组字段</option>
                            <option value="problemLevel">问题等级</option>
                            <option value="majorCode">大编码</option>
                            <option value="minorCode">小编码</option>
                            <option value="projectPhase">项目阶段</option>
                            <option value="version">版本</option>
                            <option value="problemProcess">问题工序</option>
                            <option value="developmentMethod">开发方式</option>
                            <option value="supplier">供应商</option>
                            <option value="solutionProvider">方案商</option>
                            <option value="problemPoint">问题点</option>
                            <option value="problemReason">问题原因</option>
                            <option value="improvementStrategy">改善对策</option>
                            <option value="isPreventable">是否可预防</option>
                            <option value="responsibleDepartment">责任部门</option>
                            <option value="problemStatus">问题状态</option>
                            <option value="problemTag1">问题打标1</option>
                            <option value="problemTag2">问题打标2</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="chart-type-buttons">
                            <button class="chart-type-btn active" data-type="bar" onclick="switchMergedChartType('bar')">柱状图</button>
                            <button class="chart-type-btn" data-type="pie" onclick="switchMergedChartType('pie')">饼状图</button>
                            <button class="chart-type-btn" data-type="line" onclick="switchMergedChartType('line')">折线图</button>
                        </div>
                        <button id="generateMergedChartBtn" class="btn btn-primary btn-sm" onclick="generateMergedChart()">
                            <i class="fas fa-chart-bar"></i> 生成图表
                        </button>
                    </div>
                </div>
                
                <!-- 合并数据图表容器 -->
                <div id="mergedChartContainer" class="merged-chart-container" style="display: none; margin-top: 20px; padding: 20px; background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="chart-canvas-container" style="position: relative; height: 400px; width: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        <canvas id="mergedDataChart" class="chart-canvas" style="max-width: 100%; max-height: 100%; width: 100% !important; height: 100% !important;"></canvas>
                        <div id="annotationOverlayMerged" class="chart-annotation-overlay"></div>
                        <button class="add-annotation-btn" onclick="addAnnotation('merged')" title="添加注释">
                            <i class="fas fa-comment"></i> 添加注释
                        </button>
                    </div>
                </div>
                <div class="merged-table-container">
                    <table id="mergedDataTable" class="data-table">
                          <thead>
                          <tr>
                             <th data-key="id">ID</th>
                             <th data-key="group">组别</th>
                             <th data-key="category">品类</th>
                             <th data-key="testDate">发生日期</th>
                             <th data-key="majorCode">大编码</th>
                             <th data-key="minorCode">小编码</th>
                             <th data-key="projectPhase">项目阶段</th>
                             <th data-key="version">版本</th>
                             <th data-key="problemProcess">问题工序</th>
                             <th data-key="problemLevel">问题等级</th>
                             <th data-key="developmentMethod">开发方式</th>
                             <th data-key="supplier">供应商</th>
                             <th data-key="solutionProvider">方案商</th>
                             <th data-key="problemPoint">问题点</th>
                             <th data-key="problemReason">问题原因</th>
                             <th data-key="improvementMeasures">改善对策</th>
                             <th data-key="isPreventable">是否可预防</th>
                             <th data-key="responsibleDepartment">责任部门</th>
                             <th data-key="dqeResponsible">DQE负责人</th>
                             <th data-key="problemStatus">问题状态</th>
                             <th data-key="plannedCompletionTime">预计完成时间</th>
                             <th data-key="actualCompletionTime">实际完成时间</th>
                             <th data-key="delayDays">Delay天数</th>
                             <th data-key="problemTag1">问题打标1</th>
                             <th data-key="problemTag2">问题打标2</th>
                             <th data-key="preventionNotes">预防备注</th>
                             <th data-key="dataSource">数据来源</th>
                             <th data-key="createdTime">创建时间</th>
                             <th data-key="updatedTime">更新时间</th>
                          </tr>
                          </thead>
                        <tbody id="mergedDataTableBody">
                        <!-- 合并数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="closeCartModal" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>

<!-- 收藏夹详情模态框 -->
<div id="cartDetailModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>收藏夹详情</h2>
            <span class="close" onclick="closeSpecificModal('cartDetailModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="cart-detail-info">
                <div class="detail-row">
                    <label>筛选条件:</label>
                    <span id="cartDetailFilter" class="detail-value"></span>
                </div>
                <div class="detail-row">
                    <label>数据量:</label>
                    <span id="cartDetailCount" class="detail-value"></span>
                </div>
                <div class="detail-row">
                    <label>保存时间:</label>
                    <span id="cartDetailTime" class="detail-value"></span>
                </div>
            </div>

            <div class="cart-detail-table-container">
                <table id="cartDetailTable" class="data-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>完整编码</th>
                        <th>大类</th>
                        <th>小类</th>
                        <th>样品阶段</th>
                        <th>版本</th>
                        <th>测试平台</th>
                        <th>显示设备</th>
                        <th>其他设备</th>
                        <th>问题描述</th>
                        <th>问题类别</th>
                        <th>缺陷等级</th>
                        <th>当前状态</th>
                        <th>测试人员</th>
                        <th>DQE责任人</th>
                        <th>责任部门</th>
                        <th>DQE确认回复</th>
                        <th>研发确认回复</th>
                        <th>提交时间</th>
                    </tr>
                    </thead>
                    <tbody id="cartDetailTableBody">
                    <!-- 详情数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="applyCartFilters()">重新搜索</button>
            <button class="btn btn-secondary" onclick="closeSpecificModal('cartDetailModal')">关闭</button>
        </div>
    </div>
</div>

<!-- 加载提示 -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>加载中...</p>
    </div>
</div>

<!-- 自定义提示框 -->
<div id="customToast" class="custom-toast">
    <div class="toast-content">
        <div class="toast-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="toast-message" id="toastMessage">操作成功</div>
        <div class="toast-close" id="toastClose">
            <i class="fas fa-times"></i>
        </div>
    </div>
</div>

<!-- 可复制消息模态框 -->
<div id="copyableModal" class="copyable-modal-overlay">
    <div class="copyable-modal-content">
        <div class="copyable-modal-header">
            <h4 id="copyableModalTitle">提示信息</h4>
            <span class="copyable-modal-close" onclick="closeCopyableDialog()">&times;</span>
        </div>
        <textarea id="copyableModalTextarea" class="copyable-modal-textarea" readonly></textarea>
        <div class="copyable-modal-actions">
            <button class="btn btn-secondary" onclick="closeCopyableDialog()">关闭</button>
            <button class="btn btn-primary" id="copyableModalCopyBtn">复制内容</button>
        </div>
    </div>
</div>

<!-- 底部导航 -->
<div class="bottom-nav">
    <button class="nav-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
        <span>返回</span>
    </button>
    <button class="nav-btn" onclick="goHome()">
        <i class="fas fa-home"></i>
        <span>主页</span>
    </button>
</div>

<script>
    // 全局变量
    let currentUser = '';
    let currentRole = '';
    let departmentName = ''; // 用户所属部门名称
    
    // 统一的权限检查函数：只有DQE或manager角色可以使用
    function checkDQEOrManagerPermission() {
        if (currentRole !== 'DQE' && currentRole !== 'manager') {
            showToast('只有DQE或manager角色才能进行此操作', 'error');
            return false;
        }
        return true;
    }

    // 图表相关变量 - 支持双图表
    var currentChart1 = null;
    var currentChart2 = null;
    var currentChartTypeStats = 'bar';
    var currentChartType1 = 'bar';
    var currentChartType2 = 'bar';
    var chartSortOrder1 = 'none'; // 排序状态: 'none', 'asc', 'desc'
    var chartSortOrder2 = 'none'; // 排序状态: 'none', 'asc', 'desc'
    let currentPage = 1;
    let pageSize = 20;
    let totalCount = 0;

    const copyableModal = document.getElementById('copyableModal');
    const copyableModalTitle = document.getElementById('copyableModalTitle');
    const copyableModalTextarea = document.getElementById('copyableModalTextarea');
    const copyableModalCopyBtn = document.getElementById('copyableModalCopyBtn');

    if (copyableModalCopyBtn) {
        copyableModalCopyBtn.addEventListener('click', () => {
            if (!copyableModalTextarea) {
                return;
            }
            const text = copyableModalTextarea.value;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => showToast('内容已复制到剪贴板', 'success'))
                    .catch(() => {
                        copyableModalTextarea.select();
                        document.execCommand('copy');
                        showToast('内容已复制到剪贴板', 'success');
                    });
            } else {
                copyableModalTextarea.select();
                document.execCommand('copy');
                showToast('内容已复制到剪贴板', 'success');
            }
        });
    }

    // 图表模态框控制函数
    function openChartsModal() {
        const modal = document.getElementById('chartsModal');
        if (modal) {
            modal.style.display = 'block';
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.position = 'relative';
                modalContent.style.left = 'auto';
                modalContent.style.top = 'auto';
                modalContent.style.margin = '2% auto';
                
                // 只有第一次打开或者没有被移动过时，才居中显示
                // 如果之前移动过，保持之前的位置
                if (modalDragState.xOffset === 0 && modalDragState.yOffset === 0) {
                    modalContent.style.transform = 'translate3d(0, 0, 0)';
                } else {
                    // 保持之前移动的位置
                    modalContent.style.transform = `translate3d(${modalDragState.xOffset}px, ${modalDragState.yOffset}px, 0)`;
                }
            }
            // 保持拖拽状态（不重置）
            modalDragState.isDragging = false;
        }
    }

    function closeChartsModal() {
        const modal = document.getElementById('chartsModal');
        if (modal) {
            modal.style.display = 'none';
            // 不重置位置，保留拖拽后的位置供下次使用
        }
    }

    // 打开电气测试问题点模态框
    function openTestIssuesModal() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        const modal = document.getElementById('testIssuesModal');
        if (modal) {
            modal.style.display = 'block';
            // 应用列可见性设置
            applyTestIssuesColumnVisibility();
        }
    }
    
    // 应用列可见性设置到电气测试问题点表格
    function applyTestIssuesColumnVisibility() {
        try {
            const saved = localStorage.getItem('columnVisibility');
            if (saved) {
                const visibility = JSON.parse(saved);
                // 应用设置到电气测试问题点表格
                columnDefinitions.forEach(col => {
                    if (!col.alwaysVisible && visibility.hasOwnProperty(col.key)) {
                        const header = document.querySelector(`#testIssuesTable th[data-key="${col.key}"]`);
                        if (header) {
                            if (visibility[col.key]) {
                                header.classList.remove('hidden');
                            } else {
                                header.classList.add('hidden');
                            }
                        }
                        
                        // 应用设置到数据行
                        const rows = document.querySelectorAll('#testIssuesTableBody tr');
                        rows.forEach(row => {
                            const cell = row.querySelector(`td[data-key="${col.key}"]`);
                            if (cell) {
                                if (visibility[col.key]) {
                                    cell.classList.remove('hidden');
                                } else {
                                    cell.classList.add('hidden');
                                }
                            }
                        });
                    }
                });
            }
        } catch (e) {
            console.error('应用电气测试问题点列可见性设置失败:', e);
        }
    }

    // 关闭电气测试问题点模态框
    function closeTestIssuesModal() {
        const modal = document.getElementById('testIssuesModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // 搜索电气测试问题点
    function searchTestIssues() {
        const keyword = document.getElementById('testIssuesSearchKeyword').value;
        const majorCode = document.getElementById('testIssuesMajorCode').value;
        const minorCode = document.getElementById('testIssuesMinorCode').value;
        const version = document.getElementById('testIssuesVersion').value;
        const problemStatus = document.getElementById('testIssuesProblemStatus').value;
        const group = document.getElementById('testIssuesGroup').value;
        const category = document.getElementById('testIssuesCategory').value;
        const dqeResponsible = document.getElementById('testIssuesDqeResponsible').value;
        
        showLoading();
        
        // 构建查询参数
        const params = new URLSearchParams();
        if (keyword) params.append('keyword', keyword);
        if (majorCode) params.append('majorCode', majorCode);
        if (minorCode) params.append('minorCode', minorCode);
        if (version) params.append('version', version);
        if (problemStatus) params.append('problemStatus', problemStatus);
        if (group) params.append('group', group);
        if (category) params.append('category', category);
        if (dqeResponsible) params.append('dqeResponsible', dqeResponsible);
        
        fetch('/reviewResult/getTestIssues?' + params.toString())
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    renderTestIssuesTable(data.data);
                    document.getElementById('testIssuesTotalRecords').textContent = data.total || 0;
                } else {
                    alert('查询失败: ' + data.error);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('查询时发生错误');
            });
    }

    // 重置电气测试问题点搜索
    function resetTestIssuesSearch() {
        document.getElementById('testIssuesSearchKeyword').value = '';
        document.getElementById('testIssuesMajorCode').value = '';
        document.getElementById('testIssuesMinorCode').value = '';
        document.getElementById('testIssuesVersion').value = '';
        document.getElementById('testIssuesProblemStatus').value = '';
        document.getElementById('testIssuesGroup').value = '';
        document.getElementById('testIssuesCategory').value = '';
        document.getElementById('testIssuesDqeResponsible').value = '';
        // 只清空过滤器，不触发搜索
    }

    // 渲染电气测试问题点表格
    function renderTestIssuesTable(data) {
        const tbody = document.getElementById('testIssuesTableBody');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="30" style="text-align: center;">暂无数据</td></tr>';
            return;
        }

        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td data-key="checkbox">
                    <input type="checkbox" class="test-issues-row-checkbox" data-id="${item.id}" title="选择此行">
                </td>
                <td data-key="id">${item.id || '-'}</td>
                <td data-key="group">${item.group || '-'}</td>
                <td data-key="category">${item.category || '-'}</td>
                <td data-key="testDate">${item.problemTime || '-'}</td>
                <td data-key="majorCode">${item.sampleModel || '-'}</td>
                <td data-key="minorCode">${item.sampleCoding || '-'}</td>
                <td data-key="projectPhase">${item.sampleStage || '-'}</td>
                <td data-key="version">${item.version || '-'}</td>
                <td data-key="problemProcess" class="problem-desc" title="${item.problemProcess || ''}">${(item.problemProcess || '').substring(0, 20)}${(item.problemProcess || '').length > 20 ? '...' : ''}</td>
                <td data-key="problemLevel"><span class="status-badge status-${item.defectLevel?.toLowerCase() || ''}">${item.defectLevel || '-'}</span></td>
                <td data-key="developmentMethod" class="problem-desc" title="${item.developmentMethod || ''}">${(item.developmentMethod || '').substring(0, 20)}${(item.developmentMethod || '').length > 20 ? '...' : ''}</td>
                <td data-key="supplier" class="problem-desc" title="${item.supplier || ''}">${(item.supplier || '').substring(0, 20)}${(item.supplier || '').length > 20 ? '...' : ''}</td>
                <td data-key="solutionProvider" class="problem-desc" title="${item.solutionProvider || ''}">${(item.solutionProvider || '').substring(0, 20)}${(item.solutionProvider || '').length > 20 ? '...' : ''}</td>
                <td data-key="problemPoint" class="problem-desc" title="${item.problem || ''}">${(item.problem || '').substring(0, 30)}${(item.problem || '').length > 30 ? '...' : ''}</td>
                <td data-key="problemReason" class="problem-desc" title="${item.greenUnionDqe || ''}">${(item.greenUnionDqe || '').substring(0, 30)}${(item.greenUnionDqe || '').length > 30 ? '...' : ''}</td>
                <td data-key="improvementMeasures" class="problem-desc" title="${item.greenUnionRd || ''}">${(item.greenUnionRd || '').substring(0, 30)}${(item.greenUnionRd || '').length > 30 ? '...' : ''}</td>
                <td data-key="isPreventable">${item.isPreventable || '-'}</td>
                <td data-key="responsibleDepartment">${item.responsibleDepartment || '-'}</td>
                <td data-key="dqeResponsible">${item.dqeResponsible || '-'}</td>
                <td data-key="problemStatus"><span class="status-badge status-${item.currentStatus?.toLowerCase().replace(' ', '') || ''}">${item.currentStatus || '-'}</span></td>
                <td data-key="plannedCompletionTime">${item.plannedCompletionTime || '-'}</td>
                <td data-key="actualCompletionTime">${item.actualCompletionTime || '-'}</td>
                <td data-key="delayDays">${item.delayDays || '-'}</td>
                <td data-key="problemTag1" class="problem-desc" title="${item.problemTag1 || ''}">${(item.problemTag1 || '').substring(0, 20)}${(item.problemTag1 || '').length > 20 ? '...' : ''}</td>
                <td data-key="problemTag2" class="problem-desc" title="${item.problemTag2 || ''}">${(item.problemTag2 || '').substring(0, 20)}${(item.problemTag2 || '').length > 20 ? '...' : ''}</td>
                <td data-key="preventionNotes" class="problem-desc" title="${item.remark || ''}">${(item.remark || '').substring(0, 30)}${(item.remark || '').length > 30 ? '...' : ''}</td>
                <td data-key="createdTime">${item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '-'}</td>
                <td data-key="updatedTime">-</td>
            `;
            tbody.appendChild(row);
        });
        
        // 为每个checkbox添加事件监听器
        const checkboxes = tbody.querySelectorAll('.test-issues-row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleTestIssuesCheckboxChange);
        });
        
        // 全选checkbox事件监听器（确保只绑定一次）
        const selectAllCheckbox = document.getElementById('selectAllTestIssuesRows');
        if (selectAllCheckbox && !selectAllCheckbox.hasAttribute('data-bound')) {
            selectAllCheckbox.setAttribute('data-bound', 'true');
            selectAllCheckbox.addEventListener('change', function() {
                const checked = this.checked;
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checked;
                });
            });
        }
        
        // 渲染完表格后应用列可见性设置
        applyTestIssuesColumnVisibility();
    }
    
    // 处理电气测试问题点checkbox变化
    function handleTestIssuesCheckboxChange() {
        const checkboxes = document.querySelectorAll('.test-issues-row-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllTestIssuesRows');
        
        if (selectAllCheckbox) {
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
    }

    // 导入电气测试问题点到新品质量问题
    function addTestIssuesToReview() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 获取所有选中的checkbox
        const checkedBoxes = document.querySelectorAll('.test-issues-row-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            alert('请至少选择一条记录！');
            return;
        }
        
        // 获取选中的ID列表
        const selectedIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-id'));
        
        // 确认操作
        if (!confirm(`确定要将选中的 ${selectedIds.length} 条记录导入到新品质量问题吗？`)) {
            return;
        }
        
        showLoading();
        
        // 发送请求到后端
        fetch('/reviewResult/addTestIssuesToReview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ids: selectedIds
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                // 构建详细提示消息
                let message = `成功导入 ${data.addedCount} 条记录到新品质量问题！`;
                if (data.skippedCount && data.skippedCount > 0) {
                    message += `\n\n跳过 ${data.skippedCount} 条已存在的记录：`;
                    if (data.skippedRecords && data.skippedRecords.length > 0) {
                        data.skippedRecords.forEach((record, index) => {
                            message += `\n${index + 1}. 大编码：${record.majorCode || '-'}，小编码：${record.minorCode || '-'}，项目阶段：${record.projectPhase || '-'}，版本：${record.version || '-'}，供应商：${record.supplier || '-'}，问题点：${record.problemPoint || '-'}`;
                        });
                    }
                }
                alert(message);
                // 刷新外边主表数据
                loadReviewData();
                // 关闭模态框
                closeTestIssuesModal();
            } else {
                alert('添加失败: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('添加时发生错误');
        });
    }

    // 点击模态框外部关闭
    window.onclick = function(event) {
        const chartsModal = document.getElementById('chartsModal');
        if (event.target == chartsModal) {
            closeChartsModal();
        }
        const testIssuesModal = document.getElementById('testIssuesModal');
        if (event.target == testIssuesModal) {
            closeTestIssuesModal();
        }
    }

    // 模态框拖拽功能
    let modalDragState = {
        isDragging: false,
        currentX: 0,
        currentY: 0,
        initialX: 0,
        initialY: 0,
        xOffset: 0,
        yOffset: 0
    };

    function dragStart(e) {
        // 检查是否点击了关闭按钮
        if (e.target.classList.contains('close') || e.target.closest('.close')) {
            return;
        }
        
        // 只有点击标题栏时才启动拖拽
        const modalHeader = e.target.closest('.modal-header');
        if (modalHeader) {
            modalDragState.initialX = e.clientX - modalDragState.xOffset;
            modalDragState.initialY = e.clientY - modalDragState.yOffset;
            modalDragState.isDragging = true;
        }
    }

    function drag(e) {
        if (modalDragState.isDragging) {
            e.preventDefault();
            modalDragState.currentX = e.clientX - modalDragState.initialX;
            modalDragState.currentY = e.clientY - modalDragState.initialY;

            modalDragState.xOffset = modalDragState.currentX;
            modalDragState.yOffset = modalDragState.currentY;

            const modalContent = document.querySelector('#chartsModal .modal-content');
            if (modalContent) {
                setTranslate(modalDragState.currentX, modalDragState.currentY, modalContent);
            }
        }
    }

    function dragEnd(e) {
        modalDragState.initialX = modalDragState.currentX;
        modalDragState.initialY = modalDragState.currentY;
        modalDragState.isDragging = false;
    }

    function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
    }

    // 初始化拖拽事件监听器
    function initModalDrag() {
        const modal = document.getElementById('chartsModal');
        if (modal) {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
            }
        }
    }

    // 切换图表类型函数
    // 切换图表类型函数 - 支持双图表
    function switchChartType(type, chartNumber) {
        console.log('🎯 switchChartType函数被调用，类型:', type, '图表编号:', chartNumber);
        
        // 更新对应图表的类型
        if (chartNumber === 1) {
            currentChartType1 = type;
            console.log('✅ 图表1类型已更新为:', currentChartType1);
        } else if (chartNumber === 2) {
            currentChartType2 = type;
            console.log('✅ 图表2类型已更新为:', currentChartType2);
        }
        
        // 更新对应图表的按钮状态
        const chartContainer = chartNumber === 1 ? '.chart-left' : '.chart-right';
        const chartTypeButtons = document.querySelectorAll(`${chartContainer} .chart-type-btn`);
        chartTypeButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.type === type) {
                btn.classList.add('active');
                console.log('✅ 按钮状态已更新:', btn.textContent, '-> active');
            }
        });
        
        // 检查是否有现有图表并销毁
        if (chartNumber === 1 && currentChart1) {
            console.log('📊 销毁图表1');
            currentChart1.destroy();
            currentChart1 = null;
        } else if (chartNumber === 2 && currentChart2) {
            console.log('📊 销毁图表2');
            currentChart2.destroy();
            currentChart2 = null;
        }
        
        // 如果已经有分组字段，自动重新生成图表（使用全部搜索结果数据）
        const groupFieldId = chartNumber === 1 ? 'groupField1' : 'groupField2';
        const groupField = document.getElementById(groupFieldId);
        const groupFieldValue = groupField ? groupField.value : null;
        const currentChartType = chartNumber === 1 ? currentChartType1 : currentChartType2;
        const chartSortOrder = chartNumber === 1 ? chartSortOrder1 : chartSortOrder2;
        
        console.log('📋 当前状态检查:', {
            groupField: groupFieldValue,
            currentChartType: currentChartType,
            chartNumber: chartNumber
        });
        
        if (groupFieldValue) {
            console.log('🚀 开始重新生成图表', chartNumber, '，类型:', currentChartType, '，使用全部搜索结果数据');
            
            // 重新获取全部搜索结果数据并生成图表
            getAllSearchData()
                .then(allSearchData => {
                    console.log('获取到的全部搜索结果数据用于图表切换:', allSearchData.length);
                    if (allSearchData && allSearchData.length > 0) {
                        try {
                            processChartData(allSearchData, groupFieldValue, currentChartType, chartSortOrder, chartNumber);
                            console.log('✅ 图表', chartNumber, '重新生成完成，使用数据量:', allSearchData.length);
                        } catch (error) {
                            console.error('❌ 图表', chartNumber, '重新生成失败:', error);
                        }
                    } else {
                        console.log('ℹ️ 没有搜索结果数据');
                        showNoDataMessage(chartNumber);
                    }
                })
                .catch(error => {
                    console.error('❌ 获取全部数据失败:', error);
                });
        } else {
            console.log('ℹ️ 没有选择分组字段，等待用户操作');
        }
    }
    let totalPages = 1;
    let allData = [];
    let currentEditingReviewId = null;
    let filteredData = [];
    let allSearchData = []; // 存储搜索的全部数据，用于建议功能

    // 购物车/收藏夹相关变量
    let cartItems = []; // 收藏夹项目
    let mergedData = []; // 合并后的数据
    let mergedChart = null; // 合并数据图表实例
    let mergedChartType = 'bar'; // 合并数据图表类型

    // 缓存相关变量
    let speciesCache = {
        bigSpecies: null,
        smallSpecies: null,
        sampleStage: null,
        fullModel: null,
        version: null,
        problemCategory: null,
        tester: null,
        responsibleDepartment: null,
        testPlatform: null,
        testDevice: null,
        lastUpdated: null
    };

    // 标准化状态显示
    function normalizeStatus(status) {
        if (!status) return '';
        const normalized = status.toLowerCase().trim();
        switch (normalized) {
            case 'open':
                return 'open';
            case 'closed':
            case 'close':
                return 'close';
            case 'follow up':
            case 'followup':
                return 'follow up';
            default:
                return status; // 保持原值
        }
    }

    // 标准化问题状态过滤器值 - 支持模糊搜索和大小写兼容
    function normalizeProblemStatus(status) {
        if (!status) return '';
        
        console.log('🔍 问题状态模糊搜索（支持包含匹配）:', status);
        
        // 支持模糊搜索，不区分大小写
        // 用户输入"follow"可以匹配"followingUp"、"Follow"、"FOLLOW"等
        // 用户输入"open"可以匹配"Open"、"OPEN"、"opening"等
        // 用户输入"close"可以匹配"Closed"、"close"、"closing"等
        return status.trim().toLowerCase();
    }

    // 格式化日期显示
    function formatDate(dateString) {
        if (!dateString || dateString === '-') return '-';
        
        try {
            // 如果是ISO格式的日期时间字符串，提取日期部分
            if (dateString.includes('T')) {
                return dateString.split('T')[0];
            }
            
            // 如果是其他格式，尝试解析并格式化
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            
            // 如果解析失败，返回原值
            return dateString;
        } catch (error) {
            return dateString;
        }
    }

    // 缓存管理函数
    function getCachedSpeciesOptions(speciesType) {
        // 先从内存缓存获取
        if (speciesCache[speciesType]) {
            return speciesCache[speciesType];
        }

        // 如果内存缓存没有，从localStorage获取
        try {
            const cached = localStorage.getItem('speciesCache');
            if (cached) {
                const parsedCache = JSON.parse(cached);
                if (parsedCache[speciesType] && isCacheValid(parsedCache.lastUpdated)) {
                    // 恢复到内存缓存
                    speciesCache = parsedCache;
                    return speciesCache[speciesType];
                }
            }
        } catch (e) {
            console.error('读取缓存失败:', e);
        }

        return null;
    }

    // 检查并加载缓存选项到下拉框
    function checkAndLoadCachedOptions(speciesType) {
        const cachedOptions = getCachedSpeciesOptions(speciesType);
        if (cachedOptions && cachedOptions.length > 0) {
            updateSelectOptions(speciesType + 'Filter', cachedOptions);
            return true;
        }
        return false;
    }

    function setCachedSpeciesOptions(speciesType, options) {
        // 更新内存缓存
        speciesCache[speciesType] = options;
        speciesCache.lastUpdated = new Date().getTime();

        // 保存到localStorage
        try {
            localStorage.setItem('speciesCache', JSON.stringify(speciesCache));
        } catch (e) {
            console.error('保存缓存失败:', e);
        }

        updateCacheStatusDisplay();
    }

    function isCacheValid(lastUpdated) {
        // 缓存有效期为1小时（3600000毫秒）
        const CACHE_DURATION = 60 * 60 * 1000;
        const timestamp = lastUpdated || speciesCache.lastUpdated;
        return timestamp && (new Date().getTime() - timestamp) < CACHE_DURATION;
    }

    function clearSpeciesCache() {
        // 清除内存缓存
        speciesCache = {
            bigSpecies: null,
            smallSpecies: null,
            sampleStage: null,
            fullModel: null,
            version: null,
            problemCategory: null,
            tester: null,
            responsibleDepartment: null,
            testPlatform: null,
            testDevice: null,
            lastUpdated: null
        };

        // 清除localStorage缓存
        try {
            localStorage.removeItem('speciesCache');
        } catch (e) {
            console.error('清除缓存失败:', e);
        }

        updateCacheStatusDisplay();
    }

    function loadCacheFromStorage() {
        try {
            const cached = localStorage.getItem('speciesCache');
            if (cached) {
                const parsedCache = JSON.parse(cached);
                if (isCacheValid(parsedCache.lastUpdated)) {
                    // 恢复缓存到内存
                    speciesCache = parsedCache;
                    // console.log('缓存已从localStorage恢复');

                    // 从缓存加载选项到下拉框
                    loadOptionsFromCache();
                } else {
                    // console.log('localStorage中的缓存已过期');
                }
            }
        } catch (e) {
            console.error('从localStorage加载缓存失败:', e);
        }
    }

    function loadOptionsFromCache() {
        // 加载大类选项
        if (speciesCache.bigSpecies && speciesCache.bigSpecies.length > 0) {
            updateSelectOptions('bigSpeciesFilter', speciesCache.bigSpecies);
            // console.log('大类选项已从缓存加载');
        }

        // 加载小类选项
        if (speciesCache.smallSpecies && speciesCache.smallSpecies.length > 0) {
            updateSelectOptions('smallSpeciesFilter', speciesCache.smallSpecies);
            // console.log('小类选项已从缓存加载');
        }

        // 加载样品阶段选项
        if (speciesCache.sampleStage && speciesCache.sampleStage.length > 0) {
            updateSelectOptions('sampleStageFilter', speciesCache.sampleStage);
            // console.log('样品阶段选项已从缓存加载');
        }

        // 加载完整编码选项
        if (speciesCache.fullModel && speciesCache.fullModel.length > 0) {
            updateSelectOptions('fullModelFilter', speciesCache.fullModel);
            // console.log('完整编码选项已从缓存加载');
        }

        // 加载版本选项
        if (speciesCache.version && speciesCache.version.length > 0) {
            updateSelectOptions('versionFilter', speciesCache.version);
            // console.log('版本选项已从缓存加载');
        }

        // 加载问题类别选项（三级结构）
        if (speciesCache.problemCategory && speciesCache.problemCategory.length > 0) {
            // 对于三级结构，我们不需要直接更新下拉框选项
            // 因为三级结构是通过配置文件动态生成的
            // console.log('问题类别选项已从缓存加载（三级结构）');
        }

        // 加载测试人员选项
        if (speciesCache.tester && speciesCache.tester.length > 0) {
            updateSelectOptions('testerFilter', speciesCache.tester);
            // console.log('测试人员选项已从缓存加载');
        }

        // 加载责任部门选项
        if (speciesCache.responsibleDepartment && speciesCache.responsibleDepartment.length > 0) {
            updateSelectOptions('responsibleDepartmentFilter', speciesCache.responsibleDepartment);
            // console.log('责任部门选项已从缓存加载');
        }

        // 加载测试平台选项
        if (speciesCache.testPlatform && speciesCache.testPlatform.length > 0) {
            updateSelectOptions('testPlatformFilter', speciesCache.testPlatform);
            // console.log('测试平台选项已从缓存加载');
        }

        // 加载显示设备选项
        if (speciesCache.testDevice && speciesCache.testDevice.length > 0) {
            updateSelectOptions('testDeviceFilter', speciesCache.testDevice);
            // console.log('显示设备选项已从缓存加载');
        }

        // 加载DQE负责人选项
        if (speciesCache.dqe && speciesCache.dqe.length > 0) {
            updateSelectOptions('dqeFilter', speciesCache.dqe);
            // console.log('DQE负责人选项已从缓存加载');
        }
    }

    function updateCacheStatusDisplay() {
        const cacheStatusElement = document.getElementById('cacheStatus');
        if (!cacheStatusElement) return;

        if (speciesCache.lastUpdated && isCacheValid()) {
            const timeAgo = Math.floor((new Date().getTime() - speciesCache.lastUpdated) / 1000 / 60);
            cacheStatusElement.textContent = `缓存有效 (${timeAgo}分钟前)`;
            cacheStatusElement.style.color = '#28a745';
        } else if (speciesCache.lastUpdated) {
            cacheStatusElement.textContent = '缓存已过期';
            cacheStatusElement.style.color = '#ffc107';
        } else {
            cacheStatusElement.textContent = '无缓存';
            cacheStatusElement.style.color = '#6c757d';
        }
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 页面加载完成，开始初始化...');
        console.log('📊 Chart.js是否加载:', typeof Chart !== 'undefined');
        console.log('📊 ChartDataLabels是否加载:', typeof ChartDataLabels !== 'undefined');
        
        // 检查用户权限
        checkUserPermission();

        // 初始化事件监听器
        initEventListeners();
        
        // 初始化过滤器建议功能
        initFilterSuggestions();
        
        // 加载初始的全部数据用于建议功能
        loadAllSearchDataForSuggestions();
        
        // 加载所有数据用于组别统计（不受过滤器影响）
        loadAllDataForGroupStats();

        // 初始化缓存状态显示
        loadCacheFromStorage();
        updateCacheStatusDisplay();

        // 问题类别相关功能已移除

        // 初始化购物车
        loadCartFromStorage();
        updateCartCount();

        // 确保分页控件可见
        const paginationContainer = document.querySelector('.pagination-container');
        if (paginationContainer) {
            paginationContainer.style.display = 'flex';
            // console.log('分页控件已显示');
        } else {
            console.error('找不到分页控件');
        }

        // 加载数据
        loadReviewData();

        // 添加图表模态框按钮事件监听器
        const showChartsBtn = document.getElementById('showChartsBtn');
        if (showChartsBtn) {
            showChartsBtn.addEventListener('click', function() {
                AccessLogUtil.record("新品质量问题页面-数据可视化按钮")
                openChartsModal();
            });
        }

        // 添加电气测试问题点按钮事件监听器
        const showTestIssuesBtn = document.getElementById('showTestIssuesBtn');
        if (showTestIssuesBtn) {
            showTestIssuesBtn.addEventListener('click', function() {
                openTestIssuesModal();
            });
        }

        // 添加全局编辑按钮事件监听器
        const globalEditBtn = document.getElementById('globalEditBtn');
        if (globalEditBtn) {
            globalEditBtn.addEventListener('click', toggleGlobalEditMode);
        }

        // 添加保存全局编辑按钮事件监听器
        const saveGlobalEditBtn = document.getElementById('saveGlobalEditBtn');
        if (saveGlobalEditBtn) {
            saveGlobalEditBtn.addEventListener('click', saveGlobalEditFromTable);
        }

        // 添加电气测试问题点搜索按钮事件监听器
        const testIssuesSearchBtn = document.getElementById('testIssuesSearchBtn');
        if (testIssuesSearchBtn) {
            testIssuesSearchBtn.addEventListener('click', function() {
                searchTestIssues();
            });
        }

        const testIssuesResetBtn = document.getElementById('testIssuesResetBtn');
        if (testIssuesResetBtn) {
            testIssuesResetBtn.addEventListener('click', function() {
                resetTestIssuesSearch();
            });
        }

        // 导入电气测试问题点到新品质量问题按钮事件监听器
        const testIssuesAddToReviewBtn = document.getElementById('testIssuesAddToReviewBtn');
        if (testIssuesAddToReviewBtn) {
            testIssuesAddToReviewBtn.addEventListener('click', function() {
                AccessLogUtil.record("新品质量问题页面-导入到新品质量问题按钮");
                addTestIssuesToReview();
            });
        }

        // 添加电气测试问题点输入框回车键事件监听器
        const testIssuesTextInputs = [
            'testIssuesMajorCode',
            'testIssuesMinorCode',
            'testIssuesVersion',
            'testIssuesSearchKeyword',
            'testIssuesGroup',
            'testIssuesCategory',
            'testIssuesDqeResponsible'
        ];
        
        testIssuesTextInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchTestIssues();
                    }
                });
            }
        });
        
        // 为下拉框添加change事件，选择后自动搜索
        const testIssuesSelect = document.getElementById('testIssuesProblemStatus');
        if (testIssuesSelect) {
            testIssuesSelect.addEventListener('change', function() {
                searchTestIssues();
            });
        }

        // 初始化模态框拖拽功能
        initModalDrag();

        // 初始化列管理功能
        initColumnManager();
    });

    // ========== 列管理功能 ==========
    // 列定义
    const columnDefinitions = [
        { key: 'checkbox', label: '选择', alwaysVisible: true },
        { key: 'id', label: 'ID', alwaysVisible: true },
        { key: 'group', label: '组别', alwaysVisible: true },
        { key: 'category', label: '品类', alwaysVisible: true },
        { key: 'dqeResponsible', label: 'DQE负责人', alwaysVisible: true },
        { key: 'testDate', label: '发生日期', alwaysVisible: true },
        { key: 'majorCode', label: '大编码' },
        { key: 'minorCode', label: '小编码' },
        { key: 'projectPhase', label: '项目阶段' },
        { key: 'version', label: '版本' },
        { key: 'problemProcess', label: '问题工序' },
        { key: 'problemLevel', label: '问题等级' },
        { key: 'developmentMethod', label: '开发方式' },
        { key: 'supplier', label: '供应商' },
        { key: 'solutionProvider', label: '方案商' },
        { key: 'problemPoint', label: '问题点' },
        { key: 'problemReason', label: '问题原因' },
        { key: 'improvementMeasures', label: '改善对策' },
        { key: 'isPreventable', label: '是否可预防' },
        { key: 'responsibleDepartment', label: '责任部门' },
        { key: 'problemStatus', label: '问题状态' },
        { key: 'plannedCompletionTime', label: '预计完成时间' },
        { key: 'actualCompletionTime', label: '实际完成时间' },
        { key: 'delayDays', label: 'Delay天数' },
        { key: 'problemTag1', label: '问题打标1' },
        { key: 'problemTag2', label: '问题打标2' },
        { key: 'preventionNotes', label: '预防备注' },
        { key: 'dataSource', label: '数据来源', alwaysVisible: true },
        { key: 'createdTime', label: '创建时间' },
        { key: 'updatedTime', label: '更新时间' },
        { key: 'action', label: '操作', alwaysVisible: true }
    ];

    // 初始化列管理
    function initColumnManager() {
        // 从localStorage加载列可见性设置
        loadColumnVisibility();
        
        // 创建列管理菜单
        createColumnManagerMenu();
        
        // 绑定事件
        bindColumnManagerEvents();
    }

    // 创建列管理菜单
    function createColumnManagerMenu() {
        const content = document.querySelector('.column-manager-content');
        if (!content) return;
        
        content.innerHTML = '';
        
        columnDefinitions.forEach(col => {
            const item = document.createElement('div');
            item.className = 'column-manager-item';
            item.innerHTML = `
                <input type="checkbox" id="col_${col.key}" data-key="${col.key}" 
                       ${col.alwaysVisible ? 'disabled checked' : ''} />
                <label for="col_${col.key}">${col.label}${col.alwaysVisible ? ' (必显)' : ''}</label>
            `;
            content.appendChild(item);
        });
        
        // 更新checkbox状态
        updateColumnManagerCheckboxes();
    }

    // 绑定列管理事件
    function bindColumnManagerEvents() {
        // 列管理按钮点击事件
        // 添加编辑权限说明按钮事件监听器
        const editPermissionBtn = document.getElementById('editPermissionBtn');
        if (editPermissionBtn) {
            editPermissionBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleEditPermissionDropdown();
            });
        }

        const btn = document.getElementById('columnManagerBtn');
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleColumnManager();
            });
        }

        // 点击checkbox切换列显示
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.id.startsWith('col_')) {
                const key = e.target.dataset.key;
                const checked = e.target.checked;
                toggleColumn(key, checked);
                saveColumnVisibility();
            }
        });

        // 点击页面其他地方关闭菜单
        document.addEventListener('click', function(e) {
            const columnDropdown = document.getElementById('columnManagerDropdown');
            const columnBtn = document.getElementById('columnManagerBtn');
            if (columnDropdown && columnBtn && !columnDropdown.contains(e.target) && !columnBtn.contains(e.target)) {
                hideColumnManager();
            }
            
            const permissionDropdown = document.getElementById('editPermissionDropdown');
            const permissionBtn = document.getElementById('editPermissionBtn');
            if (permissionDropdown && permissionBtn && !permissionDropdown.contains(e.target) && !permissionBtn.contains(e.target)) {
                hideEditPermissionDropdown();
            }
        });
    }

    // 切换编辑权限说明下拉菜单显示
    function toggleEditPermissionDropdown() {
        const dropdown = document.getElementById('editPermissionDropdown');
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    }

    // 隐藏编辑权限说明下拉菜单
    function hideEditPermissionDropdown() {
        const dropdown = document.getElementById('editPermissionDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }

    // 切换列管理菜单显示
    function toggleColumnManager() {
        const dropdown = document.getElementById('columnManagerDropdown');
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    }

    // 隐藏列管理菜单
    function hideColumnManager() {
        const dropdown = document.getElementById('columnManagerDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }

    // 切换列显示/隐藏
    function toggleColumn(key, visible) {
        // 隐藏所有表格的表头
        const headers = document.querySelectorAll(`th[data-key="${key}"]`);
        headers.forEach(header => {
            if (visible) {
                header.classList.remove('hidden');
            } else {
                header.classList.add('hidden');
            }
        });
        
        // 隐藏所有表格的数据行对应的单元格
        const allTableBodies = ['#reviewTableBody', '#testIssuesTableBody', '#mergedDataTableBody'];
        allTableBodies.forEach(tableBodyId => {
            const rows = document.querySelectorAll(`${tableBodyId} tr`);
            rows.forEach(row => {
                const cell = row.querySelector(`td[data-key="${key}"]`);
                if (cell) {
                    if (visible) {
                        cell.classList.remove('hidden');
                    } else {
                        cell.classList.add('hidden');
                    }
                }
            });
        });
    }

    // 全选/全不选
    function toggleAllColumns(checked) {
        columnDefinitions.forEach(col => {
            if (!col.alwaysVisible) {
                const checkbox = document.getElementById(`col_${col.key}`);
                if (checkbox && !checkbox.disabled) {
                    checkbox.checked = checked;
                    toggleColumn(col.key, checked);
                }
            }
        });
        saveColumnVisibility();
    }

    // 保存列可见性设置到localStorage
    function saveColumnVisibility() {
        const visibility = {};
        columnDefinitions.forEach(col => {
            if (!col.alwaysVisible) {
                const checkbox = document.getElementById(`col_${col.key}`);
                if (checkbox) {
                    visibility[col.key] = checkbox.checked;
                }
            }
        });
        
        try {
            localStorage.setItem('columnVisibility', JSON.stringify(visibility));
        } catch (e) {
            console.error('保存列可见性设置失败:', e);
        }
    }

    // 从localStorage加载列可见性设置
    function loadColumnVisibility() {
        try {
            const saved = localStorage.getItem('columnVisibility');
            if (saved) {
                const visibility = JSON.parse(saved);
                // 应用设置
                columnDefinitions.forEach(col => {
                    if (!col.alwaysVisible && visibility.hasOwnProperty(col.key)) {
                        toggleColumn(col.key, visibility[col.key]);
                    }
                });
            }
        } catch (e) {
            console.error('加载列可见性设置失败:', e);
        }
    }

    // 更新列管理checkbox状态
    function updateColumnManagerCheckboxes() {
        columnDefinitions.forEach(col => {
            if (!col.alwaysVisible) {
                // 检查第一个表格的表头状态（所有表格的列状态应该一致）
                const header = document.querySelector(`th[data-key="${col.key}"]`);
                const checkbox = document.getElementById(`col_${col.key}`);
                if (checkbox && header) {
                    checkbox.checked = !header.classList.contains('hidden');
                }
            }
        });
    }

    // 应用列的可见性设置（用于重新渲染表格后恢复状态）
    function applyColumnVisibility() {
        try {
            const saved = localStorage.getItem('columnVisibility');
            if (saved) {
                const visibility = JSON.parse(saved);
                // 应用设置到所有表头
                columnDefinitions.forEach(col => {
                    if (!col.alwaysVisible && visibility.hasOwnProperty(col.key)) {
                        const headers = document.querySelectorAll(`th[data-key="${col.key}"]`);
                        headers.forEach(header => {
                            if (visibility[col.key]) {
                                header.classList.remove('hidden');
                            } else {
                                header.classList.add('hidden');
                            }
                        });
                    }
                });
                
                // 应用设置到所有表格的数据行
                const allTableBodies = ['#reviewTableBody', '#testIssuesTableBody', '#mergedDataTableBody'];
                allTableBodies.forEach(tableBodyId => {
                    const rows = document.querySelectorAll(`${tableBodyId} tr`);
                    rows.forEach(row => {
                        columnDefinitions.forEach(col => {
                            if (!col.alwaysVisible && visibility.hasOwnProperty(col.key)) {
                                const cell = row.querySelector(`td[data-key="${col.key}"]`);
                                if (cell) {
                                    if (visibility[col.key]) {
                                        cell.classList.remove('hidden');
                                    } else {
                                        cell.classList.add('hidden');
                                    }
                                }
                            }
                        });
                    });
                });
            }
        } catch (e) {
            console.error('应用列可见性设置失败:', e);
        }
    }

    // 获取当前隐藏的列
    function getHiddenColumns() {
        const hiddenColumns = [];
        columnDefinitions.forEach(col => {
            if (!col.alwaysVisible) {
                // 检查第一个表格的表头状态（所有表格的列状态应该一致）
                const header = document.querySelector(`th[data-key="${col.key}"]`);
                if (header && header.classList.contains('hidden')) {
                    hiddenColumns.push(col.key);
                }
            }
        });
        return hiddenColumns;
    }

    // 问题类别相关功能已移除

    // 添加全局点击事件，隐藏所有建议框
    document.addEventListener('click', function(e) {
        // 检查点击是否在建议框或输入框内
        if (!e.target.closest('.input-with-suggestions') && !e.target.closest('.toggle-input-btn')) {
            // 隐藏所有建议框
            document.querySelectorAll('.suggestions-dropdown').forEach(suggestions => {
                hideSuggestions(suggestions);
            });
        }
    });


    // 解析URL参数
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }
    // 检查用户权限
    function checkUserPermission() {
        // 优先从URL参数获取用户信息，其次从localStorage获取
        const urlUsername = getUrlParameter('username');
        const urlJob = getUrlParameter('job');
        const urlDepartmentName = getUrlParameter('departmentName');

        if (urlUsername) {
            currentUser = urlUsername;
            localStorage.setItem('currentUser', currentUser);
            localStorage.setItem('username', currentUser); // 同时保存到username键
        } else {
            currentUser = localStorage.getItem('currentUser') || localStorage.getItem('username') || '';
        }

        if (urlJob) {
            currentRole = urlJob;
            localStorage.setItem('currentRole', currentRole);
            localStorage.setItem('job', currentRole); // 同时保存到job键
        } else {
            // 优先从localStorage获取job信息，如果没有则使用currentRole，最后默认为TestMan
            currentRole = localStorage.getItem('job') || localStorage.getItem('currentRole') || 'TestMan';
            // 将获取到的角色保存到currentRole中
            localStorage.setItem('currentRole', currentRole);
        }

        // 获取部门名称：优先从URL参数获取，其次从localStorage获取，最后从sessionStorage获取
        if (urlDepartmentName) {
            departmentName = urlDepartmentName;
            localStorage.setItem('departmentName', departmentName);
        } else {
            departmentName = localStorage.getItem('departmentName')  || '';
            // 如果从localStorage或sessionStorage获取到，也保存到另一个存储中，确保一致性
            if (departmentName) {
                localStorage.setItem('departmentName', departmentName);
            }
        }

        // 更新页面显示
        document.getElementById('currentUser').textContent = `用户: ${currentUser}`;
        document.getElementById('currentRole').textContent = `角色: ${currentRole}`;

        // 根据权限控制界面元素
        controlEditPermissions();
    }

    // 控制编辑权限
    function controlEditPermissions() {
        // 新增问题点按钮已移除，无需控制
    }

    // 初始化事件监听器
    function initEventListeners() {
        // 搜索按钮
        document.getElementById('searchBtn').addEventListener('click', searchReviews);

        // 重置按钮
        document.getElementById('resetBtn').addEventListener('click', resetFilters);

        // 为筛选输入框添加回车键搜索功能
        const filterInputs = [
            'majorCodeFilter', 'minorCodeFilter', 'projectPhaseFilter', 'versionFilter', 'supplierFilter',
            'problemStatusFilter', 'groupFilter', 'categoryFilter', 'dataSourceFilter', 'dqeResponsibleFilter',
            'testStartDateFilter', 'testEndDateFilter'
        ];

        // 为所有过滤器输入框添加键盘事件监听器
        filterInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchReviews();
                    }
                });
            }
        });


        // 全局键盘事件监听器
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                // 检查当前焦点是否在过滤器输入框或搜索按钮上
                const activeElement = document.activeElement;
                if (activeElement && (
                    filterInputs.includes(activeElement.id) ||
                    activeElement.id === 'searchBtn'
                )) {
                    e.preventDefault();
                    searchReviews();
                }
            }
        });

        // 分页相关事件监听器
        document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
        document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));
        document.getElementById('jumpBtn').addEventListener('click', jumpToPage);
        document.getElementById('lastPageBtn').addEventListener('click', goToLastPage);

        // 页面大小选择
        document.getElementById('pageSizeSelect').addEventListener('change', function() {
            pageSize = parseInt(this.value);
            currentPage = 1; // 重置到第一页
            loadReviewData(); // 重新加载数据
        });

        // 导入相关事件监听器
        document.getElementById('importBtn').addEventListener('click', function() {
            // 权限检查：只有DQE或manager可以使用
            if (!checkDQEOrManagerPermission()) {
                return;
            }
            document.getElementById('importModal').style.display = 'block';
        });

        // 关闭导入模态框
        document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImportModal();
            }
        });

        // 下载模板按钮
        document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
            fetch('/reviewResult/downloadTemplate')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 直接下载文件
                        window.open('/reviewResult/downloadTemplateFile', '_blank');
                        showToast('模板下载已开始', 'success');
                    } else {
                        alert(`模板文件不存在！\n\n${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('下载模板时发生错误:', error);
                    showToast('下载模板时发生错误', 'error');
                });
        });

        // 拖拽上传功能
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            uploadArea.classList.add('dragover');
        }

        function unhighlight() {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            handleFileSelection();
        }

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            const file = fileInput.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('confirmImportBtn').disabled = false;
            }
        }

        // 确认导入按钮
        document.getElementById('confirmImportBtn').addEventListener('click', handleFileImport);

        // 编辑相关事件监听器
        const editImageField = document.getElementById('editProblemImage');
        if (editImageField) {
            editImageField.addEventListener('input', updateImagePreview);
            editImageField.addEventListener('blur', updateImagePreview);
        }


        // 生成图表按钮事件 - 支持双图表
        const generateChartBtn1 = document.getElementById('generateChartBtn1');
        const generateChartBtn2 = document.getElementById('generateChartBtn2');
        if (generateChartBtn1) {
            generateChartBtn1.addEventListener('click', () => generateChart(1));
            console.log('生成图表1按钮事件监听器已添加');
        }
        if (generateChartBtn2) {
            generateChartBtn2.addEventListener('click', () => generateChart(2));
            console.log('生成图表2按钮事件监听器已添加');
        }


        // 图表类型按钮事件监听器
        console.log('=== 开始初始化图表类型按钮事件监听器 ===');
        const chartTypeButtons = document.querySelectorAll('.chart-type-btn');
        console.log('找到图表类型按钮数量:', chartTypeButtons.length);
        console.log('按钮详情:', Array.from(chartTypeButtons).map(btn => ({
            text: btn.textContent,
            type: btn.dataset.type,
            hasOnclick: !!btn.onclick
        })));
        
        if (chartTypeButtons.length === 0) {
            console.error('❌ 没有找到图表类型按钮！');
            return;
        }
        
        chartTypeButtons.forEach((btn, index) => {
            console.log(`按钮${index}:`, {
                element: btn,
                type: btn.dataset.type,
                text: btn.textContent,
                hasClickHandler: btn.onclick !== null
            });
            
            btn.addEventListener('click', function(e) {
                console.log('🎯 按钮被点击!', {
                    type: this.dataset.type,
                    text: this.textContent,
                    event: e
                });
                
                // 移除所有active类
                chartTypeButtons.forEach(b => b.classList.remove('active'));
                // 添加active类到当前按钮
                this.classList.add('active');
                
                // 确定图表编号（通过父容器判断）
                const chartContainer = this.closest('.chart-left, .chart-right');
                const chartNumber = chartContainer && chartContainer.classList.contains('chart-left') ? 1 : 2;
                
                // 更新对应图表的类型
                if (chartNumber === 1) {
                    currentChartType1 = this.dataset.type;
                    console.log('✅ 图表1类型切换为:', currentChartType1);
                } else {
                    currentChartType2 = this.dataset.type;
                    console.log('✅ 图表2类型切换为:', currentChartType2);
                }
                
                // 检查是否有现有图表并销毁
                const currentChart = chartNumber === 1 ? currentChart1 : currentChart2;
                if (currentChart) {
                    console.log('📊 销毁现有图表', chartNumber);
                    currentChart.destroy();
                    if (chartNumber === 1) {
                        currentChart1 = null;
                    } else {
                        currentChart2 = null;
                    }
                }
                
                // 如果已经有图表数据，自动重新生成图表
                const groupFieldId = chartNumber === 1 ? 'groupField1' : 'groupField2';
                const groupField = document.getElementById(groupFieldId);
                const groupFieldValue = groupField ? groupField.value : null;
                const currentChartType = chartNumber === 1 ? currentChartType1 : currentChartType2;
                const chartSortOrder = chartNumber === 1 ? chartSortOrder1 : chartSortOrder2;
                
                console.log('📋 当前状态检查:', {
                    groupField: groupFieldValue,
                    allDataLength: allData ? allData.length : 'undefined',
                    currentChartType: currentChartType,
                    chartNumber: chartNumber
                });
                
                if (groupFieldValue && allData && allData.length > 0) {
                    console.log('🚀 开始重新生成图表', chartNumber, '，类型:', currentChartType);
                    try {
                        processChartData(allData, groupFieldValue, currentChartType, chartSortOrder, chartNumber);
                        console.log('✅ 图表', chartNumber, '重新生成完成');
                    } catch (error) {
                        console.error('❌ 图表', chartNumber, '重新生成失败:', error);
                    }
                } else {
                    console.log('⚠️ 条件不满足，不重新生成图表', chartNumber);
                    console.log('需要满足: groupField有值 && allData有数据');
                }
            });
            
            console.log(`✅ 按钮${index}事件监听器已添加`);
        });
        console.log('=== 图表类型按钮事件监听器初始化完成 ===');
    }
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }



    // 控制编辑权限
    function controlEditPermissions() {
        // 新增问题点按钮已移除，无需控制
    }

    // 初始化事件监听器
    function initEventListeners() {
        // 搜索按钮
        document.getElementById('searchBtn').addEventListener('click', searchReviews);

        // 重置按钮
        document.getElementById('resetBtn').addEventListener('click', resetFilters);

        // 为筛选输入框添加回车键搜索功能
        const filterInputs = [
            'majorCodeFilter', 'minorCodeFilter', 'projectPhaseFilter', 'versionFilter', 'supplierFilter',
            'problemStatusFilter', 'groupFilter', 'categoryFilter', 'dataSourceFilter', 'dqeResponsibleFilter',
            'testStartDateFilter', 'testEndDateFilter'
        ];

        filterInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // 防止表单提交
                        searchReviews(); // 修正为正确的搜索函数
                    }
                });
            }
        });


        // 导入按钮 - 显示模态框
        document.getElementById('importBtn').addEventListener('click', function() {
            // 权限检查：只有DQE或manager可以使用
            if (!checkDQEOrManagerPermission()) {
                return;
            }
            document.getElementById('importModal').style.display = 'block';
        });

        // 关闭导入模态框
        window.closeImportModal = function() {
            document.getElementById('importModal').style.display = 'none';
            // 重置文件输入
            document.getElementById('fileInput').value = '';
            document.getElementById('confirmImportBtn').disabled = true;
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadArea').innerHTML = `
                <i class="fas fa-cloud-upload-alt"></i>
                <p>点击选择文件或拖拽文件到此处</p>
                <p class="file-info">支持 .xlsx 格式，最大 100MB</p>
            `;
        };

        // 下载模板文件按钮
        document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
            const btn = this;
            const originalText = btn.innerHTML;

            // 显示加载状态
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在检查...';
            btn.disabled = true;

            // 先检查模板文件是否存在
            fetch('/reviewResult/downloadTemplate')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 文件存在，开始下载
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在下载...';

                        const link = document.createElement('a');
                        link.href = data.downloadUrl;
                        link.download = '新品质量导入模板.xlsx';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showToast('模板文件下载成功', 'success');
                    } else {
                        // 文件不存在，显示提示信息
                        showToast(data.message, 'warning');
                        alert(`模板文件不存在！\n\n${data.instructions}\n\n请将模板文件放到指定路径后重试。`);
                    }
                })
                .catch(error => {
                    console.error('检查模板文件时发生错误:', error);
                    showToast('检查模板文件时发生错误', 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        });

        // 上传区域点击事件
        document.getElementById('uploadArea').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        // 拖拽上传功能
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // 文件输入变化事件
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // 确认导入按钮
        document.getElementById('confirmImportBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length > 0) {
                handleFileImport();
            }
        });

        // 处理文件选择
        function handleFileSelect(file) {
            if (file && file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
                // 将文件设置到fileInput中
                const fileInput = document.getElementById('fileInput');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                document.getElementById('uploadArea').innerHTML = `
                    <i class="fas fa-file-excel" style="color: #28a745;"></i>
                    <p style="color: #28a745; font-weight: 500;">已选择文件: ${file.name}</p>
                    <p class="file-info">文件大小: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
                document.getElementById('confirmImportBtn').disabled = false;
            } else {
                showToast('请选择有效的Excel文件(.xlsx格式)', 'error');
            }
        }

        // 新增数据按钮
        document.getElementById('addNewBtn').addEventListener('click', showAddNewModal);

        // 导出按钮
        document.getElementById('exportBtn').addEventListener('click', exportFilteredData);

        // 导出全部筛选结果按钮
        document.getElementById('exportAllResultsBtn').addEventListener('click', exportAllSearchResults);

        // 删除选中数据按钮
        document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedData);

        // 删除全部搜索结果按钮 - 已注释，操作过于危险
        // document.getElementById('deleteAllResultsBtn').addEventListener('click', deleteAllSearchResults);

        // 加入收藏夹按钮
        document.getElementById('addToCartBtn').addEventListener('click', addToCart);

        // 查看收藏夹按钮
        document.getElementById('showCartBtn').addEventListener('click', showCartModal);

        // 表格全选功能
        document.getElementById('selectAllTableRows').addEventListener('change', toggleSelectAllTableRows);

        // 收藏夹相关按钮
        document.getElementById('clearCartBtn').addEventListener('click', clearCart);
        document.getElementById('exportCartBtn').addEventListener('click', exportCartData);
        document.getElementById('mergeChartBtn').addEventListener('click', showMergedChart);
        document.getElementById('closeCartModal').addEventListener('click', function() {
            closeSpecificModal('cartModal');
        });

        // 注意：新品质量页面不需要这些刷新按钮，因为筛选器都是输入框或固定选项



        // 分页按钮
        document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
        document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
        document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));
        document.getElementById('lastPageBtn').addEventListener('click', () => goToLastPage());

        // 每页显示数量选择器
        document.getElementById('pageSizeSelect').addEventListener('change', function() {
            pageSize = parseInt(this.value);
            currentPage = 1;
            loadReviewData(); // 重新加载数据
        });

        // 页码跳转
        document.getElementById('pageJumpBtn').addEventListener('click', jumpToPage);
        document.getElementById('pageJumpInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                jumpToPage();
            }
        });

        // 保存问题点
        document.getElementById('saveProblemBtn').addEventListener('click', saveProblem);

        // 取消编辑（编辑模态框的取消按钮）
        document.getElementById('cancelEditProblemBtn').addEventListener('click', function() {
            // 检查当前是否在编辑模态框中
            const editModal = document.getElementById('editProblemModal');
            if (editModal && editModal.style.display === 'block') {
                closeModal(); // 关闭编辑模态框
            } else {
                exitEditMode(); // 退出详情模态框的编辑模式
            }
        });

        // 关闭历史版本模态框
        document.getElementById('closeHistoryModal').addEventListener('click', closeModal);

        // 关闭新品质量详情模态框
        document.getElementById('closeReviewDetailModal').addEventListener('click', function() {
            resetReviewEditMode();
            document.getElementById('reviewDetailModal').style.display = 'none';
        });

        // 关闭问题点详情模态框
        document.getElementById('closeProblemDetailModal').addEventListener('click', function() {
            closeSpecificModal('problemDetailModal');
        });

        // 新品质量编辑相关事件监听器
        document.getElementById('editReviewBtn').addEventListener('click', enterReviewEditMode);
        document.getElementById('saveReviewBtn').addEventListener('click', saveReviewEdit);
        document.getElementById('cancelEditReviewBtn').addEventListener('click', cancelReviewEdit);

        // 详情模态框编辑按钮
        document.getElementById('editProblemBtn').addEventListener('click', function() {
            enterEditMode();
        });

        // 保存详情按钮
        document.getElementById('saveDetailBtn').addEventListener('click', function() {
            saveDetailChanges();
        });



        // 使用事件委托来处理所有关闭按钮
        document.addEventListener('click', function(event) {
            // 处理X按钮关闭
            if (event.target.classList.contains('close')) {
                // 找到最近的模态框并关闭
                const modal = event.target.closest('.modal');
                if (modal) {
                    // 如果是新品质量详情模态框，需要重置编辑状态
                    if (modal.id === 'reviewDetailModal') {
                        resetReviewEditMode();
                    }
                    modal.style.display = 'none';
                }
                return;
            }

            // 处理点击模态框外部关闭
            if (event.target.classList.contains('modal')) {
                // 如果是新品质量详情模态框，需要重置编辑状态
                if (event.target.id === 'reviewDetailModal') {
                    resetReviewEditMode();
                }
                // 只关闭被点击的模态框
                event.target.style.display = 'none';
                return;
            }
        });

        // 提示框事件监听器
        const toast = document.getElementById('customToast');
        const toastClose = document.getElementById('toastClose');

        // 点击关闭按钮
        toastClose.addEventListener('click', hideToast);

        // 点击提示框外部关闭
        toast.addEventListener('click', function(event) {
            if (event.target === toast) {
                hideToast();
            }
        });

        // 全选收藏夹项目复选框
        document.getElementById('selectAllCartItems').addEventListener('change', toggleSelectAllCartItems);

        // 问题图片编辑字段事件监听器
        const editImageField = document.getElementById('editProblemImage');
        if (editImageField) {
            editImageField.addEventListener('input', updateImagePreview);
            editImageField.addEventListener('blur', updateImagePreview);
        }

        // 组别选择器事件监听器
        const groupSelector = document.getElementById('groupSelector');
        if (groupSelector) {
            groupSelector.addEventListener('change', function() {
                const selectedGroup = this.value;
                if (selectedGroup && allDataForGroupStats && allDataForGroupStats.length > 0) {
                    displayGroupStats(allDataForGroupStats, selectedGroup);
                } else {
                    document.getElementById('groupStatsDisplay').innerHTML = '<div class="no-group-data">请选择组别查看统计</div>';
                }
            });
        }
    }

    // 加载新品质量数据
    function loadReviewData() {
        showLoading();

        // 构建查询参数
        const params = new URLSearchParams({
            username: currentUser,
            job: currentRole,
            page: currentPage,
            size: pageSize
        });

        // 添加筛选条件
        const majorCode = document.getElementById('majorCodeFilter').value.trim();
        const minorCode = document.getElementById('minorCodeFilter').value.trim();
        const projectPhase = document.getElementById('projectPhaseFilter').value.trim();
        const version = document.getElementById('versionFilter').value.trim();
        const supplier = document.getElementById('supplierFilter').value.trim();
        const problemStatus = document.getElementById('problemStatusFilter').value;
        const group = document.getElementById('groupFilter').value.trim();
        const category = document.getElementById('categoryFilter').value.trim();
        const dataSource = document.getElementById('dataSourceFilter').value.trim();
        const dqeResponsible = document.getElementById('dqeResponsibleFilter').value.trim();
        const testStartDate = document.getElementById('testStartDateFilter').value;
        const testEndDate = document.getElementById('testEndDateFilter').value;

        if (majorCode) params.append('majorCode', majorCode);
        if (minorCode) params.append('minorCode', minorCode);
        if (projectPhase) params.append('projectPhase', projectPhase);
        if (version) params.append('version', version);
        if (supplier) params.append('supplier', supplier);
        if (problemStatus) {
            // 标准化问题状态，兼容大小写
            const normalizedStatus = normalizeProblemStatus(problemStatus);
            params.append('problemStatus', normalizedStatus);
        }
        if (group) params.append('group', group);
        if (category) params.append('category', category);
        if (dataSource) params.append('dataSource', dataSource);
        if (dqeResponsible) params.append('dqeResponsible', dqeResponsible);
        if (testStartDate) params.append('testStartDate', testStartDate);
        if (testEndDate) params.append('testEndDate', testEndDate);

        console.log('发送的查询参数:', params.toString());

        fetch('/reviewResult/getReviewResults?' + params.toString())
            .then(response => response.json())
            .then(data => {
                console.log('API响应数据:', data);
                if (data.success) {
                    allData = data.data || [];
                    filteredData = [...allData];
                    totalCount = data.total || 0;
                    totalPages = data.totalPages || Math.ceil(totalCount / pageSize);
                    console.log('加载的数据:', allData);
                    console.log('总记录数:', totalCount);
                    console.log('总页数:', totalPages);
                    console.log('当前页:', currentPage);
                    console.log('每页大小:', pageSize);
                    
                    // 调试：检查第一条数据的字段
                    if (allData.length > 0) {
                        console.log('第一条数据的字段:', allData[0]);
                        console.log('第一条数据的组别:', allData[0].group);
                        console.log('第一条数据的品类:', allData[0].category);
                        console.log('第一条数据的DQE负责人:', allData[0].dqeResponsible);
                        console.log('第一条数据的数据来源:', allData[0].dataSource);
                    }
                    renderTable();
                    updatePagination();
                    
                    // 获取全部搜索数据用于建议功能
                    loadAllSearchDataForSuggestions();
                    
                    // 加载所有数据用于组别统计（不受过滤器影响）
                    loadAllDataForGroupStats();
                } else {
                    console.error('API返回错误:', data);
                    showToast('加载数据失败: ' + (data.error || data.message || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('加载数据时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
    }


    // 搜索新品质量
    function searchReviews() {
        console.log('开始搜索');
        currentPage = 1; // 重置到第一页
        loadReviewData(); // 重新加载数据，服务器端会处理筛选
    }

    // 加载全部搜索数据用于建议功能
    function loadAllSearchDataForSuggestions() {
        console.log('🔄 加载全部搜索数据用于建议功能');
        
        // 构建查询参数（不包含分页参数）
        const params = new URLSearchParams({
            username: currentUser,
            job: currentRole,
            page: 1,
            size: 10000 // 设置一个很大的值来获取所有数据
        });

        // 添加筛选条件
        const majorCode = document.getElementById('majorCodeFilter').value.trim();
        const minorCode = document.getElementById('minorCodeFilter').value.trim();
        const projectPhase = document.getElementById('projectPhaseFilter').value.trim();
        const version = document.getElementById('versionFilter').value.trim();
        const supplier = document.getElementById('supplierFilter').value.trim();
        const problemStatus = document.getElementById('problemStatusFilter').value;
        const group = document.getElementById('groupFilter').value.trim();
        const category = document.getElementById('categoryFilter').value.trim();
        const dataSource = document.getElementById('dataSourceFilter').value.trim();
        const dqeResponsible = document.getElementById('dqeResponsibleFilter').value.trim();
        const testStartDate = document.getElementById('testStartDateFilter').value;
        const testEndDate = document.getElementById('testEndDateFilter').value;

        if (majorCode) params.append('majorCode', majorCode);
        if (minorCode) params.append('minorCode', minorCode);
        if (projectPhase) params.append('projectPhase', projectPhase);
        if (version) params.append('version', version);
        if (supplier) params.append('supplier', supplier);
        if (problemStatus) {
            // 标准化问题状态，兼容大小写
            const normalizedStatus = normalizeProblemStatus(problemStatus);
            params.append('problemStatus', normalizedStatus);
        }
        if (group) params.append('group', group);
        if (category) params.append('category', category);
        if (dataSource) params.append('dataSource', dataSource);
        if (dqeResponsible) params.append('dqeResponsible', dqeResponsible);
        if (testStartDate) params.append('testStartDate', testStartDate);
        if (testEndDate) params.append('testEndDate', testEndDate);

        fetch('/reviewResult/getReviewResults?' + params.toString())
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allSearchData = data.data || [];
                    console.log('✅ 全部搜索数据加载完成，数据量:', allSearchData.length);
                } else {
                    console.error('❌ 加载全部搜索数据失败:', data);
                    allSearchData = [];
                }
            })
            .catch(error => {
                console.error('❌ 加载全部搜索数据时发生错误:', error);
                allSearchData = [];
            });
    }

    // 加载所有数据用于组别统计（不受过滤器影响）
    let allDataForGroupStats = []; // 存储所有数据用于组别统计
    
    function loadAllDataForGroupStats() {
        console.log('🔄 加载所有数据用于组别统计（不受过滤器影响）');
        
        // 构建查询参数（不包含任何筛选条件，只包含用户和角色）
        const params = new URLSearchParams({
            username: currentUser,
            job: currentRole,
            page: 1,
            size: 10000 // 设置一个很大的值来获取所有数据
        });

        fetch('/reviewResult/getReviewResults?' + params.toString())
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allDataForGroupStats = data.data || [];
                    console.log('✅ 所有数据加载完成用于组别统计，数据量:', allDataForGroupStats.length);
                    // 使用所有数据更新组别统计（不受过滤器影响）
                    updateGroupStats(allDataForGroupStats);
                } else {
                    console.error('❌ 加载所有数据失败:', data);
                    allDataForGroupStats = [];
                }
            })
            .catch(error => {
                console.error('❌ 加载所有数据时发生错误:', error);
                allDataForGroupStats = [];
            });
    }

    // 更新组别下拉框选项
    function updateGroupSelector(data) {
        const selector = document.getElementById('groupSelector');
        const currentValue = selector.value;
        
        if (!data || data.length === 0) {
            selector.innerHTML = '<option value="">暂无组别数据</option>';
            return;
        }

        // 获取所有唯一的组别
        const groups = [...new Set(data.map(item => item.group || '未分组').filter(g => g))].sort();
        
        // 生成选项
        let html = '<option value="">请选择组别</option>';
        groups.forEach(group => {
            html += `<option value="${group}">${group}</option>`;
        });
        
        selector.innerHTML = html;
        
        // 如果之前有选中的值且仍然存在，恢复选中
        if (currentValue && groups.includes(currentValue)) {
            selector.value = currentValue;
            displayGroupStats(data, currentValue);
        } else {
            // 清空显示
            document.getElementById('groupStatsDisplay').innerHTML = '<div class="no-group-data">请选择组别查看统计</div>';
        }
    }

    // 显示选中组别的统计数据
    function displayGroupStats(data, selectedGroup) {
        const statsDisplay = document.getElementById('groupStatsDisplay');
        
        if (!selectedGroup || !data || data.length === 0) {
            statsDisplay.innerHTML = '<div class="no-group-data">请选择组别查看统计</div>';
            return;
        }

        // 过滤出选中组别的数据
        const groupData = data.filter(item => (item.group || '未分组') === selectedGroup);
        
        if (groupData.length === 0) {
            statsDisplay.innerHTML = '<div class="no-group-data">该组别暂无数据</div>';
            return;
        }

        // 统计该组别的数据
        const stats = {
            total: groupData.length,
            sLevel: 0,
            aLevel: 0,
            bLevel: 0,
            cLevel: 0,
            unclosed: 0
        };
        
        groupData.forEach(item => {
            // 统计各等级问题（按优先级：S > A > B > C）
            const level = (item.problemLevel || '').toUpperCase();
            if (level.includes('S')) {
                stats.sLevel++;
            } else if (level.includes('A')) {
                stats.aLevel++;
            } else if (level.includes('B')) {
                stats.bLevel++;
            } else if (level.includes('C')) {
                stats.cLevel++;
            }
            
            // 统计未关闭问题（如果状态包含"close"或"closed"则算已关闭，否则算未关闭）
            const status = (item.problemStatus || '').toLowerCase().trim();
            if (!status.includes('close')) {
                stats.unclosed++;
            }
        });
        
        // 计算占比
        const unclosedRate = stats.total > 0 ? ((stats.unclosed / stats.total) * 100).toFixed(1) : 0;
        const sRate = stats.total > 0 ? ((stats.sLevel / stats.total) * 100).toFixed(1) : 0;
        const aRate = stats.total > 0 ? ((stats.aLevel / stats.total) * 100).toFixed(1) : 0;
        const bRate = stats.total > 0 ? ((stats.bLevel / stats.total) * 100).toFixed(1) : 0;
        const cRate = stats.total > 0 ? ((stats.cLevel / stats.total) * 100).toFixed(1) : 0;
        
        // 生成HTML
        const html = `
            <div class="group-stat-card">
                <div class="group-stat-header">
                    <div class="group-stat-name">${selectedGroup}</div>
                    <div class="group-stat-total">总计: ${stats.total}</div>
                </div>
                <div class="group-stat-details">
                    <div class="group-stat-item s-level">
                        <div class="group-stat-item-label">S级</div>
                        <div class="group-stat-item-value">${stats.sLevel}</div>
                        <div class="group-stat-item-rate">${sRate}%</div>
                    </div>
                    <div class="group-stat-item a-level">
                        <div class="group-stat-item-label">A级</div>
                        <div class="group-stat-item-value">${stats.aLevel}</div>
                        <div class="group-stat-item-rate">${aRate}%</div>
                    </div>
                    <div class="group-stat-item b-level">
                        <div class="group-stat-item-label">B级</div>
                        <div class="group-stat-item-value">${stats.bLevel}</div>
                        <div class="group-stat-item-rate">${bRate}%</div>
                    </div>
                    <div class="group-stat-item c-level">
                        <div class="group-stat-item-label">C级</div>
                        <div class="group-stat-item-value">${stats.cLevel}</div>
                        <div class="group-stat-item-rate">${cRate}%</div>
                    </div>
                    <div class="group-stat-item unclosed">
                        <div class="group-stat-item-label">未关闭率</div>
                        <div class="group-stat-item-value">${unclosedRate}%</div>
                        <div class="group-stat-item-rate">${stats.unclosed}/${stats.total}</div>
                    </div>
                </div>
            </div>
        `;
        
        statsDisplay.innerHTML = html;
    }

    // 更新组别统计数据（更新下拉框和显示）
    function updateGroupStats(data) {
        // 更新下拉框选项
        updateGroupSelector(data);
        
        // 如果有选中的组别，更新显示
        const selectedGroup = document.getElementById('groupSelector').value;
        if (selectedGroup) {
            displayGroupStats(data, selectedGroup);
        }
    }

    // 重置筛选条件
    function resetFilters() {
        document.getElementById('majorCodeFilter').value = '';
        document.getElementById('minorCodeFilter').value = '';
        document.getElementById('projectPhaseFilter').value = '';
        document.getElementById('versionFilter').value = '';
        document.getElementById('supplierFilter').value = '';
        document.getElementById('problemStatusFilter').value = '';
        document.getElementById('groupFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('dataSourceFilter').value = '';
        document.getElementById('dqeResponsibleFilter').value = '';
        document.getElementById('testStartDateFilter').value = '';
        document.getElementById('testEndDateFilter').value = '';

        // 重置到第一页并重新加载数据
        currentPage = 1;
        loadReviewData();
    }

    // 获取当前用户名
    function getCurrentUsername() {
        return currentUser || '';
    }

    // 处理文件导入
    function handleFileImport() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            showToast('请先选择要导入的文件', 'error');
            return;
        }

        // 检查文件格式
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            showToast('文件格式不正确，请选择.xlsx格式的Excel文件', 'error');
            return;
        }

        // 检查文件大小（限制为100MB）
        if (file.size > 100 * 1024 * 1024) {
            showToast('文件大小不能超过100MB', 'error');
            return;
        }

        // 显示进度条
        document.getElementById('uploadProgress').style.display = 'block';
        document.getElementById('confirmImportBtn').disabled = true;

        // 模拟进度更新
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            updateProgress(progress);
        }, 200);

        // 创建FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('username', getCurrentUsername());

        // 发送请求
        fetch('/reviewResult/importReviewResults', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                updateProgress(100);

                setTimeout(() => {
                    if (data.success) {
                        const successMessage = data.message
                            ? data.message
                            : `导入成功！新增 ${data.insertCount || 0} 条，更新 ${data.updateCount || 0} 条，错误 ${data.errorCount || 0} 条`;
                        showToast(successMessage, 'success', 5000);
                        // 关闭模态框
                        closeImportModal();
                        // 刷新数据
                        loadReviewData();
                        if (Array.isArray(data.updatedRecords) && data.updatedRecords.length > 0) {
                            const totalUpdateCount = typeof data.updateCount === 'number' ? data.updateCount : data.updatedRecords.length;
                            const shownCount = data.updatedRecords.length;
                            let detailMessage = `本次更新共 ${totalUpdateCount} 条记录。`;
                            if (totalUpdateCount > shownCount) {
                                detailMessage += `\n下方仅展示前 ${shownCount} 条，剩余 ${totalUpdateCount - shownCount} 条记录请参考导入结果统计。`;
                            }
                            detailMessage += '\n\n';
                            detailMessage += data.updatedRecords.map((item, index) => `${index + 1}. ${item}`).join('\n');
                            showCopyableDialog(detailMessage, '更新记录清单');
                        }
                    } else {
                        if (data.message) {
                            const normalizedMessage = data.message.replace(/\\n/g, '\n');
                            if (normalizedMessage.includes('\n') || normalizedMessage.length > 80) {
                                showCopyableDialog(normalizedMessage, '导入失败');
                            } else {
                                const toastMessage = normalizedMessage.startsWith('导入失败')
                                    ? normalizedMessage
                                    : `导入失败：${normalizedMessage}`;
                                showToast(toastMessage, 'error', 6000);
                            }
                        } else {
                            showToast('导入失败：服务器未返回错误信息', 'error', 6000);
                        }
                        document.getElementById('confirmImportBtn').disabled = false;
                    }
                    document.getElementById('uploadProgress').style.display = 'none';
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('confirmImportBtn').disabled = false;
                console.error('导入错误:', error);
                showToast('导入过程中发生错误', 'error');
            });
    }

    // 更新进度条
    function updateProgress(percent) {
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressText').textContent = Math.round(percent) + '%';
    }

    // 导出筛选结果
    function exportFilteredData() {
        // 获取选中的行ID
        const selectedIds = getSelectedRowIds();
        
        if (selectedIds.length === 0) {
            alert('请先选择要导出的数据行！');
            return;
        }

        showLoading();

        // 获取当前隐藏的列
        const hiddenColumns = getHiddenColumns();

        // 准备导出数据 - 只传递选中的ID，让服务器端获取完整数据
        const exportData = {
            selectedIds: selectedIds,
            exportType: 'reviewResults',
            fileName: `新品质量数据_${new Date().toISOString().slice(0, 10)}.xlsx`,
            hiddenColumns: hiddenColumns
        };

        fetch('/reviewResult/exportReviewResultsExcel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(exportData)
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('导出失败');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportData.fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast(`成功导出 ${selectedIds.length} 条新品质量数据！`, 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('导出时发生错误', 'error');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // 导出全部筛选结果
    function exportAllSearchResults() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 获取当前搜索条件
        const currentFilters = getCurrentFilters();
        
        // 检查是否有筛选条件
        if (Object.keys(currentFilters).length === 0) {
            showToast('请先设置筛选条件！', 'warning');
            return;
        }

        // 确认导出
        if (!confirm('确定要导出当前筛选条件下的全部数据吗？\n\n注意：这将导出所有符合当前筛选条件的数据，不仅仅是当前页面显示的数据。')) {
            return;
        }

        showLoading();

        // 获取当前隐藏的列
        const hiddenColumns = getHiddenColumns();

        // 准备导出数据 - 传递筛选条件而不是具体的ID列表
        const exportData = {
            filters: currentFilters,
            exportType: 'reviewResults',
            fileName: `新品质量全部数据_${new Date().toISOString().slice(0, 10)}.xlsx`,
            hiddenColumns: hiddenColumns
        };

        fetch('/reviewResult/exportAllByFilters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(exportData)
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('导出失败');
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = exportData.fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showToast('成功导出全部筛选结果数据！', 'success');
        })
        .catch(error => {
            console.error('导出错误:', error);
            showToast('导出时发生错误: ' + error.message, 'error');
        })
        .finally(() => {
            hideLoading();
        });
    }

    // 删除选中数据
    function deleteSelectedData() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 获取选中的行
        const selectedRows = getSelectedTableRows();
        
        if (selectedRows.length === 0) {
            showToast('请先选择要删除的数据行！', 'warning');
            return;
        }

        // 检查权限：筛选出有权限删除的行
        const deletableRows = [];
        const nonDeletableRows = [];
        const deletableIds = []; // 存储可删除行的ID
        const nonDeletableIds = []; // 存储不可删除行的ID

        selectedRows.forEach(row => {
            const reviewGroup = row.group || '';
            const dqeResponsible = row.dqeResponsible || '';
            
            if (canEditByGroup(reviewGroup, departmentName, dqeResponsible)) {
                deletableRows.push(row);
                if (row.id) {
                    deletableIds.push(row.id);
                }
            } else {
                nonDeletableRows.push(row);
                if (row.id) {
                    nonDeletableIds.push(row.id);
                }
            }
        });

        // 如果没有可删除的行，提示用户
        if (deletableRows.length === 0) {
            if (nonDeletableRows.length > 0) {
                const nonDeletableIdsStr = nonDeletableIds.length > 0 
                    ? `（ID：${nonDeletableIds.join('、')}）` 
                    : '';
                showToast(`您没有权限删除选中的数据（组别不匹配或不是DQE负责人）${nonDeletableIdsStr}`, 'error');
            } else {
                showToast('请先选择要删除的数据行！', 'warning');
            }
            return;
        }

        // 如果有部分行没有权限，提示用户
        if (nonDeletableRows.length > 0) {
            const deletableIdsStr = deletableIds.length > 0 
                ? `（ID：${deletableIds.join('、')}）` 
                : '';
            const nonDeletableIdsStr = nonDeletableIds.length > 0 
                ? `（ID：${nonDeletableIds.join('、')}）` 
                : '';
            const message = `选中的 ${selectedRows.length} 条数据中，有 ${nonDeletableRows.length} 条没有删除权限${nonDeletableIdsStr}（组别不匹配或不是DQE负责人），将只删除 ${deletableRows.length} 条有权限的数据${deletableIdsStr}。\n\n确定要继续吗？`;
            if (!confirm(message)) {
                return;
            }
        } else {
            // 确认删除
            const deletableIdsStr = deletableIds.length > 0 
                ? `（ID：${deletableIds.join('、')}）` 
                : '';
            if (!confirm(`确定要删除选中的 ${deletableRows.length} 条数据${deletableIdsStr}吗？此操作不可恢复！`)) {
                return;
            }
        }

        showLoading();

        // 提取要删除的ID列表（只删除有权限的行）
        const idsToDelete = deletableIds;

        // 发送删除请求
        fetch('/reviewResult/deleteSelected', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ids: idsToDelete
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('删除失败');
            }
        })
        .then(result => {
            if (result.success) {
                showToast(`成功删除 ${result.deletedCount} 条数据！`, 'success');
                // 重新加载数据
                loadReviewData();
            } else {
                throw new Error(result.message || '删除失败');
            }
        })
        .catch(error => {
            console.error('删除错误:', error);
            showToast('删除时发生错误: ' + error.message, 'error');
        })
        .finally(() => {
            hideLoading();
        });
    }

    // 删除全部搜索结果 - 已注释，操作过于危险
    /*
    function deleteAllSearchResults() {
        // 获取当前搜索条件
        const currentFilters = getCurrentFilters();
        
        // 确认删除
        if (!confirm('确定要删除当前搜索结果的全部数据吗？此操作不可恢复！\n\n注意：这将删除所有符合当前筛选条件的数据，不仅仅是当前页面显示的数据。')) {
            return;
        }

        showLoading();

        // 发送删除请求，传递搜索条件而不是具体的ID列表
        fetch('/reviewResult/deleteAllByFilters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filters: currentFilters
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('删除失败');
            }
        })
        .then(result => {
            if (result.success) {
                showToast(`成功删除 ${result.deletedCount} 条数据！`, 'success');
                // 重新加载数据
                loadReviewData();
            } else {
                throw new Error(result.message || '删除失败');
            }
        })
        .catch(error => {
            console.error('删除错误:', error);
            showToast('删除时发生错误: ' + error.message, 'error');
        })
        .finally(() => {
            hideLoading();
        });
    }
    */

    // 获取当前搜索条件
    function getCurrentFilters() {
        const filters = {};
        
        // 获取所有筛选条件
        const testDateFrom = document.getElementById('testDateFrom').value;
        const testDateTo = document.getElementById('testDateTo').value;
        const majorCode = document.getElementById('majorCode').value;
        const minorCode = document.getElementById('minorCode').value;
        const projectPhase = document.getElementById('projectPhase').value;
        const version = document.getElementById('version').value;
        const problemProcess = document.getElementById('problemProcess').value;
        const problemLevel = document.getElementById('problemLevel').value;
        const developmentMethod = document.getElementById('developmentMethod').value;
        const supplier = document.getElementById('supplier').value;
        const solutionProvider = document.getElementById('solutionProvider').value;
        const problemPoint = document.getElementById('problemPoint').value;
        const problemReason = document.getElementById('problemReason').value;
        const improvementMeasures = document.getElementById('improvementMeasures').value;
        const isPreventable = document.getElementById('isPreventable').value;
        const responsibleDepartment = document.getElementById('responsibleDepartment').value;
        const problemStatus = document.getElementById('problemStatus').value;
        const problemTag1 = document.getElementById('problemTag1').value;
        const problemTag2 = document.getElementById('problemTag2').value;
        const preventionNotes = document.getElementById('preventionNotes').value;

        // 只添加非空的筛选条件
        if (testDateFrom) filters.testDateFrom = testDateFrom;
        if (testDateTo) filters.testDateTo = testDateTo;
        if (majorCode) filters.majorCode = majorCode;
        if (minorCode) filters.minorCode = minorCode;
        if (projectPhase) filters.projectPhase = projectPhase;
        if (version) filters.version = version;
        if (problemProcess) filters.problemProcess = problemProcess;
        if (problemLevel) filters.problemLevel = problemLevel;
        if (developmentMethod) filters.developmentMethod = developmentMethod;
        if (supplier) filters.supplier = supplier;
        if (solutionProvider) filters.solutionProvider = solutionProvider;
        if (problemPoint) filters.problemPoint = problemPoint;
        if (problemReason) filters.problemReason = problemReason;
        if (improvementMeasures) filters.improvementMeasures = improvementMeasures;
        if (isPreventable) filters.isPreventable = isPreventable;
        if (responsibleDepartment) filters.responsibleDepartment = responsibleDepartment;
        if (problemStatus) filters.problemStatus = problemStatus;
        if (problemTag1) filters.problemTag1 = problemTag1;
        if (problemTag2) filters.problemTag2 = problemTag2;
        if (preventionNotes) filters.preventionNotes = preventionNotes;

        return filters;
    }

    // 显示新增模态框
    function showAddNewModal() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 重置编辑状态
        resetReviewEditMode();
        
        // 设置模态框标题
        document.getElementById('reviewModalTitle').textContent = '新增新品质量';
        
        // 清空所有字段
        clearReviewDetailFields();
        
        // 直接进入编辑模式
        enterReviewEditMode();
        
        // 显示模态框
        document.getElementById('reviewDetailModal').style.display = 'block';
    }

    // 清空新品质量详情字段
    function clearReviewDetailFields() {
        // 清空所有显示字段
        const fields = [
            'detailGroup', 'detailCategory', 'detailDqeResponsible', 'detailTestDate', 'detailMajorCode', 'detailMinorCode', 'detailProjectPhase', 'detailVersion',
            'detailProblemProcess', 'detailProblemLevel', 'detailDevelopmentMethod', 'detailSupplier',
            'detailSolutionProvider', 'detailProblemPoint', 'detailProblemReason', 'detailImprovementMeasures',
            'detailIsPreventable', 'detailResponsibleDepartment', 'detailPlannedCompletionTime',
            'detailActualCompletionTime', 'detailDelayDays', 'detailProblemStatus', 'detailProblemTag1',
            'detailProblemTag2', 'detailPreventionNotes', 'detailCreatedTime', 'detailUpdatedTime', 'detailDataSource'
        ];
        
        fields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {
                element.textContent = '-';
            }
        });
    }

    // 组别匹配辅助函数 - 兼容有无"组"字的情况，以及"数据存储"和"数据储存"的统一处理
    function isGroupNameMatched(groupName1, groupName2) {
        if (!groupName1 && !groupName2) return true;
        if (!groupName1 || !groupName2) return false;
        
        // 标准化组别名称：去除空格、去除末尾"组"字、统一"数据储存"和"数据存储"
        const normalize = (name) => {
            if (!name) return '';
            // 去除首尾空格
            let normalized = name.trim();
            // 去除末尾的"组"字（如果有）
            normalized = normalized.replace(/组$/, '');
            // 将"数据储存"和"数据存储"视为同一个组别，统一为"数据存储"
            if (normalized === '数据储存' || normalized === '数据存储') {
                normalized = '数据存储';
            }
            return normalized;
        };
        
        const normalized1 = normalize(groupName1);
        const normalized2 = normalize(groupName2);
        
        // 标准化后的值相等则匹配（无论原始值是否有"组"字）
        // 例如："数据存储组"与"数据存储"匹配，"数据储存组"与"数据存储"匹配
        return normalized1 === normalized2;
    }

    // 检查组别是否允许编辑
    // 如果组别为空，则允许任何人编辑
    // 如果departmentName为空，则允许编辑所有行
    // 如果组别不为空且departmentName不为空，需要组别匹配
    function canEditByGroup(reviewGroup, departmentName, dqeResponsible) {
        const groupName = (reviewGroup || '').trim();
        
        // 如果组别为空，允许编辑
        if (!groupName) {
            return true;
        }
        
        // 如果departmentName为空，允许编辑所有行
        if (!departmentName) {
            return true;
        }
        
        // 特殊权限：如果username是张华或者易湄洁，不管是什么组，都可以编辑
        const username = getCurrentUsername();
        if (username === '张华' || username === '易湄洁') {
            return true;
        }
        
        // 如果本地缓存的username和主导DQE（dqeResponsible）一致，就可以编辑
        if (dqeResponsible && username) {
            const normalizedDqe = String(dqeResponsible).trim();
            const normalizedUsername = String(username).trim();
            if (normalizedDqe === normalizedUsername) {
                return true;
            }
        }
        
        // 标准化组名（去除末尾"组"字）
        const normalizeGroupName = (name) => {
            if (!name) return '';
            let normalized = name.trim();
            normalized = normalized.replace(/组$/, '');
            return normalized;
        };
        
        const normalizedGroupName = normalizeGroupName(groupName);
        const normalizedDepartmentName = normalizeGroupName(departmentName);
        
        // 特殊权限：邓令章可以编辑包含"蓝牙"的组别
        if (username === '邓令章' && groupName.includes('蓝牙')) {
            return true;
        }
        
        // 特殊组别匹配规则：
        // 1. 蓝牙家居组 - 工控线材也可以编辑
        if (normalizedGroupName === '蓝牙家居' && normalizedDepartmentName === '工控线材') {
            return true;
        }
        if (normalizedDepartmentName === '蓝牙家居' && normalizedGroupName === '工控线材') {
            return true;
        }
        
        // 2. 壳膜创意组 - 创意家居可以编辑（双向匹配）
        if (normalizedGroupName === '壳膜创意' && normalizedDepartmentName === '创意家居') {
            return true;
        }
        if (normalizedDepartmentName === '壳膜创意' && normalizedGroupName === '创意家居') {
            return true;
        }
        
        // 组别不为空且departmentName不为空，需要组别匹配
        return isGroupNameMatched(groupName, departmentName);
    }

    // 显示新品质量详情
    function showReviewDetail(reviewId) {
        // 权限检查：只有DQE或manager可以查看详情
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        const review = filteredData.find(r => r.id === reviewId);
        if (!review) {
            console.error('未找到ID为', reviewId, '的新品质量记录');
            showToast('未找到指定的记录', 'error');
            return;
        }

        // 调试：打印review对象的内容
        console.log('查看详情的review对象:', review);
        console.log('组别字段值:', review.group);
        console.log('品类字段值:', review.category);
        console.log('DQE负责人字段值:', review.dqeResponsible);
        console.log('数据来源字段值:', review.dataSource);
        console.log('review对象的所有属性:', Object.keys(review));
        console.log('review对象完整内容:', JSON.stringify(review, null, 2));

        // 先重置编辑状态（防止之前的状态影响）
        resetReviewEditMode();
        
        // 设置模态框标题
        const titleElement = document.getElementById('reviewModalTitle');
        if (titleElement) {
            titleElement.textContent = '新品质量详情';
        }

        // 存储当前编辑的新品质量ID
        currentEditingReviewId = reviewId;

        // 填充详情数据 - 添加安全检查
        const fields = [
            { id: 'detailGroup', value: review.group },
            { id: 'detailCategory', value: review.category },
            { id: 'detailDqeResponsible', value: review.dqeResponsible },
            { id: 'detailTestDate', value: review.testDate },
            { id: 'detailMajorCode', value: review.majorCode },
            { id: 'detailMinorCode', value: review.minorCode },
            { id: 'detailProjectPhase', value: review.projectPhase },
            { id: 'detailVersion', value: review.version },
            { id: 'detailProblemProcess', value: review.problemProcess },
            { id: 'detailProblemLevel', value: review.problemLevel },
            { id: 'detailDevelopmentMethod', value: review.developmentMethod },
            { id: 'detailSupplier', value: review.supplier },
            { id: 'detailSolutionProvider', value: review.solutionProvider },
            { id: 'detailProblemPoint', value: review.problemPoint },
            { id: 'detailProblemReason', value: review.problemReason },
            { id: 'detailImprovementMeasures', value: review.improvementMeasures },
            { id: 'detailIsPreventable', value: review.isPreventable },
            { id: 'detailResponsibleDepartment', value: review.responsibleDepartment },
            { id: 'detailPlannedCompletionTime', value: formatDate(review.plannedCompletionTime) },
            { id: 'detailActualCompletionTime', value: formatDate(review.actualCompletionTime) },
            { id: 'detailDelayDays', value: review.delayDays },
            { id: 'detailProblemStatus', value: review.problemStatus },
            { id: 'detailProblemTag1', value: review.problemTag1 },
            { id: 'detailProblemTag2', value: review.problemTag2 },
            { id: 'detailPreventionNotes', value: review.preventionNotes },
            { id: 'detailCreatedTime', value: review.createdTime },
            { id: 'detailUpdatedTime', value: review.updatedTime },
            { id: 'detailDataSource', value: review.dataSource }
        ];

        fields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
                element.textContent = field.value || '-';
                console.log(`设置字段 ${field.id} 的值为: ${field.value || '-'}`);
            } else {
                console.warn('未找到元素:', field.id);
            }
        });

        // 检查组别是否允许编辑
        // 如果组别为空，则允许任何人编辑；如果departmentName为空，允许编辑所有行；否则需要组别匹配
        const reviewGroup = review.group || '';
        const canEdit = canEditByGroup(reviewGroup, departmentName, review.dqeResponsible);
        
        // 根据组别匹配情况显示或隐藏编辑按钮
        const editBtn = document.getElementById('editReviewBtn');
        const saveBtn = document.getElementById('saveReviewBtn');
        const cancelBtn = document.getElementById('cancelEditReviewBtn');
        
        if (editBtn) {
            if (canEdit) {
                editBtn.style.display = 'inline-block';
            } else {
                editBtn.style.display = 'none';
                console.log(`详情模态框编辑按钮已隐藏：组别不匹配（组别: ${reviewGroup}，当前部门: ${departmentName}）`);
            }
        }
        if (saveBtn) saveBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';

        // 确保所有字段都是只读模式（防止之前编辑状态的输入框残留）
        convertToReadMode();

        // 显示模态框
        const modal = document.getElementById('reviewDetailModal');
        if (modal) {
            modal.style.display = 'block';
        }
    }

    // 进入编辑模式
    function enterReviewEditMode() {
        // 权限检查：只有DQE或manager可以编辑
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 检查组别权限
        if (currentEditingReviewId) {
            const review = filteredData.find(r => r.id === currentEditingReviewId);
            if (review) {
                const reviewGroup = review.group || '';
                // 检查组别是否允许编辑（如果组别为空，允许任何人编辑）
                if (!canEditByGroup(reviewGroup, departmentName, review.dqeResponsible)) {
                    showToast(`没有权限编辑此记录：组别不匹配（组别: ${reviewGroup}，当前部门: ${departmentName}）`, 'error');
                    return;
                }
            }
        }
        
        // 隐藏编辑按钮，显示保存和取消按钮
        document.getElementById('editReviewBtn').style.display = 'none';
        document.getElementById('saveReviewBtn').style.display = 'inline-block';
        document.getElementById('cancelEditReviewBtn').style.display = 'inline-block';

        // 将只读字段转换为可编辑字段
        convertToEditMode();
    }

    // 退出编辑模式
    function exitReviewEditMode() {
        // 显示编辑按钮，隐藏保存和取消按钮
        document.getElementById('editReviewBtn').style.display = 'inline-block';
        document.getElementById('saveReviewBtn').style.display = 'none';
        document.getElementById('cancelEditReviewBtn').style.display = 'none';

        // 将可编辑字段转换回只读字段
        convertToReadMode();
    }

    // 转换为编辑模式
    function convertToEditMode() {
        const fieldMappings = [
            { id: 'detailGroup', type: 'text' },
            { id: 'detailCategory', type: 'text' },
            { id: 'detailDqeResponsible', type: 'text' },
            { id: 'detailTestDate', type: 'date' },
            { id: 'detailMajorCode', type: 'text' },
            { id: 'detailMinorCode', type: 'text' },
            { id: 'detailProjectPhase', type: 'text' },
            { id: 'detailVersion', type: 'text' },
            { id: 'detailProblemProcess', type: 'text' },
            { id: 'detailProblemLevel', type: 'select', options: ['S', 'A', 'B', 'C'] },
            { id: 'detailDevelopmentMethod', type: 'text' },
            { id: 'detailSupplier', type: 'text' },
            { id: 'detailSolutionProvider', type: 'text' },
            { id: 'detailProblemPoint', type: 'textarea' },
            { id: 'detailProblemReason', type: 'textarea' },
            { id: 'detailImprovementMeasures', type: 'textarea' },
            { id: 'detailIsPreventable', type: 'select', options: ['是', '否'] },
            { id: 'detailResponsibleDepartment', type: 'text' },
            { id: 'detailPlannedCompletionTime', type: 'date' },
            { id: 'detailActualCompletionTime', type: 'date' },
            { id: 'detailDelayDays', type: 'number' },
            { id: 'detailProblemStatus', type: 'select', options: ['open', 'close', 'follow up'] },
            { id: 'detailProblemTag1', type: 'text' },
            { id: 'detailProblemTag2', type: 'text' },
            { id: 'detailPreventionNotes', type: 'textarea' },
            { id: 'detailDataSource', type: 'text' }
        ];

        fieldMappings.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
                const parent = element.parentElement;
                const currentValue = element.textContent === '-' ? '' : element.textContent;
                
                // 创建新的输入元素
                let inputElement;
                if (field.type === 'textarea') {
                    inputElement = document.createElement('textarea');
                    inputElement.rows = 3;
                } else if (field.type === 'select') {
                    inputElement = document.createElement('select');
                    field.options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = option;
                        inputElement.appendChild(optionElement);
                    });
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = field.type;
                }
                
                inputElement.id = 'edit' + field.id;
                
                // 特殊处理日期字段
                if (field.type === 'date' && currentValue && currentValue !== '-') {
                    // 将日期转换为HTML date input所需的格式 (YYYY-MM-DD)
                    const date = new Date(currentValue);
                    if (!isNaN(date.getTime())) {
                        inputElement.value = date.toISOString().split('T')[0];
                    } else {
                        inputElement.value = currentValue;
                    }
                } else {
                    inputElement.value = currentValue;
                }
                
                inputElement.className = 'form-control';
                
                // 替换原元素
                parent.replaceChild(inputElement, element);
            }
        });

        // 设置只读字段（创建时间和更新时间）
        const readonlyFields = ['detailCreatedTime', 'detailUpdatedTime'];
        readonlyFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {
                element.parentElement.classList.add('readonly');
            }
        });
    }

    // 转换为只读模式
    function convertToReadMode() {
        const fieldMappings = [
            'detailGroup', 'detailCategory', 'detailDqeResponsible', 'detailDataSource',
            'detailTestDate', 'detailMajorCode', 'detailMinorCode', 'detailProjectPhase',
            'detailVersion', 'detailProblemProcess', 'detailProblemLevel', 'detailDevelopmentMethod',
            'detailSupplier', 'detailSolutionProvider', 'detailProblemPoint', 'detailProblemReason',
            'detailImprovementMeasures', 'detailIsPreventable', 'detailResponsibleDepartment',
            'detailPlannedCompletionTime', 'detailActualCompletionTime', 'detailDelayDays',
            'detailProblemStatus', 'detailProblemTag1', 'detailProblemTag2', 'detailPreventionNotes'
        ];

        fieldMappings.forEach(fieldId => {
            const editElement = document.getElementById('edit' + fieldId);
            if (editElement) {
                const parent = editElement.parentElement;
                const currentValue = editElement.value || '-';
                
                // 创建新的显示元素
                let displayElement;
                if (fieldId.includes('ProblemPoint') || fieldId.includes('ProblemReason') || 
                    fieldId.includes('ImprovementMeasures') || fieldId.includes('PreventionNotes')) {
                    displayElement = document.createElement('div');
                    displayElement.className = 'problem-desc';
                } else {
                    displayElement = document.createElement('span');
                }
                
                displayElement.id = fieldId;
                displayElement.textContent = currentValue;
                
                // 替换编辑元素
                parent.replaceChild(displayElement, editElement);
            }
        });

        // 移除只读字段的样式
        const readonlyFields = ['detailCreatedTime', 'detailUpdatedTime'];
        readonlyFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {
                element.parentElement.classList.remove('readonly');
            }
        });
    }

    // 保存新品质量编辑
    function saveReviewEdit() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 判断是新增还是更新
        const isNewRecord = !currentEditingReviewId;
        
        if (!isNewRecord && !currentEditingReviewId) {
            showToast('没有找到要编辑的新品质量', 'error');
            return;
        }

        // 如果是更新操作，检查组别权限
        if (!isNewRecord && currentEditingReviewId) {
            const review = filteredData.find(r => r.id === currentEditingReviewId);
            if (review) {
                const reviewGroup = review.group || '';
                // 检查组别是否允许编辑（如果组别为空，允许任何人编辑）
                if (!canEditByGroup(reviewGroup, departmentName, review.dqeResponsible)) {
                    showToast(`没有权限编辑此记录：组别不匹配（组别: ${reviewGroup}，当前部门: ${departmentName}）`, 'error');
                    return;
                }
            }
        }

        // 收集编辑后的数据
        const editData = {
            group: document.getElementById('editdetailGroup')?.value || '',
            category: document.getElementById('editdetailCategory')?.value || '',
            dqeResponsible: document.getElementById('editdetailDqeResponsible')?.value || '',
            testDate: document.getElementById('editdetailTestDate')?.value || '',
            majorCode: document.getElementById('editdetailMajorCode')?.value || '',
            minorCode: document.getElementById('editdetailMinorCode')?.value || '',
            projectPhase: document.getElementById('editdetailProjectPhase')?.value || '',
            version: document.getElementById('editdetailVersion')?.value || '',
            problemProcess: document.getElementById('editdetailProblemProcess')?.value || '',
            problemLevel: document.getElementById('editdetailProblemLevel')?.value || '',
            developmentMethod: document.getElementById('editdetailDevelopmentMethod')?.value || '',
            supplier: document.getElementById('editdetailSupplier')?.value || '',
            solutionProvider: document.getElementById('editdetailSolutionProvider')?.value || '',
            problemPoint: document.getElementById('editdetailProblemPoint')?.value || '',
            problemReason: document.getElementById('editdetailProblemReason')?.value || '',
            improvementMeasures: document.getElementById('editdetailImprovementMeasures')?.value || '',
            isPreventable: document.getElementById('editdetailIsPreventable')?.value || '',
            responsibleDepartment: document.getElementById('editdetailResponsibleDepartment')?.value || '',
            plannedCompletionTime: document.getElementById('editdetailPlannedCompletionTime')?.value || '',
            actualCompletionTime: document.getElementById('editdetailActualCompletionTime')?.value || '',
            delayDays: document.getElementById('editdetailDelayDays')?.value || '',
            problemStatus: document.getElementById('editdetailProblemStatus')?.value || '',
            problemTag1: document.getElementById('editdetailProblemTag1')?.value || '',
            problemTag2: document.getElementById('editdetailProblemTag2')?.value || '',
            preventionNotes: document.getElementById('editdetailPreventionNotes')?.value || '',
            dataSource: document.getElementById('editdetailDataSource')?.value || ''
        };

        // 只有在更新时才添加id字段
        if (!isNewRecord) {
            editData.id = currentEditingReviewId;
        }

        // 显示加载状态
        showLoading();

        // 根据是新增还是更新选择不同的API
        const apiUrl = isNewRecord ? '/reviewResult/add' : '/reviewResult/update';
        const successMessage = isNewRecord ? '新品质量新增成功' : '新品质量更新成功';
        const errorMessage = isNewRecord ? '新增失败' : '更新失败';

        // 发送请求
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(editData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(successMessage, 'success');
                
                if (isNewRecord) {
                    // 新增成功后，重新加载数据
                    loadReviewData();
                } else {
                    // 更新成功后，更新本地数据
                    const reviewIndex = filteredData.findIndex(r => r.id === currentEditingReviewId);
                    if (reviewIndex !== -1) {
                        Object.assign(filteredData[reviewIndex], editData);
                    }
                    // 刷新表格显示
                    renderTable();
                }
                
                // 退出编辑模式
                exitReviewEditMode();
                // 关闭模态框
                document.getElementById('reviewDetailModal').style.display = 'none';
            } else {
                showToast(errorMessage + ': ' + (data.message || '未知错误'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast((isNewRecord ? '新增' : '更新') + '时发生错误', 'error');
        })
        .finally(() => {
            hideLoading();
        });
    }

    // 取消新品质量编辑
    function cancelReviewEdit() {
        // 退出编辑模式
        exitReviewEditMode();
        // 重新加载原始数据
        showReviewDetail(currentEditingReviewId);
    }

    // 重置新品质量编辑模式（用于模态框关闭时）
    function resetReviewEditMode() {
        // 如果当前在编辑模式，先退出编辑模式
        const editBtn = document.getElementById('editReviewBtn');
        const saveBtn = document.getElementById('saveReviewBtn');
        const cancelBtn = document.getElementById('cancelEditReviewBtn');
        
        if (editBtn && saveBtn && cancelBtn) {
            // 检查是否在编辑模式
            if (saveBtn.style.display !== 'none') {
                // 在编辑模式，需要重置
                exitReviewEditMode();
            }
        }
        
        // 清空当前编辑的新品质量ID
        currentEditingReviewId = null;
    }


    // 显示问题点详情
    function showProblemDetail(problemId) {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 首先尝试从当前过滤数据中查找
        let problem = filteredData.find(p => p.id === problemId);

        // 如果没找到，说明是从历史版本模态框中点击的，需要通过API获取详情
        if (!problem) {
            showLoading();
            fetch(`/problemLibrary/getProblemById?id=${problemId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        problem = data.data;
                        displayProblemDetail(problem);
                    } else {
                        alert('获取问题点详情失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取问题点详情时发生错误');
                })
                .finally(() => {
                    hideLoading();
                });
            return;
        }

        displayProblemDetail(problem);
    }

    // 显示问题点详情的具体实现
    function displayProblemDetail(problem) {
        // 填充详情数据
        document.getElementById('detailFullModel').textContent = problem.full_model || '';
        document.getElementById('detailSampleId').textContent = problem.sample_id || '';
        document.getElementById('detailBigSpecies').textContent = problem.big_species || '';
        document.getElementById('detailSmallSpecies').textContent = problem.small_species || '';
        document.getElementById('detailSampleStage').textContent = problem.sample_stage || '';
        document.getElementById('detailVersion').textContent = problem.version || '';
        document.getElementById('detailChipSolution').textContent = problem.chip_solution || '';
        document.getElementById('detailTestPlatform').textContent = problem.test_platform || '';
        document.getElementById('detailTestDevice').textContent = problem.test_device || '';
        document.getElementById('detailOtherDevice').textContent = problem.other_device || '';
        document.getElementById('detailProblem').textContent = problem.problem || '';

        // 显示问题图片
        displayProblemImages(problem.problem_image_or_video);

        document.getElementById('detailProblemCategory').textContent = problem.problemCategory || '';
        document.getElementById('detailDefectLevel').textContent = problem.defect_level || '';
        document.getElementById('detailCurrentStatus').textContent = normalizeStatus(problem.current_status);
        document.getElementById('detailReproductionMethod').textContent = problem.reproduction_method || '';
        document.getElementById('detailRecoveryMethod').textContent = problem.recovery_method || '';
        document.getElementById('detailReproductionProbability').textContent = problem.reproduction_probability || '';
        document.getElementById('detailTester').textContent = problem.tester || '';
        document.getElementById('detailResponsibleDepartment').textContent = problem.responsibleDepartment || '';
        document.getElementById('detailResponsiblePerson').textContent = problem.responsible_person || '';
        document.getElementById('detailDqeConfirm').textContent = problem.dqe_confirm || '';
        document.getElementById('detailRdConfirm').textContent = problem.rd_confirm || '';
        document.getElementById('detailImprovementPlan').textContent = problem.improvement_plan || '';
        document.getElementById('detailGreenUnionDqe').textContent = problem.green_union_dqe || '';
        document.getElementById('detailGreenUnionRd').textContent = problem.green_union_rd || '';
        document.getElementById('detailComparisonWithPrevious').textContent = problem.comparison_with_previous || '';
        document.getElementById('detailPostImprovementRisk').textContent = problem.post_improvement_risk || '';
        document.getElementById('detailNextVersionRegressionTest').textContent = problem.next_version_regression_test || '';
        document.getElementById('detailRemark').textContent = problem.remark || '';
        document.getElementById('detailTestOverseas').textContent = problem.test_Overseas || '';
        document.getElementById('detailCreatedAt').textContent = problem.created_at || '';

        // 设置问题ID
        document.getElementById('editProblemId').value = problem.id;

        // 同步编辑输入框的值
        document.getElementById('editDetailFullModel').value = problem.full_model || '';
        document.getElementById('editDetailBigSpecies').value = problem.big_species || '';
        document.getElementById('editDetailSmallSpecies').value = problem.small_species || '';
        document.getElementById('editDetailSampleStage').value = problem.sample_stage || '';
        document.getElementById('editDetailVersion').value = problem.version || '';
        document.getElementById('editDetailChipSolution').value = problem.chip_solution || '';
        document.getElementById('editDetailTestPlatform').value = problem.test_platform || '';
        document.getElementById('editDetailTestDevice').value = problem.test_device || '';
        document.getElementById('editDetailOtherDevice').value = problem.other_device || '';
        document.getElementById('editDetailProblem').value = problem.problem || '';
        document.getElementById('editDetailProblemCategory').value = problem.problemCategory || '';
        document.getElementById('editDetailDefectLevel').value = problem.defect_level || '';
        document.getElementById('editDetailCurrentStatus').value = normalizeStatus(problem.current_status);
        document.getElementById('editDetailReproductionMethod').value = problem.reproduction_method || '';
        document.getElementById('editDetailRecoveryMethod').value = problem.recovery_method || '';
        document.getElementById('editDetailReproductionProbability').value = problem.reproduction_probability || '';
        document.getElementById('editDetailTester').value = problem.tester || '';
        document.getElementById('editDetailResponsibleDepartment').value = problem.responsibleDepartment || '';
        document.getElementById('editDetailResponsiblePerson').value = problem.responsible_person || '';
        document.getElementById('editDetailDqeConfirm').value = problem.dqe_confirm || '';
        document.getElementById('editDetailRdConfirm').value = problem.rd_confirm || '';
        document.getElementById('editDetailImprovementPlan').value = problem.improvement_plan || '';
        document.getElementById('editDetailGreenUnionDqe').value = problem.green_union_dqe || '';
        document.getElementById('editDetailGreenUnionRd').value = problem.green_union_rd || '';
        document.getElementById('editDetailComparisonWithPrevious').value = problem.comparison_with_previous || '';
        document.getElementById('editDetailPostImprovementRisk').value = problem.post_improvement_risk || '';
        document.getElementById('editDetailNextVersionRegressionTest').value = problem.next_version_regression_test || '';
        document.getElementById('editDetailRemark').value = problem.remark || '';
        document.getElementById('editDetailTestOverseas').value = problem.test_Overseas || '';

        // 编辑按钮显示
        const editBtn = document.getElementById('editProblemBtn');
        if (editBtn) {
            editBtn.style.display = 'inline-flex';
        }

        // 确保退出编辑模式
        exitEditMode();

        document.getElementById('problemDetailModal').style.display = 'block';
    }

    // 显示问题图片
    function displayProblemImages(imageData) {
        const container = document.getElementById('detailProblemImage');
        container.innerHTML = '';

        if (!imageData || imageData.trim() === '') {
            container.innerHTML = '<div class="no-image">暂无问题图片</div>';
            return;
        }

        try {
            // 处理图片路径数据
            let imageUrls = [];

            // 如果是JSON字符串，尝试解析
            if (imageData.startsWith('[') || imageData.startsWith('{')) {
                try {
                    const parsed = JSON.parse(imageData);
                    if (Array.isArray(parsed)) {
                        imageUrls = parsed;
                    } else if (parsed.urls && Array.isArray(parsed.urls)) {
                        imageUrls = parsed.urls;
                    }
                } catch (e) {
                    console.warn('解析图片JSON数据失败:', e);
                }
            }

            // 如果解析失败或不是JSON，尝试按逗号分割
            if (imageUrls.length === 0) {
                imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
            }

            if (imageUrls.length === 0) {
                container.innerHTML = '<div class="no-image">暂无问题图片</div>';
                return;
            }

            // 创建图片画廊
            const gallery = document.createElement('div');
            gallery.className = 'image-gallery';

            imageUrls.forEach((imagePath, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';

                const img = document.createElement('img');

                // 处理图片路径：如果是相对路径，直接使用；如果是绝对路径，也直接使用
                let imageUrl = imagePath;

                // 确保路径以/开头（服务器相对路径）
                if (!imagePath.startsWith('/') && !imagePath.startsWith('http')) {
                    imageUrl = '/' + imagePath;
                }

                img.src = imageUrl;
                img.alt = `问题图片 ${index + 1}`;
                img.title = `点击查看大图 - ${imagePath}`;

                // 添加点击事件，可以放大查看
                img.addEventListener('click', function() {
                    showImageModal(imageUrl, index + 1, imageUrls.map(path => {
                        if (!path.startsWith('/') && !path.startsWith('http')) {
                            return '/' + path;
                        }
                        return path;
                    }));
                });

                // 添加错误处理
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'no-image';
                    errorDiv.textContent = `图片加载失败: ${imagePath}`;
                    imageItem.appendChild(errorDiv);
                });

                imageItem.appendChild(img);
                gallery.appendChild(imageItem);
            });

            container.appendChild(gallery);
        } catch (error) {
            console.error('处理问题图片时发生错误:', error);
            container.innerHTML = '<div class="no-image">图片数据格式错误</div>';
        }
    }

    // 显示图片放大模态框
    function showImageModal(imageUrl, currentIndex, allUrls) {
        // 创建图片查看模态框
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.zIndex = '10001';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 20px;">
                    <div class="modal-header">
                        <h2>问题图片查看 (${currentIndex}/${allUrls.length})</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="text-align: center; overflow: auto; position: relative;">
                        <div id="imageContainer" style="position: relative; display: inline-block;">
                            <img id="modalImage" src="${imageUrl}" style="max-width: 100%; max-height: 70vh; border-radius: 4px; transition: transform 0.3s ease; cursor: zoom-in;">
                        </div>
                        <div style="margin-top: 10px;">
                            ${allUrls.length > 1 ? `
                                <button onclick="switchImage(${currentIndex - 2}, ${allUrls.length})" ${currentIndex <= 1 ? 'disabled' : ''}>上一张</button>
                                <button onclick="switchImage(${currentIndex}, ${allUrls.length})" ${currentIndex >= allUrls.length ? 'disabled' : ''}>下一张</button>
                            ` : ''}
                            <button onclick="resetImageZoom()">重置缩放</button>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
        modal.style.display = 'block';

        // 初始化图片缩放功能
        initImageZoom(modal);

        // 点击模态框外部关闭
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // 初始化图片缩放功能
    function initImageZoom(modal) {
        const img = modal.querySelector('#modalImage');
        const container = modal.querySelector('#imageContainer');
        let scale = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        // 鼠标滚轮缩放
        img.addEventListener('wheel', function(e) {
            e.preventDefault();

            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newScale = Math.max(0.1, Math.min(5, scale + delta));

            if (newScale !== scale) {
                scale = newScale;
                updateImageTransform();
            }
        });

        // 鼠标点击切换缩放
        img.addEventListener('click', function(e) {
            e.stopPropagation();

            if (scale === 1) {
                scale = 2;
                img.style.cursor = 'zoom-out';
            } else {
                scale = 1;
                translateX = 0;
                translateY = 0;
                img.style.cursor = 'zoom-in';
            }

            updateImageTransform();
        });

        // 鼠标拖拽
        img.addEventListener('mousedown', function(e) {
            if (scale > 1) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                img.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateImageTransform();
            }
        });

        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                img.style.cursor = scale > 1 ? 'grab' : 'zoom-in';
            }
        });

        // 更新图片变换
        function updateImageTransform() {
            img.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
        }

        // 重置缩放
        window.resetImageZoom = function() {
            scale = 1;
            translateX = 0;
            translateY = 0;
            img.style.cursor = 'zoom-in';
            updateImageTransform();
        };

        // 全局搜索快捷键
        document.addEventListener('keydown', function(e) {
            // 如果焦点在输入框中，按回车键触发搜索
            if (e.key === 'Enter' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                const activeElement = document.activeElement;
                const isInputField = activeElement && (
                    activeElement.tagName === 'INPUT' ||
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.tagName === 'SELECT'
                );

                // 如果焦点在筛选输入框中，触发搜索
                if (isInputField && filterInputs.includes(activeElement.id)) {
                    e.preventDefault();
                    searchReviews();
                    return;
                }

                // 如果焦点在搜索按钮上，触发搜索
                if (activeElement && activeElement.id === 'searchBtn') {
                    e.preventDefault();
                    searchReviews();
                    return;
                }
            }
        });

        // 图片查看模态框的键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (modal && modal.style.display === 'block') {
                if (e.key === 'Escape') {
                    modal.remove();
                } else if (e.key === '0') {
                    resetImageZoom();
                } else if (e.key === '+' || e.key === '=') {
                    scale = Math.min(5, scale + 0.2);
                    updateImageTransform();
                } else if (e.key === '-') {
                    scale = Math.max(0.1, scale - 0.2);
                    updateImageTransform();
                }
            }
        });
    }

    // 切换图片
    function switchImage(newIndex, totalCount) {
        if (newIndex < 0 || newIndex >= totalCount) return;

        const modal = document.querySelector('.modal[style*="z-index: 10001"]');
        if (modal) {
            const img = modal.querySelector('#modalImage');
            const allUrls = Array.from(document.querySelectorAll('.image-item img')).map(img => img.src);
            img.src = allUrls[newIndex];

            // 重置缩放状态
            img.style.transform = 'scale(1) translate(0px, 0px)';
            img.style.cursor = 'zoom-in';

            // 更新标题
            const title = modal.querySelector('h2');
            title.textContent = `问题图片查看 (${newIndex + 1}/${totalCount})`;

            // 更新按钮状态
            const prevBtn = modal.querySelector('button[onclick*="上一张"]');
            const nextBtn = modal.querySelector('button[onclick*="下一张"]');
            if (prevBtn) prevBtn.disabled = newIndex <= 0;
            if (nextBtn) nextBtn.disabled = newIndex >= totalCount - 1;

            // 重新初始化缩放功能
            initImageZoom(modal);
        }
    }

    // 显示编辑问题点模态框
    function showEditProblemModal(problemId) {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        const problem = filteredData.find(p => p.id === problemId);
        if (!problem) return;

        // 填充编辑表单
        document.getElementById('editProblemId').value = problem.id;
        document.getElementById('editFullModel').value = problem.full_model || '';
        document.getElementById('editSampleStage').value = problem.sample_stage || '';
        document.getElementById('editVersion').value = problem.version || '';
        document.getElementById('editProblemCategory').value = problem.problemCategory || '';
        document.getElementById('editDefectLevel').value = problem.defect_level || '';
        document.getElementById('editCurrentStatus').value = normalizeStatus(problem.current_status);
        document.getElementById('editProblem').value = problem.problem || '';

        // 初始化问题图片字段
        const imageField = document.getElementById('editProblemImage');
        imageField.value = problem.problem_image_or_video || '';
        updateImagePreview();

        document.getElementById('editReproductionMethod').value = problem.reproduction_method || '';
        document.getElementById('editRecoveryMethod').value = problem.recovery_method || '';
        document.getElementById('editReproductionProbability').value = problem.reproduction_probability || '';
        document.getElementById('editTester').value = problem.tester || '';
        document.getElementById('editResponsibleDepartment').value = problem.responsibleDepartment || '';
        document.getElementById('editResponsiblePerson').value = problem.responsible_person || '';
        document.getElementById('editImprovementPlan').value = problem.improvement_plan || '';
        document.getElementById('editGreenUnionDqe').value = problem.green_union_dqe || '';
        document.getElementById('editGreenUnionRd').value = problem.green_union_rd || '';
        document.getElementById('editTestOverseas').value = problem.test_Overseas || '';
        document.getElementById('editRemark').value = problem.remark || '';

        document.getElementById('editProblemModal').style.display = 'block';
    }

    // 更新图片预览
    function updateImagePreview() {
        const imageField = document.getElementById('editProblemImage');
        const previewContainer = document.getElementById('editImagePreview');

        if (!imageField || !previewContainer) return;

        const imageData = imageField.value.trim();
        previewContainer.innerHTML = '';

        if (!imageData) {
            previewContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">暂无图片预览</div>';
            return;
        }

        try {
            // 解析图片路径
            let imageUrls = [];

            // 如果是JSON字符串，尝试解析
            if (imageData.startsWith('[') || imageData.startsWith('{')) {
                try {
                    const parsed = JSON.parse(imageData);
                    if (Array.isArray(parsed)) {
                        imageUrls = parsed;
                    } else if (parsed.urls && Array.isArray(parsed.urls)) {
                        imageUrls = parsed.urls;
                    }
                } catch (e) {
                    console.warn('解析图片JSON数据失败:', e);
                }
            }

            // 如果解析失败或不是JSON，尝试按逗号分割
            if (imageUrls.length === 0) {
                imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
            }

            if (imageUrls.length === 0) {
                previewContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">暂无有效图片路径</div>';
                return;
            }

            // 创建预览画廊
            const gallery = document.createElement('div');
            gallery.className = 'preview-gallery';

            imageUrls.forEach((imagePath, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';

                const img = document.createElement('img');
                let imageUrl = imagePath;

                // 确保路径以/开头（服务器相对路径）
                if (!imagePath.startsWith('/') && !imagePath.startsWith('http')) {
                    imageUrl = '/' + imagePath;
                }

                img.src = imageUrl;
                img.alt = `预览图片 ${index + 1}`;
                img.title = imagePath;

                // 添加点击事件，可以放大查看
                img.addEventListener('click', function() {
                    showImageModal(imageUrl, index + 1, imageUrls.map(path => {
                        if (!path.startsWith('/') && !path.startsWith('http')) {
                            return '/' + path;
                        }
                        return path;
                    }));
                });

                // 添加错误处理
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = '#dc3545';
                    errorDiv.style.fontSize = '10px';
                    errorDiv.style.padding = '5px';
                    errorDiv.textContent = '加载失败';
                    previewItem.appendChild(errorDiv);
                });

                // 添加删除按钮
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '×';
                removeBtn.title = '删除此图片';
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeImageFromEdit(index);
                });

                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                gallery.appendChild(previewItem);
            });

            previewContainer.appendChild(gallery);
        } catch (error) {
            console.error('处理图片预览时发生错误:', error);
            previewContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">图片数据格式错误</div>';
        }
    }

    // 从编辑中删除图片
    function removeImageFromEdit(index) {
        const imageField = document.getElementById('editProblemImage');
        const imageData = imageField.value.trim();

        if (!imageData) return;

        try {
            let imageUrls = [];

            // 解析图片路径
            if (imageData.startsWith('[') || imageData.startsWith('{')) {
                try {
                    const parsed = JSON.parse(imageData);
                    if (Array.isArray(parsed)) {
                        imageUrls = parsed;
                    } else if (parsed.urls && Array.isArray(parsed.urls)) {
                        imageUrls = parsed.urls;
                    }
                } catch (e) {
                    console.warn('解析图片JSON数据失败:', e);
                }
            }

            if (imageUrls.length === 0) {
                imageUrls = imageData.split(',').map(url => url.trim()).filter(url => url.length > 0);
            }

            // 删除指定索引的图片
            if (index >= 0 && index < imageUrls.length) {
                imageUrls.splice(index, 1);

                // 更新字段值
                imageField.value = imageUrls.join(',');

                // 更新预览
                updateImagePreview();
            }
        } catch (error) {
            console.error('删除图片时发生错误:', error);
        }
    }

    // 保存问题点
    function saveProblem() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        // 检查问题点字段是否为空
        const problemValue = document.getElementById('editProblem').value;
        if (!problemValue || problemValue.trim() === '') {
            alert('问题点字段不能为空，请填写问题描述！');
            document.getElementById('editProblem').focus();
            return;
        }

        const formData = new FormData(document.getElementById('editProblemForm'));
        const problemData = Object.fromEntries(formData.entries());
        problemData.id = document.getElementById('editProblemId').value;
        problemData.modifier = currentUser;

        showLoading();

        fetch('/problemLibrary/updateProblem', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(problemData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                    closeModal();
                    loadProblemData();
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // 渲染表格
    function renderTable() {
        const tbody = document.getElementById('reviewTableBody');
        tbody.innerHTML = '';

        // 直接使用allData，因为服务器端已经处理了分页
        const pageData = allData;

        pageData.forEach(review => {
            const row = document.createElement('tr');
            
            // 根据编辑模式决定渲染方式
            if (isGlobalEditMode) {
                // 判断是否允许编辑：如果组别为空，允许任何人编辑；如果departmentName为空，允许编辑所有行；否则需要组别匹配
                const reviewGroup = review.group || '';
                const canEdit = canEditByGroup(reviewGroup, departmentName, review.dqeResponsible);
                
                if (canEdit) {
                    // 允许编辑的行：显示输入框
                    row.innerHTML = `
                        <td data-key="checkbox">
                            <input type="checkbox" class="table-row-checkbox" data-id="${review.id}" title="选择此行">
                        </td>
                        <td data-key="id">${review.id || '-'}</td>
                        <td data-key="group"><input type="text" class="table-cell-input" data-field="group" value="${review.group || ''}" /></td>
                        <td data-key="category"><input type="text" class="table-cell-input" data-field="category" value="${review.category || ''}" /></td>
                        <td data-key="testDate"><input type="date" class="table-cell-date-input" data-field="testDate" value="${review.testDate ? formatDateForInput(review.testDate) : ''}" /></td>
                        <td data-key="majorCode"><input type="text" class="table-cell-input" data-field="majorCode" value="${review.majorCode || ''}" /></td>
                        <td data-key="minorCode"><input type="text" class="table-cell-input" data-field="minorCode" value="${review.minorCode || ''}" /></td>
                        <td data-key="projectPhase"><input type="text" class="table-cell-input" data-field="projectPhase" value="${review.projectPhase || ''}" /></td>
                        <td data-key="version"><input type="text" class="table-cell-input" data-field="version" value="${review.version || ''}" /></td>
                        <td data-key="problemProcess"><input type="text" class="table-cell-input" data-field="problemProcess" value="${review.problemProcess || ''}" /></td>
                        <td data-key="problemLevel"><input type="text" class="table-cell-input" data-field="problemLevel" value="${review.problemLevel || ''}" /></td>
                        <td data-key="developmentMethod"><input type="text" class="table-cell-input" data-field="developmentMethod" value="${review.developmentMethod || ''}" /></td>
                        <td data-key="supplier"><input type="text" class="table-cell-input" data-field="supplier" value="${review.supplier || ''}" /></td>
                        <td data-key="solutionProvider"><input type="text" class="table-cell-input" data-field="solutionProvider" value="${review.solutionProvider || ''}" /></td>
                        <td data-key="problemPoint"><input type="text" class="table-cell-input" data-field="problemPoint" value="${review.problemPoint || ''}" /></td>
                        <td data-key="problemReason"><input type="text" class="table-cell-input" data-field="problemReason" value="${review.problemReason || ''}" /></td>
                        <td data-key="improvementMeasures"><input type="text" class="table-cell-input" data-field="improvementMeasures" value="${review.improvementMeasures || ''}" /></td>
                        <td data-key="isPreventable"><input type="text" class="table-cell-input" data-field="isPreventable" value="${review.isPreventable || ''}" /></td>
                        <td data-key="responsibleDepartment"><input type="text" class="table-cell-input" data-field="responsibleDepartment" value="${review.responsibleDepartment || ''}" /></td>
                        <td data-key="dqeResponsible"><input type="text" class="table-cell-input" data-field="dqeResponsible" value="${review.dqeResponsible || ''}" /></td>
                        <td data-key="problemStatus"><input type="text" class="table-cell-input" data-field="problemStatus" value="${review.problemStatus || ''}" /></td>
                        <td data-key="plannedCompletionTime"><input type="date" class="table-cell-date-input" data-field="plannedCompletionTime" value="${review.plannedCompletionTime ? formatDateForInput(review.plannedCompletionTime) : ''}" /></td>
                        <td data-key="actualCompletionTime"><input type="date" class="table-cell-date-input" data-field="actualCompletionTime" value="${review.actualCompletionTime ? formatDateForInput(review.actualCompletionTime) : ''}" /></td>
                        <td data-key="delayDays"><input type="number" class="table-cell-input" data-field="delayDays" value="${review.delayDays || ''}" /></td>
                        <td data-key="problemTag1"><input type="text" class="table-cell-input" data-field="problemTag1" value="${review.problemTag1 || ''}" /></td>
                        <td data-key="problemTag2"><input type="text" class="table-cell-input" data-field="problemTag2" value="${review.problemTag2 || ''}" /></td>
                        <td data-key="preventionNotes"><input type="text" class="table-cell-input" data-field="preventionNotes" value="${review.preventionNotes || ''}" /></td>
                        <td data-key="dataSource"><input type="text" class="table-cell-input" data-field="dataSource" value="${review.dataSource || ''}" /></td>
                        <td data-key="createdTime">${review.createdTime ? new Date(review.createdTime).toLocaleString('zh-CN') : '-'}</td>
                        <td data-key="updatedTime">${review.updatedTime ? new Date(review.updatedTime).toLocaleString('zh-CN') : '-'}</td>
                        <td data-key="action">
                            <button class="btn btn-sm btn-info" onclick="showReviewDetail(${review.id})" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                } else {
                    // 不允许编辑的行：直接显示普通文本（不变）
                    row.innerHTML = `
                        <td data-key="checkbox">
                            <input type="checkbox" class="table-row-checkbox" data-id="${review.id}" title="选择此行">
                        </td>
                        <td data-key="id">${review.id || '-'}</td>
                        <td data-key="group">${review.group || '-'}</td>
                        <td data-key="category">${review.category || '-'}</td>
                        <td data-key="testDate">${review.testDate || '-'}</td>
                        <td data-key="majorCode">${review.majorCode || '-'}</td>
                        <td data-key="minorCode">${review.minorCode || '-'}</td>
                        <td data-key="projectPhase">${review.projectPhase || '-'}</td>
                        <td data-key="version">${review.version || '-'}</td>
                        <td data-key="problemProcess" class="problem-desc" title="${review.problemProcess || ''}">${(review.problemProcess || '').substring(0, 20)}${(review.problemProcess || '').length > 20 ? '...' : ''}</td>
                        <td data-key="problemLevel"><span class="status-badge status-${review.problemLevel?.toLowerCase() || ''}">${review.problemLevel || '-'}</span></td>
                        <td data-key="developmentMethod" class="problem-desc" title="${review.developmentMethod || ''}">${(review.developmentMethod || '').substring(0, 20)}${(review.developmentMethod || '').length > 20 ? '...' : ''}</td>
                        <td data-key="supplier" class="problem-desc" title="${review.supplier || ''}">${(review.supplier || '').substring(0, 20)}${(review.supplier || '').length > 20 ? '...' : ''}</td>
                        <td data-key="solutionProvider" class="problem-desc" title="${review.solutionProvider || ''}">${(review.solutionProvider || '').substring(0, 20)}${(review.solutionProvider || '').length > 20 ? '...' : ''}</td>
                        <td data-key="problemPoint" class="problem-desc" title="${review.problemPoint || ''}">${(review.problemPoint || '').substring(0, 30)}${(review.problemPoint || '').length > 30 ? '...' : ''}</td>
                        <td data-key="problemReason" class="problem-desc" title="${review.problemReason || ''}">${(review.problemReason || '').substring(0, 30)}${(review.problemReason || '').length > 30 ? '...' : ''}</td>
                        <td data-key="improvementMeasures" class="problem-desc" title="${review.improvementMeasures || ''}">${(review.improvementMeasures || '').substring(0, 30)}${(review.improvementMeasures || '').length > 30 ? '...' : ''}</td>
                        <td data-key="isPreventable">${review.isPreventable || '-'}</td>
                        <td data-key="responsibleDepartment">${review.responsibleDepartment || '-'}</td>
                        <td data-key="dqeResponsible">${review.dqeResponsible || '-'}</td>
                        <td data-key="problemStatus"><span class="status-badge status-${review.problemStatus?.toLowerCase().replace(' ', '') || ''}">${review.problemStatus || '-'}</span></td>
                        <td data-key="plannedCompletionTime">${formatDate(review.plannedCompletionTime)}</td>
                        <td data-key="actualCompletionTime">${formatDate(review.actualCompletionTime)}</td>
                        <td data-key="delayDays">${review.delayDays || '-'}</td>
                        <td data-key="problemTag1" class="problem-desc" title="${review.problemTag1 || ''}">${(review.problemTag1 || '').substring(0, 20)}${(review.problemTag1 || '').length > 20 ? '...' : ''}</td>
                        <td data-key="problemTag2" class="problem-desc" title="${review.problemTag2 || ''}">${(review.problemTag2 || '').substring(0, 20)}${(review.problemTag2 || '').length > 20 ? '...' : ''}</td>
                        <td data-key="preventionNotes" class="problem-desc" title="${review.preventionNotes || ''}">${(review.preventionNotes || '').substring(0, 30)}${(review.preventionNotes || '').length > 30 ? '...' : ''}</td>
                        <td data-key="dataSource">${review.dataSource || '-'}</td>
                        <td data-key="createdTime">${review.createdTime ? new Date(review.createdTime).toLocaleString('zh-CN') : '-'}</td>
                        <td data-key="updatedTime">${review.updatedTime ? new Date(review.updatedTime).toLocaleString('zh-CN') : '-'}</td>
                        <td data-key="action">
                            <button class="btn btn-sm btn-info" onclick="showReviewDetail(${review.id})" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                }
            } else {
                // 普通模式：显示文本
                row.innerHTML = `
                    <td data-key="checkbox">
                        <input type="checkbox" class="table-row-checkbox" data-id="${review.id}" title="选择此行">
                    </td>
                    <td data-key="id">${review.id || '-'}</td>
                    <td data-key="group">${review.group || '-'}</td>
                    <td data-key="category">${review.category || '-'}</td>
                    <td data-key="testDate">${review.testDate || '-'}</td>
                    <td data-key="majorCode">${review.majorCode || '-'}</td>
                    <td data-key="minorCode">${review.minorCode || '-'}</td>
                    <td data-key="projectPhase">${review.projectPhase || '-'}</td>
                    <td data-key="version">${review.version || '-'}</td>
                    <td data-key="problemProcess" class="problem-desc" title="${review.problemProcess || ''}">${(review.problemProcess || '').substring(0, 20)}${(review.problemProcess || '').length > 20 ? '...' : ''}</td>
                    <td data-key="problemLevel"><span class="status-badge status-${review.problemLevel?.toLowerCase() || ''}">${review.problemLevel || '-'}</span></td>
                    <td data-key="developmentMethod" class="problem-desc" title="${review.developmentMethod || ''}">${(review.developmentMethod || '').substring(0, 20)}${(review.developmentMethod || '').length > 20 ? '...' : ''}</td>
                    <td data-key="supplier" class="problem-desc" title="${review.supplier || ''}">${(review.supplier || '').substring(0, 20)}${(review.supplier || '').length > 20 ? '...' : ''}</td>
                    <td data-key="solutionProvider" class="problem-desc" title="${review.solutionProvider || ''}">${(review.solutionProvider || '').substring(0, 20)}${(review.solutionProvider || '').length > 20 ? '...' : ''}</td>
                    <td data-key="problemPoint" class="problem-desc" title="${review.problemPoint || ''}">${(review.problemPoint || '').substring(0, 30)}${(review.problemPoint || '').length > 30 ? '...' : ''}</td>
                    <td data-key="problemReason" class="problem-desc" title="${review.problemReason || ''}">${(review.problemReason || '').substring(0, 30)}${(review.problemReason || '').length > 30 ? '...' : ''}</td>
                    <td data-key="improvementMeasures" class="problem-desc" title="${review.improvementMeasures || ''}">${(review.improvementMeasures || '').substring(0, 30)}${(review.improvementMeasures || '').length > 30 ? '...' : ''}</td>
                    <td data-key="isPreventable">${review.isPreventable || '-'}</td>
                    <td data-key="responsibleDepartment">${review.responsibleDepartment || '-'}</td>
                    <td data-key="dqeResponsible">${review.dqeResponsible || '-'}</td>
                    <td data-key="problemStatus"><span class="status-badge status-${review.problemStatus?.toLowerCase().replace(' ', '') || ''}">${review.problemStatus || '-'}</span></td>
                    <td data-key="plannedCompletionTime">${formatDate(review.plannedCompletionTime)}</td>
                    <td data-key="actualCompletionTime">${formatDate(review.actualCompletionTime)}</td>
                    <td data-key="delayDays">${review.delayDays || '-'}</td>
                    <td data-key="problemTag1" class="problem-desc" title="${review.problemTag1 || ''}">${(review.problemTag1 || '').substring(0, 20)}${(review.problemTag1 || '').length > 20 ? '...' : ''}</td>
                    <td data-key="problemTag2" class="problem-desc" title="${review.problemTag2 || ''}">${(review.problemTag2 || '').substring(0, 20)}${(review.problemTag2 || '').length > 20 ? '...' : ''}</td>
                    <td data-key="preventionNotes" class="problem-desc" title="${review.preventionNotes || ''}">${(review.preventionNotes || '').substring(0, 30)}${(review.preventionNotes || '').length > 30 ? '...' : ''}</td>
                    <td data-key="dataSource">${review.dataSource || '-'}</td>
                    <td data-key="createdTime">${review.createdTime ? new Date(review.createdTime).toLocaleString('zh-CN') : '-'}</td>
                    <td data-key="updatedTime">${review.updatedTime ? new Date(review.updatedTime).toLocaleString('zh-CN') : '-'}</td>
                    <td data-key="action">
                        <button class="btn btn-sm btn-info" onclick="showReviewDetail(${review.id})" title="查看详情">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            }
            tbody.appendChild(row);
        });

        // 为每个复选框添加事件监听器
        const checkboxes = tbody.querySelectorAll('.table-row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleTableRowCheckboxChange);
        });

        // 更新按钮文本
        updateAddToCartButtonText();
        
        // 更新行的选中样式
        updateTableRowSelectionStyles();

        // 重新应用列的隐藏状态
        applyColumnVisibility();

        updatePagination();
    }

    // 更新分页信息
    function updatePagination() {
        console.log('updatePagination - totalCount:', totalCount, 'totalPages:', totalPages, 'currentPage:', currentPage, 'pageSize:', pageSize);

        // 使用服务器端返回的总页数，不再重新计算
        const startRecord = totalCount > 0 ? (currentPage - 1) * pageSize + 1 : 0;
        const endRecord = Math.min(currentPage * pageSize, totalCount);

        // 确保当前页不超过总页数
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        }

        document.getElementById('startRecord').textContent = startRecord;
        document.getElementById('endRecord').textContent = endRecord;
        document.getElementById('totalRecords').textContent = totalCount;

        // 更新按钮状态
        document.getElementById('firstPageBtn').disabled = currentPage === 1 || totalPages === 0;
        document.getElementById('prevPageBtn').disabled = currentPage === 1 || totalPages === 0;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
        document.getElementById('lastPageBtn').disabled = currentPage === totalPages || totalPages === 0;

        // 生成页码按钮
        generatePageNumbers(totalPages);

        // 更新跳转输入框的最大值
        document.getElementById('pageJumpInput').max = totalPages;

        // 调试信息
        // console.log(`分页信息: 总记录数=${totalCount}, 总页数=${totalPages}, 当前页=${currentPage}, 每页=${pageSize}`);
    }

    // 切换页面
    function changePage(direction) {
        const totalPages = Math.ceil(totalCount / pageSize);
        const newPage = currentPage + direction;

        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            loadReviewData(); // 重新加载数据
        }
    }

    // 跳转到指定页面
    function goToPage(page) {
        const totalPages = Math.ceil(totalCount / pageSize);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            loadReviewData(); // 重新加载数据
        }
    }

    // 跳转到最后一页
    function goToLastPage() {
        const totalPages = Math.ceil(totalCount / pageSize);
        if (totalPages > 0) {
            currentPage = totalPages;
            loadReviewData(); // 重新加载数据
        }
    }

    // 页码跳转
    function jumpToPage() {
        const input = document.getElementById('pageJumpInput');
        const page = parseInt(input.value);
        const totalPages = Math.ceil(totalCount / pageSize);

        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            loadReviewData(); // 重新加载数据
            input.value = '';
        } else {
            alert(`请输入1到${totalPages}之间的页码`);
            input.value = '';
        }
    }

    // 生成页码按钮
    function generatePageNumbers(totalPages) {
        console.log('generatePageNumbers - totalPages:', totalPages, 'currentPage:', currentPage);

        const pageNumbersContainer = document.getElementById('pageNumbers');
        pageNumbersContainer.innerHTML = '';

        // 即使只有一页也显示页码
        if (totalPages <= 0) {
            console.log('totalPages <= 0, 不生成页码按钮');
            return;
        }

        if (totalPages === 1) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = '1';
            pageBtn.className = 'btn btn-sm page-number active';
            pageBtn.onclick = () => goToPage(1);
            pageNumbersContainer.appendChild(pageBtn);
            return;
        }

        const maxVisiblePages = 5; // 最多显示5个页码按钮
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // 调整起始页码
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // 添加省略号
        if (startPage > 1) {
            const firstBtn = document.createElement('button');
            firstBtn.textContent = '1';
            firstBtn.className = 'btn btn-sm page-number';
            firstBtn.onclick = () => goToPage(1);
            pageNumbersContainer.appendChild(firstBtn);

            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-ellipsis';
                pageNumbersContainer.appendChild(ellipsis);
            }
        }

        // 添加页码按钮
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = `btn btn-sm page-number ${i === currentPage ? 'active' : ''}`;
            pageBtn.onclick = () => goToPage(i);
            pageNumbersContainer.appendChild(pageBtn);
        }

        // 添加省略号
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-ellipsis';
                pageNumbersContainer.appendChild(ellipsis);
            }

            const lastBtn = document.createElement('button');
            lastBtn.textContent = totalPages;
            lastBtn.className = 'btn btn-sm page-number';
            lastBtn.onclick = () => goToPage(totalPages);
            pageNumbersContainer.appendChild(lastBtn);
        }
    }


    // 应用筛选条件
    function applyFilters() {
        // 执行搜索以应用当前筛选条件
        searchProblems();
    }


    // 刷新单个选项（大类或小类）
    function refreshSingleSpeciesOptions(speciesType) {
        // 直接从服务器获取最新数据，不使用缓存
        fetchSpeciesOptionsFromServer(speciesType);
    }

    // 强制刷新（忽略缓存）
    function forceRefreshSpeciesOptions(speciesType) {
        // 清除缓存
        clearSpeciesCache();
        // 从服务器获取
        fetchSpeciesOptionsFromServer(speciesType);
    }


    // 从服务器获取选项
    function fetchSpeciesOptionsFromServer(speciesType) {
        showLoading();

        fetch('/problemLibrary/getSpeciesOptions', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('服务器返回的原始数据:', data.data);


                    // 更新缓存（同时更新所有选项，因为服务器返回的是完整数据）
                    setCachedSpeciesOptions('bigSpecies', data.data.bigSpecies);
                    setCachedSpeciesOptions('smallSpecies', data.data.smallSpecies);
                    setCachedSpeciesOptions('sampleStage', data.data.sampleStage);
                    setCachedSpeciesOptions('fullModel', data.data.fullModel);
                    setCachedSpeciesOptions('version', data.data.version);
                    setCachedSpeciesOptions('problemCategory', data.data.problemCategory);
                    setCachedSpeciesOptions('tester', data.data.tester);
                    setCachedSpeciesOptions('responsibleDepartment', data.data.responsibleDepartment);
                    setCachedSpeciesOptions('testPlatform', data.data.testPlatform);
                    setCachedSpeciesOptions('testDevice', data.data.testDevice);
                    setCachedSpeciesOptions('dqe', data.data.dqe);

                    // 更新对应的下拉框
                    if (speciesType === 'bigSpecies') {
                        updateSelectOptions('bigSpeciesFilter', data.data.bigSpecies);
                        showToast('大类选项已刷新并缓存', 'success');
                    } else if (speciesType === 'smallSpecies') {
                        updateSelectOptions('smallSpeciesFilter', data.data.smallSpecies);
                        showToast('小类选项已刷新并缓存', 'success');
                    } else if (speciesType === 'sampleStage') {
                        updateSelectOptions('sampleStageFilter', data.data.sampleStage);
                        showToast('样品阶段选项已刷新并缓存', 'success');
                    } else if (speciesType === 'fullModel') {
                        updateSelectOptions('fullModelFilter', data.data.fullModel);
                        showToast('完整编码选项已刷新并缓存', 'success');
                    } else if (speciesType === 'version') {
                        updateSelectOptions('versionFilter', data.data.version);
                        showToast('版本选项已刷新并缓存', 'success');
                    } else if (speciesType === 'problemCategory') {
                        // 重新初始化三级问题类别筛选器
                        // 设置数据库按钮为激活状态
                        showToast('问题类别选项已从数据库刷新并缓存', 'success');
                    } else if (speciesType === 'tester') {
                        updateSelectOptions('testerFilter', data.data.tester);
                        showToast('测试人员选项已刷新并缓存', 'success');
                    } else if (speciesType === 'responsibleDepartment') {
                        updateSelectOptions('responsibleDepartmentFilter', data.data.responsibleDepartment);
                        showToast('责任部门选项已刷新并缓存', 'success');
                    } else if (speciesType === 'testPlatform') {
                        updateSelectOptions('testPlatformFilter', data.data.testPlatform);
                        showToast('测试平台选项已刷新并缓存', 'success');
                    } else if (speciesType === 'testDevice') {
                        updateSelectOptions('testDeviceFilter', data.data.testDevice);
                        showToast('显示设备选项已刷新并缓存', 'success');
                    } else if (speciesType === 'dqe') {
                        updateSelectOptions('dqeFilter', data.data.dqe);
                        showToast('DQE负责人选项已刷新并缓存', 'success');
                    }
                } else {
                    showToast('刷新失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('刷新时发生错误', 'error');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // 更新下拉框选项
    function updateSelectOptions(selectId, options) {
        const select = document.getElementById(selectId);
        if (!select) return;

        // 保存当前选中的值
        const currentValue = select.value;

        // 清空现有选项（保留"全部"选项）
        select.innerHTML = '<option value="">全部</option>';

        // 添加新选项
        if (options && options.length > 0) {
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                // 如果选项为空字符串，显示为"空值"
                optionElement.textContent = option === '' ? '空值' : option;
                select.appendChild(optionElement);
            });
        }

        // 尝试恢复之前选中的值
        if (currentValue && Array.from(select.options).some(option => option.value === currentValue)) {
            select.value = currentValue;
        }
    }



    // 进入编辑模式
    function enterEditMode() {
        // 所有可编辑字段（除了提交时间）
        const editableFields = [
            'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
            'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
            'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
            'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
            'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
            'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
            'detailGreenUnionDqe', 'detailGreenUnionRd',
            'detailComparisonWithPrevious', 'detailPostImprovementRisk',
            'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
        ];

        editableFields.forEach(fieldId => {
            const displayElement = document.getElementById(fieldId);
            const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

            if (displayElement && inputElement) {
                displayElement.style.display = 'none';
                inputElement.style.display = 'block';
            }
        });

        // 切换按钮显示
        document.getElementById('editProblemBtn').style.display = 'none';
        document.getElementById('saveDetailBtn').style.display = 'inline-flex';
        document.getElementById('cancelEditBtn').style.display = 'inline-flex';
    }

    // 退出编辑模式
    function exitEditMode() {
        // 所有可编辑字段（除了提交时间）
        const editableFields = [
            'detailFullModel', 'detailBigSpecies', 'detailSmallSpecies', 'detailSampleStage', 'detailVersion', 'detailChipSolution',
            'detailTestPlatform', 'detailTestDevice', 'detailOtherDevice',
            'detailProblem', 'detailProblemCategory', 'detailDefectLevel', 'detailCurrentStatus',
            'detailReproductionMethod', 'detailRecoveryMethod', 'detailReproductionProbability',
            'detailTester', 'detailResponsibleDepartment', 'detailResponsiblePerson',
            'detailDqeConfirm', 'detailRdConfirm', 'detailImprovementPlan',
            'detailGreenUnionDqe', 'detailGreenUnionRd',
            'detailComparisonWithPrevious', 'detailPostImprovementRisk',
            'detailNextVersionRegressionTest', 'detailRemark', 'detailTestOverseas'
        ];

        editableFields.forEach(fieldId => {
            const displayElement = document.getElementById(fieldId);
            const inputElement = document.getElementById('edit' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));

            if (displayElement && inputElement) {
                displayElement.style.display = 'block';
                inputElement.style.display = 'none';
            }
        });

        // 切换按钮显示
        document.getElementById('editProblemBtn').style.display = 'inline-flex';
        document.getElementById('saveDetailBtn').style.display = 'none';
        document.getElementById('cancelEditBtn').style.display = 'none';
    }

    // 保存详情修改
    function saveDetailChanges() {
        // 检查问题点字段是否为空
        const problemValue = document.getElementById('editDetailProblem').value;
        if (!problemValue || problemValue.trim() === '') {
            alert('问题点字段不能为空，请填写问题描述！');
            document.getElementById('editDetailProblem').focus();
            return;
        }

        // 收集修改的数据 - 只传递必要的字段
        const problemData = {
            id: document.getElementById('editProblemId').value,
            modifier: currentUser
        };

        // 只添加有值的字段
        const fields = [
            { key: 'full_model', element: 'editDetailFullModel' },
            { key: 'big_species', element: 'editDetailBigSpecies' },
            { key: 'small_species', element: 'editDetailSmallSpecies' },
            { key: 'sample_stage', element: 'editDetailSampleStage' },
            { key: 'version', element: 'editDetailVersion' },
            { key: 'chip_solution', element: 'editDetailChipSolution' },
            { key: 'test_platform', element: 'editDetailTestPlatform' },
            { key: 'test_device', element: 'editDetailTestDevice' },
            { key: 'other_device', element: 'editDetailOtherDevice' },
            { key: 'problem', element: 'editDetailProblem' },
            { key: 'problemCategory', element: 'editDetailProblemCategory' },
            { key: 'defect_level', element: 'editDetailDefectLevel' },
            { key: 'current_status', element: 'editDetailCurrentStatus' },
            { key: 'reproduction_method', element: 'editDetailReproductionMethod' },
            { key: 'recovery_method', element: 'editDetailRecoveryMethod' },
            { key: 'reproduction_probability', element: 'editDetailReproductionProbability' },
            { key: 'tester', element: 'editDetailTester' },
            { key: 'responsibleDepartment', element: 'editDetailResponsibleDepartment' },
            { key: 'responsible_person', element: 'editDetailResponsiblePerson' },
            { key: 'dqe_confirm', element: 'editDetailDqeConfirm' },
            { key: 'rd_confirm', element: 'editDetailRdConfirm' },
            { key: 'improvement_plan', element: 'editDetailImprovementPlan' },
            { key: 'green_union_dqe', element: 'editDetailGreenUnionDqe' },
            { key: 'green_union_rd', element: 'editDetailGreenUnionRd' },
            { key: 'comparison_with_previous', element: 'editDetailComparisonWithPrevious' },
            { key: 'post_improvement_risk', element: 'editDetailPostImprovementRisk' },
            { key: 'next_version_regression_test', element: 'editDetailNextVersionRegressionTest' },
            { key: 'remark', element: 'editDetailRemark' },
            { key: 'test_Overseas', element: 'editDetailTestOverseas' }
        ];

        fields.forEach(field => {
            const element = document.getElementById(field.element);
            if (element && element.value !== '') {
                problemData[field.key] = element.value;
            }
        });

        showLoading();

        fetch('/problemLibrary/updateProblem', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(problemData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('保存成功');
                    exitEditMode();
                    loadProblemData(); // 重新加载表格数据

                    // 重新获取并显示更新后的问题点详情
                    const problemId = document.getElementById('editProblemId').value;
                    fetch(`/problemLibrary/getProblemById?id=${problemId}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success && result.data) {
                                displayProblemDetail(result.data);
                            }
                        })
                        .catch(error => {
                            console.error('获取更新后数据失败:', error);
                        });
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // 显示加载状态
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // 隐藏加载状态
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showCopyableDialog(message, title = '提示信息') {
        if (!copyableModal || !copyableModalTextarea || !copyableModalTitle) {
            alert(message);
            return;
        }
        copyableModalTitle.textContent = title;
        copyableModalTextarea.value = message;
        copyableModal.style.display = 'flex';
        copyableModal.addEventListener('click', handleCopyableModalOutsideClick);
        setTimeout(() => {
            copyableModalTextarea.focus();
            copyableModalTextarea.select();
        }, 50);
    }

    function closeCopyableDialog() {
        if (copyableModal) {
            copyableModal.style.display = 'none';
            copyableModal.removeEventListener('click', handleCopyableModalOutsideClick);
        }
    }

    function handleCopyableModalOutsideClick(event) {
        if (!copyableModal) {
            return;
        }
        const content = copyableModal.querySelector('.copyable-modal-content');
        if (content && !content.contains(event.target)) {
            closeCopyableDialog();
        }
    }

    // 显示自定义提示框
    function showToast(message, type = 'success', duration = 3000) {
        const toast = document.getElementById('customToast');
        const messageEl = document.getElementById('toastMessage');
        const iconEl = toast.querySelector('.toast-icon i');

        // 设置消息内容
        messageEl.textContent = message;

        // 设置图标和样式
        toast.className = 'custom-toast ' + type;
        switch(type) {
            case 'success':
                iconEl.className = 'fas fa-check-circle';
                break;
            case 'error':
                iconEl.className = 'fas fa-exclamation-circle';
                break;
            case 'warning':
                iconEl.className = 'fas fa-exclamation-triangle';
                break;
            case 'info':
                iconEl.className = 'fas fa-info-circle';
                break;
        }

        // 显示提示框
        toast.classList.add('show');

        // 自动隐藏
        if (duration > 0) {
            setTimeout(() => {
                hideToast();
            }, duration);
        }
    }

    // 隐藏自定义提示框
    function hideToast() {
        const toast = document.getElementById('customToast');
        toast.classList.remove('show');
    }

    // 关闭模态框
    function closeModal() {
        // 获取所有可见的模态框，按z-index排序
        const visibleModals = Array.from(document.querySelectorAll('.modal'))
            .filter(modal => modal.style.display === 'block')
            .sort((a, b) => {
                const aZIndex = parseInt(window.getComputedStyle(a).zIndex) || 0;
                const bZIndex = parseInt(window.getComputedStyle(b).zIndex) || 0;
                return bZIndex - aZIndex; // 降序排列，z-index高的在前
            });

        if (visibleModals.length > 0) {
            // 只关闭最顶层的模态框
            visibleModals[0].style.display = 'none';
        }
    }

    // 关闭指定模态框
    function closeSpecificModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // 返回上一页
    function goBack() {
        window.location.href = '/DQEIndex';
    }

    // 返回主页
    function goHome() {
        window.location.href = '/DQEIndex';
    }

    // 显示历史版本
    function showHistoryVersions(sampleId) {
        showLoading();

        fetch(`/problemLibrary/getHistoryVersions?sampleId=${sampleId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderHistoryVersions(data.data);
                    document.getElementById('historyVersionsModal').style.display = 'block';
                } else {
                    alert('获取历史版本失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取历史版本时发生错误');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // 渲染历史版本表格
    function renderHistoryVersions(historyVersions) {
        const tbody = document.getElementById('historyVersionsTableBody');
        tbody.innerHTML = '';

        if (!historyVersions || historyVersions.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td colspan="6" style="text-align: center;">暂无历史版本</td>
                `;
            tbody.appendChild(row);
            return;
        }

        historyVersions.forEach(version => {
            const row = document.createElement('tr');
            const isLatest = version.history_id === Math.max(...historyVersions.map(v => v.history_id));
            const latestBadge = isLatest ? '<span class="badge badge-primary">最新</span>' : '';

            row.innerHTML = `
                    <td>${version.history_id} ${latestBadge}</td>
                    <td class="problem-desc">${(version.problem || '').substring(0, 50)}${(version.problem || '').length > 50 ? '...' : ''}</td>
                    <td>${normalizeStatus(version.current_status)}</td>
                    <td>${version.modifier || version.tester || ''}</td>
                    <td>${version.modify_at ? new Date(version.modify_at).toLocaleString('zh-CN') : (version.created_at ? new Date(version.created_at).toLocaleString('zh-CN') : '')}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showProblemDetail(${version.id})">查看详情</button>
                    </td>
                `;
            tbody.appendChild(row);
        });
    }

    // ==================== 购物车/收藏夹功能 ====================

    // 全选/取消全选表格行
    function toggleSelectAllTableRows() {
        const selectAllCheckbox = document.getElementById('selectAllTableRows');
        const rowCheckboxes = document.querySelectorAll('.table-row-checkbox');

        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        // 更新加入收藏夹按钮的文本
        updateAddToCartButtonText();
        
        // 更新行的选中样式
        updateTableRowSelectionStyles();
    }

    // 获取选中的表格行
    function getSelectedTableRows() {
        const selectedCheckboxes = document.querySelectorAll('.table-row-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
        return allData.filter(item => selectedIds.includes(item.id));
    }

    // 获取选中的行ID（不依赖allData变量）
    function getSelectedRowIds() {
        const selectedCheckboxes = document.querySelectorAll('.table-row-checkbox:checked');
        return Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
    }

    // 更新加入收藏夹按钮文本
    function updateAddToCartButtonText() {
        const selectedCount = document.querySelectorAll('.table-row-checkbox:checked').length;
        const addToCartBtn = document.getElementById('addToCartBtn');
        
        if (selectedCount > 0) {
            addToCartBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> 加入收藏夹 (${selectedCount})`;
        } else {
            addToCartBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> 加入收藏夹`;
        }
    }

    // 清空表格选择
    function clearTableSelection() {
        const selectAllCheckbox = document.getElementById('selectAllTableRows');
        const rowCheckboxes = document.querySelectorAll('.table-row-checkbox');
        
        selectAllCheckbox.checked = false;
        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateAddToCartButtonText();
        
        // 更新行的选中样式
        updateTableRowSelectionStyles();
    }

    // 监听单个复选框变化
    function handleTableRowCheckboxChange() {
        const selectAllCheckbox = document.getElementById('selectAllTableRows');
        const rowCheckboxes = document.querySelectorAll('.table-row-checkbox');
        const checkedCount = document.querySelectorAll('.table-row-checkbox:checked').length;
        
        // 更新全选复选框状态
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === rowCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
        
        // 更新按钮文本
        updateAddToCartButtonText();
        
        // 更新行的选中样式
        updateTableRowSelectionStyles();
    }

    // 更新表格行选中样式
    function updateTableRowSelectionStyles() {
        const rowCheckboxes = document.querySelectorAll('.table-row-checkbox');
        
        rowCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                row.classList.add('table-row-selected');
            } else {
                row.classList.remove('table-row-selected');
            }
        });
    }

    // 加入收藏夹
    function addToCart() {
        // 获取选中的行ID
        const selectedIds = getSelectedRowIds();
        
        if (selectedIds.length === 0) {
            alert('请先选择要加入收藏夹的数据行！');
            return;
        }

        // 从当前页数据中获取选中的行（如果可能的话）
        const selectedRows = getSelectedTableRows();
        
        // 如果当前页没有完整数据，则从allData中获取
        if (selectedRows.length === 0) {
            // 尝试从allData中获取
            const selectedCheckboxes = document.querySelectorAll('.table-row-checkbox:checked');
            const selectedIdsFromCheckboxes = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
            const rowsFromAllData = allData.filter(item => selectedIdsFromCheckboxes.includes(item.id));
            
            if (rowsFromAllData.length > 0) {
                // 使用从allData获取的数据
                addToCartWithData(rowsFromAllData);
            } else {
                // 如果仍然没有数据，提示用户
                alert('无法获取选中数据的完整信息，请确保数据已加载完成后再试！');
                return;
            }
        } else {
            // 使用从当前页获取的数据
            addToCartWithData(selectedRows);
        }
    }

    // 使用数据添加到收藏夹的辅助函数
    function addToCartWithData(selectedRows) {
        // 获取当前筛选条件
        const filters = getCurrentFilters();
        const filterDescription = generateFilterDescription(filters);

        // 创建收藏夹项目
        const cartItem = {
            id: Date.now(), // 使用时间戳作为唯一ID
            filters: filters,
            data: [...selectedRows], // 只添加选中的行
            dataCount: selectedRows.length,
            filterDescription: filterDescription,
            saveTime: new Date().toLocaleString('zh-CN'),
            user: currentUser
        };

        // 添加到收藏夹
        cartItems.push(cartItem);

        // 保存到本地存储
        saveCartToStorage();

        // 更新收藏夹计数
        updateCartCount();

        // 清空选择
        clearTableSelection();

        alert(`已成功将 ${selectedRows.length} 条数据加入收藏夹！`);
    }

    // 获取当前筛选条件
    function getCurrentFilters() {
        return {
            majorCode: document.getElementById('majorCodeFilter').value,
            minorCode: document.getElementById('minorCodeFilter').value,
            projectPhase: document.getElementById('projectPhaseFilter').value,
            version: document.getElementById('versionFilter').value,
            supplier: document.getElementById('supplierFilter').value,
            problemStatus: document.getElementById('problemStatusFilter').value,
            group: document.getElementById('groupFilter').value,
            category: document.getElementById('categoryFilter').value,
            dataSource: document.getElementById('dataSourceFilter').value,
            dqeResponsible: document.getElementById('dqeResponsibleFilter').value,
            testStartDate: document.getElementById('testStartDateFilter').value,
            testEndDate: document.getElementById('testEndDateFilter').value
        };
    }

    // 生成筛选条件描述
    function generateFilterDescription(filters) {
        const descriptions = [];

        if (filters.majorCode) descriptions.push(`大编码: ${filters.majorCode}`);
        if (filters.minorCode) descriptions.push(`小编码: ${filters.minorCode}`);
        if (filters.projectPhase) descriptions.push(`项目阶段: ${filters.projectPhase}`);
        if (filters.version) descriptions.push(`版本: ${filters.version}`);
        if (filters.supplier) descriptions.push(`供应商: ${filters.supplier}`);
        if (filters.problemStatus) descriptions.push(`问题状态: ${filters.problemStatus}`);
        if (filters.group) descriptions.push(`组别: ${filters.group}`);
        if (filters.category) descriptions.push(`品类: ${filters.category}`);
        if (filters.dataSource) descriptions.push(`数据来源: ${filters.dataSource}`);
        if (filters.dqeResponsible) descriptions.push(`DQE责任人: ${filters.dqeResponsible}`);
        if (filters.testStartDate) descriptions.push(`测试开始: ${filters.testStartDate}`);
        if (filters.testEndDate) descriptions.push(`测试结束: ${filters.testEndDate}`);

        return descriptions.length > 0 ? descriptions.join(', ') : '无条件筛选';
    }

    // 初始化过滤器建议功能
    function initFilterSuggestions() {
        console.log('🎯 初始化过滤器建议功能');
        
        // 为过滤器输入框添加事件监听器
        const filterConfigs = [
            { id: 'majorCodeFilter', field: 'majorCode' },
            { id: 'minorCodeFilter', field: 'minorCode' },
            { id: 'projectPhaseFilter', field: 'projectPhase' },
            { id: 'versionFilter', field: 'version' },
            { id: 'supplierFilter', field: 'supplier' },
            { id: 'problemStatusFilter', field: 'problemStatus' },
            { id: 'groupFilter', field: 'group' },
            { id: 'categoryFilter', field: 'category' },
            { id: 'dataSourceFilter', field: 'dataSource' },
            { id: 'dqeResponsibleFilter', field: 'dqeResponsible' }
        ];
        
        filterConfigs.forEach(config => {
            const input = document.getElementById(config.id);
            if (!input) {
                console.log('❌ 找不到输入框:', config.id);
                return;
            }
            
            console.log('✅ 为输入框添加事件监听器:', config.id);
            
            // 键盘事件处理
            input._keydownHandler = function(e) {
                const dropdown = document.getElementById(config.id + 'Suggestions');
                const items = dropdown.querySelectorAll('.suggestion-item');
                const highlighted = dropdown.querySelector('.suggestion-item.highlighted');
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlighted) {
                        input.value = highlighted.textContent;
                        hideSuggestions(dropdown);
                        searchReviews();
                    } else {
                        searchReviews();
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (highlighted) {
                        highlighted.classList.remove('highlighted');
                        const next = highlighted.nextElementSibling;
                        if (next) {
                            next.classList.add('highlighted');
                        } else {
                            items[0]?.classList.add('highlighted');
                        }
                    } else if (items.length > 0) {
                        items[0].classList.add('highlighted');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (highlighted) {
                        highlighted.classList.remove('highlighted');
                        const prev = highlighted.previousElementSibling;
                        if (prev) {
                            prev.classList.add('highlighted');
                        } else {
                            items[items.length - 1]?.classList.add('highlighted');
                        }
                    } else if (items.length > 0) {
                        items[items.length - 1].classList.add('highlighted');
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions(dropdown);
                }
            };

            // 输入事件 - 显示建议（防抖处理）
            input._inputHandler = function(e) {
                const query = e.target.value.trim();
                console.log('⌨️ 输入事件:', config.id, '查询:', query);
                
                // 清除之前的定时器
                if (input._debounceTimer) {
                    clearTimeout(input._debounceTimer);
                }
                
                // 设置防抖延迟，用户停止输入500ms后才开始搜索
                input._debounceTimer = setTimeout(() => {
                    const suggestions = filterSuggestions(config.field, query);
                    console.log('📋 建议数量:', suggestions.length);
                    showSuggestions(config.id, suggestions);
                }, 500);
            };

            // 获得焦点事件 - 显示所有建议（防抖处理）
            input._focusHandler = function(e) {
                const query = e.target.value.trim();
                
                // 清除之前的定时器
                if (input._debounceTimer) {
                    clearTimeout(input._debounceTimer);
                }
                
                // 获得焦点时立即显示建议，但也要防抖
                input._debounceTimer = setTimeout(() => {
                    const suggestions = filterSuggestions(config.field, query);
                    showSuggestions(config.id, suggestions);
                }, 100);
            };

            // 失去焦点事件 - 延迟隐藏建议
            input._blurHandler = function(e) {
                // 清除防抖定时器
                if (input._debounceTimer) {
                    clearTimeout(input._debounceTimer);
                }
                
                setTimeout(() => {
                    const dropdown = document.getElementById(config.id + 'Suggestions');
                    hideSuggestions(dropdown);
                }, 200);
            };

            // 绑定事件监听器
            input.addEventListener('keydown', input._keydownHandler);
            input.addEventListener('input', input._inputHandler);
            input.addEventListener('focus', input._focusHandler);
            input.addEventListener('blur', input._blurHandler);
        });
        
        console.log('✅ 过滤器建议功能初始化完成');
    }

    // 显示建议下拉框
    function showSuggestions(inputId, suggestions) {
        console.log('🎯 显示建议:', inputId, '建议数量:', suggestions.length);
        const dropdown = document.getElementById(inputId + 'Suggestions');
        if (!dropdown) {
            console.log('❌ 找不到下拉框:', inputId + 'Suggestions');
            return;
        }
        console.log('✅ 找到下拉框');

        dropdown.innerHTML = '';
        
        if (suggestions.length === 0) {
            console.log('📭 没有建议，隐藏下拉框');
            dropdown.style.display = 'none';
            return;
        }

        suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = suggestion;
            item.addEventListener('click', () => {
                document.getElementById(inputId).value = suggestion;
                hideSuggestions(dropdown);
                searchReviews();
            });
            dropdown.appendChild(item);
        });

        dropdown.classList.add('show');
        console.log('✅ 下拉框已显示');
    }

    // 隐藏建议下拉框
    function hideSuggestions(dropdown) {
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }

    // 过滤建议
    function filterSuggestions(field, query) {
        console.log('🔍 过滤建议:', field, '查询:', query);
        
        // 问题状态过滤器的特殊处理
        if (field === 'problemStatus') {
            const statusOptions = ['open', 'closed', 'follow'];
            if (!query || query.trim() === '') {
                return statusOptions;
            }
            
            const filtered = statusOptions.filter(option => 
                option.toLowerCase().includes(query.toLowerCase())
            );
            
            return filtered.slice(0, 10);
        }
        
        const allValues = getUniqueValues(field);
        if (!query || query.trim() === '') {
            return allValues.slice(0, 10); // 限制显示前10个
        }
        
        const filtered = allValues.filter(value => 
            value.toLowerCase().includes(query.toLowerCase())
        );
        
        return filtered.slice(0, 10); // 限制显示前10个
    }

    // 获取字段的唯一值
    function getUniqueValues(field) {
        // 优先使用全部搜索数据，如果没有则使用当前页数据
        const dataSource = allSearchData.length > 0 ? allSearchData : allData;
        
        if (!dataSource || dataSource.length === 0) {
            console.log('⚠️ 没有可用的数据源用于建议功能');
            return [];
        }
        
        const values = dataSource.map(item => item[field]).filter(value => value && value.trim() !== '');
        const uniqueValues = [...new Set(values)];
        console.log(`📊 字段 ${field} 的唯一值数量:`, uniqueValues.length, '数据源:', allSearchData.length > 0 ? '全部搜索数据' : '当前页数据');
        return uniqueValues.sort();
    }

    // 添加全局点击事件，隐藏所有建议框
    document.addEventListener('click', function(e) {
        // 检查点击是否在建议框或输入框内
        const isInSuggestions = e.target.closest('.input-with-suggestions');
        
        if (!isInSuggestions) {
            // 隐藏所有建议框
            document.querySelectorAll('.suggestions-dropdown').forEach(suggestions => {
                hideSuggestions(suggestions);
            });
        }
    });

    // 显示收藏夹模态框
    function showCartModal() {
        renderCartItems();
        document.getElementById('cartModal').style.display = 'block';
    }

    // 渲染收藏夹项目
    function renderCartItems() {
        const tbody = document.getElementById('cartItemsTableBody');
        tbody.innerHTML = '';

        if (cartItems.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #666;">收藏夹为空</td>
                `;
            tbody.appendChild(row);
            return;
        }

        cartItems.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>
                        <input type="checkbox" class="cart-item-checkbox" data-item-id="${item.id}" onchange="updateSelectAllStatus()">
                    </td>
                    <td>${index + 1}</td>
                    <td class="filter-desc" title="${item.filterDescription}">${item.filterDescription.length > 50 ? item.filterDescription.substring(0, 50) + '...' : item.filterDescription}</td>
                    <td>${item.dataCount}</td>
                    <td>${item.saveTime}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeCartItem(${item.id})">删除</button>
                    </td>
                `;
            tbody.appendChild(row);
        });
    }

    // 全选/取消全选收藏夹项目
    function toggleSelectAllCartItems() {
        const selectAllCheckbox = document.getElementById('selectAllCartItems');
        const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');

        itemCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    // 更新全选状态
    function updateSelectAllStatus() {
        const selectAllCheckbox = document.getElementById('selectAllCartItems');
        const itemCheckboxes = document.querySelectorAll('.cart-item-checkbox');
        const checkedCount = document.querySelectorAll('.cart-item-checkbox:checked').length;

        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === itemCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // 获取选中的收藏夹项目
    function getSelectedCartItems() {
        const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
        const selectedItemIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.dataset.itemId));
        return cartItems.filter(item => selectedItemIds.includes(item.id));
    }

    // 收藏夹管理模态框的 查看收藏夹项目
    function viewCartItem(itemId) {
        const item = cartItems.find(i => i.id === itemId);
        if (!item) return;

        // 显示收藏夹详情模态框
        showCartDetailModal(item);
    }

    // 显示收藏夹详情模态框
    function showCartDetailModal(item) {
        // 设置基本信息
        document.getElementById('cartDetailFilter').textContent = item.filterDescription;
        document.getElementById('cartDetailCount').textContent = item.dataCount;
        document.getElementById('cartDetailTime').textContent = item.saveTime;

        // 渲染详情表格
        renderCartDetailTable(item.data);

        // 保存当前查看的收藏夹项目，用于重新搜索
        window.currentCartItem = item;

        // 显示模态框
        document.getElementById('cartDetailModal').style.display = 'block';
    }

    // 应用收藏夹中的筛选条件重新搜索
    function applyCartFilters() {
        if (!window.currentCartItem) {
            alert('没有可应用的筛选条件！');
            return;
        }

        const filters = window.currentCartItem.filters;
        
        // 清空所有筛选条件
        resetFilters();
        
        // 应用收藏夹中的筛选条件
        if (filters.majorCode) document.getElementById('majorCodeFilter').value = filters.majorCode;
        if (filters.minorCode) document.getElementById('minorCodeFilter').value = filters.minorCode;
        if (filters.projectPhase) document.getElementById('projectPhaseFilter').value = filters.projectPhase;
        if (filters.version) document.getElementById('versionFilter').value = filters.version;
        if (filters.supplier) document.getElementById('supplierFilter').value = filters.supplier;
        if (filters.problemStatus) document.getElementById('problemStatusFilter').value = filters.problemStatus;
        if (filters.group) document.getElementById('groupFilter').value = filters.group;
        if (filters.category) document.getElementById('categoryFilter').value = filters.category;
        if (filters.dataSource) document.getElementById('dataSourceFilter').value = filters.dataSource;
        if (filters.dqeResponsible) document.getElementById('dqeResponsibleFilter').value = filters.dqeResponsible;
        if (filters.testStartDate) document.getElementById('testStartDateFilter').value = filters.testStartDate;
        if (filters.testEndDate) document.getElementById('testEndDateFilter').value = filters.testEndDate;

        // 关闭收藏夹详情模态框
        closeSpecificModal('cartDetailModal');
        
        // 关闭收藏夹模态框
        closeSpecificModal('cartModal');
        
        // 执行搜索
        searchReviews();
        
        // 显示成功提示
        showToast('已应用收藏夹中的筛选条件并重新搜索', 'success');
    }

    // 渲染收藏夹详情表格
    function renderCartDetailTable(data) {
        const tbody = document.getElementById('cartDetailTableBody');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td colspan="19" style="text-align: center; color: #666;">暂无数据</td>
                `;
            tbody.appendChild(row);
            return;
        }

        data.forEach(problem => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${problem.id || ''}</td>
                    <td>${problem.full_model || ''}</td>
                    <td>${problem.big_species || ''}</td>
                    <td>${problem.small_species || ''}</td>
                    <td>${problem.sample_stage || ''}</td>
                    <td>${problem.version || ''}</td>
                    <td>${problem.test_platform || ''}</td>
                    <td>${problem.test_device || ''}</td>
                    <td>${problem.other_device || ''}</td>
                    <td class="problem-desc" title="${problem.problem || ''}">${problem.problem || ''}</td>
                    <td>${problem.problemCategory || ''}</td>
                    <td>${problem.defect_level || ''}</td>
                    <td>${problem.current_status || ''}</td>
                    <td>${problem.tester || ''}</td>
                    <td>${problem.dqe || ''}</td>
                    <td>${problem.responsibleDepartment || ''}</td>
                    <td>${problem.green_union_dqe || ''}</td>
                    <td>${problem.green_union_rd || ''}</td>
                    <td>${problem.created_at || ''}</td>
                `;
            tbody.appendChild(row);
        });
    }

    // 删除收藏夹项目
    function removeCartItem(itemId) {
        if (confirm('确定要删除这个收藏夹项目吗？')) {
            cartItems = cartItems.filter(i => i.id !== itemId);
            saveCartToStorage();
            updateCartCount();
            renderCartItems();
        }
    }

    // 清空收藏夹
    function clearCart() {
        if (confirm('确定要清空整个收藏夹吗？此操作不可恢复！')) {
            cartItems = [];
            mergedData = [];
            saveCartToStorage();
            updateCartCount();
            renderCartItems();
            hideMergedData();
            alert('收藏夹已清空');
        }
    }

    // 合并收藏夹数据
    function mergeCartData() {
        const selectedItems = getSelectedCartItems();

        if (selectedItems.length === 0) {
            showToast('请先选择要合并的收藏夹项目！', 'warning');
            return;
        }

        // console.log('选中的收藏夹项目:', selectedItems);

        // 合并选中的收藏夹项目的数据
        mergedData = [];
        const idSet = new Set(); // 用于去重

        selectedItems.forEach(item => {
            // console.log(`处理收藏夹项目 ${item.id}:`, item.data.length, '条数据');
            item.data.forEach(problem => {
                if (!idSet.has(problem.id)) {
                    idSet.add(problem.id);
                    mergedData.push(problem);
                }
            });
        });

        // console.log('合并后的数据:', mergedData.length, '条');

        // 显示合并数据，传递选中的项目数量
        showMergedData(selectedItems.length);
        showToast(`已合并 ${selectedItems.length} 个收藏夹项目，共 ${mergedData.length} 条数据`, 'success');
    }

    // 显示合并数据
    function showMergedData(selectedCount = 0) {
        const section = document.getElementById('mergedDataSection');
        const totalCount = mergedData.length;
        const uniqueCount = mergedData.length; // 已经去重了

        // console.log('显示合并数据:', {
        //     selectedCount: selectedCount,
        //     totalCount: totalCount,
        //     mergedDataLength: mergedData.length
        // });

        // 先隐藏，然后显示，确保刷新
        section.style.display = 'none';

        // 更新统计信息，显示选中的项目数量
        const statsElement = document.querySelector('.merged-stats');
        if (statsElement) {
            statsElement.innerHTML = `
                    <span>选中项目: <strong>${selectedCount}</strong></span>
                    <span>总数据量: <strong>${totalCount}</strong></span>
                    <span>去重后: <strong>${uniqueCount}</strong></span>
                `;
        }

        // 渲染合并数据表格
        renderMergedDataTable();

        // 强制重新显示
        setTimeout(() => {
            section.style.display = 'block';
        }, 10);
    }

    // 隐藏合并数据
    function hideMergedData() {
        document.getElementById('mergedDataSection').style.display = 'none';
    }

    // 渲染合并数据表格
    function renderMergedDataTable() {
        const tbody = document.getElementById('mergedDataTableBody');
        tbody.innerHTML = '';

        // console.log('渲染合并数据表格，数据条数:', mergedData.length);

        if (mergedData.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td colspan="29" style="text-align: center; color: #666;">没有数据</td>
                `;
            tbody.appendChild(row);
            return;
        }

        mergedData.forEach((review, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td data-key="id">${review.id || '-'}</td>
                    <td data-key="group">${review.group || '-'}</td>
                    <td data-key="category">${review.category || '-'}</td>
                    <td data-key="testDate">${review.testDate || '-'}</td>
                    <td data-key="majorCode">${review.majorCode || '-'}</td>
                    <td data-key="minorCode">${review.minorCode || '-'}</td>
                    <td data-key="projectPhase">${review.projectPhase || '-'}</td>
                    <td data-key="version">${review.version || '-'}</td>
                    <td data-key="problemProcess" class="problem-desc" title="${review.problemProcess || ''}">${(review.problemProcess || '').substring(0, 20)}${(review.problemProcess || '').length > 20 ? '...' : ''}</td>
                    <td data-key="problemLevel"><span class="status-badge status-${review.problemLevel?.toLowerCase() || ''}">${review.problemLevel || '-'}</span></td>
                    <td data-key="developmentMethod" class="problem-desc" title="${review.developmentMethod || ''}">${(review.developmentMethod || '').substring(0, 20)}${(review.developmentMethod || '').length > 20 ? '...' : ''}</td>
                    <td data-key="supplier" class="problem-desc" title="${review.supplier || ''}">${(review.supplier || '').substring(0, 20)}${(review.supplier || '').length > 20 ? '...' : ''}</td>
                    <td data-key="solutionProvider" class="problem-desc" title="${review.solutionProvider || ''}">${(review.solutionProvider || '').substring(0, 20)}${(review.solutionProvider || '').length > 20 ? '...' : ''}</td>
                    <td data-key="problemPoint" class="problem-desc" title="${review.problemPoint || ''}">${(review.problemPoint || '').substring(0, 30)}${(review.problemPoint || '').length > 30 ? '...' : ''}</td>
                    <td data-key="problemReason" class="problem-desc" title="${review.problemReason || ''}">${(review.problemReason || '').substring(0, 30)}${(review.problemReason || '').length > 30 ? '...' : ''}</td>
                    <td data-key="improvementMeasures" class="problem-desc" title="${review.improvementMeasures || ''}">${(review.improvementMeasures || '').substring(0, 30)}${(review.improvementMeasures || '').length > 30 ? '...' : ''}</td>
                    <td data-key="isPreventable">${review.isPreventable || '-'}</td>
                    <td data-key="responsibleDepartment">${review.responsibleDepartment || '-'}</td>
                    <td data-key="dqeResponsible">${review.dqeResponsible || '-'}</td>
                    <td data-key="problemStatus"><span class="status-badge status-${review.problemStatus?.toLowerCase().replace(' ', '') || ''}">${review.problemStatus || '-'}</span></td>
                    <td data-key="plannedCompletionTime">${formatDate(review.plannedCompletionTime)}</td>
                    <td data-key="actualCompletionTime">${formatDate(review.actualCompletionTime)}</td>
                    <td data-key="delayDays">${review.delayDays || '-'}</td>
                    <td data-key="problemTag1" class="problem-desc" title="${review.problemTag1 || ''}">${(review.problemTag1 || '').substring(0, 20)}${(review.problemTag1 || '').length > 20 ? '...' : ''}</td>
                    <td data-key="problemTag2" class="problem-desc" title="${review.problemTag2 || ''}">${(review.problemTag2 || '').substring(0, 20)}${(review.problemTag2 || '').length > 20 ? '...' : ''}</td>
                    <td data-key="preventionNotes" class="problem-desc" title="${review.preventionNotes || ''}">${(review.preventionNotes || '').substring(0, 30)}${(review.preventionNotes || '').length > 30 ? '...' : ''}</td>
                    <td data-key="dataSource">${review.dataSource || '-'}</td>
                    <td data-key="createdTime">${review.createdTime ? new Date(review.createdTime).toLocaleString('zh-CN') : '-'}</td>
                    <td data-key="updatedTime">${review.updatedTime ? new Date(review.updatedTime).toLocaleString('zh-CN') : '-'}</td>
                `;
            tbody.appendChild(row);
        });

        // console.log('合并数据表格渲染完成，实际渲染行数:', tbody.children.length);
        
        // 应用列可见性设置
        applyColumnVisibility();
    }

    // ==================== 图表注释功能 ====================
    let annotationCounter = { 1: 0, 2: 0, merged: 0 };

    // 添加注释
    function addAnnotation(chartId) {
        const overlayId = chartId === 'merged' ? 'annotationOverlayMerged' : `annotationOverlay${chartId}`;
        const overlay = document.getElementById(overlayId);
        if (!overlay) return;

        // 激活覆盖层
        overlay.classList.add('active');

        // 创建注释元素
        annotationCounter[chartId] = (annotationCounter[chartId] || 0) + 1;
        const annotationId = `annotation-${chartId}-${annotationCounter[chartId]}`;
        const annotation = document.createElement('div');
        annotation.id = annotationId;
        annotation.className = 'chart-annotation';
        annotation.style.left = '50px';
        annotation.style.top = '50px';
        annotation.style.width = '50px';
        annotation.style.height = '60px';

        // 创建删除按钮
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'chart-annotation-delete';
        deleteBtn.innerHTML = '×';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            annotation.remove();
        };

        // 创建拖拽手柄按钮
        const dragHandle = document.createElement('button');
        dragHandle.className = 'chart-annotation-drag';
        dragHandle.title = '拖拽移动';
        
        // 拖拽手柄专用的拖拽变量
        let isDraggingByHandle = false;
        let dragStartX = undefined, dragStartY = undefined, dragStartLeft = 0, dragStartTop = 0;
        
        dragHandle.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            e.preventDefault();
            // 通过手柄拖拽时立即开始拖拽，不需要阈值判断
            isDraggingByHandle = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            dragStartLeft = parseInt(annotation.style.left) || 0;
            dragStartTop = parseInt(annotation.style.top) || 0;
            dragHandle.style.cursor = 'move';
        });
        
        // 处理通过手柄的拖拽移动
        const handleDragMove = (e) => {
            if (!isDraggingByHandle) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            const container = overlay.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            let newLeft = dragStartLeft + deltaX;
            let newTop = dragStartTop + deltaY;
            
            // 限制在容器内
            const annotationRect = annotation.getBoundingClientRect();
            newLeft = Math.max(0, Math.min(newLeft, containerRect.width - annotationRect.width));
            newTop = Math.max(0, Math.min(newTop, containerRect.height - annotationRect.height));
            
            annotation.style.left = newLeft + 'px';
            annotation.style.top = newTop + 'px';
            e.preventDefault();
        };
        
        const handleDragEnd = (e) => {
            if (isDraggingByHandle) {
                isDraggingByHandle = false;
                dragHandle.style.cursor = 'move';
                dragStartX = undefined;
                dragStartY = undefined;
                e.preventDefault();
                e.stopPropagation();
            }
        };
        
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);

        // 创建内容区域
        const content = document.createElement('textarea');
        content.className = 'chart-annotation-content';
        content.placeholder = '点击输入注释...';
        content.value = '';
        
        // 确保点击输入框时能正常获取焦点
        content.addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止事件冒泡，避免触发拖拽
            content.focus();
        });
        content.addEventListener('mousedown', (e) => {
            e.stopPropagation(); // 阻止事件冒泡，避免触发拖拽
        });

        // 创建调整大小手柄
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'chart-annotation-resize';

        annotation.appendChild(dragHandle);
        annotation.appendChild(deleteBtn);
        annotation.appendChild(content);
        annotation.appendChild(resizeHandle);
        overlay.appendChild(annotation);

        // 实现拖拽功能
        let isDragging = false;
        let hasMoved = false; // 标记是否真正发生了移动
        let startX = undefined, startY = undefined, startLeft = 0, startTop = 0;
        const DRAG_THRESHOLD = 5; // 拖拽阈值，超过这个距离才认为是拖拽

        annotation.addEventListener('mousedown', (e) => {
            // 如果点击的是调整大小手柄，不触发拖拽
            if (e.target === resizeHandle) return;
            // 如果点击的是删除按钮，不触发拖拽
            if (e.target === deleteBtn) return;
            // 如果点击的是拖拽手柄，不触发原有拖拽（由拖拽手柄自己处理）
            if (e.target === dragHandle) return;
            // 如果点击的是输入框，不触发拖拽，允许正常输入
            if (e.target === content || e.target.tagName === 'TEXTAREA') return;
            
            hasMoved = false;
            isDragging = false;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(annotation.style.left) || 0;
            startTop = parseInt(annotation.style.top) || 0;
            annotation.style.cursor = 'move';
            // 不立即阻止默认行为，等待判断是否真的拖拽
        });

        document.addEventListener('mousemove', (e) => {
            if (startX === undefined || startY === undefined) return;
            
            if (!isDragging) {
                // 检查是否超过拖拽阈值
                const deltaX = Math.abs(e.clientX - startX);
                const deltaY = Math.abs(e.clientY - startY);
                
                if (deltaX > DRAG_THRESHOLD || deltaY > DRAG_THRESHOLD) {
                    // 超过阈值，开始拖拽
                    isDragging = true;
                    hasMoved = true;
                    e.preventDefault(); // 现在才阻止默认行为
                }
            }
            
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const container = overlay.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            let newLeft = startLeft + deltaX;
            let newTop = startTop + deltaY;
            
            // 限制在容器内
            const annotationRect = annotation.getBoundingClientRect();
            newLeft = Math.max(0, Math.min(newLeft, containerRect.width - annotationRect.width));
            newTop = Math.max(0, Math.min(newTop, containerRect.height - annotationRect.height));
            
            annotation.style.left = newLeft + 'px';
            annotation.style.top = newTop + 'px';
        });

        document.addEventListener('mouseup', (e) => {
            if (isDragging || hasMoved) {
                // 如果发生了拖拽，阻止后续的点击事件
                if (hasMoved) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
            // 重置所有状态
            isDragging = false;
            hasMoved = false;
            annotation.style.cursor = 'default';
            startX = undefined;
            startY = undefined;
        });

        // 实现调整大小功能
        let isResizing = false;
        let resizeStartX, resizeStartY, resizeStartWidth, resizeStartHeight;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizeStartX = e.clientX;
            resizeStartY = e.clientY;
            resizeStartWidth = parseInt(annotation.style.width) || 150;
            resizeStartHeight = parseInt(annotation.style.height) || 80;
            e.stopPropagation();
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const deltaX = e.clientX - resizeStartX;
            const deltaY = e.clientY - resizeStartY;
            const container = overlay.parentElement;
            const containerRect = container.getBoundingClientRect();
            const annotationRect = annotation.getBoundingClientRect();
            
            let newWidth = resizeStartWidth + deltaX;
            let newHeight = resizeStartHeight + deltaY;
            
            // 限制最小尺寸
            newWidth = Math.max(30, newWidth);
            newHeight = Math.max(40, newHeight);
            
            // 限制在容器内
            const maxWidth = containerRect.width - (annotationRect.left - containerRect.left);
            const maxHeight = containerRect.height - (annotationRect.top - containerRect.top);
            newWidth = Math.min(newWidth, maxWidth);
            newHeight = Math.min(newHeight, maxHeight);
            
            annotation.style.width = newWidth + 'px';
            annotation.style.height = newHeight + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
            }
        });

        // 聚焦到内容区域
        setTimeout(() => {
            content.focus();
        }, 100);
    }

    // ==================== 合并数据图表功能 ====================

    // 生成颜色数组
    function generateColors(count) {
        const colors = [
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 99, 132, 0.6)',
            'rgba(255, 205, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(153, 102, 255, 0.6)',
            'rgba(255, 159, 64, 0.6)',
            'rgba(199, 199, 199, 0.6)',
            'rgba(83, 102, 255, 0.6)',
            'rgba(255, 99, 255, 0.6)',
            'rgba(99, 255, 132, 0.6)',
            'rgba(255, 132, 99, 0.6)',
            'rgba(132, 99, 255, 0.6)',
            'rgba(99, 255, 255, 0.6)',
            'rgba(255, 255, 99, 0.6)',
            'rgba(255, 99, 99, 0.6)'
        ];
        
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(colors[i % colors.length]);
        }
        return result;
    }

    // 显示合并数据图表
    function showMergedChart() {
        const selectedItems = getSelectedCartItems();

        if (selectedItems.length === 0) {
            showToast('请先选择要合并的收藏夹项目！', 'warning');
            return;
        }

        // 合并选中的收藏夹项目的数据
        mergedData = [];
        const idSet = new Set(); // 用于去重

        selectedItems.forEach(item => {
            item.data.forEach(problem => {
                if (!idSet.has(problem.id)) {
                    idSet.add(problem.id);
                    mergedData.push(problem);
                }
            });
        });

        if (mergedData.length === 0) {
            showToast('没有数据可以绘制图表！', 'warning');
            return;
        }

        // 显示合并数据区域
        showMergedData(selectedItems.length);
        
        // 显示图表控制区域
        const chartControls = document.querySelector('.merged-chart-controls');
        if (chartControls) {
            chartControls.style.display = 'block';
        }

        showToast(`已准备 ${mergedData.length} 条数据用于图表绘制`, 'success');
    }

    // 切换合并数据图表类型
    function switchMergedChartType(type) {
        mergedChartType = type;
        
        // 更新按钮状态
        const chartTypeButtons = document.querySelectorAll('.merged-chart-controls .chart-type-btn');
        chartTypeButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.type === type) {
                btn.classList.add('active');
            }
        });
        
        // 如果已经有图表，重新生成
        if (mergedChart && mergedData.length > 0) {
            const groupField = document.getElementById('mergedChartField').value;
            if (groupField) {
                generateMergedChart();
            }
        }
    }

    // 生成合并数据图表
    function generateMergedChart() {
        const groupField = document.getElementById('mergedChartField').value;

        if (!groupField) {
            showToast('请选择分组字段！', 'warning');
            return;
        }

        if (mergedData.length === 0) {
            showToast('没有数据可以绘制图表！', 'warning');
            return;
        }

        try {
            // 处理图表数据
            const chartData = processMergedChartData(mergedData, groupField, mergedChartType);
            
            // 创建图表
            createMergedChart(chartData, mergedChartType);
            
            // 显示图表容器
            const chartContainer = document.getElementById('mergedChartContainer');
            if (chartContainer) {
                chartContainer.style.display = 'block';
            }
            
            showToast('图表生成成功！', 'success');
        } catch (error) {
            console.error('生成合并数据图表失败:', error);
            showToast('生成图表失败: ' + error.message, 'error');
        }
    }

    // 处理合并数据图表数据 - 使用与主图表相同的逻辑
    function processMergedChartData(data, groupField, chartType) {
        console.log('处理合并数据图表数据:', {
            dataLength: data.length,
            groupField: groupField,
            chartType: chartType
        });

        // 使用与主图表完全相同的数据处理逻辑，默认不排序
        return processGroupedDataForChart(data, groupField, chartType, 'none');
    }

    // 创建合并数据图表 - 使用与主图表完全相同的配置
    function createMergedChart(data, type) {
        console.log('🎨 createMergedChart函数被调用:', {
            data: data,
            type: type,
            labels: data.labels,
            datasetsCount: data.datasets ? data.datasets.length : 0
        });

        const ctx = document.getElementById('mergedDataChart').getContext('2d');
        
        if (!ctx) {
            console.error('❌ 无法获取canvas上下文');
            return;
        }

        console.log('✅ Canvas上下文获取成功');

        // 销毁现有图表
        if (mergedChart) {
            console.log('🗑️ 销毁现有合并图表');
            mergedChart.destroy();
            mergedChart = null;
        }

        // 根据图表类型调整数据格式
        let chartData;
        if (type === 'pie') {
            chartData = {
                labels: data.labels,
                datasets: data.datasets
            };
        } else {
            // 柱状图和折线图需要特殊处理，因为有两个Y轴
            chartData = {
                labels: data.labels,
                datasets: data.datasets.map((dataset, index) => {
                    if (dataset.label === '关闭率(%)') {
                        return {
                            ...dataset,
                            yAxisID: 'y1'
                        };
                    } else {
                        return {
                            ...dataset,
                            yAxisID: 'y'
                        };
                    }
                })
            };
        }

        // 计算Y轴最大值（增加2/3的高度）
        let actualMaxYValue = 0; // 实际数据最大值（用于控制网格线）
        let actualMaxY1Value = 0; // 实际关闭率最大值（用于控制网格线）
        let maxYValue = 0;
        let maxY1Value = 0; // 关闭率（y1轴）的最大值
        if (type !== 'pie' && chartData.datasets) {
            chartData.datasets.forEach(dataset => {
                if (dataset.label === '关闭率(%)' || dataset.yAxisID === 'y1') {
                    // 计算关闭率的最大值
                    const datasetMax = Math.max(...(dataset.data || []).map(v => Number(v) || 0));
                    if (datasetMax > actualMaxY1Value) {
                        actualMaxY1Value = datasetMax;
                    }
                } else {
                    // 计算其他数据集的最大值
                    const datasetMax = Math.max(...(dataset.data || []).map(v => Number(v) || 0));
                    if (datasetMax > actualMaxYValue) {
                        actualMaxYValue = datasetMax;
                    }
                }
            });
            // 保存实际最大值用于网格线控制
            maxYValue = actualMaxYValue;
            maxY1Value = actualMaxY1Value;
            // 增加2/3的高度：maxYValue * (1 + 2/3) = maxYValue * 1.667...
            maxYValue = Math.ceil(maxYValue * 1.667);
            // 增加2/3的高度：maxY1Value * (1 + 2/3) = maxY1Value * 1.667...
            maxY1Value = Math.ceil(maxY1Value * 1.667);
            // 确保最小值为1，避免为0时显示问题
            if (maxYValue === 0) maxYValue = 1;
            // 关闭率最小值为100（因为关闭率通常不会超过100%）
            if (maxY1Value === 0) maxY1Value = 100;
            if (maxY1Value < 100) maxY1Value = 100;
        }

        const config = {
            type: type || 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1.5,
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: type === 'pie' ? 'left' : 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: '收藏夹合并数据图表',
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#333',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function(value, context) {
                            if (type === 'pie') {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return percentage + '%';
                            } else if (context.dataset.label === '关闭率(%)') {
                                return value + '%';
                            } else {
                                return value;
                            }
                        }
                    }
                },
                scales: type !== 'pie' ? {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        suggestedMax: maxYValue,
                        ticks: {
                            stepSize: 1
                        },
                        title: {
                            display: true,
                            text: '数量'
                        },
                        grid: {
                            color: function(context) {
                                // 如果刻度值大于实际数据最大值，则不显示网格线（返回透明色）
                                if (context.tick && context.tick.value > actualMaxYValue) {
                                    return 'transparent';
                                }
                                return 'rgba(0,0,0,0.1)';
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        suggestedMax: maxY1Value,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: '关闭率(%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                            color: function(context) {
                                // 如果刻度值大于实际数据最大值，则不显示网格线（返回透明色）
                                if (context.tick && context.tick.value > actualMaxY1Value) {
                                    return 'transparent';
                                }
                                return 'rgba(0,0,0,0.05)';
                            }
                        },
                    },
                    x: {
                        barPercentage: 0.7,
                        categoryPercentage: 0.4
                    }
                } : {}
            }
        };

        // 注册数据标签插件
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }

        mergedChart = new Chart(ctx, config);
        console.log('🎉 合并数据图表创建成功!', {
            chartType: mergedChart.config.type,
            dataPoints: mergedChart.data.datasets[0] ? mergedChart.data.datasets[0].data.length : 0
        });
    }

    // 导出收藏夹数据
    function exportCartData() {
        const selectedItems = getSelectedCartItems();

        if (selectedItems.length === 0) {
            showToast('请先选择要导出的收藏夹项目！', 'warning');
            return;
        }

        showLoading();

        // 合并选中的收藏夹项目的数据，提取ID列表
        const selectedIds = [];
        const idSet = new Set(); // 用于去重

        selectedItems.forEach(item => {
            item.data.forEach(problem => {
                if (!idSet.has(problem.id)) {
                    idSet.add(problem.id);
                    selectedIds.push(problem.id);
                }
            });
        });

        // 获取当前隐藏的列
        const hiddenColumns = getHiddenColumns();

        // 准备导出数据 - 使用与主导出功能相同的格式
        const exportData = {
            selectedIds: selectedIds,
            exportType: 'reviewResults',
            fileName: `收藏夹新品质量数据_${new Date().toISOString().slice(0, 10)}.xlsx`,
            hiddenColumns: hiddenColumns
        };

        fetch('/reviewResult/exportReviewResultsExcel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(exportData)
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('导出失败');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportData.fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast(`成功导出 ${selectedItems.length} 个收藏夹项目，共 ${selectedIds.length} 条记录！`, 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('导出时发生错误', 'error');
            })
            .finally(() => {
                hideLoading();
            });
    }

    // 更新收藏夹计数
    function updateCartCount() {
        const countElement = document.getElementById('cartCount');
        if (countElement) {
            countElement.textContent = cartItems.length;
        }
    }

    // 保存收藏夹到本地存储
    function saveCartToStorage() {
        try {
            localStorage.setItem('problemLibraryCart', JSON.stringify(cartItems));
        } catch (e) {
            console.error('保存收藏夹失败:', e);
        }
    }

    // 从本地存储加载收藏夹
    function loadCartFromStorage() {
        try {
            const stored = localStorage.getItem('problemLibraryCart');
            if (stored) {
                cartItems = JSON.parse(stored);
            }
        } catch (e) {
            console.error('加载收藏夹失败:', e);
            cartItems = [];
        }
    }

    // 设置图表排序
    // 设置图表排序 - 支持双图表
    function setChartSort(sortOrder, chartNumber) {
        console.log('设置图表排序:', sortOrder, '图表编号:', chartNumber);
        
        // 更新对应图表的排序状态
        if (chartNumber === 1) {
            chartSortOrder1 = sortOrder;
        } else if (chartNumber === 2) {
            chartSortOrder2 = sortOrder;
        }
        
        // 更新对应图表的按钮状态
        const ascBtnId = chartNumber === 1 ? 'sortAscBtn1' : 'sortAscBtn2';
        const descBtnId = chartNumber === 1 ? 'sortDescBtn1' : 'sortDescBtn2';
        const ascBtn = document.getElementById(ascBtnId);
        const descBtn = document.getElementById(descBtnId);
        
        // 重置所有按钮状态
        ascBtn.classList.remove('active', 'btn-primary');
        ascBtn.classList.add('btn-outline-secondary');
        descBtn.classList.remove('active', 'btn-primary');
        descBtn.classList.add('btn-outline-secondary');
        
        // 激活选中的按钮
        if (sortOrder === 'asc') {
            ascBtn.classList.remove('btn-outline-secondary');
            ascBtn.classList.add('btn-primary', 'active');
        } else if (sortOrder === 'desc') {
            descBtn.classList.remove('btn-outline-secondary');
            descBtn.classList.add('btn-primary', 'active');
        }
        
        // 如果已有图表，重新生成
        const currentChart = chartNumber === 1 ? currentChart1 : currentChart2;
        if (currentChart) {
            console.log('重新生成图表', chartNumber, '以应用排序');
            generateChart(chartNumber);
        }
    }

    // 生成图表函数 - 支持双图表
    function generateChart(chartNumber = 1) {
        console.log('generateChart函数被调用，图表编号:', chartNumber);

        // 检查Chart.js是否加载
        if (typeof Chart === 'undefined') {
            alert('Chart.js库未加载！请检查网络连接。');
            return;
        }

        const groupFieldId = chartNumber === 1 ? 'groupField1' : 'groupField2';
        const groupField = document.getElementById(groupFieldId).value;
        const currentChartType = chartNumber === 1 ? currentChartType1 : currentChartType2;
        const chartSortOrder = chartNumber === 1 ? chartSortOrder1 : chartSortOrder2;

        console.log('选择的分组字段:', groupField, '图表编号:', chartNumber);

        if (!groupField) {
            alert('请选择分组字段');
            return;
        }

        // 显示加载状态
        const generateBtnId = chartNumber === 1 ? 'generateChartBtn1' : 'generateChartBtn2';
        const generateBtn = document.getElementById(generateBtnId);
        const originalText = generateBtn.textContent;
        generateBtn.textContent = '加载中...';
        generateBtn.disabled = true;

        // 始终重新获取所有搜索结果数据，确保图表使用完整的搜索数据
        console.log('重新获取所有搜索结果数据用于图表', chartNumber);
        getAllSearchData()
            .then(allSearchData => {
                console.log('获取到的所有搜索结果数据:', allSearchData);
                if (allSearchData && allSearchData.length > 0) {
                    try {
                        processChartData(allSearchData, groupField, currentChartType, chartSortOrder, chartNumber);
                        console.log('✅ 图表', chartNumber, '生成成功，使用数据量:', allSearchData.length);
                    } catch (error) {
                        console.error('处理图表数据失败:', error);
                        alert('处理图表数据失败: ' + error.message);
                        showNoDataMessage(chartNumber);
                    }
                } else {
                    console.log('没有获取到数据');
                    showNoDataMessage(chartNumber);
                }
            })
            .catch(error => {
                console.error('获取所有数据失败:', error);
                alert('获取数据失败: ' + error.message);
                showNoDataMessage(chartNumber);
            })
            .finally(() => {
                // 恢复按钮状态
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            });
    }

    // 处理图表数据的辅助函数 - 支持双图表
    function processChartData(data, groupField, chartType, sortOrder = 'none', chartNumber = 1) {
        console.log('🔄 processChartData 被调用:', {
            dataLength: data.length,
            groupField: groupField,
            chartType: chartType,
            sortOrder: sortOrder,
            chartNumber: chartNumber
        });
        
        if (!data || data.length === 0) {
            console.log('❌ 没有数据，显示无数据消息');
            showNoDataMessage(chartNumber);
            return;
        }

        // 验证分组字段
        if (!groupField) {
            console.error('❌ 分组字段为空');
            alert('请选择分组字段');
            return;
        }

        // 处理数据
        console.log('📊 开始处理分组数据...');
        try {
            const chartData = processGroupedDataForChart(data, groupField, chartType, sortOrder);
            console.log('✅ 处理后的图表数据:', chartData);

            // 验证处理后的数据
            if (!chartData || !chartData.labels || chartData.labels.length === 0) {
                console.error('❌ 处理后的图表数据无效');
                alert('无法生成图表数据，请检查数据格式');
                showNoDataMessage(chartNumber);
                return;
            }

            // 销毁现有图表
            const currentChart = chartNumber === 1 ? currentChart1 : currentChart2;
            if (currentChart) {
                console.log('🗑️ 销毁现有图表', chartNumber);
                currentChart.destroy();
                if (chartNumber === 1) {
                    currentChart1 = null;
                } else {
                    currentChart2 = null;
                }
            }

            // 创建新图表
            console.log('🚀 开始创建图表', chartNumber, '，类型:', chartType);
            createGroupedChart(chartData, chartType, chartNumber);
            console.log('✅ 图表', chartNumber, '创建完成');
        } catch (error) {
            console.error('❌ 处理图表数据失败:', error);
            alert('处理图表数据失败: ' + error.message);
            showNoDataMessage(chartNumber);
        }
    }

    // 获取表格数据
    function getTableData() {
        console.log('=== 开始获取图表数据 ===');
        console.log('allData类型:', typeof allData);
        console.log('allData长度:', allData ? allData.length : 'undefined');
        console.log('allData内容:', allData);

        // 检查allData是否有效
        if (!allData || allData.length === 0) {
            console.log('allData无效或为空，尝试从表格获取当前页数据');
            return getDataFromTable();
        }

        // 检查allData的数据结构
        if (allData.length > 0) {
            console.log('allData第一条数据的结构:', Object.keys(allData[0]));
            console.log('前3条allData数据:');
            for (let i = 0; i < Math.min(3, allData.length); i++) {
                console.log(`第${i + 1}条数据:`, allData[i]);
            }
        }

        console.log('使用allData，总数据量:', allData.length);
        return allData;
    }

    // 获取所有搜索结果数据（用于图表）
    function getAllSearchData() {
        console.log('=== 获取所有搜索结果数据用于图表 ===');

        return new Promise((resolve, reject) => {
            // 构建查询参数（设置一个很大的size来获取所有数据）
            const params = new URLSearchParams({
                username: currentUser,
                job: currentRole,
                page: 1,
                size: 50000  // 增加数据量限制，确保能获取到所有数据
            });

            // 添加筛选条件（与当前搜索条件保持一致）
            const majorCode = document.getElementById('majorCodeFilter').value.trim();
            const minorCode = document.getElementById('minorCodeFilter').value.trim();
            const projectPhase = document.getElementById('projectPhaseFilter').value.trim();
            const version = document.getElementById('versionFilter').value.trim();
            const supplier = document.getElementById('supplierFilter').value.trim();
            const problemStatus = document.getElementById('problemStatusFilter').value;
            const group = document.getElementById('groupFilter').value.trim();
            const category = document.getElementById('categoryFilter').value.trim();
            const dataSource = document.getElementById('dataSourceFilter').value.trim();
            const dqeResponsible = document.getElementById('dqeResponsibleFilter').value.trim();
            const testStartDate = document.getElementById('testStartDateFilter').value;
            const testEndDate = document.getElementById('testEndDateFilter').value;

            if (majorCode) params.append('majorCode', majorCode);
            if (minorCode) params.append('minorCode', minorCode);
            if (projectPhase) params.append('projectPhase', projectPhase);
            if (version) params.append('version', version);
            if (supplier) params.append('supplier', supplier);
            if (problemStatus) {
                // 标准化问题状态，兼容大小写
                const normalizedStatus = normalizeProblemStatus(problemStatus);
                params.append('problemStatus', normalizedStatus);
            }
            if (group) params.append('group', group);
            if (category) params.append('category', category);
            if (dataSource) params.append('dataSource', dataSource);
            if (dqeResponsible) params.append('dqeResponsible', dqeResponsible);
            if (testStartDate) params.append('testStartDate', testStartDate);
            if (testEndDate) params.append('testEndDate', testEndDate);

            console.log('发送的查询参数（获取所有数据用于图表）:', params.toString());

            fetch('/reviewResult/getReviewResults?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    console.log('API响应数据（所有数据）:', data);
                    if (data.success) {
                        const allSearchData = data.data || [];
                        console.log('✅ 获取到的所有搜索结果数据量:', allSearchData.length);
                        console.log('📊 图表将使用这', allSearchData.length, '条数据进行统计');
                        resolve(allSearchData);
                    } else {
                        console.error('API返回错误:', data);
                        reject(new Error(data.error || data.message || '获取数据失败'));
                    }
                })
                .catch(error => {
                    console.error('获取所有数据时发生错误:', error);
                    reject(error);
                });
        });
    }

    // 从表格获取数据的辅助函数
    function getDataFromTable() {
        const table = document.getElementById('reviewTable');
        const rows = table.querySelectorAll('tbody tr');
        const data = [];

        console.log('找到表格行数:', rows.length);

        rows.forEach((row, rowIndex) => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) {
                const rowData = {};
                // 根据表格列的实际顺序获取数据（跳过操作列，共26列数据列）
                const headers = ['id', 'testDate', 'majorCode', 'minorCode', 'projectPhase', 'version',
                    'problemProcess', 'problemLevel', 'developmentMethod', 'supplier',
                    'solutionProvider', 'problemPoint', 'problemReason', 'improvementStrategy',
                    'isPreventable', 'responsibleDepartment', 'problemStatus', 'expectedCompletionTime',
                    'actualCompletionTime', 'delayDays', 'problemTag1', 'problemTag2',
                    'preventionNote', 'createdAt', 'updatedAt'];

                headers.forEach((header, index) => {
                    if (cells[index]) {
                        rowData[header] = cells[index].textContent.trim();
                    }
                });

                // 只添加有ID的行（过滤掉空行）
                if (rowData.id && rowData.id !== '') {
                    data.push(rowData);
                    if (rowIndex < 3) { // 只打印前3行的数据用于调试
                        console.log(`第${rowIndex + 1}行数据:`, rowData);
                    }
                }
            }
        });

        console.log('从表格获取的数据行数:', data.length);
        return data;
    }

    // 处理数据用于图表显示
    function processDataForChart(data, xField, yField) {
        console.log('开始处理图表数据，X字段:', xField, 'Y字段:', yField);
        const groupedData = {};

        data.forEach((item, index) => {
            const xValue = item[xField] || '未知';
            const yValue = yField === 'count' ? 1 : (parseFloat(item[yField]) || 0);

            // 打印前几条数据的处理过程
            if (index < 3) {
                console.log(`第${index + 1}条数据:`, {
                    xValue: xValue,
                    yValue: yValue,
                    xFieldValue: item[xField],
                    yFieldValue: item[yField]
                });
            }

            if (groupedData[xValue]) {
                if (yField === 'count') {
                    groupedData[xValue]++;
                } else {
                    groupedData[xValue] += yValue;
                }
            } else {
                groupedData[xValue] = yField === 'count' ? 1 : yValue;
            }
        });

        const labels = Object.keys(groupedData);
        const values = Object.values(groupedData);

        console.log('分组后的数据:', groupedData);
        console.log('图表标签:', labels);
        console.log('图表数值:', values);

        return { labels, values };
    }

    // 处理分组数据用于图表显示
    function processGroupedDataForChart(data, groupField, chartType, sortOrder = 'none') {
        console.log('开始处理分组图表数据，分组字段:', groupField, '图表类型:', chartType, '排序:', sortOrder);
        console.log('输入数据量:', data.length);

        const groupedData = {};

        // 按分组字段统计
        data.forEach((item, index) => {
            // 打印前几条数据的字段值用于调试
            if (index < 3) {
                console.log(`第${index + 1}条数据:`, {
                    groupField: groupField,
                    groupValue: item[groupField],
                    problemStatus: item.problemStatus,
                    delayDays: item.delayDays
                });
            }

            const groupValue = item[groupField] || '未知';

            if (!groupedData[groupValue]) {
                groupedData[groupValue] = {
                    total: 0,
                    closed: 0,
                    open: 0,
                    followUp: 0,
                    delayCount: 0,
                    totalDelayDays: 0,
                    preventable: 0
                };
            }

            groupedData[groupValue].total++;

            // 统计关闭状态
            const status = item.problemStatus || 'Open';
            if (status.toLowerCase() === 'closed' || status.toLowerCase() === 'close') {
                groupedData[groupValue].closed++;
            } else if (status === 'Open') {
                groupedData[groupValue].open++;
            } else if (status === 'Follow up') {
                groupedData[groupValue].followUp++;
            }

            // 统计可预防数
            if (item.isPreventable === '是') {
                groupedData[groupValue].preventable++;
            }
        });

        // 计算关闭率
        Object.keys(groupedData).forEach(key => {
            const group = groupedData[key];
            group.closureRate = group.total > 0 ? Math.round((group.closed / group.total) * 100) : 0;
            group.avgDelayDays = group.delayCount > 0 ? Math.round(group.totalDelayDays / group.delayCount) : 0;
        });

        console.log('分组后的数据:', groupedData);

        // 获取所有标签并排序
        let labels = Object.keys(groupedData);
        
        // 根据排序设置对标签进行排序
        if (sortOrder !== 'none') {
            labels.sort((a, b) => {
                const valueA = groupedData[a].total;
                const valueB = groupedData[b].total;
                
                if (sortOrder === 'asc') {
                    return valueA - valueB;
                } else if (sortOrder === 'desc') {
                    return valueB - valueA;
                }
                return 0;
            });
            console.log('排序后的标签:', labels);
        }
        
        const datasets = [];

        // 根据图表类型决定显示哪些数据系列
        if (chartType === 'pie') {
            // 饼状图只显示总数
            datasets.push({
                label: '总数',
                data: labels.map(label => groupedData[label].total),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(255, 193, 7, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)',
                    'rgba(199, 199, 199, 0.6)',
                    'rgba(83, 102, 255, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(199, 199, 199, 1)',
                    'rgba(83, 102, 255, 1)'
                ],
                borderWidth: 1
            });
        } else {
            // 柱状图和折线图显示四个数据系列：总数、关闭数、可预防数、关闭率
            datasets.push({
                label: '总数',
                data: labels.map(label => groupedData[label].total),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                maxBarThickness: 35
            });
            datasets.push({
                label: '关闭数',
                data: labels.map(label => groupedData[label].closed),
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                maxBarThickness: 35
            });
            datasets.push({
                label: '可预防数',
                data: labels.map(label => groupedData[label].preventable),
                backgroundColor: 'rgba(255, 193, 7, 0.6)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 1,
                maxBarThickness: 35
            });
            datasets.push({
                label: '关闭率(%)',
                data: labels.map(label => groupedData[label].closureRate),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                yAxisID: 'y1',
                maxBarThickness: 35
            });
        }

        return { labels, datasets, groupedData };
    }

    // 创建图表
    function createChart(data, type) {
        console.log('createChart函数被调用，数据:', data, '类型:', type);

        const ctx = document.getElementById('dataChart').getContext('2d');
        const noDataMessage = document.getElementById('noDataMessage');

        if (!ctx) {
            console.error('无法获取canvas上下文');
            return;
        }

        // 隐藏无数据消息
        noDataMessage.style.display = 'none';

        // 根据图表类型调整数据格式
        let chartData;
        if (type === 'pie') {
            chartData = {
                labels: data.labels,
                datasets: [{
                    label: '数值',
                    data: data.values,
                    backgroundColor: getBackgroundColors(data.labels.length),
                    borderColor: getBorderColors(data.labels.length),
                    borderWidth: 1
                }]
            };
        } else {
            chartData = {
                labels: data.labels,
                datasets: [{
                    label: '数值',
                    data: data.values,
                    backgroundColor: getBackgroundColors(data.labels.length),
                    borderColor: getBorderColors(data.labels.length),
                    borderWidth: 1
                }]
            };
        }

        // 计算Y轴最大值（增加2/3的高度）
        let actualMaxYValue = 0; // 实际数据最大值（用于控制网格线）
        let maxYValue = 0;
        if (type !== 'pie' && chartData.datasets && chartData.datasets[0] && chartData.datasets[0].data) {
            actualMaxYValue = Math.max(...chartData.datasets[0].data.map(v => Number(v) || 0));
            // 增加2/3的高度：maxYValue * (1 + 2/3) = maxYValue * 1.667...
            maxYValue = Math.ceil(actualMaxYValue * 1.667);
            // 确保最小值为1，避免为0时显示问题
            if (maxYValue === 0) maxYValue = 1;
        }

        const config = {
            type: type,
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1.5,
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                plugins: {
                    legend: {
                        display: type !== 'pie',
                        position: type === 'pie' ? 'left' : 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: '数据统计图表',
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                return [`数值: ${context.parsed}`];
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#000',
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        formatter: function(value, context) {
                            return value;
                        },
                        anchor: 'end',
                        align: 'top',
                        offset: 4
                    }
                },
                scales: type !== 'pie' ? {
                    y: {
                        beginAtZero: true,
                        suggestedMax: maxYValue,
                        title: {
                            display: true,
                            text: '数值',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: function(context) {
                                // 如果刻度值大于实际数据最大值，则不显示网格线（返回透明色）
                                if (context.tick && context.tick.value > actualMaxYValue) {
                                    return 'transparent';
                                }
                                return 'rgba(0,0,0,0.1)';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '类别',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: false
                        },
                        barPercentage: 0.7,
                        categoryPercentage: 0.4
                    }
                } : {}
            },
            animation: {
                duration: 1200,
                easing: 'easeInOutQuart',
                delay: 100,
                animateRotate: true,
                animateScale: true
            },
            layout: {
                padding: {
                    top: 40,
                    bottom: 20
                }
            }
        };

        console.log('图表配置:', config);

        try {
            // 注册数据标签插件
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }
            
            // 根据图表编号创建对应的图表实例
            if (chartNumber === 1) {
                currentChart1 = new Chart(ctx, config);
                console.log('图表1创建成功');
            } else {
                currentChart2 = new Chart(ctx, config);
                console.log('图表2创建成功');
            }
        } catch (error) {
            console.error('图表创建失败:', error);
            alert('图表创建失败: ' + error.message);
        }
    }

    // 显示无数据消息
    // 显示无数据消息 - 支持双图表
    function showNoDataMessage(chartNumber = 1) {
        const currentChart = chartNumber === 1 ? currentChart1 : currentChart2;
        if (currentChart) {
            currentChart.destroy();
            if (chartNumber === 1) {
                currentChart1 = null;
            } else {
                currentChart2 = null;
            }
        }
        
        const noDataMessageId = chartNumber === 1 ? 'noDataMessage1' : 'noDataMessage2';
        document.getElementById(noDataMessageId).style.display = 'block';
        updateChartStatus('无数据可显示', 'warning', chartNumber);
    }

    // 更新图表状态 - 支持双图表
    function updateChartStatus(message, type = 'info', chartNumber = 1) {
        const statusDivId = chartNumber === 1 ? 'chartStatus1' : 'chartStatus2';
        const statusTextId = chartNumber === 1 ? 'chartStatusText1' : 'chartStatusText2';
        const statusDiv = document.getElementById(statusDivId);
        const statusText = document.getElementById(statusTextId);
        
        if (statusDiv && statusText) {
            statusText.textContent = message;
            
            // 根据类型设置样式
            switch (type) {
                case 'success':
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.borderLeftColor = '#28a745';
                    statusDiv.style.color = '#155724';
                    break;
                case 'warning':
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.borderLeftColor = '#ffc107';
                    statusDiv.style.color = '#856404';
                    break;
                case 'error':
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.borderLeftColor = '#dc3545';
                    statusDiv.style.color = '#721c24';
                    break;
                default:
                    statusDiv.style.background = '#f8f9fa';
                    statusDiv.style.borderLeftColor = '#6c757d';
                    statusDiv.style.color = '#495057';
            }
            
            statusDiv.style.display = 'block';
        }
    }

    // 生成背景颜色数组
    function getBackgroundColors(count) {
        const colors = [
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 99, 132, 0.6)',
            'rgba(255, 205, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(153, 102, 255, 0.6)',
            'rgba(255, 159, 64, 0.6)',
            'rgba(199, 199, 199, 0.6)',
            'rgba(83, 102, 255, 0.6)',
            'rgba(255, 99, 255, 0.6)',
            'rgba(99, 255, 132, 0.6)'
        ];

        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(colors[i % colors.length]);
        }
        return result;
    }

    // 生成边框颜色数组
    function getBorderColors(count) {
        const colors = [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(255, 205, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(199, 199, 199, 1)',
            'rgba(83, 102, 255, 1)',
            'rgba(255, 99, 255, 1)',
            'rgba(99, 255, 132, 1)'
        ];

        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(colors[i % colors.length]);
        }
        return result;
    }


    // 创建分组图表 - 支持双图表
    function createGroupedChart(data, type, chartNumber = 1) {
        console.log('🎨 createGroupedChart函数被调用:', {
            data: data,
            type: type,
            labels: data.labels,
            datasetsCount: data.datasets ? data.datasets.length : 0,
            chartNumber: chartNumber
        });

        const canvasId = chartNumber === 1 ? 'dataChart1' : 'dataChart2';
        const noDataMessageId = chartNumber === 1 ? 'noDataMessage1' : 'noDataMessage2';
        const ctx = document.getElementById(canvasId).getContext('2d');
        const noDataMessage = document.getElementById(noDataMessageId);

        if (!ctx) {
            console.error('❌ 无法获取canvas上下文');
            return;
        }

        console.log('✅ Canvas上下文获取成功');
        // 隐藏无数据消息
        noDataMessage.style.display = 'none';

        // 根据图表类型调整数据格式
        let chartData = data;
        if (type === 'pie') {
            // 饼状图只显示第一个数据集（通常是总数）
            chartData = {
                labels: data.labels,
                datasets: [{
                    label: data.datasets[0].label,
                    data: data.datasets[0].data,
                    backgroundColor: data.datasets[0].backgroundColor || getBackgroundColors(data.labels.length),
                    borderColor: data.datasets[0].borderColor || getBorderColors(data.labels.length),
                    borderWidth: data.datasets[0].borderWidth || 1
                }]
            };
        }

        // 计算Y轴最大值（增加2/3的高度）
        let actualMaxYValue = 0; // 实际数据最大值（用于控制网格线）
        let actualMaxY1Value = 0; // 实际关闭率最大值（用于控制网格线）
        let maxYValue = 0;
        let maxY1Value = 0; // 关闭率（y1轴）的最大值
        if (type !== 'pie' && chartData.datasets) {
            chartData.datasets.forEach(dataset => {
                if (dataset.label === '关闭率(%)' || dataset.yAxisID === 'y1') {
                    // 计算关闭率的最大值
                    const datasetMax = Math.max(...(dataset.data || []).map(v => Number(v) || 0));
                    if (datasetMax > actualMaxY1Value) {
                        actualMaxY1Value = datasetMax;
                    }
                } else {
                    // 计算其他数据集的最大值
                    const datasetMax = Math.max(...(dataset.data || []).map(v => Number(v) || 0));
                    if (datasetMax > actualMaxYValue) {
                        actualMaxYValue = datasetMax;
                    }
                }
            });
            // 保存实际最大值用于网格线控制
            maxYValue = actualMaxYValue;
            maxY1Value = actualMaxY1Value;
            // 增加2/3的高度：maxYValue * (1 + 2/3) = maxYValue * 1.667...
            maxYValue = Math.ceil(maxYValue * 1.667);
            // 增加2/3的高度：maxY1Value * (1 + 2/3) = maxY1Value * 1.667...
            maxY1Value = Math.ceil(maxY1Value * 1.667);
            // 确保最小值为1，避免为0时显示问题
            if (maxYValue === 0) maxYValue = 1;
            // 关闭率最小值为100（因为关闭率通常不会超过100%）
            if (maxY1Value === 0) maxY1Value = 100;
            if (maxY1Value < 100) maxY1Value = 100;
        }

        const config = {
            type: type || 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1.5,
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: type === 'pie' ? 'left' : 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `${document.getElementById(chartNumber === 1 ? 'groupField1' : 'groupField2').selectedOptions[0].text} 问题关闭情况`,
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const groupValue = context.label;
                                const groupData = data.groupedData ? data.groupedData[groupValue] : null;
                                
                                if (groupData) {
                                    return [
                                        `总数: ${groupData.total}`,
                                        `关闭数: ${groupData.closed}`,
                                        `可预防数: ${groupData.preventable}`,
                                        `关闭率: ${groupData.closureRate}%`
                                    ];
                                } else {
                                    return [`数值: ${context.parsed}`];
                                }
                            }
                        }
                    },
                    // 添加数据标签插件
                    datalabels: {
                        display: true,
                        color: '#000',
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        formatter: function(value, context) {
                            const datasetLabel = context.dataset.label;
                            if (datasetLabel === '关闭率(%)') {
                                return value + '%';
                            } else {
                                return value;
                            }
                        },
                        anchor: 'end',
                        align: 'top',
                        offset: 4
                    }
                },
                scales: type === 'pie' ? {} : {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        suggestedMax: maxYValue,
                        title: {
                            display: true,
                            text: '数量',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: function(context) {
                                // 如果刻度值大于实际数据最大值，则不显示网格线（返回透明色）
                                if (context.tick && context.tick.value > actualMaxYValue) {
                                    return 'transparent';
                                }
                                return 'rgba(0,0,0,0.1)';
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        suggestedMax: maxY1Value,
                        title: {
                            display: true,
                            text: '百分比',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                            color: function(context) {
                                // 如果刻度值大于实际数据最大值，则不显示网格线（返回透明色）
                                if (context.tick && context.tick.value > actualMaxY1Value) {
                                    return 'transparent';
                                }
                                return 'rgba(0,0,0,0.05)';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '问题缺陷等级',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: false
                        },
                        barPercentage: 0.7,
                        categoryPercentage: 0.4
                    }
                }
            },
            animation: {
                duration: 1200,
                easing: 'easeInOutQuart',
                delay: 100,
                animateRotate: true,
                animateScale: true
            },
            layout: {
                padding: {
                    top: 40,  // 增加顶部间距以容纳数据标签
                    bottom: 20
                }
            }
        };

        console.log('⚙️ 分组图表配置:', {
            type: config.type,
            labelsCount: config.data.labels.length,
            datasetsCount: config.data.datasets.length,
            scales: config.options.scales ? Object.keys(config.options.scales) : 'none'
        });

        try {
            // 注册数据标签插件
            console.log('📝 注册数据标签插件...');
            Chart.register(ChartDataLabels);

            console.log('🎯 开始创建Chart实例...');
            // 根据图表编号创建对应的图表实例
            if (chartNumber === 1) {
                currentChart1 = new Chart(ctx, config);
                console.log('🎉 分组图表1创建成功!', {
                    chartType: currentChart1.config.type,
                    dataPoints: currentChart1.data.datasets[0] ? currentChart1.data.datasets[0].data.length : 0
                });
            } else {
                currentChart2 = new Chart(ctx, config);
                console.log('🎉 分组图表2创建成功!', {
                    chartType: currentChart2.config.type,
                    dataPoints: currentChart2.data.datasets[0] ? currentChart2.data.datasets[0].data.length : 0
                });
            }
            
            // 更新状态
            const currentChartType = chartNumber === 1 ? currentChartType1 : currentChartType2;
            updateChartStatus(`图表${chartNumber}创建成功 - ${currentChartType === 'pie' ? '饼状图' : currentChartType === 'bar' ? '柱状图' : '折线图'}`, 'success', chartNumber);
        } catch (error) {
            console.error('💥 分组图表创建失败:', error);
            console.error('错误详情:', {
                message: error.message,
                stack: error.stack,
                config: config
            });
        }
    }

    // ========== 全局编辑功能 ==========
    let isGlobalEditMode = false; // 全局编辑模式标志

    // 切换全局编辑模式
    function toggleGlobalEditMode() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        isGlobalEditMode = !isGlobalEditMode;
        
        const table = document.getElementById('reviewTable');
        const globalEditBtn = document.getElementById('globalEditBtn');
        const saveGlobalEditBtn = document.getElementById('saveGlobalEditBtn');
        const btnText = document.getElementById('globalEditBtnText');
        
        if (isGlobalEditMode) {
            // 进入编辑模式
            table.classList.add('global-edit-mode');
            globalEditBtn.classList.remove('btn-primary');
            globalEditBtn.classList.add('btn-warning');
            btnText.textContent = '退出编辑';
            saveGlobalEditBtn.style.display = 'inline-block';
            
            // 重新渲染表格，显示输入框
            renderTable();
            showToast('已进入编辑模式，可以直接在表格中编辑数据', 'info');
        } else {
            // 退出编辑模式
            table.classList.remove('global-edit-mode');
            globalEditBtn.classList.remove('btn-warning');
            globalEditBtn.classList.add('btn-primary');
            btnText.textContent = '全局编辑';
            saveGlobalEditBtn.style.display = 'none';
            
            // 重新渲染表格，显示普通文本
            renderTable();
            showToast('已退出编辑模式', 'info');
        }
    }

    // 从表格保存全局编辑
    async function saveGlobalEditFromTable() {
        // 权限检查：只有DQE或manager可以使用
        if (!checkDQEOrManagerPermission()) {
            return;
        }
        
        if (!isGlobalEditMode) {
            return;
        }

        const inputs = document.querySelectorAll('.table-cell-input, .table-cell-date-input');
        if (inputs.length === 0) {
            showToast('没有数据需要保存', 'warning');
            return;
        }

        // 收集所有编辑的数据（只保存允许编辑的行，且只保存实际有变化的字段）
        const editedDataMap = new Map();

        inputs.forEach(input => {
            // 跳过被禁用的输入框（这些是不允许编辑的行）
            if (input.disabled || input.readOnly) {
                return;
            }
            
            const row = input.closest('tr');
            const idCell = row.querySelector('td[data-key="id"]');
            if (!idCell) return;
            
            const id = idCell.textContent.trim();
            const field = input.getAttribute('data-field');
            const currentValue = input.value.trim();
            
            // 安全验证：检查该行的原始 group 字段是否允许编辑
            // 应该基于原始数据判断是否有权限编辑，而不是修改后的值
            // 如果组别为空，允许任何人编辑；否则需要组别匹配
            const originalReview = allData.find(item => String(item.id) === id);
            if (originalReview) {
                const originalGroup = originalReview.group || '';
                if (!canEditByGroup(originalGroup, departmentName, originalReview.dqeResponsible)) {
                    return; // 原始组别不允许编辑，跳过
                }
                
                // 获取原始值并与当前值比较，只有值发生变化时才保存
                let originalValue = originalReview[field] || '';
                
                // 处理日期字段：需要格式化后再比较
                if (input.classList.contains('table-cell-date-input')) {
                    originalValue = formatDateForInput(originalValue) || '';
                    // 如果都是空字符串，视为相等
                    if (originalValue === '' && currentValue === '') {
                        return; // 值未变化，跳过
                    }
                    // 比较格式化后的值
                    if (originalValue === currentValue) {
                        return; // 值未变化，跳过
                    }
                } else {
                    // 普通字段：去除空格后比较
                    originalValue = String(originalValue).trim();
                    // 如果都是空字符串，视为相等
                    if (originalValue === '' && currentValue === '') {
                        return; // 值未变化，跳过
                    }
                    // 比较值
                    if (originalValue === currentValue) {
                        return; // 值未变化，跳过
                    }
                }
            } else if (departmentName) {
                // 如果找不到原始数据但有 departmentName，为了安全起见，也跳过
                // 这种情况理论上不应该发生，因为不允许编辑的行不会显示输入框
                return;
            } else {
                // 如果没有 departmentName 且找不到原始数据，也不保存
                return;
            }

            // 只有值真正发生变化时，才添加到编辑数据中
            if (!editedDataMap.has(id)) {
                editedDataMap.set(id, { id: id });
            }
            editedDataMap.get(id)[field] = currentValue;
        });

        const editedData = Array.from(editedDataMap.values());

        if (editedData.length === 0) {
            showToast('没有修改任何数据', 'warning');
            return;
        }

        // 在保存前弹出确认窗口，显示要保存的数据条数
        const dataCount = editedData.length;
        const confirmMessage = `确定要保存修改的 ${dataCount} 条数据吗？`;
        
        if (!confirm(confirmMessage)) {
            // 用户取消保存
            return;
        }

        // 显示保存提示
        const saveBtn = document.getElementById('saveGlobalEditBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

        try {
            // 调用批量更新接口
            const response = await fetch('/reviewResult/batchUpdate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: editedData
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast(`成功保存 ${result.updatedCount || editedData.length} 条数据`, 'success');
                // 退出编辑模式
                toggleGlobalEditMode();
                // 重新加载数据，保持在当前页
                loadReviewData();
            } else {
                showToast('保存失败: ' + (result.message || '未知错误'), 'error');
            }
        } catch (error) {
            console.error('保存失败:', error);
            showToast('保存失败: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存修改';
        }
    }

    // 打开全局编辑模态框（保留但不使用）
    async function openGlobalEditModal() {
        // 不再使用模态框方式，改为直接切换编辑模式
        toggleGlobalEditMode();
    }

    // 获取所有搜索结果数据用于全局编辑（保留但不使用）
    function getAllSearchDataForGlobalEdit() {
        return new Promise((resolve, reject) => {
            const params = new URLSearchParams({
                username: currentUser,
                job: currentRole,
                page: 1,
                size: 50000
            });

            // 添加筛选条件（与当前搜索条件保持一致）
            const majorCode = document.getElementById('majorCodeFilter').value.trim();
            const minorCode = document.getElementById('minorCodeFilter').value.trim();
            const projectPhase = document.getElementById('projectPhaseFilter').value.trim();
            const version = document.getElementById('versionFilter').value.trim();
            const supplier = document.getElementById('supplierFilter').value.trim();
            const problemStatus = document.getElementById('problemStatusFilter').value;
            const group = document.getElementById('groupFilter').value.trim();
            const category = document.getElementById('categoryFilter').value.trim();
            const dataSource = document.getElementById('dataSourceFilter').value.trim();
            const dqeResponsible = document.getElementById('dqeResponsibleFilter').value.trim();
            const testStartDate = document.getElementById('testStartDateFilter').value;
            const testEndDate = document.getElementById('testEndDateFilter').value;

            if (majorCode) params.append('majorCode', majorCode);
            if (minorCode) params.append('minorCode', minorCode);
            if (projectPhase) params.append('projectPhase', projectPhase);
            if (version) params.append('version', version);
            if (supplier) params.append('supplier', supplier);
            if (problemStatus) {
                const normalizedStatus = normalizeProblemStatus(problemStatus);
                params.append('problemStatus', normalizedStatus);
            }
            if (group) params.append('group', group);
            if (category) params.append('category', category);
            if (dataSource) params.append('dataSource', dataSource);
            if (dqeResponsible) params.append('dqeResponsible', dqeResponsible);
            if (testStartDate) params.append('testStartDate', testStartDate);
            if (testEndDate) params.append('testEndDate', testEndDate);

            fetch('/reviewResult/getReviewResults?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resolve(data.data || []);
                    } else {
                        reject(new Error(data.error || '获取数据失败'));
                    }
                })
                .catch(error => {
                    reject(error);
                });
        });
    }

    // 填充全局编辑表格（保留但不使用）
    function fillGlobalEditTable(data) {
        const tbody = document.getElementById('globalEditTableBody');
        tbody.innerHTML = '';

        data.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><input type="text" class="global-edit-input" data-field="majorCode" data-id="${item.id}" value="${item.majorCode || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="minorCode" data-id="${item.id}" value="${item.minorCode || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="projectPhase" data-id="${item.id}" value="${item.projectPhase || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="version" data-id="${item.id}" value="${item.version || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="supplier" data-id="${item.id}" value="${item.supplier || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="problemStatus" data-id="${item.id}" value="${item.problemStatus || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="group" data-id="${item.id}" value="${item.group || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="category" data-id="${item.id}" value="${item.category || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="dqeResponsible" data-id="${item.id}" value="${item.dqeResponsible || ''}" /></td>
                <td><input type="text" class="global-edit-input" data-field="dataSource" data-id="${item.id}" value="${item.dataSource || ''}" /></td>
                <td><input type="date" class="global-edit-input" data-field="testDate" data-id="${item.id}" value="${item.testDate ? formatDateForInput(item.testDate) : ''}" /></td>
            `;
            tbody.appendChild(row);
        });
    }

    // 格式化日期为input[type="date"]需要的格式
    function formatDateForInput(dateStr) {
        if (!dateStr) return '';
        // 处理各种日期格式
        if (dateStr.includes('T')) {
            return dateStr.split('T')[0];
        }
        return dateStr.substring(0, 10);
    }

    // 关闭全局编辑模态框（保留但不使用）
    function closeGlobalEditModal() {
        document.getElementById('globalEditModal').style.display = 'none';
    }

    // 保存全局编辑（保留但不使用，改为使用saveGlobalEditFromTable）
    async function saveGlobalEdit() {
        await saveGlobalEditFromTable();
    }

    // 关闭模态框事件
    window.closeGlobalEditModal = closeGlobalEditModal;

    // 创建一个通用的访问日志记录工具
    const AccessLogUtil = {
        /**
         * 记录用户操作
         * @param {string} actionName 操作名称，例如："导出按钮"、"搜索按钮"、"新增按钮"等
         */
        record: function(actionName) {
            try {
                const username = localStorage.getItem('username') || '';
                const job = localStorage.getItem('job') || '';

                if (!username || !job) {
                    console.warn('用户信息不完整，无法记录访问日志');
                    return;
                }

                // 使用fetch发送请求（不等待响应，避免影响用户体验）
                fetch('/api/userAccessLog/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        job: job,
                        accessPage: actionName
                    })
                }).catch(error => {
                    // 静默失败，不影响用户操作
                    console.error('记录访问日志失败:', error);
                });
            } catch (error) {
                console.error('记录访问日志异常:', error);
            }
        }
    };


</script>
