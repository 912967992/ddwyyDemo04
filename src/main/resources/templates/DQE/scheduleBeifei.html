<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>项目池子展示</title>
  <!-- 引入外部CSS文件 -->
  <link rel="stylesheet" href="/css/scheduleBoard.css">

</head>
<body>

<div class="pool-container">
  <div id="projectList" class="project-container">
    <h2>项目池子
      <!-- 新增项目按钮 -->
      <button id="addProjectBtn" style="margin-left: 10px;">新增项目</button>
      <!-- 新增垃圾站区域 -->
      <div id="trashStation">
        <h3>回收站(右键可查看作废项目)</h3>
        <div id="trashContent"></div>
      </div>
    </h2>
    <div id="projectPool">加载中...</div>
  </div>
  <div class="pending-sample-container">
    <h2>待送样池子</h2>
    <div class="pending-sample-category">
      <h3>视频类</h3>
      <div id="videoSamplePool">加载中...</div>
    </div>
    <div class="pending-sample-category">
      <h3>线材类</h3>
      <div id="wireSamplePool">加载中...</div>
    </div>
    <div class="pending-sample-category">
      <h3>数据类</h3>
      <div id="dataSamplePool">加载中...</div>
    </div>
    <div class="pending-sample-category">
      <h3>蓝牙类</h3>
      <div id="bluetoothSamplePool">加载中...</div>
    </div>
    <div class="pending-sample-category">
      <h3>高频类</h3>
      <div id="highFrequencySamplePool">加载中...</div>
    </div>
  </div>
</div>

<!-- 排期面板区域 -->
<div class="schedule-board-container">
  <div class="schedule-board-header">
    <h3>排期面板</h3>
    <div class="schedule-controls">
      <input type="date" id="startDate" class="date-picker">
      <span>至</span>
      <input type="date" id="endDate" class="date-picker">
      <button class="save-schedule-btn" onclick="refreshSchedule()">设置日期</button>
      <button class="save-schedule-btn" onclick="saveSchedule()">保存排期</button>
    </div>
  </div>
  <div id="scheduleBoard">请选择排期面板时间并点击设置日期按钮，才会展示面板</div>
</div>

<!-- 新增变更记录模态框 -->
<div id="changeLogModal">
  <div id="changeLogModalContent">
    <h3>变更记录</h3>
    <div id="changeLogBody"></div>
    <button id="closeChangeLogBtn">关闭</button>
  </div>
</div>

<!-- 模态框 -->
<div id="modal">
  <div id="modalContent">
    <!-- 新增变更记录按钮 -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>项目详情</h3>
      <div style="display: flex; gap: 10px;">
        <button id="changeLogBtn">变更记录</button>
        <button id="infoCloseBtn">关闭</button>
      </div>
    </div>

    <div id="modalBody"></div>

    <div style="margin-top: 10px;">
      <label for="scheduleDays"><strong>排期天数：</strong></label>
      <input type="number" id="scheduleDays" placeholder="请输入排期天数">
      <button id="saveScheduleBtn">确定排期</button>
    </div>


    <!-- 添加颜色选择功能 -->
    <div style="margin-top: 10px;">
      <label><strong>设置颜色：</strong></label>
      <div>
        <label>
          <input type="radio" id="color_null" name="schedule_color" value="null" checked> 无
        </label>
        <label>
          <input type="radio" id="color_gray" name="schedule_color" value="gray" checked> 灰色
        </label>
        <label>
          <input type="radio" id="color_green" name="schedule_color" value="green"> 绿色
        </label>
        <label>
          <input type="radio" id="color_yellow" name="schedule_color" value="yellow"> 黄色
        </label>
        <label>
          <input type="radio" id="color_red" name="schedule_color" value="red"> 红色
        </label>
      </div>
      <button id="confirmColorBtn" style="margin-top: 5px;">确认修改颜色</button>
    </div>

    <!-- ✅ 修改为同一行显示送样备注、输入框和按钮 -->
    <div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
      <label for="sampleRemark"><strong>送样备注：</strong></label>
      <input type="text" id="sampleRemark" placeholder="请输入送样备注" style="flex: 1; padding: 4px;">
      <button id="saveRemarkBtn">保存备注</button>
    </div>

  </div>
</div>

<template id="changeLogTemplate">
  <p class="change-log-item">
    <strong>测试者：</strong> {{tester}}<br>
    <strong>排期开始：</strong> {{startDate}}<br>
    <strong>排期结束：</strong> {{endDate}}<br>
    <strong>更新时间：</strong> {{updateTime}}<br>
    <strong>颜色：</strong> <span style="color: {{color}};">{{color}}</span><br>
    <strong>是否使用：</strong> {{used}}<br>
    <strong>备注：</strong> {{remark}}<br>
  <hr>
  </p>
</template>

<!-- 新增项目模态框 -->
<div id="addProjectModal" style="display: none;">
  <div id="addProjectModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>新增项目</h3>
      <button id="closeAddProjectModalBtn">关闭</button>
    </div>
    <div id="addProjectModalBody">
      <p><strong>项目名称(<span class="required">*</span>)：</strong><input type="text" id="addSampleName" required></p>
      <p><strong>大小编码(<span class="required">*</span>)：</strong><input type="text" id="addSampleModel" required> <input type="text" id="addMaterialCode" required></p>
      <p><strong>项目负责人(<span class="required">*</span>)：</strong><input type="text" id="addSampleLeader" required></p>
      <p><strong>排期天数(<span class="required">*</span>)：</strong><input type="number" id="addScheduleDays" required></p>
      <p><strong>设置颜色(<span class="required">*</span>)：</strong></p>
      <label>
        <input type="radio" id="addColorNull" name="addScheduleColor" value="null" checked> 无
      </label>
      <label>
        <input type="radio" id="addColorGray" name="addScheduleColor" value="gray"> 灰色
      </label>
      <label>
        <input type="radio" id="addColorGreen" name="addScheduleColor" value="green"> 绿色
      </label>
      <label>
        <input type="radio" id="addColorYellow" name="addScheduleColor" value="yellow"> 黄色
      </label>
      <label>
        <input type="radio" id="addColorRed" name="addScheduleColor" value="red"> 红色
      </label>
      </p>
      <p><strong>放池子分类（选填）：</strong><input type="text" id="addWaitSampleClassify"></p>
      <p><strong>送样备注（选填）：</strong><input type="text" id="addSampleRemark"></p>
    </div>
    <button id="saveNewProjectBtn">保存项目</button>
  </div>
</div>


<div id="contextMenu" class="context-menu">
  <!-- <div onclick="handleContextMenuClick()">撤回排期</div> -->
  <div onclick="showProjectAttributes(event)">查看属性</div>
</div>

<!-- 返回按钮 -->
<div class="header-container">
  <button class="BackBtn" id="BackBtn" onclick="location.href='/DQEIndex'">返回<br>主页</button>
</div>

<!-- 作废项目列表模态框 -->
<div id="trashListModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1000;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h3>作废项目列表</h3>
    <button id="trashListCloseBtn" onclick="document.getElementById('trashListModal').style.display='none'">关闭</button>
  </div>
  <ul id="trashProjectList" style="list-style:none; padding:0;"></ul>
</div>


<!-- 详情内容模态框 -->
<div id="projectDetailModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1001;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h3>项目详细信息</h3>
    <button id="closeTransBtn" onclick="document.getElementById('projectDetailModal').style.display='none'">关闭</button>
  </div>

  <p><strong>电气编号：</strong><span id="detail_sample_id"></span></p>
  <p><strong>项目名称：</strong><span id="detail_sample_name"></span></p>
  <p><strong>大小编码：</strong><span id="detail_sizecoding"></span></p>
  <p><strong>项目负责人：</strong><span id="detail_sample_leader"></span></p>
  <p><strong>排期天数：</strong><span id="detail_scheduleDays"></span></p>
  <p><strong>颜色：</strong><span id="detail_schedule_color"></span></p>
  <p><strong>放池子分类：</strong><span id="detail_waitSample_classify"></span></p>
  <p><strong>送样备注：</strong><span id="detail_remark"></span></p>
  <p><strong>作废人：</strong><span id="detail_cancel_by"></span></p>
  <p><strong>作废工号：</strong><span id="detail_job_number"></span></p>
  <p><strong>作废时间：</strong><span id="detail_cancel_date"></span></p>
  <p><strong>作废理由：</strong><span id="detail_cancel_reason"></span></p>

  <button id="recoverBtn" onclick="recoverProject()">恢复</button>
</div>




<script>
  const username = sessionStorage.getItem('username');
  // const username = "卢健";

  let localScheduleChanges = [];
  const contextMenu = document.getElementById('contextMenu');
  let currentRightClickCell = null;
  let currentRightClickProject = null;

  //默认让endDate+14天，进入页面的时候
  document.addEventListener('DOMContentLoaded', function () {
    // 获取当前 UTC 时间
    const now = new Date();

    // 北京时间偏移（UTC+8）
    const beijingOffset = 8 * 60 * 60 * 1000;
    const beijingTime = new Date(now.getTime() + beijingOffset);

    // 开始日期：7天前
    const startTime = new Date(beijingTime.getTime() - 7 * 24 * 60 * 60 * 1000);
    const startYear = startTime.getUTCFullYear();
    const startMonth = String(startTime.getUTCMonth() + 1).padStart(2, '0');
    const startDay = String(startTime.getUTCDate()).padStart(2, '0');
    const startDate = `${startYear}-${startMonth}-${startDay}`;

    // 结束日期：7天后
    const endTime = new Date(beijingTime.getTime() + 7 * 24 * 60 * 60 * 1000);
    const endYear = endTime.getUTCFullYear();
    const endMonth = String(endTime.getUTCMonth() + 1).padStart(2, '0');
    const endDay = String(endTime.getUTCDate()).padStart(2, '0');
    const endDate = `${endYear}-${endMonth}-${endDay}`;

    // 设置 input 的默认值
    document.getElementById('startDate').value = startDate;
    document.getElementById('endDate').value = endDate;
  });



  // 设置拖拽
  function setDraggable(projectEl, isProject) {
    projectEl.addEventListener('dragstart', e => {
      const sampleModel = projectEl.getAttribute('data-sample_model');
      const materialCode = projectEl.getAttribute('data-materialCode');
      e.dataTransfer.setData('project-sizecoding', `${sampleModel} ${materialCode} `+projectEl.getAttribute('data-sample_leader').charAt(0) + " "+projectEl.getAttribute('data-remark'));
      e.dataTransfer.setData('project-days', projectEl.getAttribute('data-schedule_days'));
      e.dataTransfer.setData('project-sample_id', projectEl.getAttribute('data-sample_id'));
      e.dataTransfer.setData('project-sample_name', projectEl.getAttribute('data-sample_name'));
      e.dataTransfer.setData('project-sample_model', projectEl.getAttribute('data-sample_model'));
      e.dataTransfer.setData('project-materialCode', projectEl.getAttribute('data-materialCode'));
      e.dataTransfer.setData('project-sample_category', projectEl.getAttribute('data-sample_category'));
      e.dataTransfer.setData('project-version', projectEl.getAttribute('data-version'));
      e.dataTransfer.setData('project-priority', projectEl.getAttribute('data-priority'));
      e.dataTransfer.setData('project-sample_leader', projectEl.getAttribute('data-sample_leader'));
      e.dataTransfer.setData('project-supplier', projectEl.getAttribute('data-supplier'));
      e.dataTransfer.setData('project-test_project_category', projectEl.getAttribute('data-test_project_category'));
      e.dataTransfer.setData('project-test_projects', projectEl.getAttribute('data-test_projects'));
      e.dataTransfer.setData('project-schedule', projectEl.getAttribute('data-schedule'));
      e.dataTransfer.setData('project-create_time', projectEl.getAttribute('data-create_time'));
      e.dataTransfer.setData(
              'project-schedule_days',
              projectEl.getAttribute('data-schedule_days') ?? '1'
      );
      e.dataTransfer.setData('project-schedule_color', projectEl.getAttribute('data-schedule_color'));
      e.dataTransfer.setData('project-remark', projectEl.getAttribute('data-remark'));

    });
    if(isProject){

    }else{
      projectEl.addEventListener('contextmenu', e => {
        e.preventDefault();
        currentRightClickProject = projectEl;
        // 原代码中 projectMenu 未定义，这里注释掉
        // projectMenu.style.top = e.pageY + 'px';
        // projectMenu.style.left = e.pageX + 'px';
        // projectMenu.style.display = 'block';
      });
    }
  }


  // 点击其他区域隐藏菜单
  document.addEventListener('click', e => {
    if (!e.target.classList.contains('context-menu')) {
      contextMenu.style.display = 'none';
      // projectMenu.style.display = 'none';
    }
  });

  function loadProjectPoolData() {
    fetch('/passback/getReceivedData')
            .then(response => response.json())
            .then(data => {
              renderProjectPool(data);
            })
            .catch(error => {
              document.getElementById('projectPool').innerHTML = '加载失败，请稍后重试。';
              console.error('Error fetching project data:', error);
            });
  }

  function renderProjectPool(data) {
    const container = document.getElementById('projectPool');
    container.innerHTML = '';
    if (data.length === 0) {
      container.innerHTML = '暂无项目数据。';
      return;
    }

    data.forEach(item => {
      const card = document.createElement('div');

      card.className = 'project-card';

      const scheduleColor = item.schedule_color || 'null';
      card.classList.add(scheduleColor);
      card.textContent = item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0) + " " + item.remark + " " +"(" + item.scheduleDays + "天)" ;

      card.setAttribute('data-sizecoding', item.sample_model + " " + item.materialCode + " "+ item.sample_leader.charAt(0) + " "+item.remark );
      card.setAttribute('data-sample_id', item.sample_id || '');
      card.setAttribute('data-sample_name', item.sample_name || '');
      card.setAttribute('data-sample_model', item.sample_model || '');
      card.setAttribute('data-materialCode', item.materialCode || '');
      card.setAttribute('data-sample_category', item.sample_category || '');
      card.setAttribute('data-version', item.version || '');
      card.setAttribute('data-priority', item.priority || '');
      card.setAttribute('data-sample_leader', item.sample_leader || '');
      card.setAttribute('data-supplier', item.supplier || '');
      card.setAttribute('data-test_project_category', item.testProjectCategory || '');
      card.setAttribute('data-test_projects', item.testProjects || '');
      card.setAttribute('data-schedule', item.schedule || '');
      card.setAttribute('data-create_time', item.create_time || '');
      card.setAttribute('data-schedule_days', item.scheduleDays != null ? item.scheduleDays : '1');
      card.setAttribute('data-schedule_color', item.schedule_color != null ? item.schedule_color : '');
      card.setAttribute('data-remark', item.remark != null ? item.remark : '');
      card.setAttribute('draggable', 'true');

      setDraggable(card, true);
      bindCardContextMenu(card, item);
      container.appendChild(card);
    });
  }

  // 页面加载后请求数据
  window.onload = function () {
    // 加载项目池子数据
    loadProjectPoolData(); // ✅ 页面初始化调用加载函数
    // 加载待送样池子数据
    loadPendingSamplePoolData();

    // 模态框关闭
    document.getElementById('infoCloseBtn').onclick = function () {
      document.getElementById('modal').style.display = 'none';
    };
    document.getElementById('modal').onclick = function (e) {
      if (e.target.id === 'modal') {
        document.getElementById('modal').style.display = 'none';
      }
    };

    // 关闭变更记录模态框
    document.getElementById('closeChangeLogBtn').onclick = function () {
      document.getElementById('changeLogModal').style.display = 'none';
    };
    document.getElementById('changeLogModal').onclick = function (e) {
      if (e.target.id === 'changeLogModal') {
        document.getElementById('changeLogModal').style.display = 'none';
      }
    };

  };

  // 项目卡片右键触发的绑定事件
  function bindCardContextMenu(card, item) {
    card.oncontextmenu = function (event) {
      event.preventDefault(); // 阻止浏览器默认右键菜单

      console.log("这个触发bindCardContextMenu")

      // 设置模态框内容
      document.getElementById('modalBody').innerHTML = `
            <!--            <p><strong>电气编号：</strong>${item.sample_id}</p>-->
            <div style="display: flex; align-items: center; gap: 10px;">
                <p><strong>电气编号：</strong></p>
                <input type="text" id="editSampleId" value="${item.sample_id}">
                <button id="editSampleIdBtn">修改</button>
            </div>
            <p><strong>项目名称：</strong>${item.sample_name}</p>
            <p><strong>大小编码：</strong>${item.sample_model + ' ' + item.materialCode}</p>
            <p><strong>产品类别：</strong>${item.sample_category}</p>
            <p><strong>版本：</strong>${item.version}</p>
            <p><strong>优先级：</strong>${item.priority}</p>
            <p><strong>项目负责人：</strong>${item.sample_leader}</p>
            <p><strong>供应商：</strong>${item.supplier}</p>
            <p><strong>试验项目类别：</strong>${item.testProjectCategory}</p>
            <p><strong>测试子项目：</strong>${item.testProjects}</p>
            <p><strong>状态：</strong>${getScheduleText(item.schedule)}</p>
            <p><strong>创建时间：</strong>${item.create_time}</p>
        `;

      document.getElementById('scheduleDays').value = item.scheduleDays != null ? item.scheduleDays : '';
      // 设置选中的颜色，默认选无色
      const selectedColor = item.schedule_color ? item.schedule_color : 'null';
      const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
      if (colorRadio) {
        colorRadio.checked = true;
      }

      document.getElementById('sampleRemark').value = item.remark;

      document.getElementById('saveScheduleBtn').onclick = function () {
        saveScheduleAndColor(card,item);
      };

      document.getElementById('confirmColorBtn').onclick = function () {
        saveScheduleAndColor(card,item);
      };

      document.getElementById('saveRemarkBtn').onclick = function () {
        saveScheduleAndColor(card,item);
      };


      document.getElementById('modal').style.display = 'block';

      // 绑定修改电气编号按钮点击事件
      document.getElementById('editSampleIdBtn').addEventListener('click', function () {
        const newSampleId = document.getElementById('editSampleId').value;
        const oldSampleId = item.sample_id;

        // 发送请求到控制层
        fetch('/scheduleBoard/updateElectricSampleId', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            oldSampleId: oldSampleId,
            newSampleId: newSampleId
          })
        })
                .then(response => response.json())
                .then(result => {
                  if (result.success) {
                    alert(result.message);
                    loadProjectPoolData();
                    loadPendingSamplePoolData();

                  } else {
                    alert(result.message);
                  }
                })
                .catch(error => {
                  console.error('修改电气编号时出错:', error);
                  alert('修改电气编号时出错，请稍后重试');
                });
      });

    };

    // 添加点击事件监听
    card.addEventListener('click', () => {
      checkSimilarCodes(card);
    });


  }


  // 让卡片闪烁的方法
  function blinkCards(cards) {
    const blinkInterval = 500; // 闪烁间隔（毫秒）
    const blinkCount = 3; // 闪烁次数
    let count = 0;
    const intervalId = setInterval(() => {
      cards.forEach(card => {
        card.style.opacity = card.style.opacity === '0.5' ? '1' : '0.5';
      });
      count++;
      if (count >= blinkCount * 2) {
        clearInterval(intervalId);
        cards.forEach(card => {
          card.style.opacity = '1';
        });
      }
    }, blinkInterval);
  }

  // 检查大编码是否相似的方法
  function checkSimilarCodes(clickedCard) {
    const clickedLargeCode = clickedCard.getAttribute('data-sample_model');
    const allProjectCards = document.querySelectorAll('.project-card');
    const allScheduleCells = document.querySelectorAll('#scheduleBoardTable td[data-sample_model]');
    const similarElements = [];

    // 检查项目卡片
    allProjectCards.forEach(card => {
      if (card !== clickedCard) {
        const currentLargeCode = card.getAttribute('data-sample_model');
        if (currentLargeCode === clickedLargeCode) {
          similarElements.push(card);
        }
      }
    });

    // 检查排期面板单元格
    allScheduleCells.forEach(cell => {
      const currentLargeCode = cell.getAttribute('data-sample_model');
      if (currentLargeCode === clickedLargeCode) {
        similarElements.push(cell);
      }
    });

    if (similarElements.length > 0) {
      similarElements.push(clickedCard);
      blinkCards(similarElements);
    }
  }


  function saveScheduleAndColor(card, item) {
    const days = document.getElementById('scheduleDays').value;

    let selectedColor = document.querySelector('input[name="schedule_color"]:checked')?.value;
    if (!selectedColor) {
      alert("请选择一个颜色！");
      return;
    }

    const remark = document.getElementById('sampleRemark').value;
    console.log("remark777",remark);

    const startDateCell = document.querySelector(`td[data-sample_id="${item.sample_id}"]`);
    let startDate = null;
    let tester = null;
    let job_number = null;
    let originalDays = null;

    if (startDateCell) {
      startDate = startDateCell.getAttribute('data-date');
      tester = startDateCell.getAttribute('data-tester');
      job_number = startDateCell.getAttribute('data-job_number');
      originalDays = startDateCell.getAttribute("data-schedule_days");

      if (!startDate) {
        console.error('无法获取排期开始日期');
        return;
      }

      const allCells = document.querySelectorAll('.drop-cell');
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(startDateObj);
      endDateObj.setDate(endDateObj.getDate() + Math.ceil(days) - 1);
      const newEndDate = endDateObj.toISOString().split('T')[0];

      const newDateRange = getDateRange(startDate, newEndDate);
      for (const date of newDateRange) {
        const cellsOnDate = Array.from(allCells).filter(cell =>
                cell.getAttribute('data-date') === date &&
                cell.getAttribute('data-tester') === tester &&
                cell.innerText.trim() !== '' &&
                cell.getAttribute('data-sample_id') !== item.sample_id
        );
        if (cellsOnDate.length > 0) {
          alert('新排期会占用已有项目，请重新选择排期天数！');
          return;
        }
      }

      const existingIndex = localScheduleChanges.findIndex(change => change.sample_id === item.sample_id);
      if (existingIndex !== -1) {
        localScheduleChanges[existingIndex].start_date = startDate;
        localScheduleChanges[existingIndex].end_date = newEndDate;
        localScheduleChanges[existingIndex].scheduleDays = days;
        localScheduleChanges[existingIndex].schedule_color = selectedColor;
        localScheduleChanges[existingIndex].tester = tester;
        localScheduleChanges[existingIndex].job_number = job_number;
      } else {
        const newChange = {
          change: "add",
          sample_id: item.sample_id,
          tester: tester,
          start_date: startDate,
          end_date: newEndDate,
          scheduleDays: days,
          schedule_color: selectedColor,
          job_number: job_number
        };
        localScheduleChanges.push(newChange);
      }

      console.log("标记5", localScheduleChanges);
    }

    // 合并后的接口请求
    fetch('/schedule/saveScheduleInfo', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        sample_id: item.sample_id,
        scheduleDays: days,
        schedule_color: selectedColor,
        remark: remark
      })
    })
            .then(resp => resp.json())
            .then(result => {
              alert("排期天数和颜色设置成功！");
              document.getElementById('modal').style.display = 'none';

              // 更新卡片
              if (card) {
                console.log("days",days)
                card.textContent = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${remark} (${days}天)`;
                card.setAttribute('data-schedule_days', days || '1');

                card.classList.remove('gray', 'green', 'yellow', 'red');
                card.setAttribute('data-remark',remark);
                card.classList.add(selectedColor);
                card.dataset.schedule_color = selectedColor;

                //这里是让卡片重现赋值新修改的值
                item.scheduleDays = days;
                item.schedule_color = selectedColor;
                item.remark = remark;
              }

              // 更新排期面板
              const cells = document.querySelectorAll(`td[data-sample_id="${item.sample_id}"]`);
              cells.forEach(cell => {
                cell.setAttribute('colspan', Math.ceil(days));
                cell.setAttribute('data-schedule_days', days);
                cell.setAttribute('data-remark', remark);

                cell.innerText = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${remark} (${days}天)`;
                console.log("selectedColor111:"+selectedColor)
                if (selectedColor === null || selectedColor === "null") {
                  selectedColor = "white"
                }

                cell.style.backgroundColor = selectedColor;
                cell.dataset.schedule_color = selectedColor;

                const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
                const startIndex = rowCells.indexOf(cell);
                for (let i = startIndex; i < startIndex + originalDays; i++) {
                  if (rowCells[i]) rowCells[i].style.display = '';
                }
                for (let i = startIndex + 1; i < startIndex + Math.ceil(days); i++) {
                  if (rowCells[i]) rowCells[i].style.display = 'none';
                }
              });

            })
            .catch(err => {
              console.error("保存失败：", err);
              alert("保存失败，请重试！");
            });

    setTimeout(() => {
      saveSchedule(true);
    }, 2000); // 2000 毫秒 = 2 秒

  }

  async function saveSchedule(isRefrenshBtn) {
    if (!localScheduleChanges || localScheduleChanges.length === 0 ) {
      if(!isRefrenshBtn){
        alert('没有需要保存的排期变更');
      }
      return;
    }

    try {
      const response = await fetch('/scheduleBoard/saveSchedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(localScheduleChanges)
      });

      if (!response.ok) {
        throw new Error(`保存失败: ${response.statusText}`);
      }

      const result = await response.json(); // 确保解析 JSON

      alert(result.message+result.statusSummary);

      // 清空本地缓存
      localScheduleChanges = [];
    } catch (error) {
      console.error('保存排期失败:', error);
      alert('保存失败，请稍后重试！');
    }
  }

  async function refreshSchedule() {
    await saveSchedule(true); // 确保 saveSchedule 执行完毕
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    if (!startDate) {
      alert("请至少选择初始时间！");
      return;
    }

    const contextMenu = document.getElementById('contextMenu');
    contextMenu.removeEventListener('click', handleContextMenuClick);

    document.getElementById('scheduleBoard').innerHTML = '';

    // 加载排期面板数据
    fetch(`/getSchedulesByStartDate?startDate=${startDate}&endDate=${endDate}`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(async data => {
              const board = document.getElementById('scheduleBoard');

              const allDatesSet = new Set();
              const dateMap = {}; // tester => array of tasks

              data.forEach(item => {
                const task = {
                  startDate: item.schedule_start_date,
                  endDate: item.schedule_end_date,
                  sample_id: item.sample_id,
                  sizecoding: item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0) + " "+item.remark,
                  sample_category: item.sample_category,
                  sample_model: item.sample_model,
                  sample_name: item.sample_name,
                  priority: item.priority,
                  version: item.version,
                  materialCode: item.materialCode,
                  sample_leader: item.sample_leader,
                  supplier: item.supplier,
                  test_project_category: item.testProjectCategory,
                  testProjects: item.testProjects,
                  schedule: item.schedule,
                  create_time: item.create_time,
                  schedule_days: item.scheduleDays,
                  schedule_start_date: item.schedule_start_date,
                  schedule_end_date: item.schedule_end_date,
                  schedule_color: item.schedule_color,
                  job_number: item.job_number,
                  remark: item.remark
                };

                const tester = item.tester || '未知测试人员';
                if (!dateMap[tester]) dateMap[tester] = [];
                dateMap[tester].push(task);

                const dateRange = getDateRange(item.schedule_start_date, item.schedule_end_date);
                dateRange.forEach(date => allDatesSet.add(date));
              });

              // 👉 强制覆盖日期：使用用户选择的完整日期范围
              getDateRange(startDate, endDate).forEach(date => allDatesSet.add(date));
              const allDates = Array.from(allDatesSet).sort();

              // 👉 不使用 data 中的 tester，统一从 /getTesters 获取
              try {
                const testersResponse = await fetch('/getTesters');
                const testersData = await testersResponse.json();

                drawScheduleBoard(board, testersData, allDates, dateMap);
              } catch (error) {
                console.error("获取测试人员失败:", error);
                document.getElementById('scheduleBoard').innerHTML = '测试人员加载失败。';
              }
            })
            .catch(error => {
              document.getElementById('scheduleBoard').innerHTML = '排期加载失败。';
              console.error('Error loading schedule board:', error);
            });
  }

  function groupTestersByCategory(testers) {
    const groupMap = {};

    testers.forEach(tester => {
      const group = tester.responsible_category || '未分组';
      if (!groupMap[group]) {
        groupMap[group] = [];
      }
      groupMap[group].push(tester);
    });

    return groupMap;
  }

  // 绘制排期面板
  function drawScheduleBoard(board, testers, allDates, dateMap) {
    let html = '<table id="scheduleBoardTable" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse;">';

    // 表头
    html += '<thead><tr>';
    html += '<th>组别</th>';
    html += '<th style="min-width: 100px;">测试人员</th>';
    allDates.forEach(date => {
      const dateObj = new Date(date);
      const dayOfWeek = dateObj.getDay();
      let displayText = date;
      // 新增逻辑，判断是否为周六或周日并添加对应文字
      if (dayOfWeek === 6) {
        displayText = `${date}<br>周六`;
      } else if (dayOfWeek === 0) {
        displayText = `${date}<br>周日`;
      }
      html += `<th>${displayText}</th>`;
    });
    html += '</tr></thead><tbody>';

    const groupedTesters = groupTestersByCategory(testers);

    // ⭐⭐ 新增：组别顺序数组
    const groupOrder = ['线材组', '新人', '视频组', '数据网通组', '蓝牙组' ,"耳机组","PC", "高频组"]; // 按你的需求改顺序

    // ⭐⭐ 新增：先按照 groupOrder 遍历
    groupOrder.forEach(groupName => {
      const groupTesters = groupedTesters[groupName];
      if (!groupTesters) return; // 如果某组没人，跳过

      const groupRowSpan = groupTesters.length;

      groupTesters.forEach((tester, testerIndex) => {
        const testerName = tester.test_engineer_name;
        const jobNumber = tester.engineer_id;

        html += '<tr>';

        if (testerIndex === 0) {
          html += `<td rowspan="${groupRowSpan}" style="text-align: center; font-weight: bold;">${groupName}</td>`;
        }

        html += `<td><strong>${testerName}</strong></td>`;

        let colIndex = 0;
        while (colIndex < allDates.length) {
          const currentDate = allDates[colIndex];
          const task = dateMap[testerName]?.find(t => t.startDate === currentDate);

          const dateObj = new Date(currentDate);
          const dayOfWeek = dateObj.getDay();
          // 新增：判断是否为周六或周日，添加 weekend-border 类名
          let weekendClass = '';
          if (dayOfWeek === 6 || dayOfWeek === 0) {
            weekendClass = 'weekend-border';
          }

          if (task) {
            // const rangeDates = getDateRange(task.startDate, task.endDate);
            const colspan = Math.ceil(task.schedule_days);

            html += createTaskCell(task, testerName, currentDate, colspan, weekendClass);

            for (let i = 1; i < colspan; i++) {
              let styleAttr = 'style="display: none;"';
              if (weekendClass) {
                styleAttr += ` class="${weekendClass}"`;
              }
              html += `<td class="drop-cell" ${styleAttr} data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${allDates[colIndex + i]}"></td>`;
            }
            colIndex += colspan;
          } else {
            const isCovered = dateMap[testerName]?.some(t => t.startDate < currentDate && t.endDate >= currentDate);
            if (!isCovered) {
              // 修改：添加 weekendClass 类名
              let cellHtml = `<td class="drop-cell ${weekendClass}" data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${currentDate}">`;
              html += cellHtml + `</td>`;
            }
            colIndex += 1;
          }
        }

        html += '</tr>';
      });
    });

    html += '</tbody></table>';
    board.innerHTML = html;

    // 为任务单元格添加拖拽事件
    const assignedCells = document.querySelectorAll('#scheduleBoardTable td.assigned');
    assignedCells.forEach(cell => {
      cell.setAttribute('draggable', 'true');
      cell.addEventListener('dragstart', e => {
        const taskData = {};
        const attributes = [
          'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
          'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
          'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
          'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
        ];
        attributes.forEach(attr => {
          taskData[attr] = cell.getAttribute(`data-${attr}`);
        });
        Object.entries(taskData).forEach(([key, value]) => {
          e.dataTransfer.setData(`project-${key}`, value);
        });
      });
    });

    const cells = document.querySelectorAll('.drop-cell');

    // 定义待送样池子的容器 ID 数组
    const pendingSampleContainerIds = [
      'projectPool',
      'videoSamplePool',
      'wireSamplePool',
      'dataSamplePool',
      'bluetoothSamplePool',
      'highFrequencySamplePool'
    ];

    // 调用通用函数为待送样池子的容器添加拖拽事件
    addDragEventsToContainers(pendingSampleContainerIds);

    cells.forEach((cell, cellIndex, cellList) => {
      cell.addEventListener('dragover', e => {
        e.preventDefault();

        cell.classList.add('over');

        // 自动滚动逻辑
        const scrollSpeed = 10; // 滚动速度
        const triggerDistance = 50; // 触发滚动的距离
        const viewportHeight = window.innerHeight;
        const { clientY } = e;

        // 靠近顶部，向上滚动
        if (clientY < triggerDistance) {
          window.scrollBy(0, -scrollSpeed);
        }
        // 靠近底部，向下滚动
        else if (clientY > viewportHeight - triggerDistance) {
          window.scrollBy(0, scrollSpeed);
        }
      });

      cell.addEventListener('dragleave', () => cell.classList.remove('over'));

      cell.addEventListener('drop', e => {
        e.preventDefault();
        cell.classList.remove('over');

        const sample_id = e.dataTransfer.getData('project-sample_id');
        const days = parseFloat(e.dataTransfer.getData('project-days')) || 1;
        const sizecoding = e.dataTransfer.getData('project-sizecoding') || 1;

        const tester = cell.getAttribute('data-tester');
        const job_number = cell.getAttribute('data-job_number');
        const startDate = cell.getAttribute('data-date');

        const schedule_days = parseFloat(e.dataTransfer.getData('project-schedule_days')) || 1;

        if ((!sample_id || sample_id.trim() === "")) {
          console.warn("无效拖拽内容：sample_id 和 schedule_days 都为空，忽略本次拖拽。");
          return;
        }

        const startDateObj = new Date(startDate);
        startDateObj.setDate(startDateObj.getDate() + Math.ceil(schedule_days) - 1);
        const schedule_end_date = startDateObj.toISOString().split('T')[0];

        const taskData = {
          sample_id,
          days,
          sizecoding,
          tester,
          job_number,
          startDate,
          sample_name: e.dataTransfer.getData('project-sample_name'),
          sample_model: e.dataTransfer.getData('project-sample_model'),
          materialCode: e.dataTransfer.getData('project-materialCode'),
          sample_category: e.dataTransfer.getData('project-sample_category'),
          version: e.dataTransfer.getData('project-version'),
          priority: e.dataTransfer.getData('project-priority'),
          sample_leader: e.dataTransfer.getData('project-sample_leader'),
          supplier: e.dataTransfer.getData('project-supplier'),
          test_project_category: e.dataTransfer.getData('project-test_project_category'),
          test_projects: e.dataTransfer.getData('project-test_projects'),
          schedule: e.dataTransfer.getData('project-schedule'),
          create_time: e.dataTransfer.getData('project-create_time'),
          schedule_days: e.dataTransfer.getData('project-schedule_days'),
          schedule_start_date: startDate,
          schedule_end_date: schedule_end_date,
          schedule_color: e.dataTransfer.getData('project-schedule_color'),
          remark: e.dataTransfer.getData('project-remark')
        };

        const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
        const startIndex = rowCells.indexOf(cell);
        const roundedDays = Math.ceil(parseFloat(schedule_days));

        // 检查排期是否超出可排范围
        if (startIndex + roundedDays > rowCells.length) {
          alert("排期超出可排范围！请设置更广泛的日期");
          return;
        }

        // 检查排期区域是否已被占用
        for (let i = startIndex; i < startIndex + roundedDays; i++) {
          if (rowCells[i].innerText.trim() !== '') {

            const confirmInsert = confirm('插入位置已被占用，是否将后续项目往后挪？');
            if (!confirmInsert) {
              return;
            }
          }
        }

        // 新增对后续项目没位置的判断
        let conflictCells = [];
        for (let i = startIndex; i < startIndex + roundedDays; i++) {
          if (rowCells[i].innerText.trim() !== '') {
            conflictCells.push(rowCells[i]);

          }
        }
        const projectsToMove = [];
        let diff;
        if (conflictCells.length > 0) {
          // 找到所有需要往后挪的项目
          let currentIndex = startIndex;
          while (currentIndex < rowCells.length) {
            const currentCell = rowCells[currentIndex];
            if (currentCell.innerText.trim() !== '') {
              const projectSpan = parseInt(currentCell.getAttribute('colspan')) || 1;
              const projectData = {};
              const attributes = [
                'sample_id', 'sizecoding', 'tester', 'job_number', 'sample_name',
                'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
              ];
              attributes.forEach(attr => {
                projectData[attr] = currentCell.getAttribute(`data-${attr}`);
              });
              projectsToMove.push({
                startIndex: currentIndex,
                span: projectSpan,
                data: projectData
              });
              currentIndex += projectSpan;
            } else {
              currentIndex++;
            }
          }


          let minStartIndex = Infinity;  // 初始化最小的 startIndex 值
          let maxStartIndex = Infinity;  // 初始化最小的 startIndex 值
          let maxSpan = Infinity;  // 初始化最小的 startIndex 值
          let maxSample_id = '';
          // 找到最小的 startIndex
          minStartIndex = Math.min(...projectsToMove.map(project => project.startIndex));
          maxStartIndex = Math.max(...projectsToMove.map(project => project.startIndex));
          maxSpan = Math.max(...projectsToMove.map(project => project.span));
          maxSample_id = projectsToMove[0].data.sample_id;


          // 计算拖拽项目与最小startIndex的差值
          diff = roundedDays - minStartIndex + startIndex;


          if(maxSample_id === sample_id){
            alert("请先移动到别的地方（例如项目池子或者空的日期），再拖拽回来")
            return;
          }

          if (maxStartIndex + diff + maxSpan > rowCells.length ) {
            alert("后续项目移动后超出可排范围！");
            return;
          }

        }

        // 确认可以放置项目后，再清空原排期
        const originalCell = document.querySelector(`td[data-sample_id="${sample_id}"]`);
        if (originalCell) {
          const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
          const originalStartIndex = originalRowCells.indexOf(originalCell);
          const originalScheduleDays = Math.ceil((originalCell.getAttribute('data-schedule_days')) || 1);

          // 清除原单元格内容和属性
          originalCell.innerText = '';
          originalCell.removeAttribute('colspan');
          originalCell.classList.remove('assigned');
          originalCell.style.backgroundColor = '';

          const allowedAttributes = ['class', 'data-tester', 'data-date','data-job_number'];
          [...originalCell.attributes].forEach(attr => {
            if (!allowedAttributes.includes(attr.name)) {
              originalCell.removeAttribute(attr.name);
            }
          });

          // 恢复被隐藏的格子,项目拖拽到别的地方，先触发这里
          for (let i = originalStartIndex; i < Math.min(originalStartIndex + originalScheduleDays, originalRowCells.length); i++) {
            if (originalRowCells[i]){
              originalRowCells[i].style.display = '';

              // 新增：复原周六和周日的边框样式
              const date = originalRowCells[i].getAttribute('data-date');
              console.log("date",date)
              console.log("i",i)
              setWeekendBorder(originalRowCells[i], date);
            }

          }
        }


        handleDrop(cell, cellList, taskData,  conflictCells ,projectsToMove ,diff );
      });

      cell.addEventListener('contextmenu', e => {
        e.preventDefault();
        if (cell.innerText.trim() === '') return;
        currentRightClickCell = cell;
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.display = 'block';
      });
    });

    const contextMenu = document.getElementById('contextMenu');
    contextMenu.addEventListener('click', handleContextMenuClick);

    document.querySelectorAll('#scheduleBoardTable td[data-schedule_color]').forEach(cell => {
      const color = cell.getAttribute('data-schedule_color');
      if (color) {
        cell.style.backgroundColor = color;
      }
    });
  }

  // 创建排期面板的单元格
  function createTaskCell(task, tester, currentDate, colspan, weekendClass) {
    let classAttribute = 'drop-cell assigned';
    if (weekendClass) {
      classAttribute += ` ${weekendClass}`;
    }
    return `
        <td class="drop-cell assigned"
          data-tester="${tester}"
          data-date="${currentDate}"
          data-job_number="${task.job_number}"
          colspan="${colspan}"
          data-sample_id="${task.sample_id || ''}"
          data-sample_name="${task.sample_name || ''}"
          data-sample_model="${task.sample_model || ''}"
          data-materialCode="${task.materialCode || ''}"
          data-sample_category="${task.sample_category || ''}"
          data-version="${task.version || ''}"
          data-priority="${task.priority || ''}"
          data-sample_leader="${task.sample_leader || ''}"
          data-supplier="${task.supplier || ''}"
          data-test_project_category="${task.test_project_category || ''}"
          data-test_projects="${task.test_projects || ''}"
          data-schedule="${task.schedule || ''}"
          data-create_time="${task.create_time || ''}"
          data-schedule_days="${task.schedule_days || ''}"
          data-sizecoding="${task.sizecoding || ''}"
          data-schedule_start_date="${task.schedule_start_date || ''}"
          data-schedule_end_date="${task.schedule_end_date || ''}"
          data-schedule_color="${task.schedule_color || ''}"
          data-remark="${task.remark || ''}"
          ${classAttribute}
          >${task.sizecoding} (${task.schedule_days}天)</td>
      `;
  }

  function handleContextMenuClick() {
    // 关闭右键菜单
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'none';
  }



  // 处理拖拽放下事件
  function handleDrop(cell, cellList, taskData, conflictCells ,projectsToMove ,diff ) {
    const { sample_id, days, sizecoding, tester, job_number, startDate, schedule_days, schedule_color } = taskData;
    const roundedDays = Math.ceil(parseFloat(schedule_days)); // 使用 schedule_days 确定合并单元格数量
    const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
    const startIndex = rowCells.indexOf(cell);

    if (conflictCells.length > 0) {
      // 从后往前移动项目
      for (let i = projectsToMove.length - 1; i >= 0; i--) {
        const { startIndex: projectStartIndex, span, data } = projectsToMove[i];
        const newStartIndex = projectStartIndex + diff;
        console.log("项目起始位置: ", projectStartIndex);
        console.log("挪动的天数: ", diff);
        console.log("新的起始位置: ", newStartIndex);

        // 清除原项目
        const originalStartCell = rowCells[projectStartIndex];
        originalStartCell.innerText = '';
        originalStartCell.removeAttribute('colspan');
        originalStartCell.classList.remove('assigned');
        originalStartCell.style.backgroundColor = '';
        const allowedAttributes = ['class', 'data-tester', 'data-date'];
        [...originalStartCell.attributes].forEach(attr => {
          if (!allowedAttributes.includes(attr.name)) {
            originalStartCell.removeAttribute(attr.name);
          }
        });

        // 恢复被隐藏的格子
        for (let j = projectStartIndex; j < projectStartIndex + span; j++) {
          if (rowCells[j]) rowCells[j].style.display = '';
        }


        // 创建新项目
        const newStartCell = rowCells[newStartIndex];
        newStartCell.innerText = `${data.sizecoding} (${data.schedule_days}天)`;
        newStartCell.classList.add('assigned');
        newStartCell.style.backgroundColor = data.schedule_color || "";
        newStartCell.setAttribute('colspan', span);
        Object.keys(data).forEach(key => {
          if (key !== 'days') {
            newStartCell.setAttribute(`data-${key}`, data[key]);
          }
        });
        for (let j = newStartIndex + 1; j < newStartIndex + span; j++) {
          rowCells[j].style.display = 'none';
        }
        // 更新 localScheduleChanges
        const newEndDate = rowCells[newStartIndex + span - 1].getAttribute('data-date');
        const newChange = {
          change: "add",
          sample_id: data.sample_id,
          tester: data.tester,
          start_date: rowCells[newStartIndex].getAttribute('data-date'),
          end_date: newEndDate,
          scheduleDays: data.schedule_days,
          schedule_color: data.schedule_color,
          job_number: data.job_number
        };
        const existingIndex = localScheduleChanges.findIndex(item =>
                item.sample_id === data.sample_id
        );
        if (existingIndex !== -1) {
          localScheduleChanges[existingIndex] = newChange;
        } else {
          localScheduleChanges.push(newChange);
        }
        console.log("标记6",localScheduleChanges)

        // 添加允许拖拽的方法
        newStartCell.setAttribute('draggable', 'true');
        newStartCell.addEventListener('dragstart', function (e) {
          const taskData = {};
          const attributes = [
            'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
            'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
            'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
            'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
          ];
          attributes.forEach(attr => {
            taskData[attr] = this.getAttribute(`data-${attr}`);
          });
          Object.entries(taskData).forEach(([key, value]) => {
            e.dataTransfer.setData(`project-${key}`, value);
          });
        });
      }
    }

    // 如果是已有项目拖动进来，先清除原位置
    const oldIndex = rowCells.findIndex(c => c.getAttribute('data-sample_id') === sample_id);
    if (oldIndex !== -1) {
      const span = parseInt(rowCells[oldIndex].getAttribute('colspan') || 1, 10);

      rowCells[oldIndex].innerText = '';
      rowCells[oldIndex].removeAttribute('colspan');
      rowCells[oldIndex].classList.remove('assigned');
      rowCells[oldIndex].style.backgroundColor = '';
      const allowedAttributes = ['class', 'data-tester', 'data-date'];
      [...rowCells[oldIndex].attributes].forEach(attr => {
        if (!allowedAttributes.includes(attr.name)) {
          rowCells[oldIndex].removeAttribute(attr.name);
        }
      });
      for (let i = oldIndex; i < oldIndex + span; i++) {
        if (rowCells[i]) rowCells[i].style.display = '';

      }
    }


    // 放置新插入的项目
    const startCell = rowCells[startIndex];
    startCell.innerText = `${sizecoding} (${schedule_days}天)`;
    startCell.classList.add('assigned');
    startCell.style.backgroundColor = schedule_color || "";
    startCell.setAttribute('colspan', roundedDays);
    Object.keys(taskData).forEach(key => {
      if (key !== 'days') {
        startCell.setAttribute(`data-${key}`, taskData[key]);
      }
    });
    for (let i = startIndex + 1; i < startIndex + roundedDays; i++) {
      rowCells[i].style.display = 'none';
    }
    const projectEl = document.querySelector(`.project-card[data-sample_id="${sample_id}"]`);
    if (projectEl) projectEl.remove();
    const endDate = rowCells[startIndex + roundedDays - 1].getAttribute('data-date');
    // 构造新的变更对象
    const newChange = {
      change: "add",
      sample_id: sample_id,
      tester,
      start_date: startDate,
      end_date: endDate,
      scheduleDays: schedule_days,
      schedule_color: schedule_color,
      job_number: job_number
    };
    // 查找并更新已有记录（如果存在），否则添加
    const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
    );
    if (existingIndex !== -1) {
      localScheduleChanges[existingIndex] = newChange;
    } else {
      localScheduleChanges.push(newChange);
    }
    console.log("标记7",localScheduleChanges);
    // 重新为新生成的排期单元格添加拖拽功能
    startCell.setAttribute('draggable', 'true');
    startCell.addEventListener('dragstart', function (e) {
      const taskData = {};
      const attributes = [
        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color' , 'remark'
      ];
      attributes.forEach(attr => {
        taskData[attr] = this.getAttribute(`data-${attr}`);
      });
      Object.entries(taskData).forEach(([key, value]) => {
        e.dataTransfer.setData(`project-${key}`, value);
      });
    });
  }


  // 处理撤回排期事件，撤回排期按钮触发这个方法
  function handleUndo(rowCells, startIndex, taskData, container) {
    const { schedule_days, sample_id } = taskData;
    const currentRightClickCell = rowCells[startIndex];

    // 清除原始内容和属性
    currentRightClickCell.innerText = '';
    currentRightClickCell.removeAttribute('colspan');
    currentRightClickCell.classList.remove('assigned');

    const allowedAttributes = ['class', 'data-tester', 'data-date','data-job_number'];
    [...currentRightClickCell.attributes].forEach(attr => {
      if (!allowedAttributes.includes(attr.name)) {
        currentRightClickCell.removeAttribute(attr.name);
      }
    });

    // 恢复被隐藏的格子
    for (let i = startIndex; i < Math.min(startIndex + Number(schedule_days), rowCells.length); i++) {
      if (rowCells[i]){
        console.log("标记2");
        rowCells[i].style.display = '';
      }
    }

    // 重新生成拖拽项目卡片
    const restoredProject = document.createElement('div');
    restoredProject.className = 'project-card';

    // ✅ 设置颜色 class（默认 gray）
    const colorClass = taskData.schedule_color || 'gray';
    restoredProject.classList.add(colorClass);

    restoredProject.setAttribute('draggable', 'true');
    restoredProject.setAttribute('data-sample_id', sample_id);
    restoredProject.setAttribute('data-schedule_days', schedule_days);
    //   这里
    restoredProject.textContent = `${taskData.sizecoding} (${schedule_days}天)`;


    //这里是撤回排期点击的时候，放回去的时候检查哪些标签去掉
    Object.keys(taskData).forEach(key => {
      if (key !== 'days' && key !== 'schedule_start_date' && key !== 'schedule_end_date' && key!== 'job_number'
              && key!== 'tester') {
        restoredProject.setAttribute(`data-${key}`, taskData[key]);
      }
    });

    setDraggable(restoredProject, true);

    const restoredItem = {
      sample_id: sample_id,
      sample_name: taskData.sample_name,
      sample_model: taskData.sample_model,
      materialCode: taskData.materialCode,
      sample_category: taskData.sample_category,
      version: taskData.version,
      priority: taskData.priority,
      sample_leader: taskData.sample_leader,
      supplier: taskData.supplier,
      testProjectCategory: taskData.test_project_category,
      testProjects: taskData.test_projects,
      schedule: taskData.schedule,
      create_time: taskData.create_time,
      scheduleDays: schedule_days,
      schedule_color: taskData.schedule_color,
      remark: taskData.remark
    };

    restoredProject.oncontextmenu = (event) => {
      event.preventDefault();
      bindCardContextMenu(restoredProject, restoredItem);
    };

    // const projectPool = document.getElementById('projectPool');
    // 这里是排期面板拖拽项目到池子的容器存放区域，我接下来要判定放在哪个池子，0605
    container.appendChild(restoredProject);
    // videoSamplePool.appendChild(restoredProject);


    // 记录删除操作到 localScheduleChanges，避免重复添加
    const newChange = {
      change: "delete",
      sample_id: sample_id,
      tester: taskData.tester,
      start_date: taskData.schedule_start_date,
      end_date: taskData.schedule_end_date,
      scheduleDays: schedule_days,
      schedule_color: taskData.schedule_color,
      job_number: taskData.job_number,
      container: container.id
    };

    const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
    );

    if (existingIndex !== -1) {
      localScheduleChanges[existingIndex] = newChange;
    } else {
      localScheduleChanges.push(newChange);
    }

    console.log("delete的",localScheduleChanges);
  }
  // 工具函数：生成某范围内所有日期字符串数组
  function getDateRange(start, end) {
    const dates = [];
    const current = new Date(start);
    const last = new Date(end);
    while (current <= last) {
      const yyyy = current.getFullYear();
      const mm = String(current.getMonth() + 1).padStart(2, '0');
      const dd = String(current.getDate()).padStart(2, '0');
      dates.push(`${yyyy}-${mm}-${dd}`);
      current.setDate(current.getDate() + 1);
    }
    return dates;
  }

  function showProjectAttributes(event) {
    if (event) {
      event.stopPropagation(); // 阻止事件冒泡
    }
    if (!currentRightClickCell) return;
    const taskData = {
      sample_id: currentRightClickCell.getAttribute('data-sample_id'),
      sample_name: currentRightClickCell.getAttribute('data-sample_name'),
      sample_model: currentRightClickCell.getAttribute('data-sample_model'),
      materialCode: currentRightClickCell.getAttribute('data-materialCode'),
      sample_category: currentRightClickCell.getAttribute('data-sample_category'),
      version: currentRightClickCell.getAttribute('data-version'),
      priority: currentRightClickCell.getAttribute('data-priority'),
      sample_leader: currentRightClickCell.getAttribute('data-sample_leader'),
      supplier: currentRightClickCell.getAttribute('data-supplier'),
      test_project_category: currentRightClickCell.getAttribute('data-test_project_category'),
      test_projects: currentRightClickCell.getAttribute('data-test_projects'),
      schedule: currentRightClickCell.getAttribute('data-schedule'),
      create_time: currentRightClickCell.getAttribute('data-create_time'),
      scheduleDays: currentRightClickCell.getAttribute('data-schedule_days'),
      schedule_color: currentRightClickCell.getAttribute('data-schedule_color'),
      remark: currentRightClickCell.getAttribute('data-remark')
    };

    // 设置模态框内容
    document.getElementById('modalBody').innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <p><strong>电气编号：</strong></p>
                <input type="text" id="editSampleId" value="${taskData.sample_id}">
                <button id="editSampleIdBtn">修改</button>
            </div>
            <p><strong>项目名称：</strong>${taskData.sample_name}</p>
            <p><strong>大小编码：</strong>${taskData.sample_model + ' ' + taskData.materialCode}</p>
            <p><strong>产品类别：</strong>${taskData.sample_category}</p>
            <p><strong>版本：</strong>${taskData.version}</p>
            <p><strong>优先级：</strong>${taskData.priority}</p>
            <p><strong>项目负责人：</strong>${taskData.sample_leader}</p>
            <p><strong>供应商：</strong>${taskData.supplier}</p>
            <p><strong>试验项目类别：</strong>${taskData.test_project_category}</p>
            <p><strong>测试子项目：</strong>${taskData.test_projects}</p>
            <p><strong>状态：</strong>${getScheduleText(taskData.schedule)}</p>
            <p><strong>创建时间：</strong>${taskData.create_time}</p>
        `;

    document.getElementById('scheduleDays').value = taskData.scheduleDays != null ? taskData.scheduleDays : '';
    // 设置选中的颜色，默认选无色
    const selectedColor = taskData.schedule_color ? taskData.schedule_color : 'null';
    const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
    if (colorRadio) {
      colorRadio.checked = true;
    }

    document.getElementById('sampleRemark').value = taskData.remark != null? taskData.remark : '';

    document.getElementById('saveScheduleBtn').onclick = function () {
      saveScheduleAndColor(null, taskData);
    };

    document.getElementById('confirmColorBtn').onclick = function () {
      saveScheduleAndColor(null, taskData);
    };

    document.getElementById('saveRemarkBtn').onclick = function () {
      saveScheduleAndColor(null, taskData);
    };

    document.getElementById('modal').style.display = 'block';

    // 关闭右键菜单
    const contextMenuForShow = document.getElementById('contextMenu');
    contextMenuForShow.style.display = 'none';

    // 绑定修改电气编号按钮点击事件
    document.getElementById('editSampleIdBtn').addEventListener('click', function () {
      const newSampleId = document.getElementById('editSampleId').value;
      const oldSampleId = taskData.sample_id;

      // 发送请求到控制层
      fetch('/scheduleBoard/updateElectricSampleId', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          oldSampleId: oldSampleId,
          newSampleId: newSampleId
        })
      })
              .then(response => response.json())
              .then(async result => {
                if (result.success) {
                  alert(result.message);
                  // 刷新排期面板
                  await refreshSchedule();

                } else {
                  alert(result.message);
                }
              })
              .catch(error => {
                console.error('修改电气编号时出错:', error);
                alert('修改电气编号时出错，请稍后重试');
              });
    });

  }


  function getScheduleText(code) {
    switch (code) {
      case "15":
        return "待排期";
      case "16":
        return "已排期待测试";
      case "0":
        return "测试中";
      case "1":
        return "待审核";
      case "2":
        return "审核完成";
      case "9":
        return "样品退样";
      case "10":
        return "竞品完成";
      default:
        return code || "";
    }
  }



  // 绑定变更记录按钮点击事件
  document.addEventListener('DOMContentLoaded', function () {
    const changeLogBtn = document.getElementById('changeLogBtn');
    changeLogBtn.addEventListener('click', function () {
      const sample_id = document.getElementById('modalBody').querySelector('p:nth-child(1)').textContent.split('：')[1].trim();
      fetch(`/api/getChangeLog?sample_id=${sample_id}`)
              .then(response => response.json())
              .then(data => {
                const changeLogBody = document.getElementById('changeLogBody');
                changeLogBody.innerHTML = '';

                if (data.length === 0) {
                  changeLogBody.innerHTML = '暂无变更记录。';
                } else {
                  const template = document.getElementById('changeLogTemplate').innerHTML;

                  data.forEach(change => {
                    let itemHTML = template
                            .replace('{{tester}}', change.tester)
                            .replace('{{startDate}}', change.startDate)
                            .replace('{{endDate}}', change.endDate)
                            .replace('{{updateTime}}', change.updateTime || '无')
                            .replaceAll('{{color}}', change.color)
                            .replace('{{used}}', change.used)
                            .replace('{{remark}}', change.remark)

                    changeLogBody.insertAdjacentHTML('beforeend', itemHTML);
                  });
                }

                document.getElementById('changeLogModal').style.display = 'block';
              })
              .catch(error => {
                console.error('获取变更记录失败:', error);
                document.getElementById('changeLogBody').innerHTML = '获取变更记录失败，请稍后重试。';
              });
    });

  });



  // 加载待送样池子数据
  function loadPendingSamplePoolData() {
    const categories = [
      { id: 'videoSamplePool', name: '视频类' },
      { id: 'wireSamplePool', name: '线材类' },
      { id: 'dataSamplePool', name: '数据类' },
      { id: 'bluetoothSamplePool', name: '蓝牙类' },
      { id: 'highFrequencySamplePool', name: '高频类' }
    ];

    categories.forEach(category => {
      fetch(`/passback/getPendingSampleData?category=${category.name}`)
              .then(response => response.json())
              .then(data => {
                renderPendingSamplePool(data, category.id);
              })
              .catch(error => {
                document.getElementById(category.id).innerHTML = '加载失败，请稍后重试。';
                console.error('Error fetching pending sample data:', error);
              });
    });
  }

  // 渲染待送样池子
  function renderPendingSamplePool(data, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    if (data.length === 0) {
      container.innerHTML = '暂无该类别待送样数据。';
      return;
    }

    data.forEach(item => {
      const card = document.createElement('div');
      card.className = 'project-card';

      const scheduleColor = item.schedule_color || 'null';
      card.classList.add(scheduleColor);
      card.textContent = item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0)  + " " + item.remark+ " " +"(" + item.scheduleDays + "天)";

      card.setAttribute('data-sizecoding', item.sample_model + " " + item.materialCode + " "+ item.sample_leader.charAt(0) + " " + item.remark );
      card.setAttribute('data-sample_id', item.sample_id || '');
      card.setAttribute('data-sample_name', item.sample_name || '');
      card.setAttribute('data-sample_model', item.sample_model || '');
      card.setAttribute('data-materialCode', item.materialCode || '');
      card.setAttribute('data-sample_category', item.sample_category || '');
      card.setAttribute('data-version', item.version || '');
      card.setAttribute('data-priority', item.priority || '');
      card.setAttribute('data-sample_leader', item.sample_leader || '');
      card.setAttribute('data-supplier', item.supplier || '');
      card.setAttribute('data-test_project_category', item.testProjectCategory || '');
      card.setAttribute('data-test_projects', item.testProjects || '');
      card.setAttribute('data-schedule', item.schedule || '');
      card.setAttribute('data-create_time', item.create_time || '');
      card.setAttribute('data-schedule_days', item.scheduleDays != null ? item.scheduleDays : '1');
      card.setAttribute('data-schedule_color', item.schedule_color != null ? item.schedule_color : '');
      card.setAttribute('data-remark', item.remark != null ? item.remark : '');
      card.setAttribute('draggable', 'true');

      setDraggable(card, false);
      bindCardContextMenu(card, item);
      container.appendChild(card);
    });
  }

  // 通用函数，为指定容器添加拖拽相关事件
  // ... existing code ...
  function addDragEventsToContainers(containerIds) {
    containerIds.forEach(containerId => {
      const container = document.getElementById(containerId);
      if (container) {
        // 为容器添加 dragover 事件监听器，阻止默认行为以允许放置
        container.addEventListener('dragover', e => {
          e.preventDefault();
        });

        // 为容器添加 drop 事件监听器，处理拖拽放下的逻辑
        container.addEventListener('drop', e => {
          e.preventDefault();
          console.log("拖");
          const taskData = {};
          const attributes = [
            'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
            'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
            'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
            'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
          ];
          attributes.forEach(attr => {
            taskData[attr] = e.dataTransfer.getData(`project-${attr}`);
          });

          // 从原容器移除卡片
          const fromContainerId = e.dataTransfer.getData('project-from_container');
          if (fromContainerId) {
            const fromContainer = document.getElementById(fromContainerId);
            if (fromContainer) {
              const existingCard = fromContainer.querySelector(`[data-sample_id="${taskData.sample_id}"]`);
              if (existingCard) {
                existingCard.remove();
              }
            }
          }

          // 从排期面板移除
          const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);
          if (originalCell) {
            const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
            const originalStartIndex = originalRowCells.indexOf(originalCell);
            handleUndo(originalRowCells, originalStartIndex, taskData, container);
          } else {
            // 新增：检查目标容器是否已经存在该卡片
            const existingCardInTarget = container.querySelector(`[data-sample_id="${taskData.sample_id}"]`);
            if (existingCardInTarget) {
              existingCardInTarget.remove();
            }
            // 直接从其他池子拖拽过来，创建新卡片
            const newCard = document.createElement('div');
            newCard.className = 'project-card';
            const scheduleColor = taskData.schedule_color || 'null';
            newCard.classList.add(scheduleColor);
            newCard.textContent = `${taskData.sample_model} ${taskData.materialCode} ${taskData.sample_leader?.charAt(0)} ${taskData.remark} (${taskData.schedule_days}天)`;

            Object.keys(taskData).forEach(key => {
              if (key !== 'days' && key !== 'schedule_start_date' && key !== 'schedule_end_date' && key!== 'job_number' && key!== 'tester') {
                newCard.setAttribute(`data-${key}`, taskData[key]);
              }
            });

            newCard.setAttribute('draggable', 'true');
            setDraggable(newCard, false);
            bindCardContextMenu(newCard, taskData);
            container.appendChild(newCard);

            // 记录变更
            const newChange = {
              change: "delete",
              sample_id: taskData.sample_id,
              tester: taskData.tester,
              start_date: taskData.schedule_start_date,
              end_date: taskData.schedule_end_date,
              scheduleDays: taskData.schedule_days,
              schedule_color: taskData.schedule_color,
              job_number: taskData.job_number,
              container: container.id
            };
            const existingIndex = localScheduleChanges.findIndex(item =>
                    item.sample_id === taskData.sample_id
            );
            if (existingIndex !== -1) {
              localScheduleChanges[existingIndex] = newChange;
            } else {
              localScheduleChanges.push(newChange);
            }
            console.log(localScheduleChanges)
          }
        });

        // 为容器中的卡片添加 dragstart 事件，记录来源容器
        // container.addEventListener('dragstart', e => {
        //     const target = e.target.closest('.project-card');
        //     if (target) {
        //         e.dataTransfer.setData('project-from_container', container.id);
        //     }
        // });

        // 添加判断，禁止用户拖着文字
        container.addEventListener('dragstart', e => {
          let target = e.target;

          // 如果是文本节点，则获取其父元素
          if (target.nodeType === Node.TEXT_NODE) {
            target = target.parentElement;
          }

          // 只允许拖拽 project-card 元素，其他不允许
          const card = target.closest('.project-card');

          // 如果拖拽目标不是 .project-card，则不允许
          if (!card || window.getSelection().toString().trim()) {
            e.preventDefault(); // 阻止拖拽
            console.log('只允许拖拽单个卡片，不能拖拽多项或文字！');
            return;
          }

          e.dataTransfer.setData('project-from_container', container.id);
        });

      }
    });
  }

  // 在 DOM 加载完成后绑定按钮点击事件
  document.addEventListener('DOMContentLoaded', function () {
    const addProjectBtn = document.getElementById('addProjectBtn');
    const addProjectModal = document.getElementById('addProjectModal');
    const closeAddProjectModalBtn = document.getElementById('closeAddProjectModalBtn');
    const saveNewProjectBtn = document.getElementById('saveNewProjectBtn');

    // 点击新增项目按钮显示模态框
    addProjectBtn.addEventListener('click', function () {
      addProjectModal.style.display = 'block';
    });

    // 点击关闭按钮隐藏模态框
    closeAddProjectModalBtn.addEventListener('click', function () {
      addProjectModal.style.display = 'none';
    });

    // 点击模态框外部隐藏模态框
    addProjectModal.addEventListener('click', function (e) {
      if (e.target === addProjectModal) {
        addProjectModal.style.display = 'none';
      }
    });

    // 保存新增项目
    saveNewProjectBtn.addEventListener('click', function () {
      const sample_name = document.getElementById('addSampleName').value.trim();
      const sample_model = document.getElementById('addSampleModel').value.trim();
      const materialCode = document.getElementById('addMaterialCode').value.trim();
      const sample_leader = document.getElementById('addSampleLeader').value.trim();
      const scheduleDays = document.getElementById('addScheduleDays').value.trim();

      // ✅ 校验前五项是否填写
      if (!sample_name || !sample_model || !materialCode || !sample_leader || !scheduleDays) {
        alert('请填写完整项目信息（前五项为必填）');
        return;
      }


      const newTaskData = {
        sample_name,
        sample_model,
        materialCode,
        sample_leader,
        scheduleDays,
        schedule_color: document.querySelector('input[name="addScheduleColor"]:checked').value,
        waitSample_classify: document.getElementById('addWaitSampleClassify').value,
        remark: document.getElementById('addSampleRemark').value
      };

      // 发送 POST 请求到后端
      fetch('/scheduleBoard/addProjectCard', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(newTaskData)
      })
              .then(response => response.json())
              .then(result => {
                console.log('后端返回:', result);
                if (result.success) {
                  alert(result.message); // 项目添加成功
                  addProjectModal.style.display = 'none';
                  // 加载项目池子数据
                  loadProjectPoolData(); // ✅ 页面初始化调用加载函数
                  // 加载待送样池子数据
                  loadPendingSamplePoolData();

                } else {
                  alert(result.message || '新增项目失败！'); // 项目新增失败
                }
              })
              .catch(error => {
                console.error('新增项目失败:', error);
                alert('新增项目失败！');
              });


    });
  });

  function loadTrashListAndShowModal() {
    fetch('/scheduleBoard/getTrashList')
            .then(response => response.json())
            .then(trashedProjects => {
              const listModal = document.getElementById('trashListModal');
              const listContainer = document.getElementById('trashProjectList');
              listContainer.innerHTML = '';

              trashedProjects.forEach(project => {
                const li = document.createElement('li');
                li.textContent = project.sample_name;
                li.style.cursor = 'pointer';
                li.style.margin = '5px 0';
                li.addEventListener('click', () => showProjectDetail(project));
                listContainer.appendChild(li);
              });

              listModal.style.display = 'block';
            })
            .catch(error => {
              console.error("获取作废项目失败：", error);
              alert("加载作废项目失败");
            });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const trashStation = document.getElementById('trashStation');

    // 阻止 dragover 默认行为，允许放置
    trashStation.addEventListener('dragover', function (e) {
      e.preventDefault();
    });

    // 处理 drop 事件
    trashStation.addEventListener('drop', function (e) {
      e.preventDefault();
      const sampleId = e.dataTransfer.getData('project-sample_id');
      if (sampleId) {
        if (!confirm("确定要删除该项目吗？")) {
          return;
        }
        // 调用删除接口
        deleteProject(sampleId);

        // 从原容器移除卡片
        const fromContainerId = e.dataTransfer.getData('project-from_container');
        if (fromContainerId) {
          const fromContainer = document.getElementById(fromContainerId);
          if (fromContainer) {
            const existingCard = fromContainer.querySelector(`[data-sample_id="${sampleId}"]`);
            if (existingCard) {
              existingCard.remove();
            }
          }
        }

        // 从排期面板移除
        const originalCell = document.querySelector(`td[data-sample_id="${sampleId}"]`);
        if (originalCell) {
          const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
          const originalStartIndex = originalRowCells.indexOf(originalCell);
          const taskData = {};
          const attributes = [
            'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
            'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
            'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
            'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
          ];
          attributes.forEach(attr => {
            taskData[attr] = originalCell.getAttribute(`data-${attr}`);
          });
          handleUndo(originalRowCells, originalStartIndex, taskData, document.getElementById('projectPool'));
        }
      }
    });


    // 添加右键事件监听
    trashStation.addEventListener('contextmenu', function (e) {
      e.preventDefault();

      loadTrashListAndShowModal();
    });


  });


  // 定义删除项目的函数
  // 定义删除项目的函数，带确认框和可选的删除理由
  function deleteProject(sampleId) {

    const reason = prompt("请输入删除理由（可选）：");

    fetch('/scheduleBoard/deleteProject', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        sample_id: sampleId,
        cancel_reason: reason ? reason.trim() : "", // 如果没有填写则传空字符串
        username: username
      })
    })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(result => {
              if (result.success) {
                alert(result.message);
              } else {
                alert(result.message || '项目删除失败');
              }
            })
            .catch(error => {
              console.error('删除项目时出错:', error);
              alert('删除项目时出错，请稍后重试');
            });
  }

  function showProjectDetail(project) {
    // 填充详情内容
    document.getElementById('detail_sample_id').textContent = project.sample_id;
    document.getElementById('detail_sample_name').textContent = project.sample_name;
    document.getElementById('detail_sizecoding').textContent = project.sample_model + " " + project.materialCode;
    document.getElementById('detail_sample_leader').textContent = project.sample_leader;
    document.getElementById('detail_scheduleDays').textContent = project.scheduleDays;
    document.getElementById('detail_schedule_color').textContent = project.schedule_color;
    document.getElementById('detail_waitSample_classify').textContent = project.waitSample_classify;
    document.getElementById('detail_remark').textContent = project.remark;
    document.getElementById('detail_cancel_by').textContent = project.cancel_by;
    document.getElementById('detail_job_number').textContent = project.cancel_code;
    document.getElementById('detail_cancel_date').textContent = project.cancel_date;
    document.getElementById('detail_cancel_reason').textContent = project.cancel_reason;

    // 显示详情弹窗
    document.getElementById('projectDetailModal').style.display = 'block';
  }

  function recoverProject() {
    const sampleId = document.getElementById('detail_sample_id').textContent;

    fetch('/scheduleBoard/recoverProject', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ sample_id: sampleId })
    })
            .then(response => response.json())
            .then(data => {
              alert(data.message || '恢复成功');
              document.getElementById('projectDetailModal').style.display = 'none';
              // 确保加载数据前清除可能的重复数据
              const projectPool = document.getElementById('projectPool');
              projectPool.innerHTML = ''; // 新增：清空项目池子内容
              const pendingSampleContainers = [
                'videoSamplePool',
                'wireSamplePool',
                'dataSamplePool',
                'bluetoothSamplePool',
                'highFrequencySamplePool'
              ];
              pendingSampleContainers.forEach(id => {
                const container = document.getElementById(id);
                container.innerHTML = ''; // 新增：清空待送样池子内容
              });
              loadProjectPoolData();
              loadPendingSamplePoolData();

              loadTrashListAndShowModal();
            })
            .catch(error => {
              console.error('恢复失败:', error);
              alert('恢复失败');
            });
  }

  // 新增函数：设置周六和周日的边框样式
  function setWeekendBorder(cell, date) {
    const dateObj = new Date(date);
    const dayOfWeek = dateObj.getDay();
    const weekendClass = 'weekend-border'; // 定义周末类名

    if (dayOfWeek === 6 || dayOfWeek === 0) {
      console.log("dayOfWeek",dayOfWeek)
      cell.classList.add(weekendClass);
    } else {
      cell.classList.remove(weekendClass);
    }
  }

</script>

</body>
</html>