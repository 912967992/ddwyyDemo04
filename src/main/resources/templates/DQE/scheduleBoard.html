<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¡¹ç›®æ± å­å±•ç¤º</title>
    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="/css/scheduleBoard.css">

</head>
<body>

<div class="pool-container">
    <div id="projectList" class="project-container">
        <h2>é¡¹ç›®æ± å­
            <!-- æ–°å¢é¡¹ç›®æŒ‰é’® -->
            <button id="addProjectBtn" style="margin-left: 10px;">æ–°å¢é¡¹ç›®</button>
            <!-- å‡è®¾ç®¡ç†èŠ‚å‡æ—¥æŒ‰é’®ä»£ç å¦‚ä¸‹ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ -->
            <button id="manageHolidaysBtn" class="nice-btn">ç®¡ç†èŠ‚å‡æ—¥</button>
            <!-- æ–°å¢ç®¡ç†æµ‹è¯•äººå‘˜æŒ‰é’® -->
            <button id="manageTesterBtn" class="nice-btn" onclick="showManageTestersModal()">ç®¡ç†æµ‹è¯•äººå‘˜</button>

            <!-- æ–°å¢æœç´¢æŒ‰é’® -->
            <button id="searchBtn" style="margin-left: 10px;">æœç´¢æŸ¥è¯¢</button>
            <!-- æ–°å¢åƒåœ¾ç«™åŒºåŸŸ -->
            <div id="trashStation">
                <h3>å›æ”¶ç«™(å³é”®çœ‹ä½œåºŸåˆ—è¡¨)</h3>
                <div id="trashContent"></div>
            </div>


        </h2>
        <div id="projectPool">åŠ è½½ä¸­...</div>
    </div>
    <div class="pending-sample-container">
        <h2>å¾…é€æ ·æ± å­</h2>
        <div class="pending-sample-category">
            <h3>è§†é¢‘ç±»</h3>
            <div id="videoSamplePool">åŠ è½½ä¸­...</div>
        </div>
        <div class="pending-sample-category">
            <h3>çº¿æç±»</h3>
            <div id="wireSamplePool">åŠ è½½ä¸­...</div>
        </div>
        <div class="pending-sample-category">
            <h3>æ•°æ®ç±»</h3>
            <div id="dataSamplePool">åŠ è½½ä¸­...</div>
        </div>
        <div class="pending-sample-category">
            <h3>è“ç‰™ç±»</h3>
            <div id="bluetoothSamplePool">åŠ è½½ä¸­...</div>
        </div>
        <div class="pending-sample-category">
            <h3>é«˜é¢‘ç±»</h3>
            <div id="highFrequencySamplePool">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<!-- æ’æœŸé¢æ¿åŒºåŸŸ -->
<div class="schedule-board-container">
    <div class="schedule-board-header">
        <h3>æ’æœŸé¢æ¿</h3>
        <div class="schedule-controls">
            <input type="date" id="startDate" class="date-picker">
            <span>è‡³</span>
            <input type="date" id="endDate" class="date-picker">
            <button class="save-schedule-btn" onclick="refreshSchedule()">è®¾ç½®æ—¥æœŸ</button>
            <button class="save-schedule-btn" onclick="saveSchedule()">ä¿å­˜æ’æœŸ</button>
        </div>
    </div>
    <div id="scheduleBoard">è¯·é€‰æ‹©æ’æœŸé¢æ¿æ—¶é—´å¹¶ç‚¹å‡»è®¾ç½®æ—¥æœŸæŒ‰é’®ï¼Œæ‰ä¼šå±•ç¤ºé¢æ¿</div>
</div>

<!-- æ–°å¢å˜æ›´è®°å½•æ¨¡æ€æ¡† -->
<div id="changeLogModal">
    <div id="changeLogModalContent">
        <h3>å˜æ›´è®°å½•</h3>
        <div id="changeLogBody"></div>
        <button id="closeChangeLogBtn">å…³é—­</button>
    </div>
</div>

<!-- æ¨¡æ€æ¡† -->
<div id="modal">
    <div id="modalContent">
        <!-- æ–°å¢å˜æ›´è®°å½•æŒ‰é’® -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>é¡¹ç›®è¯¦æƒ…</h3>
            <div style="display: flex; gap: 10px;">
                <button id="changeLogBtn">å˜æ›´è®°å½•</button>
                <button id="infoCloseBtn">å…³é—­</button>
            </div>
        </div>

        <div id="modalBody"></div>

        <div style="margin-top: 10px;">
            <label for="scheduleDays"><strong>æ’æœŸå¤©æ•°ï¼š</strong></label>
            <input type="number" id="scheduleDays" placeholder="è¯·è¾“å…¥æ’æœŸå¤©æ•°">
            <button id="saveScheduleBtn">ç¡®å®šæ’æœŸ</button>
        </div>


        <!-- æ·»åŠ é¢œè‰²é€‰æ‹©åŠŸèƒ½ -->
        <div style="margin-top: 10px;">
            <label><strong>è®¾ç½®é¢œè‰²ï¼š</strong></label>
            <div>
                <label>
                    <input type="radio" id="color_null" name="schedule_color" value="null" checked> æ— 
                </label>
                <label>
                    <input type="radio" id="color_gray" name="schedule_color" value="gray" checked> ç°è‰²
                </label>
                <label>
                    <input type="radio" id="color_green" name="schedule_color" value="green"> ç»¿è‰²
                </label>
                <label>
                    <input type="radio" id="color_yellow" name="schedule_color" value="yellow"> é»„è‰²
                </label>
                <label>
                    <input type="radio" id="color_red" name="schedule_color" value="red"> çº¢è‰²
                </label>
            </div>
            <button id="confirmColorBtn" style="margin-top: 5px;">ç¡®è®¤ä¿®æ”¹é¢œè‰²</button>
        </div>

        <!-- âœ… ä¿®æ”¹ä¸ºåŒä¸€è¡Œæ˜¾ç¤ºé€æ ·å¤‡æ³¨ã€è¾“å…¥æ¡†å’ŒæŒ‰é’® -->
        <div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
            <label for="sampleRemark"><strong>é€æ ·å¤‡æ³¨ï¼š</strong></label>
            <input type="text" id="sampleRemark" placeholder="è¯·è¾“å…¥é€æ ·å¤‡æ³¨" style="flex: 1; padding: 4px;">
            <button id="saveRemarkBtn">ä¿å­˜å¤‡æ³¨</button>
        </div>

    </div>
</div>

<template id="changeLogTemplate">
    <p class="change-log-item">
        <strong>æµ‹è¯•è€…ï¼š</strong> {{tester}}<br>
        <strong>æ’æœŸå¼€å§‹ï¼š</strong> {{startDate}}<br>
        <strong>æ’æœŸç»“æŸï¼š</strong> {{endDate}}<br>
        <strong>æ›´æ–°æ—¶é—´ï¼š</strong> {{updateTime}}<br>
        <strong>é¢œè‰²ï¼š</strong> <span style="color: {{color}};">{{color}}</span><br>
        <strong>æ˜¯å¦ä½¿ç”¨ï¼š</strong> {{used}}<br>
        <strong>å¤‡æ³¨ï¼š</strong> {{remark}}<br>
    <hr>
    </p>
</template>

<!-- æ–°å¢é¡¹ç›®æ¨¡æ€æ¡† -->
<div id="addProjectModal" style="display: none;">
    <div id="addProjectModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>æ–°å¢é¡¹ç›®</h3>
            <button id="closeAddProjectModalBtn">å…³é—­</button>
        </div>
        <div id="addProjectModalBody">
            <p><strong>é¡¹ç›®åç§°(<span class="required">*</span>)ï¼š</strong><input type="text" id="addSampleName" required></p>
            <p><strong>å¤§å°ç¼–ç (<span class="required">*</span>)ï¼š</strong><input type="text" id="addSampleModel" required> <input type="text" id="addMaterialCode" required></p>
            <p><strong>é¡¹ç›®è´Ÿè´£äºº(<span class="required">*</span>)ï¼š</strong><input type="text" id="addSampleLeader" required></p>
            <p><strong>æ’æœŸå¤©æ•°(<span class="required">*</span>)ï¼š</strong><input type="number" id="addScheduleDays" required></p>
            <p><strong>è®¾ç½®é¢œè‰²(<span class="required">*</span>)ï¼š</strong></p>
            <label>
                <input type="radio" id="addColorNull" name="addScheduleColor" value="null" checked> æ— 
            </label>
            <label>
                <input type="radio" id="addColorGray" name="addScheduleColor" value="gray"> ç°è‰²
            </label>
            <label>
                <input type="radio" id="addColorGreen" name="addScheduleColor" value="green"> ç»¿è‰²
            </label>
            <label>
                <input type="radio" id="addColorYellow" name="addScheduleColor" value="yellow"> é»„è‰²
            </label>
            <label>
                <input type="radio" id="addColorRed" name="addScheduleColor" value="red"> çº¢è‰²
            </label>
            </p>
            <p><strong>æ”¾æ± å­åˆ†ç±»ï¼ˆé€‰å¡«ï¼‰ï¼š</strong><input type="text" id="addWaitSampleClassify"></p>
            <p><strong>é€æ ·å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰ï¼š</strong><input type="text" id="addSampleRemark"></p>
        </div>
        <button id="saveNewProjectBtn">ä¿å­˜é¡¹ç›®</button>
    </div>
</div>


<div id="contextMenu" class="context-menu">
    <!-- <div onclick="handleContextMenuClick()">æ’¤å›æ’æœŸ</div> -->
    <div onclick="showProjectAttributes(event)">æŸ¥çœ‹å±æ€§</div>
</div>

<!-- è¿”å›æŒ‰é’® -->
<div class="header-container">
    <button class="BackBtn" id="BackBtn" onclick="location.href='/DQEIndex'">è¿”å›<br>ä¸»é¡µ</button>
</div>

<!-- ä½œåºŸé¡¹ç›®åˆ—è¡¨æ¨¡æ€æ¡† -->
<div id="trashListModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1000;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>ä½œåºŸé¡¹ç›®åˆ—è¡¨</h3>
        <button id="trashListCloseBtn" onclick="document.getElementById('trashListModal').style.display='none'">å…³é—­</button>
    </div>
    <ul id="trashProjectList" style="list-style:none; padding:0;"></ul>
</div>


<!-- è¯¦æƒ…å†…å®¹æ¨¡æ€æ¡† -->
<div id="projectDetailModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1001;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>é¡¹ç›®è¯¦ç»†ä¿¡æ¯</h3>
        <button id="closeTransBtn" onclick="document.getElementById('projectDetailModal').style.display='none'">å…³é—­</button>
    </div>

    <p><strong>ç”µæ°”ç¼–å·ï¼š</strong><span id="detail_sample_id"></span></p>
    <p><strong>é¡¹ç›®åç§°ï¼š</strong><span id="detail_sample_name"></span></p>
    <p><strong>å¤§å°ç¼–ç ï¼š</strong><span id="detail_sizecoding"></span></p>
    <p><strong>é¡¹ç›®è´Ÿè´£äººï¼š</strong><span id="detail_sample_leader"></span></p>
    <p><strong>æ’æœŸå¤©æ•°ï¼š</strong><span id="detail_scheduleDays"></span></p>
    <p><strong>é¢œè‰²ï¼š</strong><span id="detail_schedule_color"></span></p>
    <p><strong>æ”¾æ± å­åˆ†ç±»ï¼š</strong><span id="detail_waitSample_classify"></span></p>
    <p><strong>é€æ ·å¤‡æ³¨ï¼š</strong><span id="detail_remark"></span></p>
    <p><strong>ä½œåºŸäººï¼š</strong><span id="detail_cancel_by"></span></p>
    <p><strong>ä½œåºŸå·¥å·ï¼š</strong><span id="detail_job_number"></span></p>
    <p><strong>ä½œåºŸæ—¶é—´ï¼š</strong><span id="detail_cancel_date"></span></p>
    <p><strong>ä½œåºŸç†ç”±ï¼š</strong><span id="detail_cancel_reason"></span></p>

    <button id="recoverBtn" onclick="recoverProject()">æ¢å¤</button>
</div>


<!-- èŠ‚å‡æ—¥ç®¡ç†æ¨¡æ€æ¡† -->
<!-- èŠ‚å‡æ—¥ç®¡ç†æ¨¡æ€æ¡†èƒŒæ™¯å±‚ -->
<div id="holidayModalBackground" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;">
    <!-- èŠ‚å‡æ—¥ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="holidayModal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ç®¡ç†èŠ‚å‡æ—¥</h3>
            <button id="closeHolidayModalBtn">å…³é—­</button>
        </div>
        <div id="holidayList">
            <!-- èŠ‚å‡æ—¥åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div>
            <label for="newHolidayDate">æ—¥æœŸï¼š</label>
            <input type="date" id="newHolidayDate">
            <label for="newHolidayName">åç§°ï¼š</label>
            <input type="text" id="newHolidayName">
            <button id="addHolidayBtn">æ·»åŠ </button>
        </div>
    </div>
</div>


<!-- ç®¡ç†æµ‹è¯•äººå‘˜æ¨¡æ€æ¡†é®ç½©å±‚ -->
<div id="manageTestersOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
<!-- ç®¡ç†æµ‹è¯•äººå‘˜æ¨¡æ€æ¡† -->
<div id="manageTestersModal" style="display: none;">
    <div id="manageTestersModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000; max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="tester-management">
                <h3>ç®¡ç†æµ‹è¯•äººå‘˜</h3>
                <button id="addNewTesterBtn">æ–°å¢æµ‹è¯•äººå‘˜</button>
                <button id="manageGroupBtn">ç®¡ç†å±•ç¤ºçš„ç»„</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="saveTesterChangesBtn">ä¿å­˜</button>
                <button id="closeManageTestersModalBtn">å…³é—­</button>
            </div>
        </div>
        <div id="manageTestersModalBody">
            <table id="testersTable" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; width: 100%; margin-bottom: 10px;">
                <thead>
                <tr>
                    <th>å·¥ç¨‹å¸ˆID</th>
                    <th>å·¥ç¨‹å¸ˆåå­—</th>
                    <th>å…¥èŒæ—¥æœŸ</th>
                    <th>è´Ÿè´£çš„å“ç±»</th>
                    <th>æŠ€èƒ½æè¿°</th>
                    <th>æŠ€èƒ½æå‡è®°å½•</th>
                    <th>å½“å‰æŠ€èƒ½ç­‰çº§</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="testersTableBody">
                <!-- æµ‹è¯•äººå‘˜æ•°æ®å°†åŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
            <!-- ... æ–°å¢æµ‹è¯•äººå‘˜éƒ¨åˆ†ä¿æŒä¸å˜ ... -->
        </div>
    </div>
</div>


<!-- æ–°å¢æµ‹è¯•äººå‘˜æ¨¡æ€æ¡† -->
<div id="addTesterModal" style="display: none;">
    <div id="addTesterModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>æ–°å¢æµ‹è¯•äººå‘˜</h3>
            <button id="closeAddTesterModalBtn">å…³é—­</button>
        </div>
        <div id="addTesterModalBody">
            <p><strong>æµ‹è¯•äººå‘˜å§“å(<span class="required">*</span>)ï¼š</strong><input type="text" id="addTesterName" required></p>
            <p><strong>è´Ÿè´£ç»„åˆ«(<span class="required">*</span>)ï¼š</strong><input type="text" id="addTesterGroup" required></p>
            <p><strong>æŠ€èƒ½æè¿°ï¼š</strong><input type="text" id="addTesterSkillDesc"></p>
            <p><strong>æŠ€èƒ½æå‡ï¼š</strong><input type="text" id="addTesterSkillImprove"></p>
            <p><strong>å½“å‰æŠ€èƒ½ç­‰çº§ï¼š</strong><input type="text" id="addTesterSkillLevel"></p>
        </div>
        <button id="saveNewTesterBtn">ä¿å­˜æµ‹è¯•äººå‘˜</button>
    </div>
</div>

<!-- ç®¡ç†å±•ç¤ºçš„ç»„æ¨¡æ€æ¡† -->
<div id="manageGroupModal" style="display: none;">
    <div id="manageGroupModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ç®¡ç†å±•ç¤ºçš„ç»„</h3>
            <button id="closeManageGroupModalBtn">å…³é—­</button>
        </div>
        <table id="groupTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>ç»„åˆ«</th>
                <th>æ˜¯å¦å±•ç¤º</th>
                <th>æ˜¾ç¤ºé¡ºåºå€¼</th>
            </tr>
            </thead>
            <tbody>
            <!-- è¿™é‡Œå°†åŠ¨æ€æ·»åŠ ç»„ä¿¡æ¯ -->
            </tbody>
        </table>

        <button id="saveGroupSettingsBtn">ä¿å­˜ç»„åˆ«è®¾ç½®</button>

        <!-- æ–°å¢ç»„è¾“å…¥åŒºåŸŸ -->
        <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="newGroupName" placeholder="ç»„åˆ«åç§°" style="width: 150px;">
            <select id="newGroupDisplay" style="width: 100px;">
                <option value="true">å±•ç¤º</option>
                <option value="false">ä¸å±•ç¤º</option>
            </select>
            <input type="number" id="newGroupOrder" placeholder="å±•ç¤ºæƒé‡" style="width: 100px;">
            <button id="addGroupBtn">æ–°å¢ç»„</button>
        </div>
    </div>
</div>

<!-- é®ç½©å±‚ -->
<div id="searchModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 999;"></div>
<!-- æ–°å¢æœç´¢æ¨¡æ€æ¡† -->
<div id="searchModal" style="display: none;">
    <div id="searchModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>æœç´¢é¡¹ç›®</h3>
            <button id="closeSearchModalBtn" class="modal-button">å…³é—­</button>
        </div>
        <!-- ä¿®æ”¹ searchModalBody çš„æ ·å¼ -->
        <div id="searchModalBody" style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
            <div>
                <strong>ç”µæ°”ç¼–å·ï¼š</strong><input type="text" id="searchSampleId">
            </div>
            <div>
                <strong>å¤§ç¼–ç ï¼š</strong><input type="text" id="searchSampleModel">
            </div>
            <div>
                <strong>æµ‹è¯•äººï¼š</strong><input type="text" id="searchTester">
            </div>
            <button id="executeSearchBtn" class="modal-button">æœç´¢</button>
        </div>
        <div id="searchResults"></div>
    </div>
</div>






<script>
    const username = sessionStorage.getItem('username');
    // const username = "å¢å¥";

    let localScheduleChanges = [];
    const contextMenu = document.getElementById('contextMenu');
    let currentRightClickCell = null;
    let currentRightClickProject = null;

    // å®šä¹‰å…¨å±€å˜é‡ holidays ç”¨äºå­˜å‚¨èŠ‚å‡æ—¥æ•°æ®
    let holidays = [];

    // å­˜å‚¨å¾…ä¿å­˜çš„ä¿®æ”¹
    let pendingChanges = [];

    // â­â­ æ–°å¢ï¼šç»„åˆ«é¡ºåºæ•°ç»„
    let groupOrder = []; // æŒ‰ä½ çš„éœ€æ±‚æ”¹é¡ºåº

    function loadGroupOrder() {
        fetch('/scheduleBoardController/getGroupOrder')
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œé”™è¯¯');
                return response.json();
            })
            .then(data => {
                if (Array.isArray(data)) {
                    groupOrder = data;
                    console.log("groupOrder",groupOrder)

                    // è¿™é‡Œä½ å¯ä»¥è°ƒç”¨æ¸²æŸ“è¡¨æ ¼ç­‰å‡½æ•°ï¼Œä½¿ç”¨ groupOrder
                    // renderGroupTable(groupOrder);
                } else {
                    console.warn('æ¥å£è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®', data);
                }
            })
            .catch(error => {
                console.error('è·å–ç»„åˆ«é¡ºåºå¤±è´¥:', error);
            });
    }

    //é»˜è®¤è®©endDate+14å¤©ï¼Œè¿›å…¥é¡µé¢çš„æ—¶å€™
    document.addEventListener('DOMContentLoaded', function () {
        // è·å–å½“å‰ UTC æ—¶é—´
        const now = new Date();

        // åŒ—äº¬æ—¶é—´åç§»ï¼ˆUTC+8ï¼‰
        const beijingOffset = 8 * 60 * 60 * 1000;
        const beijingTime = new Date(now.getTime() + beijingOffset);

        // å¼€å§‹æ—¥æœŸï¼š7å¤©å‰
        const startTime = new Date(beijingTime.getTime() - 7 * 24 * 60 * 60 * 1000);
        const startYear = startTime.getUTCFullYear();
        const startMonth = String(startTime.getUTCMonth() + 1).padStart(2, '0');
        const startDay = String(startTime.getUTCDate()).padStart(2, '0');
        const startDate = `${startYear}-${startMonth}-${startDay}`;

        // ç»“æŸæ—¥æœŸï¼š7å¤©å
        const endTime = new Date(beijingTime.getTime() + 7 * 24 * 60 * 60 * 1000);
        const endYear = endTime.getUTCFullYear();
        const endMonth = String(endTime.getUTCMonth() + 1).padStart(2, '0');
        const endDay = String(endTime.getUTCDate()).padStart(2, '0');
        const endDate = `${endYear}-${endMonth}-${endDay}`;

        // è®¾ç½® input çš„é»˜è®¤å€¼
        document.getElementById('startDate').value = startDate;
        document.getElementById('endDate').value = endDate;
    });



    // è®¾ç½®æ‹–æ‹½
    function setDraggable(projectEl, isProject) {
        projectEl.addEventListener('dragstart', e => {
            const sampleModel = projectEl.getAttribute('data-sample_model');
            const materialCode = projectEl.getAttribute('data-materialCode');
            e.dataTransfer.setData('project-sizecoding', `${sampleModel} ${materialCode} `+projectEl.getAttribute('data-sample_leader').charAt(0) + " "+projectEl.getAttribute('data-remark'));
            e.dataTransfer.setData('project-days', projectEl.getAttribute('data-schedule_days'));
            e.dataTransfer.setData('project-sample_id', projectEl.getAttribute('data-sample_id'));
            e.dataTransfer.setData('project-sample_name', projectEl.getAttribute('data-sample_name'));
            e.dataTransfer.setData('project-sample_model', projectEl.getAttribute('data-sample_model'));
            e.dataTransfer.setData('project-materialCode', projectEl.getAttribute('data-materialCode'));
            e.dataTransfer.setData('project-sample_category', projectEl.getAttribute('data-sample_category'));
            e.dataTransfer.setData('project-version', projectEl.getAttribute('data-version'));
            e.dataTransfer.setData('project-priority', projectEl.getAttribute('data-priority'));
            e.dataTransfer.setData('project-sample_leader', projectEl.getAttribute('data-sample_leader'));
            e.dataTransfer.setData('project-supplier', projectEl.getAttribute('data-supplier'));
            e.dataTransfer.setData('project-test_project_category', projectEl.getAttribute('data-test_project_category'));
            e.dataTransfer.setData('project-test_projects', projectEl.getAttribute('data-test_projects'));
            e.dataTransfer.setData('project-schedule', projectEl.getAttribute('data-schedule'));
            e.dataTransfer.setData('project-create_time', projectEl.getAttribute('data-create_time'));
            e.dataTransfer.setData(
                'project-schedule_days',
                projectEl.getAttribute('data-schedule_days') ?? '1'
            );
            e.dataTransfer.setData('project-schedule_color', projectEl.getAttribute('data-schedule_color'));
            e.dataTransfer.setData('project-remark', projectEl.getAttribute('data-remark'));
            e.dataTransfer.setData('project-sample_sender', projectEl.getAttribute('data-sample_sender'));
            e.dataTransfer.setData('project-sample_type', projectEl.getAttribute('data-sample_type'));
            e.dataTransfer.setData('project-sample_quantity', projectEl.getAttribute('data-sample_quantity'));
            e.dataTransfer.setData('project-high_frequency', projectEl.getAttribute('data-high_frequency'));

        });
        if(isProject){

        }else{
            projectEl.addEventListener('contextmenu', e => {
                e.preventDefault();
                currentRightClickProject = projectEl;
                // åŸä»£ç ä¸­ projectMenu æœªå®šä¹‰ï¼Œè¿™é‡Œæ³¨é‡Šæ‰
                // projectMenu.style.top = e.pageY + 'px';
                // projectMenu.style.left = e.pageX + 'px';
                // projectMenu.style.display = 'block';
            });
        }
    }


    // ç‚¹å‡»å…¶ä»–åŒºåŸŸéšè—èœå•
    document.addEventListener('click', e => {
        if (!e.target.classList.contains('context-menu')) {
            contextMenu.style.display = 'none';
            // projectMenu.style.display = 'none';
        }
    });

    function loadProjectPoolData() {
        fetch('/passback/getReceivedData')
            .then(response => response.json())
            .then(data => {
                renderProjectPool(data);
            })
            .catch(error => {
                document.getElementById('projectPool').innerHTML = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                console.error('Error fetching project data:', error);
            });
    }

    function renderProjectPool(data) {
        const container = document.getElementById('projectPool');
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = 'æš‚æ— é¡¹ç›®æ•°æ®ã€‚';
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');

            card.className = 'project-card';

            const scheduleColor = item.schedule_color || 'null';
            card.classList.add(scheduleColor);
            // card.textContent = item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0) + " " + item.remark + " " +"(" + item.scheduleDays + "å¤©)" ;

            card.textContent =
                item.sample_model + " " +
                item.materialCode + " " +
                item.sample_leader.charAt(0) + " " +
                (item.remark && item.remark.length > 10
                    ? item.remark.substring(0, 10) + "..."
                    : item.remark || "") + " " +
                "(" + item.scheduleDays + "å¤©)";


            card.setAttribute('data-sizecoding', item.sample_model + " " + item.materialCode + " "+ item.sample_leader.charAt(0) + " "+item.remark );
            card.setAttribute('data-sample_id', item.sample_id || '');
            card.setAttribute('data-sample_name', item.sample_name || '');
            card.setAttribute('data-sample_model', item.sample_model || '');
            card.setAttribute('data-materialCode', item.materialCode || '');
            card.setAttribute('data-sample_category', item.sample_category || '');
            card.setAttribute('data-version', item.version || '');
            card.setAttribute('data-priority', item.priority || '');
            card.setAttribute('data-sample_leader', item.sample_leader || '');
            card.setAttribute('data-supplier', item.supplier || '');
            card.setAttribute('data-test_project_category', item.testProjectCategory || '');
            card.setAttribute('data-test_projects', item.testProjects || '');
            card.setAttribute('data-schedule', item.schedule || '');
            card.setAttribute('data-create_time', item.create_time || '');
            card.setAttribute('data-schedule_days', item.scheduleDays != null ? item.scheduleDays : '1');
            card.setAttribute('data-schedule_color', item.schedule_color != null ? item.schedule_color : '');
            card.setAttribute('data-remark', item.remark != null ? item.remark : '');
            card.setAttribute('data-sample_sender', item.sample_sender != null ? item.sample_sender : '');
            card.setAttribute('data-sample_type', item.sample_type != null ? item.sample_type : '');
            card.setAttribute('data-sample_quantity', item.sample_quantity != null ? item.sample_quantity : '');
            card.setAttribute('data-high_frequency', item.high_frequency != null ? item.high_frequency : '');
            card.setAttribute('draggable', 'true');

            setDraggable(card, true);
            bindCardContextMenu(card, item);
            container.appendChild(card);
        });
    }

    // é¡µé¢åŠ è½½åè¯·æ±‚æ•°æ®
    window.onload = function () {
        // è·å–å±•ç¤ºçš„ç»„çš„æ•°æ®
        loadGroupOrder();

        // åŠ è½½é¡¹ç›®æ± å­æ•°æ®
        loadProjectPoolData(); // âœ… é¡µé¢åˆå§‹åŒ–è°ƒç”¨åŠ è½½å‡½æ•°
        // åŠ è½½å¾…é€æ ·æ± å­æ•°æ®
        loadPendingSamplePoolData();

        // æ¨¡æ€æ¡†å…³é—­
        document.getElementById('infoCloseBtn').onclick = function () {
            document.getElementById('modal').style.display = 'none';
        };
        document.getElementById('modal').onclick = function (e) {
            if (e.target.id === 'modal') {
                document.getElementById('modal').style.display = 'none';
            }
        };

        // å…³é—­å˜æ›´è®°å½•æ¨¡æ€æ¡†
        document.getElementById('closeChangeLogBtn').onclick = function () {
            document.getElementById('changeLogModal').style.display = 'none';
        };
        document.getElementById('changeLogModal').onclick = function (e) {
            if (e.target.id === 'changeLogModal') {
                document.getElementById('changeLogModal').style.display = 'none';
            }
        };

    };

    // é¡¹ç›®å¡ç‰‡å³é”®è§¦å‘çš„ç»‘å®šäº‹ä»¶
    function bindCardContextMenu(card, item) {
        card.oncontextmenu = function (event) {
            event.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤å³é”®èœå•

            console.log("è¿™ä¸ªè§¦å‘bindCardContextMenu")

            // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('modalBody').innerHTML = `
            <!--            <p><strong>ç”µæ°”ç¼–å·ï¼š</strong>${item.sample_id}</p>-->
            <div style="display: flex; align-items: center; gap: 10px;">
                <p><strong>ç”µæ°”ç¼–å·ï¼š</strong></p>
                <input type="text" id="editSampleId" value="${item.sample_id}">
                <button id="editSampleIdBtn">ä¿®æ”¹</button>
            </div>
            <p><strong>é¡¹ç›®åç§°ï¼š</strong>${item.sample_name}</p>
            <p><strong>å¤§å°ç¼–ç ï¼š</strong>${item.sample_model + ' ' + item.materialCode}</p>
            <p><strong>äº§å“ç±»åˆ«ï¼š</strong>${item.sample_category}</p>
            <p><strong>ç‰ˆæœ¬ï¼š</strong>${item.version}</p>
            <p><strong>ä¼˜å…ˆçº§ï¼š</strong>${item.priority}</p>
            <p><strong>é¡¹ç›®è´Ÿè´£äººï¼š</strong>${item.sample_leader}</p>
            <p><strong>ä¾›åº”å•†ï¼š</strong>${item.supplier}</p>
            <p><strong>è¯•éªŒé¡¹ç›®ç±»åˆ«ï¼š</strong>${item.testProjectCategory}</p>
            <p><strong>æµ‹è¯•å­é¡¹ç›®ï¼š</strong>${item.testProjects}</p>
            <p><strong>çŠ¶æ€ï¼š</strong>${getScheduleText(item.schedule)}</p>
            <p><strong>é€æ ·äººï¼š</strong>${item.sample_sender}</p>
            <p><strong>é€æ ·ç±»åˆ«ï¼š</strong>${item.sample_type}</p>
            <p><strong>é€æ ·æ•°é‡ï¼š</strong>${item.sample_quantity}</p>
            <p><strong>æ˜¯å¦é«˜é¢‘ï¼š</strong>${item.high_frequency}</p>
            <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${item.create_time}</p>
        `;

            document.getElementById('scheduleDays').value = item.scheduleDays != null ? item.scheduleDays : '';
            // è®¾ç½®é€‰ä¸­çš„é¢œè‰²ï¼Œé»˜è®¤é€‰æ— è‰²
            const selectedColor = item.schedule_color ? item.schedule_color : 'null';
            const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
            if (colorRadio) {
                colorRadio.checked = true;
            }

            document.getElementById('sampleRemark').value = item.remark;

            document.getElementById('saveScheduleBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };

            document.getElementById('confirmColorBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };

            document.getElementById('saveRemarkBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };


            document.getElementById('modal').style.display = 'block';

            // ç»‘å®šä¿®æ”¹ç”µæ°”ç¼–å·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('editSampleIdBtn').addEventListener('click', function () {
                const newSampleId = document.getElementById('editSampleId').value;
                const oldSampleId = item.sample_id;

                // å‘é€è¯·æ±‚åˆ°æ§åˆ¶å±‚
                fetch('/scheduleBoard/updateElectricSampleId', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldSampleId: oldSampleId,
                        newSampleId: newSampleId
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(result.message);
                            loadProjectPoolData();
                            loadPendingSamplePoolData();

                        } else {
                            alert(result.message);
                        }
                    })
                    .catch(error => {
                        console.error('ä¿®æ”¹ç”µæ°”ç¼–å·æ—¶å‡ºé”™:', error);
                        alert('ä¿®æ”¹ç”µæ°”ç¼–å·æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•');
                    });
            });

        };

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
        card.addEventListener('click', () => {
            checkSimilarCodes(card);
        });


    }


    // è®©å¡ç‰‡é—ªçƒçš„æ–¹æ³•
    function blinkCards(cards) {
        const blinkInterval = 500; // é—ªçƒé—´éš”ï¼ˆæ¯«ç§’ï¼‰
        const blinkCount = 3; // é—ªçƒæ¬¡æ•°
        let count = 0;
        const intervalId = setInterval(() => {
            cards.forEach(card => {
                card.style.opacity = card.style.opacity === '0.5' ? '1' : '0.5';
            });
            count++;
            if (count >= blinkCount * 2) {
                clearInterval(intervalId);
                cards.forEach(card => {
                    card.style.opacity = '1';
                });
            }
        }, blinkInterval);
    }

    // æ£€æŸ¥å¤§ç¼–ç æ˜¯å¦ç›¸ä¼¼çš„æ–¹æ³•
    function checkSimilarCodes(clickedCard) {
        const clickedLargeCode = clickedCard.getAttribute('data-sample_model');
        const allProjectCards = document.querySelectorAll('.project-card');
        const allScheduleCells = document.querySelectorAll('#scheduleBoardTable td[data-sample_model]');
        const similarElements = [];

        // æ£€æŸ¥é¡¹ç›®å¡ç‰‡
        allProjectCards.forEach(card => {
            if (card !== clickedCard) {
                const currentLargeCode = card.getAttribute('data-sample_model');
                if (currentLargeCode === clickedLargeCode) {
                    similarElements.push(card);
                }
            }
        });

        // æ£€æŸ¥æ’æœŸé¢æ¿å•å…ƒæ ¼
        allScheduleCells.forEach(cell => {
            const currentLargeCode = cell.getAttribute('data-sample_model');
            if (currentLargeCode === clickedLargeCode) {
                similarElements.push(cell);
            }
        });

        if (similarElements.length > 0) {
            similarElements.push(clickedCard);
            blinkCards(similarElements);
        }
    }


    function saveScheduleAndColor(card, item) {
        const days = document.getElementById('scheduleDays').value;

        let selectedColor = document.querySelector('input[name="schedule_color"]:checked')?.value;
        if (!selectedColor) {
            alert("è¯·é€‰æ‹©ä¸€ä¸ªé¢œè‰²ï¼");
            return;
        }

        const remark = document.getElementById('sampleRemark').value;

        const startDateCell = document.querySelector(`td[data-sample_id="${item.sample_id}"]`);
        let startDate = null;
        let tester = null;
        let job_number = null;
        let originalDays = null;

        if (startDateCell) {
            startDate = startDateCell.getAttribute('data-date');
            tester = startDateCell.getAttribute('data-tester');
            job_number = startDateCell.getAttribute('data-job_number');
            originalDays = startDateCell.getAttribute("data-schedule_days");

            if (!startDate) {
                console.error('æ— æ³•è·å–æ’æœŸå¼€å§‹æ—¥æœŸ');
                return;
            }

            const allCells = document.querySelectorAll('.drop-cell');
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(startDateObj);
            endDateObj.setDate(endDateObj.getDate() + Math.ceil(days) - 1);
            const newEndDate = endDateObj.toISOString().split('T')[0];

            const newDateRange = getDateRange(startDate, newEndDate);
            for (const date of newDateRange) {
                const cellsOnDate = Array.from(allCells).filter(cell =>
                    cell.getAttribute('data-date') === date &&
                    cell.getAttribute('data-tester') === tester &&
                    cell.innerText.trim() !== '' &&
                    cell.getAttribute('data-sample_id') !== item.sample_id
                );
                if (cellsOnDate.length > 0) {
                    alert('æ–°æ’æœŸä¼šå ç”¨å·²æœ‰é¡¹ç›®ï¼Œè¯·é‡æ–°é€‰æ‹©æ’æœŸå¤©æ•°ï¼');
                    return;
                }
            }

            const existingIndex = localScheduleChanges.findIndex(change => change.sample_id === item.sample_id);
            if (existingIndex !== -1) {
                localScheduleChanges[existingIndex].start_date = startDate;
                localScheduleChanges[existingIndex].end_date = newEndDate;
                localScheduleChanges[existingIndex].scheduleDays = days;
                localScheduleChanges[existingIndex].schedule_color = selectedColor;
                localScheduleChanges[existingIndex].tester = tester;
                localScheduleChanges[existingIndex].job_number = job_number;
            } else {
                const newChange = {
                    change: "add",
                    sample_id: item.sample_id,
                    tester: tester,
                    start_date: startDate,
                    end_date: newEndDate,
                    scheduleDays: days,
                    schedule_color: selectedColor,
                    job_number: job_number
                };
                localScheduleChanges.push(newChange);
            }

            console.log("æ ‡è®°5", localScheduleChanges);
        }

        // åˆå¹¶åçš„æ¥å£è¯·æ±‚
        fetch('/schedule/saveScheduleInfo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sample_id: item.sample_id,
                scheduleDays: days,
                schedule_color: selectedColor,
                remark: remark
            })
        })
            .then(resp => resp.json())
            .then(result => {
                alert("æ’æœŸå¤©æ•°å’Œé¢œè‰²è®¾ç½®æˆåŠŸï¼");
                document.getElementById('modal').style.display = 'none';

                // æ›´æ–°å¡ç‰‡
                if (card) {
                    // card.textContent = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${remark} (${days}å¤©)`;
                    card.textContent = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${item.remark?.length > 10 ? item.remark.substring(0, 10) + "..." : item.remark ?? ""} (${item.scheduleDays}å¤©)`;

                    card.setAttribute('data-schedule_days', days || '1');

                    card.classList.remove('gray', 'green', 'yellow', 'red');
                    card.setAttribute('data-remark',remark);
                    card.classList.add(selectedColor);
                    card.dataset.schedule_color = selectedColor;

                    //è¿™é‡Œæ˜¯è®©å¡ç‰‡é‡ç°èµ‹å€¼æ–°ä¿®æ”¹çš„å€¼
                    item.scheduleDays = days;
                    item.schedule_color = selectedColor;
                    item.remark = remark;
                }

                // æ›´æ–°æ’æœŸé¢æ¿
                const cells = document.querySelectorAll(`td[data-sample_id="${item.sample_id}"]`);
                cells.forEach(cell => {
                    cell.setAttribute('colspan', Math.ceil(days));
                    cell.setAttribute('data-schedule_days', days);
                    cell.setAttribute('data-remark', remark);

                    // cell.innerText = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${remark} (${days}å¤©)`;
                    cell.innerText = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${(item.remark ? (item.remark.length > 10 ? item.remark.substring(0, 10) + "..." : item.remark) : "")} (${days}å¤©)`;


                    if (selectedColor === null || selectedColor === "null") {
                        selectedColor = "white"
                    }

                    cell.style.backgroundColor = selectedColor;
                    cell.dataset.schedule_color = selectedColor;

                    const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
                    const startIndex = rowCells.indexOf(cell);
                    for (let i = startIndex; i < startIndex + originalDays; i++) {
                        if (rowCells[i]) rowCells[i].style.display = '';
                    }
                    for (let i = startIndex + 1; i < startIndex + Math.ceil(days); i++) {
                        if (rowCells[i]) rowCells[i].style.display = 'none';
                    }
                });

            })
            .catch(err => {
                console.error("ä¿å­˜å¤±è´¥ï¼š", err);
                alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
            });

        setTimeout(() => {
            saveSchedule(true);
        }, 2000); // 2000 æ¯«ç§’ = 2 ç§’

    }

    async function saveSchedule(isRefrenshBtn) {
        if (!localScheduleChanges || localScheduleChanges.length === 0 ) {
            if(!isRefrenshBtn){
                alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„æ’æœŸå˜æ›´');
            }
            return;
        }

        try {
            const response = await fetch('/scheduleBoard/saveSchedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(localScheduleChanges)
            });

            if (!response.ok) {
                throw new Error(`ä¿å­˜å¤±è´¥: ${response.statusText}`);
            }

            const result = await response.json(); // ç¡®ä¿è§£æ JSON

            alert(result.message+result.statusSummary);

            // æ¸…ç©ºæœ¬åœ°ç¼“å­˜
            localScheduleChanges = [];
        } catch (error) {
            console.error('ä¿å­˜æ’æœŸå¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼');
        }
    }

    async function refreshSchedule() {
        await saveSchedule(true); // ç¡®ä¿ saveSchedule æ‰§è¡Œå®Œæ¯•
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        if (!startDate) {
            alert("è¯·è‡³å°‘é€‰æ‹©åˆå§‹æ—¶é—´ï¼");
            return;
        }

        const contextMenu = document.getElementById('contextMenu');
        contextMenu.removeEventListener('click', handleContextMenuClick);

        document.getElementById('scheduleBoard').innerHTML = '';

        // åŠ è½½æ’æœŸé¢æ¿æ•°æ®
        fetch(`/getSchedulesByStartDate?startDate=${startDate}&endDate=${endDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(async data => {
                const board = document.getElementById('scheduleBoard');

                const allDatesSet = new Set();
                const dateMap = {}; // tester => array of tasks

                data.forEach(item => {
                    const task = {
                        startDate: item.schedule_start_date,
                        endDate: item.schedule_end_date,
                        sample_id: item.sample_id,
                        sizecoding: item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0) + " "+item.remark,
                        sample_category: item.sample_category,
                        sample_model: item.sample_model,
                        sample_name: item.sample_name,
                        priority: item.priority,
                        version: item.version,
                        materialCode: item.materialCode,
                        sample_leader: item.sample_leader,
                        supplier: item.supplier,
                        test_project_category: item.testProjectCategory,
                        testProjects: item.testProjects,
                        schedule: item.schedule,
                        create_time: item.create_time,
                        schedule_days: item.scheduleDays,
                        schedule_start_date: item.schedule_start_date,
                        schedule_end_date: item.schedule_end_date,
                        schedule_color: item.schedule_color,
                        job_number: item.job_number,
                        remark: item.remark,
                        sample_sender: item.sample_sender,
                        sample_type: item.sample_type,
                        sample_quantity: item.sample_quantity,
                        high_frequency: item.high_frequency
                    };

                    const tester = item.tester || 'æœªçŸ¥æµ‹è¯•äººå‘˜';
                    if (!dateMap[tester]) dateMap[tester] = [];
                    dateMap[tester].push(task);

                    const dateRange = getDateRange(item.schedule_start_date, item.schedule_end_date);
                    dateRange.forEach(date => allDatesSet.add(date));
                });

                // ğŸ‘‰ å¼ºåˆ¶è¦†ç›–æ—¥æœŸï¼šä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å®Œæ•´æ—¥æœŸèŒƒå›´
                getDateRange(startDate, endDate).forEach(date => allDatesSet.add(date));
                const allDates = Array.from(allDatesSet).sort();

                // ğŸ‘‰ ä¸ä½¿ç”¨ data ä¸­çš„ testerï¼Œç»Ÿä¸€ä» /getTesters è·å–
                try {
                    const testersResponse = await fetch('/getTesters');
                    const testersData = await testersResponse.json();

                    drawScheduleBoard(board, testersData, allDates, dateMap);
                } catch (error) {
                    console.error("è·å–æµ‹è¯•äººå‘˜å¤±è´¥:", error);
                    document.getElementById('scheduleBoard').innerHTML = 'æµ‹è¯•äººå‘˜åŠ è½½å¤±è´¥ã€‚';
                }
            })
            .catch(error => {
                document.getElementById('scheduleBoard').innerHTML = 'æ’æœŸåŠ è½½å¤±è´¥ã€‚';
                console.error('Error loading schedule board:', error);
            });
    }

    function groupTestersByCategory(testers) {
        const groupMap = {};

        testers.forEach(tester => {
            const group = tester.responsible_category || 'æœªåˆ†ç»„';
            if (!groupMap[group]) {
                groupMap[group] = [];
            }
            groupMap[group].push(tester);
        });

        return groupMap;
    }

    // ç»˜åˆ¶æ’æœŸé¢æ¿
    function drawScheduleBoard(board, testers, allDates, dateMap) {
        let html = '<table id="scheduleBoardTable" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse;">';

        // è¡¨å¤´
        html += '<thead><tr>';
        html += '<th>ç»„åˆ«</th>';
        html += '<th style="min-width: 100px;">æµ‹è¯•äººå‘˜</th>';
        allDates.forEach(date => {
            const dateObj = new Date(date);
            const dayOfWeek = dateObj.getDay();
            let displayText = date;
            // æ–°å¢é€»è¾‘ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå‘¨å…­æˆ–å‘¨æ—¥å¹¶æ·»åŠ å¯¹åº”æ–‡å­—
            if (dayOfWeek === 6) {
                displayText = `${date}<br>å‘¨å…­`;
            } else if (dayOfWeek === 0) {
                displayText = `${date}<br>å‘¨æ—¥`;
            }
            html += `<th>${displayText}</th>`;
        });
        html += '</tr></thead><tbody>';

        const groupedTesters = groupTestersByCategory(testers);


        // â­â­ æ–°å¢ï¼šå…ˆæŒ‰ç…§ groupOrder éå†
        groupOrder.forEach(groupName => {
            const groupTesters = groupedTesters[groupName];
            if (!groupTesters) return; // å¦‚æœæŸç»„æ²¡äººï¼Œè·³è¿‡

            const groupRowSpan = groupTesters.length;

            groupTesters.forEach((tester, testerIndex) => {
                const testerName = tester.test_engineer_name;
                const jobNumber = tester.engineer_id;

                html += '<tr>';

                if (testerIndex === 0) {
                    html += `<td rowspan="${groupRowSpan}" style="text-align: center; font-weight: bold;">${groupName}</td>`;
                }

                html += `<td><strong>${testerName}</strong></td>`;

                let colIndex = 0;
                while (colIndex < allDates.length) {
                    const currentDate = allDates[colIndex];
                    // ç­›é€‰å‡ºå½“å¤©æ‰€æœ‰ 0.5 å¤©çš„é¡¹ç›®
                    const halfDayTasks = dateMap[testerName]?.filter(t =>
                        t.startDate === currentDate &&
                        parseFloat(t.schedule_days) === 0.5
                    ) || [];

                    const dateObj = new Date(currentDate);
                    const dayOfWeek = dateObj.getDay();
                    // æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå‘¨å…­æˆ–å‘¨æ—¥ï¼Œæ·»åŠ  weekend-border ç±»å
                    let weekendClass = '';
                    if (dayOfWeek === 6 || dayOfWeek === 0) {
                        weekendClass = 'weekend-border';
                    }

                    if (halfDayTasks.length >= 2) {
                        const firstTask = halfDayTasks[0];
                        const secondTask = halfDayTasks[1];
                        let cellHtml = `<td class="drop-cell assigned ${weekendClass}"
                        data-tester="${testerName}"
                        data-date="${currentDate}"
                        data-job_number="${jobNumber}"
                        data-sample_id="${firstTask.sample_id || ''}"
                        data-sample_name="${firstTask.sample_name || ''}"
                        data-sample_model="${firstTask.sample_model || ''}"
                        data-materialCode="${firstTask.materialCode || ''}"
                        data-sample_category="${firstTask.sample_category || ''}"
                        data-version="${firstTask.version || ''}"
                        data-priority="${firstTask.priority || ''}"
                        data-sample_leader="${firstTask.sample_leader || ''}"
                        data-supplier="${firstTask.supplier || ''}"
                        data-test_project_category="${firstTask.test_project_category || ''}"
                        data-test_projects="${firstTask.test_projects || ''}"
                        data-schedule="${firstTask.schedule || ''}"
                        data-create_time="${firstTask.create_time || ''}"
                        data-schedule_days="${firstTask.schedule_days || ''}"
                        data-sizecoding="${firstTask.sizecoding || ''}"
                        data-schedule_start_date="${firstTask.schedule_start_date || ''}"
                        data-schedule_end_date="${firstTask.schedule_end_date || ''}"
                        data-schedule_color="${firstTask.schedule_color || ''}"
                        data-remark="${firstTask.remark || ''}"
                        data-sample_sender="${firstTask.sample_sender || ''}"
                        data-sample_type="${firstTask.sample_type || ''}"
                        data-sample_quantity="${firstTask.sample_quantity || ''}"
                        data-high_frequency="${firstTask.high_frequency || ''}"`;

                        // è®¾ç½®ç¬¬äºŒä¸ªä»»åŠ¡çš„ data1- å±æ€§
                        Object.keys(secondTask).forEach(key => {
                            if (key !== 'days') {
                                cellHtml += ` data1-${key}="${secondTask[key] || ''}"`;
                            }
                        });

                        // ä½¿ç”¨ | åˆ†éš”ä¸¤ä¸ªé¡¹ç›®ä¿¡æ¯
                        cellHtml += `>${firstTask.sizecoding} (${firstTask.schedule_days}å¤©)|${secondTask.sizecoding} (${secondTask.schedule_days}å¤©)</td>`;
                        html += cellHtml;
                        colIndex += 1;
                    } else {
                        const task = dateMap[testerName]?.find(t => t.startDate === currentDate);
                        if (task) {
                            const colspan = Math.ceil(task.schedule_days);
                            html += createTaskCell(task, testerName, currentDate, colspan, weekendClass);
                            for (let i = 1; i < colspan; i++) {
                                let styleAttr = 'style="display: none;"';
                                if (weekendClass) {
                                    styleAttr += ` class="${weekendClass}"`;
                                }
                                html += `<td class="drop-cell" ${styleAttr} data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${allDates[colIndex + i]}"></td>`;
                            }
                            colIndex += colspan;
                        } else {
                            const isCovered = dateMap[testerName]?.some(t => t.startDate < currentDate && t.endDate >= currentDate);
                            if (!isCovered) {
                                // ä¿®æ”¹ï¼šæ·»åŠ  weekendClass ç±»å
                                let cellHtml = `<td class="drop-cell ${weekendClass}" data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${currentDate}">`;
                                html += cellHtml + `</td>`;
                            }
                            colIndex += 1;
                        }
                    }
                }

                html += '</tr>';
            });
        });

        html += '</tbody></table>';
        board.innerHTML = html;

        // ä¸ºä»»åŠ¡å•å…ƒæ ¼æ·»åŠ æ‹–æ‹½äº‹ä»¶
        const assignedCells = document.querySelectorAll('#scheduleBoardTable td.assigned');
        assignedCells.forEach(cell => {
            cell.setAttribute('draggable', 'true');
            cell.addEventListener('dragstart', e => {
                const taskData = {};
                const attributes = [
                    'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                    'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                    'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                    'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                    'sample_sender', 'sample_type', 'sample_quantity', 'high_frequency'
                ];
                attributes.forEach(attr => {
                    taskData[attr] = cell.getAttribute(`data-${attr}`);
                });
                Object.entries(taskData).forEach(([key, value]) => {
                    e.dataTransfer.setData(`project-${key}`, value);
                });
            });
        });
        const cells = document.querySelectorAll('.drop-cell');

        // å®šä¹‰å¾…é€æ ·æ± å­çš„å®¹å™¨ ID æ•°ç»„
        const pendingSampleContainerIds = [
            'projectPool',
            'videoSamplePool',
            'wireSamplePool',
            'dataSamplePool',
            'bluetoothSamplePool',
            'highFrequencySamplePool'
        ];

        // è°ƒç”¨é€šç”¨å‡½æ•°ä¸ºå¾…é€æ ·æ± å­çš„å®¹å™¨æ·»åŠ æ‹–æ‹½äº‹ä»¶
        addDragEventsToContainers(pendingSampleContainerIds);

        cells.forEach((cell, cellIndex, cellList) => {
            cell.addEventListener('dragover', e => {
                e.preventDefault();

                cell.classList.add('over');

                // è‡ªåŠ¨æ»šåŠ¨é€»è¾‘
                const scrollSpeed = 10; // æ»šåŠ¨é€Ÿåº¦
                const triggerDistance = 50; // è§¦å‘æ»šåŠ¨çš„è·ç¦»
                const viewportHeight = window.innerHeight;
                const { clientY } = e;

                // é è¿‘é¡¶éƒ¨ï¼Œå‘ä¸Šæ»šåŠ¨
                if (clientY < triggerDistance) {
                    window.scrollBy(0, -scrollSpeed);
                }
                // é è¿‘åº•éƒ¨ï¼Œå‘ä¸‹æ»šåŠ¨
                else if (clientY > viewportHeight - triggerDistance) {
                    window.scrollBy(0, scrollSpeed);
                }
            });

            cell.addEventListener('dragleave', () => cell.classList.remove('over'));

            cell.addEventListener('drop', e => {
                e.preventDefault();
                cell.classList.remove('over');

                const sample_id = e.dataTransfer.getData('project-sample_id');
                const days = parseFloat(e.dataTransfer.getData('project-days')) || 1;
                const sizecoding = e.dataTransfer.getData('project-sizecoding') || 1;

                const tester = cell.getAttribute('data-tester');
                const job_number = cell.getAttribute('data-job_number');
                const startDate = cell.getAttribute('data-date');

                const schedule_days = parseFloat(e.dataTransfer.getData('project-schedule_days')) || 1;

                if ((!sample_id || sample_id.trim() === "")) {
                    console.warn("æ— æ•ˆæ‹–æ‹½å†…å®¹ï¼šsample_id å’Œ schedule_days éƒ½ä¸ºç©ºï¼Œå¿½ç•¥æœ¬æ¬¡æ‹–æ‹½ã€‚");
                    return;
                }

                const startDateObj = new Date(startDate);
                startDateObj.setDate(startDateObj.getDate() + Math.ceil(schedule_days) - 1);
                const schedule_end_date = startDateObj.toISOString().split('T')[0];

                const taskData = {
                    sample_id,
                    days,
                    sizecoding,
                    tester,
                    job_number,
                    startDate,
                    sample_name: e.dataTransfer.getData('project-sample_name'),
                    sample_model: e.dataTransfer.getData('project-sample_model'),
                    materialCode: e.dataTransfer.getData('project-materialCode'),
                    sample_category: e.dataTransfer.getData('project-sample_category'),
                    version: e.dataTransfer.getData('project-version'),
                    priority: e.dataTransfer.getData('project-priority'),
                    sample_leader: e.dataTransfer.getData('project-sample_leader'),
                    supplier: e.dataTransfer.getData('project-supplier'),
                    test_project_category: e.dataTransfer.getData('project-test_project_category'),
                    test_projects: e.dataTransfer.getData('project-test_projects'),
                    schedule: e.dataTransfer.getData('project-schedule'),
                    create_time: e.dataTransfer.getData('project-create_time'),
                    schedule_days: e.dataTransfer.getData('project-schedule_days'),
                    schedule_start_date: startDate,
                    schedule_end_date: schedule_end_date,
                    schedule_color: e.dataTransfer.getData('project-schedule_color'),
                    remark: e.dataTransfer.getData('project-remark'),
                    sample_sender: e.dataTransfer.getData('project-sample_sender'),
                    sample_type: e.dataTransfer.getData('project-sample_type'),
                    sample_quantity: e.dataTransfer.getData('project-sample_quantity'),
                    high_frequency: e.dataTransfer.getData('project-high_frequency')
                };

                const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
                const startIndex = rowCells.indexOf(cell);
                const roundedDays = Math.ceil(parseFloat(schedule_days));

                // æ£€æŸ¥æ’æœŸæ˜¯å¦è¶…å‡ºå¯æ’èŒƒå›´
                if (startIndex + roundedDays > rowCells.length) {
                    alert("æ’æœŸè¶…å‡ºå¯æ’èŒƒå›´ï¼è¯·è®¾ç½®æ›´å¹¿æ³›çš„æ—¥æœŸ");
                    return;
                }

                // æ£€æŸ¥æ’æœŸåŒºåŸŸæ˜¯å¦å·²è¢«å ç”¨
                let conflictFound = false;
                for (let i = startIndex; i < startIndex + roundedDays; i++) {
                    if (rowCells[i].innerText.trim() !== '') {
                        conflictFound = true;
                        break;
                    }
                }

                if (conflictFound) {
                    const confirmInsert = confirm('æ’å…¥ä½ç½®å·²è¢«å ç”¨ï¼Œæ˜¯å¦å°†åç»­é¡¹ç›®å¾€åæŒªï¼Ÿ');
                    if (!confirmInsert) {
                        // åˆ¤æ–­æ˜¯å¦éƒ½æ˜¯ 0.5 å¤©çš„é¡¹ç›®
                        const draggedScheduleDays = parseFloat(taskData.schedule_days);
                        for (let i = startIndex; i < startIndex + roundedDays; i++) {
                            if (rowCells[i].innerText.trim() !== '') {
                                const conflictingScheduleDays = parseFloat(rowCells[i].getAttribute('data-schedule_days'));
                                if (draggedScheduleDays === 0.5 && conflictingScheduleDays === 0.5) {
                                    const confirmMerge = confirm('ä¸¤ä¸ªé¡¹ç›®æ’æœŸå¤©æ•°å‡ä¸º 0.5 å¤©ï¼Œæ˜¯å¦åˆå¹¶å•å…ƒæ ¼ï¼Ÿ');
                                    if (confirmMerge) {
                                        // è·å–å½“å‰å•å…ƒæ ¼ï¼ˆæ‹–æ‹½é¡¹ç›®å°†æ”¾å…¥çš„å•å…ƒæ ¼ï¼‰
                                        const targetCell = rowCells[i];

                                        // åˆ¤æ–­æ˜¯å¦0.5å¤©é¡¹ç›®è‡ªå·±æ‹–è‡ªå·±
                                        const maxSample_id = targetCell.getAttribute('data-sample_id')
                                        if (maxSample_id === sample_id) {
                                            alert("ä¸å…è®¸é¡¹ç›®è‡ªå·±åˆå¹¶è‡ªå·±");
                                            return;
                                        }


                                        // å°†æ‹–æ‹½é¡¹ç›®çš„å±æ€§æ·»åŠ åˆ°ç›®æ ‡å•å…ƒæ ¼ï¼Œç¬¬äºŒä¸ªé¡¹ç›®å±æ€§ä»¥ data1- ä¸ºå‰ç¼€
                                        Object.keys(taskData).forEach(key => {
                                            if (key !== 'days') {
                                                targetCell.setAttribute(`data1-${key}`, taskData[key]);
                                            }
                                        });

                                        // è·å–åŸé¡¹ç›®çš„å±æ€§å¹¶ä¿ç•™
                                        const originalAttributes = {};
                                        const attributesToCopy = [
                                            'sample_id', 'sample_name', 'sample_model', 'materialCode',
                                            'sample_category', 'version', 'priority', 'sample_leader',
                                            'supplier', 'test_project_category', 'test_projects', 'schedule',
                                            'create_time', 'schedule_days', 'schedule_start_date',
                                            'schedule_end_date', 'schedule_color', 'remark', 'job_number', 'tester'
                                        ];
                                        attributesToCopy.forEach(attr => {
                                            originalAttributes[attr] = targetCell.getAttribute(`data-${attr}`);
                                        });

                                        // æ„é€ æ–°çš„æ˜¾ç¤ºæ–‡æœ¬ï¼Œåˆå¹¶ä¸¤ä¸ªé¡¹ç›®ä¿¡æ¯
                                        const originalText = targetCell.innerText;
                                        // const newText = `${originalText}|${taskData.sample_model} ${taskData.materialCode} ${taskData.sample_leader?.charAt(0)} ${taskData.remark} (${taskData.schedule_days}å¤©)`;
                                        const newText = `${originalText}|${taskData.sample_model} ${taskData.materialCode} ${taskData.sample_leader?.charAt(0)} ${taskData.remark?.length > 10 ? taskData.remark.substring(0, 10) + "..." : taskData.remark ?? ""} (${taskData.schedule_days}å¤©)`;


                                        targetCell.innerText = newText;

                                        // æ›´æ–°æ’æœŸå¤©æ•°
                                        const newScheduleDays = 0.5;
                                        targetCell.setAttribute('data-schedule_days', newScheduleDays);

                                        // è®°å½•åˆå¹¶å˜æ›´åˆ° localScheduleChanges
                                        const newChange = {
                                            change: "add",
                                            sample_id: targetCell.getAttribute('data1-sample_id'),
                                            tester: targetCell.getAttribute('data1-tester'),
                                            start_date: targetCell.getAttribute('data1-schedule_start_date'),
                                            // å‡è®¾åˆå¹¶åç»“æŸæ—¥æœŸä¸å˜
                                            end_date: targetCell.getAttribute('data1-schedule_end_date'),
                                            scheduleDays: newScheduleDays,
                                            schedule_color: targetCell.getAttribute('data1-schedule_color'),
                                            job_number: targetCell.getAttribute('data1-job_number')
                                        };

                                        const existingIndex = localScheduleChanges.findIndex(item =>
                                            item.sample_id === targetCell.getAttribute('data1-sample_id')
                                        );

                                        if (existingIndex !== -1) {
                                            localScheduleChanges[existingIndex] = newChange;
                                        } else {
                                            localScheduleChanges.push(newChange);
                                        }

                                        console.log("æ ‡è®°8:",localScheduleChanges)

                                        // ä»åŸå®¹å™¨ç§»é™¤æ‹–æ‹½çš„é¡¹ç›®å¡ç‰‡
                                        const projectEl = document.querySelector(`.project-card[data-sample_id="${taskData.sample_id}"]`);
                                        if (projectEl) projectEl.remove();


                                        const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);
                                        if (originalCell) {
                                            const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                                            const originalStartIndex = originalRowCells.indexOf(originalCell);
                                            const originalScheduleDays = Math.ceil(parseFloat(originalCell.getAttribute('data-schedule_days')));

                                            // æ¸…é™¤åŸå•å…ƒæ ¼å†…å®¹å’Œå±æ€§
                                            originalCell.innerText = '';
                                            originalCell.removeAttribute('colspan');
                                            originalCell.classList.remove('assigned');
                                            originalCell.style.backgroundColor = '';

                                            const allowedAttributes = ['class', 'data-tester', 'data-date', 'data-job_number'];
                                            [...originalCell.attributes].forEach(attr => {
                                                if (!allowedAttributes.includes(attr.name)) {
                                                    originalCell.removeAttribute(attr.name);
                                                }
                                            });

                                            // æ¢å¤è¢«éšè—çš„æ ¼å­
                                            for (let j = originalStartIndex; j < originalStartIndex + originalScheduleDays; j++) {
                                                if (originalRowCells[j]) {
                                                    originalRowCells[j].style.display = '';
                                                }
                                            }
                                        }
                                        return;
                                    } else {
                                        return;
                                    }
                                } else {
                                    return;
                                }
                            }
                        }
                    } else {
                        // åç»­é¡¹ç›®åç§»é€»è¾‘ä¿æŒåŸæœ‰
                        let conflictCells = [];
                        for (let i = startIndex; i < startIndex + roundedDays; i++) {
                            if (rowCells[i].innerText.trim() !== '') {
                                conflictCells.push(rowCells[i]);
                            }
                        }
                        const projectsToMove = [];
                        let diff;
                        if (conflictCells.length > 0) {
                            // æ‰¾åˆ°æ‰€æœ‰éœ€è¦å¾€åæŒªçš„é¡¹ç›®
                            let currentIndex = startIndex;
                            while (currentIndex < rowCells.length) {
                                const currentCell = rowCells[currentIndex];
                                if (currentCell.innerText.trim() !== '' && currentCell.innerText.trim().includes("å¤©)|")){
                                    const projectSpan = parseInt(currentCell.getAttribute('colspan')) || 1;
                                    const projectData = {};
                                    const attributes = [
                                        'sample_id', 'sizecoding', 'tester', 'job_number', 'sample_name',
                                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                                    ];

                                    attributes.forEach(attr => {
                                        const normalKey = attr;
                                        const data1Key = `data1-${attr}`;
                                        const dataKey = `data-${attr}`;

                                        // è·å– data-xxx å’Œ data1-xxx çš„å€¼
                                        const dataValue = currentCell.getAttribute(dataKey);
                                        const data1Value = currentCell.getAttribute(data1Key);

                                        // å­˜å…¥ projectData ä¸­
                                        projectData[normalKey] = dataValue;
                                        projectData[data1Key] = data1Value;
                                    });

                                    projectsToMove.push({
                                        startIndex: currentIndex,
                                        span: projectSpan,
                                        data: projectData
                                    });

                                    currentIndex += projectSpan;
                                }else if(currentCell.innerText.trim() !== '') {
                                    const projectSpan = parseInt(currentCell.getAttribute('colspan')) || 1;
                                    const projectData = {};
                                    const attributes = [
                                        'sample_id', 'sizecoding', 'tester', 'job_number', 'sample_name',
                                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                                    ];
                                    attributes.forEach(attr => {
                                        projectData[attr] = currentCell.getAttribute(`data-${attr}`);
                                    });
                                    projectsToMove.push({
                                        startIndex: currentIndex,
                                        span: projectSpan,
                                        data: projectData
                                    });
                                    currentIndex += projectSpan;
                                } else {
                                    currentIndex++;
                                }
                            }

                            let minStartIndex = Infinity;  // åˆå§‹åŒ–æœ€å°çš„ startIndex å€¼
                            let maxStartIndex = Infinity;  // åˆå§‹åŒ–æœ€å°çš„ startIndex å€¼
                            let maxSpan = Infinity;  // åˆå§‹åŒ–æœ€å°çš„ startIndex å€¼
                            let maxSample_id = '';
                            // æ‰¾åˆ°æœ€å°çš„ startIndex
                            minStartIndex = Math.min(...projectsToMove.map(project => project.startIndex));
                            maxStartIndex = Math.max(...projectsToMove.map(project => project.startIndex));
                            maxSpan = Math.max(...projectsToMove.map(project => project.span));
                            maxSample_id = projectsToMove[0].data.sample_id;

                            // è®¡ç®—æ‹–æ‹½é¡¹ç›®ä¸æœ€å°startIndexçš„å·®å€¼
                            diff = roundedDays - minStartIndex + startIndex;

                            if (maxSample_id === sample_id) {
                                alert("è¯·å…ˆç§»åŠ¨åˆ°åˆ«çš„åœ°æ–¹ï¼ˆä¾‹å¦‚é¡¹ç›®æ± å­æˆ–è€…ç©ºçš„æ—¥æœŸï¼‰ï¼Œå†æ‹–æ‹½å›æ¥");
                                return;
                            }

                            if (maxStartIndex + diff + maxSpan > rowCells.length) {
                                alert("åç»­é¡¹ç›®ç§»åŠ¨åè¶…å‡ºå¯æ’èŒƒå›´ï¼");
                                return;
                            }
                        }

                        // ç¡®è®¤å¯ä»¥æ”¾ç½®é¡¹ç›®åï¼Œå†æ¸…ç©ºåŸæ’æœŸ
                        const originalCell = document.querySelector(`td[data-sample_id="${sample_id}"]`);
                        if (originalCell) {
                            const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                            const originalStartIndex = originalRowCells.indexOf(originalCell);
                            const originalScheduleDays = Math.ceil((originalCell.getAttribute('data-schedule_days')) || 1);

                            // æ¸…é™¤åŸå•å…ƒæ ¼å†…å®¹å’Œå±æ€§
                            originalCell.innerText = '';
                            originalCell.removeAttribute('colspan');
                            originalCell.classList.remove('assigned');
                            originalCell.style.backgroundColor = '';

                            const allowedAttributes = ['class', 'data-tester', 'data-date', 'data-job_number'];
                            [...originalCell.attributes].forEach(attr => {
                                if (!allowedAttributes.includes(attr.name)) {
                                    originalCell.removeAttribute(attr.name);
                                }
                            });

                            // æ¢å¤è¢«éšè—çš„æ ¼å­,é¡¹ç›®æ‹–æ‹½åˆ°åˆ«çš„åœ°æ–¹ï¼Œå…ˆè§¦å‘è¿™é‡Œ
                            for (let i = originalStartIndex; i < Math.min(originalStartIndex + originalScheduleDays, originalRowCells.length); i++) {
                                if (originalRowCells[i]) {
                                    originalRowCells[i].style.display = '';

                                    // æ–°å¢ï¼šå¤åŸå‘¨å…­å’Œå‘¨æ—¥çš„è¾¹æ¡†æ ·å¼
                                    const date = originalRowCells[i].getAttribute('data-date');
                                    setWeekendBorder(originalRowCells[i], date);
                                }
                            }
                        }
                        console.log("111")

                        handleDrop(cell, cellList, taskData, conflictCells, projectsToMove, diff);
                    }
                } else {
                    // æ¸…ç©ºæ‹–æ‹½æ¥æºçš„å•å…ƒæ ¼ï¼Œè¿™é‡Œæ˜¯æ’æœŸé¢æ¿é¡¹ç›®æ‹–æ‹½è§¦å‘çš„æ–¹æ³•ï¼
                    const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);

                    if (originalCell) {

                        // åˆ¤æ–­æ˜¯å¦å«æœ‰ data1- å¼€å¤´æ ‡ç­¾çš„å‚æ•°
                        let hasData1Attr = false;

                        const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                        const originalStartIndex = originalRowCells.indexOf(originalCell);
                        const originalScheduleDays = Math.ceil(parseFloat(originalCell.getAttribute('data-schedule_days')));

                        // å…ˆä¿å­˜åŸå•å…ƒæ ¼çš„ innerText
                        let originalInnerText = "";
                        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ data1- å¼€å¤´çš„å±æ€§
                        [...originalCell.attributes].forEach(attr => {
                            if (attr.name.startsWith('data1-')) {
                                hasData1Attr = true;
                            }
                        });


                        if (hasData1Attr) {
                            const text = originalCell.innerText;
                            const parts = text.split('|');
                            // ç¡®ä¿åˆ†å‰²åæœ‰ååŠéƒ¨åˆ†å†…å®¹
                            if (parts.length > 1) {
                                // ä»ç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹ï¼Œä½¿ç”¨ join æ–¹æ³•å¤„ç†å¯èƒ½æœ‰å¤šä¸ª | çš„æƒ…å†µ
                                originalInnerText = parts.slice(1).join('å¤©)|').trim();
                            } else {
                                originalInnerText = text.trim();
                            }
                        }

                        // æ¸…é™¤åŸå•å…ƒæ ¼å†…å®¹å’Œå±æ€§
                        originalCell.innerText = '';
                        originalCell.removeAttribute('colspan');
                        originalCell.classList.remove('assigned');
                        originalCell.style.backgroundColor = '';


                        // å…è®¸ä¿ç•™çš„å±æ€§ï¼Œæ·»åŠ åˆ¤æ–­ data1- å¼€å¤´çš„å±æ€§
                        const allowedAttributes = ['class', 'data-tester', 'data-date', 'data-job_number'];
                        [...originalCell.attributes].forEach(attr => {
                            const name = attr.name;

                            if (name.startsWith('data1-')) {
                                const newName = name.replace('data1-', 'data-');

                                // å¦‚æœè¦æ›¿æ¢çš„å±æ€§æ˜¯å—ä¿æŠ¤çš„ï¼Œä¸åŠ¨å®ƒï¼
                                if (!allowedAttributes.includes(newName)) {
                                    if (attr.value !== null && attr.value !== 'null') {
                                        originalCell.setAttribute(newName, attr.value);
                                    }
                                    originalCell.removeAttribute(name);
                                } else {
                                    // æ˜¯å—ä¿æŠ¤å±æ€§ï¼Œä¸æ›¿æ¢ä¹Ÿä¸åˆ é™¤
                                    originalCell.removeAttribute(name); // å¯é€‰ï¼šä¹Ÿå¯ä»¥ä¿ç•™ data1-tester ä»¥ä¾¿è°ƒè¯•
                                }
                            } else if (!allowedAttributes.includes(name)) {
                                // æ™®é€šéå—ä¿æŠ¤å±æ€§ï¼Œåˆ é™¤
                                originalCell.removeAttribute(name);
                            }
                        });

                        // æ¢å¤è¢«éšè—çš„æ ¼å­
                        for (let j = originalStartIndex; j < originalStartIndex + originalScheduleDays; j++) {
                            if (originalRowCells[j]) {
                                originalRowCells[j].style.display = '';
                            }
                        }
                        // æ¢å¤åŸå•å…ƒæ ¼çš„ innerText
                        originalCell.innerText = originalInnerText;

                        if (hasData1Attr) {
                            // é‡æ–°è®¾ç½®å¯æ‹–æ‹½å±æ€§
                            originalCell.setAttribute('draggable', 'true');

                            // ç»‘å®šæ‹–æ‹½å¼€å§‹äº‹ä»¶
                            originalCell.addEventListener('dragstart', function (e) {
                                const taskData = {};
                                const attributes = [
                                    'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                                    'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                    'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                    'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                                ];
                                attributes.forEach(attr => {
                                    taskData[attr] = this.getAttribute(`data-${attr}`);
                                });
                                Object.entries(taskData).forEach(([key, value]) => {
                                    e.dataTransfer.setData(`project-${key}`, value);
                                });
                            });

                            // ç»‘å®šå³é”®èœå•äº‹ä»¶
                            originalCell.addEventListener('contextmenu', e => {
                                e.preventDefault();
                                if (originalCell.innerText.trim() === '') return;
                                currentRightClickCell = originalCell;
                                const contextMenu = document.getElementById('contextMenu');
                                contextMenu.style.top = e.pageY + 'px';
                                contextMenu.style.left = e.pageX + 'px';
                                contextMenu.style.display = 'block';
                            });
                        }
                        // è·å–é¢œè‰²å€¼å¹¶æ¸²æŸ“å•å…ƒæ ¼é¢œè‰²
                        const scheduleColor = originalCell.getAttribute('data-schedule_color');
                        if (scheduleColor) {
                            originalCell.style.backgroundColor = scheduleColor;
                        }
                    }
// æ²¡æœ‰å†²çªï¼Œç›´æ¥å¤„ç†æ”¾ç½®,è¿™é‡Œæ˜¯åˆå¹¶çš„å•å…ƒæ ¼æ‹–æ‹½ä¹‹åæ‹†åˆ†åçš„é¡¹ç›®ï¼Œå®ƒæ‹–æ‹½è¿›å…¥çš„æ–¹æ³•
                    console.log("222")
                    handleDrop(cell, cellList, taskData, [], [], 0);



                }
            });


            cell.addEventListener('contextmenu', e => {
                e.preventDefault();
                if (cell.innerText.trim() === '') return;
                currentRightClickCell = cell;
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.display = 'block';
            });
        });

        const contextMenu = document.getElementById('contextMenu');
        contextMenu.addEventListener('click', handleContextMenuClick);

        document.querySelectorAll('#scheduleBoardTable td[data-schedule_color]').forEach(cell => {
            const color = cell.getAttribute('data-schedule_color');
            if (color) {
                cell.style.backgroundColor = color;
            }
        });
    }

    // åˆ›å»ºæ’æœŸé¢æ¿çš„å•å…ƒæ ¼
    function createTaskCell(task, tester, currentDate, colspan, weekendClass) {
        let classAttribute = 'drop-cell assigned';
        if (weekendClass) {
            classAttribute += ` ${weekendClass}`;
        }
        return `
        <td class="drop-cell assigned"
          data-tester="${tester}"
          data-date="${currentDate}"
          data-job_number="${task.job_number}"
          colspan="${colspan}"
          data-sample_id="${task.sample_id || ''}"
          data-sample_name="${task.sample_name || ''}"
          data-sample_model="${task.sample_model || ''}"
          data-materialCode="${task.materialCode || ''}"
          data-sample_category="${task.sample_category || ''}"
          data-version="${task.version || ''}"
          data-priority="${task.priority || ''}"
          data-sample_leader="${task.sample_leader || ''}"
          data-supplier="${task.supplier || ''}"
          data-test_project_category="${task.test_project_category || ''}"
          data-test_projects="${task.test_projects || ''}"
          data-schedule="${task.schedule || ''}"
          data-create_time="${task.create_time || ''}"
          data-schedule_days="${task.schedule_days || ''}"
          data-sizecoding="${task.sizecoding || ''}"
          data-schedule_start_date="${task.schedule_start_date || ''}"
          data-schedule_end_date="${task.schedule_end_date || ''}"
          data-schedule_color="${task.schedule_color || ''}"
          data-remark="${task.remark || ''}"
          data-sample_sender="${task.sample_sender || ''}"
          data-sample_type="${task.sample_type || ''}"
          data-sample_quantity="${task.sample_quantity || ''}"
          data-high_frequency="${task.high_frequency || ''}"
          ${classAttribute}
          >${task.sizecoding} (${task.schedule_days}å¤©)</td>
      `;
    }

    function handleContextMenuClick() {
        // å…³é—­å³é”®èœå•
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'none';
    }



    // å¤„ç†æ‹–æ‹½æ”¾ä¸‹äº‹ä»¶
    function handleDrop(cell, cellList, taskData, conflictCells ,projectsToMove ,diff ) {

        const { sample_id, days, sizecoding, tester, job_number, startDate, schedule_days, schedule_color } = taskData;

        const roundedDays = Math.ceil(parseFloat(schedule_days)); // ä½¿ç”¨ schedule_days ç¡®å®šåˆå¹¶å•å…ƒæ ¼æ•°é‡

        const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
        const startIndex = rowCells.indexOf(cell);

        if (conflictCells.length > 0) {
            // ä»åå¾€å‰ç§»åŠ¨é¡¹ç›®
            for (let i = projectsToMove.length - 1; i >= 0; i--) {
                const { startIndex: projectStartIndex, span, data } = projectsToMove[i];
                const newStartIndex = projectStartIndex + diff;
                console.log("é¡¹ç›®èµ·å§‹ä½ç½®: ", projectStartIndex);
                console.log("æŒªåŠ¨çš„å¤©æ•°: ", diff);
                console.log("æ–°çš„èµ·å§‹ä½ç½®: ", newStartIndex);

                // æ¸…é™¤åŸé¡¹ç›®
                const originalStartCell = rowCells[projectStartIndex];
                originalStartCell.innerText = '';
                originalStartCell.removeAttribute('colspan');
                originalStartCell.classList.remove('assigned');
                originalStartCell.style.backgroundColor = '';
                const allowedAttributes = ['class', 'data-tester', 'data-date'];
                [...originalStartCell.attributes].forEach(attr => {
                    if (!allowedAttributes.includes(attr.name)) {
                        originalStartCell.removeAttribute(attr.name);
                    }
                });

                // æ¢å¤è¢«éšè—çš„æ ¼å­
                for (let j = projectStartIndex; j < projectStartIndex + span; j++) {
                    if (rowCells[j]) rowCells[j].style.display = '';
                }


                // åˆ›å»ºæ–°é¡¹ç›®
                const newStartCell = rowCells[newStartIndex];
                // newStartCell.innerText = `${data.sizecoding} (${data.schedule_days}å¤©)`;
                // åˆ¤æ–­æ˜¯å¦æœ‰ data1-sample_id
                if (data["data1-sample_id"]) {
                    newStartCell.innerText = `${data.sizecoding} (${data.schedule_days}å¤©)|${data["data1-sizecoding"] || ''} (${data["data1-schedule_days"] || ''}å¤©)`;
                } else {
                    newStartCell.innerText = `${data.sizecoding} (${data.schedule_days}å¤©)`;
                }

                newStartCell.classList.add('assigned');
                newStartCell.style.backgroundColor = data.schedule_color || "";
                newStartCell.setAttribute('colspan', span);
                // Object.keys(data).forEach(key => {
                //     if (key !== 'days') {
                //         newStartCell.setAttribute(`data-${key}`, data[key]);
                //     }
                // });


                Object.keys(data).forEach(key => {
                    if (key !== 'days') {
                        if (key.startsWith('data1-')) {
                            // ç›´æ¥å†™å…¥ data1-xxx å±æ€§ï¼ˆä¿æŒåŸæ ·ï¼‰
                            newStartCell.setAttribute(key, data[key]);
                        } else {
                            // æ­£å¸¸ data-xxx å±æ€§
                            newStartCell.setAttribute(`data-${key}`, data[key]);
                        }
                    }
                });


                for (let j = newStartIndex + 1; j < newStartIndex + span; j++) {
                    rowCells[j].style.display = 'none';
                }
                // æ›´æ–° localScheduleChanges
                const newEndDate = rowCells[newStartIndex + span - 1].getAttribute('data-date');
                const newChange = {
                    change: "add",
                    sample_id: data.sample_id,
                    tester: data.tester,
                    start_date: rowCells[newStartIndex].getAttribute('data-date'),
                    end_date: newEndDate,
                    scheduleDays: data.schedule_days,
                    schedule_color: data.schedule_color,
                    job_number: data.job_number
                };

                const existingIndex = localScheduleChanges.findIndex(item =>
                    item.sample_id === data.sample_id
                );
                if (existingIndex !== -1) {
                    localScheduleChanges[existingIndex] = newChange;
                } else {
                    localScheduleChanges.push(newChange);
                }

                if (data["data1-sample_id"]) {
                    const newChangeData1 = {
                        change: "add",
                        sample_id: data["data1-sample_id"],
                        tester: data.tester,  // å¦‚æœä½ ä¹Ÿæœ‰ data1-testerï¼Œå¯ä»¥æ”¹æˆ data["data1-tester"]
                        start_date: rowCells[newStartIndex].getAttribute('data-date'),
                        end_date: newEndDate,
                        scheduleDays: data["data1-schedule_days"],
                        schedule_color: data["data1-schedule_color"],
                        job_number: data.job_number  // å¦‚æœä½ ä¹Ÿæœ‰ data1-job_numberï¼Œå¯ä»¥æ”¹æˆ data["data1-job_number"]
                    };

                    const existingIndexData1 = localScheduleChanges.findIndex(item =>
                        item.sample_id === data["data1-sample_id"]
                    );
                    if (existingIndexData1 !== -1) {
                        localScheduleChanges[existingIndexData1] = newChangeData1;
                    } else {
                        localScheduleChanges.push(newChangeData1);
                    }
                }
                console.log("æ ‡è®°6",localScheduleChanges)

                // æ·»åŠ å…è®¸æ‹–æ‹½çš„æ–¹æ³•
                newStartCell.setAttribute('draggable', 'true');
                newStartCell.addEventListener('dragstart', function (e) {
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                    ];
                    attributes.forEach(attr => {
                        taskData[attr] = this.getAttribute(`data-${attr}`);
                    });
                    Object.entries(taskData).forEach(([key, value]) => {
                        e.dataTransfer.setData(`project-${key}`, value);
                    });
                });
            }
        }

        // å¦‚æœæ˜¯å·²æœ‰é¡¹ç›®æ‹–åŠ¨è¿›æ¥ï¼Œå…ˆæ¸…é™¤åŸä½ç½®
        const oldIndex = rowCells.findIndex(c => c.getAttribute('data-sample_id') === sample_id);
        if (oldIndex !== -1) {
            const span = parseInt(rowCells[oldIndex].getAttribute('colspan') || 1, 10);

            rowCells[oldIndex].innerText = '';
            rowCells[oldIndex].removeAttribute('colspan');
            rowCells[oldIndex].classList.remove('assigned');
            rowCells[oldIndex].style.backgroundColor = '';
            const allowedAttributes = ['class', 'data-tester', 'data-date'];
            [...rowCells[oldIndex].attributes].forEach(attr => {
                if (!allowedAttributes.includes(attr.name)) {
                    rowCells[oldIndex].removeAttribute(attr.name);
                }
            });
            for (let i = oldIndex; i < oldIndex + span; i++) {
                if (rowCells[i]) rowCells[i].style.display = '';

            }
        }


        // æ”¾ç½®æ–°æ’å…¥çš„é¡¹ç›®
        const startCell = rowCells[startIndex];
        startCell.innerText = `${sizecoding} (${schedule_days}å¤©)`;
        startCell.classList.add('assigned');
        startCell.style.backgroundColor = schedule_color || "";
        startCell.setAttribute('colspan', roundedDays);
        Object.keys(taskData).forEach(key => {
            if (key !== 'days') {
                startCell.setAttribute(`data-${key}`, taskData[key]);
            }
        });
        for (let i = startIndex + 1; i < startIndex + roundedDays; i++) {
            rowCells[i].style.display = 'none';
        }
        const projectEl = document.querySelector(`.project-card[data-sample_id="${sample_id}"]`);
        if (projectEl) projectEl.remove();

        const targetCell = rowCells[startIndex + roundedDays - 1];
        if (!targetCell) {
            console.warn("æ— æ•ˆæ‹–æ‹½å†…å®¹ï¼šè¯·å‹¿é€‰æ‹©åˆ«çš„è¿›è¡Œæ‹–æ‹½ï¼Œå¿½ç•¥æœ¬æ¬¡æ‹–æ‹½ã€‚");
            return;
        }

        const endDate = rowCells[startIndex + roundedDays - 1].getAttribute('data-date');
        // æ„é€ æ–°çš„å˜æ›´å¯¹è±¡
        const newChange = {
            change: "add",
            sample_id: sample_id,
            tester,
            start_date: startDate,
            end_date: endDate,
            scheduleDays: schedule_days,
            schedule_color: schedule_color,
            job_number: job_number
        };
        // æŸ¥æ‰¾å¹¶æ›´æ–°å·²æœ‰è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™æ·»åŠ 
        const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
        );
        if (existingIndex !== -1) {
            localScheduleChanges[existingIndex] = newChange;
        } else {
            localScheduleChanges.push(newChange);
        }
        console.log("æ ‡è®°7",localScheduleChanges);
        // é‡æ–°ä¸ºæ–°ç”Ÿæˆçš„æ’æœŸå•å…ƒæ ¼æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        startCell.setAttribute('draggable', 'true');
        startCell.addEventListener('dragstart', function (e) {
            const taskData = {};
            const attributes = [
                'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color' , 'remark'
            ];
            attributes.forEach(attr => {
                taskData[attr] = this.getAttribute(`data-${attr}`);
            });
            Object.entries(taskData).forEach(([key, value]) => {
                e.dataTransfer.setData(`project-${key}`, value);
            });
        });
    }


    // å¤„ç†æ’¤å›æ’æœŸäº‹ä»¶ï¼Œæ’¤å›æ’æœŸæŒ‰é’®è§¦å‘è¿™ä¸ªæ–¹æ³•
    function handleUndo(rowCells, startIndex, taskData, container, originalCell, isRenderCard = false) {
        const { schedule_days, sample_id } = taskData;
        const currentRightClickCell = rowCells[startIndex];

        let change = "delete";

        // æ¸…é™¤åŸå§‹å†…å®¹å’Œå±æ€§
        currentRightClickCell.innerText = '';
        currentRightClickCell.removeAttribute('colspan');
        currentRightClickCell.classList.remove('assigned');

        const allowedAttributes = ['class', 'data-tester', 'data-date','data-job_number'];

        // è¿™é‡Œæ˜¯è´Ÿè´£æŠŠåˆå¹¶é¡¹ç›®æ‹–å›å»ï¼Œæ¢å¤æ’æœŸé¢æ¿åŸæ¥data1æ•°æ®
        // åˆ¤æ–­æ˜¯å¦å«æœ‰ data1- å¼€å¤´æ ‡ç­¾çš„å‚æ•°
        let hasData1Attr = false;

        // å…ˆä¿å­˜åŸå•å…ƒæ ¼çš„ innerText
        let originalInnerText = "";
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ data1- å¼€å¤´çš„å±æ€§
        if(originalCell){
            [...originalCell.attributes].forEach(attr => {
                if (attr.name.startsWith('data1-')) {
                    hasData1Attr = true;
                }
            });
            if (hasData1Attr) {
                const text = originalCell.getAttribute("data1-sizecoding") + "(" + originalCell.getAttribute("data1-schedule_days") + "å¤©)";
                originalInnerText = text.trim();
            }
            // æ¸…é™¤åŸå•å…ƒæ ¼å†…å®¹å’Œå±æ€§
            originalCell.innerText = '';
            originalCell.removeAttribute('colspan');
            originalCell.classList.remove('assigned');
            originalCell.style.backgroundColor = '';

            // æ¢å¤åŸå•å…ƒæ ¼çš„ innerText
            originalCell.innerText = originalInnerText;

            [...originalCell.attributes].forEach(attr => {
                const name = attr.name;

                if (name.startsWith('data1-')) {
                    const newName = name.replace('data1-', 'data-');

                    // å¦‚æœè¦æ›¿æ¢çš„å±æ€§æ˜¯å—ä¿æŠ¤çš„ï¼Œä¸åŠ¨å®ƒï¼
                    if (!allowedAttributes.includes(newName)) {
                        if (attr.value !== null && attr.value !== 'null') {
                            originalCell.setAttribute(newName, attr.value);
                        }
                        originalCell.removeAttribute(name);
                    } else {
                        // æ˜¯å—ä¿æŠ¤å±æ€§ï¼Œä¸æ›¿æ¢ä¹Ÿä¸åˆ é™¤
                        originalCell.removeAttribute(name); // å¯é€‰ï¼šä¹Ÿå¯ä»¥ä¿ç•™ data1-tester ä»¥ä¾¿è°ƒè¯•
                    }
                } else if (!allowedAttributes.includes(name)) {
                    // æ™®é€šéå—ä¿æŠ¤å±æ€§ï¼Œåˆ é™¤
                    originalCell.removeAttribute(name);
                }
            });

            if (hasData1Attr) {
                // é‡æ–°è®¾ç½®å¯æ‹–æ‹½å±æ€§
                originalCell.setAttribute('draggable', 'true');

                // ç»‘å®šæ‹–æ‹½å¼€å§‹äº‹ä»¶
                originalCell.addEventListener('dragstart', function (e) {
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                        'sample_sender','sample_type','sample_quantity','high_frequency'
                    ];
                    attributes.forEach(attr => {
                        taskData[attr] = this.getAttribute(`data-${attr}`);
                    });
                    Object.entries(taskData).forEach(([key, value]) => {
                        e.dataTransfer.setData(`project-${key}`, value);
                    });
                });
            }

            // è·å–é¢œè‰²å€¼å¹¶æ¸²æŸ“å•å…ƒæ ¼é¢œè‰²
            const scheduleColor = originalCell.getAttribute('data-schedule_color');
            if (scheduleColor) {
                originalCell.style.backgroundColor = scheduleColor;
            }

        }else{
            [...currentRightClickCell.attributes].forEach(attr => {
                if (!allowedAttributes.includes(attr.name)) {
                    currentRightClickCell.removeAttribute(attr.name);
                }
            });
        }


        // æ¢å¤è¢«éšè—çš„æ ¼å­
        for (let i = startIndex; i < Math.min(startIndex + Number(schedule_days), rowCells.length); i++) {
            if (rowCells[i]){
                console.log("æ ‡è®°2");
                rowCells[i].style.display = '';

                const date = rowCells[i].getAttribute('data-date');
                setWeekendBorder(rowCells[i], date);
            }
        }

        if(isRenderCard){
            change = "drop";

        }else{
            // é‡æ–°ç”Ÿæˆæ‹–æ‹½é¡¹ç›®å¡ç‰‡
            const restoredProject = document.createElement('div');
            restoredProject.className = 'project-card';

            // âœ… è®¾ç½®é¢œè‰² classï¼ˆé»˜è®¤ grayï¼‰
            const colorClass = taskData.schedule_color || 'gray';
            restoredProject.classList.add(colorClass);

            restoredProject.setAttribute('draggable', 'true');
            restoredProject.setAttribute('data-sample_id', sample_id);
            restoredProject.setAttribute('data-schedule_days', schedule_days);
            //   è¿™é‡Œ
            restoredProject.textContent = `${taskData.sizecoding} (${schedule_days}å¤©)`;

            //è¿™é‡Œæ˜¯æ’¤å›æ’æœŸç‚¹å‡»çš„æ—¶å€™ï¼Œæ”¾å›å»çš„æ—¶å€™æ£€æŸ¥å“ªäº›æ ‡ç­¾å»æ‰
            Object.keys(taskData).forEach(key => {
                if (key !== 'days' && key !== 'schedule_start_date' && key !== 'schedule_end_date' && key!== 'job_number'
                    && key!== 'tester') {
                    restoredProject.setAttribute(`data-${key}`, taskData[key]);
                }
            });

            setDraggable(restoredProject, true);

            const restoredItem = {
                sample_id: sample_id,
                sample_name: taskData.sample_name,
                sample_model: taskData.sample_model,
                materialCode: taskData.materialCode,
                sample_category: taskData.sample_category,
                version: taskData.version,
                priority: taskData.priority,
                sample_leader: taskData.sample_leader,
                supplier: taskData.supplier,
                testProjectCategory: taskData.test_project_category,
                testProjects: taskData.test_projects,
                schedule: taskData.schedule,
                create_time: taskData.create_time,
                scheduleDays: schedule_days,
                schedule_color: taskData.schedule_color,
                remark: taskData.remark,
                sample_sender: taskData.sample_sender,
                sample_type: taskData.sample_type,
                sample_quantity: taskData.sample_quantity,
                high_frequency: taskData.high_frequency
            };

            restoredProject.oncontextmenu = (event) => {
                event.preventDefault();
                bindCardContextMenu(restoredProject, restoredItem);
            };

            // è¿™é‡Œæ˜¯æ’æœŸé¢æ¿æ‹–æ‹½é¡¹ç›®åˆ°æ± å­çš„å®¹å™¨å­˜æ”¾åŒºåŸŸï¼Œæˆ‘æ¥ä¸‹æ¥è¦åˆ¤å®šæ”¾åœ¨å“ªä¸ªæ± å­ï¼Œ0605
            container.appendChild(restoredProject);
        }






        // è®°å½•åˆ é™¤æ“ä½œåˆ° localScheduleChangesï¼Œé¿å…é‡å¤æ·»åŠ 
        const newChange = {
            change: change,
            sample_id: sample_id,
            tester: taskData.tester,
            start_date: taskData.schedule_start_date,
            end_date: taskData.schedule_end_date,
            scheduleDays: schedule_days,
            schedule_color: taskData.schedule_color,
            job_number: taskData.job_number,
            container: container.id
        };

        const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
        );

        if (existingIndex !== -1) {
            localScheduleChanges[existingIndex] = newChange;
        } else {
            localScheduleChanges.push(newChange);
        }

        console.log("deleteçš„",localScheduleChanges);
    }
    // å·¥å…·å‡½æ•°ï¼šç”ŸæˆæŸèŒƒå›´å†…æ‰€æœ‰æ—¥æœŸå­—ç¬¦ä¸²æ•°ç»„
    function getDateRange(start, end) {
        const dates = [];
        const current = new Date(start);
        const last = new Date(end);
        while (current <= last) {
            const yyyy = current.getFullYear();
            const mm = String(current.getMonth() + 1).padStart(2, '0');
            const dd = String(current.getDate()).padStart(2, '0');
            dates.push(`${yyyy}-${mm}-${dd}`);
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }

    function showProjectAttributes(event) {
        if (event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        }
        if (!currentRightClickCell) return;
        const taskData = {
            sample_id: currentRightClickCell.getAttribute('data-sample_id'),
            sample_name: currentRightClickCell.getAttribute('data-sample_name'),
            sample_model: currentRightClickCell.getAttribute('data-sample_model'),
            materialCode: currentRightClickCell.getAttribute('data-materialCode'),
            sample_category: currentRightClickCell.getAttribute('data-sample_category'),
            version: currentRightClickCell.getAttribute('data-version'),
            priority: currentRightClickCell.getAttribute('data-priority'),
            sample_leader: currentRightClickCell.getAttribute('data-sample_leader'),
            supplier: currentRightClickCell.getAttribute('data-supplier'),
            test_project_category: currentRightClickCell.getAttribute('data-test_project_category'),
            test_projects: currentRightClickCell.getAttribute('data-test_projects'),
            schedule: currentRightClickCell.getAttribute('data-schedule'),
            create_time: currentRightClickCell.getAttribute('data-create_time'),
            scheduleDays: currentRightClickCell.getAttribute('data-schedule_days'),
            schedule_color: currentRightClickCell.getAttribute('data-schedule_color'),
            remark: currentRightClickCell.getAttribute('data-remark'),
            sample_sender: currentRightClickCell.getAttribute('data-sample_sender'),
            sample_type: currentRightClickCell.getAttribute('data-sample_type'),
            sample_quantity: currentRightClickCell.getAttribute('data-sample_quantity'),
            high_frequency: currentRightClickCell.getAttribute('data-high_frequency')
        };

        // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
        document.getElementById('modalBody').innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <p><strong>ç”µæ°”ç¼–å·ï¼š</strong></p>
                <input type="text" id="editSampleId" value="${taskData.sample_id}">
                <button id="editSampleIdBtn">ä¿®æ”¹</button>
            </div>
            <p><strong>é¡¹ç›®åç§°ï¼š</strong>${taskData.sample_name}</p>
            <p><strong>å¤§å°ç¼–ç ï¼š</strong>${taskData.sample_model + ' ' + taskData.materialCode}</p>
            <p><strong>äº§å“ç±»åˆ«ï¼š</strong>${taskData.sample_category}</p>
            <p><strong>ç‰ˆæœ¬ï¼š</strong>${taskData.version}</p>
            <p><strong>ä¼˜å…ˆçº§ï¼š</strong>${taskData.priority}</p>
            <p><strong>é¡¹ç›®è´Ÿè´£äººï¼š</strong>${taskData.sample_leader}</p>
            <p><strong>ä¾›åº”å•†ï¼š</strong>${taskData.supplier}</p>
            <p><strong>è¯•éªŒé¡¹ç›®ç±»åˆ«ï¼š</strong>${taskData.test_project_category}</p>
            <p><strong>æµ‹è¯•å­é¡¹ç›®ï¼š</strong>${taskData.test_projects}</p>
            <p><strong>çŠ¶æ€ï¼š</strong>${getScheduleText(taskData.schedule)}</p>
            <p><strong>é€æ ·äººï¼š</strong>${taskData.sample_sender}</p>
            <p><strong>é€æ ·ç±»åˆ«ï¼š</strong>${taskData.sample_type}</p>
            <p><strong>é€æ ·æ•°é‡ï¼š</strong>${taskData.sample_quantity}</p>
            <p><strong>æ˜¯å¦é«˜é¢‘ï¼š</strong>${taskData.high_frequency}</p>
            <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${taskData.create_time}</p>
        `;

        document.getElementById('scheduleDays').value = taskData.scheduleDays != null ? taskData.scheduleDays : '';
        // è®¾ç½®é€‰ä¸­çš„é¢œè‰²ï¼Œé»˜è®¤é€‰æ— è‰²
        const selectedColor = taskData.schedule_color ? taskData.schedule_color : 'null';
        const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
        if (colorRadio) {
            colorRadio.checked = true;
        }

        document.getElementById('sampleRemark').value = taskData.remark != null? taskData.remark : '';

        document.getElementById('saveScheduleBtn').onclick = function () {
            const sampleId = currentRightClickCell.getAttribute('data1-sample_id');

            if (sampleId) {
                alert("è¿™æ˜¯ä¸¤ä¸ª 0.5 å¤©é¡¹ç›®åˆå¹¶çš„å•å…ƒæ ¼ï¼Œåªå…è®¸å…ˆæ‹†åˆ†å†è®¾ç½®å…¶ä»–ç”µæ°”ç¼–å·ï¼Œæ’æœŸå¤©æ•°ã€é¢œè‰²å’Œå¤‡æ³¨ã€‚");
                return; // é˜»æ­¢åç»­æ“ä½œ
            }
            saveScheduleAndColor(null, taskData);
        };

        document.getElementById('confirmColorBtn').onclick = function () {
            const sampleId = currentRightClickCell.getAttribute('data1-sample_id');

            if (sampleId) {
                alert("è¿™æ˜¯ä¸¤ä¸ª 0.5 å¤©é¡¹ç›®åˆå¹¶çš„å•å…ƒæ ¼ï¼Œåªå…è®¸å…ˆæ‹†åˆ†å†è®¾ç½®å…¶ä»–ç”µæ°”ç¼–å·ï¼Œæ’æœŸå¤©æ•°ã€é¢œè‰²å’Œå¤‡æ³¨ã€‚");
                return; // é˜»æ­¢åç»­æ“ä½œ
            }
            saveScheduleAndColor(null, taskData);
        };

        document.getElementById('saveRemarkBtn').onclick = function () {
            const sampleId = currentRightClickCell.getAttribute('data1-sample_id');

            if (sampleId) {
                alert("è¿™æ˜¯ä¸¤ä¸ª 0.5 å¤©é¡¹ç›®åˆå¹¶çš„å•å…ƒæ ¼ï¼Œåªå…è®¸å…ˆæ‹†åˆ†å†è®¾ç½®å…¶ä»–ç”µæ°”ç¼–å·ï¼Œæ’æœŸå¤©æ•°ã€é¢œè‰²å’Œå¤‡æ³¨ã€‚");
                return; // é˜»æ­¢åç»­æ“ä½œ
            }
            saveScheduleAndColor(null, taskData);
        };

        document.getElementById('modal').style.display = 'block';

        // å…³é—­å³é”®èœå•
        const contextMenuForShow = document.getElementById('contextMenu');
        contextMenuForShow.style.display = 'none';

        // ç»‘å®šä¿®æ”¹ç”µæ°”ç¼–å·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('editSampleIdBtn').addEventListener('click', function () {
            const sampleId = currentRightClickCell.getAttribute('data1-sample_id');

            if (sampleId) {
                alert("è¿™æ˜¯ä¸¤ä¸ª 0.5 å¤©é¡¹ç›®åˆå¹¶çš„å•å…ƒæ ¼ï¼Œåªå…è®¸å…ˆæ‹†åˆ†å†è®¾ç½®å…¶ä»–ç”µæ°”ç¼–å·ï¼Œæ’æœŸå¤©æ•°ã€é¢œè‰²å’Œå¤‡æ³¨ã€‚");
                return; // é˜»æ­¢åç»­æ“ä½œ
            }

            const newSampleId = document.getElementById('editSampleId').value;
            const oldSampleId = taskData.sample_id;

            // å‘é€è¯·æ±‚åˆ°æ§åˆ¶å±‚
            fetch('/scheduleBoard/updateElectricSampleId', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldSampleId: oldSampleId,
                    newSampleId: newSampleId
                })
            })
                .then(response => response.json())
                .then(async result => {
                    if (result.success) {
                        alert(result.message);
                        // åˆ·æ–°æ’æœŸé¢æ¿
                        await refreshSchedule();

                    } else {
                        alert(result.message);
                    }
                })
                .catch(error => {
                    console.error('ä¿®æ”¹ç”µæ°”ç¼–å·æ—¶å‡ºé”™:', error);
                    alert('ä¿®æ”¹ç”µæ°”ç¼–å·æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•');
                });
        });

    }


    function getScheduleText(code) {
        switch (code) {
            case "15":
                return "å¾…æ’æœŸ";
            case "16":
                return "å·²æ’æœŸå¾…æµ‹è¯•";
            case "0":
                return "æµ‹è¯•ä¸­";
            case "1":
                return "å¾…å®¡æ ¸";
            case "2":
                return "å®¡æ ¸å®Œæˆ";
            case "9":
                return "æ ·å“é€€æ ·";
            case "10":
                return "ç«å“å®Œæˆ";
            default:
                return code || "";
        }
    }



    // ç»‘å®šå˜æ›´è®°å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function () {
        const changeLogBtn = document.getElementById('changeLogBtn');
        changeLogBtn.addEventListener('click', function () {
            // const sample_id = document.getElementById('modalBody').querySelector('p:nth-child(1)').textContent.split('ï¼š')[1].trim();
            const sample_id = document.getElementById('editSampleId').value.trim();

            fetch(`/api/getChangeLog?sample_id=${sample_id}`)
                .then(response => response.json())
                .then(data => {
                    const changeLogBody = document.getElementById('changeLogBody');
                    changeLogBody.innerHTML = '';

                    if (data.length === 0) {
                        changeLogBody.innerHTML = 'æš‚æ— å˜æ›´è®°å½•ã€‚';
                    } else {
                        const template = document.getElementById('changeLogTemplate').innerHTML;

                        data.forEach(change => {
                            let itemHTML = template
                                .replace('{{tester}}', change.tester)
                                .replace('{{startDate}}', change.startDate)
                                .replace('{{endDate}}', change.endDate)
                                .replace('{{updateTime}}', change.updateTime || 'æ— ')
                                .replaceAll('{{color}}', change.color)
                                .replace('{{used}}', change.used)
                                .replace('{{remark}}', change.remark)

                            changeLogBody.insertAdjacentHTML('beforeend', itemHTML);
                        });
                    }

                    document.getElementById('changeLogModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('è·å–å˜æ›´è®°å½•å¤±è´¥:', error);
                    document.getElementById('changeLogBody').innerHTML = 'è·å–å˜æ›´è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                });
        });

    });



    // åŠ è½½å¾…é€æ ·æ± å­æ•°æ®
    function loadPendingSamplePoolData() {
        const categories = [
            { id: 'videoSamplePool', name: 'è§†é¢‘ç±»' },
            { id: 'wireSamplePool', name: 'çº¿æç±»' },
            { id: 'dataSamplePool', name: 'æ•°æ®ç±»' },
            { id: 'bluetoothSamplePool', name: 'è“ç‰™ç±»' },
            { id: 'highFrequencySamplePool', name: 'é«˜é¢‘ç±»' }
        ];

        categories.forEach(category => {
            fetch(`/passback/getPendingSampleData?category=${category.name}`)
                .then(response => response.json())
                .then(data => {
                    renderPendingSamplePool(data, category.id);
                })
                .catch(error => {
                    document.getElementById(category.id).innerHTML = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    console.error('Error fetching pending sample data:', error);
                });
        });
    }

    // æ¸²æŸ“å¾…é€æ ·æ± å­
    function renderPendingSamplePool(data, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = 'æš‚æ— è¯¥ç±»åˆ«å¾…é€æ ·æ•°æ®ã€‚';
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'project-card';

            const scheduleColor = item.schedule_color || 'null';
            card.classList.add(scheduleColor);
            // card.textContent = item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0)  + " " + item.remark+ " " +"(" + item.scheduleDays + "å¤©)";
            card.textContent =
                item.sample_model + " " +
                item.materialCode + " " +
                item.sample_leader.charAt(0) + " " +
                (item.remark?.length > 10 ? item.remark.substring(0, 10) + "..." : item.remark ?? "") + " " +
                "(" + item.scheduleDays + "å¤©)";


            card.setAttribute('data-sizecoding', item.sample_model + " " + item.materialCode + " "+ item.sample_leader.charAt(0) + " " + item.remark );
            card.setAttribute('data-sample_id', item.sample_id || '');
            card.setAttribute('data-sample_name', item.sample_name || '');
            card.setAttribute('data-sample_model', item.sample_model || '');
            card.setAttribute('data-materialCode', item.materialCode || '');
            card.setAttribute('data-sample_category', item.sample_category || '');
            card.setAttribute('data-version', item.version || '');
            card.setAttribute('data-priority', item.priority || '');
            card.setAttribute('data-sample_leader', item.sample_leader || '');
            card.setAttribute('data-supplier', item.supplier || '');
            card.setAttribute('data-test_project_category', item.testProjectCategory || '');
            card.setAttribute('data-test_projects', item.testProjects || '');
            card.setAttribute('data-schedule', item.schedule || '');
            card.setAttribute('data-create_time', item.create_time || '');
            // card.setAttribute('data-schedule_days', item.scheduleDays != null ? item.scheduleDays : '1');
            card.setAttribute('data-schedule_days', item.scheduleDays);
            card.setAttribute('data-schedule_color', item.schedule_color != null ? item.schedule_color : '');
            card.setAttribute('data-remark', item.remark != null ? item.remark : '');
            card.setAttribute('data-sample_sender', item.sample_sender != null ? item.sample_sender : '');
            card.setAttribute('data-sample_type', item.sample_type != null ? item.sample_type : '');
            card.setAttribute('data-sample_quantity', item.sample_quantity != null ? item.sample_quantity : '');
            card.setAttribute('data-high_frequency', item.high_frequency != null ? item.high_frequency : '');
            card.setAttribute('draggable', 'true');

            setDraggable(card, false);
            bindCardContextMenu(card, item);
            container.appendChild(card);
        });
    }

    // é€šç”¨å‡½æ•°ï¼Œä¸ºæŒ‡å®šå®¹å™¨æ·»åŠ æ‹–æ‹½ç›¸å…³äº‹ä»¶
    // ... existing code ...
    function addDragEventsToContainers(containerIds) {
        containerIds.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                // ä¸ºå®¹å™¨æ·»åŠ  dragover äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸ºä»¥å…è®¸æ”¾ç½®
                container.addEventListener('dragover', e => {
                    e.preventDefault();
                });

                // ä¸ºå®¹å™¨æ·»åŠ  drop äº‹ä»¶ç›‘å¬å™¨ï¼Œå¤„ç†æ‹–æ‹½æ”¾ä¸‹çš„é€»è¾‘
                container.addEventListener('drop', e => {
                    e.preventDefault();
                    console.log("æ‹–11");
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                        'sample_sender','sample_type','sample_quantity','high_frequency'
                    ];
                    attributes.forEach(attr => {
                        taskData[attr] = e.dataTransfer.getData(`project-${attr}`);
                    });

                    // æ‹¦æˆªæ‹–æ‹½ç©º sample_id çš„æƒ…å†µ
                    if (!taskData.sample_id || taskData.sample_id.trim() === "") {
                        console.warn("æ— æ•ˆæ‹–æ‹½ï¼šsample_id ä¸ºç©ºï¼Œå¿½ç•¥æœ¬æ¬¡æ‹–æ‹½ã€‚");
                        return;
                    }


                    // ä»åŸå®¹å™¨ç§»é™¤å¡ç‰‡
                    const fromContainerId = e.dataTransfer.getData('project-from_container');
                    if (fromContainerId) {
                        const fromContainer = document.getElementById(fromContainerId);
                        if (fromContainer) {
                            const existingCard = fromContainer.querySelector(`[data-sample_id="${taskData.sample_id}"]`);
                            if (existingCard) {
                                existingCard.remove();
                            }
                        }
                    }

                    // ä»æ’æœŸé¢æ¿ç§»é™¤
                    const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);
                    if (originalCell) {
                        const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                        const originalStartIndex = originalRowCells.indexOf(originalCell);

                        handleUndo(originalRowCells, originalStartIndex, taskData, container,originalCell);
                    } else {
                        // æ–°å¢ï¼šæ£€æŸ¥ç›®æ ‡å®¹å™¨æ˜¯å¦å·²ç»å­˜åœ¨è¯¥å¡ç‰‡
                        const existingCardInTarget = container.querySelector(`[data-sample_id="${taskData.sample_id}"]`);
                        if (existingCardInTarget) {
                            existingCardInTarget.remove();
                        }
                        // ç›´æ¥ä»å…¶ä»–æ± å­æ‹–æ‹½è¿‡æ¥ï¼Œåˆ›å»ºæ–°å¡ç‰‡
                        const newCard = document.createElement('div');
                        newCard.className = 'project-card';
                        const scheduleColor = taskData.schedule_color || 'null';
                        newCard.classList.add(scheduleColor);
                        newCard.textContent = `${taskData.sample_model} ${taskData.materialCode} ${taskData.sample_leader?.charAt(0)} ${taskData.remark} (${taskData.schedule_days}å¤©)`;

                        Object.keys(taskData).forEach(key => {
                            if (key !== 'days' && key !== 'schedule_start_date' && key !== 'schedule_end_date' && key!== 'job_number' && key!== 'tester') {
                                newCard.setAttribute(`data-${key}`, taskData[key]);
                            }
                        });

                        newCard.setAttribute('draggable', 'true');
                        setDraggable(newCard, false);
                        bindCardContextMenu(newCard, taskData);
                        container.appendChild(newCard);

                        // è®°å½•å˜æ›´
                        const newChange = {
                            change: "delete",
                            sample_id: taskData.sample_id,
                            tester: taskData.tester,
                            start_date: taskData.schedule_start_date,
                            end_date: taskData.schedule_end_date,
                            scheduleDays: taskData.schedule_days,
                            schedule_color: taskData.schedule_color,
                            job_number: taskData.job_number,
                            container: container.id
                        };
                        const existingIndex = localScheduleChanges.findIndex(item =>
                            item.sample_id === taskData.sample_id
                        );
                        if (existingIndex !== -1) {
                            localScheduleChanges[existingIndex] = newChange;
                        } else {
                            localScheduleChanges.push(newChange);
                        }

                    }
                });

                // ä¸ºå®¹å™¨ä¸­çš„å¡ç‰‡æ·»åŠ  dragstart äº‹ä»¶ï¼Œè®°å½•æ¥æºå®¹å™¨
                // container.addEventListener('dragstart', e => {
                //     const target = e.target.closest('.project-card');
                //     if (target) {
                //         e.dataTransfer.setData('project-from_container', container.id);
                //     }
                // });

                // æ·»åŠ åˆ¤æ–­ï¼Œç¦æ­¢ç”¨æˆ·æ‹–ç€æ–‡å­—
                container.addEventListener('dragstart', e => {
                    let target = e.target;

                    // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œåˆ™è·å–å…¶çˆ¶å…ƒç´ 
                    if (target.nodeType === Node.TEXT_NODE) {
                        target = target.parentElement;
                    }

                    // åªå…è®¸æ‹–æ‹½ project-card å…ƒç´ ï¼Œå…¶ä»–ä¸å…è®¸
                    const card = target.closest('.project-card');

                    // å¦‚æœæ‹–æ‹½ç›®æ ‡ä¸æ˜¯ .project-cardï¼Œåˆ™ä¸å…è®¸
                    if (!card || window.getSelection().toString().trim()) {
                        e.preventDefault(); // é˜»æ­¢æ‹–æ‹½
                        console.log('åªå…è®¸æ‹–æ‹½å•ä¸ªå¡ç‰‡ï¼Œä¸èƒ½æ‹–æ‹½å¤šé¡¹æˆ–æ–‡å­—ï¼');
                        return;
                    }

                    e.dataTransfer.setData('project-from_container', container.id);
                });

            }
        });
    }

    // åœ¨ DOM åŠ è½½å®Œæˆåç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function () {
        const addProjectBtn = document.getElementById('addProjectBtn');
        const addProjectModal = document.getElementById('addProjectModal');
        const closeAddProjectModalBtn = document.getElementById('closeAddProjectModalBtn');
        const saveNewProjectBtn = document.getElementById('saveNewProjectBtn');

        // ç‚¹å‡»æ–°å¢é¡¹ç›®æŒ‰é’®æ˜¾ç¤ºæ¨¡æ€æ¡†
        addProjectBtn.addEventListener('click', function () {
            addProjectModal.style.display = 'block';
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—æ¨¡æ€æ¡†
        closeAddProjectModalBtn.addEventListener('click', function () {
            addProjectModal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨éšè—æ¨¡æ€æ¡†
        addProjectModal.addEventListener('click', function (e) {
            if (e.target === addProjectModal) {
                addProjectModal.style.display = 'none';
            }
        });

        // ä¿å­˜æ–°å¢é¡¹ç›®
        saveNewProjectBtn.addEventListener('click', function () {
            const sample_name = document.getElementById('addSampleName').value.trim();
            const sample_model = document.getElementById('addSampleModel').value.trim();
            const materialCode = document.getElementById('addMaterialCode').value.trim();
            const sample_leader = document.getElementById('addSampleLeader').value.trim();
            const scheduleDays = document.getElementById('addScheduleDays').value.trim();

            // âœ… æ ¡éªŒå‰äº”é¡¹æ˜¯å¦å¡«å†™
            if (!sample_name || !sample_model || !materialCode || !sample_leader || !scheduleDays) {
                alert('è¯·å¡«å†™å®Œæ•´é¡¹ç›®ä¿¡æ¯ï¼ˆå‰äº”é¡¹ä¸ºå¿…å¡«ï¼‰');
                return;
            }


            const newTaskData = {
                sample_name,
                sample_model,
                materialCode,
                sample_leader,
                scheduleDays,
                schedule_color: document.querySelector('input[name="addScheduleColor"]:checked').value,
                waitSample_classify: document.getElementById('addWaitSampleClassify').value,
                remark: document.getElementById('addSampleRemark').value
            };

            // å‘é€ POST è¯·æ±‚åˆ°åç«¯
            fetch('/scheduleBoard/addProjectCard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newTaskData)
            })
                .then(response => response.json())
                .then(result => {

                    if (result.success) {
                        alert(result.message); // é¡¹ç›®æ·»åŠ æˆåŠŸ
                        addProjectModal.style.display = 'none';
                        // åŠ è½½é¡¹ç›®æ± å­æ•°æ®
                        loadProjectPoolData(); // âœ… é¡µé¢åˆå§‹åŒ–è°ƒç”¨åŠ è½½å‡½æ•°
                        // åŠ è½½å¾…é€æ ·æ± å­æ•°æ®
                        loadPendingSamplePoolData();

                    } else {
                        alert(result.message || 'æ–°å¢é¡¹ç›®å¤±è´¥ï¼'); // é¡¹ç›®æ–°å¢å¤±è´¥
                    }
                })
                .catch(error => {
                    console.error('æ–°å¢é¡¹ç›®å¤±è´¥:', error);
                    alert('æ–°å¢é¡¹ç›®å¤±è´¥ï¼');
                });


        });
    });

    function loadTrashListAndShowModal() {
        fetch('/scheduleBoard/getTrashList')
            .then(response => response.json())
            .then(trashedProjects => {
                const listModal = document.getElementById('trashListModal');
                const listContainer = document.getElementById('trashProjectList');
                listContainer.innerHTML = '';

                trashedProjects.forEach(project => {
                    const li = document.createElement('li');
                    li.textContent = project.sample_name;
                    li.style.cursor = 'pointer';
                    li.style.margin = '5px 0';
                    li.addEventListener('click', () => showProjectDetail(project));
                    listContainer.appendChild(li);
                });

                listModal.style.display = 'block';
            })
            .catch(error => {
                console.error("è·å–ä½œåºŸé¡¹ç›®å¤±è´¥ï¼š", error);
                alert("åŠ è½½ä½œåºŸé¡¹ç›®å¤±è´¥");
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const trashStation = document.getElementById('trashStation');

        // é˜»æ­¢ dragover é»˜è®¤è¡Œä¸ºï¼Œå…è®¸æ”¾ç½®
        trashStation.addEventListener('dragover', function (e) {
            e.preventDefault();
        });

        // å¤„ç† drop äº‹ä»¶
        trashStation.addEventListener('drop', function (e) {
            e.preventDefault();

            const sampleId = e.dataTransfer.getData('project-sample_id');

            if (sampleId) {
                if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ")) {
                    return;
                }
                // è°ƒç”¨åˆ é™¤æ¥å£
                deleteProject(sampleId, e.dataTransfer);

                // ä»åŸå®¹å™¨ç§»é™¤å¡ç‰‡
                const fromContainerId = e.dataTransfer.getData('project-from_container');
                if (fromContainerId) {
                    const fromContainer = document.getElementById(fromContainerId);
                    if (fromContainer) {
                        const existingCard = fromContainer.querySelector(`[data-sample_id="${sampleId}"]`);
                        if (existingCard) {
                            existingCard.remove();
                        }
                    }
                }

                // ä»æ’æœŸé¢æ¿ç§»é™¤
                const originalCell = document.querySelector(`td[data-sample_id="${sampleId}"]`);
                if (originalCell) {
                    const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                    const originalStartIndex = originalRowCells.indexOf(originalCell);
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                    ];
                    attributes.forEach(attr => {
                        taskData[attr] = originalCell.getAttribute(`data-${attr}`);
                    });
                    // æ–°å¢ä¸€ä¸ªå‚æ•°ï¼Œç”¨æ¥ä¼ é€’åˆ°æ–¹æ³•é‡Œå»åˆ¤æ–­æ˜¯å¦éœ€è¦æ¸²æŸ“å¡ç‰‡
                    const isRenderCard = true;
                    handleUndo(originalRowCells, originalStartIndex, taskData, document.getElementById('projectPool'),originalCell,isRenderCard);
                }
            }
        });


        // æ·»åŠ å³é”®äº‹ä»¶ç›‘å¬
        trashStation.addEventListener('contextmenu', function (e) {
            e.preventDefault();

            loadTrashListAndShowModal();
        });


    });

    // å®šä¹‰åˆ é™¤é¡¹ç›®çš„å‡½æ•°ï¼Œå¸¦ç¡®è®¤æ¡†å’Œå¯é€‰çš„åˆ é™¤ç†ç”±
    function deleteProject(sampleId, element ) {
        // ä¸¢å›æ”¶ç«™çš„æ—¶å€™ï¼Œå¤šä¼ ä¸€äº›æ•°æ®ä½œä¸ºå˜æ›´è®°å½•
        const tester = element.getData('project-tester');
        const start_date = element.getData('project-schedule_start_date');
        const end_date = element.getData('project-schedule_end_date');
        const schedule_color = element.getData('project-schedule_color');
        const change = "drop";


        const reason = prompt("è¯·è¾“å…¥åˆ é™¤ç†ç”±ï¼ˆå¯é€‰ï¼‰ï¼š");

        fetch('/scheduleBoard/deleteProject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sample_id: sampleId,
                cancel_reason: reason ? reason.trim() : "", // å¦‚æœæ²¡æœ‰å¡«å†™åˆ™ä¼ ç©ºå­—ç¬¦ä¸²
                username: username,
                tester: tester,
                start_date: start_date,
                end_date: end_date,
                schedule_color: schedule_color,
                change: change
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    alert(result.message);
                } else {
                    alert(result.message || 'é¡¹ç›®åˆ é™¤å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤é¡¹ç›®æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤é¡¹ç›®æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•');
            });
    }

    function showProjectDetail(project) {
        // å¡«å……è¯¦æƒ…å†…å®¹
        document.getElementById('detail_sample_id').textContent = project.sample_id;
        document.getElementById('detail_sample_name').textContent = project.sample_name;
        document.getElementById('detail_sizecoding').textContent = project.sample_model + " " + project.materialCode;
        document.getElementById('detail_sample_leader').textContent = project.sample_leader;
        document.getElementById('detail_scheduleDays').textContent = project.scheduleDays;
        document.getElementById('detail_schedule_color').textContent = project.schedule_color;
        document.getElementById('detail_waitSample_classify').textContent = project.waitSample_classify;
        document.getElementById('detail_remark').textContent = project.remark;
        document.getElementById('detail_cancel_by').textContent = project.cancel_by;
        document.getElementById('detail_job_number').textContent = project.cancel_code;
        document.getElementById('detail_cancel_date').textContent = project.cancel_date;
        document.getElementById('detail_cancel_reason').textContent = project.cancel_reason;

        // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
        document.getElementById('projectDetailModal').style.display = 'block';
    }

    function recoverProject() {
        const sampleId = document.getElementById('detail_sample_id').textContent;

        fetch('/scheduleBoard/recoverProject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ sample_id: sampleId })
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message || 'æ¢å¤æˆåŠŸ');
                document.getElementById('projectDetailModal').style.display = 'none';
                // ç¡®ä¿åŠ è½½æ•°æ®å‰æ¸…é™¤å¯èƒ½çš„é‡å¤æ•°æ®
                const projectPool = document.getElementById('projectPool');
                projectPool.innerHTML = ''; // æ–°å¢ï¼šæ¸…ç©ºé¡¹ç›®æ± å­å†…å®¹
                const pendingSampleContainers = [
                    'videoSamplePool',
                    'wireSamplePool',
                    'dataSamplePool',
                    'bluetoothSamplePool',
                    'highFrequencySamplePool'
                ];
                pendingSampleContainers.forEach(id => {
                    const container = document.getElementById(id);
                    container.innerHTML = ''; // æ–°å¢ï¼šæ¸…ç©ºå¾…é€æ ·æ± å­å†…å®¹
                });
                loadProjectPoolData();
                loadPendingSamplePoolData();

                loadTrashListAndShowModal();
            })
            .catch(error => {
                console.error('æ¢å¤å¤±è´¥:', error);
                alert('æ¢å¤å¤±è´¥');
            });
    }

    // æ–°å¢å‡½æ•°ï¼šè®¾ç½®å‘¨å…­å’Œå‘¨æ—¥çš„è¾¹æ¡†æ ·å¼
    function setWeekendBorder(cell, date) {
        const dateObj = new Date(date);
        const dayOfWeek = dateObj.getDay();
        const weekendClass = 'weekend-border'; // å®šä¹‰å‘¨æœ«ç±»å

        // æ£€æŸ¥æ˜¯å¦ä¸ºå‘¨æœ«
        const isWeekend = dayOfWeek === 6 || dayOfWeek === 0;
        // æ£€æŸ¥æ˜¯å¦ä¸ºèŠ‚å‡æ—¥
        const isHoliday = holidays.some(h => h.holiday_date === date);

        if (isWeekend || isHoliday) {
            // console.log(`æ·»åŠ  ${weekendClass} æ ·å¼ï¼Œæ—¥æœŸ: ${date}ï¼ŒåŸå› : ${isWeekend ? 'å‘¨æœ«' : 'èŠ‚å‡æ—¥'}`);
            cell.classList.add(weekendClass);
        } else {
            cell.classList.remove(weekendClass);
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', function () {
        const manageHolidaysBtn = document.getElementById('manageHolidaysBtn');
        const holidayModalBackground = document.getElementById('holidayModalBackground');
        const holidayModal = document.getElementById('holidayModal');
        const closeHolidayModalBtn = document.getElementById('closeHolidayModalBtn');
        const addHolidayBtn = document.getElementById('addHolidayBtn');

        // ç‚¹å‡»ç®¡ç†èŠ‚å‡æ—¥æŒ‰é’®æ˜¾ç¤ºæ¨¡æ€æ¡†
        manageHolidaysBtn.addEventListener('click', function () {
            loadHolidays();
            holidayModalBackground.style.display = 'block';
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—æ¨¡æ€æ¡†
        closeHolidayModalBtn.addEventListener('click', function () {
            holidayModalBackground.style.display = 'none';
        });

        // ç‚¹å‡»æ·»åŠ æŒ‰é’®æ·»åŠ èŠ‚å‡æ—¥
        addHolidayBtn.addEventListener('click', function () {
            const newHolidayDate = document.getElementById('newHolidayDate').value;
            const newHolidayName = document.getElementById('newHolidayName').value;

            if (newHolidayDate && newHolidayName) {
                addHoliday(newHolidayDate, newHolidayName);
            } else {
                alert('è¯·å¡«å†™å®Œæ•´çš„æ—¥æœŸå’Œåç§°');
            }
        });

        // ç‚¹å‡»èƒŒæ™¯å±‚å…³é—­æ¨¡æ€æ¡†
        holidayModalBackground.addEventListener('click', function (e) {
            if (e.target === holidayModalBackground) {
                holidayModalBackground.style.display = 'none';
            }
        });
    });

    // åŠ è½½èŠ‚å‡æ—¥åˆ—è¡¨
    function loadHolidays() {
        fetch('/scheduleBoard/getHolidays')
            .then(response => response.json())
            .then(data => {
                const holidayList = document.getElementById('holidayList');
                holidayList.innerHTML = '';

                data.forEach(holiday => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '5px';

                    const dateSpan = document.createElement('span');
                    dateSpan.textContent = holiday.holiday_date;
                    dateSpan.style.marginRight = '10px';

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = holiday.holiday_name;
                    nameSpan.style.marginRight = '10px';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.addEventListener('click', function () {

                        deleteHoliday(holiday.id);
                    });

                    div.appendChild(dateSpan);
                    div.appendChild(nameSpan);
                    div.appendChild(deleteBtn);
                    holidayList.appendChild(div);
                });
            })
            .catch(error => {
                console.error('åŠ è½½èŠ‚å‡æ—¥åˆ—è¡¨å¤±è´¥:', error);
            });
    }


    // æ·»åŠ èŠ‚å‡æ—¥
    function addHoliday(date, name) {
        fetch('/scheduleBoard/addHoliday', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                holiday_date: date,
                holiday_name: name
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('æ·»åŠ æˆåŠŸ');
                    // å‡è®¾ holidays æ˜¯å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨èŠ‚å‡æ—¥ä¿¡æ¯
                    if (!window.holidays) {
                        window.holidays = [];
                    }
                    const existingIndex = holidays.findIndex(holiday => holiday.holiday_date === date);
                    if (existingIndex !== -1) {
                        // æ—¥æœŸå·²å­˜åœ¨ï¼Œè¿›è¡Œæ›´æ–°
                        holidays[existingIndex] = {
                            holiday_date: date,
                            holiday_name: name,
                            ...data
                        };
                    } else {
                        // æ—¥æœŸä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°çš„èŠ‚å‡æ—¥
                        holidays.push({
                            holiday_date: date,
                            holiday_name: name,
                            ...data
                        });
                    }
                    loadHolidays();
                    // ç§»é™¤æ¸…ç©ºæ—¥æœŸè¾“å…¥æ¡†çš„ä»£ç ï¼Œä»…æ¸…ç©ºåç§°è¾“å…¥æ¡†
                    // document.getElementById('newHolidayName').value = '';
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('æ·»åŠ èŠ‚å‡æ—¥å¤±è´¥:', error);
                alert('æ·»åŠ èŠ‚å‡æ—¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
    }
    // åˆ é™¤èŠ‚å‡æ—¥
    function deleteHoliday(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚å‡æ—¥å—ï¼Ÿ')) {
            fetch('/scheduleBoard/deleteHoliday', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: id
                })
            })
                .then(response => {
                    // æ£€æŸ¥å“åº”çŠ¶æ€æ˜¯å¦æ­£å¸¸
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('åˆ é™¤æˆåŠŸ');
                        // æ›´æ–°å…¨å±€å˜é‡ holidays
                        holidays = holidays.filter(holiday => holiday.id !== id);
                        // åŠ è½½èŠ‚å‡æ—¥åˆ—è¡¨ï¼Œä¸æ“ä½œè¾“å…¥æ¡†
                        loadHolidays();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤èŠ‚å‡æ—¥å¤±è´¥:', error);
                    alert('åˆ é™¤èŠ‚å‡æ—¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
        }
    }

    // åœ¨é¡µé¢åŠ è½½å®Œæˆæ—¶è·å–èŠ‚å‡æ—¥æ•°æ®
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            // å‘èµ·è¯·æ±‚è·å–èŠ‚å‡æ—¥æ•°æ®
            const response = await fetch('/scheduleBoard/getHolidays');
            // æ£€æŸ¥å“åº”çŠ¶æ€æ˜¯å¦æ­£å¸¸
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // å°†å“åº”æ•°æ®è§£æä¸º JSON æ ¼å¼å¹¶èµ‹å€¼ç»™ holidays å˜é‡
            holidays = await response.json();
        } catch (error) {
            console.error('è·å–èŠ‚å‡æ—¥æ•°æ®å¤±è´¥:', error);
        }
    });


    // æ˜¾ç¤ºç®¡ç†æµ‹è¯•äººå‘˜æ¨¡æ€æ¡†
    function showManageTestersModal() {
        loadTestersData();
        document.getElementById('manageTestersOverlay').style.display = 'block';
        document.getElementById('manageTestersModal').style.display = 'block';
    }

    // åŠ è½½æµ‹è¯•äººå‘˜æ•°æ®
    function loadTestersData() {
        fetch('/scheduleBoardController/getTestEngineers')
            .then(response => response.json())
            .then(data => {
                const testersTableBody = document.getElementById('testersTableBody');
                testersTableBody.innerHTML = '';

                // æŒ‰è´Ÿè´£çš„å“ç±»åˆ†ç»„
                const groupedTesters = {};
                data.forEach(tester => {
                    const category = tester.responsible_category || 'æœªåˆ†ç»„';
                    if (!groupedTesters[category]) {
                        groupedTesters[category] = [];
                    }
                    groupedTesters[category].push(tester);
                });

                // éå†æ¯ä¸ªåˆ†ç»„
                for (const category in groupedTesters) {
                    // æ·»åŠ åˆ†ç»„æ ‡é¢˜è¡Œ
                    const groupRow = document.createElement('tr');
                    groupRow.innerHTML = `
                        <td colspan="8" style="background-color: #f0f0f0; font-weight: bold;">${category}</td>
                    `;
                    testersTableBody.appendChild(groupRow);

                    // æ·»åŠ è¯¥åˆ†ç»„ä¸‹çš„æµ‹è¯•äººå‘˜æ•°æ®
                    groupedTesters[category].forEach(tester => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${tester.engineer_id}</td>
                            <td>${tester.test_engineer_name}</td>
                            <td>${tester.hire_date}</td>
                            <td><span class="editable-field" data-field="responsible_category" data-test_engineer_name="${tester.test_engineer_name}">${tester.responsible_category || '/'}</span></td>
                            <td><span class="editable-field" data-field="skill_description" data-test_engineer_name="${tester.test_engineer_name}">${tester.skill_description || '/'}</span></td>
                            <td><span class="editable-field" data-field="skill_improvernment" data-test_engineer_name="${tester.test_engineer_name}">${tester.skill_improvernment || '/'}</span></td>
                            <td><span class="editable-field" data-field="current_skill_level" data-test_engineer_name="${tester.test_engineer_name}">${tester.current_skill_level || '/'}</span></td>
                            <td>
                                <button id="deleteTestBtn" onclick="deleteTester('${tester.test_engineer_name}')">åˆ é™¤</button>
                            </td>
                        `;
                        testersTableBody.appendChild(row);
                    });
                }

                // ä¸ºå¯ç¼–è¾‘å­—æ®µæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                const editableFields = document.querySelectorAll('.editable-field');
                editableFields.forEach(field => {
                    field.addEventListener('click', function () {
                        makeEditable(this);
                    });
                });
            })
            .catch(error => {
                console.error('åŠ è½½æµ‹è¯•äººå‘˜æ•°æ®å¤±è´¥:', error);
            });
    }


    // å…³é—­ç®¡ç†æµ‹è¯•äººå‘˜æ¨¡æ€æ¡†
    function closeManageTestersModal() {
        document.getElementById('manageTestersOverlay').style.display = 'none';
        document.getElementById('manageTestersModal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const closeManageTestersModalBtn = document.getElementById('closeManageTestersModalBtn');
        const manageTestersOverlay = document.getElementById('manageTestersOverlay');

        // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—æ¨¡æ€æ¡†
        closeManageTestersModalBtn.addEventListener('click', closeManageTestersModal);

        // ç‚¹å‡»é®ç½©å±‚éšè—æ¨¡æ€æ¡†
        manageTestersOverlay.addEventListener('click', closeManageTestersModal);
    });

    //æŠŠåŒåçš„æ•°æ®åˆå¹¶åˆ°åŒä¸€ä¸ªå¯¹è±¡é‡Œ
    function mergePendingChanges(pendingChanges) {
        const mergedChanges = {};

        pendingChanges.forEach(change => {
            const { test_engineer_name, field, value } = change;
            if (!mergedChanges[test_engineer_name]) {
                mergedChanges[test_engineer_name] = { test_engineer_name };
            }
            mergedChanges[test_engineer_name][field] = value;
        });

        return Object.values(mergedChanges);
    }

    function makeEditable(element) {
        const fieldName = element.dataset.field;
        const test_engineer_name = element.dataset.test_engineer_name;
        const originalValue = element.textContent;
        let inputElement;

        if (fieldName === 'current_skill_level') {
            inputElement = document.createElement('input');
            inputElement.type = 'text';
        } else {
            inputElement = document.createElement('textarea');
        }

        inputElement.value = originalValue;
        inputElement.className = 'editing';

        // æ›¿æ¢å…ƒç´ 
        element.parentNode.replaceChild(inputElement, element);
        inputElement.focus();

        // ä¿å­˜ä¿®æ”¹åˆ°æš‚å­˜æ•°ç»„
        const saveToPending = () => {
            const newValue = inputElement.value;
            if (newValue !== originalValue) {
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒå·¥ç¨‹å¸ˆå’Œå­—æ®µçš„ä¿®æ”¹ï¼Œæœ‰åˆ™æ›´æ–°
                const existingIndex = pendingChanges.findIndex(change =>
                    change.test_engineer_name === test_engineer_name && change.field === fieldName
                );
                if (existingIndex !== -1) {
                    pendingChanges[existingIndex].value = newValue;
                } else {
                    pendingChanges.push({
                        test_engineer_name: test_engineer_name,
                        field: fieldName,
                        value: newValue
                    });
                }
            }
            // é‡æ–°åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
            const newSpan = document.createElement('span');
            newSpan.className = 'editable-field';
            newSpan.dataset.field = fieldName;
            newSpan.dataset.test_engineer_name = test_engineer_name;
            newSpan.textContent = newValue;
            newSpan.addEventListener('click', function () {
                makeEditable(this);
            });
            inputElement.parentNode.replaceChild(newSpan, inputElement);
        };

        // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜åˆ°æš‚å­˜æ•°ç»„
        inputElement.addEventListener('blur', saveToPending);

        // // æŒ‰ä¸‹å›è½¦é”®æ—¶ä¿å­˜åˆ°æš‚å­˜æ•°ç»„
        // inputElement.addEventListener('keydown', function (event) {
        //     if (event.key === 'Enter') {
        //         event.preventDefault();
        //         saveToPending();
        //     }
        // });
    }

    document.addEventListener('DOMContentLoaded', function () {

        const saveTesterChangesBtn = document.getElementById('saveTesterChangesBtn');
        saveTesterChangesBtn.addEventListener('click', function () {
            if (pendingChanges.length > 0) {
                const mergedData = {};

                pendingChanges.forEach(item => {
                    const name = item.test_engineer_name;
                    if (!mergedData[name]) {
                        mergedData[name] = { test_engineer_name: name };
                    }
                    // å°† field ä½œä¸ºå±æ€§åï¼Œvalue ä½œä¸ºå±æ€§å€¼æ·»åŠ åˆ°å¯¹è±¡ä¸­
                    mergedData[name][item.field] = item.value;
                });

                const finalChanges = Object.values(mergedData);

                fetch('/scheduleBoardController/updateTesterInfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(finalChanges)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(result.message);
                            loadTestersData(); // é‡æ–°åŠ è½½æ•°æ®
                            pendingChanges = []; // æ¸…ç©ºæš‚å­˜æ•°ç»„
                        } else {
                            alert(result.message || 'ä¿å­˜ä¿®æ”¹å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        console.error('ä¿å­˜ä¿®æ”¹æ—¶å‡ºé”™:', error);
                        alert('ä¿å­˜ä¿®æ”¹æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•');
                    });
            } else {
                alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„ä¿®æ”¹');
            }
        });
    });

    // å°è£…ä¿å­˜æ–°å¢æµ‹è¯•äººå‘˜çš„æ–¹æ³•
    function saveNewTester() {
        const testerName = document.getElementById('addTesterName').value.trim();
        const testerGroup = document.getElementById('addTesterGroup').value.trim();
        const testerSkillDesc = document.getElementById('addTesterSkillDesc').value.trim();
        const testerSkillImprove = document.getElementById('addTesterSkillImprove').value.trim();
        const testerSkillLevel = document.getElementById('addTesterSkillLevel').value.trim();

        // æ ¡éªŒå¿…å¡«é¡¹
        if (!testerName || !testerGroup) {
            alert('è¯·å¡«å†™å®Œæ•´å¿…å¡«ä¿¡æ¯ï¼ˆæµ‹è¯•äººå‘˜å§“åå’Œè´Ÿè´£ç»„åˆ«ï¼‰');
            return;
        }

        const newTesterData = {
            test_engineer_name: testerName,
            responsible_category: testerGroup,
            skill_description: testerSkillDesc,
            skill_improvernment: testerSkillImprove,
            current_skill_level: testerSkillLevel
        };

        // å‘é€ POST è¯·æ±‚åˆ°åç«¯
        fetch('/scheduleBoardController/addTesterInfo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newTesterData)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message); // æµ‹è¯•äººå‘˜æ·»åŠ æˆåŠŸ
                    // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ·æ–°æµ‹è¯•äººå‘˜åˆ—è¡¨ç­‰é€»è¾‘
                    showManageTestersModal();
                } else {
                    alert(result.message || 'æ–°å¢æµ‹è¯•äººå‘˜å¤±è´¥ï¼'); // æµ‹è¯•äººå‘˜æ–°å¢å¤±è´¥
                }
            })
            .catch(error => {
                console.error('æ–°å¢æµ‹è¯•äººå‘˜å¤±è´¥:', error);
                alert('æ–°å¢æµ‹è¯•äººå‘˜å¤±è´¥ï¼');
            });
    }

    document.addEventListener('DOMContentLoaded', function () {

        const addNewTesterBtn = document.getElementById('addNewTesterBtn');

        // æ–°å¢æµ‹è¯•äººå‘˜æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
        const addTesterModal = document.getElementById('addTesterModal');
        const closeAddTesterModalBtn = document.getElementById('closeAddTesterModalBtn');
        const saveNewTesterBtn = document.getElementById('saveNewTesterBtn');


        // ç‚¹å‡»æ–°å¢æµ‹è¯•äººå‘˜æŒ‰é’®æ˜¾ç¤ºæ–°å¢æµ‹è¯•äººå‘˜æ¨¡æ€æ¡†
        addNewTesterBtn.addEventListener('click', function () {
            addTesterModal.style.display = 'block';
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—æ–°å¢æµ‹è¯•äººå‘˜æ¨¡æ€æ¡†
        closeAddTesterModalBtn.addEventListener('click', function () {
            addTesterModal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨éšè—æ–°å¢æµ‹è¯•äººå‘˜æ¨¡æ€æ¡†
        addTesterModal.addEventListener('click', function (e) {
            if (e.target === addTesterModal) {
                addTesterModal.style.display = 'none';
            }
        });

        // å°è£…ä¿å­˜æ–°å¢æµ‹è¯•äººå‘˜çš„æ–¹æ³•


        // ä¿å­˜æ–°å¢æµ‹è¯•äººå‘˜æŒ‰é’®ç»‘å®šæ–¹æ³•
        saveNewTesterBtn.addEventListener('click', saveNewTester);
    });

    // åˆ é™¤æµ‹è¯•äººå‘˜çš„æ–¹æ³•
    async function deleteTester(test_engineer_name) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥æµ‹è¯•äººå‘˜å—ï¼Ÿ")) {
            return;
        }

        try {
            const response = await fetch('/scheduleBoardController/deleteTester', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_engineer_name: test_engineer_name
                })
            });

            if (!response.ok) {
                throw new Error(`åˆ é™¤å¤±è´¥: ${response.statusText}`);
            }

            const result = await response.json();
            alert(result.message);
            showManageTestersModal();


        } catch (error) {
            console.error('åˆ é™¤æµ‹è¯•äººå‘˜å¤±è´¥:', error);
            alert('åˆ é™¤æµ‹è¯•äººå‘˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼');
        }
    }


    // åœ¨ DOM åŠ è½½å®Œæˆåç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function () {
        const manageGroupBtn = document.getElementById('manageGroupBtn');
        const manageGroupModal = document.getElementById('manageGroupModal');
        const closeManageGroupModalBtn = document.getElementById('closeManageGroupModalBtn');
        const saveGroupSettingsBtn = document.getElementById('saveGroupSettingsBtn');

        // ç‚¹å‡»ç®¡ç†å±•ç¤ºçš„ç»„æŒ‰é’®æ˜¾ç¤ºæ¨¡æ€æ¡†
        manageGroupBtn.addEventListener('click', function () {
            loadGroupData();
            manageGroupModal.style.display = 'block';
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—æ¨¡æ€æ¡†
        closeManageGroupModalBtn.addEventListener('click', function () {
            manageGroupModal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨éšè—æ¨¡æ€æ¡†
        manageGroupModal.addEventListener('click', function (e) {
            if (e.target === manageGroupModal) {
                manageGroupModal.style.display = 'none';
            }
        });

        // ä¿å­˜ç»„è®¾ç½®
        saveGroupSettingsBtn.addEventListener('click', function () {
            const groupSettings = [];
            const rows = document.querySelectorAll('#groupTable tbody tr');
            rows.forEach((row, index) => {
                const id = row.querySelector('td:nth-child(1)').textContent;
                const name = row.querySelector('td:nth-child(2)').textContent;
                const is_displayed = row.querySelector('input[type="checkbox"]').checked;
                const displayOrderInput = row.querySelector('input[type="number"]');
                const display_order = parseInt(displayOrderInput.value, 10) || 0; // fallback ä¸º 0
                groupSettings.push({
                    id: id,
                    display_order: display_order,
                    is_displayed: is_displayed,
                    name: name
                });
            });

            // åªç”Ÿæˆæ˜¾ç¤ºçš„ç»„åæ•°ç»„ä½œä¸ºæ’åº
            groupOrder = groupSettings
                .filter(g => g.is_displayed)
                .sort((a, b) => a.display_order - b.display_order)
                .map(g => g.name);

            // å‘é€è¯·æ±‚åˆ°åç«¯ä¿å­˜è®¾ç½®
            fetch('/scheduleBoardController/saveGroupSettings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(groupSettings)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                    } else {
                        alert(result.message || 'ä¿å­˜ç»„è®¾ç½®å¤±è´¥ï¼');
                    }
                })
                .catch(error => {
                    console.error('ä¿å­˜ç»„è®¾ç½®å¤±è´¥:', error);
                    alert('ä¿å­˜ç»„è®¾ç½®å¤±è´¥ï¼');
                });
        });
    });

    // åŠ è½½ç»„æ•°æ®
    function loadGroupData() {
        fetch('/scheduleBoardController/getGroupData')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#groupTable tbody');
                tableBody.innerHTML = '';

                data.forEach(group => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${group.id}</td>
                    <td>${group.name}</td>
                    <td><input type="checkbox" ${group.is_displayed ? 'checked' : ''}></td>
                  <td><input type="number" value="${group.display_order}" class="display-order-input small-input" data-group-id="${group.id}"></td>

                `;
                    tableBody.appendChild(row);
                });


            })
            .catch(error => {
                console.error('åŠ è½½ç»„æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½ç»„æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            });
    }

    document.getElementById('addGroupBtn').addEventListener('click', async function () {
        const name = document.getElementById('newGroupName').value.trim();
        const display = document.getElementById('newGroupDisplay').value === 'true';
        const order = document.getElementById('newGroupOrder').value.trim();

        if (!name || !order) {
            alert("è¯·å¡«å†™å®Œæ•´çš„ç»„ä¿¡æ¯ï¼");
            return;
        }

        // 1. å…ˆæ£€æŸ¥è¡¨æ ¼ä¸­æ˜¯å¦å·²æœ‰åŒåç»„
        const existingNames = Array.from(document.querySelectorAll('#groupTable tbody tr td:nth-child(2)'))
            .map(td => td.textContent.trim().toLowerCase());
        if (existingNames.includes(name.toLowerCase())) {
            alert("è¯¥ç»„åˆ«åç§°å·²å­˜åœ¨ï¼ˆæœ¬åœ°ï¼‰ï¼");
            return;
        }

        // 3. æ„é€ æ–°ç»„æ•°æ®å¯¹è±¡
        const newGroup = {
            name: name,
            is_displayed: display,
            display_order: parseInt(order)
        };

        // 4. æäº¤åˆ°åç«¯æ¥å£
        try {
            const addResponse = await fetch('/scheduleBoardController/addGroup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newGroup)
            });

            const result = await addResponse.text();
            if (result === 'æ–°å¢æˆåŠŸ') {
                // æ’å…¥æ–°è¡Œåˆ°è¡¨æ ¼
                const tbody = document.querySelector('#groupTable tbody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                <td>ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰</td>
                <td>${name}</td>
                <td><input type="checkbox" ${display ? 'checked' : ''}></td>
                <td><input type="number" value="${order}" style="width: 80px;"></td>
            `;
                tbody.appendChild(newRow);

                // æ¸…ç©ºè¾“å…¥æ¡†
                // document.getElementById('newGroupName').value = '';
                // document.getElementById('newGroupDisplay').value = 'true';
                // document.getElementById('newGroupOrder').value = '';

                alert("æ–°å¢æˆåŠŸï¼");
            } else {
                alert("åç«¯æ·»åŠ å¤±è´¥ï¼š" + result);
            }
        } catch (err) {
            console.error("æäº¤å¤±è´¥", err);
            alert("æäº¤æ•°æ®æ—¶å‡ºé”™ï¼");
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const searchBtn = document.getElementById('searchBtn');
        const searchModal = document.getElementById('searchModal');
        const closeSearchModalBtn = document.getElementById('closeSearchModalBtn');
        const executeSearchBtn = document.getElementById('executeSearchBtn');

        const modalContent = document.getElementById('searchModalContent');
        const overlay = document.getElementById('searchModalOverlay');

        // æ‰“å¼€æ¨¡æ€æ¡†æ—¶æ˜¾ç¤ºé®ç½©å’Œæ¨¡æ€æ¡†ï¼ˆä½ è‡ªå·±è°ƒç”¨ï¼‰
        function openSearchModal() {
            overlay.style.display = 'block';
            searchModal.style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†å’Œé®ç½©
        function closeSearchModal() {
            overlay.style.display = 'none';
            searchModal.style.display = 'none';
        }

        // ç‚¹å‡»é®ç½©å…³é—­
        overlay.addEventListener('click', closeSearchModal);

        // å…³é—­æŒ‰é’®
        closeSearchModalBtn.addEventListener('click', closeSearchModal);



        // ç‚¹å‡»æœç´¢æŒ‰é’®æ˜¾ç¤ºæ¨¡æ€æ¡†
        searchBtn.addEventListener('click', function () {
            // searchModal.style.display = 'block';
            openSearchModal();
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®éšè—æ¨¡æ€æ¡†
        closeSearchModalBtn.addEventListener('click', function () {
            // searchModal.style.display = 'none';
            closeSearchModal();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨éšè—æ¨¡æ€æ¡†
        searchModal.addEventListener('click', function (e) {
            if (e.target === searchModal) {
                searchModal.style.display = 'none';
            }
        });

        // æ‰§è¡Œæœç´¢
        executeSearchBtn.addEventListener('click', function () {
            const sampleId = document.getElementById('searchSampleId').value;
            const sampleModel = document.getElementById('searchSampleModel').value;
            const tester = document.getElementById('searchTester').value;

            // å‘é€æœç´¢è¯·æ±‚
            fetch('/scheduleBoardController/searchProjects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sampleId: sampleId,
                    sampleModel: sampleModel,
                    tester: tester
                })
            })
                .then(response => response.json())
                .then(data => {
                    const resultsContainer = document.getElementById('searchResults');
                    resultsContainer.innerHTML = '';

                    if (data.length === 0) {
                        resultsContainer.innerHTML = 'æš‚æ— æœç´¢ç»“æœã€‚';
                    } else {
                        let html = '<table border="1">';
                        html += `
                        <thead>
                            <tr>
                                <th>ç”µæ°”ç¼–å·</th>
                                <th>å¤§å°ç¼–ç </th>
                                <th>é¢„è®¡æ’æœŸå¼€å§‹æ—¶é—´</th>
                                <th>é¢„è®¡æ’æœŸç»“æŸæ—¶é—´</th>
                                <th>æ’æœŸå¤©æ•°</th>
                                <th>æµ‹è¯•äºº</th>
                                <th>å®é™…æµ‹è¯•å¼€å§‹æ—¶é—´</th>
                                <th>å®é™…æµ‹è¯•ç»“æŸæ—¶é—´</th>
                                <th>å®æµ‹æ—¶é•¿</th>
                                <th>æŠ¥å‘Šå®¡æ ¸æ—¶é—´</th>
                                <th>æ ·å“æ‰¿è®¤ç»“æœ</th>
                                <th>æ’æœŸé¢œè‰²</th>
                                <th>æ˜¯å¦ä½œåºŸ</th>
                            </tr>
                        </thead>
                        `;
                        html += '<tbody>';
                        data.forEach(item => {
                            const startDate = item.schedule_start_date ? item.schedule_start_date.split('T')[0] : '';
                            const endDate = item.schedule_end_date ? item.schedule_end_date.split('T')[0] : '';

                            html += `<tr>
                                <td>${item.sample_id}</td>
                                <td>${item.sample_model} ${item.materialCode || ''}</td>
                                <td>${startDate}</td>
                                <td>${endDate}</td>
                                <td>${item.scheduleDays}</td>
                                <td>${item.tester}</td>
                                <td>${item.actual_start_time}</td>
                                <td>${item.actual_finish_time}</td>
                                <td>${item.testDuration}</td>
                                <td>${item.reportReviewTime}</td>
                                <td>${item.sampleRecognizeResult}</td>
                                <td style="background-color: ${item.schedule_color};">${item.schedule_color}</td>
                                <td>${item.isCancel}</td>
                            </tr>`;
                        });

                        html += '</tbody></table>';
                        resultsContainer.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('æœç´¢å¤±è´¥:', error);
                    document.getElementById('searchResults').innerHTML = 'æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                });
        });
    });



</script>

</body>
</html>