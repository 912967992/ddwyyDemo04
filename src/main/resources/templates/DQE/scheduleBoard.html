<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¡¹ç›®æ± å­å±•ç¤º</title>
    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="/css/scheduleBoard.css">

</head>
<body>

<div id="projectList" class="project-container">
    <h2>é¡¹ç›®æ± å­</h2>
    <div id="projectPool">åŠ è½½ä¸­...</div>
</div>

<!-- æ’æœŸé¢æ¿åŒºåŸŸ -->
<div class="schedule-board-container">
    <div class="schedule-board-header">
        <h3>æ’æœŸé¢æ¿</h3>
        <div class="schedule-controls">
            <input type="date" id="startDate" class="date-picker">
            <span>è‡³</span>
            <input type="date" id="endDate" class="date-picker">
            <button class="save-schedule-btn" onclick="refreshSchedule()">è®¾ç½®æ—¥æœŸ</button>
            <button class="save-schedule-btn" onclick="saveSchedule()">ä¿å­˜æ’æœŸ</button>
        </div>
    </div>
    <div id="scheduleBoard">è¯·é€‰æ‹©æ’æœŸé¢æ¿æ—¶é—´å¹¶ç‚¹å‡»è®¾ç½®æ—¥æœŸæŒ‰é’®ï¼Œæ‰ä¼šå±•ç¤ºé¢æ¿</div>
</div>

<!-- æ–°å¢å˜æ›´è®°å½•æ¨¡æ€æ¡† -->
<div id="changeLogModal">
    <div id="changeLogModalContent">
        <h3>å˜æ›´è®°å½•</h3>
        <div id="changeLogBody"></div>
        <button id="closeChangeLogBtn">å…³é—­</button>
    </div>
</div>

<!-- æ¨¡æ€æ¡† -->
<div id="modal">
    <div id="modalContent">
               <!-- æ–°å¢å˜æ›´è®°å½•æŒ‰é’® -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>é¡¹ç›®è¯¦æƒ…</h3>
                <button id="changeLogBtn">å˜æ›´è®°å½•</button>
            </div>
        <div id="modalBody"></div>

        <div style="margin-top: 10px;">
            <label for="scheduleDays"><strong>æ’æœŸå¤©æ•°ï¼š</strong></label>
            <input type="number" id="scheduleDays" placeholder="è¯·è¾“å…¥æ’æœŸå¤©æ•°">
            <button id="saveScheduleBtn">ç¡®å®šæ’æœŸ</button>
        </div>

        <!-- æ·»åŠ é¢œè‰²é€‰æ‹©åŠŸèƒ½ -->
        <!-- æ·»åŠ é¢œè‰²é€‰æ‹©åŠŸèƒ½ -->
        <!-- æ·»åŠ é¢œè‰²é€‰æ‹©åŠŸèƒ½ -->
        <div style="margin-top: 10px;">
            <label><strong>è®¾ç½®é¢œè‰²ï¼š</strong></label>
            <div>
                <label>
                    <input type="radio" id="color_null" name="schedule_color" value="null" checked> æ— 
                </label>
                <label>
                    <input type="radio" id="color_gray" name="schedule_color" value="gray" checked> ç°è‰²
                </label>
                <label>
                    <input type="radio" id="color_green" name="schedule_color" value="green"> ç»¿è‰²
                </label>
                <label>
                    <input type="radio" id="color_yellow" name="schedule_color" value="yellow"> é»„è‰²
                </label>
                <label>
                    <input type="radio" id="color_red" name="schedule_color" value="red"> çº¢è‰²
                </label>
            </div>
            <button id="confirmColorBtn" style="margin-top: 5px;">ç¡®è®¤ä¿®æ”¹é¢œè‰²</button>
        </div>


        <button id="closeBtn">å…³é—­</button>
    </div>
</div>

<template id="changeLogTemplate">
    <p class="change-log-item">
        <strong>æµ‹è¯•è€…ï¼š</strong> {{tester}}<br>
        <strong>æ’æœŸå¼€å§‹ï¼š</strong> {{startDate}}<br>
        <strong>æ’æœŸç»“æŸï¼š</strong> {{endDate}}<br>
        <strong>æ›´æ–°æ—¶é—´ï¼š</strong> {{updateTime}}<br>
        <strong>é¢œè‰²ï¼š</strong> <span style="color: {{color}};">{{color}}</span><br>
        <strong>æ˜¯å¦ä½¿ç”¨ï¼š</strong> {{used}}<br>
    <hr>
    </p>
</template>


<div id="contextMenu" class="context-menu">
    <!-- <div onclick="handleContextMenuClick()">æ’¤å›æ’æœŸ</div> -->
    <div onclick="showProjectAttributes(event)">æŸ¥çœ‹å±æ€§</div>
</div>

<!-- è¿”å›æŒ‰é’® -->
<div class="header-container">
    <button class="BackBtn" id="BackBtn" onclick="location.href='/DQEIndex'">è¿”å›<br>ä¸»é¡µ</button>
</div>

<script>
    let localScheduleChanges = [];
    const contextMenu = document.getElementById('contextMenu');
    let currentRightClickCell = null;
    let currentRightClickProject = null;

    //é»˜è®¤è®©endDate+14å¤©ï¼Œè¿›å…¥é¡µé¢çš„æ—¶å€™
    document.addEventListener('DOMContentLoaded', function () {
        // è·å–å½“å‰ UTC æ—¶é—´
        const now = new Date();

        // åŒ—äº¬æ—¶é—´åç§»ï¼ˆUTC+8ï¼‰
        const beijingOffset = 8 * 60 * 60 * 1000;
        const beijingTime = new Date(now.getTime() + beijingOffset);

        // å¼€å§‹æ—¥æœŸï¼š7å¤©å‰
        const startTime = new Date(beijingTime.getTime() - 7 * 24 * 60 * 60 * 1000);
        const startYear = startTime.getUTCFullYear();
        const startMonth = String(startTime.getUTCMonth() + 1).padStart(2, '0');
        const startDay = String(startTime.getUTCDate()).padStart(2, '0');
        const startDate = `${startYear}-${startMonth}-${startDay}`;

        // ç»“æŸæ—¥æœŸï¼š7å¤©å
        const endTime = new Date(beijingTime.getTime() + 7 * 24 * 60 * 60 * 1000);
        const endYear = endTime.getUTCFullYear();
        const endMonth = String(endTime.getUTCMonth() + 1).padStart(2, '0');
        const endDay = String(endTime.getUTCDate()).padStart(2, '0');
        const endDate = `${endYear}-${endMonth}-${endDay}`;

        // è®¾ç½® input çš„é»˜è®¤å€¼
        document.getElementById('startDate').value = startDate;
        document.getElementById('endDate').value = endDate;
    });



    // è®¾ç½®æ‹–æ‹½ï¼Œæ‹–æ‹½è¿›å»çš„æ—¶å€™ï¼Œå¦‚æœæ’æœŸå¤©æ•°æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä¸å…è®¸æ‹–æ‹½
    function setDraggable(projectEl, isProject) {
        projectEl.addEventListener('dragstart', e => {
            const sampleModel = projectEl.getAttribute('data-sample_model');
            const materialCode = projectEl.getAttribute('data-materialCode');
            e.dataTransfer.setData('project-sizecoding', `${sampleModel} ${materialCode} `+projectEl.getAttribute('data-sample_leader').charAt(0));
            e.dataTransfer.setData('project-days', projectEl.getAttribute('data-schedule_days'));
            e.dataTransfer.setData('project-sample_id', projectEl.getAttribute('data-sample_id'));
            e.dataTransfer.setData('project-sample_name', projectEl.getAttribute('data-sample_name'));
            e.dataTransfer.setData('project-sample_model', projectEl.getAttribute('data-sample_model'));
            e.dataTransfer.setData('project-materialCode', projectEl.getAttribute('data-materialCode'));
            e.dataTransfer.setData('project-sample_category', projectEl.getAttribute('data-sample_category'));
            e.dataTransfer.setData('project-version', projectEl.getAttribute('data-version'));
            e.dataTransfer.setData('project-priority', projectEl.getAttribute('data-priority'));
            e.dataTransfer.setData('project-sample_leader', projectEl.getAttribute('data-sample_leader'));
            e.dataTransfer.setData('project-supplier', projectEl.getAttribute('data-supplier'));
            e.dataTransfer.setData('project-test_project_category', projectEl.getAttribute('data-test_project_category'));
            e.dataTransfer.setData('project-test_projects', projectEl.getAttribute('data-test_projects'));
            e.dataTransfer.setData('project-schedule', projectEl.getAttribute('data-schedule'));
            e.dataTransfer.setData('project-create_time', projectEl.getAttribute('data-create_time'));
            // e.dataTransfer.setData('project-schedule_days', projectEl.getAttribute('data-schedule_days'));
            e.dataTransfer.setData(
                'project-schedule_days',
                projectEl.getAttribute('data-schedule_days') ?? '1'
            );
            e.dataTransfer.setData('project-schedule_color', projectEl.getAttribute('data-schedule_color'));

        });
        if(isProject){

        }else{
            projectEl.addEventListener('contextmenu', e => {
                e.preventDefault();
                currentRightClickProject = projectEl;
                // åŸä»£ç ä¸­ projectMenu æœªå®šä¹‰ï¼Œè¿™é‡Œæ³¨é‡Šæ‰
                // projectMenu.style.top = e.pageY + 'px';
                // projectMenu.style.left = e.pageX + 'px';
                // projectMenu.style.display = 'block';
            });
        }
    }


    // ç‚¹å‡»å…¶ä»–åŒºåŸŸéšè—èœå•
    document.addEventListener('click', e => {
        if (!e.target.classList.contains('context-menu')) {
            contextMenu.style.display = 'none';
            // projectMenu.style.display = 'none';
        }
    });

    function loadProjectPoolData() {
        fetch('/passback/getReceivedData')
            .then(response => response.json())
            .then(data => {
                renderProjectPool(data);
            })
            .catch(error => {
                document.getElementById('projectPool').innerHTML = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                console.error('Error fetching project data:', error);
            });
    }

    function renderProjectPool(data) {
        const container = document.getElementById('projectPool');
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = 'æš‚æ— é¡¹ç›®æ•°æ®ã€‚';
            return;
        }

        data.forEach(item => {
            console.log(item);
            const card = document.createElement('div');

            card.className = 'project-card';

            const scheduleColor = item.schedule_color || 'null';
            card.classList.add(scheduleColor);
            card.textContent = item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0) + " " +"(" + item.scheduleDays + "å¤©)";

            card.setAttribute('data-sizecoding', item.sample_model + " " + item.materialCode + " "+ item.sample_leader.charAt(0) );
            card.setAttribute('data-sample_id', item.sample_id || '');
            card.setAttribute('data-sample_name', item.sample_name || '');
            card.setAttribute('data-sample_model', item.sample_model || '');
            card.setAttribute('data-materialCode', item.materialCode || '');
            card.setAttribute('data-sample_category', item.sample_category || '');
            card.setAttribute('data-version', item.version || '');
            card.setAttribute('data-priority', item.priority || '');
            card.setAttribute('data-sample_leader', item.sample_leader || '');
            card.setAttribute('data-supplier', item.supplier || '');
            card.setAttribute('data-test_project_category', item.testProjectCategory || '');
            card.setAttribute('data-test_projects', item.testProjects || '');
            card.setAttribute('data-schedule', item.schedule || '');
            card.setAttribute('data-create_time', item.create_time || '');
            card.setAttribute('data-schedule_days', item.scheduleDays != null ? item.scheduleDays : '1');
            card.setAttribute('data-schedule_color', item.schedule_color != null ? item.schedule_color : '');
            card.setAttribute('draggable', 'true');

            setDraggable(card, true);
            bindCardContextMenu(card, item);
            container.appendChild(card);
        });
    }

    // é¡µé¢åŠ è½½åè¯·æ±‚æ•°æ®
    window.onload = function () {
        // åŠ è½½é¡¹ç›®æ± å­æ•°æ®
        loadProjectPoolData(); // âœ… é¡µé¢åˆå§‹åŒ–è°ƒç”¨åŠ è½½å‡½æ•°

        // æ¨¡æ€æ¡†å…³é—­
        document.getElementById('closeBtn').onclick = function () {
            document.getElementById('modal').style.display = 'none';
        };
        document.getElementById('modal').onclick = function (e) {
            if (e.target.id === 'modal') {
                document.getElementById('modal').style.display = 'none';
            }
        };

        // å…³é—­å˜æ›´è®°å½•æ¨¡æ€æ¡†
        document.getElementById('closeChangeLogBtn').onclick = function () {
            document.getElementById('changeLogModal').style.display = 'none';
        };
        document.getElementById('changeLogModal').onclick = function (e) {
            if (e.target.id === 'changeLogModal') {
                document.getElementById('changeLogModal').style.display = 'none';
            }
        };

    };

    // é¡¹ç›®å¡ç‰‡å³é”®è§¦å‘çš„ç»‘å®šäº‹ä»¶
    function bindCardContextMenu(card, item) {
        card.oncontextmenu = function (event) {
            event.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤å³é”®èœå•

            console.log("è¿™ä¸ªè§¦å‘bindCardContextMenu")

            // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('modalBody').innerHTML = `
            <p><strong>ç”µæ°”ç¼–å·ï¼š</strong>${item.sample_id}</p>
            <p><strong>é¡¹ç›®åç§°ï¼š</strong>${item.sample_name}</p>
            <p><strong>å¤§å°ç¼–ç ï¼š</strong>${item.sample_model + item.materialCode}</p>
            <p><strong>äº§å“ç±»åˆ«ï¼š</strong>${item.sample_category}</p>
            <p><strong>ç‰ˆæœ¬ï¼š</strong>${item.version}</p>
            <p><strong>ä¼˜å…ˆçº§ï¼š</strong>${item.priority}</p>
            <p><strong>é¡¹ç›®è´Ÿè´£äººï¼š</strong>${item.sample_leader}</p>
            <p><strong>ä¾›åº”å•†ï¼š</strong>${item.supplier}</p>
            <p><strong>è¯•éªŒé¡¹ç›®ç±»åˆ«ï¼š</strong>${item.testProjectCategory}</p>
            <p><strong>æµ‹è¯•å­é¡¹ç›®ï¼š</strong>${item.testProjects}</p>
            <p><strong>çŠ¶æ€ï¼š</strong>${getScheduleText(item.schedule)}</p>
            <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${item.create_time}</p>
        `;

            document.getElementById('scheduleDays').value = item.scheduleDays != null ? item.scheduleDays : '';
            // è®¾ç½®é€‰ä¸­çš„é¢œè‰²ï¼Œé»˜è®¤é€‰æ— è‰²
            const selectedColor = item.schedule_color ? item.schedule_color : 'null';
            const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
            if (colorRadio) {
                colorRadio.checked = true;
            }

            document.getElementById('saveScheduleBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };

            document.getElementById('confirmColorBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };


            document.getElementById('modal').style.display = 'block';

        };
    }

    function saveScheduleAndColor(card,item) {
        const days = document.getElementById('scheduleDays').value;
        // if (!days || isNaN(days) || days < 0) {
        //     alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ’æœŸå¤©æ•°ï¼");
        //     return;
        // }

        const selectedColor = document.querySelector('input[name="schedule_color"]:checked')?.value;
        if (!selectedColor) {
            alert("è¯·é€‰æ‹©ä¸€ä¸ªé¢œè‰²ï¼");
            return;
        }

        // è®¡ç®—æ–°çš„æ’æœŸç»“æŸæ—¥æœŸ
        const startDateCell = document.querySelector(`td[data-sample_id="${item.sample_id}"]`);
        let startDate = null;
        let tester = null;
        let job_number = null;
        let originalDays = null;
        if (startDateCell) {
            startDate = startDateCell.getAttribute('data-date');
            tester = startDateCell.getAttribute('data-tester');
            job_number = startDateCell.getAttribute('data-job_number');
            originalDays = startDateCell.getAttribute("data-schedule_days");

            if (!startDate) {
                console.error('æ— æ³•è·å–æ’æœŸå¼€å§‹æ—¥æœŸ');
                return;
            }

            // è·å–æ’æœŸé¢æ¿çš„æ‰€æœ‰å•å…ƒæ ¼
            const allCells = document.querySelectorAll('.drop-cell');
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(startDateObj);
            endDateObj.setDate(endDateObj.getDate() + parseInt(days) - 1);
            const newEndDate = endDateObj.toISOString().split('T')[0];

            // ç”Ÿæˆæ–°æ’æœŸèŒƒå›´å†…çš„æ‰€æœ‰æ—¥æœŸ
            const newDateRange = getDateRange(startDate, newEndDate);

            // æ£€æŸ¥æ–°æ’æœŸæ˜¯å¦ä¼šå ç”¨å…¶ä»–é¡¹ç›®
            for (const date of newDateRange) {
                const cellsOnDate = Array.from(allCells).filter(cell =>
                    cell.getAttribute('data-date') === date &&
                    cell.getAttribute('data-tester') === tester &&
                    cell.innerText.trim() !== '' &&
                    cell.getAttribute('data-sample_id') !== item.sample_id
                );
                if (cellsOnDate.length > 0) {
                    alert('æ–°æ’æœŸä¼šå ç”¨å·²æœ‰é¡¹ç›®ï¼Œè¯·é‡æ–°é€‰æ‹©æ’æœŸå¤©æ•°ï¼');
                    return;
                }
            }

            // æ›´æ–° localScheduleChanges
            const existingIndex = localScheduleChanges.findIndex(change => change.sample_id === item.sample_id);
            if (existingIndex !== -1) {
                localScheduleChanges[existingIndex].start_date = startDate;
                localScheduleChanges[existingIndex].end_date = newEndDate;
                localScheduleChanges[existingIndex].scheduleDays = days;
                localScheduleChanges[existingIndex].schedule_color = selectedColor;
                localScheduleChanges[existingIndex].tester = tester;
                localScheduleChanges[existingIndex].job_number = job_number;
            } else {
                const newChange = {
                    change: "add",
                    sample_id: item.sample_id,
                    tester: tester,
                    start_date: startDate,
                    end_date: newEndDate,
                    scheduleDays: days,
                    schedule_color: selectedColor,
                    job_number: job_number
                };
                localScheduleChanges.push(newChange);
            }
            console.log(localScheduleChanges)

        }
        // if (!startDate) {
        //     // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¼€å§‹æ—¥æœŸï¼Œä»é¡¹ç›®å¡ç‰‡ä¸­è·å–ç›¸å…³ä¿¡æ¯ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
        //     const projectCard = document.querySelector(`.project-card[data-sample_id="${item.sample_id}"]`);
        //     if (projectCard) {
        //         // è¿™é‡Œå‡è®¾é¡¹ç›®å¡ç‰‡ä¸­æœ‰æ’æœŸå¼€å§‹æ—¥æœŸä¿¡æ¯ï¼Œè‹¥æ²¡æœ‰éœ€è¦è°ƒæ•´é€»è¾‘
        //         startDate = projectCard.getAttribute('data-schedule_start_date');
        //     }
        // }




        // 1ï¸âƒ£ ä¿å­˜å¤©æ•°
        fetch('/passback/saveScheduleDays', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sample_id: item.sample_id, scheduleDays: days })
        })
            .then(resp => resp.json())
            .then(resp => {
                // æ›´æ–°å¡ç‰‡æ˜¾ç¤ºå’Œå±æ€§
                if (card) {
                    card.textContent = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} (${days}å¤©)`;
                    card.setAttribute('data-schedule_days', days);
                    item.scheduleDays = days;
                }

                // æ›´æ–°æ’æœŸé¢æ¿ä¸­å¯¹åº”å•å…ƒæ ¼çš„ colspan
                const cells = document.querySelectorAll(`td[data-sample_id="${item.sample_id}"]`);
                cells.forEach(cell => {
                    cell.setAttribute('colspan', days);
                    // è®¾ç½® data-schedule_days å±æ€§çš„å€¼ä¸ colspan ä¸€è‡´
                    cell.setAttribute('data-schedule_days', days);
                    cell.innerText = `${item.sample_model} ${item.materialCode} (${days}å¤©)`;

                    // æ¢å¤è¢«éšè—çš„æ ¼å­
                    const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
                    const startIndex = rowCells.indexOf(cell);

                    // åªæ˜¾ç¤ºåŸåˆå¹¶èŒƒå›´å†…çš„å•å…ƒæ ¼
                    for (let i = startIndex; i < startIndex + originalDays; i++) {
                        if (rowCells[i]) {

                            rowCells[i].style.display = '';
                        }
                    }

                    for (let i = startIndex + 1; i < startIndex + parseInt(days); i++) {
                        if (rowCells[i]){
                            rowCells[i].style.display = 'none';
                        }
                    }
                });

            })
            .catch(err => {
                console.error("ä¿å­˜å¤©æ•°å¤±è´¥ï¼š", err);
                alert("ä¿å­˜å¤©æ•°å¤±è´¥ï¼");
            });

        // 2ï¸âƒ£ ä¿å­˜é¢œè‰²
        fetch('/schedule/saveScheduleColor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                color: selectedColor,
                sample_id: item.sample_id
            })
        })
            .then(response => response.text())
            .then(result => {
                // åˆ¤æ–­æ˜¯å¦ä¸º nullã€ç©ºå­—ç¬¦ä¸²æˆ– undefined
                if (!result || result === 'null') {
                    result = 'æ— è‰²';
                }

                alert("æ’æœŸå¤©æ•°å’Œé¢œè‰²è®¾ç½®æˆåŠŸï¼š" + result);
                document.getElementById('modal').style.display = 'none';

                // æ›´æ–°å¡ç‰‡é¢œè‰²æ ·å¼
                const card = document.querySelector(`.project-card[data-sample_id="${item.sample_id}"]`);
                if (card) {
                    card.classList.remove('gray', 'green', 'yellow', 'red');
                    card.classList.add(selectedColor);
                    card.dataset.schedule_color = selectedColor;
                    item.schedule_color = selectedColor;
                }

                // æ›´æ–°æ’æœŸé¢æ¿ä¸­å¯¹åº”å•å…ƒæ ¼çš„é¢œè‰²
                const cells = document.querySelectorAll(`td[data-sample_id="${item.sample_id}"]`);
                cells.forEach(cell => {
                    cell.style.backgroundColor = selectedColor;
                    cell.dataset.schedule_color = selectedColor;
                });
            })
            .catch(error => {
                console.error("ä¿å­˜é¢œè‰²å¤±è´¥ï¼š", error);
                alert("è®¾ç½®é¢œè‰²å¤±è´¥ï¼Œè¯·é‡è¯•");
            });

        saveSchedule(true);
    }

    async function saveSchedule(isRefrenshBtn) {
        if (!localScheduleChanges || localScheduleChanges.length === 0 ) {
            if(!isRefrenshBtn){
                alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„æ’æœŸå˜æ›´');
            }
            return;
        }

        try {
            const response = await fetch('/scheduleBoard/saveSchedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(localScheduleChanges)
            });

            if (!response.ok) {
                throw new Error(`ä¿å­˜å¤±è´¥: ${response.statusText}`);
            }

            const result = await response.json(); // ç¡®ä¿è§£æ JSON

            alert(result.message+result.statusSummary);

            // æ¸…ç©ºæœ¬åœ°ç¼“å­˜
            localScheduleChanges = [];
        } catch (error) {
            console.error('ä¿å­˜æ’æœŸå¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼');
        }
    }

    async function refreshSchedule() {
        await saveSchedule(true); // ç¡®ä¿ saveSchedule æ‰§è¡Œå®Œæ¯•
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        if (!startDate) {
            alert("è¯·è‡³å°‘é€‰æ‹©åˆå§‹æ—¶é—´ï¼");
            return;
        }

        const contextMenu = document.getElementById('contextMenu');
        contextMenu.removeEventListener('click', handleContextMenuClick);

        document.getElementById('scheduleBoard').innerHTML = '';

        // åŠ è½½æ’æœŸé¢æ¿æ•°æ®
        fetch(`/getSchedulesByStartDate?startDate=${startDate}&endDate=${endDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(async data => {
                const board = document.getElementById('scheduleBoard');

                const allDatesSet = new Set();
                const dateMap = {}; // tester => array of tasks

                data.forEach(item => {
                    const task = {
                        startDate: item.schedule_start_date,
                        endDate: item.schedule_end_date,
                        sample_id: item.sample_id,
                        sizecoding: item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0),
                        sample_category: item.sample_category,
                        sample_model: item.sample_model,
                        sample_name: item.sample_name,
                        priority: item.priority,
                        version: item.version,
                        materialCode: item.materialCode,
                        sample_leader: item.sample_leader,
                        supplier: item.supplier,
                        test_project_category: item.testProjectCategory,
                        testProjects: item.testProjects,
                        schedule: item.schedule,
                        create_time: item.create_time,
                        schudule_days: item.scheduleDays,
                        schedule_start_date: item.schedule_start_date,
                        schedule_end_date: item.schedule_end_date,
                        schedule_color: item.schedule_color,
                        job_number: item.job_number
                    };

                    const tester = item.tester || 'æœªçŸ¥æµ‹è¯•äººå‘˜';
                    if (!dateMap[tester]) dateMap[tester] = [];
                    dateMap[tester].push(task);

                    const dateRange = getDateRange(item.schedule_start_date, item.schedule_end_date);
                    dateRange.forEach(date => allDatesSet.add(date));
                });

                // ğŸ‘‰ å¼ºåˆ¶è¦†ç›–æ—¥æœŸï¼šä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å®Œæ•´æ—¥æœŸèŒƒå›´
                getDateRange(startDate, endDate).forEach(date => allDatesSet.add(date));
                const allDates = Array.from(allDatesSet).sort();

                // ğŸ‘‰ ä¸ä½¿ç”¨ data ä¸­çš„ testerï¼Œç»Ÿä¸€ä» /getTesters è·å–
                try {
                    const testersResponse = await fetch('/getTesters');
                    const testersData = await testersResponse.json();

                    drawScheduleBoard(board, testersData, allDates, dateMap);
                } catch (error) {
                    console.error("è·å–æµ‹è¯•äººå‘˜å¤±è´¥:", error);
                    document.getElementById('scheduleBoard').innerHTML = 'æµ‹è¯•äººå‘˜åŠ è½½å¤±è´¥ã€‚';
                }
            })
            .catch(error => {
                document.getElementById('scheduleBoard').innerHTML = 'æ’æœŸåŠ è½½å¤±è´¥ã€‚';
                console.error('Error loading schedule board:', error);
            });
    }

    function groupTestersByCategory(testers) {
        const groupMap = {};

        testers.forEach(tester => {
            const group = tester.responsible_category || 'æœªåˆ†ç»„';
            if (!groupMap[group]) {
                groupMap[group] = [];
            }
            groupMap[group].push(tester);
        });

        return groupMap;
    }

    // ç»˜åˆ¶æ’æœŸé¢æ¿
    function drawScheduleBoard(board, testers, allDates, dateMap) {
        let html = '<table id="scheduleBoardTable" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse;">';

        // è¡¨å¤´
        html += '<thead><tr>';
        html += '<th>ç»„åˆ«</th>';
        html += '<th style="min-width: 100px;">æµ‹è¯•äººå‘˜</th>';
        allDates.forEach(date => {
            html += `<th>${date}</th>`;
        });
        html += '</tr></thead><tbody>';

        const groupedTesters = groupTestersByCategory(testers);

        // â­â­ æ–°å¢ï¼šç»„åˆ«é¡ºåºæ•°ç»„
        const groupOrder = ['çº¿æç»„', 'æ–°äºº', 'è§†é¢‘ç»„', 'æ•°æ®ç½‘é€šç»„', 'è“ç‰™ç»„' ,"è€Œæœºç»„ç»„", "é«˜é¢‘ç»„"]; // æŒ‰ä½ çš„éœ€æ±‚æ”¹é¡ºåº

        // â­â­ æ–°å¢ï¼šå…ˆæŒ‰ç…§ groupOrder éå†
        groupOrder.forEach(groupName => {
            const groupTesters = groupedTesters[groupName];
            if (!groupTesters) return; // å¦‚æœæŸç»„æ²¡äººï¼Œè·³è¿‡

            const groupRowSpan = groupTesters.length;

            groupTesters.forEach((tester, testerIndex) => {
                const testerName = tester.test_engineer_name;
                const jobNumber = tester.engineer_id;

                html += '<tr>';

                if (testerIndex === 0) {
                    html += `<td rowspan="${groupRowSpan}" style="text-align: center; font-weight: bold;">${groupName}</td>`;
                }

                html += `<td><strong>${testerName}</strong></td>`;

                let colIndex = 0;
                while (colIndex < allDates.length) {
                    const currentDate = allDates[colIndex];
                    const task = dateMap[testerName]?.find(t => t.startDate === currentDate);

                    if (task) {
                        const rangeDates = getDateRange(task.startDate, task.endDate);
                        const colspan = rangeDates.length;

                        html += createTaskCell(task, testerName, currentDate, colspan);

                        for (let i = 1; i < colspan; i++) {
                            html += `<td class="drop-cell" style="display: none;" data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${allDates[colIndex + i]}"></td>`;
                        }

                        colIndex += colspan;
                    } else {
                        const isCovered = dateMap[testerName]?.some(t => t.startDate < currentDate && t.endDate >= currentDate);
                        if (!isCovered) {
                            html += `<td class="drop-cell" data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${currentDate}"></td>`;
                            // html += `<!--<td class="drop-cell" style="min-width: 150px;" data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${currentDate}"></td>-->`;
                        }
                        colIndex += 1;
                    }
                }

                html += '</tr>';
            });
        });

        html += '</tbody></table>';
        board.innerHTML = html;

        // ä¸ºä»»åŠ¡å•å…ƒæ ¼æ·»åŠ æ‹–æ‹½äº‹ä»¶
        const assignedCells = document.querySelectorAll('#scheduleBoardTable td.assigned');
        assignedCells.forEach(cell => {
            cell.setAttribute('draggable', 'true');
            cell.addEventListener('dragstart', e => {
                const taskData = {};
                const attributes = [
                    'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                    'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                    'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                    'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color'
                ];
                attributes.forEach(attr => {
                    taskData[attr] = cell.getAttribute(`data-${attr}`);
                });
                Object.entries(taskData).forEach(([key, value]) => {
                    e.dataTransfer.setData(`project-${key}`, value);
                });
            });
        });

        const cells = document.querySelectorAll('.drop-cell');
        const projectPool = document.getElementById('projectPool');

        // ä¸ºé¡¹ç›®æ± å­æ·»åŠ æ‹–æ‹½äº‹ä»¶
        projectPool.addEventListener('dragover', e => {
            e.preventDefault();
        });
        projectPool.addEventListener('drop', e => {
            e.preventDefault();
            const taskData = {};
            const attributes = [
                'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color'
            ];
            attributes.forEach(attr => {
                taskData[attr] = e.dataTransfer.getData(`project-${attr}`);
            });
            const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);
            if (originalCell) {
                const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                const originalStartIndex = originalRowCells.indexOf(originalCell);
                handleUndo(originalRowCells, originalStartIndex, taskData);
            }
        });

        cells.forEach((cell, cellIndex, cellList) => {
            cell.addEventListener('dragover', e => {
                e.preventDefault();
                cell.classList.add('over');
            });

            cell.addEventListener('dragleave', () => cell.classList.remove('over'));

            cell.addEventListener('drop', e => {
                e.preventDefault();
                cell.classList.remove('over');

                const sample_id = e.dataTransfer.getData('project-sample_id');
                const days = parseFloat(e.dataTransfer.getData('project-days')) || 1;
                const sizecoding = e.dataTransfer.getData('project-sizecoding') || 1;

                const tester = cell.getAttribute('data-tester');
                const job_number = cell.getAttribute('data-job_number');
                const startDate = cell.getAttribute('data-date');

                const schedule_days = parseFloat(e.dataTransfer.getData('project-schedule_days')) || 1;

                if ((!sample_id || sample_id.trim() === "")) {
                    console.warn("æ— æ•ˆæ‹–æ‹½å†…å®¹ï¼šsample_id å’Œ schedule_days éƒ½ä¸ºç©ºï¼Œå¿½ç•¥æœ¬æ¬¡æ‹–æ‹½ã€‚");
                    return;
                }

                const startDateObj = new Date(startDate);
                startDateObj.setDate(startDateObj.getDate() + Math.ceil(schedule_days) - 1);
                const schedule_end_date = startDateObj.toISOString().split('T')[0];

                const taskData = {
                    sample_id,
                    days,
                    sizecoding,
                    tester,
                    job_number,
                    startDate,
                    sample_name: e.dataTransfer.getData('project-sample_name'),
                    sample_model: e.dataTransfer.getData('project-sample_model'),
                    materialCode: e.dataTransfer.getData('project-materialCode'),
                    sample_category: e.dataTransfer.getData('project-sample_category'),
                    version: e.dataTransfer.getData('project-version'),
                    priority: e.dataTransfer.getData('project-priority'),
                    sample_leader: e.dataTransfer.getData('project-sample_leader'),
                    supplier: e.dataTransfer.getData('project-supplier'),
                    test_project_category: e.dataTransfer.getData('project-test_project_category'),
                    test_projects: e.dataTransfer.getData('project-test_projects'),
                    schedule: e.dataTransfer.getData('project-schedule'),
                    create_time: e.dataTransfer.getData('project-create_time'),
                    schedule_days: e.dataTransfer.getData('project-schedule_days'),
                    schedule_start_date: startDate,
                    schedule_end_date: schedule_end_date,
                    schedule_color: e.dataTransfer.getData('project-schedule_color')
                };

                const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
                const startIndex = rowCells.indexOf(cell);
                const roundedDays = Math.ceil(parseFloat(schedule_days));
                console.log("startIndex,",startIndex);

                // æ£€æŸ¥æ’æœŸæ˜¯å¦è¶…å‡ºå¯æ’èŒƒå›´
                if (startIndex + roundedDays > rowCells.length) {
                    alert("æ’æœŸè¶…å‡ºå¯æ’èŒƒå›´ï¼è¯·è®¾ç½®æ›´å¹¿æ³›çš„æ—¥æœŸ");
                    return;
                }

                // æ£€æŸ¥æ’æœŸåŒºåŸŸæ˜¯å¦å·²è¢«å ç”¨
                for (let i = startIndex; i < startIndex + roundedDays; i++) {
                    if (rowCells[i].innerText.trim() !== '') {

                        const confirmInsert = confirm('æ’å…¥ä½ç½®å·²è¢«å ç”¨ï¼Œæ˜¯å¦å°†åç»­é¡¹ç›®å¾€åæŒªï¼Ÿ');
                        if (!confirmInsert) {
                            return;
                        }
                    }
                }

                // æ–°å¢å¯¹åç»­é¡¹ç›®æ²¡ä½ç½®çš„åˆ¤æ–­
                let conflictCells = [];
                for (let i = startIndex; i < startIndex + roundedDays; i++) {
                    if (rowCells[i].innerText.trim() !== '') {
                        conflictCells.push(rowCells[i]);
                        // console.log(rowCells[i].innerHTML.trim(),i);
                    }
                }
                console.log("conflictCells.length,",conflictCells.length)
                const projectsToMove = [];
                let diff;
                if (conflictCells.length > 0) {
                    // æ‰¾åˆ°æ‰€æœ‰éœ€è¦å¾€åæŒªçš„é¡¹ç›®
                    let currentIndex = startIndex;
                    while (currentIndex < rowCells.length) {
                        const currentCell = rowCells[currentIndex];
                        if (currentCell.innerText.trim() !== '') {
                            const projectSpan = parseInt(currentCell.getAttribute('colspan')) || 1;
                            const projectData = {};
                            const attributes = [
                                'sample_id', 'sizecoding', 'tester', 'job_number', 'sample_name',
                                'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color'
                            ];
                            attributes.forEach(attr => {
                                projectData[attr] = currentCell.getAttribute(`data-${attr}`);
                            });
                            projectsToMove.push({
                                startIndex: currentIndex,
                                span: projectSpan,
                                data: projectData
                            });
                            currentIndex += projectSpan;
                        } else {
                            currentIndex++;
                        }
                    }
                    console.log("projectsToMove:",projectsToMove)

                    let minStartIndex = Infinity;  // åˆå§‹åŒ–æœ€å°çš„ startIndex å€¼
                    let maxStartIndex = Infinity;  // åˆå§‹åŒ–æœ€å°çš„ startIndex å€¼
                    let maxSpan = Infinity;  // åˆå§‹åŒ–æœ€å°çš„ startIndex å€¼
                    let maxSample_id = '';
                    // æ‰¾åˆ°æœ€å°çš„ startIndex
                    minStartIndex = Math.min(...projectsToMove.map(project => project.startIndex));
                    maxStartIndex = Math.max(...projectsToMove.map(project => project.startIndex));
                    maxSpan = Math.max(...projectsToMove.map(project => project.span));
                    maxSample_id = projectsToMove[0].data.sample_id;
                    console.log("maxSpan",maxSpan)
                    console.log("maxStartIndex:", maxStartIndex);
                    console.log("maxSample_id:", maxSample_id);

                    // è®¡ç®—æ‹–æ‹½é¡¹ç›®ä¸æœ€å°startIndexçš„å·®å€¼
                    diff = roundedDays - minStartIndex + startIndex;
                    console.log("æ‹–æ‹½é¡¹ç›®ä¸æœ€å°startIndexçš„å·®å€¼:", diff);

                    console.log("sample_id",sample_id)
                    if(maxSample_id === sample_id){
                        alert("è¯·å…ˆç§»åŠ¨åˆ°åˆ«çš„åœ°æ–¹ï¼ˆä¾‹å¦‚é¡¹ç›®æ± å­æˆ–è€…ç©ºçš„æ—¥æœŸï¼‰ï¼Œå†æ‹–æ‹½å›æ¥")
                        return;
                    }

                    if (maxStartIndex + diff + maxSpan > rowCells.length ) {
                        alert("åç»­é¡¹ç›®ç§»åŠ¨åè¶…å‡ºå¯æ’èŒƒå›´ï¼");
                        return;
                    }

                }

                // ç¡®è®¤å¯ä»¥æ”¾ç½®é¡¹ç›®åï¼Œå†æ¸…ç©ºåŸæ’æœŸ
                const originalCell = document.querySelector(`td[data-sample_id="${sample_id}"]`);
                if (originalCell) {
                    const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                    const originalStartIndex = originalRowCells.indexOf(originalCell);
                    const originalScheduleDays = parseInt(originalCell.getAttribute('data-schedule_days')) || 1;

                    // æ¸…é™¤åŸå•å…ƒæ ¼å†…å®¹å’Œå±æ€§
                    originalCell.innerText = '';
                    originalCell.removeAttribute('colspan');
                    originalCell.classList.remove('assigned');
                    originalCell.style.backgroundColor = '';

                    const allowedAttributes = ['class', 'data-tester', 'data-date','data-job_number'];
                    [...originalCell.attributes].forEach(attr => {
                        if (!allowedAttributes.includes(attr.name)) {
                            originalCell.removeAttribute(attr.name);
                        }
                    });

                    // æ¢å¤è¢«éšè—çš„æ ¼å­
                    for (let i = originalStartIndex; i < Math.min(originalStartIndex + originalScheduleDays, originalRowCells.length); i++) {
                        if (originalRowCells[i]) originalRowCells[i].style.display = '';
                    }
                }

                handleDrop(cell, cellList, taskData,  conflictCells ,projectsToMove ,diff );
            });

            cell.addEventListener('contextmenu', e => {
                e.preventDefault();
                if (cell.innerText.trim() === '') return;
                currentRightClickCell = cell;
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.display = 'block';
            });
        });

        const contextMenu = document.getElementById('contextMenu');
        contextMenu.addEventListener('click', handleContextMenuClick);

        document.querySelectorAll('#scheduleBoardTable td[data-schedule_color]').forEach(cell => {
            const color = cell.getAttribute('data-schedule_color');
            if (color) {
                cell.style.backgroundColor = color;
            }
        });
    }

    // åˆ›å»ºæ’æœŸé¢æ¿çš„å•å…ƒæ ¼
    function createTaskCell(task, tester, currentDate, colspan) {
        return `
        <td class="drop-cell assigned"
          data-tester="${tester}"
          data-date="${currentDate}"
          data-job_number="${task.job_number}"
          colspan="${colspan}"
          data-sample_id="${task.sample_id || ''}"
          data-sample_name="${task.sample_name || ''}"
          data-sample_model="${task.sample_model || ''}"
          data-materialCode="${task.materialCode || ''}"
          data-sample_category="${task.sample_category || ''}"
          data-version="${task.version || ''}"
          data-priority="${task.priority || ''}"
          data-sample_leader="${task.sample_leader || ''}"
          data-supplier="${task.supplier || ''}"
          data-test_project_category="${task.test_project_category || ''}"
          data-test_projects="${task.test_projects || ''}"
          data-schedule="${task.schedule || ''}"
          data-create_time="${task.create_time || ''}"
          data-schedule_days="${task.schudule_days || ''}"
          data-sizecoding="${task.sizecoding || ''}"
          data-schedule_start_date="${task.schedule_start_date || ''}"
          data-schedule_end_date="${task.schedule_end_date || ''}"
          data-schedule_color="${task.schedule_color || ''}"
        >${task.sizecoding} (${task.schudule_days}å¤©)</td>
      `;
    }

    function handleContextMenuClick() {
        // å…³é—­å³é”®èœå•
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'none';
    }



    // å¤„ç†æ‹–æ‹½æ”¾ä¸‹äº‹ä»¶
    function handleDrop(cell, cellList, taskData, conflictCells ,projectsToMove ,diff ) {
        const { sample_id, days, sizecoding, tester, job_number, startDate, schedule_days, schedule_color } = taskData;
        const roundedDays = Math.ceil(parseFloat(schedule_days)); // ä½¿ç”¨ schedule_days ç¡®å®šåˆå¹¶å•å…ƒæ ¼æ•°é‡
        const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
        const startIndex = rowCells.indexOf(cell);

        if (conflictCells.length > 0) {
            // ä»åå¾€å‰ç§»åŠ¨é¡¹ç›®
            for (let i = projectsToMove.length - 1; i >= 0; i--) {
                const { startIndex: projectStartIndex, span, data } = projectsToMove[i];
                const newStartIndex = projectStartIndex + diff;
                console.log("é¡¹ç›®èµ·å§‹ä½ç½®: ", projectStartIndex);
                console.log("æŒªåŠ¨çš„å¤©æ•°: ", diff);
                console.log("æ–°çš„èµ·å§‹ä½ç½®: ", newStartIndex);

                // æ¸…é™¤åŸé¡¹ç›®
                const originalStartCell = rowCells[projectStartIndex];
                originalStartCell.innerText = '';
                originalStartCell.removeAttribute('colspan');
                originalStartCell.classList.remove('assigned');
                originalStartCell.style.backgroundColor = '';
                const allowedAttributes = ['class', 'data-tester', 'data-date'];
                [...originalStartCell.attributes].forEach(attr => {
                    if (!allowedAttributes.includes(attr.name)) {
                        originalStartCell.removeAttribute(attr.name);
                    }
                });
                // æ¢å¤è¢«éšè—çš„æ ¼å­
                for (let j = projectStartIndex; j < projectStartIndex + span; j++) {
                    if (rowCells[j]) rowCells[j].style.display = '';
                }
                // åˆ›å»ºæ–°é¡¹ç›®
                const newStartCell = rowCells[newStartIndex];
                newStartCell.innerText = `${data.sizecoding} (${data.schedule_days}å¤©)`;
                newStartCell.classList.add('assigned');
                newStartCell.style.backgroundColor = data.schedule_color || "";
                newStartCell.setAttribute('colspan', span);
                Object.keys(data).forEach(key => {
                    if (key !== 'days') {
                        newStartCell.setAttribute(`data-${key}`, data[key]);
                    }
                });
                for (let j = newStartIndex + 1; j < newStartIndex + span; j++) {
                    console.log("j",j);
                    rowCells[j].style.display = 'none';
                }
                // æ›´æ–° localScheduleChanges
                const newEndDate = rowCells[newStartIndex + span - 1].getAttribute('data-date');
                const newChange = {
                    change: "add",
                    sample_id: data.sample_id,
                    tester: data.tester,
                    start_date: rowCells[newStartIndex].getAttribute('data-date'),
                    end_date: newEndDate,
                    scheduleDays: data.schedule_days,
                    schedule_color: data.schedule_color,
                    job_number: data.job_number
                };
                const existingIndex = localScheduleChanges.findIndex(item =>
                    item.sample_id === data.sample_id
                );
                if (existingIndex !== -1) {
                    localScheduleChanges[existingIndex] = newChange;
                } else {
                    localScheduleChanges.push(newChange);
                }

                // æ·»åŠ å…è®¸æ‹–æ‹½çš„æ–¹æ³•
                newStartCell.setAttribute('draggable', 'true');
                newStartCell.addEventListener('dragstart', function (e) {
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color'
                    ];
                    attributes.forEach(attr => {
                        taskData[attr] = this.getAttribute(`data-${attr}`);
                    });
                    Object.entries(taskData).forEach(([key, value]) => {
                        e.dataTransfer.setData(`project-${key}`, value);
                    });
                });
            }
        }
        console.log("startCellçš„startIndex",startIndex)

        // æ”¾ç½®æ–°æ’å…¥çš„é¡¹ç›®
        const startCell = rowCells[startIndex];
        startCell.innerText = `${sizecoding} (${schedule_days}å¤©)`;
        startCell.classList.add('assigned');
        startCell.style.backgroundColor = schedule_color || "";
        startCell.setAttribute('colspan', roundedDays);
        Object.keys(taskData).forEach(key => {
            if (key !== 'days') {
                startCell.setAttribute(`data-${key}`, taskData[key]);
            }
        });
        for (let i = startIndex + 1; i < startIndex + roundedDays; i++) {
            rowCells[i].style.display = 'none';
        }
        const projectEl = document.querySelector(`.project-card[data-sample_id="${sample_id}"]`);
        if (projectEl) projectEl.remove();
        const endDate = rowCells[startIndex + roundedDays - 1].getAttribute('data-date');
        // æ„é€ æ–°çš„å˜æ›´å¯¹è±¡
        const newChange = {
            change: "add",
            sample_id: sample_id,
            tester,
            start_date: startDate,
            end_date: endDate,
            scheduleDays: schedule_days,
            schedule_color: schedule_color,
            job_number: job_number
        };
        // æŸ¥æ‰¾å¹¶æ›´æ–°å·²æœ‰è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™æ·»åŠ 
        const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
        );
        if (existingIndex !== -1) {
            localScheduleChanges[existingIndex] = newChange;
        } else {
            localScheduleChanges.push(newChange);
        }
        console.log("addçš„",localScheduleChanges);
        // é‡æ–°ä¸ºæ–°ç”Ÿæˆçš„æ’æœŸå•å…ƒæ ¼æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        startCell.setAttribute('draggable', 'true');
        startCell.addEventListener('dragstart', function (e) {
            const taskData = {};
            const attributes = [
                'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color'
            ];
            attributes.forEach(attr => {
                taskData[attr] = this.getAttribute(`data-${attr}`);
            });
            Object.entries(taskData).forEach(([key, value]) => {
                e.dataTransfer.setData(`project-${key}`, value);
            });
        });
    }


    // å¤„ç†æ’¤å›æ’æœŸäº‹ä»¶ï¼Œæ’¤å›æ’æœŸæŒ‰é’®è§¦å‘è¿™ä¸ªæ–¹æ³•
    function handleUndo(rowCells, startIndex, taskData) {
        const { schedule_days, sample_id } = taskData;
        const currentRightClickCell = rowCells[startIndex];

        // æ¸…é™¤åŸå§‹å†…å®¹å’Œå±æ€§
        currentRightClickCell.innerText = '';
        currentRightClickCell.removeAttribute('colspan');
        currentRightClickCell.classList.remove('assigned');

        const allowedAttributes = ['class', 'data-tester', 'data-date','data-job_number'];
        [...currentRightClickCell.attributes].forEach(attr => {
            if (!allowedAttributes.includes(attr.name)) {
                currentRightClickCell.removeAttribute(attr.name);
            }
        });

        // æ¢å¤è¢«éšè—çš„æ ¼å­
        for (let i = startIndex; i < Math.min(startIndex + Number(schedule_days), rowCells.length); i++) {
            if (rowCells[i]) rowCells[i].style.display = '';
        }

        // é‡æ–°ç”Ÿæˆæ‹–æ‹½é¡¹ç›®å¡ç‰‡
        const restoredProject = document.createElement('div');
        restoredProject.className = 'project-card';

        // âœ… è®¾ç½®é¢œè‰² classï¼ˆé»˜è®¤ grayï¼‰
        const colorClass = taskData.schedule_color || 'gray';
        restoredProject.classList.add(colorClass);

        restoredProject.setAttribute('draggable', 'true');
        restoredProject.setAttribute('data-sample_id', sample_id);
        restoredProject.setAttribute('data-schedule_days', schedule_days);
        //   è¿™é‡Œ
        restoredProject.textContent = `${taskData.sizecoding} (${schedule_days}å¤©)`;


        //è¿™é‡Œæ˜¯æ’¤å›æ’æœŸç‚¹å‡»çš„æ—¶å€™ï¼Œæ”¾å›å»çš„æ—¶å€™æ£€æŸ¥å“ªäº›æ ‡ç­¾å»æ‰
        Object.keys(taskData).forEach(key => {
            if (key !== 'days' && key !== 'schedule_start_date' && key !== 'schedule_end_date' && key!== 'job_number'
                && key!== 'tester') {
                restoredProject.setAttribute(`data-${key}`, taskData[key]);
            }
        });

        setDraggable(restoredProject, true);

        const restoredItem = {
            sample_id: sample_id,
            sample_name: taskData.sample_name,
            sample_model: taskData.sample_model,
            materialCode: taskData.materialCode,
            sample_category: taskData.sample_category,
            version: taskData.version,
            priority: taskData.priority,
            sample_leader: taskData.sample_leader,
            supplier: taskData.supplier,
            testProjectCategory: taskData.test_project_category,
            testProjects: taskData.test_projects,
            schedule: taskData.schedule,
            create_time: taskData.create_time,
            scheduleDays: schedule_days,
            schedule_color: taskData.schedule_color
        };

        restoredProject.oncontextmenu = (event) => {
            event.preventDefault();
            bindCardContextMenu(restoredProject, restoredItem);
        };

        const projectPool = document.getElementById('projectPool');
        projectPool.appendChild(restoredProject);

        // è®°å½•åˆ é™¤æ“ä½œåˆ° localScheduleChangesï¼Œé¿å…é‡å¤æ·»åŠ 
        const newChange = {
            change: "delete",
            sample_id: sample_id,
            tester: taskData.tester,
            start_date: taskData.schedule_start_date,
            end_date: taskData.schedule_end_date,
            scheduleDays: schedule_days,
            schedule_color: taskData.schedule_color,
            job_number: taskData.job_number
        };

        const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
        );

        if (existingIndex !== -1) {
            localScheduleChanges[existingIndex] = newChange;
        } else {
            localScheduleChanges.push(newChange);
        }

        console.log("deleteçš„",localScheduleChanges);
    }
    // å·¥å…·å‡½æ•°ï¼šç”ŸæˆæŸèŒƒå›´å†…æ‰€æœ‰æ—¥æœŸå­—ç¬¦ä¸²æ•°ç»„
    function getDateRange(start, end) {
        const dates = [];
        const current = new Date(start);
        const last = new Date(end);
        while (current <= last) {
            const yyyy = current.getFullYear();
            const mm = String(current.getMonth() + 1).padStart(2, '0');
            const dd = String(current.getDate()).padStart(2, '0');
            dates.push(`${yyyy}-${mm}-${dd}`);
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }

    function showProjectAttributes(event) {
        if (event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        }
        if (!currentRightClickCell) return;
        const taskData = {
            sample_id: currentRightClickCell.getAttribute('data-sample_id'),
            sample_name: currentRightClickCell.getAttribute('data-sample_name'),
            sample_model: currentRightClickCell.getAttribute('data-sample_model'),
            materialCode: currentRightClickCell.getAttribute('data-materialCode'),
            sample_category: currentRightClickCell.getAttribute('data-sample_category'),
            version: currentRightClickCell.getAttribute('data-version'),
            priority: currentRightClickCell.getAttribute('data-priority'),
            sample_leader: currentRightClickCell.getAttribute('data-sample_leader'),
            supplier: currentRightClickCell.getAttribute('data-supplier'),
            test_project_category: currentRightClickCell.getAttribute('data-test_project_category'),
            test_projects: currentRightClickCell.getAttribute('data-test_projects'),
            schedule: currentRightClickCell.getAttribute('data-schedule'),
            create_time: currentRightClickCell.getAttribute('data-create_time'),
            scheduleDays: currentRightClickCell.getAttribute('data-schedule_days'),
            schedule_color: currentRightClickCell.getAttribute('data-schedule_color')
        };

        // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
        document.getElementById('modalBody').innerHTML = `
            <p><strong>ç”µæ°”ç¼–å·ï¼š</strong>${taskData.sample_id}</p>
            <p><strong>é¡¹ç›®åç§°ï¼š</strong>${taskData.sample_name}</p>
            <p><strong>å¤§å°ç¼–ç ï¼š</strong>${taskData.sample_model + taskData.materialCode}</p>
            <p><strong>äº§å“ç±»åˆ«ï¼š</strong>${taskData.sample_category}</p>
            <p><strong>ç‰ˆæœ¬ï¼š</strong>${taskData.version}</p>
            <p><strong>ä¼˜å…ˆçº§ï¼š</strong>${taskData.priority}</p>
            <p><strong>é¡¹ç›®è´Ÿè´£äººï¼š</strong>${taskData.sample_leader}</p>
            <p><strong>ä¾›åº”å•†ï¼š</strong>${taskData.supplier}</p>
            <p><strong>è¯•éªŒé¡¹ç›®ç±»åˆ«ï¼š</strong>${taskData.test_project_category}</p>
            <p><strong>æµ‹è¯•å­é¡¹ç›®ï¼š</strong>${taskData.test_projects}</p>
            <p><strong>çŠ¶æ€ï¼š</strong>${getScheduleText(taskData.schedule)}</p>
            <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${taskData.create_time}</p>
        `;

        document.getElementById('scheduleDays').value = taskData.scheduleDays != null ? taskData.scheduleDays : '';
        // è®¾ç½®é€‰ä¸­çš„é¢œè‰²ï¼Œé»˜è®¤é€‰æ— è‰²
        const selectedColor = taskData.schedule_color ? taskData.schedule_color : 'null';
        const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
        if (colorRadio) {
            colorRadio.checked = true;
        }

        document.getElementById('saveScheduleBtn').onclick = function () {
            saveScheduleAndColor(null, taskData);
        };

        document.getElementById('confirmColorBtn').onclick = function () {
            const selectedColor = document.querySelector('input[name="schedule_color"]:checked')?.value;
            if (!selectedColor) {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªé¢œè‰²ï¼");
                return;
            }

            // ä¿å­˜é¢œè‰²
            fetch('/schedule/saveScheduleColor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    color: selectedColor,
                    sample_id: taskData.sample_id
                })
            })
                .then(response => response.text())
                .then(result => {
                    // åˆ¤æ–­æ˜¯å¦ä¸º nullã€ç©ºå­—ç¬¦ä¸²æˆ– undefined
                    if (!result || result === 'null') {
                        result = 'æ— è‰²';
                    }

                    alert("é¢œè‰²è®¾ç½®æˆåŠŸï¼š" + result);
                    document.getElementById('modal').style.display = 'none';

                    // æ›´æ–°æ’æœŸé¢æ¿ä¸­å¯¹åº”å•å…ƒæ ¼çš„é¢œè‰²
                    const cells = document.querySelectorAll(`td[data-sample_id="${taskData.sample_id}"]`);
                    cells.forEach(cell => {
                        cell.style.backgroundColor = selectedColor;
                        cell.dataset.schedule_color = selectedColor;
                    });

                    // æ›´æ–°é¡¹ç›®æ± ä¸­çš„å¡ç‰‡é¢œè‰²
                    const projectCard = document.querySelector(`.project-card[data-sample_id="${taskData.sample_id}"]`);
                    if (projectCard) {
                        projectCard.classList.remove('gray', 'green', 'yellow', 'red');
                        projectCard.classList.add(selectedColor);
                        projectCard.dataset.schedule_color = selectedColor;
                    }
                })
                .catch(error => {
                    console.error("ä¿å­˜é¢œè‰²å¤±è´¥ï¼š", error);
                    alert("è®¾ç½®é¢œè‰²å¤±è´¥ï¼Œè¯·é‡è¯•");
                });
        };

        document.getElementById('modal').style.display = 'block';

        // å…³é—­å³é”®èœå•
        const contextMenuForShow = document.getElementById('contextMenu');
        contextMenuForShow.style.display = 'none';
    }


    function getScheduleText(code) {
        switch (code) {
            case "15":
                return "å¾…æ’æœŸ";
            case "16":
                return "å·²æ’æœŸå¾…æµ‹è¯•";
            case "0":
                return "æµ‹è¯•ä¸­";
            case "1":
                return "å¾…å®¡æ ¸";
            case "2":
                return "å®¡æ ¸å®Œæˆ";
            case "9":
                return "æ ·å“é€€æ ·";
            case "10":
                return "ç«å“å®Œæˆ";
            default:
                return code || "";
        }
    }



    // ç»‘å®šå˜æ›´è®°å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function () {
        const changeLogBtn = document.getElementById('changeLogBtn');
        changeLogBtn.addEventListener('click', function () {
            const sample_id = document.getElementById('modalBody').querySelector('p:nth-child(1)').textContent.split('ï¼š')[1].trim();
            fetch(`/api/getChangeLog?sample_id=${sample_id}`)
                .then(response => response.json())
                .then(data => {
                    const changeLogBody = document.getElementById('changeLogBody');
                    changeLogBody.innerHTML = '';

                    if (data.length === 0) {
                        changeLogBody.innerHTML = 'æš‚æ— å˜æ›´è®°å½•ã€‚';
                    } else {
                        const template = document.getElementById('changeLogTemplate').innerHTML;

                        data.forEach(change => {
                            let itemHTML = template
                                .replace('{{tester}}', change.tester)
                                .replace('{{startDate}}', change.startDate)
                                .replace('{{endDate}}', change.endDate)
                                .replace('{{updateTime}}', change.updateTime || 'æ— ')
                                .replaceAll('{{color}}', change.color)
                                .replace('{{used}}', change.used);

                            changeLogBody.insertAdjacentHTML('beforeend', itemHTML);
                        });
                    }

                    document.getElementById('changeLogModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('è·å–å˜æ›´è®°å½•å¤±è´¥:', error);
                    document.getElementById('changeLogBody').innerHTML = 'è·å–å˜æ›´è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                });
        });

    });







</script>

</body>
</html>