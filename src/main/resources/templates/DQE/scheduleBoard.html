<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ’æœŸç‰ˆ</title>

    <link rel="stylesheet" href="/css/scheduleBoard.css">-->


</head>
<body>
<h1>æ’æœŸç‰ˆ</h1>
<div class="controls">
    <button id="addTester">æ–°å¢æµ‹è¯•äººå‘˜</button>
    <button id="addProject">æ–°å¢é¡¹ç›®</button>
    <button id="addDay">æ–°å¢æ’æœŸæ—¥æœŸ</button>
</div>
<div class="container">
    <div class="pool" id="pool">
        <h3>é¡¹ç›®æ± å­</h3>
    </div>
    <div class="schedule-container">
        <h3>æ’æœŸç‰ˆ</h3>
        <div class="schedule" id="schedule"></div>
    </div>
</div>

<script>
    const pool = document.getElementById('pool');
    const schedule = document.getElementById('schedule');

    let testers = [];
    let dates = [];
    // å­˜å‚¨æ’æœŸæ•°æ®ï¼š{ tester: { date: { project, days, startDate, color } } }
    let scheduleData = {};
    // å½“æ‹–æ‹½æ’æœŸä¸­é¡¹ç›®æ—¶è®°å½•åŸå§‹ä¿¡æ¯ï¼ˆç”¨äºæ‹–æ‹½å–æ¶ˆæ—¶å›é€€ï¼‰
    let draggedProjectOriginal = null;

    // ç”Ÿæˆå”¯ä¸€é¡¹ç›®åç§°
    function getNextProjectName() {
        const existing = new Set();
        Array.from(pool.children).forEach(p => existing.add(p.textContent));
        Array.from(schedule.querySelectorAll('.occupied')).forEach(c => existing.add(c.textContent));
        let num = 1;
        while (existing.has(`é¡¹ç›®${num}`)) num++;
        return `é¡¹ç›®${num}`;
    }

    // æ¸²æŸ“æ’æœŸè¡¨
    function renderSchedule() {
        const cols = dates.length + 1;
        const rows = testers.length + 1;

        schedule.style.gridTemplateColumns = `150px repeat(${cols - 1}, 100px)`;
        schedule.style.gridTemplateRows = `repeat(${rows}, 50px)`;
        schedule.innerHTML = '';

        // è¡¨å¤´è¡Œ
        schedule.appendChild(createHeaderCell('æµ‹è¯•äººå‘˜/æ—¥æœŸ'));
        dates.forEach(date => schedule.appendChild(createHeaderCell(date)));

        // æ•°æ®è¡Œ
        testers.forEach(tester => {
            schedule.appendChild(createHeaderCell(tester));
            dates.forEach((date, dateIndex) => {
                const cell = createEmptyCell();
                cell.dataset.tester = tester;
                cell.dataset.date = date;
                cell.dataset.dateIndex = dateIndex;

                const projectData = scheduleData[tester]?.[date];
                // åœ¨æ¸²æŸ“æ’æœŸæ—¶ï¼Œæ£€æŸ¥é¡¹ç›®æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™è¿›è¡Œåˆå¹¶æ˜¾ç¤º
                if (projectData) {
                    if (projectData.startDate === date) {
                        // åˆå¹¶å•å…ƒæ ¼
                        cell.style.gridColumnEnd = `span ${projectData.days}`;
                        cell.classList.add('merge-start');
                        cell.classList.add('occupied');
                        // è®©å•å…ƒæ ¼èƒŒæ™¯è‰²ä¸é¡¹ç›®é¢œè‰²ä¿æŒä¸€è‡´
                        cell.style.backgroundColor = projectData.color || '#f44336';
                        cell.innerHTML = ''; // æ¸…ç©ºå†…å®¹
                        const projDiv = document.createElement('div');
                        projDiv.className = 'project';
                        projDiv.draggable = true;
                        projDiv.textContent = projectData.project;
                        projDiv.style.backgroundColor = projectData.color || '#f44336';
                        addDragAndDropFromSchedule(projDiv, tester, date, projectData);
                        addColorSelector(projDiv);
                        cell.appendChild(projDiv);
                    } else {
                        // éšè—è¢«åˆå¹¶çš„å•å…ƒæ ¼
                        cell.classList.add('merged');
                    }
                }

                schedule.appendChild(cell);
            });
        });
    }

    // åˆ›å»ºè¡¨å¤´å•å…ƒæ ¼
    function createHeaderCell(content) {
        const cell = document.createElement('div');
        cell.className = 'cell header';
        cell.textContent = content;
        return cell;
    }

    // åˆ›å»ºç©ºç™½æ ¼å­
    // åˆ›å»ºç©ºç™½æ ¼å­
    function createEmptyCell() {
        const cell = document.createElement('div');
        cell.className = 'cell';
        // ä¿ç•™åŸæœ‰å³é”®æ’¤å›åŠŸèƒ½
        cell.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (cell.classList.contains('occupied')) {
                const projectName = cell.querySelector('.project').textContent; // è·å–é¡¹ç›®åç§°
                const tester = cell.dataset.tester;
                const date = cell.dataset.date;
                const projectData = scheduleData[tester][date];
                if (projectData) {
                    const startDate = projectData.startDate;
                    const days = projectData.days;
                    // æ¸…é™¤æ‰€æœ‰å ç”¨çš„æ ¼å­
                    for (let i = 0; i < days; i++) {
                        const currentDate = dates[dates.indexOf(startDate) + i];
                        delete scheduleData[tester][currentDate];
                    }
                    // ç§»å›æ± å­ï¼ˆä¿ç•™åŸå§‹å¤©æ•°å’Œé¢œè‰²ï¼‰
                    const project = document.createElement('div');
                    project.className = 'project';
                    project.draggable = true;
                    project.textContent = projectName; // åªä¿ç•™é¡¹ç›®åç§°
                    addDragAndDrop(project);
                    addDaysInput(project, days);
                    project.style.backgroundColor = projectData.color || '#f44336';
                    addColorSelector(project);
                    pool.appendChild(project);
                }
                renderSchedule();
            }
        });
        return cell;
    }
    // ä¸ºé¡¹ç›®æ·»åŠ å¤©æ•°è¾“å…¥æ¡†ï¼ˆä»…ç”¨äºé¡¹ç›®æ± ä¸­çš„é¡¹ç›®ï¼‰
    function addDaysInput(project, days = 1) {
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 1;
        input.value = days;
        input.className = 'days-input';
        project.appendChild(input);
    }

    // ä¿®æ”¹åçš„é¢œè‰²é€‰æ‹©å™¨å‡½æ•°
    function addColorSelector(project) {
        const colors = {
            red: '#f44336',
            yellow: '#ffeb3b',
            green: '#4caf50',
            gray: '#9e9e9e'
        };

        const picker = document.createElement('div');
        picker.className = 'color-selector';

        const btn = document.createElement('button');
        btn.className = 'color-picker-btn';
        btn.innerHTML = 'ğŸ¨';

        const options = document.createElement('div');
        options.className = 'color-options';

        for (const key in colors) {
            const colorBtn = document.createElement('button');
            colorBtn.className = 'color-option';
            colorBtn.style.backgroundColor = colors[key];
            colorBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                project.style.backgroundColor = colors[key];
                project.dataset.color = colors[key];

                const cell = project.parentElement;
                if (cell && cell.dataset.tester && cell.dataset.date) {
                    const tester = cell.dataset.tester;
                    const startDate = cell.dataset.date;
                    const projData = scheduleData[tester]?.[startDate];
                    if (projData) {
                        projData.color = colors[key];
                        const startIndex = dates.indexOf(startDate);
                        for (let i = 0; i < projData.days; i++) {
                            const d = dates[startIndex + i];
                            if (scheduleData[tester][d]) {
                                scheduleData[tester][d].color = colors[key];
                            }
                        }
                        cell.style.backgroundColor = colors[key];
                    }
                }
            });
            options.appendChild(colorBtn);
        }

        btn.appendChild(options);
        picker.appendChild(btn);
        project.appendChild(picker);

        // ä½¿ç”¨ mouseenter å’Œ mouseleave æ§åˆ¶é¢œè‰²é€‰æ‹©å™¨çš„æ˜¾ç¤º
        btn.addEventListener('mouseenter', () => {
            options.style.display = 'flex';
        });
        btn.addEventListener('mouseleave', () => {
            options.style.display = 'none';
        });

    }
    // ä¸ºé¡¹ç›®æ·»åŠ æ‹–æ‹½åŠŸèƒ½ï¼ˆé€‚ç”¨äºé¡¹ç›®æ± ä¸­çš„é¡¹ç›®ï¼‰
    function addDragAndDrop(element) {
        element.addEventListener('dragstart', (e) => {
            const element = e.target;

            // æå– div ä¸­çš„çº¯æ–‡æœ¬å†…å®¹ï¼Œå¿½ç•¥ button å’Œå…¶ä»–éæ–‡æœ¬èŠ‚ç‚¹
            let projectName = '';
            for (let node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE && node.nodeValue.trim() !== '') {
                    projectName += node.nodeValue.trim();
                }
            }

            // è®¾ç½®æ‹–æ‹½æ•°æ®
            e.dataTransfer.setData('text', projectName);
            // const projectName = element.textContent.trim(); // ç›´æ¥ä½¿ç”¨ textContent
            console.log("æ‹–æ‹½1",element)
            e.dataTransfer.setData('text', projectName);
            e.dataTransfer.setData('days', element.querySelector('.days-input').value);
            e.dataTransfer.setData('source', 'pool');
            e.dataTransfer.setData('color', element.dataset.color || '#f44336');
            element.classList.add('dragging');
        });
        element.addEventListener('dragend', () => {
            element.classList.remove('dragging');
        });
    }

    // ä¸ºæ’æœŸä¸­çš„é¡¹ç›®æ·»åŠ æ‹–æ‹½åŠŸèƒ½
    function addDragAndDropFromSchedule(element, tester, date, projectData) {
        element.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text', element.textContent);
            console.log("æ‹–æ‹½2",element)
            e.dataTransfer.setData('days', projectData.days);
            e.dataTransfer.setData('color', projectData.color || '#f44336');
            e.dataTransfer.setData('source', 'schedule');
            draggedProjectOriginal = { tester, startDate: date, project: projectData.project, days: projectData.days, color: projectData.color || '#f44336' };
            setTimeout(() => {
                const startIndex = dates.indexOf(date);
                for (let i = 0; i < projectData.days; i++) {
                    const d = dates[startIndex + i];
                    delete scheduleData[tester][d];
                }
                renderSchedule();
            }, 0);
        });
        element.addEventListener('dragend', () => {
            if (draggedProjectOriginal) {
                const { tester, startDate, project, days, color } = draggedProjectOriginal;
                const startIndex = dates.indexOf(startDate);
                for (let i = 0; i < days; i++) {
                    const d = dates[startIndex + i];
                    scheduleData[tester][d] = { project, days, startDate, color };
                }
                draggedProjectOriginal = null;
                renderSchedule();
            }
        });
    }

    // æ’æœŸç‰ˆæ‹–æ‹½æ”¾ç½®äº‹ä»¶ï¼ˆé€‚ç”¨äºæ¥è‡ªé¡¹ç›®æ± å’Œæ’æœŸä¸­çš„é¡¹ç›®ï¼‰
    schedule.addEventListener('dragover', (e) => {
        e.preventDefault();
        const cell = e.target.closest('.cell:not(.header):not(.occupied)');
        if (cell) cell.style.border = '2px dashed green';
    });

    schedule.addEventListener('dragleave', (e) => {
        const cell = e.target.closest('.cell');
        if (cell) cell.style.border = '1px solid #ccc';
    });

    schedule.addEventListener('drop', (e) => {
        e.preventDefault();
        const cell = e.target.closest('.cell:not(.header):not(.occupied)');
        if (!cell) return;

        const source = e.dataTransfer.getData('source');
        const projectName = e.dataTransfer.getData('text');
        console.log("æ‹–æ‹½3:",projectName)
        console.log("æ‹–æ‹½3çš„e:",e.dataTransfer)

        const days = parseInt(e.dataTransfer.getData('days'), 10);
        const color = e.dataTransfer.getData('color') || '#f44336';
        const tester = cell.dataset.tester;
        const startDateIndex = parseInt(cell.dataset.dateIndex, 10);

        // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„è¿ç»­ç©ºä½
        let hasEnoughSpace = true;
        if (startDateIndex + days > dates.length) {
            hasEnoughSpace = false;
        } else {
            for (let i = 0; i < days; i++) {
                const idx = startDateIndex + i;
                const targetCell = schedule.querySelector(`.cell[data-tester="${tester}"][data-date-index="${idx}"]`);
                if (targetCell && targetCell.classList.contains('occupied')) {
                    hasEnoughSpace = false;
                    break;
                }
            }
        }

        if (hasEnoughSpace) {
            const startDate = dates[startDateIndex];
            for (let i = 0; i < days; i++) {
                const d = dates[startDateIndex + i];
                scheduleData[tester][d] = { project: projectName, days, startDate, color };
            }
            if (source === 'pool') {
                const proj = Array.from(pool.children).find(p => p.textContent === projectName);
                if (proj) pool.removeChild(proj);
            }
            draggedProjectOriginal = null;
            renderSchedule();
        } else {
            alert('æ²¡æœ‰è¶³å¤Ÿçš„è¿ç»­ç©ºä½ï¼');
            if (source === 'schedule' && draggedProjectOriginal) {
                const { tester, startDate, project, days, color } = draggedProjectOriginal;
                const startIndex = dates.indexOf(startDate);
                for (let i = 0; i < days; i++) {
                    const d = dates[startIndex + i];
                    scheduleData[tester][d] = { project, days, startDate, color };
                }
                draggedProjectOriginal = null;
                renderSchedule();
            }
        }
        cell.style.border = '1px solid #ccc';
    });

    // äº‹ä»¶ç›‘å¬ï¼šæ–°å¢æµ‹è¯•äººå‘˜
    document.getElementById('addTester').addEventListener('click', () => {
        const name = `æµ‹è¯•äººå‘˜${testers.length + 1}`;
        testers.push(name);
        scheduleData[name] = {};
        dates.forEach(date => scheduleData[name][date] = null);
        renderSchedule();
    });

    // äº‹ä»¶ç›‘å¬ï¼šæ–°å¢é¡¹ç›®ï¼ˆåŠ å…¥é¡¹ç›®æ± ï¼‰
    document.getElementById('addProject').addEventListener('click', () => {
        const project = document.createElement('div');
        project.className = 'project';
        project.draggable = true;
        project.textContent = getNextProjectName();
        addDragAndDrop(project);
        addDaysInput(project);
        project.style.backgroundColor = '#f44336';
        project.dataset.color = '#f44336';
        addColorSelector(project);
        pool.appendChild(project);
    });

    // äº‹ä»¶ç›‘å¬ï¼šæ–°å¢æ’æœŸæ—¥æœŸ
    document.getElementById('addDay').addEventListener('click', () => {
        const date = `æ—¥æœŸ${dates.length + 1}`;
        dates.push(date);
        testers.forEach(tester => {
            if (!scheduleData[tester][date]) {
                scheduleData[tester][date] = null;
            }
        });
        renderSchedule();  // é‡æ–°æ¸²æŸ“æ’æœŸè¡¨
    });

</script>
</body>
</html>
