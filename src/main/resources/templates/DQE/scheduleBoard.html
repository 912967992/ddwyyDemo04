<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>项目池子展示</title>
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/scheduleBoard.css">

    <!-- 自定义 Alert 组件样式 -->
    <style>
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .custom-alert {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: alertSlideIn 0.3s ease-out;
        }

        @keyframes alertSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .custom-alert-message {
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
            color: #333;
            word-wrap: break-word;
        }

        .custom-alert-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .custom-alert-button:hover {
            background: #0056b3;
        }

        .custom-alert-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .custom-alert-close:hover {
            color: #333;
        }

        .custom-alert-timer {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #007bff;
            border-radius: 0 0 8px 8px;
            transition: width 0.1s linear;
        }
    </style>

</head>
<body>

<div class="pool-container">
    <div id="projectList" class="project-container">
        <h2>项目池子
            <!-- 新增项目按钮 -->
            <button id="addProjectBtn" style="margin-left: 10px;">新增项目</button>
            <!-- 假设管理节假日按钮代码如下，可根据实际情况修改 -->
            <button id="manageHolidaysBtn" class="nice-btn">管理节假日</button>
            <!-- 新增管理测试人员按钮 -->
            <button id="manageTesterBtn" class="nice-btn" onclick="showManageTestersModal()">管理测试人员</button>

            <!-- 新增搜索按钮 -->
            <button id="searchBtn" style="margin-left: 10px;">搜索查询</button>
            <!-- 新增变更记录搜索看板按钮 -->
            <button id="changeRecordSearchBtn" style="margin-left: 10px;">变更记录搜索看板</button>
            <button id="refreshColorBtn" style="margin-left: 10px;">刷新颜色</button>
            <!-- 新增垃圾站区域 -->
            <div id="trashStation">
                <h3>回收站(右键看作废列表)</h3>
                <div id="trashContent"></div>
            </div>


        </h2>
        <div id="projectPool">加载中...</div>
    </div>
    <div class="pending-sample-container">
        <h2>待送样池子</h2>
        <div class="pending-sample-columns">
            <!-- 左列 -->
            <div class="pending-sample-column">
                <div class="pending-sample-category">
                    <h3>视频类</h3>
                    <div id="videoSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>数据线类</h3>
                    <div id="wireSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>音视频线类</h3>
                    <div id="audioVideoWireSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>数据类</h3>
                    <div id="dataSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>蓝牙类</h3>
                    <div id="bluetoothSamplePool">加载中...</div>
                </div>
            </div>
            <!-- 右列 -->
            <div class="pending-sample-column">
                <div class="pending-sample-category">
                    <h3>键鼠类</h3>
                    <div id="keyboardMouseSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>耳机类</h3>
                    <div id="headphoneSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>定位器类</h3>
                    <div id="locatorSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>IPC类</h3>
                    <div id="ipcSamplePool">加载中...</div>
                </div>
                <div class="pending-sample-category">
                    <h3>高频类</h3>
                    <div id="highFrequencySamplePool">加载中...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 排期面板区域 -->
<div class="schedule-board-container">
    <div class="schedule-board-header">
        <h3>排期面板 <span style="font-size: 12px; color: #666; font-weight: normal;">(点击左侧测试人员姓名可高亮对应行)</span></h3>
        <div class="schedule-controls">
            <input type="date" id="startDate" class="date-picker">
            <span>至</span>
            <input type="date" id="endDate" class="date-picker">
            <button class="save-schedule-btn" onclick="refreshSchedule()">设置日期</button>
            <button class="save-schedule-btn" onclick="saveSchedule()">保存排期</button>
        </div>
    </div>
    <div id="scheduleBoard">请选择排期面板时间并点击设置日期按钮，才会展示面板</div>
</div>

<!-- 新增变更记录模态框 -->
<div id="changeLogModal">
    <div id="changeLogModalContent">
        <h3>变更记录</h3>
        <div id="changeLogBody"></div>
        <button id="closeChangeLogBtn">关闭</button>
    </div>
</div>

<!-- 模态框 -->
<div id="modal">
    <div id="modalContent">
        <!-- 新增变更记录按钮 -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>项目详情</h3>
            <div style="display: flex; gap: 10px;">
                <button id="changeLogBtn">变更记录</button>
                <button id="infoCloseBtn">关闭</button>
            </div>
        </div>

        <div id="modalBody"></div>

        <div style="margin-top: 10px;">
            <label for="scheduleDays"><strong>排期天数：</strong></label>
            <input type="number" id="scheduleDays" placeholder="请输入排期天数">
            <button id="saveScheduleBtn">确定排期</button>
        </div>


        <!-- 添加颜色选择功能 -->
        <div style="margin-top: 10px;">
            <label><strong>设置颜色：</strong></label>
            <div>
                <label>
                    <input type="radio" id="color_null" name="schedule_color" value="null" checked> 无
                </label>
                <label>
                    <input type="radio" id="color_gray" name="schedule_color" value="gray" checked> 灰色
                </label>
                <label>
                    <input type="radio" id="color_green" name="schedule_color" value="green"> 绿色
                </label>
                <label>
                    <input type="radio" id="color_yellow" name="schedule_color" value="yellow"> 黄色
                </label>
                <label>
                    <input type="radio" id="color_red" name="schedule_color" value="red"> 红色
                </label>
            </div>
            <button id="confirmColorBtn" style="margin-top: 5px;">确认修改颜色</button>
        </div>

        <!-- ✅ 修改为同一行显示送样备注、输入框和按钮 -->
        <div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
            <label for="sampleRemark"><strong>送样备注：</strong></label>
            <input type="text" id="sampleRemark" placeholder="请输入送样备注" style="flex: 1; padding: 4px;">
            <button id="saveRemarkBtn">保存备注</button>
        </div>

    </div>
</div>

<template id="changeLogTemplate">
    <p class="change-log-item">
        <strong>测试者：</strong> {{tester}}<br>
        <strong>排期开始：</strong> {{startDate}}<br>
        <strong>排期结束：</strong> {{endDate}}<br>
        <strong>更新时间：</strong> {{updateTime}}<br>
        <strong>颜色：</strong> <span style="color: {{color}};">{{color}}</span><br>
        <strong>是否使用：</strong> {{used}}<br>
        <strong>备注：</strong> {{remark}}<br>
    </p>
    <hr>
</template>

<!-- 新增项目模态框 -->
<div id="addProjectModal" style="display: none;">
    <div id="addProjectModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>新增项目</h3>
            <button id="closeAddProjectModalBtn">关闭</button>
        </div>
        <div id="addProjectModalBody">
            <p><strong>项目名称(<span class="required">*</span>)：</strong><input type="text" id="addSampleName" required></p>
            <p><strong>大小编码(<span class="required">*</span>)：</strong><input type="text" id="addSampleModel" required> <input type="text" id="addMaterialCode" required></p>
            <p><strong>项目负责人(<span class="required">*</span>)：</strong><input type="text" id="addSampleLeader" required></p>
            <p><strong>排期天数(<span class="required">*</span>)：</strong><input type="number" id="addScheduleDays" required></p>
            <p><strong>设置颜色(<span class="required">*</span>)：</strong></p>
            <label>
                <input type="radio" id="addColorNull" name="addScheduleColor" value="null" checked> 无
            </label>
            <label>
                <input type="radio" id="addColorGray" name="addScheduleColor" value="gray"> 灰色
            </label>
            <label>
                <input type="radio" id="addColorGreen" name="addScheduleColor" value="green"> 绿色
            </label>
            <label>
                <input type="radio" id="addColorYellow" name="addScheduleColor" value="yellow"> 黄色
            </label>
            <label>
                <input type="radio" id="addColorRed" name="addScheduleColor" value="red"> 红色
            </label>
            </p>
            <p><strong>放池子分类（选填）：</strong><input type="text" id="addWaitSampleClassify"></p>
            <p><strong>送样备注（选填）：</strong><input type="text" id="addSampleRemark"></p>
        </div>
        <button id="saveNewProjectBtn">保存项目</button>
    </div>
</div>


<div id="contextMenu" class="context-menu">
    <!-- <div onclick="handleContextMenuClick()">撤回排期</div> -->
    <div onclick="showProjectAttributes(event)">查看属性</div>
</div>

<!-- 返回按钮 -->
<div class="header-container">
    <button class="BackBtn" id="BackBtn" onclick="location.href='/DQEIndex'">返回<br>主页</button>
</div>

<!-- 作废项目列表模态框 -->
<div id="trashListModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1000;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>作废项目列表</h3>
        <button id="trashListCloseBtn" onclick="document.getElementById('trashListModal').style.display='none'">关闭</button>
    </div>
    <ul id="trashProjectList" style="list-style:none; padding:0;"></ul>
</div>


<!-- 详情内容模态框 -->
<div id="projectDetailModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1001;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>项目详细信息</h3>
        <button id="closeTransBtn" onclick="document.getElementById('projectDetailModal').style.display='none'">关闭</button>
    </div>

    <p><strong>电气编号：</strong><span id="detail_sample_id"></span></p>
    <p><strong>项目名称：</strong><span id="detail_sample_name"></span></p>
    <p><strong>大小编码：</strong><span id="detail_sizecoding"></span></p>
    <p><strong>项目负责人：</strong><span id="detail_sample_leader"></span></p>
    <p><strong>排期天数：</strong><span id="detail_scheduleDays"></span></p>
    <p><strong>颜色：</strong><span id="detail_schedule_color"></span></p>
    <p><strong>放池子分类：</strong><span id="detail_waitSample_classify"></span></p>
    <p><strong>送样备注：</strong><span id="detail_remark"></span></p>
    <p><strong>作废人：</strong><span id="detail_cancel_by"></span></p>
    <p><strong>作废工号：</strong><span id="detail_job_number"></span></p>
    <p><strong>作废时间：</strong><span id="detail_cancel_date"></span></p>
    <p><strong>作废理由：</strong><span id="detail_cancel_reason"></span></p>

    <button id="recoverBtn" onclick="recoverProject()">恢复</button>
</div>


<!-- 节假日管理模态框 -->
<!-- 节假日管理模态框背景层 -->
<div id="holidayModalBackground" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;">
    <!-- 节假日管理模态框 -->
    <div id="holidayModal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>管理节假日</h3>
            <button id="closeHolidayModalBtn">关闭</button>
        </div>
        <div id="holidayList">
            <!-- 节假日列表将通过 JavaScript 动态生成 -->
        </div>
        <div>
            <label for="newHolidayDate">日期：</label>
            <input type="date" id="newHolidayDate">
            <label for="newHolidayName">名称：</label>
            <input type="text" id="newHolidayName">
            <button id="addHolidayBtn">添加</button>
        </div>
    </div>
</div>


<!-- 管理测试人员模态框遮罩层 -->
<div id="manageTestersOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
<!-- 管理测试人员模态框 -->
<div id="manageTestersModal" style="display: none;">
    <div id="manageTestersModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000; max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="tester-management">
                <h3>管理测试人员</h3>
                <button id="addNewTesterBtn">新增测试人员</button>
                <button id="manageGroupBtn">管理展示的组</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="saveTesterChangesBtn">保存</button>
                <button id="closeManageTestersModalBtn">关闭</button>
            </div>
        </div>
        <div id="manageTestersModalBody">
            <table id="testersTable" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; width: 100%; margin-bottom: 10px;">
                <thead>
                <tr>
                    <th>工程师ID</th>
                    <th>工程师名字</th>
                    <th>入职日期</th>
                    <th>负责的品类</th>
                    <th>技能描述</th>
                    <th>技能提升记录</th>
                    <th>当前技能等级</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="testersTableBody">
                <!-- 测试人员数据将动态填充 -->
                </tbody>
            </table>
            <!-- ... 新增测试人员部分保持不变 ... -->
        </div>
    </div>
</div>


<!-- 新增测试人员模态框 -->
<div id="addTesterModal" style="display: none;">
    <div id="addTesterModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>新增测试人员</h3>
            <button id="closeAddTesterModalBtn">关闭</button>
        </div>
        <div id="addTesterModalBody">
            <p><strong>测试人员姓名(<span class="required">*</span>)：</strong><input type="text" id="addTesterName" required></p>
            <p><strong>负责组别(<span class="required">*</span>)：</strong><input type="text" id="addTesterGroup" required></p>
            <p><strong>技能描述：</strong><input type="text" id="addTesterSkillDesc"></p>
            <p><strong>技能提升：</strong><input type="text" id="addTesterSkillImprove"></p>
            <p><strong>当前技能等级：</strong><input type="text" id="addTesterSkillLevel"></p>
        </div>
        <button id="saveNewTesterBtn">保存测试人员</button>
    </div>
</div>

<!-- 管理展示的组模态框 -->
<div id="manageGroupModal" style="display: none;">
    <div id="manageGroupModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>管理展示的组</h3>
            <button id="closeManageGroupModalBtn">关闭</button>
        </div>
        <table id="groupTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>组别</th>
                <th>是否展示</th>
                <th>显示顺序值</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <!-- 这里将动态添加组信息 -->
            </tbody>
        </table>

        <button id="saveGroupSettingsBtn">保存组别设置</button>

        <!-- 新增组输入区域 -->
        <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="newGroupName" placeholder="组别名称" style="width: 150px;">
            <select id="newGroupDisplay" style="width: 100px;">
                <option value="true">展示</option>
                <option value="false">不展示</option>
            </select>
            <input type="number" id="newGroupOrder" placeholder="展示权重" style="width: 100px;">
            <button id="addGroupBtn">新增组</button>
        </div>
    </div>
</div>

<!-- 遮罩层 -->
<div id="searchModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 999;"></div>
<!-- 新增搜索模态框 -->
<div id="searchModal" style="display: none;">
    <div id="searchModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>搜索项目</h3>
            <button id="closeSearchModalBtn" class="modal-button">关闭</button>
        </div>
        <!-- 修改 searchModalBody 的样式 -->
        <div id="searchModalBody" style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
            <div>
                <strong>电气编号：</strong><input type="text" id="searchSampleId">
            </div>
            <div>
                <strong>大编码：</strong><input type="text" id="searchSampleModel">
            </div>
            <div>
                <strong>测试人：</strong><input type="text" id="searchTester">
            </div>
            <button id="executeSearchBtn" class="modal-button">搜索</button>
        </div>
        <div id="searchResults"></div>
    </div>
</div>

<!-- 变更记录搜索看板模态框 -->
<div id="changeRecordSearchModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1001;">
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; width: 90%; max-width: 1400px; height: 90%; max-height: 800px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 24px;">🔍 变更记录搜索看板</h2>
            <button id="closeChangeRecordSearchModal" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 16px;">✕ 关闭</button>
        </div>
        
        <div style="padding: 20px; height: calc(100% - 80px); overflow-y: auto;">
            <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                <form id="changeRecordSearchForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: end;">
                    <!-- 第一行：基本信息 -->
                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">🔌 电气编号</label>
                        <input type="text" id="changeRecordETTestCode" placeholder="输入电气编号" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">📋 大编码</label>
                        <input type="text" id="changeRecordModel" placeholder="输入大编码" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">🏷️ 产品类别</label>
                        <input type="text" id="changeRecordCategory" placeholder="输入产品类别" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">👤 项目负责人</label>
                        <input type="text" id="changeRecordLeader" placeholder="输入项目负责人" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">📦 送样人</label>
                        <input type="text" id="changeRecordSender" placeholder="输入送样人" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <!-- 第二行：测试相关信息 -->
                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">🧪 测试人</label>
                        <input type="text" id="changeRecordTester" placeholder="输入测试人姓名" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">📅 排期开始日期</label>
                        <input type="date" id="changeRecordStartDate" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">📅 排期结束日期</label>
                        <input type="date" id="changeRecordEndDate" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">✅ 排期状态</label>
                        <select id="changeRecordIsUsed" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                            <option value="">全部状态</option>
                            <option value="1">已排期</option>
                            <option value="0">未排期</option>
                        </select>
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">🗑️ 是否作废</label>
                        <select id="changeRecordIsCancel" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                            <option value="">全部</option>
                            <option value="0">正常</option>
                            <option value="1">已作废</option>
                        </select>
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">📊 当前进度</label>
                        <select id="changeRecordSchedule" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                            <option value="">全部进度</option>
                            <option value="0">待测试</option>
                            <option value="1">待DQE和研发审核</option>
                            <option value="2">测试完成</option>
                        </select>
                    </div>

                    <!-- 第三行：备注和变更记录 -->
                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">📝 送样备注</label>
                        <input type="text" id="changeRecordRemark" placeholder="输入送样备注" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">🕒 变更记录开始日期</label>
                        <input type="date" id="changeRecordStartDate2" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">🕒 变更记录结束日期</label>
                        <input type="date" id="changeRecordEndDate2" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <label style="font-weight: 600; margin-bottom: 5px; color: #555;">📝 变更记录备注</label>
                        <input type="text" id="changeRecordRemark2" placeholder="输入变更记录备注" style="padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                    </div>

                    <!-- 操作按钮 -->
                    <div style="display: flex; flex-direction: column;">
                        <button type="submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">🔍 搜索</button>
                    </div>

                    <div style="display: flex; flex-direction: column;">
                        <button type="button" onclick="clearChangeRecordForm()" style="background: #6c757d; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);">🗑️ 清空</button>
                    </div>
                </form>
            </div>

            <div id="changeRecordResultsPanel" style="background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); overflow: hidden; display: none;">
                <div style="background: #f8f9fa; padding: 15px 25px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                    <div id="changeRecordResultsCount" style="font-weight: 600; color: #495057;">搜索结果：0 条记录</div>
                    <button onclick="exportChangeRecordResults()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">📊 导出结果</button>
                </div>

                <div id="changeRecordResultsContent" style="overflow-x: auto;">
                    <table id="changeRecordResultsTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">🔢 ID序号</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">🔌 电气编号</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">🏷️ 大编码</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">👤 项目负责人</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">📦 送样人</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">🧪 测试人</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">📅 排期开始日期</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">📅 排期结束日期</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">📊 排期天数</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">🎨 颜色</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">🕒 更新时间</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">✅ 是否使用</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">🗑️ 是否作废</th>
                                <th style="background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6;">📝 备注</th>
                            </tr>
                        </thead>
                        <tbody id="changeRecordResultsTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="changeRecordPagination" style="display: none; justify-content: center; align-items: center; padding: 20px; gap: 10px;">
                    <button onclick="previousChangeRecordPage()" id="changeRecordPrevBtn" style="padding: 8px 12px; border: 1px solid #dee2e6; background: white; cursor: pointer; border-radius: 4px;">上一页</button>
                    <span id="changeRecordPageInfo" style="margin: 0 10px;">第 1 页，共 1 页</span>
                    <button onclick="nextChangeRecordPage()" id="changeRecordNextBtn" style="padding: 8px 12px; border: 1px solid #dee2e6; background: white; cursor: pointer; border-radius: 4px;">下一页</button>
                </div>
            </div>
        </div>
    </div>
</div>






<script>
    function getParams() {
        let query = window.location.search;
        return new URLSearchParams(query);
    }

    const urlParams = getParams();
    let username = urlParams.get('username');
    let job = urlParams.get('job');

    // 只有当参数存在时才存储到localStorage
    if (username !== null) {
        localStorage.setItem("username", username);
    }else{
        username = sessionStorage.getItem('username');
    }
    if (job !== null) {
        localStorage.setItem("job", job);
    }else{
        job = sessionStorage.getItem('job');
    }


    // const username = "卢健";

    let localScheduleChanges = [];
    const contextMenu = document.getElementById('contextMenu');
    let currentRightClickCell = null;
    let currentRightClickProject = null;

    // 定义全局变量 holidays 用于存储节假日数据
    let holidays = [];

    // 存储待保存的修改
    let pendingChanges = [];

    // ⭐⭐ 新增：组别顺序数组
    let groupOrder = []; // 按你的需求改顺序

    function loadGroupOrder() {
        fetch('/scheduleBoardController/getGroupOrder')
            .then(response => {
                if (!response.ok) throw new Error('网络错误');
                return response.json();
            })
            .then(data => {
                if (Array.isArray(data)) {
                    groupOrder = data;
                    console.log("groupOrder",groupOrder)

                    // 这里你可以调用渲染表格等函数，使用 groupOrder
                    // renderGroupTable(groupOrder);
                } else {
                    console.warn('接口返回数据格式不正确', data);
                }
            })
            .catch(error => {
                console.error('获取组别顺序失败:', error);
            });
    }

    //默认让endDate+14天，进入页面的时候
    document.addEventListener('DOMContentLoaded', function () {
        // 获取当前 UTC 时间
        const now = new Date();

        // 北京时间偏移（UTC+8）
        const beijingOffset = 8 * 60 * 60 * 1000;
        const beijingTime = new Date(now.getTime() + beijingOffset);

        // 开始日期：7天前
        const startTime = new Date(beijingTime.getTime() - 7 * 24 * 60 * 60 * 1000);
        const startYear = startTime.getUTCFullYear();
        const startMonth = String(startTime.getUTCMonth() + 1).padStart(2, '0');
        const startDay = String(startTime.getUTCDate()).padStart(2, '0');
        const startDate = `${startYear}-${startMonth}-${startDay}`;

        // 结束日期：7天后
        const endTime = new Date(beijingTime.getTime() + 7 * 24 * 60 * 60 * 1000);
        const endYear = endTime.getUTCFullYear();
        const endMonth = String(endTime.getUTCMonth() + 1).padStart(2, '0');
        const endDay = String(endTime.getUTCDate()).padStart(2, '0');
        const endDate = `${endYear}-${endMonth}-${endDay}`;

        // 设置 input 的默认值
        document.getElementById('startDate').value = startDate;
        document.getElementById('endDate').value = endDate;
    });



    // 全局变量用于跟踪拖拽状态
    let isDragging = false;
    let draggedElement = null;
    let dragData = {};
    let dragPreview = null;
    
    // 全局变量用于跟踪高亮状态
    let currentHighlightedTester = null;

    // 设置拖拽
    function setDraggable(projectEl, isProject) {
        // 双击开始拖拽
        projectEl.addEventListener('dblclick', e => {
            e.preventDefault();
            e.stopPropagation();

            // 收集拖拽数据
            dragData = {
                'project-sizecoding': `${projectEl.getAttribute('data-sample_model')} ${formatRemark(projectEl.getAttribute('data-materialCode'))} ${projectEl.getAttribute('data-sample_leader').charAt(0)} ${formatRemark(projectEl.getAttribute('data-remark'))}`,
                'project-days': projectEl.getAttribute('data-schedule_days'),
                'project-sample_id': projectEl.getAttribute('data-sample_id'),
                'project-sample_name': projectEl.getAttribute('data-sample_name'),
                'project-sample_model': projectEl.getAttribute('data-sample_model'),
                'project-materialCode': projectEl.getAttribute('data-materialCode'),
                'project-sample_category': projectEl.getAttribute('data-sample_category'),
                'project-version': projectEl.getAttribute('data-version'),
                'project-priority': projectEl.getAttribute('data-priority'),
                'project-sample_leader': projectEl.getAttribute('data-sample_leader'),
                'project-supplier': projectEl.getAttribute('data-supplier'),
                'project-test_project_category': projectEl.getAttribute('data-test_project_category'),
                'project-test_projects': projectEl.getAttribute('data-test_projects'),
                'project-schedule': projectEl.getAttribute('data-schedule'),
                'project-create_time': projectEl.getAttribute('data-create_time'),
                'project-schedule_days': projectEl.getAttribute('data-schedule_days') ?? '1',
                'project-schedule_color': projectEl.getAttribute('data-schedule_color'),
                'project-remark': projectEl.getAttribute('data-remark'),
                'project-sample_sender': projectEl.getAttribute('data-sample_sender'),
                'project-sample_type': projectEl.getAttribute('data-sample_type'),
                'project-sample_quantity': projectEl.getAttribute('data-sample_quantity'),
                'project-high_frequency': projectEl.getAttribute('data-high_frequency')
            };

            draggedElement = projectEl;
            isDragging = true;

            // 创建拖拽预览元素
            createDragPreview(projectEl);

            // 添加全局鼠标事件监听器
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('click', handleMouseClick);

            // 阻止默认的拖拽行为
            projectEl.setAttribute('draggable', 'false');
        });
        if(isProject){

        }else{
            projectEl.addEventListener('contextmenu', e => {
                e.preventDefault();
                currentRightClickProject = projectEl;
                // 原代码中 projectMenu 未定义，这里注释掉
                // projectMenu.style.top = e.pageY + 'px';
                // projectMenu.style.left = e.pageX + 'px';
                // projectMenu.style.display = 'block';
            });
        }
    }

    // 创建拖拽预览元素
    function createDragPreview(originalElement) {
        dragPreview = originalElement.cloneNode(true);
        dragPreview.style.position = 'fixed';
        dragPreview.style.zIndex = '10000';
        dragPreview.style.opacity = '0.8';
        dragPreview.style.pointerEvents = 'none';
        dragPreview.style.transform = 'rotate(5deg)';
        dragPreview.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
        document.body.appendChild(dragPreview);
    }

    // 处理鼠标移动
    function handleMouseMove(e) {
        if (!isDragging || !dragPreview) return;

        dragPreview.style.left = (e.clientX - dragPreview.offsetWidth / 2) + 'px';
        dragPreview.style.top = (e.clientY - dragPreview.offsetHeight / 2) + 'px';

        // 获取排期表格容器
        const scheduleContainer = document.querySelector('.schedule-table-container');
        const mainTableContainer = document.querySelector('.main-table-container');
        if (!scheduleContainer || !mainTableContainer) return;

        // 自动滚动逻辑 - 垂直和水平方向
        const scrollSpeed = 10; // 滚动速度
        const triggerDistance = 50; // 触发滚动的距离
        const containerRect = scheduleContainer.getBoundingClientRect();
        const { clientX, clientY } = e;

        // 调试信息 - 每10次移动输出一次
        if (!window.debugCounter) window.debugCounter = 0;
        window.debugCounter++;
        // if (window.debugCounter % 10 === 0) {
        //     console.log('鼠标位置:', clientX, clientY, '容器位置:', containerRect);
        //     console.log('右侧触发条件:', clientX, '>', containerRect.right - triggerDistance, '=', clientX > containerRect.right - triggerDistance);
        //     console.log('顶部触发条件:', clientY, '<', containerRect.top + triggerDistance, '=', clientY < containerRect.top + triggerDistance);
        //     console.log('底部触发条件:', clientY, '>', containerRect.bottom - triggerDistance, '=', clientY > containerRect.bottom - triggerDistance);
        //     console.log('容器滚动位置:', scheduleContainer.scrollTop, scheduleContainer.scrollLeft);
        // }

        // 垂直方向自动滚动
        // 靠近容器顶部，向上滚动
        if (clientY < containerRect.top + triggerDistance) {
            scheduleContainer.scrollTop -= scrollSpeed;
            // console.log('向上滚动', clientY, containerRect.top + triggerDistance);
        }
        // 靠近容器底部，向下滚动
        else if (clientY > containerRect.bottom - triggerDistance) {
            scheduleContainer.scrollTop += scrollSpeed;
            // console.log('向下滚动', clientY, containerRect.bottom - triggerDistance);
        }
        
        // 同时支持window滚动（当鼠标在容器外时）
        // 靠近页面顶部，向上滚动window
        if (clientY < triggerDistance) {
            window.scrollBy(0, -scrollSpeed);
            // console.log('window向上滚动', clientY, triggerDistance);
        }
        // 靠近页面底部，向下滚动window
        else if (clientY > window.innerHeight - triggerDistance) {
            window.scrollBy(0, scrollSpeed);
            // console.log('window向下滚动', clientY, window.innerHeight - triggerDistance);
        }

        // 水平方向自动滚动 - 使用主表格容器
        // 靠近容器左侧，向左滚动
        if (clientX < containerRect.left + triggerDistance) {
            mainTableContainer.scrollLeft -= scrollSpeed;
            // console.log('向左滚动', clientX, containerRect.left + triggerDistance);
        }
        // 靠近容器右侧，向右滚动
        else if (clientX > containerRect.right - triggerDistance) {
            mainTableContainer.scrollLeft += scrollSpeed;
            // console.log('向右滚动', clientX, containerRect.right - triggerDistance);
        }
    }

    // 处理鼠标点击（放下）
    function handleMouseClick(e) {
        if (!isDragging) return;

        e.preventDefault();
        e.stopPropagation();

        // 查找目标元素
        const targetElement = document.elementFromPoint(e.clientX, e.clientY);
        let targetCell = null;
        let targetPool = null;
        let targetTrash = null;

        // 池子ID列表
        const poolIds = [
            'projectPool',
            'videoSamplePool',
            'wireSamplePool',
            'audioVideoWireSamplePool',
            'dataSamplePool',
            'bluetoothSamplePool',
            'highFrequencySamplePool',
            'keyboardMouseSamplePool',
            'headphoneSamplePool',
            'locatorSamplePool',
            'ipcSamplePool'
        ];

        // 查找最近的 .drop-cell 元素
        if (targetElement) {
            targetCell = targetElement.closest('.drop-cell');

            // 查找是否点击到池子容器
            for (const id of poolIds) {
                const poolDom = document.getElementById(id);
                if (poolDom && (targetElement === poolDom || poolDom.contains(targetElement))) {
                    targetPool = poolDom;
                    break;
                }
            }

            // 查找是否点击到回收站
            const trashStation = document.getElementById('trashStation');
            if (trashStation && (targetElement === trashStation || trashStation.contains(targetElement))) {
                targetTrash = trashStation;
            }
        }

        if (targetCell) {
            // 模拟拖拽放下事件（排期面板）
            const dropEvent = new Event('drop', { bubbles: true });
            dropEvent.dataTransfer = {
                getData: function(key) {
                    return dragData[key] || '';
                }
            };
            targetCell.dispatchEvent(dropEvent);
        } else if (targetPool) {
            // 放回池子
            restoreToPool(targetPool, dragData);
        } else if (targetTrash) {
            // 放入回收站
            const mockDataTransfer = {
                getData: function(key) {
                    if (key === 'project-from_container') {
                        // 查找项目来源的池子
                        const poolIds = [
                            'projectPool',
                            'videoSamplePool',
                            'wireSamplePool',
                            'audioVideoWireSamplePool',
                            'dataSamplePool',
                            'bluetoothSamplePool',
                            'highFrequencySamplePool',
                            'keyboardMouseSamplePool',
                            'headphoneSamplePool',
                            'locatorSamplePool',
                            'ipcSamplePool'
                        ];
                        for (const poolId of poolIds) {
                            const pool = document.getElementById(poolId);
                            if (pool && pool.contains(draggedElement)) {
                                return poolId;
                            }
                        }
                        return '';
                    }
                    return dragData[key] || '';
                }
            };
            handleTrashDrop(mockDataTransfer);
        }
        // 清理拖拽状态
        cleanupDrag();
    }

    // 还原到池子
    function restoreToPool(poolDom, dragData) {
        const sample_id = dragData['project-sample_id'];

        // 先清除所有池子中相同 sample_id 的卡片
        const poolIds = [
            'projectPool',
            'videoSamplePool',
            'wireSamplePool',
            'audioVideoWireSamplePool',
            'dataSamplePool',
            'bluetoothSamplePool',
            'highFrequencySamplePool',
            'keyboardMouseSamplePool',
            'headphoneSamplePool',
            'locatorSamplePool',
            'ipcSamplePool'
        ];

        poolIds.forEach(poolId => {
            const pool = document.getElementById(poolId);
            if (pool) {
                const existingCard = pool.querySelector(`[data-sample_id="${sample_id}"]`);
                if (existingCard) {
                    existingCard.remove();
                }
            }
        });

        // 生成卡片
        const card = document.createElement('div');
        card.className = 'project-card';
        const scheduleColor = dragData['project-schedule_color'] || 'null';
        card.classList.add(scheduleColor);
        card.textContent = `${dragData['project-sample_model'] || ''} ${dragData['project-materialCode'] || ''} ${(dragData['project-sample_leader']||'').charAt(0)} ${dragData['project-remark'] || ''} (${dragData['project-schedule_days'] || '1'}天)`;
        // 设置属性
        Object.keys(dragData).forEach(key => {
            if (key.startsWith('project-')) {
                card.setAttribute('data-' + key.replace('project-', ''), dragData[key]);
            }
        });
        
        // 确保这四个重要属性被正确设置
        card.setAttribute('data-sample_sender', dragData['project-sample_sender'] || '');
        card.setAttribute('data-sample_type', dragData['project-sample_type'] || '');
        card.setAttribute('data-sample_quantity', dragData['project-sample_quantity'] || '');
        card.setAttribute('data-high_frequency', dragData['project-high_frequency'] || '');
        card.setAttribute('draggable', 'false');
        setDraggable(card, true);
        
        // 创建项目数据对象用于右键菜单
        const itemData = {
            sample_id: dragData['project-sample_id'],
            sample_name: dragData['project-sample_name'],
            sample_model: dragData['project-sample_model'],
            materialCode: dragData['project-materialCode'],
            sample_category: dragData['project-sample_category'],
            version: dragData['project-version'],
            priority: dragData['project-priority'],
            sample_leader: dragData['project-sample_leader'],
            supplier: dragData['project-supplier'],
            testProjectCategory: dragData['project-test_project_category'],
            testProjects: dragData['project-test_projects'],
            schedule: dragData['project-schedule'],
            create_time: dragData['project-create_time'],
            scheduleDays: dragData['project-schedule_days'],
            schedule_color: dragData['project-schedule_color'],
            remark: dragData['project-remark'],
            sample_sender: dragData['project-sample_sender'],
            sample_type: dragData['project-sample_type'],
            sample_quantity: dragData['project-sample_quantity'],
            high_frequency: dragData['project-high_frequency']
        };
        
        // 绑定右键菜单
        bindCardContextMenu(card, itemData);
        
        poolDom.appendChild(card);

        // 清理排期面板原单元格（如果有）
        if (draggedElement && draggedElement.classList.contains('assigned')) {
            // 获取原单元格的行和列信息
            const originalRowCells = Array.from(draggedElement.parentElement.querySelectorAll('.drop-cell'));
            const originalStartIndex = originalRowCells.indexOf(draggedElement);
            const originalScheduleDays = Math.ceil(parseFloat(draggedElement.getAttribute('data-schedule_days')) || 1);

            // 检查是否存在 dataX- 开头的属性
            let hasDataXAttr = false;
            let maxDataIndex = 0;
            [...draggedElement.attributes].forEach(attr => {
                if (attr.name.match(/^data\d+-/)) {
                    hasDataXAttr = true;
                    const match = attr.name.match(/^data(\d+)-/);
                    if (match) {
                        const index = parseInt(match[1]);
                        if (index > maxDataIndex) {
                            maxDataIndex = index;
                        }
                    }
                }
            });

            // 先保存原单元格的 innerText（如果有 dataX- 属性）
            let originalInnerText = "";
            if (hasDataXAttr) {
                const text = draggedElement.innerText;
                const parts = text.split('|');
                // 确保分割后有后半部分内容
                if (parts.length > 1) {
                    // 从第二个元素开始，使用 join 方法处理可能有多个 | 的情况
                    originalInnerText = parts.slice(1).join('天)|').trim();
                } else {
                    originalInnerText = text.trim();
                }
            }

            // 清除原单元格内容和属性
            draggedElement.innerText = '';
            draggedElement.removeAttribute('colspan');
            // draggedElement.classList.remove('assigned');
            draggedElement.style.backgroundColor = '';
            
            // 允许保留的属性，添加判断 dataX- 开头的属性
            const allowed = ['class', 'data-tester', 'data-date', 'data-job_number'];

            [...draggedElement.attributes].forEach(attr => {
                const name = attr.name;

                // 处理形如 dataX- 的属性（X为数字）
                const match = name.match(/^data(\d+)-(.+)$/);
                if (match) {
                    const index = parseInt(match[1], 10);
                    const key = match[2];

                    let newName;
                    if (index === 1) {
                        newName = `data-${key}`; // X=1 时 → data-key
                    } else if (index > 1) {
                        newName = `data${index - 1}-${key}`; // X>1 时 → data(X-1)-key
                    }

                    if (newName && !allowed.includes(newName)) {
                        if (attr.value !== null && attr.value !== 'null') {
                            draggedElement.setAttribute(newName, attr.value);
                        }
                    }

                    // 无论如何都删除原始属性
                    draggedElement.removeAttribute(name);

                } else if (!allowed.includes(name)) {
                    // 普通非受保护属性，删除
                    draggedElement.removeAttribute(name);
                }
            });


            // 恢复原单元格的 innerText（如果有 dataX- 属性）
            if (hasDataXAttr) {
                draggedElement.innerText = originalInnerText;
                
                // 如果有 dataX- 的值，那肯定要继续设置 colspan 的值为 data-schedule_days 的值
                const scheduleDays = draggedElement.getAttribute('data-schedule_days');
                if (scheduleDays && scheduleDays !== 'null') {
                    draggedElement.setAttribute('colspan', Math.ceil(parseFloat(scheduleDays)));
                }
                
                // 重新设置可拖拽属性
                draggedElement.setAttribute('draggable', 'false'); // 禁用默认拖拽，使用双击拖拽
                
                // 绑定双击拖拽事件
                draggedElement.addEventListener('dblclick', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // 收集拖拽数据
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                        'sample_sender', 'sample_type', 'sample_quantity', 'high_frequency'
                    ];
                    attributes.forEach(attr => {
                        taskData[`project-${attr}`] = this.getAttribute(`data-${attr}`);
                    });

                    dragData = taskData;
                    draggedElement = this;
                    isDragging = true;

                    // 创建拖拽预览元素
                    createDragPreview(this);

                    // 添加全局鼠标事件监听器
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('click', handleMouseClick);
                });

                // 绑定右键菜单事件
                draggedElement.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    if (draggedElement.innerText.trim() === '') return;
                    currentRightClickCell = draggedElement;
                    const contextMenu = document.getElementById('contextMenu');
                    contextMenu.style.top = e.pageY + 'px';
                    contextMenu.style.left = e.pageX + 'px';
                    contextMenu.style.display = 'block';
                });
            }
            
            // 获取颜色值并渲染单元格颜色
            const scheduleColor = draggedElement.getAttribute('data-schedule_color');
            if (scheduleColor && scheduleColor !== 'null') {
                draggedElement.style.backgroundColor = scheduleColor;
                // 设置CSS变量，供CSS规则使用
                draggedElement.style.setProperty('--project-color', scheduleColor);
                // 如果是周末单元格，强制设置颜色优先级
                if (draggedElement.classList.contains('weekend-border')) {
                    draggedElement.style.setProperty('background-color', scheduleColor, 'important');
                }
            }

            if(!hasDataXAttr){
                // 恢复被隐藏的格子
                for (let i = originalStartIndex; i < originalStartIndex + originalScheduleDays; i++) {
                    if (originalRowCells[i]) {
                        originalRowCells[i].style.display = '';
                        // 恢复周末样式
                        const date = originalRowCells[i].getAttribute('data-date');
                        setWeekendBorder(originalRowCells[i], date);
                    }
                }
            }


            // 记录删除操作到 localScheduleChanges
            const sample_id = dragData['project-sample_id'];
            const schedule_days = dragData['project-schedule_days'] || '1';
            const schedule_color = dragData['project-schedule_color'];
            const tester = draggedElement.getAttribute('data-tester');
            const job_number = draggedElement.getAttribute('data-job_number');
            const start_date = draggedElement.getAttribute('data-date');

            // 计算结束日期
            const startDateObj = new Date(start_date);
            startDateObj.setDate(startDateObj.getDate() + Math.ceil(parseFloat(schedule_days)) - 1);
            const end_date = startDateObj.toISOString().split('T')[0];

            const newChange = {
                change: "delete",
                sample_id: sample_id,
                tester: tester,
                start_date: start_date,
                end_date: end_date,
                scheduleDays: schedule_days,
                schedule_color: schedule_color,
                job_number: job_number,
                container: poolDom.id
            };

            // 查找并更新已有记录（如果存在），否则添加
            const existingIndex = localScheduleChanges.findIndex(item =>
                item.sample_id === sample_id
            );
            if (existingIndex !== -1) {
                localScheduleChanges[existingIndex] = newChange;
            } else {
                localScheduleChanges.push(newChange);
            }

            console.log("项目已还原到池子，变更已记录:", localScheduleChanges);
        } else if (draggedElement && draggedElement.classList.contains('project-card')) {
            // 处理池子间卡片移动的变更记录
            const sample_id = dragData['project-sample_id'];
            const schedule_days = dragData['project-schedule_days'] || '1';
            const schedule_color = dragData['project-schedule_color'];

            // 查找原池子ID
            let originalPoolId = '';
            const poolIds = [
                'projectPool',
                'videoSamplePool',
                'wireSamplePool',
                'audioVideoWireSamplePool',
                'dataSamplePool',
                'bluetoothSamplePool',
                'highFrequencySamplePool',
                'keyboardMouseSamplePool',
                'headphoneSamplePool',
                'locatorSamplePool',
                'ipcSamplePool'
            ];

            for (const poolId of poolIds) {
                const pool = document.getElementById(poolId);
                if (pool && pool.contains(draggedElement)) {
                    originalPoolId = poolId;
                    break;
                }
            }

            const newChange = {
                change: "delete",
                sample_id: sample_id,
                tester: "",
                start_date: "",
                end_date: "",
                scheduleDays: schedule_days,
                schedule_color: schedule_color,
                job_number: "",
                container: poolDom.id
            };

            // 查找并更新已有记录（如果存在），否则添加
            const existingIndex = localScheduleChanges.findIndex(item =>
                item.sample_id === sample_id
            );
            if (existingIndex !== -1) {
                localScheduleChanges[existingIndex] = newChange;
            } else {
                localScheduleChanges.push(newChange);
            }

            console.log("池子间卡片移动，变更已记录:", newChange);
        }
    }

    // 清理拖拽状态
    function cleanupDrag() {
        isDragging = false;
        draggedElement = null;
        dragData = {};

        if (dragPreview) {
            document.body.removeChild(dragPreview);
            dragPreview = null;
        }

        // 移除全局事件监听器
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('click', handleMouseClick);
    }
    document.addEventListener('click', e => {
        if (!e.target.classList.contains('context-menu')) {
            contextMenu.style.display = 'none';
            // projectMenu.style.display = 'none';
        }
    });

    function loadProjectPoolData() {
        fetch('/passback/getReceivedData')
            .then(response => response.json())
            .then(data => {
                renderProjectPool(data);
            })
            .catch(error => {
                document.getElementById('projectPool').innerHTML = '加载失败，请稍后重试。';
                console.error('Error fetching project data:', error);
            });
    }

    function renderProjectPool(data) {
        const container = document.getElementById('projectPool');
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = '暂无项目数据。';
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');

            card.className = 'project-card';

            const scheduleColor = item.schedule_color || 'null';
            card.classList.add(scheduleColor);
            // card.textContent = item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0) + " " + item.remark + " " +"(" + item.scheduleDays + "天)" ;

            card.textContent =
                item.sample_model + " " +
                (item.materialCode && item.materialCode.length > 10
                    ? item.materialCode.substring(0, 10) + "..."
                    : item.materialCode || "") + " " +
                item.sample_leader.charAt(0) + " " +
                (item.remark && item.remark.length > 10
                    ? item.remark.substring(0, 10) + "..."
                    : item.remark || "") + " " +
                "(" + item.scheduleDays + "天)";


            card.setAttribute('data-sizecoding', item.sample_model + " " + formatRemark(item.materialCode) + " "+ item.sample_leader.charAt(0) + " "+ formatRemark(item.remark) );
            card.setAttribute('data-sample_id', item.sample_id || '');
            card.setAttribute('data-sample_name', item.sample_name || '');
            card.setAttribute('data-sample_model', item.sample_model || '');
            card.setAttribute('data-materialCode', item.materialCode || '');
            card.setAttribute('data-sample_category', item.sample_category || '');
            card.setAttribute('data-version', item.version || '');
            card.setAttribute('data-priority', item.priority || '');
            card.setAttribute('data-sample_leader', item.sample_leader || '');
            card.setAttribute('data-supplier', item.supplier || '');
            card.setAttribute('data-test_project_category', item.testProjectCategory || '');
            card.setAttribute('data-test_projects', item.testProjects || '');
            card.setAttribute('data-schedule', item.schedule || '');
            card.setAttribute('data-create_time', item.create_time || '');
            card.setAttribute('data-schedule_days', item.scheduleDays != null ? item.scheduleDays : '1');
            card.setAttribute('data-schedule_color', item.schedule_color != null ? item.schedule_color : '');
            card.setAttribute('data-remark', item.remark != null ? item.remark : '');
            card.setAttribute('data-sample_sender', item.sample_sender != null ? item.sample_sender : '');
            card.setAttribute('data-sample_type', item.sample_type != null ? item.sample_type : '');
            card.setAttribute('data-sample_quantity', item.sample_quantity != null ? item.sample_quantity : '');
            card.setAttribute('data-high_frequency', item.high_frequency != null ? item.high_frequency : '');
            card.setAttribute('draggable', 'false'); // 禁用默认拖拽，使用双击拖拽

            setDraggable(card, true);
            bindCardContextMenu(card, item);
            container.appendChild(card);
        });
    }

    // 页面加载后请求数据
    window.onload = function () {
        // 获取展示的组的数据
        loadGroupOrder();

        // 加载项目池子数据
        loadProjectPoolData(); // ✅ 页面初始化调用加载函数
        // 加载待送样池子数据
        loadPendingSamplePoolData();
        // 加载节假日数据
        loadHolidaysData();

        // 模态框关闭
        document.getElementById('infoCloseBtn').onclick = function () {
            document.getElementById('modal').style.display = 'none';
        };
        document.getElementById('modal').onclick = function (e) {
            if (e.target.id === 'modal') {
                document.getElementById('modal').style.display = 'none';
            }
        };

        // 关闭变更记录模态框
        document.getElementById('closeChangeLogBtn').onclick = function () {
            document.getElementById('changeLogModal').style.display = 'none';
        };
        document.getElementById('changeLogModal').onclick = function (e) {
            if (e.target.id === 'changeLogModal') {
                document.getElementById('changeLogModal').style.display = 'none';
            }
        };

    };

    // 项目卡片右键触发的绑定事件
    function bindCardContextMenu(card, item) {
        card.oncontextmenu = function (event) {
            event.preventDefault(); // 阻止浏览器默认右键菜单

            console.log("这个触发bindCardContextMenu")

            // 设置模态框内容
            document.getElementById('modalBody').innerHTML = `
            <!--            <p><strong>电气编号：</strong>${item.sample_id}</p>-->
            <div style="display: flex; align-items: center; gap: 10px;">
                <p><strong>电气编号：</strong></p>
                <input type="text" id="editSampleId" value="${item.sample_id}">
                <button id="editSampleIdBtn">修改</button>
            </div>
            <p><strong>项目名称：</strong>${item.sample_name}</p>
            <p><strong>大小编码：</strong>${item.sample_model + ' ' + item.materialCode}</p>
            <p><strong>产品类别：</strong>${item.sample_category}</p>
            <p><strong>版本：</strong>${item.version}</p>
            <p><strong>优先级：</strong>${item.priority}</p>
            <p><strong>项目负责人：</strong>${item.sample_leader}</p>
            <p><strong>供应商：</strong>${item.supplier}</p>
            <p><strong>试验项目类别：</strong>${item.testProjectCategory}</p>
            <p><strong>测试子项目：</strong>${item.testProjects}</p>
            <p><strong>状态：</strong>${getScheduleText(item.schedule)}</p>
            <p><strong>送样人：</strong>${item.sample_sender}</p>
            <p><strong>送样类别：</strong>${item.sample_type}</p>
            <p><strong>送样数量：</strong>${item.sample_quantity}</p>
            <p><strong>是否高频：</strong>${item.high_frequency}</p>
            <p><strong>创建时间：</strong>${item.create_time}</p>
        `;

            document.getElementById('scheduleDays').value = item.scheduleDays != null ? item.scheduleDays : '';
            // 设置选中的颜色，默认选无色
            const selectedColor = item.schedule_color ? item.schedule_color : 'null';
            const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
            if (colorRadio) {
                colorRadio.checked = true;
            }

            document.getElementById('sampleRemark').value = item.remark;

            document.getElementById('saveScheduleBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };

            document.getElementById('confirmColorBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };

            document.getElementById('saveRemarkBtn').onclick = function () {
                saveScheduleAndColor(card,item);
            };


            document.getElementById('modal').style.display = 'block';

            // 绑定修改电气编号按钮点击事件
            document.getElementById('editSampleIdBtn').addEventListener('click', function () {
                const newSampleId = document.getElementById('editSampleId').value;
                const oldSampleId = item.sample_id;

                // 发送请求到控制层
                fetch('/scheduleBoard/updateElectricSampleId', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldSampleId: oldSampleId,
                        newSampleId: newSampleId
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(result.message);
                            loadProjectPoolData();
                            loadPendingSamplePoolData();

                        } else {
                            alert(result.message);
                        }
                    })
                    .catch(error => {
                        console.error('修改电气编号时出错:', error);
                        alert('修改电气编号时出错，请稍后重试');
                    });
            });

        };

        // 添加点击事件监听
        card.addEventListener('click', () => {
            checkSimilarCodes(card);
        });


    }


    // 让卡片闪烁的方法
    function blinkCards(cards) {
        const blinkInterval = 500; // 闪烁间隔（毫秒）
        const blinkCount = 3; // 闪烁次数
        let count = 0;
        const intervalId = setInterval(() => {
            cards.forEach(card => {
                card.style.opacity = card.style.opacity === '0.5' ? '1' : '0.5';
            });
            count++;
            if (count >= blinkCount * 2) {
                clearInterval(intervalId);
                cards.forEach(card => {
                    card.style.opacity = '1';
                });
            }
        }, blinkInterval);
    }

    // 检查大编码是否相似的方法
    function checkSimilarCodes(clickedCard) {
        const clickedLargeCode = clickedCard.getAttribute('data-sample_model');
        const allProjectCards = document.querySelectorAll('.project-card');
        const allScheduleCells = document.querySelectorAll('.main-table-container #scheduleBoardTable td[data-sample_model]');
        const similarElements = [];

        // 检查项目卡片
        allProjectCards.forEach(card => {
            if (card !== clickedCard) {
                const currentLargeCode = card.getAttribute('data-sample_model');
                if (currentLargeCode === clickedLargeCode) {
                    similarElements.push(card);
                }
            }
        });

        // 检查排期面板单元格
        allScheduleCells.forEach(cell => {
            const currentLargeCode = cell.getAttribute('data-sample_model');
            if (currentLargeCode === clickedLargeCode) {
                similarElements.push(cell);
            }
        });

        if (similarElements.length > 0) {
            similarElements.push(clickedCard);
            blinkCards(similarElements);
        }
    }


    function saveScheduleAndColor(card, item) {
        const days = document.getElementById('scheduleDays').value;

        let selectedColor = document.querySelector('input[name="schedule_color"]:checked')?.value;
        if (!selectedColor) {
            alert("请选择一个颜色！");
            return;
        }

        const remark = document.getElementById('sampleRemark').value;

        const startDateCell = document.querySelector(`td[data-sample_id="${item.sample_id}"]`);
        let startDate = null;
        let tester = null;
        let job_number = null;
        let originalDays = null;

        if (startDateCell) {
            startDate = startDateCell.getAttribute('data-date');
            tester = startDateCell.getAttribute('data-tester');
            job_number = startDateCell.getAttribute('data-job_number');
            originalDays = startDateCell.getAttribute("data-schedule_days");

            if (!startDate) {
                console.error('无法获取排期开始日期');
                return;
            }

            const allCells = document.querySelectorAll('.drop-cell');
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(startDateObj);
            endDateObj.setDate(endDateObj.getDate() + Math.ceil(days) - 1);
            const newEndDate = endDateObj.toISOString().split('T')[0];

            const newDateRange = getDateRange(startDate, newEndDate);
            for (const date of newDateRange) {
                const cellsOnDate = Array.from(allCells).filter(cell =>
                    cell.getAttribute('data-date') === date &&
                    cell.getAttribute('data-tester') === tester &&
                    cell.innerText.trim() !== '' &&
                    cell.getAttribute('data-sample_id') !== item.sample_id
                );
                if (cellsOnDate.length > 0) {
                    alert('新排期会占用已有项目，请重新选择排期天数！');
                    return;
                }
            }

            const existingIndex = localScheduleChanges.findIndex(change => change.sample_id === item.sample_id);
            if (existingIndex !== -1) {
                localScheduleChanges[existingIndex].start_date = startDate;
                localScheduleChanges[existingIndex].end_date = newEndDate;
                localScheduleChanges[existingIndex].scheduleDays = days;
                localScheduleChanges[existingIndex].schedule_color = selectedColor;
                localScheduleChanges[existingIndex].tester = tester;
                localScheduleChanges[existingIndex].job_number = job_number;
            } else {
                const newChange = {
                    change: "add",
                    sample_id: item.sample_id,
                    tester: tester,
                    start_date: startDate,
                    end_date: newEndDate,
                    scheduleDays: days,
                    schedule_color: selectedColor,
                    job_number: job_number
                };
                localScheduleChanges.push(newChange);
            }

            console.log("标记5", localScheduleChanges);
        }

        // 合并后的接口请求
        fetch('/schedule/saveScheduleInfo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sample_id: item.sample_id,
                scheduleDays: days,
                schedule_color: selectedColor,
                remark: remark
            })
        })
            .then(resp => resp.json())
            .then(result => {
                // alert("排期天数和颜色设置成功！");
                document.getElementById('modal').style.display = 'none';

                // 更新卡片
                if (card) {
                    // card.textContent = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${remark} (${days}天)`;
                    card.textContent = `${item.sample_model} ${item.materialCode?.length > 10 ? item.materialCode.substring(0, 10) + "..." : item.materialCode ?? ""} ${item.sample_leader?.charAt(0)} ${item.remark?.length > 10 ? item.remark.substring(0, 10) + "..." : item.remark ?? ""} (${item.scheduleDays}天)`;

                    card.setAttribute('data-schedule_days', days || '1');

                    card.classList.remove('gray', 'green', 'yellow', 'red');
                    card.setAttribute('data-remark',remark);
                    card.classList.add(selectedColor);
                    card.dataset.schedule_color = selectedColor;

                    //这里是让卡片重现赋值新修改的值
                    item.scheduleDays = days;
                    item.schedule_color = selectedColor;
                    item.remark = remark;
                }

                // 更新排期面板
                const cells = document.querySelectorAll(`td[data-sample_id="${item.sample_id}"]`);
                cells.forEach(cell => {
                    // 获取原始天数
                    const originalDays = parseInt(cell.getAttribute('data-schedule_days')) || 1;
                    const newDays = parseInt(days) || 1;

                    cell.setAttribute('colspan', Math.ceil(newDays));
                    cell.setAttribute('data-schedule_days', days);
                    cell.setAttribute('data-remark', remark);

                    // cell.innerText = `${item.sample_model} ${item.materialCode} ${item.sample_leader?.charAt(0)} ${remark} (${days}天)`;
                    cell.innerText = `${item.sample_model} ${(item.materialCode ? (item.materialCode.length > 10 ? item.materialCode.substring(0, 10) + "..." : item.materialCode) : "")} ${item.sample_leader?.charAt(0)} ${(item.remark ? (item.remark.length > 10 ? item.remark.substring(0, 10) + "..." : item.remark) : "")} (${days}天)`;

                    if (selectedColor === null || selectedColor === "null") {
                        selectedColor = "white"
                    }

                    cell.style.backgroundColor = selectedColor;
                    cell.dataset.schedule_color = selectedColor;
                    // 设置CSS变量，供CSS规则使用
                    cell.style.setProperty('--project-color', selectedColor);

                    const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
                    const startIndex = rowCells.indexOf(cell);

                    // 先恢复所有被隐藏的单元格
                    for (let i = startIndex; i < startIndex + Math.max(originalDays, newDays); i++) {
                        if (rowCells[i]) {
                            rowCells[i].style.display = '';
                        }
                    }

                    // 然后根据新天数隐藏不需要的单元格
                    for (let i = startIndex + 1; i < startIndex + Math.ceil(newDays); i++) {
                        if (rowCells[i]) {
                            rowCells[i].style.display = 'none';
                        }
                    }
                });

            })
            .catch(err => {
                console.error("保存失败：", err);
                alert("保存失败，请重试！");
            });

        setTimeout(() => {
            saveSchedule(true);
        }, 2000); // 2000 毫秒 = 2 秒

    }

    async function saveSchedule(isRefrenshBtn) {
        if (!localScheduleChanges || localScheduleChanges.length === 0 ) {
            if(!isRefrenshBtn){
                alert('没有需要保存的排期变更');
            }
            return;
        }

        try {
            const response = await fetch('/scheduleBoard/saveSchedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(localScheduleChanges)
            });

            if (!response.ok) {
                throw new Error(`保存失败: ${response.statusText}`);
            }

            const result = await response.json(); // 确保解析 JSON

            alert(result.message+result.statusSummary);

            // 清空本地缓存
            localScheduleChanges = [];
        } catch (error) {
            console.error('保存排期失败:', error);
            alert('保存失败，请稍后重试！');
        }
    }

    async function refreshSchedule() {
        await saveSchedule(true); // 确保 saveSchedule 执行完毕
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        if (!startDate) {
            alert("请至少选择初始时间！");
            return;
        }

        const contextMenu = document.getElementById('contextMenu');
        contextMenu.removeEventListener('click', handleContextMenuClick);

        document.getElementById('scheduleBoard').innerHTML = '';

        // 加载排期面板数据
        fetch(`/getSchedulesByStartDate?startDate=${startDate}&endDate=${endDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(async data => {
                const board = document.getElementById('scheduleBoard');

                const allDatesSet = new Set();
                const dateMap = {}; // tester => array of tasks

                data.forEach(item => {
                    const task = {
                        startDate: item.schedule_start_date,
                        endDate: item.schedule_end_date,
                        sample_id: item.sample_id,
                        sizecoding: item.sample_model + " " + formatRemark(item.materialCode) + " " + item.sample_leader.charAt(0) + " " + formatRemark(item.remark),
                        sample_category: item.sample_category,
                        sample_model: item.sample_model,
                        sample_name: item.sample_name,
                        priority: item.priority,
                        version: item.version,
                        materialCode: item.materialCode,
                        sample_leader: item.sample_leader,
                        supplier: item.supplier,
                        test_project_category: item.testProjectCategory,
                        testProjects: item.testProjects,
                        schedule: item.schedule,
                        create_time: item.create_time,
                        schedule_days: item.scheduleDays,
                        schedule_start_date: item.schedule_start_date,
                        schedule_end_date: item.schedule_end_date,
                        schedule_color: item.schedule_color,
                        job_number: item.job_number,
                        remark: item.remark,
                        sample_sender: item.sample_sender,
                        sample_type: item.sample_type,
                        sample_quantity: item.sample_quantity,
                        high_frequency: item.high_frequency
                    };

                    const tester = item.tester || '未知测试人员';
                    if (!dateMap[tester]) dateMap[tester] = [];
                    dateMap[tester].push(task);

                    const dateRange = getDateRange(item.schedule_start_date, item.schedule_end_date);
                    dateRange.forEach(date => allDatesSet.add(date));
                });

                // 👉 强制覆盖日期：使用用户选择的完整日期范围
                getDateRange(startDate, endDate).forEach(date => allDatesSet.add(date));
                const allDates = Array.from(allDatesSet).sort();

                // 👉 不使用 data 中的 tester，统一从 /getTesters 获取
                try {
                    const testersResponse = await fetch('/getTesters');
                    const testersData = await testersResponse.json();

                    drawScheduleBoard(board, testersData, allDates, dateMap);
                } catch (error) {
                    console.error("获取测试人员失败:", error);
                    document.getElementById('scheduleBoard').innerHTML = '测试人员加载失败。';
                }
            })
            .catch(error => {
                document.getElementById('scheduleBoard').innerHTML = '排期加载失败。';
                console.error('Error loading schedule board:', error);
            });
    }

    function groupTestersByCategory(testers) {
        const groupMap = {};

        testers.forEach(tester => {
            const group = tester.responsible_category || '未分组';
            if (!groupMap[group]) {
                groupMap[group] = [];
            }
            groupMap[group].push(tester);
        });

        return groupMap;
    }

    // 绘制排期面板
    function drawScheduleBoard(board, testers, allDates, dateMap) {
        let html = '<div class="schedule-table-container">';
        
        // 创建冻结列容器
        html += '<div class="frozen-columns">';
        html += '<table id="frozenTable" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse;">';
        
        // 冻结列表头
        html += '<thead><tr>';
        html += '<th class="frozen-header">组别</th>';
        html += '<th class="frozen-header" style="min-width: 100px;">测试人员</th>';
        html += '</tr></thead><tbody>';
        
        // 冻结列内容
        const groupedTesters = groupTestersByCategory(testers);
        groupOrder.forEach(groupName => {
            const groupTesters = groupedTesters[groupName];
            if (!groupTesters) return;

            const groupRowSpan = groupTesters.length;
            groupTesters.forEach((tester, testerIndex) => {
                const testerName = tester.test_engineer_name;
                const jobNumber = tester.engineer_id;

                html += '<tr style="height: 60px;">';
                if (testerIndex === 0) {
                    html += `<td class="frozen-cell" rowspan="${groupRowSpan}" style="text-align: center; font-weight: bold;">${groupName}</td>`;
                }
                html += `<td class="frozen-cell"><strong class="tester-name" data-tester="${testerName}" style="cursor: pointer; color: #007bff;">${testerName}</strong></td>`;
                html += '</tr>';
            });
        });
        html += '</tbody></table>';
        html += '</div>';
        
        // 创建主表格容器
        html += '<div class="main-table-container">';
        html += '<table id="scheduleBoardTable" border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse;">';

        // 主表格表头
        html += '<thead><tr>';
        allDates.forEach(date => {
            const dateObj = new Date(date);
            const dayOfWeek = dateObj.getDay();
            let displayText = date;
            let isHoliday = false;
            let holidayName = '';

            // 检查是否为节假日
            if (holidays && holidays.length > 0) {
                const holiday = holidays.find(h => h.holiday_date === date);
                if (holiday) {
                    isHoliday = true;
                    holidayName = holiday.holiday_name;
                }
            }

            // 判断是否为周六或周日并添加对应文字
            if (dayOfWeek === 6) {
                displayText = `${date}<br>周六`;
            } else if (dayOfWeek === 0) {
                displayText = `${date}<br>周日`;
            }

            // 如果是节假日，添加节假日名称和特殊样式
            if (isHoliday) {
                displayText = `${date}<br>${holidayName}`;
                html += `<th class="weekend-border">${displayText}</th>`;
            } else {
                html += `<th>${displayText}</th>`;
            }
        });
        html += '</tr></thead><tbody>';


        // ⭐⭐ 新增：先按照 groupOrder 遍历
        groupOrder.forEach(groupName => {
            const groupTesters = groupedTesters[groupName];
            if (!groupTesters) return; // 如果某组没人，跳过

            const groupRowSpan = groupTesters.length;

            groupTesters.forEach((tester, testerIndex) => {
                const testerName = tester.test_engineer_name;
                const jobNumber = tester.engineer_id;

                html += '<tr style="height: 60px;">';

                let colIndex = 0;
                while (colIndex < allDates.length) {
                    const currentDate = allDates[colIndex];
                    // 筛选出当天所有相同天数的项目
                    const sameDayTasks = dateMap[testerName]?.filter(t =>
                        t.startDate === currentDate
                    ) || [];
                    
                    // 按天数分组
                    const tasksByDays = {};
                    sameDayTasks.forEach(task => {
                        const days = parseFloat(task.schedule_days);
                        if (!tasksByDays[days]) {
                            tasksByDays[days] = [];
                        }
                        tasksByDays[days].push(task);
                    });
                    
                    // 找到可以合并的天数组（至少2个相同天数的项目）
                    const mergeableDays = Object.keys(tasksByDays).filter(days => 
                        tasksByDays[parseFloat(days)].length >= 2
                    );
                    
                    // 优先选择最小的天数进行合并
                    const mergeableDay = mergeableDays.length > 0 ? 
                        Math.min(...mergeableDays.map(d => parseFloat(d))) : null;
                    
                    const mergeableTasks = mergeableDay ? tasksByDays[mergeableDay] : [];

                    const dateObj = new Date(currentDate);
                    const dayOfWeek = dateObj.getDay();
                    // 判断是否为周六、周日或节假日，添加 weekend-border 类名
                    let weekendClass = '';
                    const isWeekend = dayOfWeek === 6 || dayOfWeek === 0;
                    const isHoliday = holidays.some(h => h.holiday_date === currentDate);
                    
                    if (isWeekend || isHoliday) {
                        weekendClass = 'weekend-border';
                    }

                    if (mergeableTasks.length >= 2) {
                        const firstTask = mergeableTasks[0];
                        let cellHtml = `<td class="drop-cell assigned ${weekendClass}"
                        data-tester="${testerName}"
                        data-date="${currentDate}"
                        data-job_number="${jobNumber}"
                        data-sample_id="${firstTask.sample_id || ''}"
                        data-sample_name="${firstTask.sample_name || ''}"
                        data-sample_model="${firstTask.sample_model || ''}"
                        data-materialCode="${firstTask.materialCode || ''}"
                        data-sample_category="${firstTask.sample_category || ''}"
                        data-version="${firstTask.version || ''}"
                        data-priority="${firstTask.priority || ''}"
                        data-sample_leader="${firstTask.sample_leader || ''}"
                        data-supplier="${firstTask.supplier || ''}"
                        data-test_project_category="${firstTask.test_project_category || ''}"
                        data-test_projects="${firstTask.test_projects || ''}"
                        data-schedule="${firstTask.schedule || ''}"
                        data-create_time="${firstTask.create_time || ''}"
                        data-schedule_days="${firstTask.schedule_days || ''}"
                        data-sizecoding="${firstTask.sizecoding || ''}"
                        data-schedule_start_date="${firstTask.schedule_start_date || ''}"
                        data-schedule_end_date="${firstTask.schedule_end_date || ''}"
                        data-schedule_color="${firstTask.schedule_color || ''}"
                        data-remark="${firstTask.remark || ''}"
                        data-sample_sender="${firstTask.sample_sender || ''}"
                        data-sample_type="${firstTask.sample_type || ''}"
                        data-sample_quantity="${firstTask.sample_quantity || ''}"
                        data-high_frequency="${firstTask.high_frequency || ''}"`;

                        // 设置其他任务的 dataX- 属性
                        let displayText = `${firstTask.sizecoding} (${firstTask.schedule_days}天)`;
                        for (let i = 1; i < mergeableTasks.length; i++) {
                            const task = mergeableTasks[i];
                            Object.keys(task).forEach(key => {
                                if (key !== 'days') {
                                    cellHtml += ` data${i}-${key}="${task[key] || ''}"`;
                                }
                            });
                            // 限制显示文本长度，避免内容过多撑开单元格
                            const shortSizecoding = task.sizecoding.length > 15 ? 
                                task.sizecoding.substring(0, 15) + '...' : task.sizecoding;
                            displayText += `|${shortSizecoding} (${task.schedule_days}天)`;
                        }

                        // 设置 colspan 属性
                        const colspan = Math.ceil(parseFloat(firstTask.schedule_days));
                        cellHtml += ` colspan="${colspan}" style="height: 60px !important; min-height: 60px !important; max-height: 60px !important; padding: 5px 4px !important; overflow: hidden !important; line-height: 1.2 !important;">${displayText}</td>`;
                        html += cellHtml;
                        
                        // 隐藏被合并的单元格
                        for (let i = 1; i < colspan; i++) {
                            if (colIndex + i < allDates.length) {
                                let styleAttr = 'style="display: none; height: 60px !important; min-height: 60px !important; max-height: 60px !important; padding: 5px 4px !important;"';
                                if (weekendClass) {
                                    styleAttr += ` class="${weekendClass}"`;
                                }
                                html += `<td class="drop-cell" ${styleAttr} data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${allDates[colIndex + i]}"></td>`;
                            }
                        }
                        colIndex += colspan;
                    } else {
                        const task = dateMap[testerName]?.find(t => t.startDate === currentDate);
                        if (task) {
                            const colspan = Math.ceil(task.schedule_days);
                            html += createTaskCell(task, testerName, currentDate, colspan, weekendClass);
                            for (let i = 1; i < colspan; i++) {
                                let styleAttr = 'style="display: none; height: 60px !important; min-height: 60px !important; max-height: 60px !important; padding: 5px 4px !important;"';
                                if (weekendClass) {
                                    styleAttr += ` class="${weekendClass}"`;
                                }
                                html += `<td class="drop-cell" ${styleAttr} data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${allDates[colIndex + i]}"></td>`;
                            }
                            colIndex += colspan;
                        } else {
                            const isCovered = dateMap[testerName]?.some(t => t.startDate < currentDate && t.endDate >= currentDate);
                            if (!isCovered) {
                                // 修改：添加 weekendClass 类名
                                let cellHtml = `<td class="drop-cell ${weekendClass}" style="height: 60px !important; min-height: 60px !important; max-height: 60px !important; padding: 5px 4px !important; overflow: hidden !important;" data-tester="${testerName}" data-job_number="${jobNumber}" data-date="${currentDate}">`;
                                html += cellHtml + `</td>`;
                            }
                            colIndex += 1;
                        }
                    }
                }

                html += '</tr>';
            });
        });

        html += '</tbody></table>';
        html += '</div>'; // 关闭 main-table-container
        html += '</div>'; // 关闭 schedule-table-container
        board.innerHTML = html;

        // 为测试人员姓名添加点击事件（包括冻结列和主表格）
        const testerNames = document.querySelectorAll('.tester-name');
        testerNames.forEach(testerName => {
            testerName.addEventListener('click', function() {
                const tester = this.getAttribute('data-tester');
                const isCurrentlyHighlighted = this.classList.contains('highlighted-tester');
                
                if (isCurrentlyHighlighted) {
                    // 如果当前已高亮，则取消高亮
                    highlightTesterRow(null);
                } else {
                    // 否则高亮该测试人员的行
                    highlightTesterRow(tester);
                }
            });
        });

        // 添加全局点击事件，点击表格外区域取消高亮
        document.addEventListener('click', function(e) {
            // 使用新的函数检查是否应该保持高亮
            if (!shouldKeepHighlight(e.target)) {
                highlightTesterRow(null);
            }
        });

        // 添加键盘事件，按ESC键取消高亮
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                highlightTesterRow(null);
            }
        });

        // 同步冻结列和主表格的垂直滚动
        const mainTableContainer = document.querySelector('.main-table-container');
        const frozenColumns = document.querySelector('.frozen-columns');
        
        if (mainTableContainer && frozenColumns) {
            // 主表格滚动时，同步冻结列
            mainTableContainer.addEventListener('scroll', function() {
                if (frozenColumns.scrollTop !== this.scrollTop) {
                    frozenColumns.scrollTop = this.scrollTop;
                }
            });
            
            // 冻结列滚动时，同步主表格
            frozenColumns.addEventListener('scroll', function() {
                if (mainTableContainer.scrollTop !== this.scrollTop) {
                    mainTableContainer.scrollTop = this.scrollTop;
                }
            });
            
            // 初始化时确保两个容器的高度一致
            setTimeout(() => {
                const mainHeight = mainTableContainer.scrollHeight;
                const frozenHeight = frozenColumns.scrollHeight;
                console.log('主表格高度:', mainHeight, '冻结列高度:', frozenHeight);
            }, 1000);
        }

        // 为任务单元格添加拖拽事件
        const assignedCells = document.querySelectorAll('.main-table-container #scheduleBoardTable td.assigned');
        assignedCells.forEach(cell => {
            cell.setAttribute('draggable', 'false'); // 禁用默认拖拽
            cell.addEventListener('dblclick', e => {
                e.preventDefault();
                e.stopPropagation();

                // 收集拖拽数据
                const taskData = {};
                const attributes = [
                    'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                    'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                    'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                    'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                    'sample_sender', 'sample_type', 'sample_quantity', 'high_frequency'
                ];
                attributes.forEach(attr => {
                    taskData[`project-${attr}`] = cell.getAttribute(`data-${attr}`);
                });

                dragData = taskData;
                draggedElement = cell;
                isDragging = true;

                // 创建拖拽预览元素
                createDragPreview(cell);

                // 添加全局鼠标事件监听器
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('click', handleMouseClick);
            });
        });
        const cells = document.querySelectorAll('.drop-cell');

        // 定义待送样池子的容器 ID 数组
        const pendingSampleContainerIds = [
            'projectPool',
            'videoSamplePool',
            'wireSamplePool',
            'audioVideoWireSamplePool',
            'dataSamplePool',
            'bluetoothSamplePool',
            'highFrequencySamplePool',
            'keyboardMouseSamplePool',
            'headphoneSamplePool',
            'locatorSamplePool',
            'ipcSamplePool'
        ];

        // 调用通用函数为待送样池子的容器添加拖拽事件
        addDragEventsToContainers(pendingSampleContainerIds);

        cells.forEach((cell, cellIndex, cellList) => {
            cell.addEventListener('dragover', e => {
                e.preventDefault();

                cell.classList.add('over');

                // 获取排期表格容器
                const scheduleContainer = document.querySelector('.schedule-table-container');
                const mainTableContainer = document.querySelector('.main-table-container');
                if (!scheduleContainer || !mainTableContainer) return;

                // 自动滚动逻辑 - 垂直和水平方向
                const scrollSpeed = 10; // 滚动速度
                const triggerDistance = 50; // 触发滚动的距离
                const containerRect = scheduleContainer.getBoundingClientRect();
                const { clientX, clientY } = e;

                // 垂直方向自动滚动
                // 靠近容器顶部，向上滚动
                if (clientY < containerRect.top + triggerDistance) {
                    scheduleContainer.scrollTop -= scrollSpeed;
                }
                // 靠近容器底部，向下滚动
                else if (clientY > containerRect.bottom - triggerDistance) {
                    scheduleContainer.scrollTop += scrollSpeed;
                }
                
                // 同时支持window滚动（当鼠标在容器外时）
                // 靠近页面顶部，向上滚动window
                if (clientY < triggerDistance) {
                    window.scrollBy(0, -scrollSpeed);
                }
                // 靠近页面底部，向下滚动window
                else if (clientY > window.innerHeight - triggerDistance) {
                    window.scrollBy(0, scrollSpeed);
                }

                // 水平方向自动滚动 - 使用主表格容器
                // 靠近容器左侧，向左滚动
                if (clientX < containerRect.left + triggerDistance) {
                    mainTableContainer.scrollLeft -= scrollSpeed;
                    console.log('单元格向左滚动', clientX, containerRect.left + triggerDistance);
                }
                // 靠近容器右侧，向右滚动
                else if (clientX > containerRect.right - triggerDistance) {
                    mainTableContainer.scrollLeft += scrollSpeed;
                    console.log('单元格向右滚动', clientX, containerRect.right - triggerDistance);
                }
            });

            cell.addEventListener('dragleave', () => cell.classList.remove('over'));

            cell.addEventListener('drop', e => {
                e.preventDefault();
                cell.classList.remove('over');

                const sample_id = e.dataTransfer.getData('project-sample_id');
                const days = parseFloat(e.dataTransfer.getData('project-days')) || 1;
                const sizecoding = e.dataTransfer.getData('project-sizecoding') || 1;

                const tester = cell.getAttribute('data-tester');
                const job_number = cell.getAttribute('data-job_number');
                const startDate = cell.getAttribute('data-date');

                const schedule_days = parseFloat(e.dataTransfer.getData('project-schedule_days')) || 1;

                if ((!sample_id || sample_id.trim() === "")) {
                    console.warn("无效拖拽内容：sample_id 和 schedule_days 都为空，忽略本次拖拽。");
                    return;
                }

                const startDateObj = new Date(startDate);
                startDateObj.setDate(startDateObj.getDate() + Math.ceil(schedule_days) - 1);
                const schedule_end_date = startDateObj.toISOString().split('T')[0];

                const taskData = {
                    sample_id,
                    days,
                    sizecoding,
                    tester,
                    job_number,
                    startDate,
                    sample_name: e.dataTransfer.getData('project-sample_name'),
                    sample_model: e.dataTransfer.getData('project-sample_model'),
                    materialCode: e.dataTransfer.getData('project-materialCode'),
                    sample_category: e.dataTransfer.getData('project-sample_category'),
                    version: e.dataTransfer.getData('project-version'),
                    priority: e.dataTransfer.getData('project-priority'),
                    sample_leader: e.dataTransfer.getData('project-sample_leader'),
                    supplier: e.dataTransfer.getData('project-supplier'),
                    test_project_category: e.dataTransfer.getData('project-test_project_category'),
                    test_projects: e.dataTransfer.getData('project-test_projects'),
                    schedule: e.dataTransfer.getData('project-schedule'),
                    create_time: e.dataTransfer.getData('project-create_time'),
                    schedule_days: e.dataTransfer.getData('project-schedule_days'),
                    schedule_start_date: startDate,
                    schedule_end_date: schedule_end_date,
                    schedule_color: e.dataTransfer.getData('project-schedule_color'),
                    remark: e.dataTransfer.getData('project-remark'),
                    sample_sender: e.dataTransfer.getData('project-sample_sender'),
                    sample_type: e.dataTransfer.getData('project-sample_type'),
                    sample_quantity: e.dataTransfer.getData('project-sample_quantity'),
                    high_frequency: e.dataTransfer.getData('project-high_frequency')
                };

                const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
                const startIndex = rowCells.indexOf(cell);
                const roundedDays = Math.ceil(parseFloat(schedule_days));

                // 检查排期是否超出可排范围
                if (startIndex + roundedDays > rowCells.length) {
                    alert("排期超出可排范围！请设置更广泛的日期");
                    return;
                }

                // 检查排期区域是否已被占用
                let conflictFound = false;
                for (let i = startIndex; i < startIndex + roundedDays; i++) {
                    if (rowCells[i].innerText.trim() !== '') {
                        conflictFound = true;
                        break;
                    }
                }

                if (conflictFound) {
                    const confirmInsert = confirm('插入位置已被占用，是否将后续项目往后挪？');
                    if (!confirmInsert) {
                        // 判断是否都是相同天数的项目
                        const draggedScheduleDays = parseFloat(taskData.schedule_days);
                        for (let i = startIndex; i < startIndex + roundedDays; i++) {
                            if (rowCells[i].innerText.trim() !== '') {
                                const conflictingScheduleDays = parseFloat(rowCells[i].getAttribute('data-schedule_days'));
                                if (draggedScheduleDays === conflictingScheduleDays) {
                                    const confirmMerge = confirm(`两个项目排期天数均为 ${draggedScheduleDays} 天，是否合并单元格？`);
                                    if (confirmMerge) {
                                        // 获取当前单元格（拖拽项目将放入的单元格）
                                        const targetCell = rowCells[i];

                                        // 判断是否相同天数项目自己拖自己
                                        const maxSample_id = targetCell.getAttribute('data-sample_id')
                                        if (maxSample_id === sample_id) {
                                            alert("不允许项目自己合并自己");
                                            return;
                                        }

                                        // 检查已存在的 dataX- 属性，找到下一个可用的索引
                                        let nextIndex = 1;
                                        const existingAttributes = [...targetCell.attributes];
                                        for (const attr of existingAttributes) {
                                            if (attr.name.startsWith('data') && attr.name.match(/^data(\d+)-/)) {
                                                const match = attr.name.match(/^data(\d+)-/);
                                                if (match) {
                                                    const currentIndex = parseInt(match[1]);
                                                    if (currentIndex >= nextIndex) {
                                                        nextIndex = currentIndex + 1;
                                                    }
                                                }
                                            }
                                        }

                                        // 将拖拽项目的属性添加到目标单元格，使用动态的 dataX- 前缀
                                        Object.keys(taskData).forEach(key => {
                                            if (key !== 'days') {
                                                targetCell.setAttribute(`data${nextIndex}-${key}`, taskData[key]);
                                            }
                                        });

                                        // 获取原项目的属性并保留
                                        const originalAttributes = {};
                                        const attributesToCopy = [
                                            'sample_id', 'sample_name', 'sample_model', 'materialCode',
                                            'sample_category', 'version', 'priority', 'sample_leader',
                                            'supplier', 'test_project_category', 'test_projects', 'schedule',
                                            'create_time', 'schedule_days', 'schedule_start_date',
                                            'schedule_end_date', 'schedule_color', 'remark', 'job_number', 'tester',
                                            'sample_sender', 'sample_type', 'sample_quantity', 'high_frequency'
                                        ];
                                        attributesToCopy.forEach(attr => {
                                            originalAttributes[attr] = targetCell.getAttribute(`data-${attr}`);
                                        });

                                        // 构造新的显示文本，合并两个项目信息
                                        const originalText = targetCell.innerText;
                                        // const newText = `${originalText}|${taskData.sample_model} ${taskData.materialCode} ${taskData.sample_leader?.charAt(0)} ${taskData.remark} (${taskData.schedule_days}天)`;
                                        const newText = `${originalText}|${taskData.sample_model} ${taskData.materialCode?.length > 10 ? taskData.materialCode.substring(0, 10) + "..." : taskData.materialCode ?? ""} ${taskData.sample_leader?.charAt(0)} ${taskData.remark?.length > 10 ? taskData.remark.substring(0, 10) + "..." : taskData.remark ?? ""} (${taskData.schedule_days}天)`;


                                        targetCell.innerText = newText;

                                        // 更新排期天数
                                        const newScheduleDays = draggedScheduleDays;
                                        targetCell.setAttribute('data-schedule_days', newScheduleDays);

                                        // 记录合并变更到 localScheduleChanges
                                        const newChange = {
                                            change: "add",
                                            sample_id: targetCell.getAttribute(`data${nextIndex}-sample_id`),
                                            tester: targetCell.getAttribute(`data${nextIndex}-tester`),
                                            start_date: targetCell.getAttribute(`data${nextIndex}-schedule_start_date`),
                                            // 假设合并后结束日期不变
                                            end_date: targetCell.getAttribute(`data${nextIndex}-schedule_end_date`),
                                            scheduleDays: newScheduleDays,
                                            schedule_color: targetCell.getAttribute(`data${nextIndex}-schedule_color`),
                                            job_number: targetCell.getAttribute(`data${nextIndex}-job_number`)
                                        };

                                        const existingIndex = localScheduleChanges.findIndex(item =>
                                            item.sample_id === targetCell.getAttribute(`data${nextIndex}-sample_id`)
                                        );

                                        if (existingIndex !== -1) {
                                            localScheduleChanges[existingIndex] = newChange;
                                        } else {
                                            localScheduleChanges.push(newChange);
                                        }

                                        console.log("标记8:",localScheduleChanges)

                                        // 从原容器移除拖拽的项目卡片
                                        const projectEl = document.querySelector(`.project-card[data-sample_id="${taskData.sample_id}"]`);
                                        if (projectEl) projectEl.remove();


                                        const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);
                                        if (originalCell) {
                                            const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                                            const originalStartIndex = originalRowCells.indexOf(originalCell);
                                            const originalScheduleDays = Math.ceil(parseFloat(originalCell.getAttribute('data-schedule_days')));

                                            // 检查原单元格是否还有其他合并的项目（dataX- 属性）
                                            let hasOtherMergedProjects = false;
                                            let remainingProjects = [];
                                            let maxDataIndex = 0;
                                            let draggedProjectIndex = -1;
                                            
                                            // 先找到被拖拽项目的索引
                                            [...originalCell.attributes].forEach(attr => {
                                                if (attr.name.match(/^data\d+-sample_id$/)) {
                                                    const match = attr.name.match(/^data(\d+)-/);
                                                    if (match) {
                                                        const index = parseInt(match[1]);
                                                        const projectSampleId = attr.value;
                                                        
                                                        // 找到被拖拽项目的索引
                                                        if (projectSampleId === taskData.sample_id) {
                                                            draggedProjectIndex = index;
                                                        }
                                                    }
                                                }
                                            });
                                            
                                            // 检查所有 dataX- 属性，找出除了当前拖拽项目之外的其他项目
                                            [...originalCell.attributes].forEach(attr => {
                                                if (attr.name.match(/^data\d+-sample_id$/)) {
                                                    const match = attr.name.match(/^data(\d+)-/);
                                                    if (match) {
                                                        const index = parseInt(match[1]);
                                                        const projectSampleId = attr.value;
                                                        
                                                        // 如果不是当前拖拽的项目，则保留
                                                        if (projectSampleId !== taskData.sample_id) {
                                                            hasOtherMergedProjects = true;
                                                            maxDataIndex = Math.max(maxDataIndex, index);
                                                            
                                                            // 收集这个项目的所有属性
                                                            const projectData = {};
                                                            [...originalCell.attributes].forEach(projectAttr => {
                                                                if (projectAttr.name.startsWith(`data${index}-`)) {
                                                                    const key = projectAttr.name.replace(`data${index}-`, '');
                                                                    projectData[key] = projectAttr.value;
                                                                }
                                                            });
                                                            remainingProjects.push({
                                                                index: index,
                                                                data: projectData
                                                            });
                                                        }
                                                    }
                                                }
                                            });
                                            
                                            console.log("被拖拽项目索引:", draggedProjectIndex);
                                            console.log("剩余项目数量:", remainingProjects.length);

                                            if (hasOtherMergedProjects) {
                                                // 如果还有其他合并的项目，需要重新整理显示
                                                console.log("原单元格还有其他合并项目，需要重新整理");
                                                
                                                // 清除原单元格内容和基本属性
                                                originalCell.innerText = '';
                                                originalCell.removeAttribute('colspan');
                                                originalCell.classList.remove('assigned');
                                                originalCell.style.backgroundColor = '';

                                                // 保留基本属性
                                                const allowedAttributes = ['class', 'data-tester', 'data-date', 'data-job_number'];
                                                
                                                // 清除所有属性，但保留基本属性和其他合并项目的属性
                                                [...originalCell.attributes].forEach(attr => {
                                                    if (!allowedAttributes.includes(attr.name) && !attr.name.match(/^data\d+-/)) {
                                                        originalCell.removeAttribute(attr.name);
                                                    }
                                                });

                                                // 重新整理剩余项目的属性，将第一个项目设为 data- 属性
                                                if (remainingProjects.length > 0) {
                                                    const firstProject = remainingProjects[0];
                                                    
                                                    // 先清除所有 dataX- 属性，包括被拆分项目的属性
                                                    [...originalCell.attributes].forEach(attr => {
                                                        if (attr.name.match(/^data\d+-/)) {
                                                            originalCell.removeAttribute(attr.name);
                                                        }
                                                    });
                                                    
                                                    console.log("已清除所有 dataX- 属性");
                                                    
                                                    // 将第一个项目的属性设为 data- 属性
                                                    Object.keys(firstProject.data).forEach(key => {
                                                        originalCell.setAttribute(`data-${key}`, firstProject.data[key]);
                                                    });
                                                    
                                                    // 重新整理其他项目的属性，使用新的索引
                                                    for (let i = 1; i < remainingProjects.length; i++) {
                                                        const project = remainingProjects[i];
                                                        Object.keys(project.data).forEach(key => {
                                                            originalCell.setAttribute(`data${i}-${key}`, project.data[key]);
                                                        });
                                                    }
                                                    
                                                    // 重新构造显示文本
                                                    let displayText = `${firstProject.data.sizecoding || ''} (${firstProject.data.schedule_days || ''}天)`;
                                                    for (let i = 1; i < remainingProjects.length; i++) {
                                                        const project = remainingProjects[i];
                                                        const sizecoding = project.data.sizecoding || '';
                                                        const scheduleDays = project.data.schedule_days || '';
                                                        const remark = project.data.remark || '';
                                                        const truncatedRemark = remark.length > 10 ? remark.substring(0, 10) + "..." : remark;
                                                        displayText += `|${sizecoding} ${truncatedRemark} (${scheduleDays}天)`;
                                                    }
                                                    
                                                    originalCell.innerText = displayText;
                                                    console.log("重新整理后的显示文本:", displayText);
                                                    originalCell.classList.add('assigned');
                                                    
                                                    // 设置颜色（使用第一个项目的颜色）
                                                    const scheduleColor = firstProject.data.schedule_color;
                                                    if (scheduleColor && scheduleColor !== 'null') {
                                                        originalCell.style.backgroundColor = scheduleColor;
                                                        originalCell.style.setProperty('--project-color', scheduleColor);
                                                        if (originalCell.classList.contains('weekend-border')) {
                                                            originalCell.style.setProperty('background-color', scheduleColor, 'important');
                                                        }
                                                    }
                                                    
                                                    // 设置 colspan（使用第一个项目的天数）
                                                    const scheduleDays = firstProject.data.schedule_days;
                                                    if (scheduleDays && scheduleDays !== 'null') {
                                                        originalCell.setAttribute('colspan', Math.ceil(parseFloat(scheduleDays)));
                                                        originalCell.setAttribute('data-schedule_days', scheduleDays);
                                                    }
                                                    
                                                    // 重新隐藏被合并的单元格
                                                    for (let j = originalStartIndex + 1; j < originalStartIndex + Math.ceil(parseFloat(scheduleDays)); j++) {
                                                        if (originalRowCells[j]) {
                                                            originalRowCells[j].style.display = 'none';
                                                        }
                                                    }
                                                    
                                                    // 重新绑定拖拽事件
                                                    originalCell.setAttribute('draggable', 'false');
                                                    originalCell.addEventListener('dblclick', function (e) {
                                                        e.preventDefault();
                                                        e.stopPropagation();

                                                        // 收集拖拽数据
                                                        const taskData = {};
                                                        const attributes = [
                                                            'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                                                            'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                                            'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                                            'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                                                            'sample_sender', 'sample_type', 'sample_quantity', 'high_frequency'
                                                        ];
                                                        attributes.forEach(attr => {
                                                            taskData[`project-${attr}`] = this.getAttribute(`data-${attr}`);
                                                        });

                                                        dragData = taskData;
                                                        draggedElement = this;
                                                        isDragging = true;

                                                        // 创建拖拽预览元素
                                                        createDragPreview(this);

                                                        // 添加全局鼠标事件监听器
                                                        document.addEventListener('mousemove', handleMouseMove);
                                                        document.addEventListener('click', handleMouseClick);
                                                    });

                                                    // 绑定右键菜单事件
                                                    originalCell.addEventListener('contextmenu', e => {
                                                        e.preventDefault();
                                                        if (originalCell.innerText.trim() === '') return;
                                                        currentRightClickCell = originalCell;
                                                        const contextMenu = document.getElementById('contextMenu');
                                                        contextMenu.style.top = e.pageY + 'px';
                                                        contextMenu.style.left = e.pageX + 'px';
                                                        contextMenu.style.display = 'block';
                                                    });
                                                }
                                            } else {
                                                // 如果没有其他合并的项目，按原来的逻辑处理
                                                console.log("原单元格没有其他合并项目，按原逻辑处理");
                                                
                                                // 清除原单元格内容和属性
                                                originalCell.innerText = '';
                                                originalCell.removeAttribute('colspan');
                                                originalCell.classList.remove('assigned');
                                                originalCell.style.backgroundColor = '';

                                                const allowedAttributes = ['class', 'data-tester', 'data-date', 'data-job_number'];
                                                [...originalCell.attributes].forEach(attr => {
                                                    if (!allowedAttributes.includes(attr.name)) {
                                                        originalCell.removeAttribute(attr.name);
                                                    }
                                                });

                                                // 恢复被隐藏的格子
                                                for (let j = originalStartIndex; j < originalStartIndex + originalScheduleDays; j++) {
                                                    if (originalRowCells[j]) {
                                                        originalRowCells[j].style.display = '';
                                                        // 恢复周末样式
                                                        const date = originalRowCells[j].getAttribute('data-date');
                                                        setWeekendBorder(originalRowCells[j], date);
                                                    }
                                                }

                                                // 重新设置 colspan 属性（如果原单元格还有项目数据）
                                                const remainingScheduleDays = originalCell.getAttribute('data-schedule_days');
                                                if (remainingScheduleDays && remainingScheduleDays !== 'null') {
                                                    originalCell.setAttribute('colspan', Math.ceil(parseFloat(remainingScheduleDays)));
                                                    // 重新隐藏被合并的单元格
                                                    for (let j = originalStartIndex + 1; j < originalStartIndex + Math.ceil(parseFloat(remainingScheduleDays)); j++) {
                                                        if (originalRowCells[j]) {
                                                            originalRowCells[j].style.display = 'none';
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        return;
                                    } else {
                                        return;
                                    }
                                } else {
                                    return;
                                }
                            }
                        }
                    } else {
                        // 后续项目后移逻辑保持原有
                        let conflictCells = [];
                        for (let i = startIndex; i < startIndex + roundedDays; i++) {
                            if (rowCells[i].innerText.trim() !== '') {
                                conflictCells.push(rowCells[i]);
                            }
                        }
                        const projectsToMove = [];
                        let diff;
                        if (conflictCells.length > 0) {
                            // 找到所有需要往后挪的项目
                            let currentIndex = startIndex;
                            while (currentIndex < rowCells.length) {
                                const currentCell = rowCells[currentIndex];
                                if (currentCell.innerText.trim() !== '' && currentCell.innerText.trim().includes("天)|")){
                                    const projectSpan = parseInt(currentCell.getAttribute('colspan')) || 1;
                                    const projectData = {};
                                    const attributes = [
                                        'sample_id', 'sizecoding', 'tester', 'job_number', 'sample_name',
                                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                                    ];

                                    attributes.forEach(attr => {
                                        const normalKey = attr;
                                        const dataKey = `data-${attr}`;

                                        // 获取 data-xxx 的值
                                        const dataValue = currentCell.getAttribute(dataKey);
                                        projectData[normalKey] = dataValue;

                                        // 获取所有 dataX-xxx 的值
                                        [...currentCell.attributes].forEach(cellAttr => {
                                            if (cellAttr.name.match(/^data\d+-/)) {
                                                projectData[cellAttr.name] = cellAttr.value;
                                            }
                                        });
                                    });

                                    projectsToMove.push({
                                        startIndex: currentIndex,
                                        span: projectSpan,
                                        data: projectData
                                    });

                                    currentIndex += projectSpan;
                                }else if(currentCell.innerText.trim() !== '') {
                                    const projectSpan = parseInt(currentCell.getAttribute('colspan')) || 1;
                                    const projectData = {};
                                    const attributes = [
                                        'sample_id', 'sizecoding', 'tester', 'job_number', 'sample_name',
                                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                                    ];
                                    attributes.forEach(attr => {
                                        projectData[attr] = currentCell.getAttribute(`data-${attr}`);
                                    });
                                    projectsToMove.push({
                                        startIndex: currentIndex,
                                        span: projectSpan,
                                        data: projectData
                                    });
                                    currentIndex += projectSpan;
                                } else {
                                    currentIndex++;
                                }
                            }

                            let minStartIndex = Infinity;  // 初始化最小的 startIndex 值
                            let maxStartIndex = Infinity;  // 初始化最小的 startIndex 值
                            let maxSpan = Infinity;  // 初始化最小的 startIndex 值
                            let maxSample_id = '';
                            // 找到最小的 startIndex
                            minStartIndex = Math.min(...projectsToMove.map(project => project.startIndex));
                            maxStartIndex = Math.max(...projectsToMove.map(project => project.startIndex));
                            maxSpan = Math.max(...projectsToMove.map(project => project.span));
                            maxSample_id = projectsToMove[0].data.sample_id;

                            // 计算拖拽项目与最小startIndex的差值
                            diff = roundedDays - minStartIndex + startIndex;

                            if (maxSample_id === sample_id) {
                                alert("请先移动到别的地方（例如项目池子或者空的日期），再拖拽回来");
                                return;
                            }

                            if (maxStartIndex + diff + maxSpan > rowCells.length) {
                                alert("后续项目移动后超出可排范围！");
                                return;
                            }
                        }

                        // 确认可以放置项目后，再清空原排期
                        const originalCell = document.querySelector(`td[data-sample_id="${sample_id}"]`);
                        if (originalCell) {
                            const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                            const originalStartIndex = originalRowCells.indexOf(originalCell);
                            const originalScheduleDays = Math.ceil((originalCell.getAttribute('data-schedule_days')) || 1);

                            // 清除原单元格内容和属性
                            originalCell.innerText = '';
                            originalCell.removeAttribute('colspan');
                            originalCell.classList.remove('assigned');
                            originalCell.style.backgroundColor = '';

                            const allowedAttributes = ['class', 'data-tester', 'data-date', 'data-job_number'];
                            [...originalCell.attributes].forEach(attr => {
                                if (!allowedAttributes.includes(attr.name)) {
                                    originalCell.removeAttribute(attr.name);
                                }
                            });

                                                    // 恢复被隐藏的格子,项目拖拽到别的地方，先触发这里
                        for (let i = originalStartIndex; i < Math.min(originalStartIndex + originalScheduleDays, originalRowCells.length); i++) {
                            if (originalRowCells[i]) {
                                originalRowCells[i].style.display = '';

                                // 新增：复原周六和周日的边框样式
                                const date = originalRowCells[i].getAttribute('data-date');
                                setWeekendBorder(originalRowCells[i], date);
                            }
                        }

                        // 重新设置 colspan 属性（如果原单元格还有项目数据）
                        const remainingScheduleDays = originalCell.getAttribute('data-schedule_days');
                        if (remainingScheduleDays && remainingScheduleDays !== 'null') {
                            originalCell.setAttribute('colspan', Math.ceil(parseFloat(remainingScheduleDays)));
                            // 重新隐藏被合并的单元格
                            for (let i = originalStartIndex + 1; i < originalStartIndex + Math.ceil(parseFloat(remainingScheduleDays)); i++) {
                                if (originalRowCells[i]) {
                                    originalRowCells[i].style.display = 'none';
                                }
                            }
                        }
                        }
                        console.log("111")

                        handleDrop(cell, cellList, taskData, conflictCells, projectsToMove, diff);
                    }
                } else {
                    // 清空拖拽来源的单元格，这里是排期面板项目拖拽触发的方法！
                    const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);

                    if (originalCell) {

                        // 判断是否含有 data1- 开头标签的参数
                        let hasData1Attr = false;

                        const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                        const originalStartIndex = originalRowCells.indexOf(originalCell);
                        const originalScheduleDays = Math.ceil(parseFloat(originalCell.getAttribute('data-schedule_days')));

                        // 先保存原单元格的 innerText
                        let originalInnerText = "";
                        // 检查是否存在 data1- 开头的属性
                        [...originalCell.attributes].forEach(attr => {
                            if (attr.name.startsWith('data1-')) {
                                hasData1Attr = true;
                            }
                        });


                        if (hasData1Attr) {
                            const text = originalCell.innerText;
                            const parts = text.split('|');
                            // 确保分割后有后半部分内容
                            if (parts.length > 1) {
                                // 从第二个元素开始，使用 join 方法处理可能有多个 | 的情况
                                originalInnerText = parts.slice(1).join('天)|').trim();
                            } else {
                                originalInnerText = text.trim();
                            }
                        }

                        // 清除原单元格内容和属性
                        originalCell.innerText = '';
                        originalCell.removeAttribute('colspan');
                        // originalCell.classList.remove('assigned');
                        originalCell.style.backgroundColor = '';

                        // 允许保留的属性
                        const allowedAttributes = ['class', 'data-tester', 'data-date', 'data-job_number'];

                        [...originalCell.attributes].forEach(attr => {
                            const name = attr.name;

                            // 匹配形如 dataX- 开头的属性，X 为数字
                            const match = name.match(/^data(\d+)-(.+)$/);
                            if (match) {
                                const number = parseInt(match[1], 10);
                                const key = match[2];

                                let newName;
                                if (number === 1) {
                                    newName = `data-${key}`; // X为1，变成data-key
                                } else if (number > 1) {
                                    newName = `data${number - 1}-${key}`; // X>1，减1
                                }

                                if (newName && !allowedAttributes.includes(newName)) {
                                    if (attr.value !== null && attr.value !== 'null') {
                                        originalCell.setAttribute(newName, attr.value);
                                    }
                                }
                                // 删除原始 dataX- 属性
                                originalCell.removeAttribute(name);

                            } else if (!allowedAttributes.includes(name)) {
                                // 非 dataX- 且非受保护属性，直接删除
                                originalCell.removeAttribute(name);
                            }
                        });




                        // 恢复被隐藏的格子
                        for (let j = originalStartIndex; j < originalStartIndex + originalScheduleDays; j++) {
                            if (originalRowCells[j]) {
                                originalRowCells[j].style.display = '';
                                // 恢复周末样式
                                const date = originalRowCells[j].getAttribute('data-date');
                                setWeekendBorder(originalRowCells[j], date);
                            }
                        }

                        // 重新设置 colspan 属性（如果原单元格还有项目数据）
                        const remainingScheduleDays = draggedElement.getAttribute('data-schedule_days');
                        if (remainingScheduleDays && remainingScheduleDays !== 'null') {
                            draggedElement.setAttribute('colspan', Math.ceil(parseFloat(remainingScheduleDays)));
                            // 重新隐藏被合并的单元格
                            for (let j = originalStartIndex + 1; j < originalStartIndex + Math.ceil(parseFloat(remainingScheduleDays)); j++) {
                                if (originalRowCells[j]) {
                                    originalRowCells[j].style.display = 'none';
                                }
                            }
                        }

                        // 重新隐藏被合并的单元格（除了第一个）
                        const newScheduleDays = Math.ceil(parseFloat(originalCell.getAttribute('data-schedule_days')));
                        for (let j = originalStartIndex + 1; j < originalStartIndex + newScheduleDays; j++) {
                            if (originalRowCells[j]) {
                                originalRowCells[j].style.display = 'none';
                            }
                        }
                        // 恢复原单元格的 innerText
                        originalCell.innerText = originalInnerText;

                        // 重新设置 colspan 属性
                        const scheduleDays = originalCell.getAttribute('data-schedule_days');
                        if (scheduleDays && scheduleDays !== 'null') {
                            originalCell.setAttribute('colspan', Math.ceil(parseFloat(scheduleDays)));
                        }

                        if (hasData1Attr) {
                            // 重新设置可拖拽属性
                            originalCell.setAttribute('draggable', 'false'); // 禁用默认拖拽，使用双击拖拽

                            // 绑定双击拖拽事件
                            originalCell.addEventListener('dblclick', function (e) {
                                e.preventDefault();
                                e.stopPropagation();

                                // 收集拖拽数据
                                const taskData = {};
                                const attributes = [
                                    'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                                    'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                                    'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                                    'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                                ];
                                attributes.forEach(attr => {
                                    taskData[`project-${attr}`] = this.getAttribute(`data-${attr}`);
                                });

                                dragData = taskData;
                                draggedElement = this;
                                isDragging = true;

                                // 创建拖拽预览元素
                                createDragPreview(this);

                                // 添加全局鼠标事件监听器
                                document.addEventListener('mousemove', handleMouseMove);
                                document.addEventListener('click', handleMouseClick);
                            });

                            // 绑定右键菜单事件
                            originalCell.addEventListener('contextmenu', e => {
                                e.preventDefault();
                                if (originalCell.innerText.trim() === '') return;
                                currentRightClickCell = originalCell;
                                const contextMenu = document.getElementById('contextMenu');
                                contextMenu.style.top = e.pageY + 'px';
                                contextMenu.style.left = e.pageX + 'px';
                                contextMenu.style.display = 'block';
                            });
                        }
                        // 获取颜色值并渲染单元格颜色
                        const scheduleColor = originalCell.getAttribute('data-schedule_color');
                        if (scheduleColor && scheduleColor !== 'null') {
                            originalCell.style.backgroundColor = scheduleColor;
                            // 设置CSS变量，供CSS规则使用
                            originalCell.style.setProperty('--project-color', scheduleColor);
                            // 如果是周末单元格，强制设置颜色优先级
                            if (originalCell.classList.contains('weekend-border')) {
                                originalCell.style.setProperty('background-color', scheduleColor, 'important');
                            }
                        }
                    }
// 没有冲突，直接处理放置,这里是合并的单元格拖拽之后拆分后的项目，它拖拽进入的方法
                    console.log("222")
                    handleDrop(cell, cellList, taskData, [], [], 0);



                }
            });


            cell.addEventListener('contextmenu', e => {
                e.preventDefault();
                if (cell.innerText.trim() === '') return;
                currentRightClickCell = cell;
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.display = 'block';
            });
        });

        const contextMenu = document.getElementById('contextMenu');
        contextMenu.addEventListener('click', handleContextMenuClick);

        // 设置项目颜色
        document.querySelectorAll('.main-table-container #scheduleBoardTable td[data-schedule_color]').forEach(cell => {
            const color = cell.getAttribute('data-schedule_color');
            if (color && color !== 'null') {
                cell.style.backgroundColor = color;
                // 设置CSS变量，供CSS规则使用
                cell.style.setProperty('--project-color', color);
                // 确保节假日项目也能正确显示颜色
                if (cell.classList.contains('weekend-border')) {
                    cell.style.backgroundColor = color;
                }
            }
        });



    }

    // 创建排期面板的单元格
    function createTaskCell(task, tester, currentDate, colspan, weekendClass) {
        let classAttribute = 'drop-cell assigned';
        if (weekendClass) {
            classAttribute += ` ${weekendClass}`;
        }
        return `
        <td class="drop-cell assigned"
          data-tester="${tester}"
          data-date="${currentDate}"
          data-job_number="${task.job_number}"
          colspan="${colspan}"
          style="height: 60px !important; min-height: 60px !important; max-height: 60px !important; padding: 5px 4px !important; overflow: hidden !important; line-height: 1.2 !important;"
          data-sample_id="${task.sample_id || ''}"
          data-sample_name="${task.sample_name || ''}"
          data-sample_model="${task.sample_model || ''}"
          data-materialCode="${task.materialCode || ''}"
          data-sample_category="${task.sample_category || ''}"
          data-version="${task.version || ''}"
          data-priority="${task.priority || ''}"
          data-sample_leader="${task.sample_leader || ''}"
          data-supplier="${task.supplier || ''}"
          data-test_project_category="${task.test_project_category || ''}"
          data-test_projects="${task.test_projects || ''}"
          data-schedule="${task.schedule || ''}"
          data-create_time="${task.create_time || ''}"
          data-schedule_days="${task.schedule_days || ''}"
          data-sizecoding="${task.sizecoding || ''}"
          data-schedule_start_date="${task.schedule_start_date || ''}"
          data-schedule_end_date="${task.schedule_end_date || ''}"
          data-schedule_color="${task.schedule_color || ''}"
          data-remark="${task.remark || ''}"
          data-sample_sender="${task.sample_sender || ''}"
          data-sample_type="${task.sample_type || ''}"
          data-sample_quantity="${task.sample_quantity || ''}"
          data-high_frequency="${task.high_frequency || ''}"
          ${classAttribute}
          >${task.sizecoding} (${task.schedule_days}天)</td>
      `;
    }

    function handleContextMenuClick() {
        // 关闭右键菜单
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'none';
    }



    // 处理拖拽放下事件
    function handleDrop(cell, cellList, taskData, conflictCells ,projectsToMove ,diff ) {

        const { sample_id, days, sizecoding, tester, job_number, startDate, schedule_days, schedule_color } = taskData;

        const roundedDays = Math.ceil(parseFloat(schedule_days)); // 使用 schedule_days 确定合并单元格数量

        const rowCells = Array.from(cell.parentElement.querySelectorAll('.drop-cell'));
        const startIndex = rowCells.indexOf(cell);

        if (conflictCells.length > 0) {
            // 从后往前移动项目
            for (let i = projectsToMove.length - 1; i >= 0; i--) {
                const { startIndex: projectStartIndex, span, data } = projectsToMove[i];
                const newStartIndex = projectStartIndex + diff;
                console.log("项目起始位置: ", projectStartIndex);
                console.log("挪动的天数: ", diff);
                console.log("新的起始位置: ", newStartIndex);

                // 清除原项目
                const originalStartCell = rowCells[projectStartIndex];
                originalStartCell.innerText = '';
                originalStartCell.removeAttribute('colspan');
                originalStartCell.classList.remove('assigned');
                originalStartCell.style.backgroundColor = '';
                const allowedAttributes = ['class', 'data-tester', 'data-date'];
                [...originalStartCell.attributes].forEach(attr => {
                    if (!allowedAttributes.includes(attr.name)) {
                        originalStartCell.removeAttribute(attr.name);
                    }
                });

                // 恢复被隐藏的格子
                for (let j = projectStartIndex; j < projectStartIndex + span; j++) {
                    if (rowCells[j]) {
                        rowCells[j].style.display = '';
                        // 恢复周末样式
                        const date = rowCells[j].getAttribute('data-date');
                        setWeekendBorder(rowCells[j], date);
                    }
                }


                // 创建新项目
                const newStartCell = rowCells[newStartIndex];
                // newStartCell.innerText = `${data.sizecoding} (${data.schedule_days}天)`;
                // 判断是否有多个项目（dataX-sample_id）
                let displayText = `${data.sizecoding} (${data.schedule_days}天)`;
                let hasMultipleProjects = false;
                
                // 检查所有 dataX- 属性
                Object.keys(data).forEach(key => {
                    if (key.match(/^data\d+-sample_id$/)) {
                        hasMultipleProjects = true;
                        const match = key.match(/^data(\d+)-/);
                        if (match) {
                            const index = match[1];
                            const sizecoding = data[`data${index}-sizecoding`] || '';
                            const scheduleDays = data[`data${index}-schedule_days`] || '';
                            displayText += `|${sizecoding} (${scheduleDays}天)`;
                        }
                    }
                });
                
                newStartCell.innerText = displayText;

                newStartCell.classList.add('assigned');
                
                // 设置项目颜色，确保周末项目也能正确显示颜色
                if (data.schedule_color && data.schedule_color !== 'null') {
                    newStartCell.style.backgroundColor = data.schedule_color;
                    // 设置CSS变量，供CSS规则使用
                    newStartCell.style.setProperty('--project-color', data.schedule_color);
                    // 如果是周末单元格，强制设置颜色优先级
                    if (newStartCell.classList.contains('weekend-border')) {
                        newStartCell.style.setProperty('background-color', data.schedule_color, 'important');
                    }
                }
                
                newStartCell.setAttribute('colspan', span);
                // Object.keys(data).forEach(key => {
                //     if (key !== 'days') {
                //         newStartCell.setAttribute(`data-${key}`, data[key]);
                //     }
                // });


                Object.keys(data).forEach(key => {
                    if (key !== 'days') {
                        if (key.match(/^data\d+-/)) {
                            // 直接写入 dataX-xxx 属性（保持原样）
                            newStartCell.setAttribute(key, data[key]);
                        } else {
                            // 正常 data-xxx 属性
                            newStartCell.setAttribute(`data-${key}`, data[key]);
                        }
                    }
                });


                for (let j = newStartIndex + 1; j < newStartIndex + span; j++) {
                    rowCells[j].style.display = 'none';
                }
                // 更新 localScheduleChanges
                const newEndDate = rowCells[newStartIndex + span - 1].getAttribute('data-date');
                const newChange = {
                    change: "add",
                    sample_id: data.sample_id,
                    tester: data.tester,
                    start_date: rowCells[newStartIndex].getAttribute('data-date'),
                    end_date: newEndDate,
                    scheduleDays: data.schedule_days,
                    schedule_color: data.schedule_color,
                    job_number: data.job_number
                };

                const existingIndex = localScheduleChanges.findIndex(item =>
                    item.sample_id === data.sample_id
                );
                if (existingIndex !== -1) {
                    localScheduleChanges[existingIndex] = newChange;
                } else {
                    localScheduleChanges.push(newChange);
                }

                // 处理所有 dataX- 项目的变更记录
                Object.keys(data).forEach(key => {
                    if (key.match(/^data\d+-sample_id$/)) {
                        const match = key.match(/^data(\d+)-/);
                        if (match) {
                            const index = match[1];
                            const newChangeDataX = {
                                change: "add",
                                sample_id: data[`data${index}-sample_id`],
                                tester: data.tester,
                                start_date: rowCells[newStartIndex].getAttribute('data-date'),
                                end_date: newEndDate,
                                scheduleDays: data[`data${index}-schedule_days`],
                                schedule_color: data[`data${index}-schedule_color`],
                                job_number: data.job_number
                            };

                            const existingIndexDataX = localScheduleChanges.findIndex(item =>
                                item.sample_id === data[`data${index}-sample_id`]
                            );
                            if (existingIndexDataX !== -1) {
                                localScheduleChanges[existingIndexDataX] = newChangeDataX;
                            } else {
                                localScheduleChanges.push(newChangeDataX);
                            }
                        }
                    }
                });
                console.log("标记6",localScheduleChanges)

                // 添加允许拖拽的方法
                newStartCell.setAttribute('draggable', 'false'); // 禁用默认拖拽，使用双击拖拽
                newStartCell.addEventListener('dblclick', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // 收集拖拽数据
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                        'sample_sender', 'sample_type', 'sample_quantity', 'high_frequency'
                    ];
                    attributes.forEach(attr => {
                        taskData[`project-${attr}`] = this.getAttribute(`data-${attr}`);
                    });

                    dragData = taskData;
                    draggedElement = this;
                    isDragging = true;

                    // 创建拖拽预览元素
                    createDragPreview(this);

                    // 添加全局鼠标事件监听器
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('click', handleMouseClick);
                });
            }
        }

        // 如果是已有项目拖动进来，先清除原位置
        const oldIndex = rowCells.findIndex(c => c.getAttribute('data-sample_id') === sample_id);
        if (oldIndex !== -1) {
            const span = parseInt(rowCells[oldIndex].getAttribute('colspan') || 1, 10);

            rowCells[oldIndex].innerText = '';
            rowCells[oldIndex].removeAttribute('colspan');
            rowCells[oldIndex].classList.remove('assigned');
            rowCells[oldIndex].style.backgroundColor = '';
            const allowedAttributes = ['class', 'data-tester', 'data-date'];
            [...rowCells[oldIndex].attributes].forEach(attr => {
                if (!allowedAttributes.includes(attr.name)) {
                    rowCells[oldIndex].removeAttribute(attr.name);
                }
            });
            for (let i = oldIndex; i < oldIndex + span; i++) {
                if (rowCells[i]) {
                    rowCells[i].style.display = '';
                    // 恢复周末样式
                    const date = rowCells[i].getAttribute('data-date');
                    setWeekendBorder(rowCells[i], date);
                }
            }

            // 检查是否有其他项目需要重新设置 colspan
            const remainingScheduleDays = rowCells[oldIndex].getAttribute('data-schedule_days');
            if (remainingScheduleDays && remainingScheduleDays !== 'null') {
                rowCells[oldIndex].setAttribute('colspan', Math.ceil(parseFloat(remainingScheduleDays)));
                // 重新隐藏被合并的单元格
                for (let i = oldIndex + 1; i < oldIndex + Math.ceil(parseFloat(remainingScheduleDays)); i++) {
                    if (rowCells[i]) {
                        rowCells[i].style.display = 'none';
                    }
                }
            }
        }


        // 放置新插入的项目
        const startCell = rowCells[startIndex];
        startCell.innerText = `${sizecoding} (${schedule_days}天)`;
        startCell.classList.add('assigned');

        // 设置项目颜色，确保周末项目也能正确显示颜色
        if (schedule_color && schedule_color !== 'null') {
            startCell.style.backgroundColor = schedule_color;
            // 设置CSS变量，供CSS规则使用
            startCell.style.setProperty('--project-color', schedule_color);
            // 如果是周末单元格，强制设置颜色优先级
            if (startCell.classList.contains('weekend-border')) {
                startCell.style.setProperty('background-color', schedule_color, 'important');
            }
        }

        startCell.setAttribute('colspan', roundedDays);
        Object.keys(taskData).forEach(key => {
            if (key !== 'days') {
                startCell.setAttribute(`data-${key}`, taskData[key]);
            }
        });
        for (let i = startIndex + 1; i < startIndex + roundedDays; i++) {
            rowCells[i].style.display = 'none';
        }
        const projectEl = document.querySelector(`.project-card[data-sample_id="${sample_id}"]`);
        if (projectEl) projectEl.remove();

        const targetCell = rowCells[startIndex + roundedDays - 1];
        if (!targetCell) {
            console.warn("无效拖拽内容：请勿选择别的进行拖拽，忽略本次拖拽。");
            return;
        }

        const endDate = rowCells[startIndex + roundedDays - 1].getAttribute('data-date');
        // 构造新的变更对象
        const newChange = {
            change: "add",
            sample_id: sample_id,
            tester,
            start_date: startDate,
            end_date: endDate,
            scheduleDays: schedule_days,
            schedule_color: schedule_color,
            job_number: job_number
        };
        // 查找并更新已有记录（如果存在），否则添加
        const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
        );
        if (existingIndex !== -1) {
            localScheduleChanges[existingIndex] = newChange;
        } else {
            localScheduleChanges.push(newChange);
        }
        console.log("标记7",localScheduleChanges);
        // 重新为新生成的排期单元格添加拖拽功能
        startCell.setAttribute('draggable', 'false'); // 禁用默认拖拽，使用双击拖拽
        startCell.addEventListener('dblclick', function (e) {
            e.preventDefault();
            e.stopPropagation();

            // 收集拖拽数据
            const taskData = {};
            const attributes = [
                'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color' , 'remark',
                'sample_sender', 'sample_type', 'sample_quantity', 'high_frequency'
            ];
            attributes.forEach(attr => {
                taskData[`project-${attr}`] = this.getAttribute(`data-${attr}`);
            });

            dragData = taskData;
            draggedElement = this;
            isDragging = true;

            // 创建拖拽预览元素
            createDragPreview(this);

            // 添加全局鼠标事件监听器
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('click', handleMouseClick);
        });
    }


    // 处理撤回排期事件，撤回排期按钮触发这个方法
    function handleUndo(rowCells, startIndex, taskData, container, originalCell, isRenderCard = false) {
        const { schedule_days, sample_id } = taskData;
        const currentRightClickCell = rowCells[startIndex];

        let change = "delete";

        // 清除原始内容和属性
        currentRightClickCell.innerText = '';
        currentRightClickCell.removeAttribute('colspan');
        currentRightClickCell.classList.remove('assigned');

        const allowedAttributes = ['class', 'data-tester', 'data-date','data-job_number'];

        // 这里是负责把合并项目拖回去，恢复排期面板原来dataX数据
        // 判断是否含有 dataX- 开头标签的参数
        let hasDataXAttr = false;
        let maxDataIndex = 0;

        // 先保存原单元格的 innerText
        let originalInnerText = "";
        // 检查是否存在 dataX- 开头的属性
        if(originalCell){
            [...originalCell.attributes].forEach(attr => {
                if (attr.name.match(/^data\d+-/)) {
                    hasDataXAttr = true;
                    const match = attr.name.match(/^data(\d+)-/);
                    if (match) {
                        const index = parseInt(match[1]);
                        if (index > maxDataIndex) {
                            maxDataIndex = index;
                        }
                    }
                }
            });
            if (hasDataXAttr) {
                // 找到最大的索引，恢复对应的项目
                const sizecoding = originalCell.getAttribute(`data${maxDataIndex}-sizecoding`);
                const scheduleDays = originalCell.getAttribute(`data${maxDataIndex}-schedule_days`);
                originalInnerText = `${sizecoding} (${scheduleDays}天)`;
            }
            // 清除原单元格内容和属性
            originalCell.innerText = '';
            originalCell.removeAttribute('colspan');
            originalCell.classList.remove('assigned');
            originalCell.style.backgroundColor = '';

            // 恢复原单元格的 innerText
            originalCell.innerText = originalInnerText;

            // 重新设置 colspan 属性
            const scheduleDays = originalCell.getAttribute('data-schedule_days');
            if (scheduleDays && scheduleDays !== 'null') {
                originalCell.setAttribute('colspan', Math.ceil(parseFloat(scheduleDays)));
            }

            [...originalCell.attributes].forEach(attr => {
                const name = attr.name;

                if (name.match(/^data\d+-/)) {
                    const match = name.match(/^data(\d+)-/);
                    if (match) {
                        const index = match[1];
                        const newName = name.replace(`data${index}-`, 'data-');

                        // 如果要替换的属性是受保护的，不动它！
                        if (!allowedAttributes.includes(newName)) {
                            if (attr.value !== null && attr.value !== 'null') {
                                originalCell.setAttribute(newName, attr.value);
                            }
                            originalCell.removeAttribute(name);
                        } else {
                            // 是受保护属性，不替换也不删除
                            originalCell.removeAttribute(name);
                        }
                    }
                } else if (!allowedAttributes.includes(name)) {
                    // 普通非受保护属性，删除
                    originalCell.removeAttribute(name);
                }
            });

            if (hasDataXAttr) {
                // 重新设置可拖拽属性
                originalCell.setAttribute('draggable', 'false'); // 禁用默认拖拽，使用双击拖拽

                // 绑定双击拖拽事件
                originalCell.addEventListener('dblclick', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // 收集拖拽数据
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                        'sample_sender','sample_type','sample_quantity','high_frequency'
                    ];
                    attributes.forEach(attr => {
                        taskData[`project-${attr}`] = this.getAttribute(`data-${attr}`);
                    });

                    dragData = taskData;
                    draggedElement = this;
                    isDragging = true;

                    // 创建拖拽预览元素
                    createDragPreview(this);

                    // 添加全局鼠标事件监听器
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('click', handleMouseClick);
                });
            }

            // 获取颜色值并渲染单元格颜色
            const scheduleColor = originalCell.getAttribute('data-schedule_color');
            if (scheduleColor && scheduleColor !== 'null') {
                originalCell.style.backgroundColor = scheduleColor;
                // 设置CSS变量，供CSS规则使用
                originalCell.style.setProperty('--project-color', scheduleColor);
                // 如果是周末单元格，强制设置颜色优先级
                if (originalCell.classList.contains('weekend-border')) {
                    originalCell.style.setProperty('background-color', scheduleColor, 'important');
                }
            }

        }else{
            [...currentRightClickCell.attributes].forEach(attr => {
                if (!allowedAttributes.includes(attr.name)) {
                    currentRightClickCell.removeAttribute(attr.name);
                }
            });
        }


                    // 恢复被隐藏的格子
            for (let i = startIndex; i < Math.min(startIndex + Number(schedule_days), rowCells.length); i++) {
                if (rowCells[i]){
                    console.log("标记2");
                    rowCells[i].style.display = '';

                    const date = rowCells[i].getAttribute('data-date');
                    setWeekendBorder(rowCells[i], date);
                }
            }

            // 重新隐藏被合并的单元格（如果原单元格还有项目数据）
            const remainingScheduleDays = originalCell ? originalCell.getAttribute('data-schedule_days') : null;
            if (remainingScheduleDays && remainingScheduleDays !== 'null') {
                const newScheduleDays = Math.ceil(parseFloat(remainingScheduleDays));
                for (let i = startIndex + 1; i < startIndex + newScheduleDays; i++) {
                    if (rowCells[i]) {
                        rowCells[i].style.display = 'none';
                    }
                }
            }

        if(isRenderCard){
            change = "drop";

        }else{
            // 重新生成拖拽项目卡片
            const restoredProject = document.createElement('div');
            restoredProject.className = 'project-card';

            // ✅ 设置颜色 class（默认 gray）
            const colorClass = taskData.schedule_color || 'gray';
            restoredProject.classList.add(colorClass);

            restoredProject.setAttribute('draggable', 'true');
            restoredProject.setAttribute('data-sample_id', sample_id);
            restoredProject.setAttribute('data-schedule_days', schedule_days);
            //   这里
            restoredProject.textContent = `${taskData.sizecoding} (${schedule_days}天)`;

            //这里是撤回排期点击的时候，放回去的时候检查哪些标签去掉
            Object.keys(taskData).forEach(key => {
                if (key !== 'days' && key !== 'schedule_start_date' && key !== 'schedule_end_date' && key!== 'job_number'
                    && key!== 'tester') {
                    restoredProject.setAttribute(`data-${key}`, taskData[key]);
                }
            });

            setDraggable(restoredProject, true);

            const restoredItem = {
                sample_id: sample_id,
                sample_name: taskData.sample_name,
                sample_model: taskData.sample_model,
                materialCode: taskData.materialCode,
                sample_category: taskData.sample_category,
                version: taskData.version,
                priority: taskData.priority,
                sample_leader: taskData.sample_leader,
                supplier: taskData.supplier,
                testProjectCategory: taskData.test_project_category,
                testProjects: taskData.test_projects,
                schedule: taskData.schedule,
                create_time: taskData.create_time,
                scheduleDays: schedule_days,
                schedule_color: taskData.schedule_color,
                remark: taskData.remark,
                sample_sender: taskData.sample_sender,
                sample_type: taskData.sample_type,
                sample_quantity: taskData.sample_quantity,
                high_frequency: taskData.high_frequency
            };

            restoredProject.oncontextmenu = (event) => {
                event.preventDefault();
                bindCardContextMenu(restoredProject, restoredItem);
            };

            // 这里是排期面板拖拽项目到池子的容器存放区域，我接下来要判定放在哪个池子，0605
            container.appendChild(restoredProject);
        }






        // 记录删除操作到 localScheduleChanges，避免重复添加
        const newChange = {
            change: change,
            sample_id: sample_id,
            tester: taskData.tester,
            start_date: taskData.schedule_start_date,
            end_date: taskData.schedule_end_date,
            scheduleDays: schedule_days,
            schedule_color: taskData.schedule_color,
            job_number: taskData.job_number,
            container: container.id
        };

        const existingIndex = localScheduleChanges.findIndex(item =>
            item.sample_id === sample_id
        );

        if (existingIndex !== -1) {
            localScheduleChanges[existingIndex] = newChange;
        } else {
            localScheduleChanges.push(newChange);
        }

        console.log("delete的",localScheduleChanges);
    }
    // 工具函数：生成某范围内所有日期字符串数组
    function getDateRange(start, end) {
        const dates = [];
        const current = new Date(start);
        const last = new Date(end);
        while (current <= last) {
            const yyyy = current.getFullYear();
            const mm = String(current.getMonth() + 1).padStart(2, '0');
            const dd = String(current.getDate()).padStart(2, '0');
            dates.push(`${yyyy}-${mm}-${dd}`);
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }

    function showProjectAttributes(event) {
        if (event) {
            event.stopPropagation(); // 阻止事件冒泡
        }
        if (!currentRightClickCell) return;
        const taskData = {
            sample_id: currentRightClickCell.getAttribute('data-sample_id'),
            sample_name: currentRightClickCell.getAttribute('data-sample_name'),
            sample_model: currentRightClickCell.getAttribute('data-sample_model'),
            materialCode: currentRightClickCell.getAttribute('data-materialCode'),
            sample_category: currentRightClickCell.getAttribute('data-sample_category'),
            version: currentRightClickCell.getAttribute('data-version'),
            priority: currentRightClickCell.getAttribute('data-priority'),
            sample_leader: currentRightClickCell.getAttribute('data-sample_leader'),
            supplier: currentRightClickCell.getAttribute('data-supplier'),
            test_project_category: currentRightClickCell.getAttribute('data-test_project_category'),
            test_projects: currentRightClickCell.getAttribute('data-test_projects'),
            schedule: currentRightClickCell.getAttribute('data-schedule'),
            create_time: currentRightClickCell.getAttribute('data-create_time'),
            scheduleDays: currentRightClickCell.getAttribute('data-schedule_days'),
            schedule_color: currentRightClickCell.getAttribute('data-schedule_color'),
            remark: currentRightClickCell.getAttribute('data-remark'),
            sample_sender: currentRightClickCell.getAttribute('data-sample_sender'),
            sample_type: currentRightClickCell.getAttribute('data-sample_type'),
            sample_quantity: currentRightClickCell.getAttribute('data-sample_quantity'),
            high_frequency: currentRightClickCell.getAttribute('data-high_frequency')
        };

        // 设置模态框内容
        document.getElementById('modalBody').innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <p><strong>电气编号：</strong></p>
                <input type="text" id="editSampleId" value="${taskData.sample_id}">
                <button id="editSampleIdBtn">修改</button>
            </div>
            <p><strong>项目名称：</strong>${taskData.sample_name}</p>
            <p><strong>大小编码：</strong>${taskData.sample_model + ' ' + taskData.materialCode}</p>
            <p><strong>产品类别：</strong>${taskData.sample_category}</p>
            <p><strong>版本：</strong>${taskData.version}</p>
            <p><strong>优先级：</strong>${taskData.priority}</p>
            <p><strong>项目负责人：</strong>${taskData.sample_leader}</p>
            <p><strong>供应商：</strong>${taskData.supplier}</p>
            <p><strong>试验项目类别：</strong>${taskData.test_project_category}</p>
            <p><strong>测试子项目：</strong>${taskData.test_projects}</p>
            <p><strong>状态：</strong>${getScheduleText(taskData.schedule)}</p>
            <p><strong>送样人：</strong>${taskData.sample_sender}</p>
            <p><strong>送样类别：</strong>${taskData.sample_type}</p>
            <p><strong>送样数量：</strong>${taskData.sample_quantity}</p>
            <p><strong>是否高频：</strong>${taskData.high_frequency}</p>
            <p><strong>创建时间：</strong>${taskData.create_time}</p>
        `;

        document.getElementById('scheduleDays').value = taskData.scheduleDays != null ? taskData.scheduleDays : '';
        // 设置选中的颜色，默认选无色
        const selectedColor = taskData.schedule_color ? taskData.schedule_color : 'null';
        const colorRadio = document.querySelector(`input[name="schedule_color"][value="${selectedColor}"]`);
        if (colorRadio) {
            colorRadio.checked = true;
        }

        document.getElementById('sampleRemark').value = taskData.remark != null? taskData.remark : '';

        document.getElementById('saveScheduleBtn').onclick = function () {
            // 检查是否有多个项目合并
            let hasMultipleProjects = false;
            [...currentRightClickCell.attributes].forEach(attr => {
                if (attr.name.match(/^data\d+-sample_id$/)) {
                    hasMultipleProjects = true;
                }
            });

            if (hasMultipleProjects) {
                alert("这是多个相同天数项目合并的单元格，只允许先拆分再设置其他电气编号，排期天数、颜色和备注。");
                return; // 阻止后续操作
            }
            saveScheduleAndColor(null, taskData);
        };

        document.getElementById('confirmColorBtn').onclick = function () {
            // 检查是否有多个项目合并
            let hasMultipleProjects = false;
            [...currentRightClickCell.attributes].forEach(attr => {
                if (attr.name.match(/^data\d+-sample_id$/)) {
                    hasMultipleProjects = true;
                }
            });

            if (hasMultipleProjects) {
                alert("这是多个相同天数项目合并的单元格，只允许先拆分再设置其他电气编号，排期天数、颜色和备注。");
                return; // 阻止后续操作
            }
            saveScheduleAndColor(null, taskData);
        };

        document.getElementById('saveRemarkBtn').onclick = function () {
            // 检查是否有多个项目合并
            let hasMultipleProjects = false;
            [...currentRightClickCell.attributes].forEach(attr => {
                if (attr.name.match(/^data\d+-sample_id$/)) {
                    hasMultipleProjects = true;
                }
            });

            if (hasMultipleProjects) {
                alert("这是多个相同天数项目合并的单元格，只允许先拆分再设置其他电气编号，排期天数、颜色和备注。");
                return; // 阻止后续操作
            }
            saveScheduleAndColor(null, taskData);
        };

        document.getElementById('modal').style.display = 'block';

        // 关闭右键菜单
        const contextMenuForShow = document.getElementById('contextMenu');
        contextMenuForShow.style.display = 'none';

        // 绑定修改电气编号按钮点击事件
        document.getElementById('editSampleIdBtn').addEventListener('click', function () {
            const sampleId = currentRightClickCell.getAttribute('data1-sample_id');

            if (sampleId) {
                alert("这是多个相同天数项目合并的单元格，只允许先拆分再设置其他电气编号，排期天数、颜色和备注。");
                return; // 阻止后续操作
            }

            const newSampleId = document.getElementById('editSampleId').value;
            const oldSampleId = taskData.sample_id;

            // 发送请求到控制层
            fetch('/scheduleBoard/updateElectricSampleId', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldSampleId: oldSampleId,
                    newSampleId: newSampleId
                })
            })
                .then(response => response.json())
                .then(async result => {
                    if (result.success) {
                        alert(result.message);
                        // 刷新排期面板
                        await refreshSchedule();

                    } else {
                        alert(result.message);
                    }
                })
                .catch(error => {
                    console.error('修改电气编号时出错:', error);
                    alert('修改电气编号时出错，请稍后重试');
                });
        });

    }


    function getScheduleText(code) {
        switch (code) {
            case "15":
                return "待排期";
            case "16":
                return "已排期待测试";
            case "0":
                return "测试中";
            case "1":
                return "待审核";
            case "2":
                return "审核完成";
            case "9":
                return "样品退样";
            case "10":
                return "竞品完成";
            default:
                return code || "";
        }
    }



    // 绑定变更记录按钮点击事件
    document.addEventListener('DOMContentLoaded', function () {
        const changeLogBtn = document.getElementById('changeLogBtn');
        changeLogBtn.addEventListener('click', function () {
            // const sample_id = document.getElementById('modalBody').querySelector('p:nth-child(1)').textContent.split('：')[1].trim();
            const sample_id = document.getElementById('editSampleId').value.trim();

            fetch(`/api/getChangeLog?sample_id=${sample_id}`)
                .then(response => response.json())
                .then(data => {
                    const changeLogBody = document.getElementById('changeLogBody');
                    changeLogBody.innerHTML = '';

                    if (data.length === 0) {
                        changeLogBody.innerHTML = '暂无变更记录。';
                    } else {
                        const template = document.getElementById('changeLogTemplate').innerHTML;

                        data.forEach(change => {
                            let itemHTML = template
                                .replace('{{tester}}', change.tester)
                                .replace('{{startDate}}', change.startDate)
                                .replace('{{endDate}}', change.endDate)
                                .replace('{{updateTime}}', change.updateTime || '无')
                                .replaceAll('{{color}}', change.color)
                                .replace('{{used}}', change.used)
                                .replace('{{remark}}', change.remark)

                            changeLogBody.insertAdjacentHTML('beforeend', itemHTML);
                        });
                    }

                    document.getElementById('changeLogModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('获取变更记录失败:', error);
                    document.getElementById('changeLogBody').innerHTML = '获取变更记录失败，请稍后重试。';
                });
        });

    });



    // 加载待送样池子数据
    function loadPendingSamplePoolData() {
        const categories = [
            { id: 'videoSamplePool', name: '视频类' },
            { id: 'wireSamplePool', name: '数据线类' },
            { id: 'audioVideoWireSamplePool', name: '音视频线类' },
            { id: 'dataSamplePool', name: '数据类' },
            { id: 'bluetoothSamplePool', name: '蓝牙类' },
            { id: 'highFrequencySamplePool', name: '高频类' },
            { id: 'keyboardMouseSamplePool', name: '键鼠类' },
            { id: 'headphoneSamplePool', name: '耳机类' },
            { id: 'locatorSamplePool', name: '定位器类' },
            { id: 'ipcSamplePool', name: 'IPC类' }
        ];

        categories.forEach(category => {
            fetch(`/passback/getPendingSampleData?category=${category.name}`)
                .then(response => response.json())
                .then(data => {
                    renderPendingSamplePool(data, category.id);
                })
                .catch(error => {
                    // 如果后端接口不存在，为新的池子添加示例数据
                    if (error.message.includes('404') || error.message.includes('Not Found')) {
                        const sampleData = getSampleDataForCategory(category.name);
                        renderPendingSamplePool(sampleData, category.id);
                    } else {
                        document.getElementById(category.id).innerHTML = '加载失败，请稍后重试。';
                        console.error('Error fetching pending sample data:', error);
                    }
                });
        });
    }

    // 为新的池子类别提供示例数据
    function getSampleDataForCategory(categoryName) {
        const sampleData = {
            '数据线类': [
                { sample_id: 'DT001', sample_name: 'USB-C数据线', sample_model: 'USB-C', materialCode: 'DT001', sample_leader: '张三', scheduleDays: 2, schedule_color: 'green', remark: '高速传输' },
                { sample_id: 'DT002', sample_name: 'Type-C充电线', sample_model: 'Type-C', materialCode: 'DT002', sample_leader: '李四', scheduleDays: 1, schedule_color: 'yellow', remark: '快充支持' }
            ],
            '音视频线类': [
                { sample_id: 'AV001', sample_name: 'HDMI高清线', sample_model: 'HDMI', materialCode: 'AV001', sample_leader: '王五', scheduleDays: 3, schedule_color: 'blue', remark: '4K传输' },
                { sample_id: 'AV002', sample_name: '音频连接线', sample_model: 'AUDIO', materialCode: 'AV002', sample_leader: '赵六', scheduleDays: 1, schedule_color: 'gray', remark: '立体声' }
            ],
            '键鼠类': [
                { sample_id: 'KM001', sample_name: '无线键盘', sample_model: 'KB-WL', materialCode: 'KM001', sample_leader: '孙七', scheduleDays: 2, schedule_color: 'green', remark: '蓝牙连接' },
                { sample_id: 'KM002', sample_name: '游戏鼠标', sample_model: 'MS-GM', materialCode: 'KM002', sample_leader: '周八', scheduleDays: 1, schedule_color: 'red', remark: '高精度' }
            ],
            '耳机类': [
                { sample_id: 'HP001', sample_name: '蓝牙耳机', sample_model: 'HP-BT', materialCode: 'HP001', sample_leader: '吴九', scheduleDays: 2, schedule_color: 'blue', remark: '降噪功能' },
                { sample_id: 'HP002', sample_name: '有线耳机', sample_model: 'HP-WL', materialCode: 'HP002', sample_leader: '郑十', scheduleDays: 1, schedule_color: 'gray', remark: '高音质' }
            ],
            '定位器类': [
                { sample_id: 'LC001', sample_name: 'GPS定位器', sample_model: 'GPS-LC', materialCode: 'LC001', sample_leader: '钱一', scheduleDays: 3, schedule_color: 'green', remark: '高精度定位' },
                { sample_id: 'LC002', sample_name: '室内定位器', sample_model: 'IN-LC', materialCode: 'LC002', sample_leader: '孙二', scheduleDays: 2, schedule_color: 'yellow', remark: '室内导航' }
            ],
            'IPC类': [
                { sample_id: 'IPC001', sample_name: '网络摄像头', sample_model: 'IPC-NET', materialCode: 'IPC001', sample_leader: '李三', scheduleDays: 2, schedule_color: 'blue', remark: '高清监控' },
                { sample_id: 'IPC002', sample_name: '智能摄像头', sample_model: 'IPC-SMART', materialCode: 'IPC002', sample_leader: '王四', scheduleDays: 3, schedule_color: 'green', remark: 'AI识别' }
            ]
        };
        
        return sampleData[categoryName] || [];
    }

    // 渲染待送样池子
    function renderPendingSamplePool(data, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = '暂无该类别待送样数据。';
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'project-card';

            const scheduleColor = item.schedule_color || 'null';
            card.classList.add(scheduleColor);
            // card.textContent = item.sample_model + " " + item.materialCode + " " + item.sample_leader.charAt(0)  + " " + item.remark+ " " +"(" + item.scheduleDays + "天)";
            card.textContent =
                item.sample_model + " " +
                (item.materialCode?.length > 10 ? item.materialCode.substring(0, 10) + "..." : item.materialCode ?? "") + " " +
                item.sample_leader.charAt(0) + " " +
                (item.remark?.length > 10 ? item.remark.substring(0, 10) + "..." : item.remark ?? "") + " " +
                "(" + item.scheduleDays + "天)";


            card.setAttribute('data-sizecoding', item.sample_model + " " + formatRemark(item.materialCode) + " "+ item.sample_leader.charAt(0) + " " + formatRemark(item.remark) );
            card.setAttribute('data-sample_id', item.sample_id || '');
            card.setAttribute('data-sample_name', item.sample_name || '');
            card.setAttribute('data-sample_model', item.sample_model || '');
            card.setAttribute('data-materialCode', item.materialCode || '');
            card.setAttribute('data-sample_category', item.sample_category || '');
            card.setAttribute('data-version', item.version || '');
            card.setAttribute('data-priority', item.priority || '');
            card.setAttribute('data-sample_leader', item.sample_leader || '');
            card.setAttribute('data-supplier', item.supplier || '');
            card.setAttribute('data-test_project_category', item.testProjectCategory || '');
            card.setAttribute('data-test_projects', item.testProjects || '');
            card.setAttribute('data-schedule', item.schedule || '');
            card.setAttribute('data-create_time', item.create_time || '');
            // card.setAttribute('data-schedule_days', item.scheduleDays != null ? item.scheduleDays : '1');
            card.setAttribute('data-schedule_days', item.scheduleDays);
            card.setAttribute('data-schedule_color', item.schedule_color != null ? item.schedule_color : '');
            card.setAttribute('data-remark', item.remark != null ? item.remark : '');
            card.setAttribute('data-sample_sender', item.sample_sender != null ? item.sample_sender : '');
            card.setAttribute('data-sample_type', item.sample_type != null ? item.sample_type : '');
            card.setAttribute('data-sample_quantity', item.sample_quantity != null ? item.sample_quantity : '');
            card.setAttribute('data-high_frequency', item.high_frequency != null ? item.high_frequency : '');
            card.setAttribute('draggable', 'true');

            setDraggable(card, false);
            bindCardContextMenu(card, item);
            container.appendChild(card);
        });
    }

    // 通用函数，为指定容器添加拖拽相关事件
    // ... existing code ...
    function addDragEventsToContainers(containerIds) {
        containerIds.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                // 为容器添加 dragover 事件监听器，阻止默认行为以允许放置
                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    
                    // 获取排期表格容器
                    const scheduleContainer = document.querySelector('.schedule-table-container');
                    const mainTableContainer = document.querySelector('.main-table-container');
                    if (!scheduleContainer || !mainTableContainer) return;
                    
                    // 自动滚动逻辑 - 垂直和水平方向
                    const scrollSpeed = 10; // 滚动速度
                    const triggerDistance = 50; // 触发滚动的距离
                    const containerRect = scheduleContainer.getBoundingClientRect();
                    const { clientX, clientY } = e;

                    // 垂直方向自动滚动
                    // 靠近容器顶部，向上滚动
                    if (clientY < containerRect.top + triggerDistance) {
                        scheduleContainer.scrollTop -= scrollSpeed;
                    }
                    // 靠近容器底部，向下滚动
                    else if (clientY > containerRect.bottom - triggerDistance) {
                        scheduleContainer.scrollTop += scrollSpeed;
                    }
                    
                    // 同时支持window滚动（当鼠标在容器外时）
                    // 靠近页面顶部，向上滚动window
                    if (clientY < triggerDistance) {
                        window.scrollBy(0, -scrollSpeed);
                    }
                    // 靠近页面底部，向下滚动window
                    else if (clientY > window.innerHeight - triggerDistance) {
                        window.scrollBy(0, scrollSpeed);
                    }

                    // 水平方向自动滚动 - 使用主表格容器
                    // 靠近容器左侧，向左滚动
                    if (clientX < containerRect.left + triggerDistance) {
                        mainTableContainer.scrollLeft -= scrollSpeed;
                    }
                    // 靠近容器右侧，向右滚动
                    else if (clientX > containerRect.right - triggerDistance) {
                        mainTableContainer.scrollLeft += scrollSpeed;
                    }
                });

                // 为容器添加 drop 事件监听器，处理拖拽放下的逻辑
                container.addEventListener('drop', e => {
                    e.preventDefault();
                    console.log("拖11");
                    const taskData = {};
                    const attributes = [
                        'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                        'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                        'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                        'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark',
                        'sample_sender','sample_type','sample_quantity','high_frequency'
                    ];
                    attributes.forEach(attr => {
                        taskData[attr] = e.dataTransfer.getData(`project-${attr}`);
                    });

                    // 拦截拖拽空 sample_id 的情况
                    if (!taskData.sample_id || taskData.sample_id.trim() === "") {
                        console.warn("无效拖拽：sample_id 为空，忽略本次拖拽。");
                        return;
                    }


                    // 从原容器移除卡片
                    const fromContainerId = e.dataTransfer.getData('project-from_container');
                    if (fromContainerId) {
                        const fromContainer = document.getElementById(fromContainerId);
                        if (fromContainer) {
                            const existingCard = fromContainer.querySelector(`[data-sample_id="${taskData.sample_id}"]`);
                            if (existingCard) {
                                existingCard.remove();
                            }
                        }
                    }

                    // 从排期面板移除
                    const originalCell = document.querySelector(`td[data-sample_id="${taskData.sample_id}"]`);
                    if (originalCell) {
                        const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                        const originalStartIndex = originalRowCells.indexOf(originalCell);

                        handleUndo(originalRowCells, originalStartIndex, taskData, container,originalCell);
                    } else {
                        // 新增：检查目标容器是否已经存在该卡片
                        const existingCardInTarget = container.querySelector(`[data-sample_id="${taskData.sample_id}"]`);
                        if (existingCardInTarget) {
                            existingCardInTarget.remove();
                        }
                        // 直接从其他池子拖拽过来，创建新卡片
                        const newCard = document.createElement('div');
                        newCard.className = 'project-card';
                        const scheduleColor = taskData.schedule_color || 'null';
                        newCard.classList.add(scheduleColor);
                        newCard.textContent = `${taskData.sample_model} ${taskData.materialCode} ${taskData.sample_leader?.charAt(0)} ${taskData.remark} (${taskData.schedule_days}天)`;

                        Object.keys(taskData).forEach(key => {
                            if (key !== 'days' && key !== 'schedule_start_date' && key !== 'schedule_end_date' && key!== 'job_number' && key!== 'tester') {
                                newCard.setAttribute(`data-${key}`, taskData[key]);
                            }
                        });

                        newCard.setAttribute('draggable', 'true');
                        setDraggable(newCard, false);
                        bindCardContextMenu(newCard, taskData);
                        container.appendChild(newCard);

                        // 记录变更
                        const newChange = {
                            change: "delete",
                            sample_id: taskData.sample_id,
                            tester: taskData.tester,
                            start_date: taskData.schedule_start_date,
                            end_date: taskData.schedule_end_date,
                            scheduleDays: taskData.schedule_days,
                            schedule_color: taskData.schedule_color,
                            job_number: taskData.job_number,
                            container: container.id
                        };
                        const existingIndex = localScheduleChanges.findIndex(item =>
                            item.sample_id === taskData.sample_id
                        );
                        if (existingIndex !== -1) {
                            localScheduleChanges[existingIndex] = newChange;
                        } else {
                            localScheduleChanges.push(newChange);
                        }

                    }
                });

                // 为容器中的卡片添加 dragstart 事件，记录来源容器
                // container.addEventListener('dragstart', e => {
                //     const target = e.target.closest('.project-card');
                //     if (target) {
                //         e.dataTransfer.setData('project-from_container', container.id);
                //     }
                // });

                // 添加判断，禁止用户拖着文字
                container.addEventListener('dragstart', e => {
                    let target = e.target;

                    // 如果是文本节点，则获取其父元素
                    if (target.nodeType === Node.TEXT_NODE) {
                        target = target.parentElement;
                    }

                    // 只允许拖拽 project-card 元素，其他不允许
                    const card = target.closest('.project-card');

                    // 如果拖拽目标不是 .project-card，则不允许
                    if (!card || window.getSelection().toString().trim()) {
                        e.preventDefault(); // 阻止拖拽
                        console.log('只允许拖拽单个卡片，不能拖拽多项或文字！');
                        return;
                    }

                    e.dataTransfer.setData('project-from_container', container.id);
                });

            }
        });
    }

    // 在 DOM 加载完成后绑定按钮点击事件
    document.addEventListener('DOMContentLoaded', function () {
        const addProjectBtn = document.getElementById('addProjectBtn');
        const addProjectModal = document.getElementById('addProjectModal');
        const closeAddProjectModalBtn = document.getElementById('closeAddProjectModalBtn');
        const saveNewProjectBtn = document.getElementById('saveNewProjectBtn');
        const refreshColorBtn = document.getElementById('refreshColorBtn');

        refreshColorBtn.addEventListener('click', function () {
            if (!confirm('确定要刷新颜色吗？')) {
                return;
            }

            fetch('/scheduleBoardController/refreshColor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // 这里不用传 finalChanges
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        loadTestersData(); // 刷新表格数据
                    } else {
                        alert(result.message || '刷新颜色失败');
                    }
                })
                .catch(error => {
                    console.error('刷新颜色出错:', error);
                    alert('刷新颜色出错，请稍后重试');
                });
        });


        // 点击新增项目按钮显示模态框
        addProjectBtn.addEventListener('click', function () {
            addProjectModal.style.display = 'block';
        });

        // 点击关闭按钮隐藏模态框
        closeAddProjectModalBtn.addEventListener('click', function () {
            addProjectModal.style.display = 'none';
        });

        // 点击模态框外部隐藏模态框
        addProjectModal.addEventListener('click', function (e) {
            if (e.target === addProjectModal) {
                addProjectModal.style.display = 'none';
            }
        });

        // 保存新增项目
        saveNewProjectBtn.addEventListener('click', function () {
            const sample_name = document.getElementById('addSampleName').value.trim();
            const sample_model = document.getElementById('addSampleModel').value.trim();
            const materialCode = document.getElementById('addMaterialCode').value.trim();
            const sample_leader = document.getElementById('addSampleLeader').value.trim();
            const scheduleDays = document.getElementById('addScheduleDays').value.trim();

            // ✅ 校验前五项是否填写
            if (!sample_name || !sample_model || !materialCode || !sample_leader || !scheduleDays) {
                alert('请填写完整项目信息（前五项为必填）');
                return;
            }


            const newTaskData = {
                sample_name,
                sample_model,
                materialCode,
                sample_leader,
                scheduleDays,
                schedule_color: document.querySelector('input[name="addScheduleColor"]:checked').value,
                waitSample_classify: document.getElementById('addWaitSampleClassify').value,
                remark: document.getElementById('addSampleRemark').value
            };

            // 发送 POST 请求到后端
            fetch('/scheduleBoard/addProjectCard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newTaskData)
            })
                .then(response => response.json())
                .then(result => {

                    if (result.success) {
                        alert(result.message); // 项目添加成功
                        addProjectModal.style.display = 'none';
                        // 加载项目池子数据
                        loadProjectPoolData(); // ✅ 页面初始化调用加载函数
                        // 加载待送样池子数据
                        loadPendingSamplePoolData();

                    } else {
                        alert(result.message || '新增项目失败！'); // 项目新增失败
                    }
                })
                .catch(error => {
                    console.error('新增项目失败:', error);
                    alert('新增项目失败！');
                });


        });
    });

    function loadTrashListAndShowModal() {
        fetch('/scheduleBoard/getTrashList')
            .then(response => response.json())
            .then(trashedProjects => {
                const listModal = document.getElementById('trashListModal');
                const listContainer = document.getElementById('trashProjectList');
                listContainer.innerHTML = '';

                trashedProjects.forEach(project => {
                    const li = document.createElement('li');
                    li.textContent = project.sample_name;
                    li.style.cursor = 'pointer';
                    li.style.margin = '5px 0';
                    li.addEventListener('click', () => showProjectDetail(project));
                    listContainer.appendChild(li);
                });

                listModal.style.display = 'block';
            })
            .catch(error => {
                console.error("获取作废项目失败：", error);
                alert("加载作废项目失败");
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const trashStation = document.getElementById('trashStation');

        // 阻止 dragover 默认行为，允许放置（兼容传统拖拽）
        trashStation.addEventListener('dragover', function (e) {
            e.preventDefault();
            
            // 获取排期表格容器
            const scheduleContainer = document.querySelector('.schedule-table-container');
            const mainTableContainer = document.querySelector('.main-table-container');
            if (!scheduleContainer || !mainTableContainer) return;
            
            // 自动滚动逻辑 - 垂直和水平方向
            const scrollSpeed = 10; // 滚动速度
            const triggerDistance = 50; // 触发滚动的距离
            const containerRect = scheduleContainer.getBoundingClientRect();
            const { clientX, clientY } = e;

            // 垂直方向自动滚动
            // 靠近容器顶部，向上滚动
            if (clientY < containerRect.top + triggerDistance) {
                scheduleContainer.scrollTop -= scrollSpeed;
            }
            // 靠近容器底部，向下滚动
            else if (clientY > containerRect.bottom - triggerDistance) {
                scheduleContainer.scrollTop += scrollSpeed;
            }
            
            // 同时支持window滚动（当鼠标在容器外时）
            // 靠近页面顶部，向上滚动window
            if (clientY < triggerDistance) {
                window.scrollBy(0, -scrollSpeed);
            }
            // 靠近页面底部，向下滚动window
            else if (clientY > window.innerHeight - triggerDistance) {
                window.scrollBy(0, scrollSpeed);
            }

            // 水平方向自动滚动 - 使用主表格容器
            // 靠近容器左侧，向左滚动
            if (clientX < containerRect.left + triggerDistance) {
                mainTableContainer.scrollLeft -= scrollSpeed;
            }
            // 靠近容器右侧，向右滚动
            else if (clientX > containerRect.right - triggerDistance) {
                mainTableContainer.scrollLeft += scrollSpeed;
            }
        });

        // 处理 drop 事件（兼容传统拖拽）
        trashStation.addEventListener('drop', function (e) {
            e.preventDefault();
            handleTrashDrop(e.dataTransfer);
        });

        // 添加右键事件监听
        trashStation.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            loadTrashListAndShowModal();
        });
    });

    // 处理回收站放置的通用函数
    function handleTrashDrop(dataTransfer) {
        const sampleId = dataTransfer.getData('project-sample_id');

        if (sampleId) {
            if (!confirm("确定要删除该项目吗？")) {
                return;
            }

            // 调用删除接口
            deleteProject(sampleId, dataTransfer);

            // 从原容器移除卡片
            const fromContainerId = dataTransfer.getData('project-from_container');
            if (fromContainerId) {
                const fromContainer = document.getElementById(fromContainerId);
                if (fromContainer) {
                    const existingCard = fromContainer.querySelector(`[data-sample_id="${sampleId}"]`);
                    if (existingCard) {
                        existingCard.remove();
                        console.log(`已从池子 ${fromContainerId} 移除卡片 ${sampleId}`);
                    }
                }
            } else {
                // 如果没有 from_container 信息，尝试直接查找并移除卡片
                const poolIds = [
                    'projectPool',
                    'videoSamplePool',
                    'wireSamplePool',
                    'audioVideoWireSamplePool',
                    'dataSamplePool',
                    'bluetoothSamplePool',
                    'highFrequencySamplePool',
                    'keyboardMouseSamplePool',
                    'headphoneSamplePool',
                    'locatorSamplePool',
                    'ipcSamplePool'
                ];
                for (const poolId of poolIds) {
                    const pool = document.getElementById(poolId);
                    if (pool) {
                        const existingCard = pool.querySelector(`[data-sample_id="${sampleId}"]`);
                        if (existingCard) {
                            existingCard.remove();
                            console.log(`已从池子 ${poolId} 移除卡片 ${sampleId}`);
                            break;
                        }
                    }
                }
            }

            // 从排期面板移除
            const originalCell = document.querySelector(`td[data-sample_id="${sampleId}"]`);
            if (originalCell) {
                const originalRowCells = Array.from(originalCell.parentElement.querySelectorAll('.drop-cell'));
                const originalStartIndex = originalRowCells.indexOf(originalCell);
                const taskData = {};
                const attributes = [
                    'sample_id', 'days', 'sizecoding', 'tester', 'job_number', 'startDate', 'sample_name',
                    'sample_model', 'materialCode', 'sample_category', 'version', 'priority', 'sample_leader',
                    'supplier', 'test_project_category', 'test_projects', 'schedule', 'create_time',
                    'schedule_days', 'schedule_start_date', 'schedule_end_date', 'schedule_color', 'remark'
                ];
                attributes.forEach(attr => {
                    taskData[attr] = originalCell.getAttribute(`data-${attr}`);
                });
                // 新增一个参数，用来传递到方法里去判断是否需要渲染卡片
                const isRenderCard = true;
                handleUndo(originalRowCells, originalStartIndex, taskData, document.getElementById('projectPool'),originalCell,isRenderCard);
            }
        }
    }

    // 定义删除项目的函数，带确认框和可选的删除理由
    function deleteProject(sampleId, element ) {
        // 丢回收站的时候，多传一些数据作为变更记录
        const tester = element.getData('project-tester');
        const start_date = element.getData('project-schedule_start_date');
        const end_date = element.getData('project-schedule_end_date');
        const schedule_color = element.getData('project-schedule_color');
        const change = "drop";


        const reason = prompt("请输入删除理由（可选）：");

        fetch('/scheduleBoard/deleteProject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sample_id: sampleId,
                cancel_reason: reason ? reason.trim() : "", // 如果没有填写则传空字符串
                username: username,
                tester: tester,
                start_date: start_date,
                end_date: end_date,
                schedule_color: schedule_color,
                change: change
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    alert(result.message);
                } else {
                    alert(result.message || '项目删除失败');
                }
            })
            .catch(error => {
                console.error('删除项目时出错:', error);
                alert('删除项目时出错，请稍后重试');
            });
    }

    function showProjectDetail(project) {
        // 填充详情内容
        document.getElementById('detail_sample_id').textContent = project.sample_id;
        document.getElementById('detail_sample_name').textContent = project.sample_name;
        document.getElementById('detail_sizecoding').textContent = project.sample_model + " " + project.materialCode;
        document.getElementById('detail_sample_leader').textContent = project.sample_leader;
        document.getElementById('detail_scheduleDays').textContent = project.scheduleDays;
        document.getElementById('detail_schedule_color').textContent = project.schedule_color;
        document.getElementById('detail_waitSample_classify').textContent = project.waitSample_classify;
        document.getElementById('detail_remark').textContent = project.remark;
        document.getElementById('detail_cancel_by').textContent = project.cancel_by;
        document.getElementById('detail_job_number').textContent = project.cancel_code;
        document.getElementById('detail_cancel_date').textContent = project.cancel_date;
        document.getElementById('detail_cancel_reason').textContent = project.cancel_reason;

        // 显示详情弹窗
        document.getElementById('projectDetailModal').style.display = 'block';
    }

    function recoverProject() {
        const sampleId = document.getElementById('detail_sample_id').textContent;

        fetch('/scheduleBoard/recoverProject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ sample_id: sampleId })
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message || '恢复成功');
                document.getElementById('projectDetailModal').style.display = 'none';
                // 确保加载数据前清除可能的重复数据
                const projectPool = document.getElementById('projectPool');
                projectPool.innerHTML = ''; // 新增：清空项目池子内容
                const pendingSampleContainers = [
                    'videoSamplePool',
                    'wireSamplePool',
                    'audioVideoWireSamplePool',
                    'dataSamplePool',
                    'bluetoothSamplePool',
                    'highFrequencySamplePool',
                    'keyboardMouseSamplePool',
                    'headphoneSamplePool',
                    'locatorSamplePool',
                    'ipcSamplePool'
                ];
                pendingSampleContainers.forEach(id => {
                    const container = document.getElementById(id);
                    container.innerHTML = ''; // 新增：清空待送样池子内容
                });
                loadProjectPoolData();
                loadPendingSamplePoolData();

                loadTrashListAndShowModal();
            })
            .catch(error => {
                console.error('恢复失败:', error);
                alert('恢复失败');
            });
    }

    // 新增函数：格式化备注，限制为最多10个字符
    function formatRemark(remark) {
        if (!remark) return '';
        if (remark.length <= 10) return remark;
        return remark.substring(0, 10) + '...';
    }

    // 新增函数：设置周六和周日的边框样式
    function setWeekendBorder(cell, date) {
        const dateObj = new Date(date);
        const dayOfWeek = dateObj.getDay();
        const weekendClass = 'weekend-border'; // 定义周末类名

        // 检查是否为周末
        const isWeekend = dayOfWeek === 6 || dayOfWeek === 0;
        // 检查是否为节假日
        const isHoliday = holidays.some(h => h.holiday_date === date);

        if (isWeekend || isHoliday) {
            // console.log(`添加 ${weekendClass} 样式，日期: ${date}，原因: ${isWeekend ? '周末' : '节假日'}`);
            cell.classList.add(weekendClass);
        } else {
            cell.classList.remove(weekendClass);
        }
    }

    // 新增函数：高亮指定测试人员的行
    function highlightTesterRow(testerName) {
        // 更新全局高亮状态
        const previousTester = currentHighlightedTester;
        currentHighlightedTester = testerName;
        
        // 先清除所有行的高亮
        const allRows = document.querySelectorAll('.main-table-container #scheduleBoardTable tbody tr');
        allRows.forEach(row => {
            row.classList.remove('highlighted-row');
        });

        // 清除冻结列中所有行的高亮
        const allFrozenRows = document.querySelectorAll('#frozenTable tbody tr');
        allFrozenRows.forEach(row => {
            row.classList.remove('highlighted-row');
        });

        // 清除所有测试人员姓名的高亮
        const allTesterNames = document.querySelectorAll('.tester-name');
        allTesterNames.forEach(name => {
            name.classList.remove('highlighted-tester');
        });

        // 如果传入了测试人员姓名，则高亮对应行
        if (testerName) {
            // 找到对应的测试人员姓名元素并高亮
            const targetTesterNames = document.querySelectorAll(`.tester-name[data-tester="${testerName}"]`);
            targetTesterNames.forEach(name => {
                name.classList.add('highlighted-tester');
            });

            // 找到主表格中对应的行并高亮
            // 主表格中的行通过 data-tester 属性标识，而不是通过 .tester-name 元素
            const targetRow = document.querySelector(`.main-table-container #scheduleBoardTable tbody tr:has(td[data-tester="${testerName}"])`);
            if (targetRow) {
                targetRow.classList.add('highlighted-row');
            } else {
                // 备用方法：通过查找包含该测试人员 data-tester 属性的行
                allRows.forEach(row => {
                    const testerCell = row.querySelector(`td[data-tester="${testerName}"]`);
                    if (testerCell) {
                        row.classList.add('highlighted-row');
                    }
                });
            }

            // 找到冻结列中对应的行并高亮
            const targetFrozenRow = document.querySelector(`#frozenTable tbody tr:has(.tester-name[data-tester="${testerName}"])`);
            if (targetFrozenRow) {
                targetFrozenRow.classList.add('highlighted-row');
            } else {
                // 备用方法：通过查找包含该测试人员姓名的行
                allFrozenRows.forEach(row => {
                    const testerCell = row.querySelector(`.tester-name[data-tester="${testerName}"]`);
                    if (testerCell) {
                        row.classList.add('highlighted-row');
                    }
                });
            }
            
            console.log(`✅ 高亮测试人员: ${testerName}`);
        } else {
            console.log(`❌ 取消高亮，之前高亮的测试人员: ${previousTester}`);
        }
    }
    
    // 新增函数：检查是否应该保持高亮状态
    function shouldKeepHighlight(element) {
        // 检查元素是否在应该保持高亮的区域内
        const isInScheduleTable = element.closest('#scheduleBoardTable') || element.closest('#frozenTable');
        const isTesterName = element.classList.contains('tester-name');
        const isInProjectPool = element.closest('#projectPool');
        const isInPendingSampleContainer = element.closest('.pending-sample-container');
        const isInPoolContainer = element.closest('.pool-container');
        const isProjectCard = element.classList.contains('project-card') || element.classList.contains('pending-sample-card');
        const isInModal = element.closest('#modal') || element.closest('#addProjectModal') || element.closest('#searchModal') || element.closest('#changeRecordSearchModal');
        const isInButtonArea = element.closest('.schedule-controls') || element.closest('.schedule-board-header');
        
        const shouldKeep = isInScheduleTable || isTesterName || isInProjectPool || isInPendingSampleContainer || isInPoolContainer || isProjectCard || isInModal || isInButtonArea;
        
        // 调试信息
        if (currentHighlightedTester && !shouldKeep) {
            console.log(`🔍 点击元素: ${element.tagName}.${element.className} - 保持高亮: ${shouldKeep}`);
        }
        
        return shouldKeep;
    }

    // 页面加载完成后绑定事件
    document.addEventListener('DOMContentLoaded', function () {
        const manageHolidaysBtn = document.getElementById('manageHolidaysBtn');
        const holidayModalBackground = document.getElementById('holidayModalBackground');
        const holidayModal = document.getElementById('holidayModal');
        const closeHolidayModalBtn = document.getElementById('closeHolidayModalBtn');
        const addHolidayBtn = document.getElementById('addHolidayBtn');

        // 点击管理节假日按钮显示模态框
        manageHolidaysBtn.addEventListener('click', function () {
            loadHolidays();
            holidayModalBackground.style.display = 'block';
        });

        // 点击关闭按钮隐藏模态框
        closeHolidayModalBtn.addEventListener('click', function () {
            holidayModalBackground.style.display = 'none';
        });

        // 点击添加按钮添加节假日
        addHolidayBtn.addEventListener('click', function () {
            const newHolidayDate = document.getElementById('newHolidayDate').value;
            const newHolidayName = document.getElementById('newHolidayName').value;

            if (newHolidayDate && newHolidayName) {
                addHoliday(newHolidayDate, newHolidayName);
            } else {
                alert('请填写完整的日期和名称');
            }
        });

        // 点击背景层关闭模态框
        holidayModalBackground.addEventListener('click', function (e) {
            if (e.target === holidayModalBackground) {
                holidayModalBackground.style.display = 'none';
            }
        });
    });

    // 加载节假日数据（用于初始化）
    function loadHolidaysData() {
        fetch('/scheduleBoard/getHolidays')
            .then(response => response.json())
            .then(data => {
                holidays = data;
                console.log('节假日数据已加载:', holidays);
            })
            .catch(error => {
                console.error('加载节假日数据失败:', error);
                holidays = [];
            });
    }

    // 加载节假日列表（用于管理界面）
    function loadHolidays() {
        fetch('/scheduleBoard/getHolidays')
            .then(response => response.json())
            .then(data => {
                const holidayList = document.getElementById('holidayList');
                holidayList.innerHTML = '';

                data.forEach(holiday => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '5px';

                    const dateSpan = document.createElement('span');
                    dateSpan.textContent = holiday.holiday_date;
                    dateSpan.style.marginRight = '10px';

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = holiday.holiday_name;
                    nameSpan.style.marginRight = '10px';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '删除';
                    deleteBtn.addEventListener('click', function () {

                        deleteHoliday(holiday.id);
                    });

                    div.appendChild(dateSpan);
                    div.appendChild(nameSpan);
                    div.appendChild(deleteBtn);
                    holidayList.appendChild(div);
                });
            })
            .catch(error => {
                console.error('加载节假日列表失败:', error);
            });
    }


    // 添加节假日
    function addHoliday(date, name) {
        fetch('/scheduleBoard/addHoliday', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                holiday_date: date,
                holiday_name: name
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('添加成功');
                    // 假设 holidays 是全局变量，用于存储节假日信息
                    if (!window.holidays) {
                        window.holidays = [];
                    }
                    const existingIndex = holidays.findIndex(holiday => holiday.holiday_date === date);
                    if (existingIndex !== -1) {
                        // 日期已存在，进行更新
                        holidays[existingIndex] = {
                            holiday_date: date,
                            holiday_name: name,
                            ...data
                        };
                    } else {
                        // 日期不存在，添加新的节假日
                        holidays.push({
                            holiday_date: date,
                            holiday_name: name,
                            ...data
                        });
                    }
                    loadHolidays();
                    // 移除清空日期输入框的代码，仅清空名称输入框
                    // document.getElementById('newHolidayName').value = '';
                } else {
                    alert('添加失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('添加节假日失败:', error);
                alert('添加节假日失败，请稍后重试');
            });
    }
    // 删除节假日
    function deleteHoliday(id) {
        if (confirm('确定要删除这个节假日吗？')) {
            fetch('/scheduleBoard/deleteHoliday', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: id
                })
            })
                .then(response => {
                    // 检查响应状态是否正常
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('删除成功');
                        // 更新全局变量 holidays
                        holidays = holidays.filter(holiday => holiday.id !== id);
                        // 加载节假日列表，不操作输入框
                        loadHolidays();
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('删除节假日失败:', error);
                    alert('删除节假日失败，请稍后重试');
                });
        }
    }

    // 在页面加载完成时获取节假日数据
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            // 发起请求获取节假日数据
            const response = await fetch('/scheduleBoard/getHolidays');
            // 检查响应状态是否正常
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // 将响应数据解析为 JSON 格式并赋值给 holidays 变量
            holidays = await response.json();
        } catch (error) {
            console.error('获取节假日数据失败:', error);
        }
    });


    // 显示管理测试人员模态框
    function showManageTestersModal() {
        loadTestersData();
        document.getElementById('manageTestersOverlay').style.display = 'block';
        document.getElementById('manageTestersModal').style.display = 'block';
    }

    // 加载测试人员数据
    function loadTestersData() {
        fetch('/scheduleBoardController/getTestEngineers')
            .then(response => response.json())
            .then(data => {
                const testersTableBody = document.getElementById('testersTableBody');
                testersTableBody.innerHTML = '';

                // 按负责的品类分组
                const groupedTesters = {};
                data.forEach(tester => {
                    const category = tester.responsible_category || '未分组';
                    if (!groupedTesters[category]) {
                        groupedTesters[category] = [];
                    }
                    groupedTesters[category].push(tester);
                });

                // 遍历每个分组
                for (const category in groupedTesters) {
                    // 添加分组标题行
                    const groupRow = document.createElement('tr');
                    groupRow.innerHTML = `
                        <td colspan="8" style="background-color: #f0f0f0; font-weight: bold;">${category}</td>
                    `;
                    testersTableBody.appendChild(groupRow);

                    // 添加该分组下的测试人员数据
                    groupedTesters[category].forEach(tester => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${tester.engineer_id}</td>
                            <td>${tester.test_engineer_name}</td>
                            <td>${tester.hire_date}</td>
                            <td><span class="editable-field" data-field="responsible_category" data-test_engineer_name="${tester.test_engineer_name}">${tester.responsible_category || '/'}</span></td>
                            <td><span class="editable-field" data-field="skill_description" data-test_engineer_name="${tester.test_engineer_name}">${tester.skill_description || '/'}</span></td>
                            <td><span class="editable-field" data-field="skill_improvernment" data-test_engineer_name="${tester.test_engineer_name}">${tester.skill_improvernment || '/'}</span></td>
                            <td><span class="editable-field" data-field="current_skill_level" data-test_engineer_name="${tester.test_engineer_name}">${tester.current_skill_level || '/'}</span></td>
                            <td>
                                <button id="deleteTestBtn" onclick="deleteTester('${tester.test_engineer_name}')">删除</button>
                            </td>
                        `;
                        testersTableBody.appendChild(row);
                    });
                }

                // 为可编辑字段添加点击事件监听器
                const editableFields = document.querySelectorAll('.editable-field');
                editableFields.forEach(field => {
                    field.addEventListener('click', function () {
                        makeEditable(this);
                    });
                });
            })
            .catch(error => {
                console.error('加载测试人员数据失败:', error);
            });
    }


    // 关闭管理测试人员模态框
    function closeManageTestersModal() {
        document.getElementById('manageTestersOverlay').style.display = 'none';
        document.getElementById('manageTestersModal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const closeManageTestersModalBtn = document.getElementById('closeManageTestersModalBtn');
        const manageTestersOverlay = document.getElementById('manageTestersOverlay');

        // 点击关闭按钮隐藏模态框
        closeManageTestersModalBtn.addEventListener('click', closeManageTestersModal);

        // 点击遮罩层隐藏模态框
        manageTestersOverlay.addEventListener('click', closeManageTestersModal);
    });

    //把同名的数据合并到同一个对象里
    function mergePendingChanges(pendingChanges) {
        const mergedChanges = {};

        pendingChanges.forEach(change => {
            const { test_engineer_name, field, value } = change;
            if (!mergedChanges[test_engineer_name]) {
                mergedChanges[test_engineer_name] = { test_engineer_name };
            }
            mergedChanges[test_engineer_name][field] = value;
        });

        return Object.values(mergedChanges);
    }

    function makeEditable(element) {
        const fieldName = element.dataset.field;
        const test_engineer_name = element.dataset.test_engineer_name;
        const originalValue = element.textContent;
        let inputElement;

        if (fieldName === 'current_skill_level') {
            inputElement = document.createElement('input');
            inputElement.type = 'text';
        } else {
            inputElement = document.createElement('textarea');
        }

        inputElement.value = originalValue;
        inputElement.className = 'editing';

        // 替换元素
        element.parentNode.replaceChild(inputElement, element);
        inputElement.focus();

        // 保存修改到暂存数组
        const saveToPending = () => {
            const newValue = inputElement.value;
            if (newValue !== originalValue) {
                // 检查是否已有相同工程师和字段的修改，有则更新
                const existingIndex = pendingChanges.findIndex(change =>
                    change.test_engineer_name === test_engineer_name && change.field === fieldName
                );
                if (existingIndex !== -1) {
                    pendingChanges[existingIndex].value = newValue;
                } else {
                    pendingChanges.push({
                        test_engineer_name: test_engineer_name,
                        field: fieldName,
                        value: newValue
                    });
                }
            }
            // 重新创建文本节点
            const newSpan = document.createElement('span');
            newSpan.className = 'editable-field';
            newSpan.dataset.field = fieldName;
            newSpan.dataset.test_engineer_name = test_engineer_name;
            newSpan.textContent = newValue;
            newSpan.addEventListener('click', function () {
                makeEditable(this);
            });
            inputElement.parentNode.replaceChild(newSpan, inputElement);
        };

        // 失去焦点时保存到暂存数组
        inputElement.addEventListener('blur', saveToPending);

        // // 按下回车键时保存到暂存数组
        // inputElement.addEventListener('keydown', function (event) {
        //     if (event.key === 'Enter') {
        //         event.preventDefault();
        //         saveToPending();
        //     }
        // });
    }

    document.addEventListener('DOMContentLoaded', function () {

        const saveTesterChangesBtn = document.getElementById('saveTesterChangesBtn');
        saveTesterChangesBtn.addEventListener('click', function () {
            if (pendingChanges.length > 0) {
                const mergedData = {};

                pendingChanges.forEach(item => {
                    const name = item.test_engineer_name;
                    if (!mergedData[name]) {
                        mergedData[name] = { test_engineer_name: name };
                    }
                    // 将 field 作为属性名，value 作为属性值添加到对象中
                    mergedData[name][item.field] = item.value;
                });

                const finalChanges = Object.values(mergedData);

                fetch('/scheduleBoardController/updateTesterInfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(finalChanges)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(result.message);
                            loadTestersData(); // 重新加载数据
                            pendingChanges = []; // 清空暂存数组
                        } else {
                            alert(result.message || '保存修改失败');
                        }
                    })
                    .catch(error => {
                        console.error('保存修改时出错:', error);
                        alert('保存修改时出错，请稍后重试');
                    });
            } else {
                alert('没有需要保存的修改');
            }
        });
    });

    // 封装保存新增测试人员的方法
    function saveNewTester() {
        const testerName = document.getElementById('addTesterName').value.trim();
        const testerGroup = document.getElementById('addTesterGroup').value.trim();
        const testerSkillDesc = document.getElementById('addTesterSkillDesc').value.trim();
        const testerSkillImprove = document.getElementById('addTesterSkillImprove').value.trim();
        const testerSkillLevel = document.getElementById('addTesterSkillLevel').value.trim();

        // 校验必填项
        if (!testerName || !testerGroup) {
            alert('请填写完整必填信息（测试人员姓名和负责组别）');
            return;
        }

        const newTesterData = {
            test_engineer_name: testerName,
            responsible_category: testerGroup,
            skill_description: testerSkillDesc,
            skill_improvernment: testerSkillImprove,
            current_skill_level: testerSkillLevel
        };

        // 发送 POST 请求到后端
        fetch('/scheduleBoardController/addTesterInfo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newTesterData)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message); // 测试人员添加成功
                    // 这里可以添加刷新测试人员列表等逻辑
                    showManageTestersModal();
                } else {
                    alert(result.message || '新增测试人员失败！'); // 测试人员新增失败
                }
            })
            .catch(error => {
                console.error('新增测试人员失败:', error);
                alert('新增测试人员失败！');
            });
    }

    document.addEventListener('DOMContentLoaded', function () {

        const addNewTesterBtn = document.getElementById('addNewTesterBtn');

        // 新增测试人员模态框相关元素
        const addTesterModal = document.getElementById('addTesterModal');
        const closeAddTesterModalBtn = document.getElementById('closeAddTesterModalBtn');
        const saveNewTesterBtn = document.getElementById('saveNewTesterBtn');


        // 点击新增测试人员按钮显示新增测试人员模态框
        addNewTesterBtn.addEventListener('click', function () {
            addTesterModal.style.display = 'block';
        });

        // 点击关闭按钮隐藏新增测试人员模态框
        closeAddTesterModalBtn.addEventListener('click', function () {
            addTesterModal.style.display = 'none';
        });

        // 点击模态框外部隐藏新增测试人员模态框
        addTesterModal.addEventListener('click', function (e) {
            if (e.target === addTesterModal) {
                addTesterModal.style.display = 'none';
            }
        });

        // 封装保存新增测试人员的方法


        // 保存新增测试人员按钮绑定方法
        saveNewTesterBtn.addEventListener('click', saveNewTester);
    });

    // 删除测试人员的方法
    async function deleteTester(test_engineer_name) {
        if (!confirm("确定要删除该测试人员吗？")) {
            return;
        }

        try {
            const response = await fetch('/scheduleBoardController/deleteTester', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_engineer_name: test_engineer_name
                })
            });

            if (!response.ok) {
                throw new Error(`删除失败: ${response.statusText}`);
            }

            const result = await response.json();
            alert(result.message);
            showManageTestersModal();


        } catch (error) {
            console.error('删除测试人员失败:', error);
            alert('删除测试人员失败，请稍后重试！');
        }
    }


    // 在 DOM 加载完成后绑定按钮点击事件
    document.addEventListener('DOMContentLoaded', function () {
        const manageGroupBtn = document.getElementById('manageGroupBtn');
        const manageGroupModal = document.getElementById('manageGroupModal');
        const closeManageGroupModalBtn = document.getElementById('closeManageGroupModalBtn');
        const saveGroupSettingsBtn = document.getElementById('saveGroupSettingsBtn');

        // 点击管理展示的组按钮显示模态框
        manageGroupBtn.addEventListener('click', function () {
            loadGroupData();
            manageGroupModal.style.display = 'block';
        });

        // 点击关闭按钮隐藏模态框
        closeManageGroupModalBtn.addEventListener('click', function () {
            manageGroupModal.style.display = 'none';
        });

        // 点击模态框外部隐藏模态框
        manageGroupModal.addEventListener('click', function (e) {
            if (e.target === manageGroupModal) {
                manageGroupModal.style.display = 'none';
            }
        });

        // 保存组设置
        saveGroupSettingsBtn.addEventListener('click', function () {
            const groupSettings = [];
            const rows = document.querySelectorAll('#groupTable tbody tr');
            rows.forEach((row, index) => {
                const id = row.querySelector('td:nth-child(1)').textContent;
                const name = row.querySelector('td:nth-child(2)').textContent;
                const is_displayed = row.querySelector('input[type="checkbox"]').checked;
                const displayOrderInput = row.querySelector('input[type="number"]');
                const display_order = parseInt(displayOrderInput.value, 10) || 0; // fallback 为 0
                groupSettings.push({
                    id: id,
                    display_order: display_order,
                    is_displayed: is_displayed,
                    name: name
                });
            });

            // 只生成显示的组名数组作为排序
            groupOrder = groupSettings
                .filter(g => g.is_displayed)
                .sort((a, b) => a.display_order - b.display_order)
                .map(g => g.name);

            // 发送请求到后端保存设置
            fetch('/scheduleBoardController/saveGroupSettings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(groupSettings)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                    } else {
                        alert(result.message || '保存组设置失败！');
                    }
                })
                .catch(error => {
                    console.error('保存组设置失败:', error);
                    alert('保存组设置失败！');
                });
        });
    });

    // 加载组数据
    function loadGroupData() {
        fetch('/scheduleBoardController/getGroupData')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#groupTable tbody');
                tableBody.innerHTML = '';

                data.forEach(group => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${group.id}</td>
                    <td>${group.name}</td>
                    <td><input type="checkbox" ${group.is_displayed ? 'checked' : ''}></td>
                    <td><input type="number" value="${group.display_order}" class="display-order-input small-input" data-group-id="${group.id}"></td>
                    <td><button class="delete-group-btn" data-group-id="${group.id}">删除</button></td>
                `;
                    tableBody.appendChild(row);
                });

                // 为每个删除按钮绑定事件
                document.querySelectorAll('.delete-group-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const groupId = this.getAttribute('data-group-id');
                        deleteGroup(groupId);
                    });
                });
            })
            .catch(error => {
                console.error('加载组数据失败:', error);
                alert('加载组数据失败，请稍后重试。');
            });
    }


    // 删除组的按钮
    function deleteGroup(groupId) {
        if (!confirm('确定要删除这个组别吗？')) return;

        fetch(`/scheduleBoardController/deleteGroup/${groupId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    alert('组别删除成功！');
                    loadGroupData(); // 重新加载数据
                } else {
                    alert('删除失败，请稍后再试。');
                }
            })
            .catch(error => {
                console.error('删除组别失败:', error);
                alert('删除组别失败，请稍后重试。');
            });
    }



    document.getElementById('addGroupBtn').addEventListener('click', async function () {
        const name = document.getElementById('newGroupName').value.trim();
        const display = document.getElementById('newGroupDisplay').value === 'true';
        const order = document.getElementById('newGroupOrder').value.trim();

        if (!name || !order) {
            alert("请填写完整的组信息！");
            return;
        }

        // 1. 先检查表格中是否已有同名组
        const existingNames = Array.from(document.querySelectorAll('#groupTable tbody tr td:nth-child(2)'))
            .map(td => td.textContent.trim().toLowerCase());
        if (existingNames.includes(name.toLowerCase())) {
            alert("该组别名称已存在（本地）！");
            return;
        }

        // 3. 构造新组数据对象
        const newGroup = {
            name: name,
            is_displayed: display,
            display_order: parseInt(order)
        };

        // 4. 提交到后端接口
        try {
            const addResponse = await fetch('/scheduleBoardController/addGroup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newGroup)
            });

            const result = await addResponse.text();
            if (result === '新增成功') {
                // 插入新行到表格
                const tbody = document.querySelector('#groupTable tbody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                <td>（自动生成）</td>
                <td>${name}</td>
                <td><input type="checkbox" ${display ? 'checked' : ''}></td>
                <td><input type="number" value="${order}" style="width: 80px;"></td>
            `;
                tbody.appendChild(newRow);

                // 清空输入框
                // document.getElementById('newGroupName').value = '';
                // document.getElementById('newGroupDisplay').value = 'true';
                // document.getElementById('newGroupOrder').value = '';

                alert("新增成功！");
            } else {
                alert("后端添加失败：" + result);
            }
        } catch (err) {
            console.error("提交失败", err);
            alert("提交数据时出错！");
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const searchBtn = document.getElementById('searchBtn');
        const searchModal = document.getElementById('searchModal');
        const closeSearchModalBtn = document.getElementById('closeSearchModalBtn');
        const executeSearchBtn = document.getElementById('executeSearchBtn');

        const modalContent = document.getElementById('searchModalContent');
        const overlay = document.getElementById('searchModalOverlay');

        // 打开模态框时显示遮罩和模态框（你自己调用）
        function openSearchModal() {
            overlay.style.display = 'block';
            searchModal.style.display = 'block';
        }

        // 关闭模态框和遮罩
        function closeSearchModal() {
            overlay.style.display = 'none';
            searchModal.style.display = 'none';
        }

        // 点击遮罩关闭
        overlay.addEventListener('click', closeSearchModal);

        // 关闭按钮
        closeSearchModalBtn.addEventListener('click', closeSearchModal);



        // 点击搜索按钮显示模态框
        searchBtn.addEventListener('click', function () {
            // searchModal.style.display = 'block';
            openSearchModal();
        });

        // 点击关闭按钮隐藏模态框
        closeSearchModalBtn.addEventListener('click', function () {
            // searchModal.style.display = 'none';
            closeSearchModal();
        });

        // 点击模态框外部隐藏模态框
        searchModal.addEventListener('click', function (e) {
            if (e.target === searchModal) {
                searchModal.style.display = 'none';
            }
        });

        // 执行搜索
        executeSearchBtn.addEventListener('click', function () {
            const sampleId = document.getElementById('searchSampleId').value;
            const sampleModel = document.getElementById('searchSampleModel').value;
            const tester = document.getElementById('searchTester').value;

            // 发送搜索请求
            fetch('/scheduleBoardController/searchProjects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sampleId: sampleId,
                    sampleModel: sampleModel,
                    tester: tester
                })
            })
                .then(response => response.json())
                .then(data => {
                    const resultsContainer = document.getElementById('searchResults');
                    resultsContainer.innerHTML = '';

                    if (data.length === 0) {
                        resultsContainer.innerHTML = '暂无搜索结果。';
                    } else {
                        let html = '<table border="1">';
                        html += `
                        <thead>
                            <tr>
                                <th>电气编号</th>
                                <th>大小编码</th>
                                <th>预计排期开始时间</th>
                                <th>预计排期结束时间</th>
                                <th>排期天数</th>
                                <th>测试人</th>
                                <th>实际测试开始时间</th>
                                <th>实际测试结束时间</th>
                                <th>实测时长</th>
                                <th>报告审核时间</th>
                                <th>样品承认结果</th>
                                <th>排期颜色</th>
                                <th>是否作废</th>
                            </tr>
                        </thead>
                        `;
                        html += '<tbody>';
                        data.forEach(item => {
                            const startDate = item.schedule_start_date ? item.schedule_start_date.split('T')[0] : '';
                            const endDate = item.schedule_end_date ? item.schedule_end_date.split('T')[0] : '';

                            html += `<tr>
                                <td>${item.sample_id}</td>
                                <td>${item.sample_model} ${item.materialCode || ''}</td>
                                <td>${startDate}</td>
                                <td>${endDate}</td>
                                <td>${item.scheduleDays}</td>
                                <td>${item.tester}</td>
                                <td>${item.actual_start_time}</td>
                                <td>${item.actual_finish_time}</td>
                                <td>${item.testDuration}</td>
                                <td>${item.reportReviewTime}</td>
                                <td>${item.sampleRecognizeResult}</td>
                                <td style="background-color: ${item.schedule_color};">${item.schedule_color}</td>
                                <td>${item.isCancel}</td>
                            </tr>`;
                        });

                        html += '</tbody></table>';
                        resultsContainer.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('搜索失败:', error);
                    document.getElementById('searchResults').innerHTML = '搜索失败，请稍后重试。';
                });
        });

        // 变更记录搜索看板相关功能
        const changeRecordSearchBtn = document.getElementById('changeRecordSearchBtn');
        const changeRecordSearchModal = document.getElementById('changeRecordSearchModal');
        const closeChangeRecordSearchModal = document.getElementById('closeChangeRecordSearchModal');
        const changeRecordSearchForm = document.getElementById('changeRecordSearchForm');

        // 变更记录搜索看板按钮点击事件
        changeRecordSearchBtn.addEventListener('click', function() {
            changeRecordSearchModal.style.display = 'block';
            // 设置默认日期范围（最近30天）
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('changeRecordStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('changeRecordEndDate').value = today.toISOString().split('T')[0];
        });

        // 关闭变更记录搜索看板模态框
        closeChangeRecordSearchModal.addEventListener('click', function() {
            changeRecordSearchModal.style.display = 'none';
        });

        // 点击模态框外部关闭
        changeRecordSearchModal.addEventListener('click', function(e) {
            if (e.target === changeRecordSearchModal) {
                changeRecordSearchModal.style.display = 'none';
            }
        });

        // 变更记录搜索表单提交事件
        changeRecordSearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            performChangeRecordSearch();
        });
    });

    // 变更记录搜索相关变量
    let changeRecordCurrentPage = 1;
    const changeRecordPageSize = 10;
    let changeRecordAllResults = [];
    let changeRecordCurrentResults = [];

    // 执行变更记录搜索
    function performChangeRecordSearch() {
        const formData = {
            ETTestCode: document.getElementById('changeRecordETTestCode').value,
            sampleModel: document.getElementById('changeRecordModel').value,
            sampleCategory: document.getElementById('changeRecordCategory').value,
            sampleLeader: document.getElementById('changeRecordLeader').value,
            sampleSender: document.getElementById('changeRecordSender').value,

            tester: document.getElementById('changeRecordTester').value,
            startDate: document.getElementById('changeRecordStartDate').value,
            endDate: document.getElementById('changeRecordEndDate').value,
            isUsed: document.getElementById('changeRecordIsUsed').value,
            isCancel: document.getElementById('changeRecordIsCancel').value,

            schedule: document.getElementById('changeRecordSchedule').value,
            remark: document.getElementById('changeRecordRemark').value,
            dateRangeStart: document.getElementById('changeRecordStartDate2').value,
            dateRangeEnd: document.getElementById('changeRecordEndDate2').value,
            changeRecordRemark: document.getElementById('changeRecordRemark2').value
        };

        // 显示加载状态
        document.getElementById('changeRecordResultsPanel').style.display = 'block';
        document.getElementById('changeRecordResultsTableBody').innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 40px; color: #6c757d;">🔍 正在搜索中...</td></tr>';

        // 优先使用新的搜索接口，如果失败则回退到旧接口
        fetch('/scheduleBoardController/searchByChangeRecordNew', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('新接口响应状态:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`新接口请求失败: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('变更记录搜索返回的数据:', data);
            changeRecordAllResults = data;
            changeRecordCurrentPage = 1;
            displayChangeRecordResults();
        })
        .catch(error => {
            console.warn('新接口不可用，尝试使用旧接口:', error);
            // 回退到旧接口
            return fetch('/scheduleBoardController/searchByChangeRecord', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`旧接口请求失败: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('旧接口变更记录搜索返回的数据:', data);
                changeRecordAllResults = data;
                changeRecordCurrentPage = 1;
                displayChangeRecordResults();
            })
            .catch(oldError => {
                console.error('旧接口也失败了:', oldError);
                throw oldError; // 重新抛出错误，让外层catch处理
            });
        })
        .catch(error => {
            console.error('变更记录搜索失败:', error);
            document.getElementById('changeRecordResultsTableBody').innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 40px; color: #6c757d;">❌ 搜索失败，请重试</td></tr>';
        });
    }

    // 显示变更记录搜索结果
    function displayChangeRecordResults() {
        const resultsTableBody = document.getElementById('changeRecordResultsTableBody');
        const pagination = document.getElementById('changeRecordPagination');
        const resultsCount = document.getElementById('changeRecordResultsCount');
        const pageInfo = document.getElementById('changeRecordPageInfo');
        const prevBtn = document.getElementById('changeRecordPrevBtn');
        const nextBtn = document.getElementById('changeRecordNextBtn');

        console.log('显示变更记录结果，数据长度:', changeRecordAllResults.length);

        // 没有结果时
        if (!changeRecordAllResults || changeRecordAllResults.length === 0) {
            resultsTableBody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">📭 没有找到匹配的记录</td></tr>';
            pagination.style.display = 'none';
            resultsCount.textContent = '搜索结果：0 条记录';
            return;
        }

        // 总记录数 & 总页数
        const totalResults = changeRecordAllResults.length;
        const totalPages = Math.ceil(totalResults / changeRecordPageSize);

        // 确保当前页在合法范围内
        if (changeRecordCurrentPage > totalPages) changeRecordCurrentPage = totalPages;
        if (changeRecordCurrentPage < 1) changeRecordCurrentPage = 1;

        // 分页数据
        const startIndex = (changeRecordCurrentPage - 1) * changeRecordPageSize;
        const endIndex = Math.min(startIndex + changeRecordPageSize, totalResults);
        changeRecordCurrentResults = changeRecordAllResults.slice(startIndex, endIndex);

        // 更新结果计数
        resultsCount.textContent = `搜索结果：${totalResults} 条记录`;

        // 渲染表格 - 直接显示change_records表的数据
        const tableHtml = changeRecordCurrentResults.map((item, index) => `
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top; font-weight: 500;">${item.id || (startIndex + index + 1)}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top; font-weight: 500;">${item.electric_sample_id || item.sample_id || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.sample_model || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.sample_leader || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.sample_sender || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.tester || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${formatChangeRecordDate(item.start_date) || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${formatChangeRecordDate(item.end_date) || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.scheduleDays || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">
                    <span style="display: inline-block; width: 20px; height: 20px; border-radius: 3px; background-color: ${getColorValue(item.schedule_color)}; border: 1px solid #ddd; margin-right: 5px;"></span>
                    ${item.schedule_color || '-'}
                </td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${formatChangeRecordDate(item.update_time) || '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.is_used}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.is_cancel === 1 ? '是' : item.is_cancel === 0 ? '否' : '-'}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: top;">${item.remark || '-'}</td>
            </tr>
        `).join('');

        resultsTableBody.innerHTML = tableHtml;

        // 显示分页
        if (totalPages > 1) {
            pageInfo.textContent = `第 ${changeRecordCurrentPage} 页，共 ${totalPages} 页`;
            prevBtn.disabled = changeRecordCurrentPage === 1;
            nextBtn.disabled = changeRecordCurrentPage === totalPages;
            pagination.style.display = 'flex';
        } else {
            pagination.style.display = 'none';
        }
    }





    // 格式化变更记录日期
    function formatChangeRecordDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toISOString().split('T')[0]; // 返回 YYYY-MM-DD 格式
    }

    // 获取颜色值
    function getColorValue(colorName) {
        const colorMap = {
            'red': '#ff6b6b',
            'green': '#51cf66',
            'yellow': '#ffd43b',
            'gray': '#868e96',
            'null': '#ffffff'
        };
        return colorMap[colorName] || '#ffffff';
    }

    // 清空变更记录表单
    function clearChangeRecordForm() {
        document.getElementById('changeRecordSearchForm').reset();

        // 重新设置默认日期范围
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

        document.getElementById('changeRecordStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('changeRecordEndDate').value = today.toISOString().split('T')[0];
        
        // 清空变更记录日期范围
        document.getElementById('changeRecordStartDate2').value = '';
        document.getElementById('changeRecordEndDate2').value = '';
        
        // 重置下拉选择框
        document.getElementById('changeRecordIsUsed').value = '';
        document.getElementById('changeRecordIsCancel').value = '';
        document.getElementById('changeRecordSchedule').value = '';
        
        // 显示清空成功提示
        showToast('表单已清空', 'success');
    }

    // 显示提示消息
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        
        switch(type) {
            case 'success':
                toast.style.background = '#28a745';
                break;
            case 'error':
                toast.style.background = '#dc3545';
                break;
            case 'warning':
                toast.style.background = '#ffc107';
                toast.style.color = '#212529';
                break;
            default:
                toast.style.background = '#007bff';
        }
        
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // 变更记录上一页
    function previousChangeRecordPage() {
        if (changeRecordCurrentPage > 1) {
            changeRecordCurrentPage--;
            displayChangeRecordResults();
        }
    }

    // 变更记录下一页
    function nextChangeRecordPage() {
        const totalPages = Math.ceil(changeRecordAllResults.length / changeRecordPageSize);
        if (changeRecordCurrentPage < totalPages) {
            changeRecordCurrentPage++;
            displayChangeRecordResults();
        }
    }

    // 导出变更记录结果
    function exportChangeRecordResults() {
        if (changeRecordAllResults.length === 0) {
            alert('没有数据可导出');
            return;
        }

        // 创建CSV内容
        let csvContent = '电气编号,大编码,项目负责人,送样人,测试人,排期开始日期,排期结束日期,备注\n';

        changeRecordAllResults.forEach(function(item) {
            csvContent += `"${item.electric_sample_id || item.sample_id || ''}","${item.sample_model || ''}","${item.sample_leader || ''}","${item.sample_sender || ''}","${item.tester || ''}","${formatChangeRecordDate(item.start_date) || ''}","${formatChangeRecordDate(item.end_date) || ''}","${item.remark || ''}"\n`;
        });

        // 下载CSV文件
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `变更记录搜索结果_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 添加变更记录状态样式
    const style = document.createElement('style');
    style.textContent = `
        .status-used { color: #28a745; font-weight: 600; }
        .status-unused { color: #dc3545; font-weight: 600; }
        .status-cancelled { color: #6c757d; font-weight: 600; }
        
        .color-gray { color: #6c757d; font-weight: 600; }
        .color-green { color: #28a745; font-weight: 600; }
        .color-yellow { color: #ffc107; font-weight: 600; }
        .color-red { color: #dc3545; font-weight: 600; }
        .color-default { color: #6c757d; font-weight: 600; }
        
        #changeRecordPrevBtn:disabled,
        #changeRecordNextBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 变更记录横向滚动条样式 */
        #changeRecordResultsTableBody td:last-child div::-webkit-scrollbar {
            height: 6px;
        }
        
        #changeRecordResultsTableBody td:last-child div::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #changeRecordResultsTableBody td:last-child div::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #changeRecordResultsTableBody td:last-child div::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 输入框焦点样式 */
        #changeRecordSearchForm input:focus,
        #changeRecordSearchForm select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
        
        /* 按钮悬停效果 */
        #changeRecordSearchForm button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        /* 变更记录卡片悬停效果 */
        #changeRecordResultsTableBody .change-record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Toast动画 */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // 自定义 Alert 组件 HTML 结构
    const customAlertHTML = `
        <div id="customAlertOverlay" class="custom-alert-overlay">
            <div class="custom-alert">
                <button class="custom-alert-close" onclick="closeCustomAlert()">&times;</button>
                <div class="custom-alert-message" id="customAlertMessage"></div>
                <button class="custom-alert-button" onclick="closeCustomAlert()">确定</button>
                <div class="custom-alert-timer" id="customAlertTimer"></div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', customAlertHTML);

    // 自定义 Alert 函数
    let customAlertTimeout = null;
    let customAlertTimer = null;
    let alertEventListenersAdded = false;

    function customAlert(message, duration = 3000) {
        // 清除之前的定时器
        if (customAlertTimeout) {
            clearTimeout(customAlertTimeout);
        }
        if (customAlertTimer) {
            clearInterval(customAlertTimer);
        }

        const overlay = document.getElementById('customAlertOverlay');
        const messageEl = document.getElementById('customAlertMessage');
        const timerEl = document.getElementById('customAlertTimer');

        messageEl.textContent = message;
        overlay.style.display = 'flex';
        timerEl.style.width = '100%';

        // 设置自动关闭定时器
        customAlertTimeout = setTimeout(() => {
            closeCustomAlert();
        }, duration);

        // 设置进度条动画
        const startTime = Date.now();
        const endTime = startTime + duration;
        
        customAlertTimer = setInterval(() => {
            const now = Date.now();
            const remaining = Math.max(0, endTime - now);
            const progress = (remaining / duration) * 100;
            timerEl.style.width = progress + '%';
            
            if (remaining <= 0) {
                clearInterval(customAlertTimer);
            }
        }, 10);

        // 只在第一次添加事件监听器
        if (!alertEventListenersAdded) {
            // 点击遮罩层关闭
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeCustomAlert();
                }
            });

            // ESC 键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeCustomAlert();
                }
            });

            alertEventListenersAdded = true;
        }
    }

    function closeCustomAlert() {
        const overlay = document.getElementById('customAlertOverlay');
        overlay.style.display = 'none';
        
        if (customAlertTimeout) {
            clearTimeout(customAlertTimeout);
            customAlertTimeout = null;
        }
        if (customAlertTimer) {
            clearInterval(customAlertTimer);
            customAlertTimer = null;
        }
    }

    // 替换原生 alert 函数
    window.alert = customAlert;

</script>

</body>
</html>