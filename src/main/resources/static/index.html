<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>研发质量管理系统登陆验证中...</title>
</head>
<body>
<!--<button onclick="redirectToDingTalk()">DingTalk Login</button>-->
<script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.7.0/dingtalk.open.js"></script>

<script>

    dd.ready(function () {
        dd.runtime.permission.requestAuthCode({
            corpId: "ding39a9d20442a933ec35c2f4657eb6378f", // 企业CorpId
            onSuccess: function (result) {
                // 获取到authCode后发送到后端
                sendAuthCodeToServer(result.code);
            },
            onFail: function (err) {
                alert('获取authCode失败: ' + JSON.stringify(err));
            }
        });
    });

    function setLocalStorageItem(key, value) {
        // 判断缓存中是否存在该键
        if (localStorage.getItem(key) !== null) {
            // 清除之前的缓存
            localStorage.removeItem(key);
        }
        // 设置新的值
        localStorage.setItem(key, value);
    }

    function sendAuthCodeToServer(authCode) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/getUserInfo', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                // 单独将每个需要的字段保存到sessionStorage
                sessionStorage.setItem('userId', response.userId);
                sessionStorage.setItem('username', response.username);
                sessionStorage.setItem('job', response.job);
                sessionStorage.setItem('departmentId', response.departmentId);
                sessionStorage.setItem('corp_id', response.corp_id);
                sessionStorage.setItem('templatespath', response.templatespath);
                sessionStorage.setItem('savepath', response.savepath);
                sessionStorage.setItem('imagepath', response.imagepath);

                setLocalStorageItem("username", response.username);
                setLocalStorageItem("job", response.job);
                setLocalStorageItem("corp_id", response.corp_id);
                // alert('姓名: ' + response.username + '，职位：' + response.job + '  ，你好！');
                alert('姓名: ' + response.username + '，角色：'+ response.job+'  ，你好！');

                if (response.job.includes("DQE") || response.job.includes("rd") || response.job.includes("projectLeader")
                || response.job.includes("manager")) {
                    window.location.href = '/DQEIndex';
                } else {
                    // 重定向到首页
                    window.location.href = '/testManIndex';
                }
            }
        };
        xhr.send(JSON.stringify({authCode: authCode}));
    }

</script>
</body>
</html>
